{"remainingRequest":"/home/vimalesh/Learning/devops_ui/node_modules/thread-loader/dist/cjs.js!/home/vimalesh/Learning/devops_ui/node_modules/babel-loader/lib/index.js!/home/vimalesh/Learning/devops_ui/node_modules/eslint-loader/index.js??ref--13-0!/home/vimalesh/Learning/devops_ui/src/portal/Chatbot/Dashboard/Layout/intro.js","dependencies":[{"path":"/home/vimalesh/Learning/devops_ui/src/portal/Chatbot/Dashboard/Layout/intro.js","mtime":1643027096176},{"path":"/home/vimalesh/Learning/devops_ui/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/Learning/devops_ui/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/Learning/devops_ui/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/vimalesh/Learning/devops_ui/node_modules/eslint-loader/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:cmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN5bWJvbCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN5bWJvbC5kZXNjcmlwdGlvbiIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN5bWJvbC5pdGVyYXRvciIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmNvbmNhdCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmluY2x1ZGVzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuaW5kZXgtb2YiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5zbGljZSIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNwbGljZSIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC50by1zdHJpbmciKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5yZWdleHAuZXhlYyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC50by1zdHJpbmciKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuaW5jbHVkZXMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuaXRlcmF0b3IiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcubWF0Y2giKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcucmVwbGFjZSIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5zcGxpdCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuaXRlcmF0b3IiKTsKCnZhciBfdHlwZW9mMiA9IHJlcXVpcmUoIi9ob21lL3ZpbWFsZXNoL0xlYXJuaW5nL2Rldm9wc191aS9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy90eXBlb2YiKTsKCi8qIQogKiBJbnRyby5qcyB2My4wLjEKICogaHR0cHM6Ly9naXRodWIuY29tL3VzYWJsaWNhL2ludHJvLmpzCiAqCiAqIENvcHlyaWdodCAoQykgMjAxNy0yMDIwIEFmc2hpbiBNZWhyYWJhbmkgKEBhZnNoaW5tZWgpLgogKiBodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vdXNhYmxpY2EvaW50cm8uanMvbWFzdGVyL2xpY2Vuc2UubWQKICoKICogRGF0ZTogU2F0LCAxNyBPY3QgMjAyMCAxMDozNjoyMCBHTVQKICovCnZhciBfcmVxdWlyZSA9IHJlcXVpcmUoImQzIiksCiAgICBpbWFnZSA9IF9yZXF1aXJlLmltYWdlOwoKKGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHsKICAodHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mMihleHBvcnRzKSkgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnID8gbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCkgOiB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgPyBkZWZpbmUoZmFjdG9yeSkgOiAoZ2xvYmFsID0gZ2xvYmFsIHx8IHNlbGYsIGdsb2JhbC5pbnRyb0pzID0gZmFjdG9yeSgpKTsKfSkodGhpcywgZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZnVuY3Rpb24gX3R5cGVvZihvYmopIHsKICAgICJAYmFiZWwvaGVscGVycyAtIHR5cGVvZiI7CgogICAgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA9PT0gInN5bWJvbCIpIHsKICAgICAgX3R5cGVvZiA9IGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmo7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsKICAgICAgICByZXR1cm4gb2JqICYmIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSBTeW1ib2wucHJvdG90eXBlID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOwogICAgICB9OwogICAgfQoKICAgIHJldHVybiBfdHlwZW9mKG9iaik7CiAgfQogIC8qKgogICAqIE92ZXJ3cml0ZXMgb2JqMSdzIHZhbHVlcyB3aXRoIG9iajIncyBhbmQgYWRkcyBvYmoyJ3MgaWYgbm9uIGV4aXN0ZW50IGluIG9iajEKICAgKiB2aWE6IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTcxMjUxL2hvdy1jYW4taS1tZXJnZS1wcm9wZXJ0aWVzLW9mLXR3by1qYXZhc2NyaXB0LW9iamVjdHMtZHluYW1pY2FsbHkKICAgKgogICAqIEBwYXJhbSBvYmoxCiAgICogQHBhcmFtIG9iajIKICAgKiBAcmV0dXJucyBvYmozIGEgbmV3IG9iamVjdCBiYXNlZCBvbiBvYmoxIGFuZCBvYmoyCiAgICovCgoKICBmdW5jdGlvbiBtZXJnZU9wdGlvbnMob2JqMSwgb2JqMikgewogICAgdmFyIG9iajMgPSB7fTsKICAgIHZhciBhdHRybmFtZTsKCiAgICBmb3IgKGF0dHJuYW1lIGluIG9iajEpIHsKICAgICAgb2JqM1thdHRybmFtZV0gPSBvYmoxW2F0dHJuYW1lXTsKICAgIH0KCiAgICBmb3IgKGF0dHJuYW1lIGluIG9iajIpIHsKICAgICAgb2JqM1thdHRybmFtZV0gPSBvYmoyW2F0dHJuYW1lXTsKICAgIH0KCiAgICByZXR1cm4gb2JqMzsKICB9CiAgLyoqCiAgICogTWFyayBhbnkgb2JqZWN0IHdpdGggYW4gaW5jcmVtZW50aW5nIG51bWJlcgogICAqIHVzZWQgZm9yIGtlZXBpbmcgdHJhY2sgb2Ygb2JqZWN0cwogICAqCiAgICogQHBhcmFtIE9iamVjdCBvYmogICBBbnkgb2JqZWN0IG9yIERPTSBFbGVtZW50CiAgICogQHBhcmFtIFN0cmluZyBrZXkKICAgKiBAcmV0dXJuIE9iamVjdAogICAqLwoKCiAgdmFyIHN0YW1wID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGtleXMgPSB7fTsKICAgIHJldHVybiBmdW5jdGlvbiBzdGFtcChvYmopIHsKICAgICAgdmFyIGtleSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogImludHJvanMtc3RhbXAiOyAvLyBlYWNoIGdyb3VwIGluY3JlbWVudHMgZnJvbSAwCgogICAgICBrZXlzW2tleV0gPSBrZXlzW2tleV0gfHwgMDsgLy8gc3RhbXAgb25seSBvbmNlIHBlciBvYmplY3QKCiAgICAgIGlmIChvYmpba2V5XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgLy8gaW5jcmVtZW50IGtleSBmb3IgZWFjaCBuZXcgb2JqZWN0CiAgICAgICAgb2JqW2tleV0gPSBrZXlzW2tleV0rKzsKICAgICAgfQoKICAgICAgcmV0dXJuIG9ialtrZXldOwogICAgfTsKICB9KCk7CiAgLyoqCiAgICogSXRlcmF0ZXMgYXJyYXlzCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSBhcnIKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmb3JFYWNoRm5jCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29tcGxldGVGbmMKICAgKiBAcmV0dXJuIHtOdWxsfQogICAqLwoKCiAgZnVuY3Rpb24gZm9yRWFjaChhcnIsIGZvckVhY2hGbmMsIGNvbXBsZXRlRm5jKSB7CiAgICAvLyBpbiBjYXNlIGFyciBpcyBhbiBlbXB0eSBxdWVyeSBzZWxlY3RvciBub2RlIGxpc3QKICAgIGlmIChhcnIpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGFyci5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgIGZvckVhY2hGbmMoYXJyW2ldLCBpKTsKICAgICAgfQogICAgfQoKICAgIGlmICh0eXBlb2YgY29tcGxldGVGbmMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgY29tcGxldGVGbmMoKTsKICAgIH0KICB9CiAgLyoqCiAgICogUmVtb3ZlIGEgY2xhc3MgZnJvbSBhbiBlbGVtZW50CiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9yZW1vdmVDbGFzcwogICAqIEBwYXJhbSB7T2JqZWN0fSBlbGVtZW50CiAgICogQHBhcmFtIHtSZWdFeHB8U3RyaW5nfSBjbGFzc05hbWVSZWdleCBjYW4gYmUgcmVnZXggb3Igc3RyaW5nCiAgICogQHJldHVybnMgbnVsbAogICAqLwoKCiAgZnVuY3Rpb24gcmVtb3ZlQ2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lUmVnZXgpIHsKICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgU1ZHRWxlbWVudCkgewogICAgICB2YXIgcHJlID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoImNsYXNzIikgfHwgIiI7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJjbGFzcyIsIHByZS5yZXBsYWNlKGNsYXNzTmFtZVJlZ2V4LCAiIikucmVwbGFjZSgvXlxzK3xccyskL2csICIiKSk7CiAgICB9IGVsc2UgewogICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnJlcGxhY2UoY2xhc3NOYW1lUmVnZXgsICIiKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgIiIpOwogICAgfQogIH0KICAvKioKICAgKiBET01FdmVudCBIYW5kbGVzIGFsbCBET00gZXZlbnRzCiAgICoKICAgKiBtZXRob2RzOgogICAqCiAgICogb24gLSBhZGQgZXZlbnQgaGFuZGxlcgogICAqIG9mZiAtIHJlbW92ZSBldmVudAogICAqLwoKCiAgdmFyIERPTUV2ZW50ID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRE9NRXZlbnQoKSB7CiAgICAgIHZhciBldmVudHNfa2V5ID0gImludHJvanNfZXZlbnQiOwogICAgICAvKioKICAgICAgICogR2V0cyBhIHVuaXF1ZSBJRCBmb3IgYW4gZXZlbnQgbGlzdGVuZXIKICAgICAgICoKICAgICAgICogQHBhcmFtIG9iaiBPYmplY3QKICAgICAgICogQHBhcmFtIHR5cGUgZXZlbnQgdHlwZQogICAgICAgKiBAcGFyYW0gbGlzdGVuZXIgRnVuY3Rpb24KICAgICAgICogQHBhcmFtIGNvbnRleHQgT2JqZWN0CiAgICAgICAqIEByZXR1cm4gU3RyaW5nCiAgICAgICAqLwoKICAgICAgdGhpcy5faWQgPSBmdW5jdGlvbiAob2JqLCB0eXBlLCBsaXN0ZW5lciwgY29udGV4dCkgewogICAgICAgIHJldHVybiB0eXBlICsgc3RhbXAobGlzdGVuZXIpICsgKGNvbnRleHQgPyAiXyIuY29uY2F0KHN0YW1wKGNvbnRleHQpKSA6ICIiKTsKICAgICAgfTsKICAgICAgLyoqCiAgICAgICAqIEFkZHMgZXZlbnQgbGlzdGVuZXIKICAgICAgICoKICAgICAgICogQHBhcmFtIG9iaiBPYmplY3Qgb2JqCiAgICAgICAqIEBwYXJhbSB0eXBlIFN0cmluZwogICAgICAgKiBAcGFyYW0gbGlzdGVuZXIgRnVuY3Rpb24KICAgICAgICogQHBhcmFtIGNvbnRleHQgT2JqZWN0CiAgICAgICAqIEBwYXJhbSB1c2VDYXB0dXJlIEJvb2xlYW4KICAgICAgICogQHJldHVybiBudWxsCiAgICAgICAqLwoKCiAgICAgIHRoaXMub24gPSBmdW5jdGlvbiAob2JqLCB0eXBlLCBsaXN0ZW5lciwgY29udGV4dCwgdXNlQ2FwdHVyZSkgewogICAgICAgIHZhciBpZCA9IHRoaXMuX2lkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIHZhciBoYW5kbGVyID0gZnVuY3Rpb24gaGFuZGxlcihlKSB7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIuY2FsbChjb250ZXh0IHx8IG9iaiwgZSB8fCB3aW5kb3cuZXZlbnQpOwogICAgICAgIH07CgogICAgICAgIGlmICgiYWRkRXZlbnRMaXN0ZW5lciIgaW4gb2JqKSB7CiAgICAgICAgICBvYmouYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBoYW5kbGVyLCB1c2VDYXB0dXJlKTsKICAgICAgICB9IGVsc2UgaWYgKCJhdHRhY2hFdmVudCIgaW4gb2JqKSB7CiAgICAgICAgICBvYmouYXR0YWNoRXZlbnQoIm9uIi5jb25jYXQodHlwZSksIGhhbmRsZXIpOwogICAgICAgIH0KCiAgICAgICAgb2JqW2V2ZW50c19rZXldID0gb2JqW2V2ZW50c19rZXldIHx8IHt9OwogICAgICAgIG9ialtldmVudHNfa2V5XVtpZF0gPSBoYW5kbGVyOwogICAgICB9OwogICAgICAvKioKICAgICAgICogUmVtb3ZlcyBldmVudCBsaXN0ZW5lcgogICAgICAgKgogICAgICAgKiBAcGFyYW0gb2JqIE9iamVjdAogICAgICAgKiBAcGFyYW0gdHlwZSBTdHJpbmcKICAgICAgICogQHBhcmFtIGxpc3RlbmVyIEZ1bmN0aW9uCiAgICAgICAqIEBwYXJhbSBjb250ZXh0IE9iamVjdAogICAgICAgKiBAcGFyYW0gdXNlQ2FwdHVyZSBCb29sZWFuCiAgICAgICAqIEByZXR1cm4gbnVsbAogICAgICAgKi8KCgogICAgICB0aGlzLm9mZiA9IGZ1bmN0aW9uIChvYmosIHR5cGUsIGxpc3RlbmVyLCBjb250ZXh0LCB1c2VDYXB0dXJlKSB7CiAgICAgICAgdmFyIGlkID0gdGhpcy5faWQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgdmFyIGhhbmRsZXIgPSBvYmpbZXZlbnRzX2tleV0gJiYgb2JqW2V2ZW50c19rZXldW2lkXTsKCiAgICAgICAgaWYgKCFoYW5kbGVyKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoInJlbW92ZUV2ZW50TGlzdGVuZXIiIGluIG9iaikgewogICAgICAgICAgb2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgaGFuZGxlciwgdXNlQ2FwdHVyZSk7CiAgICAgICAgfSBlbHNlIGlmICgiZGV0YWNoRXZlbnQiIGluIG9iaikgewogICAgICAgICAgb2JqLmRldGFjaEV2ZW50KCJvbiIuY29uY2F0KHR5cGUpLCBoYW5kbGVyKTsKICAgICAgICB9CgogICAgICAgIG9ialtldmVudHNfa2V5XVtpZF0gPSBudWxsOwogICAgICB9OwogICAgfQoKICAgIHJldHVybiBuZXcgRE9NRXZlbnQoKTsKICB9KCk7CiAgLyoqCiAgICogQXBwZW5kIGEgY2xhc3MgdG8gYW4gZWxlbWVudAogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfYWRkQ2xhc3MKICAgKiBAcGFyYW0ge09iamVjdH0gZWxlbWVudAogICAqIEBwYXJhbSB7U3RyaW5nfSBjbGFzc05hbWUKICAgKiBAcmV0dXJucyBudWxsCiAgICovCgoKICBmdW5jdGlvbiBhZGRDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgU1ZHRWxlbWVudCkgewogICAgICAvLyBzdmcKICAgICAgdmFyIHByZSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCJjbGFzcyIpIHx8ICIiOwogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgiY2xhc3MiLCAiIi5jb25jYXQocHJlLCAiICIpLmNvbmNhdChjbGFzc05hbWUpKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChlbGVtZW50LmNsYXNzTGlzdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgLy8gY2hlY2sgZm9yIG1vZGVybiBjbGFzc0xpc3QgcHJvcGVydHkKICAgICAgICB2YXIgY2xhc3NlcyA9IGNsYXNzTmFtZS5zcGxpdCgiICIpOwogICAgICAgIGZvckVhY2goY2xhc3NlcywgZnVuY3Rpb24gKGNscykgewogICAgICAgICAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKGNscyk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAoIWVsZW1lbnQuY2xhc3NOYW1lLm1hdGNoKGNsYXNzTmFtZSkpIHsKICAgICAgICAvLyBjaGVjayBpZiBlbGVtZW50IGRvZXNuJ3QgYWxyZWFkeSBoYXZlIGNsYXNzTmFtZQogICAgICAgIGVsZW1lbnQuY2xhc3NOYW1lICs9ICIgIi5jb25jYXQoY2xhc3NOYW1lKTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBHZXQgYW4gZWxlbWVudCBDU1MgcHJvcGVydHkgb24gdGhlIHBhZ2UKICAgKiBUaGFua3MgdG8gSmF2YVNjcmlwdCBLaXQ6IGh0dHA6Ly93d3cuamF2YXNjcmlwdGtpdC5jb20vZGh0bWx0dXRvcnMvZGh0bWxjYXNjYWRlNC5zaHRtbAogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfZ2V0UHJvcFZhbHVlCiAgICogQHBhcmFtIHtPYmplY3R9IGVsZW1lbnQKICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcE5hbWUKICAgKiBAcmV0dXJucyBzdHJpbmcgcHJvcGVydHkgdmFsdWUKICAgKi8KCgogIGZ1bmN0aW9uIGdldFByb3BWYWx1ZShlbGVtZW50LCBwcm9wTmFtZSkgewogICAgdmFyIHByb3BWYWx1ZSA9ICIiOwoKICAgIGlmIChlbGVtZW50LmN1cnJlbnRTdHlsZSkgewogICAgICAvL0lFCiAgICAgIHByb3BWYWx1ZSA9IGVsZW1lbnQuY3VycmVudFN0eWxlW3Byb3BOYW1lXTsKICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuZGVmYXVsdFZpZXcgJiYgZG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSkgewogICAgICAvL090aGVycwogICAgICBwcm9wVmFsdWUgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQsIG51bGwpLmdldFByb3BlcnR5VmFsdWUocHJvcE5hbWUpOwogICAgfSAvL1ByZXZlbnQgZXhjZXB0aW9uIGluIElFCgoKICAgIGlmIChwcm9wVmFsdWUgJiYgcHJvcFZhbHVlLnRvTG93ZXJDYXNlKSB7CiAgICAgIHJldHVybiBwcm9wVmFsdWUudG9Mb3dlckNhc2UoKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBwcm9wVmFsdWU7CiAgICB9CiAgfQogIC8qKgogICAqIFRvIHNldCB0aGUgc2hvdyBlbGVtZW50CiAgICogVGhpcyBmdW5jdGlvbiBzZXQgYSByZWxhdGl2ZSAoaW4gbW9zdCBjYXNlcykgcG9zaXRpb24gYW5kIGNoYW5nZXMgdGhlIHotaW5kZXgKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX3NldFNob3dFbGVtZW50CiAgICogQHBhcmFtIHtPYmplY3R9IHRhcmdldEVsZW1lbnQKICAgKi8KCgogIGZ1bmN0aW9uIHNldFNob3dFbGVtZW50KF9yZWYpIHsKICAgIHZhciBlbGVtZW50ID0gX3JlZi5lbGVtZW50OwogICAgdmFyIHBhcmVudEVsbTsgLy8gd2UgbmVlZCB0byBhZGQgdGhpcyBzaG93IGVsZW1lbnQgY2xhc3MgdG8gdGhlIHBhcmVudCBvZiBTVkcgZWxlbWVudHMKICAgIC8vIGJlY2F1c2UgdGhlIFNWRyBlbGVtZW50cyBjYW4ndCBoYXZlIGluZGVwZW5kZW50IHotaW5kZXgKCiAgICBpZiAoZWxlbWVudCBpbnN0YW5jZW9mIFNWR0VsZW1lbnQpIHsKICAgICAgcGFyZW50RWxtID0gZWxlbWVudC5wYXJlbnROb2RlOwoKICAgICAgd2hpbGUgKGVsZW1lbnQucGFyZW50Tm9kZSAhPT0gbnVsbCkgewogICAgICAgIGlmICghcGFyZW50RWxtLnRhZ05hbWUgfHwgcGFyZW50RWxtLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gImJvZHkiKSBicmVhazsKCiAgICAgICAgaWYgKHBhcmVudEVsbS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzdmciKSB7CiAgICAgICAgICBhZGRDbGFzcyhwYXJlbnRFbG0sICJpbnRyb2pzLXNob3dFbGVtZW50IGludHJvanMtcmVsYXRpdmVQb3NpdGlvbiIpOwogICAgICAgIH0KCiAgICAgICAgcGFyZW50RWxtID0gcGFyZW50RWxtLnBhcmVudE5vZGU7CiAgICAgIH0KICAgIH0KCiAgICBhZGRDbGFzcyhlbGVtZW50LCAiaW50cm9qcy1zaG93RWxlbWVudCIpOwogICAgdmFyIGN1cnJlbnRFbGVtZW50UG9zaXRpb24gPSBnZXRQcm9wVmFsdWUoZWxlbWVudCwgInBvc2l0aW9uIik7CgogICAgaWYgKGN1cnJlbnRFbGVtZW50UG9zaXRpb24gIT09ICJhYnNvbHV0ZSIgJiYgY3VycmVudEVsZW1lbnRQb3NpdGlvbiAhPT0gInJlbGF0aXZlIiAmJiBjdXJyZW50RWxlbWVudFBvc2l0aW9uICE9PSAiZml4ZWQiKSB7CiAgICAgIC8vY2hhbmdlIHRvIG5ldyBpbnRybyBpdGVtCiAgICAgIGFkZENsYXNzKGVsZW1lbnQsICJpbnRyb2pzLXJlbGF0aXZlUG9zaXRpb24iKTsKICAgIH0KCiAgICBwYXJlbnRFbG0gPSBlbGVtZW50LnBhcmVudE5vZGU7CgogICAgd2hpbGUgKHBhcmVudEVsbSAhPT0gbnVsbCkgewogICAgICBpZiAoIXBhcmVudEVsbS50YWdOYW1lIHx8IHBhcmVudEVsbS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJib2R5IikgYnJlYWs7IC8vZml4IFRoZSBTdGFja2luZyBDb250ZXh0IHByb2JsZW0uCiAgICAgIC8vTW9yZSBkZXRhaWw6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0d1aWRlL0NTUy9VbmRlcnN0YW5kaW5nX3pfaW5kZXgvVGhlX3N0YWNraW5nX2NvbnRleHQKCiAgICAgIHZhciB6SW5kZXggPSBnZXRQcm9wVmFsdWUocGFyZW50RWxtLCAiei1pbmRleCIpOwogICAgICB2YXIgb3BhY2l0eSA9IHBhcnNlRmxvYXQoZ2V0UHJvcFZhbHVlKHBhcmVudEVsbSwgIm9wYWNpdHkiKSk7CiAgICAgIHZhciB0cmFuc2Zvcm0gPSBnZXRQcm9wVmFsdWUocGFyZW50RWxtLCAidHJhbnNmb3JtIikgfHwgZ2V0UHJvcFZhbHVlKHBhcmVudEVsbSwgIi13ZWJraXQtdHJhbnNmb3JtIikgfHwgZ2V0UHJvcFZhbHVlKHBhcmVudEVsbSwgIi1tb3otdHJhbnNmb3JtIikgfHwgZ2V0UHJvcFZhbHVlKHBhcmVudEVsbSwgIi1tcy10cmFuc2Zvcm0iKSB8fCBnZXRQcm9wVmFsdWUocGFyZW50RWxtLCAiLW8tdHJhbnNmb3JtIik7CgogICAgICBpZiAoL1swLTldKy8udGVzdCh6SW5kZXgpIHx8IG9wYWNpdHkgPCAxIHx8IHRyYW5zZm9ybSAhPT0gIm5vbmUiICYmIHRyYW5zZm9ybSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgYWRkQ2xhc3MocGFyZW50RWxtLCAiaW50cm9qcy1maXhQYXJlbnQiKTsKICAgICAgfQoKICAgICAgcGFyZW50RWxtID0gcGFyZW50RWxtLnBhcmVudE5vZGU7CiAgICB9CiAgfQogIC8qKgogICAqIHNjcm9sbCBhIHNjcm9sbGFibGUgZWxlbWVudCB0byBhIGNoaWxkIGVsZW1lbnQKICAgKgogICAqIEBwYXJhbSBFbGVtZW50IHBhcmVudAogICAqIEBwYXJhbSBFbGVtZW50IGVsZW1lbnQKICAgKiBAcmV0dXJuIE51bGwKICAgKi8KCgogIGZ1bmN0aW9uIHNjcm9sbFBhcmVudFRvRWxlbWVudChwYXJlbnQsIF9yZWYpIHsKICAgIHZhciBvZmZzZXRUb3AgPSBfcmVmLm9mZnNldFRvcDsKICAgIHBhcmVudC5zY3JvbGxUb3AgPSBvZmZzZXRUb3AgLSBwYXJlbnQub2Zmc2V0VG9wOwogIH0KICAvKioKICAgKiBGaW5kIHRoZSBuZWFyZXN0IHNjcm9sbGFibGUgcGFyZW50CiAgICogY29waWVkIGZyb20gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzU5Mzk4ODYvZmluZC1maXJzdC1zY3JvbGxhYmxlLXBhcmVudAogICAqCiAgICogQHBhcmFtIEVsZW1lbnQgZWxlbWVudAogICAqIEByZXR1cm4gRWxlbWVudAogICAqLwoKCiAgZnVuY3Rpb24gZ2V0U2Nyb2xsUGFyZW50KGVsZW1lbnQpIHsKICAgIHZhciBzdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQpOwogICAgdmFyIGV4Y2x1ZGVTdGF0aWNQYXJlbnQgPSBzdHlsZS5wb3NpdGlvbiA9PT0gImFic29sdXRlIjsKICAgIHZhciBvdmVyZmxvd1JlZ2V4ID0gLyhhdXRvfHNjcm9sbCkvOwogICAgaWYgKHN0eWxlLnBvc2l0aW9uID09PSAiZml4ZWQiKSByZXR1cm4gZG9jdW1lbnQuYm9keTsKCiAgICBmb3IgKHZhciBwYXJlbnQgPSBlbGVtZW50OyBwYXJlbnQgPSBwYXJlbnQucGFyZW50RWxlbWVudDspIHsKICAgICAgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShwYXJlbnQpOwoKICAgICAgaWYgKGV4Y2x1ZGVTdGF0aWNQYXJlbnQgJiYgc3R5bGUucG9zaXRpb24gPT09ICJzdGF0aWMiKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIGlmIChvdmVyZmxvd1JlZ2V4LnRlc3Qoc3R5bGUub3ZlcmZsb3cgKyBzdHlsZS5vdmVyZmxvd1kgKyBzdHlsZS5vdmVyZmxvd1gpKSByZXR1cm4gcGFyZW50OwogICAgfQoKICAgIHJldHVybiBkb2N1bWVudC5ib2R5OwogIH0KICAvKioKICAgKiBQcm92aWRlcyBhIGNyb3NzLWJyb3dzZXIgd2F5IHRvIGdldCB0aGUgc2NyZWVuIGRpbWVuc2lvbnMKICAgKiB2aWE6IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNTg2NDQ2Ny9pbnRlcm5ldC1leHBsb3Jlci1pbm5lcmhlaWdodAogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfZ2V0V2luU2l6ZQogICAqIEByZXR1cm5zIHtPYmplY3R9IHdpZHRoIGFuZCBoZWlnaHQgYXR0cmlidXRlcwogICAqLwoKCiAgZnVuY3Rpb24gZ2V0V2luU2l6ZSgpIHsKICAgIGlmICh3aW5kb3cuaW5uZXJXaWR0aCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgd2lkdGg6IHdpbmRvdy5pbm5lcldpZHRoLAogICAgICAgIGhlaWdodDogd2luZG93LmlubmVySGVpZ2h0CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICB2YXIgRCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICAgICAgcmV0dXJuIHsKICAgICAgICB3aWR0aDogRC5jbGllbnRXaWR0aCwKICAgICAgICBoZWlnaHQ6IEQuY2xpZW50SGVpZ2h0CiAgICAgIH07CiAgICB9CiAgfQogIC8qKgogICAqIENoZWNrIHRvIHNlZSBpZiB0aGUgZWxlbWVudCBpcyBpbiB0aGUgdmlld3BvcnQgb3Igbm90CiAgICogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xMjM5OTkvaG93LXRvLXRlbGwtaWYtYS1kb20tZWxlbWVudC1pcy12aXNpYmxlLWluLXRoZS1jdXJyZW50LXZpZXdwb3J0CiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9lbGVtZW50SW5WaWV3cG9ydAogICAqIEBwYXJhbSB7T2JqZWN0fSBlbAogICAqLwoKCiAgZnVuY3Rpb24gZWxlbWVudEluVmlld3BvcnQoZWwpIHsKICAgIHZhciByZWN0ID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICByZXR1cm4gcmVjdC50b3AgPj0gMCAmJiByZWN0LmxlZnQgPj0gMCAmJiByZWN0LmJvdHRvbSArIDgwIDw9IHdpbmRvdy5pbm5lckhlaWdodCAmJiAvLyBhZGQgODAgdG8gZ2V0IHRoZSB0ZXh0IHJpZ2h0CiAgICByZWN0LnJpZ2h0IDw9IHdpbmRvdy5pbm5lcldpZHRoOwogIH0KICAvKioKICAgKiBUbyBjaGFuZ2UgdGhlIHNjcm9sbCBvZiBgd2luZG93YCBhZnRlciBoaWdobGlnaHRpbmcgYW4gZWxlbWVudAogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfc2Nyb2xsVG8KICAgKiBAcGFyYW0ge1N0cmluZ30gc2Nyb2xsVG8KICAgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0RWxlbWVudAogICAqIEBwYXJhbSB7T2JqZWN0fSB0b29sdGlwTGF5ZXIKICAgKi8KCgogIGZ1bmN0aW9uIHNjcm9sbFRvKHNjcm9sbFRvLCBfcmVmLCB0b29sdGlwTGF5ZXIpIHsKICAgIHZhciBlbGVtZW50ID0gX3JlZi5lbGVtZW50OwogICAgaWYgKHNjcm9sbFRvID09PSAib2ZmIikgcmV0dXJuOwogICAgdmFyIHJlY3Q7CiAgICBpZiAoIXRoaXMuX29wdGlvbnMuc2Nyb2xsVG9FbGVtZW50KSByZXR1cm47CgogICAgaWYgKHNjcm9sbFRvID09PSAidG9vbHRpcCIpIHsKICAgICAgcmVjdCA9IHRvb2x0aXBMYXllci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIH0gZWxzZSB7CiAgICAgIHJlY3QgPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgfQoKICAgIGlmICghZWxlbWVudEluVmlld3BvcnQoZWxlbWVudCkpIHsKICAgICAgdmFyIHdpbkhlaWdodCA9IGdldFdpblNpemUoKS5oZWlnaHQ7CiAgICAgIHZhciB0b3AgPSByZWN0LmJvdHRvbSAtIChyZWN0LmJvdHRvbSAtIHJlY3QudG9wKTsgLy8gVE9ETyAoYWZzaGlubSk6IGRvIHdlIG5lZWQgc2Nyb2xsIHBhZGRpbmcgbm93PwogICAgICAvLyBJIGhhdmUgY2hhbmdlZCB0aGUgc2Nyb2xsIG9wdGlvbiBhbmQgbm93IGl0IHNjcm9sbHMgdGhlIHdpbmRvdyB0bwogICAgICAvLyB0aGUgY2VudGVyIG9mIHRoZSB0YXJnZXQgZWxlbWVudCBvciB0b29sdGlwLgoKICAgICAgaWYgKHRvcCA8IDAgfHwgZWxlbWVudC5jbGllbnRIZWlnaHQgPiB3aW5IZWlnaHQpIHsKICAgICAgICB3aW5kb3cuc2Nyb2xsQnkoMCwgcmVjdC50b3AgLSAod2luSGVpZ2h0IC8gMiAtIHJlY3QuaGVpZ2h0IC8gMikgLSB0aGlzLl9vcHRpb25zLnNjcm9sbFBhZGRpbmcpOyAvLyAzMHB4IHBhZGRpbmcgZnJvbSBlZGdlIHRvIGxvb2sgbmljZQogICAgICAgIC8vU2Nyb2xsIGRvd24KICAgICAgfSBlbHNlIHsKICAgICAgICB3aW5kb3cuc2Nyb2xsQnkoMCwgcmVjdC50b3AgLSAod2luSGVpZ2h0IC8gMiAtIHJlY3QuaGVpZ2h0IC8gMikgKyB0aGlzLl9vcHRpb25zLnNjcm9sbFBhZGRpbmcpOyAvLyAzMHB4IHBhZGRpbmcgZnJvbSBlZGdlIHRvIGxvb2sgbmljZQogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIFNldHRpbmcgYW5jaG9ycyB0byBiZWhhdmUgbGlrZSBidXR0b25zCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9zZXRBbmNob3JBc0J1dHRvbgogICAqLwoKCiAgZnVuY3Rpb24gc2V0QW5jaG9yQXNCdXR0b24oYW5jaG9yKSB7CiAgICBhbmNob3Iuc2V0QXR0cmlidXRlKCJyb2xlIiwgImJ1dHRvbiIpOwogICAgYW5jaG9yLnRhYkluZGV4ID0gMDsKICB9CiAgLyoqCiAgICogR2V0IGFuIGVsZW1lbnQgcG9zaXRpb24gb24gdGhlIHBhZ2UKICAgKiBUaGFua3MgdG8gYG1lb3V3YDogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvNDQyNDc0LzM3NTk2NgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfZ2V0T2Zmc2V0CiAgICogQHBhcmFtIHtPYmplY3R9IGVsZW1lbnQKICAgKiBAcmV0dXJucyBFbGVtZW50J3MgcG9zaXRpb24gaW5mbwogICAqLwoKCiAgZnVuY3Rpb24gZ2V0T2Zmc2V0KGVsZW1lbnQpIHsKICAgIHZhciBib2R5ID0gZG9jdW1lbnQuYm9keTsKICAgIHZhciBkb2NFbCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICAgIHZhciBzY3JvbGxUb3AgPSB3aW5kb3cucGFnZVlPZmZzZXQgfHwgZG9jRWwuc2Nyb2xsVG9wIHx8IGJvZHkuc2Nyb2xsVG9wOwogICAgdmFyIHNjcm9sbExlZnQgPSB3aW5kb3cucGFnZVhPZmZzZXQgfHwgZG9jRWwuc2Nyb2xsTGVmdCB8fCBib2R5LnNjcm9sbExlZnQ7CiAgICB2YXIgeCA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICByZXR1cm4gewogICAgICB0b3A6IHgudG9wICsgc2Nyb2xsVG9wLAogICAgICB3aWR0aDogeC53aWR0aCwKICAgICAgaGVpZ2h0OiB4LmhlaWdodCwKICAgICAgbGVmdDogeC5sZWZ0ICsgc2Nyb2xsTGVmdAogICAgfTsKICB9CiAgLyoqCiAgICogQ2hlY2tzIHRvIHNlZSBpZiB0YXJnZXQgZWxlbWVudCAob3IgcGFyZW50cykgcG9zaXRpb24gaXMgZml4ZWQgb3Igbm90CiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9pc0ZpeGVkCiAgICogQHBhcmFtIHtPYmplY3R9IGVsZW1lbnQKICAgKiBAcmV0dXJucyBCb29sZWFuCiAgICovCgoKICBmdW5jdGlvbiBpc0ZpeGVkKGVsZW1lbnQpIHsKICAgIHZhciBwID0gZWxlbWVudC5wYXJlbnROb2RlOwoKICAgIGlmICghcCB8fCBwLm5vZGVOYW1lID09PSAiSFRNTCIpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmIChnZXRQcm9wVmFsdWUoZWxlbWVudCwgInBvc2l0aW9uIikgPT09ICJmaXhlZCIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgcmV0dXJuIGlzRml4ZWQocCk7CiAgfQogIC8qKgogICAqIFVwZGF0ZSB0aGUgcG9zaXRpb24gb2YgdGhlIGhlbHBlciBsYXllciBvbiB0aGUgc2NyZWVuCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9zZXRIZWxwZXJMYXllclBvc2l0aW9uCiAgICogQHBhcmFtIHtPYmplY3R9IGhlbHBlckxheWVyCiAgICovCgoKICBmdW5jdGlvbiBzZXRIZWxwZXJMYXllclBvc2l0aW9uKGhlbHBlckxheWVyKSB7CiAgICBpZiAoaGVscGVyTGF5ZXIpIHsKICAgICAgLy9wcmV2ZW50IGVycm9yIHdoZW4gYHRoaXMuX2N1cnJlbnRTdGVwYCBpbiB1bmRlZmluZWQKICAgICAgaWYgKCF0aGlzLl9pbnRyb0l0ZW1zW3RoaXMuX2N1cnJlbnRTdGVwXSkgcmV0dXJuOwogICAgICB2YXIgY3VycmVudEVsZW1lbnQgPSB0aGlzLl9pbnRyb0l0ZW1zW3RoaXMuX2N1cnJlbnRTdGVwXTsKICAgICAgdmFyIGVsZW1lbnRQb3NpdGlvbiA9IGdldE9mZnNldChjdXJyZW50RWxlbWVudC5lbGVtZW50KTsKICAgICAgdmFyIHdpZHRoSGVpZ2h0UGFkZGluZyA9IHRoaXMuX29wdGlvbnMuaGVscGVyRWxlbWVudFBhZGRpbmc7IC8vIElmIHRoZSB0YXJnZXQgZWxlbWVudCBpcyBmaXhlZCwgdGhlIHRvb2x0aXAgc2hvdWxkIGJlIGZpeGVkIGFzIHdlbGwuCiAgICAgIC8vIE90aGVyd2lzZSwgcmVtb3ZlIGEgZml4ZWQgY2xhc3MgdGhhdCBtYXkgYmUgbGVmdCBvdmVyIGZyb20gdGhlIHByZXZpb3VzCiAgICAgIC8vIHN0ZXAuCgogICAgICBpZiAoaXNGaXhlZChjdXJyZW50RWxlbWVudC5lbGVtZW50KSkgewogICAgICAgIGFkZENsYXNzKGhlbHBlckxheWVyLCAiaW50cm9qcy1maXhlZFRvb2x0aXAiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZW1vdmVDbGFzcyhoZWxwZXJMYXllciwgImludHJvanMtZml4ZWRUb29sdGlwIik7CiAgICAgIH0KCiAgICAgIGlmIChjdXJyZW50RWxlbWVudC5wb3NpdGlvbiA9PT0gImZsb2F0aW5nIikgewogICAgICAgIHdpZHRoSGVpZ2h0UGFkZGluZyA9IDA7CiAgICAgIH0gLy9zZXQgbmV3IHBvc2l0aW9uIHRvIGhlbHBlciBsYXllcgoKCiAgICAgIGhlbHBlckxheWVyLnN0eWxlLmNzc1RleHQgPSAid2lkdGg6ICIuY29uY2F0KGVsZW1lbnRQb3NpdGlvbi53aWR0aCArIHdpZHRoSGVpZ2h0UGFkZGluZywgInB4OyBoZWlnaHQ6IikuY29uY2F0KGVsZW1lbnRQb3NpdGlvbi5oZWlnaHQgKyB3aWR0aEhlaWdodFBhZGRpbmcsICJweDsgdG9wOiIpLmNvbmNhdChlbGVtZW50UG9zaXRpb24udG9wIC0gd2lkdGhIZWlnaHRQYWRkaW5nIC8gMiwgInB4O2xlZnQ6ICIpLmNvbmNhdChlbGVtZW50UG9zaXRpb24ubGVmdCAtIHdpZHRoSGVpZ2h0UGFkZGluZyAvIDIsICJweDsiKTsKICAgIH0KICB9CiAgLyoqCiAgICogU2V0IHRvb2x0aXAgbGVmdCBzbyBpdCBkb2Vzbid0IGdvIG9mZiB0aGUgcmlnaHQgc2lkZSBvZiB0aGUgd2luZG93CiAgICoKICAgKiBAcmV0dXJuIGJvb2xlYW4gdHJ1ZSwgaWYgdG9vbHRpcExheWVyU3R5bGVMZWZ0IGlzIG9rLiAgZmFsc2UsIG90aGVyd2lzZS4KICAgKi8KCgogIGZ1bmN0aW9uIGNoZWNrUmlnaHQodGFyZ2V0T2Zmc2V0LCB0b29sdGlwTGF5ZXJTdHlsZUxlZnQsIHRvb2x0aXBPZmZzZXQsIHdpbmRvd1NpemUsIHRvb2x0aXBMYXllcikgewogICAgaWYgKHRhcmdldE9mZnNldC5sZWZ0ICsgdG9vbHRpcExheWVyU3R5bGVMZWZ0ICsgdG9vbHRpcE9mZnNldC53aWR0aCA+IHdpbmRvd1NpemUud2lkdGgpIHsKICAgICAgLy8gb2ZmIHRoZSByaWdodCBzaWRlIG9mIHRoZSB3aW5kb3cKICAgICAgdG9vbHRpcExheWVyLmxlZnQgPSAiIi5jb25jYXQod2luZG93U2l6ZS53aWR0aCAtIHRvb2x0aXBPZmZzZXQud2lkdGggLSB0YXJnZXRPZmZzZXQubGVmdCwgInB4Iik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICB0b29sdGlwTGF5ZXIubGVmdCA9ICIiLmNvbmNhdCh0b29sdGlwTGF5ZXJTdHlsZUxlZnQsICJweCIpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIC8qKgogICAqIFNldCB0b29sdGlwIHJpZ2h0IHNvIGl0IGRvZXNuJ3QgZ28gb2ZmIHRoZSBsZWZ0IHNpZGUgb2YgdGhlIHdpbmRvdwogICAqCiAgICogQHJldHVybiBib29sZWFuIHRydWUsIGlmIHRvb2x0aXBMYXllclN0eWxlUmlnaHQgaXMgb2suICBmYWxzZSwgb3RoZXJ3aXNlLgogICAqLwoKCiAgZnVuY3Rpb24gY2hlY2tMZWZ0KHRhcmdldE9mZnNldCwgdG9vbHRpcExheWVyU3R5bGVSaWdodCwgdG9vbHRpcE9mZnNldCwgdG9vbHRpcExheWVyKSB7CiAgICBpZiAodGFyZ2V0T2Zmc2V0LmxlZnQgKyB0YXJnZXRPZmZzZXQud2lkdGggLSB0b29sdGlwTGF5ZXJTdHlsZVJpZ2h0IC0gdG9vbHRpcE9mZnNldC53aWR0aCA8IDApIHsKICAgICAgLy8gb2ZmIHRoZSBsZWZ0IHNpZGUgb2YgdGhlIHdpbmRvdwogICAgICB0b29sdGlwTGF5ZXIuc3R5bGUubGVmdCA9ICIiLmNvbmNhdCgtdGFyZ2V0T2Zmc2V0LmxlZnQsICJweCIpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgdG9vbHRpcExheWVyLnN0eWxlLnJpZ2h0ID0gIiIuY29uY2F0KHRvb2x0aXBMYXllclN0eWxlUmlnaHQsICJweCIpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIC8qKgogICAqIFJlbW92ZSBhbiBlbnRyeSBmcm9tIGEgc3RyaW5nIGFycmF5IGlmIGl0J3MgdGhlcmUsIGRvZXMgbm90aGluZyBpZiBpdCBpc24ndCB0aGVyZS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IHN0cmluZ0FycmF5CiAgICogQHBhcmFtIHtTdHJpbmd9IHN0cmluZ1RvUmVtb3ZlCiAgICovCgoKICBmdW5jdGlvbiByZW1vdmVFbnRyeShzdHJpbmdBcnJheSwgc3RyaW5nVG9SZW1vdmUpIHsKICAgIGlmIChzdHJpbmdBcnJheS5pbmNsdWRlcyhzdHJpbmdUb1JlbW92ZSkpIHsKICAgICAgc3RyaW5nQXJyYXkuc3BsaWNlKHN0cmluZ0FycmF5LmluZGV4T2Yoc3RyaW5nVG9SZW1vdmUpLCAxKTsKICAgIH0KICB9CiAgLyoqCiAgICogYXV0by1kZXRlcm1pbmUgYWxpZ25tZW50CiAgICogQHBhcmFtIHtJbnRlZ2VyfSAgb2Zmc2V0TGVmdAogICAqIEBwYXJhbSB7SW50ZWdlcn0gIHRvb2x0aXBXaWR0aAogICAqIEBwYXJhbSB7T2JqZWN0fSAgIHdpbmRvd1NpemUKICAgKiBAcGFyYW0ge1N0cmluZ30gICBkZXNpcmVkQWxpZ25tZW50CiAgICogQHJldHVybiB7U3RyaW5nfSAgY2FsY3VsYXRlZEFsaWdubWVudAogICAqLwoKCiAgZnVuY3Rpb24gX2RldGVybWluZUF1dG9BbGlnbm1lbnQob2Zmc2V0TGVmdCwgdG9vbHRpcFdpZHRoLCBfcmVmLCBkZXNpcmVkQWxpZ25tZW50KSB7CiAgICB2YXIgd2lkdGggPSBfcmVmLndpZHRoOwogICAgdmFyIGhhbGZUb29sdGlwV2lkdGggPSB0b29sdGlwV2lkdGggLyAyOwogICAgdmFyIHdpbldpZHRoID0gTWF0aC5taW4od2lkdGgsIHdpbmRvdy5zY3JlZW4ud2lkdGgpOwogICAgdmFyIHBvc3NpYmxlQWxpZ25tZW50cyA9IFsiLWxlZnQtYWxpZ25lZCIsICItbWlkZGxlLWFsaWduZWQiLCAiLXJpZ2h0LWFsaWduZWQiXTsKICAgIHZhciBjYWxjdWxhdGVkQWxpZ25tZW50ID0gIiI7IC8vIHZhbGlkIGxlZnQgbXVzdCBiZSBhdCBsZWFzdCBhIHRvb2x0aXBXaWR0aAogICAgLy8gYXdheSBmcm9tIHJpZ2h0IHNpZGUKCiAgICBpZiAod2luV2lkdGggLSBvZmZzZXRMZWZ0IDwgdG9vbHRpcFdpZHRoKSB7CiAgICAgIHJlbW92ZUVudHJ5KHBvc3NpYmxlQWxpZ25tZW50cywgIi1sZWZ0LWFsaWduZWQiKTsKICAgIH0gLy8gdmFsaWQgbWlkZGxlIG11c3QgYmUgYXQgbGVhc3QgaGFsZgogICAgLy8gd2lkdGggYXdheSBmcm9tIGJvdGggc2lkZXMKCgogICAgaWYgKG9mZnNldExlZnQgPCBoYWxmVG9vbHRpcFdpZHRoIHx8IHdpbldpZHRoIC0gb2Zmc2V0TGVmdCA8IGhhbGZUb29sdGlwV2lkdGgpIHsKICAgICAgcmVtb3ZlRW50cnkocG9zc2libGVBbGlnbm1lbnRzLCAiLW1pZGRsZS1hbGlnbmVkIik7CiAgICB9IC8vIHZhbGlkIHJpZ2h0IG11c3QgYmUgYXQgbGVhc3QgYSB0b29sdGlwV2lkdGgKICAgIC8vIHdpZHRoIGF3YXkgZnJvbSBsZWZ0IHNpZGUKCgogICAgaWYgKG9mZnNldExlZnQgPCB0b29sdGlwV2lkdGgpIHsKICAgICAgcmVtb3ZlRW50cnkocG9zc2libGVBbGlnbm1lbnRzLCAiLXJpZ2h0LWFsaWduZWQiKTsKICAgIH0KCiAgICBpZiAocG9zc2libGVBbGlnbm1lbnRzLmxlbmd0aCkgewogICAgICBpZiAocG9zc2libGVBbGlnbm1lbnRzLmluY2x1ZGVzKGRlc2lyZWRBbGlnbm1lbnQpKSB7CiAgICAgICAgLy8gdGhlIGRlc2lyZWQgYWxpZ25tZW50IGlzIHZhbGlkCiAgICAgICAgY2FsY3VsYXRlZEFsaWdubWVudCA9IGRlc2lyZWRBbGlnbm1lbnQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gcGljayB0aGUgZmlyc3QgdmFsaWQgcG9zaXRpb24sIGluIG9yZGVyCiAgICAgICAgY2FsY3VsYXRlZEFsaWdubWVudCA9IHBvc3NpYmxlQWxpZ25tZW50c1swXTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gaWYgc2NyZWVuIHdpZHRoIGlzIHRvbyBzbWFsbAogICAgICAvLyBmb3IgQU5ZIGFsaWdubWVudCwgbWlkZGxlIGlzCiAgICAgIC8vIHByb2JhYmx5IHRoZSBiZXN0IGZvciB2aXNpYmlsaXR5CiAgICAgIGNhbGN1bGF0ZWRBbGlnbm1lbnQgPSAiLW1pZGRsZS1hbGlnbmVkIjsKICAgIH0KCiAgICByZXR1cm4gY2FsY3VsYXRlZEFsaWdubWVudDsKICB9CiAgLyoqCiAgICogRGV0ZXJtaW5lcyB0aGUgcG9zaXRpb24gb2YgdGhlIHRvb2x0aXAgYmFzZWQgb24gdGhlIHBvc2l0aW9uIHByZWNlZGVuY2UgYW5kIGF2YWlsYWJpbGl0eQogICAqIG9mIHNjcmVlbiBzcGFjZS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSAgICB0YXJnZXRFbGVtZW50CiAgICogQHBhcmFtIHtPYmplY3R9ICAgIHRvb2x0aXBMYXllcgogICAqIEBwYXJhbSB7U3RyaW5nfSAgICBkZXNpcmVkVG9vbHRpcFBvc2l0aW9uCiAgICogQHJldHVybiB7U3RyaW5nfSAgIGNhbGN1bGF0ZWRQb3NpdGlvbgogICAqLwoKCiAgZnVuY3Rpb24gX2RldGVybWluZUF1dG9Qb3NpdGlvbih0YXJnZXRFbGVtZW50LCB0b29sdGlwTGF5ZXIsIGRlc2lyZWRUb29sdGlwUG9zaXRpb24pIHsKICAgIC8vIFRha2UgYSBjbG9uZSBvZiBwb3NpdGlvbiBwcmVjZWRlbmNlLiBUaGVzZSB3aWxsIGJlIHRoZSBhdmFpbGFibGUKICAgIHZhciBwb3NzaWJsZVBvc2l0aW9ucyA9IHRoaXMuX29wdGlvbnMucG9zaXRpb25QcmVjZWRlbmNlLnNsaWNlKCk7CgogICAgdmFyIHdpbmRvd1NpemUgPSBnZXRXaW5TaXplKCk7CiAgICB2YXIgdG9vbHRpcEhlaWdodCA9IGdldE9mZnNldCh0b29sdGlwTGF5ZXIpLmhlaWdodCArIDEwOwogICAgdmFyIHRvb2x0aXBXaWR0aCA9IGdldE9mZnNldCh0b29sdGlwTGF5ZXIpLndpZHRoICsgMjA7CiAgICB2YXIgdGFyZ2V0RWxlbWVudFJlY3QgPSB0YXJnZXRFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOyAvLyBJZiB3ZSBjaGVjayBhbGwgdGhlIHBvc3NpYmxlIGFyZWFzLCBhbmQgdGhlcmUgYXJlIG5vIHZhbGlkIHBsYWNlcyBmb3IgdGhlIHRvb2x0aXAsIHRoZSBlbGVtZW50CiAgICAvLyBtdXN0IHRha2UgdXAgbW9zdCBvZiB0aGUgc2NyZWVuIHJlYWwgZXN0YXRlLiBTaG93IHRoZSB0b29sdGlwIGZsb2F0aW5nIGluIHRoZSBtaWRkbGUgb2YgdGhlIHNjcmVlbi4KCiAgICB2YXIgY2FsY3VsYXRlZFBvc2l0aW9uID0gImZsb2F0aW5nIjsKICAgIC8qCiAgICAgKiBhdXRvIGRldGVybWluZSBwb3NpdGlvbgogICAgICovCiAgICAvLyBDaGVjayBmb3Igc3BhY2UgYmVsb3cKCiAgICBpZiAodGFyZ2V0RWxlbWVudFJlY3QuYm90dG9tICsgdG9vbHRpcEhlaWdodCA+IHdpbmRvd1NpemUuaGVpZ2h0KSB7CiAgICAgIHJlbW92ZUVudHJ5KHBvc3NpYmxlUG9zaXRpb25zLCAiYm90dG9tIik7CiAgICB9IC8vIENoZWNrIGZvciBzcGFjZSBhYm92ZQoKCiAgICBpZiAodGFyZ2V0RWxlbWVudFJlY3QudG9wIC0gdG9vbHRpcEhlaWdodCA8IDApIHsKICAgICAgcmVtb3ZlRW50cnkocG9zc2libGVQb3NpdGlvbnMsICJ0b3AiKTsKICAgIH0gLy8gQ2hlY2sgZm9yIHNwYWNlIHRvIHRoZSByaWdodAoKCiAgICBpZiAodGFyZ2V0RWxlbWVudFJlY3QucmlnaHQgKyB0b29sdGlwV2lkdGggPiB3aW5kb3dTaXplLndpZHRoKSB7CiAgICAgIHJlbW92ZUVudHJ5KHBvc3NpYmxlUG9zaXRpb25zLCAicmlnaHQiKTsKICAgIH0gLy8gQ2hlY2sgZm9yIHNwYWNlIHRvIHRoZSBsZWZ0CgoKICAgIGlmICh0YXJnZXRFbGVtZW50UmVjdC5sZWZ0IC0gdG9vbHRpcFdpZHRoIDwgMCkgewogICAgICByZW1vdmVFbnRyeShwb3NzaWJsZVBvc2l0aW9ucywgImxlZnQiKTsKICAgIH0gLy8gQHZhciB7U3RyaW5nfSAgZXg6ICdyaWdodC1hbGlnbmVkJwoKCiAgICB2YXIgZGVzaXJlZEFsaWdubWVudCA9IGZ1bmN0aW9uIChwb3MpIHsKICAgICAgdmFyIGh5cGhlbkluZGV4ID0gcG9zLmluZGV4T2YoIi0iKTsKCiAgICAgIGlmIChoeXBoZW5JbmRleCAhPT0gLTEpIHsKICAgICAgICAvLyBoYXMgYWxpZ25tZW50CiAgICAgICAgcmV0dXJuIHBvcy5zdWJzdHIoaHlwaGVuSW5kZXgpOwogICAgICB9CgogICAgICByZXR1cm4gIiI7CiAgICB9KGRlc2lyZWRUb29sdGlwUG9zaXRpb24gfHwgIiIpOyAvLyBzdHJpcCBhbGlnbm1lbnQgZnJvbSBwb3NpdGlvbgoKCiAgICBpZiAoZGVzaXJlZFRvb2x0aXBQb3NpdGlvbikgewogICAgICAvLyBleDogImJvdHRvbS1yaWdodC1hbGlnbmVkIgogICAgICAvLyBzaG91bGQgcmV0dXJuICdib3R0b20nCiAgICAgIGRlc2lyZWRUb29sdGlwUG9zaXRpb24gPSBkZXNpcmVkVG9vbHRpcFBvc2l0aW9uLnNwbGl0KCItIilbMF07CiAgICB9CgogICAgaWYgKHBvc3NpYmxlUG9zaXRpb25zLmxlbmd0aCkgewogICAgICBpZiAoZGVzaXJlZFRvb2x0aXBQb3NpdGlvbiAhPT0gImF1dG8iICYmIHBvc3NpYmxlUG9zaXRpb25zLmluY2x1ZGVzKGRlc2lyZWRUb29sdGlwUG9zaXRpb24pKSB7CiAgICAgICAgLy8gSWYgdGhlIHJlcXVlc3RlZCBwb3NpdGlvbiBpcyBpbiB0aGUgbGlzdCwgY2hvb3NlIHRoYXQKICAgICAgICBjYWxjdWxhdGVkUG9zaXRpb24gPSBkZXNpcmVkVG9vbHRpcFBvc2l0aW9uOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFBpY2sgdGhlIGZpcnN0IHZhbGlkIHBvc2l0aW9uLCBpbiBvcmRlcgogICAgICAgIGNhbGN1bGF0ZWRQb3NpdGlvbiA9IHBvc3NpYmxlUG9zaXRpb25zWzBdOwogICAgICB9CiAgICB9IC8vIG9ubHkgdG9wIGFuZCBib3R0b20gcG9zaXRpb25zIGhhdmUgb3B0aW9uYWwgYWxpZ25tZW50cwoKCiAgICBpZiAoWyJ0b3AiLCAiYm90dG9tIl0uaW5jbHVkZXMoY2FsY3VsYXRlZFBvc2l0aW9uKSkgewogICAgICBjYWxjdWxhdGVkUG9zaXRpb24gKz0gX2RldGVybWluZUF1dG9BbGlnbm1lbnQodGFyZ2V0RWxlbWVudFJlY3QubGVmdCwgdG9vbHRpcFdpZHRoLCB3aW5kb3dTaXplLCBkZXNpcmVkQWxpZ25tZW50KTsKICAgIH0KCiAgICByZXR1cm4gY2FsY3VsYXRlZFBvc2l0aW9uOwogIH0KICAvKioKICAgKiBSZW5kZXIgdG9vbHRpcCBib3ggaW4gdGhlIHBhZ2UKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgcGxhY2VUb29sdGlwCiAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gdGFyZ2V0RWxlbWVudAogICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IHRvb2x0aXBMYXllcgogICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGFycm93TGF5ZXIKICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBoZWxwZXJOdW1iZXJMYXllcgogICAqIEBwYXJhbSB7Qm9vbGVhbn0gaGludE1vZGUKICAgKi8KCgogIGZ1bmN0aW9uIHBsYWNlVG9vbHRpcCh0YXJnZXRFbGVtZW50LCB0b29sdGlwTGF5ZXIsIGFycm93TGF5ZXIsIGhlbHBlck51bWJlckxheWVyLCBoaW50TW9kZSkgewogICAgdmFyIHRvb2x0aXBDc3NDbGFzcyA9ICIiOwogICAgdmFyIGN1cnJlbnRTdGVwT2JqOwogICAgdmFyIHRvb2x0aXBPZmZzZXQ7CiAgICB2YXIgdGFyZ2V0T2Zmc2V0OwogICAgdmFyIHdpbmRvd1NpemU7CiAgICB2YXIgY3VycmVudFRvb2x0aXBQb3NpdGlvbjsKICAgIGhpbnRNb2RlID0gaGludE1vZGUgfHwgZmFsc2U7IC8vcmVzZXQgdGhlIG9sZCBzdHlsZQoKICAgIHRvb2x0aXBMYXllci5zdHlsZS50b3AgPSBudWxsOwogICAgdG9vbHRpcExheWVyLnN0eWxlLnJpZ2h0ID0gbnVsbDsKICAgIHRvb2x0aXBMYXllci5zdHlsZS5ib3R0b20gPSBudWxsOwogICAgdG9vbHRpcExheWVyLnN0eWxlLmxlZnQgPSBudWxsOwogICAgdG9vbHRpcExheWVyLnN0eWxlLm1hcmdpbkxlZnQgPSBudWxsOwogICAgdG9vbHRpcExheWVyLnN0eWxlLm1hcmdpblRvcCA9IG51bGw7CiAgICBhcnJvd0xheWVyLnN0eWxlLmRpc3BsYXkgPSAiaW5oZXJpdCI7CgogICAgaWYgKHR5cGVvZiBoZWxwZXJOdW1iZXJMYXllciAhPT0gInVuZGVmaW5lZCIgJiYgaGVscGVyTnVtYmVyTGF5ZXIgIT09IG51bGwpIHsKICAgICAgaGVscGVyTnVtYmVyTGF5ZXIuc3R5bGUudG9wID0gbnVsbDsKICAgICAgaGVscGVyTnVtYmVyTGF5ZXIuc3R5bGUubGVmdCA9IG51bGw7CiAgICB9IC8vcHJldmVudCBlcnJvciB3aGVuIGB0aGlzLl9jdXJyZW50U3RlcGAgaXMgdW5kZWZpbmVkCgoKICAgIGlmICghdGhpcy5faW50cm9JdGVtc1t0aGlzLl9jdXJyZW50U3RlcF0pIHJldHVybjsgLy9pZiB3ZSBoYXZlIGEgY3VzdG9tIGNzcyBjbGFzcyBmb3IgZWFjaCBzdGVwCgogICAgY3VycmVudFN0ZXBPYmogPSB0aGlzLl9pbnRyb0l0ZW1zW3RoaXMuX2N1cnJlbnRTdGVwXTsKCiAgICBpZiAodHlwZW9mIGN1cnJlbnRTdGVwT2JqLnRvb2x0aXBDbGFzcyA9PT0gInN0cmluZyIpIHsKICAgICAgdG9vbHRpcENzc0NsYXNzID0gY3VycmVudFN0ZXBPYmoudG9vbHRpcENsYXNzOwogICAgfSBlbHNlIHsKICAgICAgdG9vbHRpcENzc0NsYXNzID0gdGhpcy5fb3B0aW9ucy50b29sdGlwQ2xhc3M7CiAgICB9CgogICAgdG9vbHRpcExheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLXRvb2x0aXAgIi5jb25jYXQodG9vbHRpcENzc0NsYXNzKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgIiIpOwogICAgdG9vbHRpcExheWVyLnNldEF0dHJpYnV0ZSgicm9sZSIsICJkaWFsb2ciKTsKICAgIGN1cnJlbnRUb29sdGlwUG9zaXRpb24gPSB0aGlzLl9pbnRyb0l0ZW1zW3RoaXMuX2N1cnJlbnRTdGVwXS5wb3NpdGlvbjsgLy8gRmxvYXRpbmcgaXMgYWx3YXlzIHZhbGlkLCBubyBwb2ludCBpbiBjYWxjdWxhdGluZwoKICAgIGlmIChjdXJyZW50VG9vbHRpcFBvc2l0aW9uICE9PSAiZmxvYXRpbmciKSB7Ly8gY3VycmVudFRvb2x0aXBQb3NpdGlvbiA9IF9kZXRlcm1pbmVBdXRvUG9zaXRpb24uY2FsbCh0aGlzLCB0YXJnZXRFbGVtZW50LCB0b29sdGlwTGF5ZXIsIGN1cnJlbnRUb29sdGlwUG9zaXRpb24pOwogICAgfQoKICAgIHZhciB0b29sdGlwTGF5ZXJTdHlsZUxlZnQ7CiAgICB0YXJnZXRPZmZzZXQgPSBnZXRPZmZzZXQodGFyZ2V0RWxlbWVudCk7CiAgICB0b29sdGlwT2Zmc2V0ID0gZ2V0T2Zmc2V0KHRvb2x0aXBMYXllcik7CiAgICB3aW5kb3dTaXplID0gZ2V0V2luU2l6ZSgpOwogICAgYWRkQ2xhc3ModG9vbHRpcExheWVyLCAiaW50cm9qcy0iLmNvbmNhdChjdXJyZW50VG9vbHRpcFBvc2l0aW9uKSk7CgogICAgc3dpdGNoIChjdXJyZW50VG9vbHRpcFBvc2l0aW9uKSB7CiAgICAgIGNhc2UgInRvcC1yaWdodC1hbGlnbmVkIjoKICAgICAgICBhcnJvd0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWFycm93IGJvdHRvbS1yaWdodCI7CiAgICAgICAgdmFyIHRvb2x0aXBMYXllclN0eWxlUmlnaHQgPSAwOwogICAgICAgIGNoZWNrTGVmdCh0YXJnZXRPZmZzZXQsIHRvb2x0aXBMYXllclN0eWxlUmlnaHQsIHRvb2x0aXBPZmZzZXQsIHRvb2x0aXBMYXllcik7CiAgICAgICAgdG9vbHRpcExheWVyLnN0eWxlLmJvdHRvbSA9ICIiLmNvbmNhdCh0YXJnZXRPZmZzZXQuaGVpZ2h0ICsgMjAsICJweCIpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAidG9wLW1pZGRsZS1hbGlnbmVkIjoKICAgICAgICBhcnJvd0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWFycm93IGJvdHRvbS1taWRkbGUiOwogICAgICAgIHZhciB0b29sdGlwTGF5ZXJTdHlsZUxlZnRSaWdodCA9IHRhcmdldE9mZnNldC53aWR0aCAvIDIgLSB0b29sdGlwT2Zmc2V0LndpZHRoIC8gMjsgLy8gYSBmaXggZm9yIG1pZGRsZSBhbGlnbmVkIGhpbnRzCgogICAgICAgIGlmIChoaW50TW9kZSkgewogICAgICAgICAgdG9vbHRpcExheWVyU3R5bGVMZWZ0UmlnaHQgKz0gNTsKICAgICAgICB9CgogICAgICAgIGlmIChjaGVja0xlZnQodGFyZ2V0T2Zmc2V0LCB0b29sdGlwTGF5ZXJTdHlsZUxlZnRSaWdodCwgdG9vbHRpcE9mZnNldCwgdG9vbHRpcExheWVyKSkgewogICAgICAgICAgdG9vbHRpcExheWVyLnN0eWxlLnJpZ2h0ID0gbnVsbDsKICAgICAgICAgIGNoZWNrUmlnaHQodGFyZ2V0T2Zmc2V0LCB0b29sdGlwTGF5ZXJTdHlsZUxlZnRSaWdodCwgdG9vbHRpcE9mZnNldCwgd2luZG93U2l6ZSwgdG9vbHRpcExheWVyKTsKICAgICAgICB9CgogICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS5ib3R0b20gPSAiIi5jb25jYXQodGFyZ2V0T2Zmc2V0LmhlaWdodCArIDIwLCAicHgiKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgInRvcC1sZWZ0LWFsaWduZWQiOiAvLyB0b3AtbGVmdC1hbGlnbmVkIGlzIHRoZSBzYW1lIGFzIHRoZSBkZWZhdWx0IHRvcAoKICAgICAgY2FzZSAidG9wIjoKICAgICAgICBhcnJvd0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWFycm93IGJvdHRvbSI7CiAgICAgICAgdG9vbHRpcExheWVyU3R5bGVMZWZ0ID0gaGludE1vZGUgPyAwIDogMTU7CiAgICAgICAgY2hlY2tSaWdodCh0YXJnZXRPZmZzZXQsIHRvb2x0aXBMYXllclN0eWxlTGVmdCwgdG9vbHRpcE9mZnNldCwgd2luZG93U2l6ZSwgdG9vbHRpcExheWVyKTsKICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUuYm90dG9tID0gIiIuY29uY2F0KHRhcmdldE9mZnNldC5oZWlnaHQgKyAyMCwgInB4Iik7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICJyaWdodCI6CiAgICAgICAgdG9vbHRpcExheWVyLnN0eWxlLmxlZnQgPSAiIi5jb25jYXQodGFyZ2V0T2Zmc2V0LndpZHRoICsgMjAgKyA2MywgInB4Iik7CiAgICAgICAgdmFyIGltYWdlTGF5ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsKICAgICAgICBpbWFnZUxheWVyLnNyYyA9ICIvaW1nL0dyb3VwMy5zdmciOwogICAgICAgIHZhciBwYXJlbnRfZGl2X2Zvcl9pbWFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXN0b20tYXJyb3ctaW1hZ2UtY2Vuc2UiKTsKCiAgICAgICAgaWYgKHRhcmdldE9mZnNldC50b3AgKyB0b29sdGlwT2Zmc2V0LmhlaWdodCA+IHdpbmRvd1NpemUuaGVpZ2h0KSB7CiAgICAgICAgICAvLyBJbiB0aGlzIGNhc2UsIHJpZ2h0IHdvdWxkIGhhdmUgZmFsbGVuIGJlbG93IHRoZSBib3R0b20gb2YgdGhlIHNjcmVlbi4KICAgICAgICAgIC8vIE1vZGlmeSBzbyB0aGF0IHRoZSBib3R0b20gb2YgdGhlIHRvb2x0aXAgY29ubmVjdHMgd2l0aCB0aGUgdGFyZ2V0CiAgICAgICAgICAvLyBhcnJvd0xheWVyLmFwcGVuZENoaWxkKGltYWdlTGF5ZXIpOwogICAgICAgICAgLy8gcGFyZW50X2Rpdl9mb3JfaW1hZ2UuYXBwZW5kQ2hpbGQoaW1hZ2VMYXllcik7CiAgICAgICAgICBwYXJlbnRfZGl2X2Zvcl9pbWFnZS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CiAgICAgICAgICBwYXJlbnRfZGl2X2Zvcl9pbWFnZS5zdHlsZS5sZWZ0ID0gIi02N3B4IjsKICAgICAgICAgIHBhcmVudF9kaXZfZm9yX2ltYWdlLnN0eWxlLnRvcCA9ICIiLmNvbmNhdCh0YXJnZXRPZmZzZXQuaGVpZ2h0IC0gMTAsICJweCIpOwogICAgICAgICAgYXJyb3dMYXllci5jbGFzc05hbWUgPSAiaW50cm9qcy1hcnJvdyBsZWZ0LWJvdHRvbSI7CiAgICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUudG9wID0gIi0iLmNvbmNhdCh0b29sdGlwT2Zmc2V0LmhlaWdodCAtIHRhcmdldE9mZnNldC5oZWlnaHQgLSAyMCwgInB4Iik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIGFycm93TGF5ZXIuYXBwZW5kQ2hpbGQoaW1hZ2VMYXllcik7CiAgICAgICAgICAvLyBwYXJlbnRfZGl2X2Zvcl9pbWFnZS5hcHBlbmRDaGlsZChpbWFnZUxheWVyKTsKICAgICAgICAgIHBhcmVudF9kaXZfZm9yX2ltYWdlLnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKICAgICAgICAgIHBhcmVudF9kaXZfZm9yX2ltYWdlLnN0eWxlLmxlZnQgPSAiLTY3cHgiOwogICAgICAgICAgcGFyZW50X2Rpdl9mb3JfaW1hZ2Uuc3R5bGUudG9wID0gIiIuY29uY2F0KHRhcmdldE9mZnNldC5oZWlnaHQgLSAxMCwgInB4Iik7IC8vIGFycm93TGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtYXJyb3cgbGVmdCI7CgogICAgICAgICAgYXJyb3dMYXllci5jbGFzc05hbWUgPSAiaW50cm9qcy1hcnJvdyBsZWZ0LWJvdHRvbSI7CiAgICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUudG9wID0gIi0iLmNvbmNhdCh0b29sdGlwT2Zmc2V0LmhlaWdodCAtIHRhcmdldE9mZnNldC5oZWlnaHQgLSAyMCwgInB4Iik7CiAgICAgICAgfQoKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgImxlZnQiOgogICAgICAgIGlmICghaGludE1vZGUgJiYgdGhpcy5fb3B0aW9ucy5zaG93U3RlcE51bWJlcnMgPT09IHRydWUpIHsKICAgICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS50b3AgPSAiMTVweCI7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFyZ2V0T2Zmc2V0LnRvcCArIHRvb2x0aXBPZmZzZXQuaGVpZ2h0ID4gd2luZG93U2l6ZS5oZWlnaHQpIHsKICAgICAgICAgIC8vIEluIHRoaXMgY2FzZSwgbGVmdCB3b3VsZCBoYXZlIGZhbGxlbiBiZWxvdyB0aGUgYm90dG9tIG9mIHRoZSBzY3JlZW4uCiAgICAgICAgICAvLyBNb2RpZnkgc28gdGhhdCB0aGUgYm90dG9tIG9mIHRoZSB0b29sdGlwIGNvbm5lY3RzIHdpdGggdGhlIHRhcmdldAogICAgICAgICAgdG9vbHRpcExheWVyLnN0eWxlLnRvcCA9ICItIi5jb25jYXQodG9vbHRpcE9mZnNldC5oZWlnaHQgLSB0YXJnZXRPZmZzZXQuaGVpZ2h0IC0gMjAsICJweCIpOwogICAgICAgICAgYXJyb3dMYXllci5jbGFzc05hbWUgPSAiaW50cm9qcy1hcnJvdyByaWdodC1ib3R0b20iOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhcnJvd0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWFycm93IHJpZ2h0IjsKICAgICAgICB9CgogICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS5yaWdodCA9ICIiLmNvbmNhdCh0YXJnZXRPZmZzZXQud2lkdGggKyAyMCwgInB4Iik7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICJmbG9hdGluZyI6CiAgICAgICAgYXJyb3dMYXllci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOyAvL3dlIGhhdmUgdG8gYWRqdXN0IHRoZSB0b3AgYW5kIGxlZnQgb2YgbGF5ZXIgbWFudWFsbHkgZm9yIGludHJvIGl0ZW1zIHdpdGhvdXQgZWxlbWVudAoKICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUubGVmdCA9ICI1MCUiOwogICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS50b3AgPSAiNTAlIjsKICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUubWFyZ2luTGVmdCA9ICItIi5jb25jYXQodG9vbHRpcE9mZnNldC53aWR0aCAvIDIsICJweCIpOwogICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS5tYXJnaW5Ub3AgPSAiLSIuY29uY2F0KHRvb2x0aXBPZmZzZXQuaGVpZ2h0IC8gMiwgInB4Iik7CgogICAgICAgIGlmICh0eXBlb2YgaGVscGVyTnVtYmVyTGF5ZXIgIT09ICJ1bmRlZmluZWQiICYmIGhlbHBlck51bWJlckxheWVyICE9PSBudWxsKSB7CiAgICAgICAgICBoZWxwZXJOdW1iZXJMYXllci5zdHlsZS5sZWZ0ID0gIi0iLmNvbmNhdCh0b29sdGlwT2Zmc2V0LndpZHRoIC8gMiArIDE4LCAicHgiKTsKICAgICAgICAgIGhlbHBlck51bWJlckxheWVyLnN0eWxlLnRvcCA9ICItIi5jb25jYXQodG9vbHRpcE9mZnNldC5oZWlnaHQgLyAyICsgMTgsICJweCIpOwogICAgICAgIH0KCiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICJib3R0b20tcmlnaHQtYWxpZ25lZCI6CiAgICAgICAgYXJyb3dMYXllci5jbGFzc05hbWUgPSAiaW50cm9qcy1hcnJvdyB0b3AtcmlnaHQiOwogICAgICAgIHRvb2x0aXBMYXllclN0eWxlUmlnaHQgPSAwOwogICAgICAgIGNoZWNrTGVmdCh0YXJnZXRPZmZzZXQsIHRvb2x0aXBMYXllclN0eWxlUmlnaHQsIHRvb2x0aXBPZmZzZXQsIHRvb2x0aXBMYXllcik7CiAgICAgICAgdG9vbHRpcExheWVyLnN0eWxlLnRvcCA9ICIiLmNvbmNhdCh0YXJnZXRPZmZzZXQuaGVpZ2h0ICsgMjAsICJweCIpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAiYm90dG9tLW1pZGRsZS1hbGlnbmVkIjoKICAgICAgICBhcnJvd0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWFycm93IHRvcC1taWRkbGUiOwogICAgICAgIHRvb2x0aXBMYXllclN0eWxlTGVmdFJpZ2h0ID0gdGFyZ2V0T2Zmc2V0LndpZHRoIC8gMiAtIHRvb2x0aXBPZmZzZXQud2lkdGggLyAyOyAvLyBhIGZpeCBmb3IgbWlkZGxlIGFsaWduZWQgaGludHMKCiAgICAgICAgaWYgKGhpbnRNb2RlKSB7CiAgICAgICAgICB0b29sdGlwTGF5ZXJTdHlsZUxlZnRSaWdodCArPSA1OwogICAgICAgIH0KCiAgICAgICAgaWYgKGNoZWNrTGVmdCh0YXJnZXRPZmZzZXQsIHRvb2x0aXBMYXllclN0eWxlTGVmdFJpZ2h0LCB0b29sdGlwT2Zmc2V0LCB0b29sdGlwTGF5ZXIpKSB7CiAgICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUucmlnaHQgPSBudWxsOwogICAgICAgICAgY2hlY2tSaWdodCh0YXJnZXRPZmZzZXQsIHRvb2x0aXBMYXllclN0eWxlTGVmdFJpZ2h0LCB0b29sdGlwT2Zmc2V0LCB3aW5kb3dTaXplLCB0b29sdGlwTGF5ZXIpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGdldF9sZWZ0X29mZnNldCA9IE1hdGgubWF4KGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCk7CiAgICAgICAgdmFyIGdldF90b3Bfb2Zmc2V0ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodDsgLy8gdG9vbHRpcExheWVyLnN0eWxlLnRvcCA9ICIiLmNvbmNhdCh0YXJnZXRPZmZzZXQuaGVpZ2h0ICsgMjAsICJweCIpOwoKICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUudG9wID0gIiIuY29uY2F0KGdldF90b3Bfb2Zmc2V0IC8gMi4zLCAicHgiKTsKICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUubGVmdCA9ICIiLmNvbmNhdChnZXRfbGVmdF9vZmZzZXQgLyAyLjUsICJweCIpOwogICAgICAgIGJyZWFrOwogICAgICAvLyBjYXNlICdib3R0b20tbGVmdC1hbGlnbmVkJzoKICAgICAgLy8gQm90dG9tLWxlZnQtYWxpZ25lZCBpcyB0aGUgc2FtZSBhcyB0aGUgZGVmYXVsdCBib3R0b20KICAgICAgLy8gY2FzZSAnYm90dG9tJzoKICAgICAgLy8gQm90dG9tIGdvaW5nIHRvIGZvbGxvdyB0aGUgZGVmYXVsdCBiZWhhdmlvcgoKICAgICAgZGVmYXVsdDoKICAgICAgICBhcnJvd0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWFycm93IHRvcCI7CiAgICAgICAgdG9vbHRpcExheWVyU3R5bGVMZWZ0ID0gMDsKICAgICAgICBjaGVja1JpZ2h0KHRhcmdldE9mZnNldCwgdG9vbHRpcExheWVyU3R5bGVMZWZ0LCB0b29sdGlwT2Zmc2V0LCB3aW5kb3dTaXplLCB0b29sdGlwTGF5ZXIpOwogICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS50b3AgPSAiIi5jb25jYXQodGFyZ2V0T2Zmc2V0LmhlaWdodCArIDIwLCAicHgiKTsKICAgIH0KICB9CiAgLyoqCiAgICogVG8gcmVtb3ZlIGFsbCBzaG93IGVsZW1lbnQocykKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX3JlbW92ZVNob3dFbGVtZW50CiAgICovCgoKICBmdW5jdGlvbiByZW1vdmVTaG93RWxlbWVudCgpIHsKICAgIHZhciBlbG1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgiLmludHJvanMtc2hvd0VsZW1lbnQiKTsKICAgIGZvckVhY2goZWxtcywgZnVuY3Rpb24gKGVsbSkgewogICAgICByZW1vdmVDbGFzcyhlbG0sIC9pbnRyb2pzLVthLXpBLVpdKy9nKTsKICAgIH0pOwogIH0KICAvKioKICAgKiBHZXRzIHRoZSBjdXJyZW50IHByb2dyZXNzIHBlcmNlbnRhZ2UKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX2dldFByb2dyZXNzCiAgICogQHJldHVybnMgY3VycmVudCBwcm9ncmVzcyBwZXJjZW50YWdlCiAgICovCgoKICBmdW5jdGlvbiBfZ2V0UHJvZ3Jlc3MoKSB7CiAgICAvLyBTdGVwcyBhcmUgMCBpbmRleGVkCiAgICB2YXIgY3VycmVudFN0ZXAgPSBwYXJzZUludCh0aGlzLl9jdXJyZW50U3RlcCArIDEsIDEwKTsKICAgIHJldHVybiBjdXJyZW50U3RlcCAvIHRoaXMuX2ludHJvSXRlbXMubGVuZ3RoICogMTAwOwogIH0KICAvKioKICAgKiBBZGQgZGlzYWJsZWludGVyYWN0aW9uIGxheWVyIGFuZCBhZGp1c3QgdGhlIHNpemUgYW5kIHBvc2l0aW9uIG9mIHRoZSBsYXllcgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfZGlzYWJsZUludGVyYWN0aW9uCiAgICovCgoKICBmdW5jdGlvbiBfZGlzYWJsZUludGVyYWN0aW9uKCkgewogICAgdmFyIGRpc2FibGVJbnRlcmFjdGlvbkxheWVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtZGlzYWJsZUludGVyYWN0aW9uIik7CgogICAgaWYgKGRpc2FibGVJbnRlcmFjdGlvbkxheWVyID09PSBudWxsKSB7CiAgICAgIGRpc2FibGVJbnRlcmFjdGlvbkxheWVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGRpc2FibGVJbnRlcmFjdGlvbkxheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWRpc2FibGVJbnRlcmFjdGlvbiI7CgogICAgICB0aGlzLl90YXJnZXRFbGVtZW50LmFwcGVuZENoaWxkKGRpc2FibGVJbnRlcmFjdGlvbkxheWVyKTsKICAgIH0KCiAgICBzZXRIZWxwZXJMYXllclBvc2l0aW9uLmNhbGwodGhpcywgZGlzYWJsZUludGVyYWN0aW9uTGF5ZXIpOwogIH0KICAvKioKICAgKiBTaG93IGFuIGVsZW1lbnQgb24gdGhlIHBhZ2UKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX3Nob3dFbGVtZW50CiAgICogQHBhcmFtIHtPYmplY3R9IHRhcmdldEVsZW1lbnQKICAgKi8KCgogIGZ1bmN0aW9uIF9zaG93RWxlbWVudCh0YXJnZXRFbGVtZW50KSB7CiAgICBpZiAodHlwZW9mIHRoaXMuX2ludHJvQ2hhbmdlQ2FsbGJhY2sgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRoaXMuX2ludHJvQ2hhbmdlQ2FsbGJhY2suY2FsbCh0aGlzLCB0YXJnZXRFbGVtZW50LmVsZW1lbnQpOwogICAgfQoKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBvbGRIZWxwZXJMYXllciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWhlbHBlckxheWVyIik7CiAgICB2YXIgb2xkUmVmZXJlbmNlTGF5ZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy10b29sdGlwUmVmZXJlbmNlTGF5ZXIiKTsKICAgIHZhciBoaWdobGlnaHRDbGFzcyA9ICJpbnRyb2pzLWhlbHBlckxheWVyIjsKICAgIHZhciBuZXh0VG9vbHRpcEJ1dHRvbjsKICAgIHZhciBwcmV2VG9vbHRpcEJ1dHRvbjsKICAgIHZhciBza2lwVG9vbHRpcEJ1dHRvbjsKICAgIHZhciBzY3JvbGxQYXJlbnQ7IC8vY2hlY2sgZm9yIGEgY3VycmVudCBzdGVwIGhpZ2hsaWdodCBjbGFzcwoKICAgIGlmICh0eXBlb2YgdGFyZ2V0RWxlbWVudC5oaWdobGlnaHRDbGFzcyA9PT0gInN0cmluZyIpIHsKICAgICAgaGlnaGxpZ2h0Q2xhc3MgKz0gIiAiLmNvbmNhdCh0YXJnZXRFbGVtZW50LmhpZ2hsaWdodENsYXNzKTsKICAgIH0gLy9jaGVjayBmb3Igb3B0aW9ucyBoaWdobGlnaHQgY2xhc3MKCgogICAgaWYgKHR5cGVvZiB0aGlzLl9vcHRpb25zLmhpZ2hsaWdodENsYXNzID09PSAic3RyaW5nIikgewogICAgICBoaWdobGlnaHRDbGFzcyArPSAiICIuY29uY2F0KHRoaXMuX29wdGlvbnMuaGlnaGxpZ2h0Q2xhc3MpOwogICAgfQoKICAgIGlmIChvbGRIZWxwZXJMYXllciAhPT0gbnVsbCkgewogICAgICB2YXIgb2xkSGVscGVyTnVtYmVyTGF5ZXIgPSBvbGRSZWZlcmVuY2VMYXllci5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy1oZWxwZXJOdW1iZXJMYXllciIpOwogICAgICB2YXIgb2xkdG9vbHRpcExheWVyID0gb2xkUmVmZXJlbmNlTGF5ZXIucXVlcnlTZWxlY3RvcigiLmludHJvanMtdG9vbHRpcHRleHQiKTsKICAgICAgdmFyIG9sZEFycm93TGF5ZXIgPSBvbGRSZWZlcmVuY2VMYXllci5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy1hcnJvdyIpOwogICAgICB2YXIgb2xkdG9vbHRpcENvbnRhaW5lciA9IG9sZFJlZmVyZW5jZUxheWVyLnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLXRvb2x0aXAiKTsKICAgICAgc2tpcFRvb2x0aXBCdXR0b24gPSBvbGRSZWZlcmVuY2VMYXllci5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy1za2lwYnV0dG9uIik7CiAgICAgIHByZXZUb29sdGlwQnV0dG9uID0gb2xkUmVmZXJlbmNlTGF5ZXIucXVlcnlTZWxlY3RvcigiLmludHJvanMtcHJldmJ1dHRvbiIpOwogICAgICBuZXh0VG9vbHRpcEJ1dHRvbiA9IG9sZFJlZmVyZW5jZUxheWVyLnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLW5leHRidXR0b24iKTsgLy91cGRhdGUgb3IgcmVzZXQgdGhlIGhlbHBlciBoaWdobGlnaHQgY2xhc3MKCiAgICAgIG9sZEhlbHBlckxheWVyLmNsYXNzTmFtZSA9IGhpZ2hsaWdodENsYXNzOyAvL2hpZGUgdGhlIHRvb2x0aXAKCiAgICAgIGlmIChkb2N1bWVudC5jb250YWlucyhkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibGFiZWxfZGlzcGxheV9kaXYiKSkpIHsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibGFiZWxfZGlzcGxheV9kaXYiKS5yZW1vdmUoKTsKICAgICAgfQoKICAgICAgaWYgKHRhcmdldEVsZW1lbnQubGFiZWxEaXNwbGF5ICE9PSAiV0VMQ09NRSIpIHsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3VzdG9tLWFycm93LWltYWdlLWNlbnNlIikuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImN1c3RvbS1hcnJvdy1pbWFnZS1jZW5zZSIpLnN0eWxlLm9wYWNpdHkgPSAxOwogICAgICB9IGVsc2UgewogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXN0b20tYXJyb3ctaW1hZ2UtY2Vuc2UiKS5zdHlsZS5vcGFjaXR5ID0gMDsKICAgICAgfQoKICAgICAgdmFyIGxhYmVsX2Rpc3BsYXlfZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGxhYmVsX2Rpc3BsYXlfZGl2LmlkID0gImxhYmVsX2Rpc3BsYXlfZGl2IjsKICAgICAgbGFiZWxfZGlzcGxheV9kaXYuc3R5bGUuY29sb3IgPSAiI0ZGRkZGRiI7CiAgICAgIGxhYmVsX2Rpc3BsYXlfZGl2LnN0eWxlLnRleHRBbGlnbiA9ICJjZW50ZXIiOwogICAgICBsYWJlbF9kaXNwbGF5X2Rpdi5zdHlsZS5tYXJnaW5Ub3AgPSAiMC41cmVtIjsKICAgICAgbGFiZWxfZGlzcGxheV9kaXYuaW5uZXJIVE1MID0gdGFyZ2V0RWxlbWVudC5sYWJlbERpc3BsYXk7CiAgICAgIG9sZEhlbHBlckxheWVyLmFwcGVuZENoaWxkKGxhYmVsX2Rpc3BsYXlfZGl2KTsgLy8gb2xkSGVscGVyTGF5ZXIuaW5uZXJIVE1MID0gdGFyZ2V0RWxlbWVudC5sYWJlbERpc3BsYXk7CgogICAgICBvbGR0b29sdGlwQ29udGFpbmVyLnN0eWxlLm9wYWNpdHkgPSAwOwogICAgICBvbGR0b29sdGlwQ29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgogICAgICBpZiAob2xkSGVscGVyTnVtYmVyTGF5ZXIgIT09IG51bGwpIHsKICAgICAgICB2YXIgbGFzdEludHJvSXRlbSA9IHRoaXMuX2ludHJvSXRlbXNbdGFyZ2V0RWxlbWVudC5zdGVwIC0gMiA+PSAwID8gdGFyZ2V0RWxlbWVudC5zdGVwIC0gMiA6IDBdOwoKICAgICAgICBpZiAobGFzdEludHJvSXRlbSAhPT0gbnVsbCAmJiB0aGlzLl9kaXJlY3Rpb24gPT09ICJmb3J3YXJkIiAmJiBsYXN0SW50cm9JdGVtLnBvc2l0aW9uID09PSAiZmxvYXRpbmciIHx8IHRoaXMuX2RpcmVjdGlvbiA9PT0gImJhY2t3YXJkIiAmJiB0YXJnZXRFbGVtZW50LnBvc2l0aW9uID09PSAiZmxvYXRpbmciKSB7CiAgICAgICAgICBvbGRIZWxwZXJOdW1iZXJMYXllci5zdHlsZS5vcGFjaXR5ID0gMDsKICAgICAgICB9CiAgICAgIH0gLy8gc2Nyb2xsIHRvIGVsZW1lbnQKCgogICAgICBzY3JvbGxQYXJlbnQgPSBnZXRTY3JvbGxQYXJlbnQodGFyZ2V0RWxlbWVudC5lbGVtZW50KTsKCiAgICAgIGlmIChzY3JvbGxQYXJlbnQgIT09IGRvY3VtZW50LmJvZHkpIHsKICAgICAgICAvLyB0YXJnZXQgaXMgd2l0aGluIGEgc2Nyb2xsYWJsZSBlbGVtZW50CiAgICAgICAgc2Nyb2xsUGFyZW50VG9FbGVtZW50KHNjcm9sbFBhcmVudCwgdGFyZ2V0RWxlbWVudC5lbGVtZW50KTsKICAgICAgfSAvLyBzZXQgbmV3IHBvc2l0aW9uIHRvIGhlbHBlciBsYXllcgoKCiAgICAgIHNldEhlbHBlckxheWVyUG9zaXRpb24uY2FsbChzZWxmLCBvbGRIZWxwZXJMYXllcik7CiAgICAgIHNldEhlbHBlckxheWVyUG9zaXRpb24uY2FsbChzZWxmLCBvbGRSZWZlcmVuY2VMYXllcik7IC8vcmVtb3ZlIGBpbnRyb2pzLWZpeFBhcmVudGAgY2xhc3MgZnJvbSB0aGUgZWxlbWVudHMKCiAgICAgIHZhciBmaXhQYXJlbnRzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgiLmludHJvanMtZml4UGFyZW50Iik7CiAgICAgIGZvckVhY2goZml4UGFyZW50cywgZnVuY3Rpb24gKHBhcmVudCkgewogICAgICAgIHJlbW92ZUNsYXNzKHBhcmVudCwgL2ludHJvanMtZml4UGFyZW50L2cpOwogICAgICB9KTsgLy9yZW1vdmUgb2xkIGNsYXNzZXMgaWYgdGhlIGVsZW1lbnQgc3RpbGwgZXhpc3QKCiAgICAgIHJlbW92ZVNob3dFbGVtZW50KCk7IC8vd2Ugc2hvdWxkIHdhaXQgdW50aWwgdGhlIENTUzMgdHJhbnNpdGlvbiBpcyBjb21wZXRlZCAoaXQncyAwLjMgc2VjKSB0byBwcmV2ZW50IGluY29ycmVjdCBgaGVpZ2h0YCBhbmQgYHdpZHRoYCBjYWxjdWxhdGlvbgoKICAgICAgaWYgKHNlbGYuX2xhc3RTaG93RWxlbWVudFRpbWVyKSB7CiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChzZWxmLl9sYXN0U2hvd0VsZW1lbnRUaW1lcik7CiAgICAgIH0KCiAgICAgIHNlbGYuX2xhc3RTaG93RWxlbWVudFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIC8vc2V0IGN1cnJlbnQgc3RlcCB0byB0aGUgbGFiZWwKICAgICAgICBpZiAob2xkSGVscGVyTnVtYmVyTGF5ZXIgIT09IG51bGwpIHsKICAgICAgICAgIG9sZEhlbHBlck51bWJlckxheWVyLmlubmVySFRNTCA9IHRhcmdldEVsZW1lbnQuc3RlcDsKICAgICAgICB9IC8vc2V0IGN1cnJlbnQgdG9vbHRpcCB0ZXh0CgoKICAgICAgICB2YXIgdG9vbHRpcEhlYWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImg1Iik7CiAgICAgICAgdG9vbHRpcEhlYWRlci5zdHlsZS5jb2xvciA9ICIjMjgzODc3IjsKICAgICAgICB0b29sdGlwSGVhZGVyLnN0eWxlLmZvbnRGYW1pbHkgPSAicnViaWsiOwogICAgICAgIHRvb2x0aXBIZWFkZXIuaW5uZXJIVE1MID0gdGFyZ2V0RWxlbWVudC5sYWJlbERpc3BsYXk7CiAgICAgICAgdmFyIHRvb2x0aXBCb2R5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgdG9vbHRpcEJvZHkuaW5uZXJIVE1MID0gdGFyZ2V0RWxlbWVudC5pbnRybzsKICAgICAgICBvbGR0b29sdGlwTGF5ZXIuaW5uZXJIVE1MID0gIiI7CiAgICAgICAgb2xkdG9vbHRpcExheWVyLnN0eWxlLm1heFdpZHRoID0gIiI7CiAgICAgICAgb2xkdG9vbHRpcExheWVyLnN0eWxlLm1pbldpZHRoID0gIjQ2MHB4IjsgLy8gdG9vbHRpcFRleHRMYXllci5zdHlsZS5tYXhXaWR0aCA9ICIzMDBweCI7CiAgICAgICAgLy8gb2xkdG9vbHRpcExheWVyLmlubmVySFRNTCA9IHRhcmdldEVsZW1lbnQuaW50cm87IC8vc2V0IHRoZSB0b29sdGlwIHBvc2l0aW9uCgogICAgICAgIG9sZHRvb2x0aXBMYXllci5hcHBlbmRDaGlsZCh0b29sdGlwSGVhZGVyKTsKICAgICAgICBvbGR0b29sdGlwTGF5ZXIuYXBwZW5kQ2hpbGQodG9vbHRpcEJvZHkpOwogICAgICAgIG9sZHRvb2x0aXBMYXllci5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiLTEuNTJyZW0iOwogICAgICAgIG9sZHRvb2x0aXBDb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgb2xkdG9vbHRpcExheWVyLnN0eWxlLnBhZGRpbmdMZWZ0ID0gIjFyZW0iOyAvLyBvbGR0b29sdGlwQ29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAibWF4LXdpZHRoOiA3MDBweCAhaW1wb3J0YW50IjsgCgogICAgICAgIHBsYWNlVG9vbHRpcC5jYWxsKHNlbGYsIHRhcmdldEVsZW1lbnQuZWxlbWVudCwgb2xkdG9vbHRpcENvbnRhaW5lciwgb2xkQXJyb3dMYXllciwgb2xkSGVscGVyTnVtYmVyTGF5ZXIpOyAvL2NoYW5nZSBhY3RpdmUgYnVsbGV0CgogICAgICAgIGlmIChzZWxmLl9vcHRpb25zLnNob3dCdWxsZXRzKSB7CiAgICAgICAgICBvbGRSZWZlcmVuY2VMYXllci5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy1idWxsZXRzIGxpID4gYS5hY3RpdmUiKS5jbGFzc05hbWUgPSAiIjsKICAgICAgICAgIG9sZFJlZmVyZW5jZUxheWVyLnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWJ1bGxldHMgbGkgPiBhW2RhdGEtc3RlcG51bWJlcj1cIiIuY29uY2F0KHRhcmdldEVsZW1lbnQuc3RlcCwgIlwiXSIpKS5jbGFzc05hbWUgPSAiYWN0aXZlIjsKICAgICAgICB9IC8vIG9sZFJlZmVyZW5jZUxheWVyLnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLXByb2dyZXNzIC5pbnRyb2pzLXByb2dyZXNzYmFyIikuc3R5bGUuY3NzVGV4dCA9ICJ3aWR0aDoiLmNvbmNhdChfZ2V0UHJvZ3Jlc3MuY2FsbChzZWxmKSwgIiU7Iik7CiAgICAgICAgLy8gb2xkUmVmZXJlbmNlTGF5ZXIucXVlcnlTZWxlY3RvcigiLmludHJvanMtcHJvZ3Jlc3MgLmludHJvanMtcHJvZ3Jlc3NiYXIiKS5zZXRBdHRyaWJ1dGUoImFyaWEtdmFsdWVub3ciLCBfZ2V0UHJvZ3Jlc3MuY2FsbChzZWxmKSk7IC8vc2hvdyB0aGUgdG9vbHRpcAoKCiAgICAgICAgb2xkdG9vbHRpcENvbnRhaW5lci5zdHlsZS5vcGFjaXR5ID0gMTsKICAgICAgICBpZiAob2xkSGVscGVyTnVtYmVyTGF5ZXIpIG9sZEhlbHBlck51bWJlckxheWVyLnN0eWxlLm9wYWNpdHkgPSAxOyAvL3Jlc2V0IGJ1dHRvbiBmb2N1cwoKICAgICAgICBpZiAodHlwZW9mIHNraXBUb29sdGlwQnV0dG9uICE9PSAidW5kZWZpbmVkIiAmJiBza2lwVG9vbHRpcEJ1dHRvbiAhPT0gbnVsbCAmJiAvaW50cm9qcy1kb25lYnV0dG9uL2dpLnRlc3Qoc2tpcFRvb2x0aXBCdXR0b24uY2xhc3NOYW1lKSkgewogICAgICAgICAgLy8gc2tpcCBidXR0b24gaXMgbm93ICJkb25lIiBidXR0b24KICAgICAgICAgIHNraXBUb29sdGlwQnV0dG9uLmZvY3VzKCk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmV4dFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIG5leHRUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgICAvL3N0aWxsIGluIHRoZSB0b3VyLCBmb2N1cyBvbiBuZXh0CiAgICAgICAgICBuZXh0VG9vbHRpcEJ1dHRvbi5mb2N1cygpOwogICAgICAgIH0gLy8gY2hhbmdlIHRoZSBzY3JvbGwgb2YgdGhlIHdpbmRvdywgaWYgbmVlZGVkCgoKICAgICAgICBzY3JvbGxUby5jYWxsKHNlbGYsIHRhcmdldEVsZW1lbnQuc2Nyb2xsVG8sIHRhcmdldEVsZW1lbnQsIG9sZHRvb2x0aXBMYXllcik7CiAgICAgIH0sIDM1MCk7IC8vIGVuZCBvZiBvbGQgZWxlbWVudCBpZi1lbHNlIGNvbmRpdGlvbgogICAgfSBlbHNlIHsKICAgICAgdmFyIGhlbHBlckxheWVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHZhciByZWZlcmVuY2VMYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICB2YXIgYXJyb3dMYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICB2YXIgdG9vbHRpcExheWVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHZhciB0b29sdGlwVGV4dExheWVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHZhciBidWxsZXRzTGF5ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgdmFyIHByb2dyZXNzTGF5ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgdmFyIGJ1dHRvbnNMYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICB2YXIgaW1hZ2VMYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwogICAgICBpbWFnZUxheWVyLnNyYyA9ICIvaW1nL0dyb3VwMy5zdmciOwogICAgICBpbWFnZUxheWVyLmlkID0gImN1c3RvbS1hcnJvdy1pbWFnZS1jZW5zZSI7CiAgICAgIGltYWdlTGF5ZXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgaGVscGVyTGF5ZXIuY2xhc3NOYW1lID0gaGlnaGxpZ2h0Q2xhc3M7CiAgICAgIHJlZmVyZW5jZUxheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLXRvb2x0aXBSZWZlcmVuY2VMYXllciI7IC8vIHNjcm9sbCB0byBlbGVtZW50CgogICAgICBzY3JvbGxQYXJlbnQgPSBnZXRTY3JvbGxQYXJlbnQodGFyZ2V0RWxlbWVudC5lbGVtZW50KTsKCiAgICAgIGlmIChzY3JvbGxQYXJlbnQgIT09IGRvY3VtZW50LmJvZHkpIHsKICAgICAgICAvLyB0YXJnZXQgaXMgd2l0aGluIGEgc2Nyb2xsYWJsZSBlbGVtZW50CiAgICAgICAgc2Nyb2xsUGFyZW50VG9FbGVtZW50KHNjcm9sbFBhcmVudCwgdGFyZ2V0RWxlbWVudC5lbGVtZW50KTsKICAgICAgfSAvL3NldCBuZXcgcG9zaXRpb24gdG8gaGVscGVyIGxheWVyCgoKICAgICAgc2V0SGVscGVyTGF5ZXJQb3NpdGlvbi5jYWxsKHNlbGYsIGhlbHBlckxheWVyKTsKICAgICAgc2V0SGVscGVyTGF5ZXJQb3NpdGlvbi5jYWxsKHNlbGYsIHJlZmVyZW5jZUxheWVyKTsgLy9hZGQgaGVscGVyIGxheWVyIHRvIHRhcmdldCBlbGVtZW50CgogICAgICB0aGlzLl90YXJnZXRFbGVtZW50LmFwcGVuZENoaWxkKGhlbHBlckxheWVyKTsgLy8gdGhpcy5fdGFyZ2V0RWxlbWVudC5hcHBlbmRDaGlsZChpbWFnZUxheWVyKTsKCgogICAgICB0aGlzLl90YXJnZXRFbGVtZW50LmFwcGVuZENoaWxkKHJlZmVyZW5jZUxheWVyKTsKCiAgICAgIGFycm93TGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtYXJyb3ciOwogICAgICB0b29sdGlwVGV4dExheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLXRvb2x0aXB0ZXh0IjsKICAgICAgdmFyIHRvb2x0aXBIZWFkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJoNSIpOwogICAgICB0b29sdGlwSGVhZGVyLnN0eWxlLmNvbG9yID0gIiMyODM4NzciOwogICAgICB0b29sdGlwSGVhZGVyLmlubmVySFRNTCA9ICJXRUxDT01FIjsKICAgICAgdmFyIHRvb2x0aXBCb2R5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHRvb2x0aXBCb2R5LmlubmVySFRNTCA9IHRhcmdldEVsZW1lbnQuaW50cm87CiAgICAgIHRvb2x0aXBUZXh0TGF5ZXIuaW5uZXJIVE1MID0gIiI7CiAgICAgIHRvb2x0aXBUZXh0TGF5ZXIuc3R5bGUubWluV2lkdGggPSAiNTAwcHgiOwogICAgICB0b29sdGlwVGV4dExheWVyLnN0eWxlLm1heFdpZHRoID0gIjMwMHB4IjsKICAgICAgdG9vbHRpcFRleHRMYXllci5hcHBlbmRDaGlsZCh0b29sdGlwSGVhZGVyKTsKICAgICAgdG9vbHRpcFRleHRMYXllci5hcHBlbmRDaGlsZCh0b29sdGlwQm9keSk7CiAgICAgIHRvb2x0aXBUZXh0TGF5ZXIuc3R5bGUubWFyZ2luQm90dG9tID0gIjAiOyAvLyB0b29sdGlwVGV4dExheWVyLmlubmVySFRNTCA9IHRhcmdldEVsZW1lbnQuaW50cm87CiAgICAgIC8vIHZhciBsYWJlbF9kaXNwbGF5X2RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAvLyBsYWJlbF9kaXNwbGF5X2Rpdi5pZCA9ICJsYWJlbF9kaXNwbGF5X2RpdiI7CiAgICAgIC8vIGxhYmVsX2Rpc3BsYXlfZGl2LnN0eWxlLmNvbG9yID0gIiNGRkZGRkYiOwogICAgICAvLyBsYWJlbF9kaXNwbGF5X2Rpdi5zdHlsZS50ZXh0QWxpZ24gPSAiY2VudGVyIjsKICAgICAgLy8gbGFiZWxfZGlzcGxheV9kaXYuc3R5bGUubWFyZ2luVG9wID0gIjAuNXJlbSI7CiAgICAgIC8vIGxhYmVsX2Rpc3BsYXlfZGl2LmlubmVySFRNTCA9IHRhcmdldEVsZW1lbnQubGFiZWxEaXNwbGF5OwogICAgICAvLyBoZWxwZXJMYXllci5hcHBlbmRDaGlsZChsYWJlbF9kaXNwbGF5X2Rpdik7CiAgICAgIC8vIGhlbHBlckxheWVyLmlubmVySFRNTCA9IHRhcmdldEVsZW1lbnQubGFiZWxEaXNwbGF5OwoKICAgICAgYnVsbGV0c0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWJ1bGxldHMiOwoKICAgICAgaWYgKHRoaXMuX29wdGlvbnMuc2hvd0J1bGxldHMgPT09IGZhbHNlKSB7CiAgICAgICAgYnVsbGV0c0xheWVyLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgIH0KCiAgICAgIHZhciB1bENvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInVsIik7CiAgICAgIHVsQ29udGFpbmVyLnNldEF0dHJpYnV0ZSgicm9sZSIsICJ0YWJsaXN0Iik7CgogICAgICB2YXIgYW5jaG9yQ2xpY2sgPSBmdW5jdGlvbiBhbmNob3JDbGljaygpIHsKICAgICAgICBzZWxmLmdvVG9TdGVwKHRoaXMuZ2V0QXR0cmlidXRlKCJkYXRhLXN0ZXBudW1iZXIiKSk7CiAgICAgIH07CgogICAgICBmb3JFYWNoKHRoaXMuX2ludHJvSXRlbXMsIGZ1bmN0aW9uIChfcmVmLCBpKSB7CiAgICAgICAgdmFyIHN0ZXAgPSBfcmVmLnN0ZXA7CiAgICAgICAgdmFyIGlubmVyTGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwogICAgICAgIHZhciBhbmNob3JMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgICAgIGlubmVyTGkuc2V0QXR0cmlidXRlKCJyb2xlIiwgInByZXNlbnRhdGlvbiIpOwogICAgICAgIGFuY2hvckxpbmsuc2V0QXR0cmlidXRlKCJyb2xlIiwgInRhYiIpOwogICAgICAgIGFuY2hvckxpbmsub25jbGljayA9IGFuY2hvckNsaWNrOwoKICAgICAgICBpZiAoaSA9PT0gdGFyZ2V0RWxlbWVudC5zdGVwIC0gMSkgewogICAgICAgICAgYW5jaG9yTGluay5jbGFzc05hbWUgPSAiYWN0aXZlIjsKICAgICAgICB9CgogICAgICAgIHNldEFuY2hvckFzQnV0dG9uKGFuY2hvckxpbmspOwogICAgICAgIGFuY2hvckxpbmsuaW5uZXJIVE1MID0gIiZuYnNwOyI7CiAgICAgICAgYW5jaG9yTGluay5zZXRBdHRyaWJ1dGUoImRhdGEtc3RlcG51bWJlciIsIHN0ZXApOwogICAgICAgIGlubmVyTGkuYXBwZW5kQ2hpbGQoYW5jaG9yTGluayk7CiAgICAgICAgdWxDb250YWluZXIuYXBwZW5kQ2hpbGQoaW5uZXJMaSk7CiAgICAgIH0pOwogICAgICBidWxsZXRzTGF5ZXIuYXBwZW5kQ2hpbGQodWxDb250YWluZXIpOwogICAgICBwcm9ncmVzc0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLXByb2dyZXNzIjsKCiAgICAgIGlmICh0aGlzLl9vcHRpb25zLnNob3dQcm9ncmVzcyA9PT0gZmFsc2UpIHsKICAgICAgICBwcm9ncmVzc0xheWVyLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgIH0KCiAgICAgIHZhciBwcm9ncmVzc0JhciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBwcm9ncmVzc0Jhci5jbGFzc05hbWUgPSAiaW50cm9qcy1wcm9ncmVzc2JhciI7CiAgICAgIHByb2dyZXNzQmFyLnNldEF0dHJpYnV0ZSgicm9sZSIsICJwcm9ncmVzcyIpOwogICAgICBwcm9ncmVzc0Jhci5zZXRBdHRyaWJ1dGUoImFyaWEtdmFsdWVtaW4iLCAwKTsKICAgICAgcHJvZ3Jlc3NCYXIuc2V0QXR0cmlidXRlKCJhcmlhLXZhbHVlbWF4IiwgMTAwKTsKICAgICAgcHJvZ3Jlc3NCYXIuc2V0QXR0cmlidXRlKCJhcmlhLXZhbHVlbm93IiwgX2dldFByb2dyZXNzLmNhbGwodGhpcykpOwogICAgICBwcm9ncmVzc0Jhci5zdHlsZS5jc3NUZXh0ID0gIndpZHRoOiIuY29uY2F0KF9nZXRQcm9ncmVzcy5jYWxsKHRoaXMpLCAiJTsiKTsKICAgICAgcHJvZ3Jlc3NMYXllci5hcHBlbmRDaGlsZChwcm9ncmVzc0Jhcik7CiAgICAgIGJ1dHRvbnNMYXllci5jbGFzc05hbWUgPSAiaW50cm9qcy10b29sdGlwYnV0dG9ucyI7CgogICAgICBpZiAodGhpcy5fb3B0aW9ucy5zaG93QnV0dG9ucyA9PT0gZmFsc2UpIHsKICAgICAgICBidXR0b25zTGF5ZXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgfQoKICAgICAgdG9vbHRpcExheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLXRvb2x0aXAiOyAvLyB0b29sdGlwTGF5ZXIuc3R5bGUuY3NzVGV4dCA9ICJtYXgtd2lkdGg6IDMwMHB4ICFpbXBvcnRhbnQiOyAKCiAgICAgIHRvb2x0aXBMYXllci5hcHBlbmRDaGlsZCh0b29sdGlwVGV4dExheWVyKTsKICAgICAgdG9vbHRpcExheWVyLmFwcGVuZENoaWxkKGltYWdlTGF5ZXIpOyAvLyB0b29sdGlwTGF5ZXIuYXBwZW5kQ2hpbGQoYnVsbGV0c0xheWVyKTsKICAgICAgLy8gdG9vbHRpcExheWVyLmFwcGVuZENoaWxkKHByb2dyZXNzTGF5ZXIpOyAvL2FkZCBoZWxwZXIgbGF5ZXIgbnVtYmVyCgogICAgICB2YXIgaGVscGVyTnVtYmVyTGF5ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CgogICAgICBpZiAodGhpcy5fb3B0aW9ucy5zaG93U3RlcE51bWJlcnMgPT09IHRydWUpIHsKICAgICAgICBoZWxwZXJOdW1iZXJMYXllci5jbGFzc05hbWUgPSAiaW50cm9qcy1oZWxwZXJOdW1iZXJMYXllciI7CiAgICAgICAgaGVscGVyTnVtYmVyTGF5ZXIuaW5uZXJIVE1MID0gdGFyZ2V0RWxlbWVudC5zdGVwOwogICAgICAgIHJlZmVyZW5jZUxheWVyLmFwcGVuZENoaWxkKGhlbHBlck51bWJlckxheWVyKTsKICAgICAgfQoKICAgICAgdG9vbHRpcExheWVyLmFwcGVuZENoaWxkKGFycm93TGF5ZXIpOwogICAgICByZWZlcmVuY2VMYXllci5hcHBlbmRDaGlsZCh0b29sdGlwTGF5ZXIpOyAvL25leHQgYnV0dG9uCgogICAgICBuZXh0VG9vbHRpcEJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKCiAgICAgIG5leHRUb29sdGlwQnV0dG9uLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHNlbGYuX2ludHJvSXRlbXMubGVuZ3RoIC0gMSAhPT0gc2VsZi5fY3VycmVudFN0ZXApIHsKICAgICAgICAgIG5leHRTdGVwLmNhbGwoc2VsZik7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgc2V0QW5jaG9yQXNCdXR0b24obmV4dFRvb2x0aXBCdXR0b24pOwogICAgICBuZXh0VG9vbHRpcEJ1dHRvbi5pbm5lckhUTUwgPSB0aGlzLl9vcHRpb25zLm5leHRMYWJlbDsgLy9wcmV2aW91cyBidXR0b24KCiAgICAgIHByZXZUb29sdGlwQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgICBwcmV2VG9vbHRpcEJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKICAgICAgcHJldlRvb2x0aXBCdXR0b24ub25jbGljayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoc2VsZi5fY3VycmVudFN0ZXAgIT09IDApIHsKICAgICAgICAgIHByZXZpb3VzU3RlcC5jYWxsKHNlbGYpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHNldEFuY2hvckFzQnV0dG9uKHByZXZUb29sdGlwQnV0dG9uKTsKICAgICAgcHJldlRvb2x0aXBCdXR0b24uaW5uZXJIVE1MID0gdGhpcy5fb3B0aW9ucy5wcmV2TGFiZWw7IC8vc2tpcCBidXR0b24KCiAgICAgIHNraXBUb29sdGlwQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgICBza2lwVG9vbHRpcEJ1dHRvbi5jbGFzc05hbWUgPSAiIi5jb25jYXQodGhpcy5fb3B0aW9ucy5idXR0b25DbGFzcywgIiBpbnRyb2pzLXNraXBidXR0b24gIik7CiAgICAgIHNldEFuY2hvckFzQnV0dG9uKHNraXBUb29sdGlwQnV0dG9uKTsKICAgICAgc2tpcFRvb2x0aXBCdXR0b24uaW5uZXJIVE1MID0gdGhpcy5fb3B0aW9ucy5za2lwTGFiZWw7CgogICAgICBza2lwVG9vbHRpcEJ1dHRvbi5vbmNsaWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChzZWxmLl9pbnRyb0l0ZW1zLmxlbmd0aCAtIDEgPT09IHNlbGYuX2N1cnJlbnRTdGVwICYmIHR5cGVvZiBzZWxmLl9pbnRyb0NvbXBsZXRlQ2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHNlbGYuX2ludHJvQ29tcGxldGVDYWxsYmFjay5jYWxsKHNlbGYpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBzZWxmLl9pbnRyb1NraXBDYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgc2VsZi5faW50cm9Ta2lwQ2FsbGJhY2suY2FsbChzZWxmKTsKICAgICAgICB9CgogICAgICAgIGV4aXRJbnRyby5jYWxsKHNlbGYsIHNlbGYuX3RhcmdldEVsZW1lbnQpOwogICAgICB9OwoKICAgICAgYnV0dG9uc0xheWVyLmFwcGVuZENoaWxkKHNraXBUb29sdGlwQnV0dG9uKTsgLy9pbiBvcmRlciB0byBwcmV2ZW50IGRpc3BsYXlpbmcgbmV4dC9wcmV2aW91cyBidXR0b24gYWx3YXlzCgogICAgICBpZiAodGhpcy5faW50cm9JdGVtcy5sZW5ndGggPiAxKSB7CiAgICAgICAgYnV0dG9uc0xheWVyLmFwcGVuZENoaWxkKHByZXZUb29sdGlwQnV0dG9uKTsKICAgICAgICBidXR0b25zTGF5ZXIuYXBwZW5kQ2hpbGQobmV4dFRvb2x0aXBCdXR0b24pOwogICAgICB9CgogICAgICB0b29sdGlwTGF5ZXIuYXBwZW5kQ2hpbGQoYnV0dG9uc0xheWVyKTsgLy9zZXQgcHJvcGVyIHBvc2l0aW9uCgogICAgICBwbGFjZVRvb2x0aXAuY2FsbChzZWxmLCB0YXJnZXRFbGVtZW50LmVsZW1lbnQsIHRvb2x0aXBMYXllciwgYXJyb3dMYXllciwgaGVscGVyTnVtYmVyTGF5ZXIpOyAvLyBjaGFuZ2UgdGhlIHNjcm9sbCBvZiB0aGUgd2luZG93LCBpZiBuZWVkZWQKCiAgICAgIHNjcm9sbFRvLmNhbGwodGhpcywgdGFyZ2V0RWxlbWVudC5zY3JvbGxUbywgdGFyZ2V0RWxlbWVudCwgdG9vbHRpcExheWVyKTsgLy9lbmQgb2YgbmV3IGVsZW1lbnQgaWYtZWxzZSBjb25kaXRpb24KICAgIH0gLy8gcmVtb3ZpbmcgcHJldmlvdXMgZGlzYWJsZSBpbnRlcmFjdGlvbiBsYXllcgoKCiAgICB2YXIgZGlzYWJsZUludGVyYWN0aW9uTGF5ZXIgPSBzZWxmLl90YXJnZXRFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWRpc2FibGVJbnRlcmFjdGlvbiIpOwoKICAgIGlmIChkaXNhYmxlSW50ZXJhY3Rpb25MYXllcikgewogICAgICBkaXNhYmxlSW50ZXJhY3Rpb25MYXllci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGRpc2FibGVJbnRlcmFjdGlvbkxheWVyKTsKICAgIH0gLy9kaXNhYmxlIGludGVyYWN0aW9uCgoKICAgIGlmICh0YXJnZXRFbGVtZW50LmRpc2FibGVJbnRlcmFjdGlvbikgewogICAgICBfZGlzYWJsZUludGVyYWN0aW9uLmNhbGwoc2VsZik7CiAgICB9IC8vIHdoZW4gaXQncyB0aGUgZmlyc3Qgc3RlcCBvZiB0b3VyCgoKICAgIGlmICh0aGlzLl9jdXJyZW50U3RlcCA9PT0gMCAmJiB0aGlzLl9pbnRyb0l0ZW1zLmxlbmd0aCA+IDEpIHsKICAgICAgaWYgKHR5cGVvZiBza2lwVG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgc2tpcFRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgICBza2lwVG9vbHRpcEJ1dHRvbi5jbGFzc05hbWUgPSAiIi5jb25jYXQodGhpcy5fb3B0aW9ucy5idXR0b25DbGFzcywgIiBpbnRyb2pzLXNraXBidXR0b24iKTsKICAgICAgICBza2lwVG9vbHRpcEJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICB9CgogICAgICBpZiAodHlwZW9mIG5leHRUb29sdGlwQnV0dG9uICE9PSAidW5kZWZpbmVkIiAmJiBuZXh0VG9vbHRpcEJ1dHRvbiAhPT0gbnVsbCkgewogICAgICAgIG5leHRUb29sdGlwQnV0dG9uLmNsYXNzTmFtZSA9ICIiLmNvbmNhdCh0aGlzLl9vcHRpb25zLmJ1dHRvbkNsYXNzLCAiIGludHJvanMtbmV4dGJ1dHRvbiIpOwogICAgICB9CgogICAgICBpZiAodGhpcy5fb3B0aW9ucy5oaWRlUHJldiA9PT0gdHJ1ZSkgewogICAgICAgIGlmICh0eXBlb2YgcHJldlRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIHByZXZUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgICBwcmV2VG9vbHRpcEJ1dHRvbi5jbGFzc05hbWUgPSAiIi5jb25jYXQodGhpcy5fb3B0aW9ucy5idXR0b25DbGFzcywgIiBpbnRyb2pzLXByZXZidXR0b24gaW50cm9qcy1oaWRkZW4iKTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgbmV4dFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIG5leHRUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgICBhZGRDbGFzcyhuZXh0VG9vbHRpcEJ1dHRvbiwgImludHJvanMtZnVsbGJ1dHRvbiIpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodHlwZW9mIHByZXZUb29sdGlwQnV0dG9uICE9PSAidW5kZWZpbmVkIiAmJiBwcmV2VG9vbHRpcEJ1dHRvbiAhPT0gbnVsbCkgewogICAgICAgICAgcHJldlRvb2x0aXBCdXR0b24uY2xhc3NOYW1lID0gIiIuY29uY2F0KHRoaXMuX29wdGlvbnMuYnV0dG9uQ2xhc3MsICIgaW50cm9qcy1wcmV2YnV0dG9uIGludHJvanMtZGlzYWJsZWQiKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2Ygc2tpcFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIHNraXBUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgc2tpcFRvb2x0aXBCdXR0b24uaW5uZXJIVE1MID0gdGhpcy5fb3B0aW9ucy5za2lwTGFiZWw7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodGhpcy5faW50cm9JdGVtcy5sZW5ndGggLSAxID09PSB0aGlzLl9jdXJyZW50U3RlcCB8fCB0aGlzLl9pbnRyb0l0ZW1zLmxlbmd0aCA9PT0gMSkgewogICAgICAvLyBsYXN0IHN0ZXAgb2YgdG91cgogICAgICBpZiAodHlwZW9mIHNraXBUb29sdGlwQnV0dG9uICE9PSAidW5kZWZpbmVkIiAmJiBza2lwVG9vbHRpcEJ1dHRvbiAhPT0gbnVsbCkgewogICAgICAgIHNraXBUb29sdGlwQnV0dG9uLmlubmVySFRNTCA9IHRoaXMuX29wdGlvbnMuZG9uZUxhYmVsOyAvLyBhZGRpbmcgZG9uZWJ1dHRvbiBjbGFzcyBpbiBhZGRpdGlvbiB0byBza2lwYnV0dG9uCgogICAgICAgIHNraXBUb29sdGlwQnV0dG9uLnN0eWxlLmRpc3BsYXkgPSAiaW5saW5lLWJsb2NrIjsKICAgICAgICBhZGRDbGFzcyhza2lwVG9vbHRpcEJ1dHRvbiwgImludHJvanMtZG9uZWJ1dHRvbiIpOwogICAgICB9CgogICAgICBpZiAodHlwZW9mIHByZXZUb29sdGlwQnV0dG9uICE9PSAidW5kZWZpbmVkIiAmJiBwcmV2VG9vbHRpcEJ1dHRvbiAhPT0gbnVsbCkgewogICAgICAgIHByZXZUb29sdGlwQnV0dG9uLmNsYXNzTmFtZSA9ICIiLmNvbmNhdCh0aGlzLl9vcHRpb25zLmJ1dHRvbkNsYXNzLCAiIGludHJvanMtcHJldmJ1dHRvbiIpOwogICAgICB9CgogICAgICBpZiAodGhpcy5fb3B0aW9ucy5oaWRlTmV4dCA9PT0gdHJ1ZSkgewogICAgICAgIGlmICh0eXBlb2YgbmV4dFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIG5leHRUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgICBuZXh0VG9vbHRpcEJ1dHRvbi5jbGFzc05hbWUgPSAiIi5jb25jYXQodGhpcy5fb3B0aW9ucy5idXR0b25DbGFzcywgIiBpbnRyb2pzLW5leHRidXR0b24gaW50cm9qcy1oaWRkZW4iKTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgcHJldlRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIHByZXZUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgICBhZGRDbGFzcyhwcmV2VG9vbHRpcEJ1dHRvbiwgImludHJvanMtZnVsbGJ1dHRvbiIpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodHlwZW9mIG5leHRUb29sdGlwQnV0dG9uICE9PSAidW5kZWZpbmVkIiAmJiBuZXh0VG9vbHRpcEJ1dHRvbiAhPT0gbnVsbCkgewogICAgICAgICAgbmV4dFRvb2x0aXBCdXR0b24uY2xhc3NOYW1lID0gIiIuY29uY2F0KHRoaXMuX29wdGlvbnMuYnV0dG9uQ2xhc3MsICIgaW50cm9qcy1uZXh0YnV0dG9uIGludHJvanMtZGlzYWJsZWQiKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIHN0ZXBzIGJldHdlZW4gc3RhcnQgYW5kIGVuZAogICAgICBpZiAodHlwZW9mIHNraXBUb29sdGlwQnV0dG9uICE9PSAidW5kZWZpbmVkIiAmJiBza2lwVG9vbHRpcEJ1dHRvbiAhPT0gbnVsbCkgewogICAgICAgIHNraXBUb29sdGlwQnV0dG9uLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgc2tpcFRvb2x0aXBCdXR0b24uY2xhc3NOYW1lID0gIiIuY29uY2F0KHRoaXMuX29wdGlvbnMuYnV0dG9uQ2xhc3MsICIgaW50cm9qcy1za2lwYnV0dG9uIik7CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgcHJldlRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIHByZXZUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgcHJldlRvb2x0aXBCdXR0b24uY2xhc3NOYW1lID0gIiIuY29uY2F0KHRoaXMuX29wdGlvbnMuYnV0dG9uQ2xhc3MsICIgaW50cm9qcy1wcmV2YnV0dG9uIik7CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgbmV4dFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIG5leHRUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgbmV4dFRvb2x0aXBCdXR0b24uY2xhc3NOYW1lID0gIiIuY29uY2F0KHRoaXMuX29wdGlvbnMuYnV0dG9uQ2xhc3MsICIgaW50cm9qcy1uZXh0YnV0dG9uIik7CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2Ygc2tpcFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIHNraXBUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgc2tpcFRvb2x0aXBCdXR0b24uaW5uZXJIVE1MID0gdGhpcy5fb3B0aW9ucy5za2lwTGFiZWw7CiAgICAgIH0KICAgIH0KCiAgICBpZiAodHlwZW9mIHByZXZUb29sdGlwQnV0dG9uICE9PSAidW5kZWZpbmVkIiAmJiBwcmV2VG9vbHRpcEJ1dHRvbiAhPT0gbnVsbCkgewogICAgICBwcmV2VG9vbHRpcEJ1dHRvbi5zZXRBdHRyaWJ1dGUoInJvbGUiLCAiYnV0dG9uIik7CiAgICB9CgogICAgaWYgKHR5cGVvZiBuZXh0VG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgbmV4dFRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgbmV4dFRvb2x0aXBCdXR0b24uc2V0QXR0cmlidXRlKCJyb2xlIiwgImJ1dHRvbiIpOwogICAgfQoKICAgIGlmICh0eXBlb2Ygc2tpcFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIHNraXBUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgIHNraXBUb29sdGlwQnV0dG9uLnNldEF0dHJpYnV0ZSgicm9sZSIsICJidXR0b24iKTsKICAgIH0gLy9TZXQgZm9jdXMgb24gIm5leHQiIGJ1dHRvbiwgc28gdGhhdCBoaXR0aW5nIEVudGVyIGFsd2F5cyBtb3ZlcyB5b3Ugb250byB0aGUgbmV4dCBzdGVwCgoKICAgIGlmICh0eXBlb2YgbmV4dFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIG5leHRUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgIG5leHRUb29sdGlwQnV0dG9uLmZvY3VzKCk7CiAgICB9CgogICAgc2V0U2hvd0VsZW1lbnQodGFyZ2V0RWxlbWVudCk7CgogICAgaWYgKHR5cGVvZiB0aGlzLl9pbnRyb0FmdGVyQ2hhbmdlQ2FsbGJhY2sgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRoaXMuX2ludHJvQWZ0ZXJDaGFuZ2VDYWxsYmFjay5jYWxsKHRoaXMsIHRhcmdldEVsZW1lbnQuZWxlbWVudCk7CiAgICB9CiAgfQogIC8qKgogICAqIEdvIHRvIHNwZWNpZmljIHN0ZXAgb2YgaW50cm9kdWN0aW9uCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9nb1RvU3RlcAogICAqLwoKCiAgZnVuY3Rpb24gZ29Ub1N0ZXAoc3RlcCkgewogICAgLy9iZWNhdXNlIHN0ZXBzIHN0YXJ0cyB3aXRoIHplcm8KICAgIHRoaXMuX2N1cnJlbnRTdGVwID0gc3RlcCAtIDI7CgogICAgaWYgKHR5cGVvZiB0aGlzLl9pbnRyb0l0ZW1zICE9PSAidW5kZWZpbmVkIikgewogICAgICBuZXh0U3RlcC5jYWxsKHRoaXMpOwogICAgfQogIH0KICAvKioKICAgKiBHbyB0byB0aGUgc3BlY2lmaWMgc3RlcCBvZiBpbnRyb2R1Y3Rpb24gd2l0aCB0aGUgZXhwbGljaXQgW2RhdGEtc3RlcF0gbnVtYmVyCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9nb1RvU3RlcE51bWJlcgogICAqLwoKCiAgZnVuY3Rpb24gZ29Ub1N0ZXBOdW1iZXIoc3RlcCkgewogICAgdGhpcy5fY3VycmVudFN0ZXBOdW1iZXIgPSBzdGVwOwoKICAgIGlmICh0eXBlb2YgdGhpcy5faW50cm9JdGVtcyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgbmV4dFN0ZXAuY2FsbCh0aGlzKTsKICAgIH0KICB9CiAgLyoqCiAgICogR28gdG8gbmV4dCBzdGVwIG9uIGludHJvCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9uZXh0U3RlcAogICAqLwoKCiAgZnVuY3Rpb24gbmV4dFN0ZXAoKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHRoaXMuX2RpcmVjdGlvbiA9ICJmb3J3YXJkIjsKCiAgICBpZiAodHlwZW9mIHRoaXMuX2N1cnJlbnRTdGVwTnVtYmVyICE9PSAidW5kZWZpbmVkIikgewogICAgICBmb3JFYWNoKHRoaXMuX2ludHJvSXRlbXMsIGZ1bmN0aW9uIChfcmVmLCBpKSB7CiAgICAgICAgdmFyIHN0ZXAgPSBfcmVmLnN0ZXA7CgogICAgICAgIGlmIChzdGVwID09PSBfdGhpcy5fY3VycmVudFN0ZXBOdW1iZXIpIHsKICAgICAgICAgIF90aGlzLl9jdXJyZW50U3RlcCA9IGkgLSAxOwogICAgICAgICAgX3RoaXMuX2N1cnJlbnRTdGVwTnVtYmVyID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgaWYgKHR5cGVvZiB0aGlzLl9jdXJyZW50U3RlcCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhpcy5fY3VycmVudFN0ZXAgPSAwOwogICAgfSBlbHNlIHsKICAgICAgKyt0aGlzLl9jdXJyZW50U3RlcDsKICAgIH0KCiAgICB2YXIgbmV4dFN0ZXAgPSB0aGlzLl9pbnRyb0l0ZW1zW3RoaXMuX2N1cnJlbnRTdGVwXTsKICAgIHZhciBjb250aW51ZVN0ZXAgPSB0cnVlOwoKICAgIGlmICh0eXBlb2YgdGhpcy5faW50cm9CZWZvcmVDaGFuZ2VDYWxsYmFjayAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgY29udGludWVTdGVwID0gdGhpcy5faW50cm9CZWZvcmVDaGFuZ2VDYWxsYmFjay5jYWxsKHRoaXMsIG5leHRTdGVwLmVsZW1lbnQpOwogICAgfSAvLyBpZiBgb25iZWZvcmVjaGFuZ2VgIHJldHVybmVkIGBmYWxzZWAsIHN0b3AgZGlzcGxheWluZyB0aGUgZWxlbWVudAoKCiAgICBpZiAoY29udGludWVTdGVwID09PSBmYWxzZSkgewogICAgICAtLXRoaXMuX2N1cnJlbnRTdGVwOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKHRoaXMuX2ludHJvSXRlbXMubGVuZ3RoIDw9IHRoaXMuX2N1cnJlbnRTdGVwKSB7CiAgICAgIC8vZW5kIG9mIHRoZSBpbnRybwogICAgICAvL2NoZWNrIGlmIGFueSBjYWxsYmFjayBpcyBkZWZpbmVkCiAgICAgIGlmICh0eXBlb2YgdGhpcy5faW50cm9Db21wbGV0ZUNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhpcy5faW50cm9Db21wbGV0ZUNhbGxiYWNrLmNhbGwodGhpcyk7CiAgICAgIH0KCiAgICAgIGV4aXRJbnRyby5jYWxsKHRoaXMsIHRoaXMuX3RhcmdldEVsZW1lbnQpOwogICAgICByZXR1cm47CiAgICB9CgogICAgX3Nob3dFbGVtZW50LmNhbGwodGhpcywgbmV4dFN0ZXApOwogIH0KICAvKioKICAgKiBHbyB0byBwcmV2aW91cyBzdGVwIG9uIGludHJvCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9wcmV2aW91c1N0ZXAKICAgKi8KCgogIGZ1bmN0aW9uIHByZXZpb3VzU3RlcCgpIHsKICAgIHRoaXMuX2RpcmVjdGlvbiA9ICJiYWNrd2FyZCI7CgogICAgaWYgKHRoaXMuX2N1cnJlbnRTdGVwID09PSAwKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAtLXRoaXMuX2N1cnJlbnRTdGVwOwogICAgdmFyIG5leHRTdGVwID0gdGhpcy5faW50cm9JdGVtc1t0aGlzLl9jdXJyZW50U3RlcF07CiAgICB2YXIgY29udGludWVTdGVwID0gdHJ1ZTsKCiAgICBpZiAodHlwZW9mIHRoaXMuX2ludHJvQmVmb3JlQ2hhbmdlQ2FsbGJhY2sgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGNvbnRpbnVlU3RlcCA9IHRoaXMuX2ludHJvQmVmb3JlQ2hhbmdlQ2FsbGJhY2suY2FsbCh0aGlzLCBuZXh0U3RlcC5lbGVtZW50KTsKICAgIH0gLy8gaWYgYG9uYmVmb3JlY2hhbmdlYCByZXR1cm5lZCBgZmFsc2VgLCBzdG9wIGRpc3BsYXlpbmcgdGhlIGVsZW1lbnQKCgogICAgaWYgKGNvbnRpbnVlU3RlcCA9PT0gZmFsc2UpIHsKICAgICAgKyt0aGlzLl9jdXJyZW50U3RlcDsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIF9zaG93RWxlbWVudC5jYWxsKHRoaXMsIG5leHRTdGVwKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgY3VycmVudCBzdGVwIG9mIHRoZSBpbnRybwogICAqCiAgICogQHJldHVybnMge2Jvb2xlYW59CiAgICovCgoKICBmdW5jdGlvbiBjdXJyZW50U3RlcCgpIHsKICAgIHJldHVybiB0aGlzLl9jdXJyZW50U3RlcDsKICB9CiAgLyoqCiAgICogb24ga2V5Q29kZToKICAgKiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvS2V5Ym9hcmRFdmVudC9rZXlDb2RlCiAgICogVGhpcyBmZWF0dXJlIGhhcyBiZWVuIHJlbW92ZWQgZnJvbSB0aGUgV2ViIHN0YW5kYXJkcy4KICAgKiBUaG91Z2ggc29tZSBicm93c2VycyBtYXkgc3RpbGwgc3VwcG9ydCBpdCwgaXQgaXMgaW4KICAgKiB0aGUgcHJvY2VzcyBvZiBiZWluZyBkcm9wcGVkLgogICAqIEluc3RlYWQsIHlvdSBzaG91bGQgdXNlIEtleWJvYXJkRXZlbnQuY29kZSwKICAgKiBpZiBpdCdzIGltcGxlbWVudGVkLgogICAqCiAgICogalF1ZXJ5J3MgYXBwcm9hY2ggaXMgdG8gdGVzdCBmb3IKICAgKiAgICgxKSBlLndoaWNoLCB0aGVuCiAgICogICAoMikgZS5jaGFyQ29kZSwgdGhlbgogICAqICAgKDMpIGUua2V5Q29kZQogICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5L2Jsb2IvYTZiMDcwNTI5NGQzMzZhZTJmNjNmNzI3NmRlMGRhMTE5NTQ5NTM2My9zcmMvZXZlbnQuanMjTDYzOAogICAqCiAgICogQHBhcmFtIHR5cGUgdmFyCiAgICogQHJldHVybiB0eXBlCiAgICovCgoKICBmdW5jdGlvbiBvbktleURvd24oZSkgewogICAgdmFyIGNvZGUgPSBlLmNvZGUgPT09IG51bGwgPyBlLndoaWNoIDogZS5jb2RlOyAvLyBpZiBjb2RlL2Uud2hpY2ggaXMgbnVsbAoKICAgIGlmIChjb2RlID09PSBudWxsKSB7CiAgICAgIGNvZGUgPSBlLmNoYXJDb2RlID09PSBudWxsID8gZS5rZXlDb2RlIDogZS5jaGFyQ29kZTsKICAgIH0KCiAgICBpZiAoKGNvZGUgPT09ICJFc2NhcGUiIHx8IGNvZGUgPT09IDI3KSAmJiB0aGlzLl9vcHRpb25zLmV4aXRPbkVzYyA9PT0gdHJ1ZSkgewogICAgICAvL2VzY2FwZSBrZXkgcHJlc3NlZCwgZXhpdCB0aGUgaW50cm8KICAgICAgLy9jaGVjayBpZiBleGl0IGNhbGxiYWNrIGlzIGRlZmluZWQKICAgICAgZXhpdEludHJvLmNhbGwodGhpcywgdGhpcy5fdGFyZ2V0RWxlbWVudCk7CiAgICB9IGVsc2UgaWYgKGNvZGUgPT09ICJBcnJvd0xlZnQiIHx8IGNvZGUgPT09IDM3KSB7CiAgICAgIC8vbGVmdCBhcnJvdwogICAgICBwcmV2aW91c1N0ZXAuY2FsbCh0aGlzKTsKICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gIkFycm93UmlnaHQiIHx8IGNvZGUgPT09IDM5KSB7CiAgICAgIC8vcmlnaHQgYXJyb3cKICAgICAgbmV4dFN0ZXAuY2FsbCh0aGlzKTsKICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gIkVudGVyIiB8fCBjb2RlID09PSAxMykgewogICAgICAvL3NyY0VsZW1lbnQgPT09IGllCiAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldCB8fCBlLnNyY0VsZW1lbnQ7CgogICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5jbGFzc05hbWUubWF0Y2goImludHJvanMtcHJldmJ1dHRvbiIpKSB7CiAgICAgICAgLy91c2VyIGhpdCBlbnRlciB3aGlsZSBmb2N1c2luZyBvbiBwcmV2aW91cyBidXR0b24KICAgICAgICBwcmV2aW91c1N0ZXAuY2FsbCh0aGlzKTsKICAgICAgfSBlbHNlIGlmICh0YXJnZXQgJiYgdGFyZ2V0LmNsYXNzTmFtZS5tYXRjaCgiaW50cm9qcy1za2lwYnV0dG9uIikpIHsKICAgICAgICAvL3VzZXIgaGl0IGVudGVyIHdoaWxlIGZvY3VzaW5nIG9uIHNraXAgYnV0dG9uCiAgICAgICAgaWYgKHRoaXMuX2ludHJvSXRlbXMubGVuZ3RoIC0gMSA9PT0gdGhpcy5fY3VycmVudFN0ZXAgJiYgdHlwZW9mIHRoaXMuX2ludHJvQ29tcGxldGVDYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdGhpcy5faW50cm9Db21wbGV0ZUNhbGxiYWNrLmNhbGwodGhpcyk7CiAgICAgICAgfQoKICAgICAgICBleGl0SW50cm8uY2FsbCh0aGlzLCB0aGlzLl90YXJnZXRFbGVtZW50KTsKICAgICAgfSBlbHNlIGlmICh0YXJnZXQgJiYgdGFyZ2V0LmdldEF0dHJpYnV0ZSgiZGF0YS1zdGVwbnVtYmVyIikpIHsKICAgICAgICAvLyB1c2VyIGhpdCBlbnRlciB3aGlsZSBmb2N1c2luZyBvbiBzdGVwIGJ1bGxldAogICAgICAgIHRhcmdldC5jbGljaygpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vZGVmYXVsdCBiZWhhdmlvciBmb3IgcmVzcG9uZGluZyB0byBlbnRlcgogICAgICAgIG5leHRTdGVwLmNhbGwodGhpcyk7CiAgICAgIH0gLy9wcmV2ZW50IGRlZmF1bHQgYmVoYXZpb3VyIG9uIGhpdHRpbmcgRW50ZXIsIHRvIHByZXZlbnQgc3RlcHMgYmVpbmcgc2tpcHBlZCBpbiBzb21lIGJyb3dzZXJzCgoKICAgICAgaWYgKGUucHJldmVudERlZmF1bHQpIHsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZS5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICB9CiAgICB9CiAgfQogIC8qCiAgICogbWFrZXMgYSBjb3B5IG9mIHRoZSBvYmplY3QKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9jbG9uZU9iamVjdAogICAqLwoKCiAgZnVuY3Rpb24gY2xvbmVPYmplY3Qob2JqZWN0KSB7CiAgICBpZiAob2JqZWN0ID09PSBudWxsIHx8IF90eXBlb2Yob2JqZWN0KSAhPT0gIm9iamVjdCIgfHwgdHlwZW9mIG9iamVjdC5ub2RlVHlwZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0dXJuIG9iamVjdDsKICAgIH0KCiAgICB2YXIgdGVtcCA9IHt9OwoKICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgaWYgKHR5cGVvZiB3aW5kb3cualF1ZXJ5ICE9PSAidW5kZWZpbmVkIiAmJiBvYmplY3Rba2V5XSBpbnN0YW5jZW9mIHdpbmRvdy5qUXVlcnkpIHsKICAgICAgICB0ZW1wW2tleV0gPSBvYmplY3Rba2V5XTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0ZW1wW2tleV0gPSBjbG9uZU9iamVjdChvYmplY3Rba2V5XSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGVtcDsKICB9CiAgLyoqCiAgICogR2V0IGEgcXVlcnlzZWxlY3RvciB3aXRoaW4gdGhlIGhpbnQgd3JhcHBlcgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHNlbGVjdG9yCiAgICogQHJldHVybiB7Tm9kZUxpc3R8QXJyYXl9CiAgICovCgoKICBmdW5jdGlvbiBoaW50UXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikgewogICAgdmFyIGhpbnRzV3JhcHBlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWhpbnRzIik7CiAgICByZXR1cm4gaGludHNXcmFwcGVyID8gaGludHNXcmFwcGVyLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpIDogW107CiAgfQogIC8qKgogICAqIEhpZGUgYSBoaW50CiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIGhpZGVIaW50CiAgICovCgoKICBmdW5jdGlvbiBoaWRlSGludChzdGVwSWQpIHsKICAgIHZhciBoaW50ID0gaGludFF1ZXJ5U2VsZWN0b3JBbGwoIi5pbnRyb2pzLWhpbnRbZGF0YS1zdGVwPVwiIi5jb25jYXQoc3RlcElkLCAiXCJdIikpWzBdOwogICAgcmVtb3ZlSGludFRvb2x0aXAuY2FsbCh0aGlzKTsKCiAgICBpZiAoaGludCkgewogICAgICBhZGRDbGFzcyhoaW50LCAiaW50cm9qcy1oaWRlaGludCIpOwogICAgfSAvLyBjYWxsIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAoaWYgYW55KQoKCiAgICBpZiAodHlwZW9mIHRoaXMuX2hpbnRDbG9zZUNhbGxiYWNrICE9PSAidW5kZWZpbmVkIikgewogICAgICB0aGlzLl9oaW50Q2xvc2VDYWxsYmFjay5jYWxsKHRoaXMsIHN0ZXBJZCk7CiAgICB9CiAgfQogIC8qKgogICAqIEhpZGUgYWxsIGhpbnRzCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIGhpZGVIaW50cwogICAqLwoKCiAgZnVuY3Rpb24gaGlkZUhpbnRzKCkgewogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICB2YXIgaGludHMgPSBoaW50UXVlcnlTZWxlY3RvckFsbCgiLmludHJvanMtaGludCIpOwogICAgZm9yRWFjaChoaW50cywgZnVuY3Rpb24gKGhpbnQpIHsKICAgICAgaGlkZUhpbnQuY2FsbChfdGhpcywgaGludC5nZXRBdHRyaWJ1dGUoImRhdGEtc3RlcCIpKTsKICAgIH0pOwogIH0KICAvKioKICAgKiBTaG93IGFsbCBoaW50cwogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfc2hvd0hpbnRzCiAgICovCgoKICBmdW5jdGlvbiBzaG93SGludHMoKSB7CiAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICB2YXIgaGludHMgPSBoaW50UXVlcnlTZWxlY3RvckFsbCgiLmludHJvanMtaGludCIpOwoKICAgIGlmIChoaW50cyAmJiBoaW50cy5sZW5ndGgpIHsKICAgICAgZm9yRWFjaChoaW50cywgZnVuY3Rpb24gKGhpbnQpIHsKICAgICAgICBzaG93SGludC5jYWxsKF90aGlzMiwgaGludC5nZXRBdHRyaWJ1dGUoImRhdGEtc3RlcCIpKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBwb3B1bGF0ZUhpbnRzLmNhbGwodGhpcywgdGhpcy5fdGFyZ2V0RWxlbWVudCk7CiAgICB9CiAgfQogIC8qKgogICAqIFNob3cgYSBoaW50CiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIHNob3dIaW50CiAgICovCgoKICBmdW5jdGlvbiBzaG93SGludChzdGVwSWQpIHsKICAgIHZhciBoaW50ID0gaGludFF1ZXJ5U2VsZWN0b3JBbGwoIi5pbnRyb2pzLWhpbnRbZGF0YS1zdGVwPVwiIi5jb25jYXQoc3RlcElkLCAiXCJdIikpWzBdOwoKICAgIGlmIChoaW50KSB7CiAgICAgIHJlbW92ZUNsYXNzKGhpbnQsIC9pbnRyb2pzLWhpZGVoaW50L2cpOwogICAgfQogIH0KICAvKioKICAgKiBSZW1vdmVzIGFsbCBoaW50IGVsZW1lbnRzIG9uIHRoZSBwYWdlCiAgICogVXNlZnVsIHdoZW4geW91IHdhbnQgdG8gZGVzdHJveSB0aGUgZWxlbWVudHMgYW5kIGFkZCB0aGVtIGFnYWluIChlLmcuIGEgbW9kYWwgb3IgcG9wdXApCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIHJlbW92ZUhpbnRzCiAgICovCgoKICBmdW5jdGlvbiByZW1vdmVIaW50cygpIHsKICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgIHZhciBoaW50cyA9IGhpbnRRdWVyeVNlbGVjdG9yQWxsKCIuaW50cm9qcy1oaW50Iik7CiAgICBmb3JFYWNoKGhpbnRzLCBmdW5jdGlvbiAoaGludCkgewogICAgICByZW1vdmVIaW50LmNhbGwoX3RoaXMzLCBoaW50LmdldEF0dHJpYnV0ZSgiZGF0YS1zdGVwIikpOwogICAgfSk7CiAgfQogIC8qKgogICAqIFJlbW92ZSBvbmUgc2luZ2xlIGhpbnQgZWxlbWVudCBmcm9tIHRoZSBwYWdlCiAgICogVXNlZnVsIHdoZW4geW91IHdhbnQgdG8gZGVzdHJveSB0aGUgZWxlbWVudCBhbmQgYWRkIHRoZW0gYWdhaW4gKGUuZy4gYSBtb2RhbCBvciBwb3B1cCkKICAgKiBVc2UgcmVtb3ZlSGludHMgaWYgeW91IHdhbnQgdG8gcmVtb3ZlIGFsbCBlbGVtZW50cy4KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgcmVtb3ZlSGludAogICAqLwoKCiAgZnVuY3Rpb24gcmVtb3ZlSGludChzdGVwSWQpIHsKICAgIHZhciBoaW50ID0gaGludFF1ZXJ5U2VsZWN0b3JBbGwoIi5pbnRyb2pzLWhpbnRbZGF0YS1zdGVwPVwiIi5jb25jYXQoc3RlcElkLCAiXCJdIikpWzBdOwoKICAgIGlmIChoaW50KSB7CiAgICAgIGhpbnQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChoaW50KTsKICAgIH0KICB9CiAgLyoqCiAgICogQWRkIGFsbCBhdmFpbGFibGUgaGludHMgdG8gdGhlIHBhZ2UKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgYWRkSGludHMKICAgKi8KCgogIGZ1bmN0aW9uIGFkZEhpbnRzKCkgewogICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGhpbnRzV3JhcHBlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWhpbnRzIik7CgogICAgaWYgKGhpbnRzV3JhcHBlciA9PT0gbnVsbCkgewogICAgICBoaW50c1dyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgaGludHNXcmFwcGVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWhpbnRzIjsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhbiBldmVudCBoYW5kbGVyIHVuaXF1ZSB0byB0aGUgaGludCBpdGVyYXRpb24KICAgICAqCiAgICAgKiBAcGFyYW0ge0ludGVnZXJ9IGkKICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufQogICAgICovCgoKICAgIHZhciBnZXRIaW50Q2xpY2sgPSBmdW5jdGlvbiBnZXRIaW50Q2xpY2soaSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGUpIHsKICAgICAgICB2YXIgZXZ0ID0gZSA/IGUgOiB3aW5kb3cuZXZlbnQ7CgogICAgICAgIGlmIChldnQuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoZXZ0LmNhbmNlbEJ1YmJsZSAhPT0gbnVsbCkgewogICAgICAgICAgZXZ0LmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBzaG93SGludERpYWxvZy5jYWxsKHNlbGYsIGkpOwogICAgICB9OwogICAgfTsKCiAgICBmb3JFYWNoKHRoaXMuX2ludHJvSXRlbXMsIGZ1bmN0aW9uIChpdGVtLCBpKSB7CiAgICAgIC8vIGF2b2lkIGFwcGVuZCBhIGhpbnQgdHdpY2UKICAgICAgaWYgKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWhpbnRbZGF0YS1zdGVwPVwiIi5jb25jYXQoaSwgIlwiXSIpKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGhpbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgIHNldEFuY2hvckFzQnV0dG9uKGhpbnQpOwogICAgICBoaW50Lm9uY2xpY2sgPSBnZXRIaW50Q2xpY2soaSk7CiAgICAgIGhpbnQuY2xhc3NOYW1lID0gImludHJvanMtaGludCI7CgogICAgICBpZiAoIWl0ZW0uaGludEFuaW1hdGlvbikgewogICAgICAgIGFkZENsYXNzKGhpbnQsICJpbnRyb2pzLWhpbnQtbm8tYW5pbSIpOwogICAgICB9IC8vIGhpbnQncyBwb3NpdGlvbiBzaG91bGQgYmUgZml4ZWQgaWYgdGhlIHRhcmdldCBlbGVtZW50J3MgcG9zaXRpb24gaXMgZml4ZWQKCgogICAgICBpZiAoaXNGaXhlZChpdGVtLmVsZW1lbnQpKSB7CiAgICAgICAgYWRkQ2xhc3MoaGludCwgImludHJvanMtZml4ZWRoaW50Iik7CiAgICAgIH0KCiAgICAgIHZhciBoaW50RG90ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGhpbnREb3QuY2xhc3NOYW1lID0gImludHJvanMtaGludC1kb3QiOwogICAgICB2YXIgaGludFB1bHNlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGhpbnRQdWxzZS5jbGFzc05hbWUgPSAiaW50cm9qcy1oaW50LXB1bHNlIjsKICAgICAgaGludC5hcHBlbmRDaGlsZChoaW50RG90KTsKICAgICAgaGludC5hcHBlbmRDaGlsZChoaW50UHVsc2UpOwogICAgICBoaW50LnNldEF0dHJpYnV0ZSgiZGF0YS1zdGVwIiwgaSk7IC8vIHdlIHN3YXAgdGhlIGhpbnQgZWxlbWVudCB3aXRoIHRhcmdldCBlbGVtZW50CiAgICAgIC8vIGJlY2F1c2UgX3NldEhlbHBlckxheWVyUG9zaXRpb24gdXNlcyBgZWxlbWVudGAgcHJvcGVydHkKCiAgICAgIGl0ZW0udGFyZ2V0RWxlbWVudCA9IGl0ZW0uZWxlbWVudDsKICAgICAgaXRlbS5lbGVtZW50ID0gaGludDsgLy8gYWxpZ24gdGhlIGhpbnQgcG9zaXRpb24KCiAgICAgIGFsaWduSGludFBvc2l0aW9uLmNhbGwoX3RoaXM0LCBpdGVtLmhpbnRQb3NpdGlvbiwgaGludCwgaXRlbS50YXJnZXRFbGVtZW50KTsKICAgICAgaGludHNXcmFwcGVyLmFwcGVuZENoaWxkKGhpbnQpOwogICAgfSk7IC8vIGFkZGluZyB0aGUgaGludHMgd3JhcHBlcgoKICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaGludHNXcmFwcGVyKTsgLy8gY2FsbCB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gKGlmIGFueSkKCiAgICBpZiAodHlwZW9mIHRoaXMuX2hpbnRzQWRkZWRDYWxsYmFjayAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhpcy5faGludHNBZGRlZENhbGxiYWNrLmNhbGwodGhpcyk7CiAgICB9CiAgfQogIC8qKgogICAqIEFsaWducyBoaW50IHBvc2l0aW9uCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIGFsaWduSGludFBvc2l0aW9uCiAgICogQHBhcmFtIHtTdHJpbmd9IHBvc2l0aW9uCiAgICogQHBhcmFtIHtPYmplY3R9IGhpbnQKICAgKiBAcGFyYW0ge09iamVjdH0gZWxlbWVudAogICAqLwoKCiAgZnVuY3Rpb24gYWxpZ25IaW50UG9zaXRpb24ocG9zaXRpb24sIF9yZWYsIGVsZW1lbnQpIHsKICAgIHZhciBzdHlsZSA9IF9yZWYuc3R5bGU7IC8vIGdldC9jYWxjdWxhdGUgb2Zmc2V0IG9mIHRhcmdldCBlbGVtZW50CgogICAgdmFyIG9mZnNldCA9IGdldE9mZnNldC5jYWxsKHRoaXMsIGVsZW1lbnQpOwogICAgdmFyIGljb25XaWR0aCA9IDIwOwogICAgdmFyIGljb25IZWlnaHQgPSAyMDsgLy8gYWxpZ24gdGhlIGhpbnQgZWxlbWVudAoKICAgIHN3aXRjaCAocG9zaXRpb24pIHsKICAgICAgZGVmYXVsdDoKICAgICAgY2FzZSAidG9wLWxlZnQiOgogICAgICAgIHN0eWxlLmxlZnQgPSAiIi5jb25jYXQob2Zmc2V0LmxlZnQsICJweCIpOwogICAgICAgIHN0eWxlLnRvcCA9ICIiLmNvbmNhdChvZmZzZXQudG9wLCAicHgiKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgInRvcC1yaWdodCI6CiAgICAgICAgc3R5bGUubGVmdCA9ICIiLmNvbmNhdChvZmZzZXQubGVmdCArIG9mZnNldC53aWR0aCAtIGljb25XaWR0aCwgInB4Iik7CiAgICAgICAgc3R5bGUudG9wID0gIiIuY29uY2F0KG9mZnNldC50b3AsICJweCIpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAiYm90dG9tLWxlZnQiOgogICAgICAgIHN0eWxlLmxlZnQgPSAiIi5jb25jYXQob2Zmc2V0LmxlZnQsICJweCIpOwogICAgICAgIHN0eWxlLnRvcCA9ICIiLmNvbmNhdChvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodCAtIGljb25IZWlnaHQsICJweCIpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAiYm90dG9tLXJpZ2h0IjoKICAgICAgICBzdHlsZS5sZWZ0ID0gIiIuY29uY2F0KG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoIC0gaWNvbldpZHRoLCAicHgiKTsKICAgICAgICBzdHlsZS50b3AgPSAiIi5jb25jYXQob2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQgLSBpY29uSGVpZ2h0LCAicHgiKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgIm1pZGRsZS1sZWZ0IjoKICAgICAgICBzdHlsZS5sZWZ0ID0gIiIuY29uY2F0KG9mZnNldC5sZWZ0LCAicHgiKTsKICAgICAgICBzdHlsZS50b3AgPSAiIi5jb25jYXQob2Zmc2V0LnRvcCArIChvZmZzZXQuaGVpZ2h0IC0gaWNvbkhlaWdodCkgLyAyLCAicHgiKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgIm1pZGRsZS1yaWdodCI6CiAgICAgICAgc3R5bGUubGVmdCA9ICIiLmNvbmNhdChvZmZzZXQubGVmdCArIG9mZnNldC53aWR0aCAtIGljb25XaWR0aCwgInB4Iik7CiAgICAgICAgc3R5bGUudG9wID0gIiIuY29uY2F0KG9mZnNldC50b3AgKyAob2Zmc2V0LmhlaWdodCAtIGljb25IZWlnaHQpIC8gMiwgInB4Iik7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICJtaWRkbGUtbWlkZGxlIjoKICAgICAgICBzdHlsZS5sZWZ0ID0gIiIuY29uY2F0KG9mZnNldC5sZWZ0ICsgKG9mZnNldC53aWR0aCAtIGljb25XaWR0aCkgLyAyLCAicHgiKTsKICAgICAgICBzdHlsZS50b3AgPSAiIi5jb25jYXQob2Zmc2V0LnRvcCArIChvZmZzZXQuaGVpZ2h0IC0gaWNvbkhlaWdodCkgLyAyLCAicHgiKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgImJvdHRvbS1taWRkbGUiOgogICAgICAgIHN0eWxlLmxlZnQgPSAiIi5jb25jYXQob2Zmc2V0LmxlZnQgKyAob2Zmc2V0LndpZHRoIC0gaWNvbldpZHRoKSAvIDIsICJweCIpOwogICAgICAgIHN0eWxlLnRvcCA9ICIiLmNvbmNhdChvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodCAtIGljb25IZWlnaHQsICJweCIpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAidG9wLW1pZGRsZSI6CiAgICAgICAgc3R5bGUubGVmdCA9ICIiLmNvbmNhdChvZmZzZXQubGVmdCArIChvZmZzZXQud2lkdGggLSBpY29uV2lkdGgpIC8gMiwgInB4Iik7CiAgICAgICAgc3R5bGUudG9wID0gIiIuY29uY2F0KG9mZnNldC50b3AsICJweCIpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICAvKioKICAgKiBUcmlnZ2VycyB3aGVuIHVzZXIgY2xpY2tzIG9uIHRoZSBoaW50IGVsZW1lbnQKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX3Nob3dIaW50RGlhbG9nCiAgICogQHBhcmFtIHtOdW1iZXJ9IHN0ZXBJZAogICAqLwoKCiAgZnVuY3Rpb24gc2hvd0hpbnREaWFsb2coc3RlcElkKSB7CiAgICB2YXIgaGludEVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy1oaW50W2RhdGEtc3RlcD1cIiIuY29uY2F0KHN0ZXBJZCwgIlwiXSIpKTsKICAgIHZhciBpdGVtID0gdGhpcy5faW50cm9JdGVtc1tzdGVwSWRdOyAvLyBjYWxsIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAoaWYgYW55KQoKICAgIGlmICh0eXBlb2YgdGhpcy5faGludENsaWNrQ2FsbGJhY2sgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRoaXMuX2hpbnRDbGlja0NhbGxiYWNrLmNhbGwodGhpcywgaGludEVsZW1lbnQsIGl0ZW0sIHN0ZXBJZCk7CiAgICB9IC8vIHJlbW92ZSBhbGwgb3BlbiB0b29sdGlwcwoKCiAgICB2YXIgcmVtb3ZlZFN0ZXAgPSByZW1vdmVIaW50VG9vbHRpcC5jYWxsKHRoaXMpOyAvLyB0byB0b2dnbGUgdGhlIHRvb2x0aXAKCiAgICBpZiAocGFyc2VJbnQocmVtb3ZlZFN0ZXAsIDEwKSA9PT0gc3RlcElkKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgdG9vbHRpcExheWVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB2YXIgdG9vbHRpcFRleHRMYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdmFyIGFycm93TGF5ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHZhciByZWZlcmVuY2VMYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdG9vbHRpcExheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLXRvb2x0aXAiOwoKICAgIHRvb2x0aXBMYXllci5vbmNsaWNrID0gZnVuY3Rpb24gKGUpIHsKICAgICAgLy9JRTkgJiBPdGhlciBCcm93c2VycwogICAgICBpZiAoZS5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICB9IC8vSUU4IGFuZCBMb3dlcgogICAgICBlbHNlIHsKICAgICAgICAgIGUuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICB9CiAgICB9OwoKICAgIHRvb2x0aXBUZXh0TGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtdG9vbHRpcHRleHQiOwogICAgdmFyIHRvb2x0aXBXcmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicCIpOwogICAgdG9vbHRpcFdyYXBwZXIuaW5uZXJIVE1MID0gaXRlbS5oaW50OwogICAgdmFyIGNsb3NlQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgY2xvc2VCdXR0b24uY2xhc3NOYW1lID0gdGhpcy5fb3B0aW9ucy5idXR0b25DbGFzczsKICAgIGNsb3NlQnV0dG9uLnNldEF0dHJpYnV0ZSgicm9sZSIsICJidXR0b24iKTsKICAgIGNsb3NlQnV0dG9uLmlubmVySFRNTCA9IHRoaXMuX29wdGlvbnMuaGludEJ1dHRvbkxhYmVsOwogICAgY2xvc2VCdXR0b24ub25jbGljayA9IGhpZGVIaW50LmJpbmQodGhpcywgc3RlcElkKTsKICAgIHRvb2x0aXBUZXh0TGF5ZXIuYXBwZW5kQ2hpbGQodG9vbHRpcFdyYXBwZXIpOwogICAgdG9vbHRpcFRleHRMYXllci5hcHBlbmRDaGlsZChjbG9zZUJ1dHRvbik7CiAgICBhcnJvd0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWFycm93IjsKICAgIHRvb2x0aXBMYXllci5hcHBlbmRDaGlsZChhcnJvd0xheWVyKTsKICAgIHRvb2x0aXBMYXllci5hcHBlbmRDaGlsZCh0b29sdGlwVGV4dExheWVyKTsgLy8gc2V0IGN1cnJlbnQgc3RlcCBmb3IgX3BsYWNlVG9vbHRpcCBmdW5jdGlvbgoKICAgIHRoaXMuX2N1cnJlbnRTdGVwID0gaGludEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLXN0ZXAiKTsgLy8gYWxpZ24gcmVmZXJlbmNlIGxheWVyIHBvc2l0aW9uCgogICAgcmVmZXJlbmNlTGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtdG9vbHRpcFJlZmVyZW5jZUxheWVyIGludHJvanMtaGludFJlZmVyZW5jZSI7CiAgICByZWZlcmVuY2VMYXllci5zZXRBdHRyaWJ1dGUoImRhdGEtc3RlcCIsIGhpbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1zdGVwIikpOwogICAgc2V0SGVscGVyTGF5ZXJQb3NpdGlvbi5jYWxsKHRoaXMsIHJlZmVyZW5jZUxheWVyKTsKICAgIHJlZmVyZW5jZUxheWVyLmFwcGVuZENoaWxkKHRvb2x0aXBMYXllcik7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHJlZmVyZW5jZUxheWVyKTsgLy9zZXQgcHJvcGVyIHBvc2l0aW9uCgogICAgcGxhY2VUb29sdGlwLmNhbGwodGhpcywgaGludEVsZW1lbnQsIHRvb2x0aXBMYXllciwgYXJyb3dMYXllciwgbnVsbCwgdHJ1ZSk7CiAgfQogIC8qKgogICAqIFJlbW92ZXMgb3BlbiBoaW50ICh0b29sdGlwIGhpbnQpCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9yZW1vdmVIaW50VG9vbHRpcAogICAqLwoKCiAgZnVuY3Rpb24gcmVtb3ZlSGludFRvb2x0aXAoKSB7CiAgICB2YXIgdG9vbHRpcCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWhpbnRSZWZlcmVuY2UiKTsKCiAgICBpZiAodG9vbHRpcCkgewogICAgICB2YXIgc3RlcCA9IHRvb2x0aXAuZ2V0QXR0cmlidXRlKCJkYXRhLXN0ZXAiKTsKICAgICAgdG9vbHRpcC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRvb2x0aXApOwogICAgICByZXR1cm4gc3RlcDsKICAgIH0KICB9CiAgLyoqCiAgICogU3RhcnQgcGFyc2luZyBoaW50IGl0ZW1zCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0RWxtCiAgICogQG1ldGhvZCBfc3RhcnRIaW50CiAgICovCgoKICBmdW5jdGlvbiBwb3B1bGF0ZUhpbnRzKHRhcmdldEVsbSkgewogICAgdmFyIF90aGlzNSA9IHRoaXM7CgogICAgdGhpcy5faW50cm9JdGVtcyA9IFtdOwoKICAgIGlmICh0aGlzLl9vcHRpb25zLmhpbnRzKSB7CiAgICAgIGZvckVhY2godGhpcy5fb3B0aW9ucy5oaW50cywgZnVuY3Rpb24gKGhpbnQpIHsKICAgICAgICB2YXIgY3VycmVudEl0ZW0gPSBjbG9uZU9iamVjdChoaW50KTsKCiAgICAgICAgaWYgKHR5cGVvZiBjdXJyZW50SXRlbS5lbGVtZW50ID09PSAic3RyaW5nIikgewogICAgICAgICAgLy9ncmFiIHRoZSBlbGVtZW50IHdpdGggZ2l2ZW4gc2VsZWN0b3IgZnJvbSB0aGUgcGFnZQogICAgICAgICAgY3VycmVudEl0ZW0uZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoY3VycmVudEl0ZW0uZWxlbWVudCk7CiAgICAgICAgfQoKICAgICAgICBjdXJyZW50SXRlbS5oaW50UG9zaXRpb24gPSBjdXJyZW50SXRlbS5oaW50UG9zaXRpb24gfHwgX3RoaXM1Ll9vcHRpb25zLmhpbnRQb3NpdGlvbjsKICAgICAgICBjdXJyZW50SXRlbS5oaW50QW5pbWF0aW9uID0gY3VycmVudEl0ZW0uaGludEFuaW1hdGlvbiB8fCBfdGhpczUuX29wdGlvbnMuaGludEFuaW1hdGlvbjsKCiAgICAgICAgaWYgKGN1cnJlbnRJdGVtLmVsZW1lbnQgIT09IG51bGwpIHsKICAgICAgICAgIF90aGlzNS5faW50cm9JdGVtcy5wdXNoKGN1cnJlbnRJdGVtKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGhpbnRzID0gdGFyZ2V0RWxtLnF1ZXJ5U2VsZWN0b3JBbGwoIipbZGF0YS1oaW50XSIpOwoKICAgICAgaWYgKCFoaW50cyB8fCAhaGludHMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IC8vZmlyc3QgYWRkIGludHJvIGl0ZW1zIHdpdGggZGF0YS1zdGVwCgoKICAgICAgZm9yRWFjaChoaW50cywgZnVuY3Rpb24gKGN1cnJlbnRFbGVtZW50KSB7CiAgICAgICAgLy8gaGludCBhbmltYXRpb24KICAgICAgICB2YXIgaGludEFuaW1hdGlvbiA9IGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1oaW50YW5pbWF0aW9uIik7CgogICAgICAgIGlmIChoaW50QW5pbWF0aW9uKSB7CiAgICAgICAgICBoaW50QW5pbWF0aW9uID0gaGludEFuaW1hdGlvbiA9PT0gInRydWUiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBoaW50QW5pbWF0aW9uID0gX3RoaXM1Ll9vcHRpb25zLmhpbnRBbmltYXRpb247CiAgICAgICAgfQoKICAgICAgICBfdGhpczUuX2ludHJvSXRlbXMucHVzaCh7CiAgICAgICAgICBlbGVtZW50OiBjdXJyZW50RWxlbWVudCwKICAgICAgICAgIGhpbnQ6IGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1oaW50IiksCiAgICAgICAgICBoaW50UG9zaXRpb246IGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1oaW50cG9zaXRpb24iKSB8fCBfdGhpczUuX29wdGlvbnMuaGludFBvc2l0aW9uLAogICAgICAgICAgaGludEFuaW1hdGlvbjogaGludEFuaW1hdGlvbiwKICAgICAgICAgIHRvb2x0aXBDbGFzczogY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLXRvb2x0aXBjbGFzcyIpLAogICAgICAgICAgcG9zaXRpb246IGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1wb3NpdGlvbiIpIHx8IF90aGlzNS5fb3B0aW9ucy50b29sdGlwUG9zaXRpb24KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgYWRkSGludHMuY2FsbCh0aGlzKTsKICAgIC8qCiAgICB0b2RvOgogICAgdGhlc2UgZXZlbnRzIHNob3VsZCBiZSByZW1vdmVkIGF0IHNvbWUgcG9pbnQKICAgICovCgogICAgRE9NRXZlbnQub24oZG9jdW1lbnQsICJjbGljayIsIHJlbW92ZUhpbnRUb29sdGlwLCB0aGlzLCBmYWxzZSk7CiAgICBET01FdmVudC5vbih3aW5kb3csICJyZXNpemUiLCByZUFsaWduSGludHMsIHRoaXMsIHRydWUpOwogIH0KICAvKioKICAgKiBSZS1hbGlnbnMgYWxsIGhpbnQgZWxlbWVudHMKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX3JlQWxpZ25IaW50cwogICAqLwoKCiAgZnVuY3Rpb24gcmVBbGlnbkhpbnRzKCkgewogICAgdmFyIF90aGlzNiA9IHRoaXM7CgogICAgZm9yRWFjaCh0aGlzLl9pbnRyb0l0ZW1zLCBmdW5jdGlvbiAoX3JlZjIpIHsKICAgICAgdmFyIHRhcmdldEVsZW1lbnQgPSBfcmVmMi50YXJnZXRFbGVtZW50LAogICAgICAgICAgaGludFBvc2l0aW9uID0gX3JlZjIuaGludFBvc2l0aW9uLAogICAgICAgICAgZWxlbWVudCA9IF9yZWYyLmVsZW1lbnQ7CgogICAgICBpZiAodHlwZW9mIHRhcmdldEVsZW1lbnQgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBhbGlnbkhpbnRQb3NpdGlvbi5jYWxsKF90aGlzNiwgaGludFBvc2l0aW9uLCBlbGVtZW50LCB0YXJnZXRFbGVtZW50KTsKICAgIH0pOwogIH0KICAvKioKICAgKiBVcGRhdGUgcGxhY2VtZW50IG9mIHRoZSBpbnRybyBvYmplY3RzIG9uIHRoZSBzY3JlZW4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KCgogIGZ1bmN0aW9uIHJlZnJlc2goKSB7CiAgICAvLyByZS1hbGlnbiBpbnRyb3MKICAgIHNldEhlbHBlckxheWVyUG9zaXRpb24uY2FsbCh0aGlzLCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy1oZWxwZXJMYXllciIpKTsKICAgIHNldEhlbHBlckxheWVyUG9zaXRpb24uY2FsbCh0aGlzLCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy10b29sdGlwUmVmZXJlbmNlTGF5ZXIiKSk7CiAgICBzZXRIZWxwZXJMYXllclBvc2l0aW9uLmNhbGwodGhpcywgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtZGlzYWJsZUludGVyYWN0aW9uIikpOyAvLyByZS1hbGlnbiB0b29sdGlwCgogICAgaWYgKHRoaXMuX2N1cnJlbnRTdGVwICE9PSB1bmRlZmluZWQgJiYgdGhpcy5fY3VycmVudFN0ZXAgIT09IG51bGwpIHsKICAgICAgdmFyIG9sZEhlbHBlck51bWJlckxheWVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtaGVscGVyTnVtYmVyTGF5ZXIiKTsKICAgICAgdmFyIG9sZEFycm93TGF5ZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy1hcnJvdyIpOwogICAgICB2YXIgb2xkdG9vbHRpcENvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLXRvb2x0aXAiKTsKICAgICAgcGxhY2VUb29sdGlwLmNhbGwodGhpcywgdGhpcy5faW50cm9JdGVtc1t0aGlzLl9jdXJyZW50U3RlcF0uZWxlbWVudCwgb2xkdG9vbHRpcENvbnRhaW5lciwgb2xkQXJyb3dMYXllciwgb2xkSGVscGVyTnVtYmVyTGF5ZXIpOwogICAgfSAvL3JlLWFsaWduIGhpbnRzCgoKICAgIHJlQWxpZ25IaW50cy5jYWxsKHRoaXMpOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICBmdW5jdGlvbiBvblJlc2l6ZSgpIHsKICAgIHJlZnJlc2guY2FsbCh0aGlzKTsKICB9CiAgLyoqCiAgICogRXhpdCBmcm9tIGludHJvCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9leGl0SW50cm8KICAgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0RWxlbWVudAogICAqIEBwYXJhbSB7Qm9vbGVhbn0gZm9yY2UgLSBTZXR0aW5nIHRvIGB0cnVlYCB3aWxsIHNraXAgdGhlIHJlc3VsdCBvZiBiZWZvcmVFeGl0IGNhbGxiYWNrCiAgICovCgoKICBmdW5jdGlvbiBleGl0SW50cm8odGFyZ2V0RWxlbWVudCwgZm9yY2UpIHsKICAgIHZhciBjb250aW51ZUV4aXQgPSB0cnVlOyAvLyBjYWxsaW5nIG9uYmVmb3JlZXhpdCBjYWxsYmFjawogICAgLy8KICAgIC8vIElmIHRoaXMgY2FsbGJhY2sgcmV0dXJuIGBmYWxzZWAsIGl0IHdvdWxkIGhhbHQgdGhlIHByb2Nlc3MKCiAgICBpZiAodGhpcy5faW50cm9CZWZvcmVFeGl0Q2FsbGJhY2sgIT09IHVuZGVmaW5lZCkgewogICAgICBjb250aW51ZUV4aXQgPSB0aGlzLl9pbnRyb0JlZm9yZUV4aXRDYWxsYmFjay5jYWxsKHRoaXMpOwogICAgfSAvLyBza2lwIHRoaXMgY2hlY2sgaWYgYGZvcmNlYCBwYXJhbWV0ZXIgaXMgYHRydWVgCiAgICAvLyBvdGhlcndpc2UsIGlmIGBvbmJlZm9yZWV4aXRgIHJldHVybmVkIGBmYWxzZWAsIGRvbid0IGV4aXQgdGhlIGludHJvCgoKICAgIGlmICghZm9yY2UgJiYgY29udGludWVFeGl0ID09PSBmYWxzZSkgcmV0dXJuOyAvL3JlbW92ZSBvdmVybGF5IGxheWVycyBmcm9tIHRoZSBwYWdlCgogICAgdmFyIG92ZXJsYXlMYXllcnMgPSB0YXJnZXRFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIi5pbnRyb2pzLW92ZXJsYXkiKTsKCiAgICBpZiAob3ZlcmxheUxheWVycyAmJiBvdmVybGF5TGF5ZXJzLmxlbmd0aCkgewogICAgICBmb3JFYWNoKG92ZXJsYXlMYXllcnMsIGZ1bmN0aW9uIChvdmVybGF5TGF5ZXIpIHsKICAgICAgICBvdmVybGF5TGF5ZXIuc3R5bGUub3BhY2l0eSA9IDA7CiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSkgewogICAgICAgICAgICB0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgfS5iaW5kKG92ZXJsYXlMYXllciksIDUwMCk7CiAgICAgIH0pOwogICAgfSAvL3JlbW92ZSBhbGwgaGVscGVyIGxheWVycwoKCiAgICB2YXIgaGVscGVyTGF5ZXIgPSB0YXJnZXRFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWhlbHBlckxheWVyIik7CgogICAgaWYgKGhlbHBlckxheWVyKSB7CiAgICAgIGhlbHBlckxheWVyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaGVscGVyTGF5ZXIpOwogICAgfQoKICAgIHZhciByZWZlcmVuY2VMYXllciA9IHRhcmdldEVsZW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtdG9vbHRpcFJlZmVyZW5jZUxheWVyIik7CgogICAgaWYgKHJlZmVyZW5jZUxheWVyKSB7CiAgICAgIHJlZmVyZW5jZUxheWVyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocmVmZXJlbmNlTGF5ZXIpOwogICAgfSAvL3JlbW92ZSBkaXNhYmxlSW50ZXJhY3Rpb25MYXllcgoKCiAgICB2YXIgZGlzYWJsZUludGVyYWN0aW9uTGF5ZXIgPSB0YXJnZXRFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWRpc2FibGVJbnRlcmFjdGlvbiIpOwoKICAgIGlmIChkaXNhYmxlSW50ZXJhY3Rpb25MYXllcikgewogICAgICBkaXNhYmxlSW50ZXJhY3Rpb25MYXllci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGRpc2FibGVJbnRlcmFjdGlvbkxheWVyKTsKICAgIH0gLy9yZW1vdmUgaW50cm8gZmxvYXRpbmcgZWxlbWVudAoKCiAgICB2YXIgZmxvYXRpbmdFbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanNGbG9hdGluZ0VsZW1lbnQiKTsKCiAgICBpZiAoZmxvYXRpbmdFbGVtZW50KSB7CiAgICAgIGZsb2F0aW5nRWxlbWVudC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGZsb2F0aW5nRWxlbWVudCk7CiAgICB9CgogICAgcmVtb3ZlU2hvd0VsZW1lbnQoKTsgLy9yZW1vdmUgYGludHJvanMtZml4UGFyZW50YCBjbGFzcyBmcm9tIHRoZSBlbGVtZW50cwoKICAgIHZhciBmaXhQYXJlbnRzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgiLmludHJvanMtZml4UGFyZW50Iik7CiAgICBmb3JFYWNoKGZpeFBhcmVudHMsIGZ1bmN0aW9uIChwYXJlbnQpIHsKICAgICAgcmVtb3ZlQ2xhc3MocGFyZW50LCAvaW50cm9qcy1maXhQYXJlbnQvZyk7CiAgICB9KTsgLy9jbGVhbiBsaXN0ZW5lcnMKCiAgICBET01FdmVudC5vZmYod2luZG93LCAia2V5ZG93biIsIG9uS2V5RG93biwgdGhpcywgdHJ1ZSk7CiAgICBET01FdmVudC5vZmYod2luZG93LCAicmVzaXplIiwgb25SZXNpemUsIHRoaXMsIHRydWUpOyAvL2NoZWNrIGlmIGFueSBjYWxsYmFjayBpcyBkZWZpbmVkCgogICAgaWYgKHRoaXMuX2ludHJvRXhpdENhbGxiYWNrICE9PSB1bmRlZmluZWQpIHsKICAgICAgdGhpcy5faW50cm9FeGl0Q2FsbGJhY2suY2FsbCh0aGlzKTsKICAgIH0gLy9zZXQgdGhlIHN0ZXAgdG8gemVybwoKCiAgICB0aGlzLl9jdXJyZW50U3RlcCA9IHVuZGVmaW5lZDsKICB9CiAgLyoqCiAgICogQWRkIG92ZXJsYXkgbGF5ZXIgdG8gdGhlIHBhZ2UKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX2FkZE92ZXJsYXlMYXllcgogICAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXRFbG0KICAgKi8KCgogIGZ1bmN0aW9uIGFkZE92ZXJsYXlMYXllcih0YXJnZXRFbG0pIHsKICAgIHZhciBvdmVybGF5TGF5ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHZhciBzdHlsZVRleHQgPSAiIjsKICAgIHZhciBzZWxmID0gdGhpczsgLy9zZXQgY3NzIGNsYXNzIG5hbWUKCiAgICBvdmVybGF5TGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtb3ZlcmxheSI7IC8vY2hlY2sgaWYgdGhlIHRhcmdldCBlbGVtZW50IGlzIGJvZHksIHdlIHNob3VsZCBjYWxjdWxhdGUgdGhlIHNpemUgb2Ygb3ZlcmxheSBsYXllciBpbiBhIGJldHRlciB3YXkKCiAgICBpZiAoIXRhcmdldEVsbS50YWdOYW1lIHx8IHRhcmdldEVsbS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJib2R5IikgewogICAgICBzdHlsZVRleHQgKz0gInRvcDogMDtib3R0b206IDA7IGxlZnQ6IDA7cmlnaHQ6IDA7cG9zaXRpb246IGZpeGVkOyI7CiAgICAgIG92ZXJsYXlMYXllci5zdHlsZS5jc3NUZXh0ID0gc3R5bGVUZXh0OwogICAgfSBlbHNlIHsKICAgICAgLy9zZXQgb3ZlcmxheSBsYXllciBwb3NpdGlvbgogICAgICB2YXIgZWxlbWVudFBvc2l0aW9uID0gZ2V0T2Zmc2V0KHRhcmdldEVsbSk7CgogICAgICBpZiAoZWxlbWVudFBvc2l0aW9uKSB7CiAgICAgICAgc3R5bGVUZXh0ICs9ICJ3aWR0aDogIi5jb25jYXQoZWxlbWVudFBvc2l0aW9uLndpZHRoLCAicHg7IGhlaWdodDoiKS5jb25jYXQoZWxlbWVudFBvc2l0aW9uLmhlaWdodCwgInB4OyB0b3A6IikuY29uY2F0KGVsZW1lbnRQb3NpdGlvbi50b3AsICJweDtsZWZ0OiAiKS5jb25jYXQoZWxlbWVudFBvc2l0aW9uLmxlZnQsICJweDsiKTsKICAgICAgICBvdmVybGF5TGF5ZXIuc3R5bGUuY3NzVGV4dCA9IHN0eWxlVGV4dDsKICAgICAgfQogICAgfQoKICAgIHRhcmdldEVsbS5hcHBlbmRDaGlsZChvdmVybGF5TGF5ZXIpOwoKICAgIG92ZXJsYXlMYXllci5vbmNsaWNrID0gZnVuY3Rpb24gKCkgewogICAgICBpZiAoc2VsZi5fb3B0aW9ucy5leGl0T25PdmVybGF5Q2xpY2sgPT09IHRydWUpIHsKICAgICAgICBleGl0SW50cm8uY2FsbChzZWxmLCB0YXJnZXRFbG0pOwogICAgICB9CiAgICB9OwoKICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgc3R5bGVUZXh0ICs9ICJvcGFjaXR5OiAiLmNvbmNhdChzZWxmLl9vcHRpb25zLm92ZXJsYXlPcGFjaXR5LnRvU3RyaW5nKCksICI7Iik7CiAgICAgIG92ZXJsYXlMYXllci5zdHlsZS5jc3NUZXh0ID0gc3R5bGVUZXh0OwogICAgfSwgMTApOwogICAgcmV0dXJuIHRydWU7CiAgfQogIC8qKgogICAqIEluaXRpYXRlIGEgbmV3IGludHJvZHVjdGlvbi9ndWlkZSBmcm9tIGFuIGVsZW1lbnQgaW4gdGhlIHBhZ2UKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX2ludHJvRm9yRWxlbWVudAogICAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXRFbG0KICAgKiBAcGFyYW0ge1N0cmluZ30gZ3JvdXAKICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gU3VjY2VzcyBvciBub3Q/CiAgICovCgoKICBmdW5jdGlvbiBpbnRyb0ZvckVsZW1lbnQodGFyZ2V0RWxtLCBncm91cCkgewogICAgdmFyIF90aGlzID0gdGhpczsKCiAgICB2YXIgYWxsSW50cm9TdGVwcyA9IHRhcmdldEVsbS5xdWVyeVNlbGVjdG9yQWxsKCIqW2RhdGEtaW50cm9dIik7CiAgICB2YXIgaW50cm9JdGVtcyA9IFtdOwoKICAgIGlmICh0aGlzLl9vcHRpb25zLnN0ZXBzKSB7CiAgICAgIC8vdXNlIHN0ZXBzIHBhc3NlZCBwcm9ncmFtbWF0aWNhbGx5CiAgICAgIGZvckVhY2godGhpcy5fb3B0aW9ucy5zdGVwcywgZnVuY3Rpb24gKHN0ZXApIHsKICAgICAgICB2YXIgY3VycmVudEl0ZW0gPSBjbG9uZU9iamVjdChzdGVwKTsgLy9zZXQgdGhlIHN0ZXAKCiAgICAgICAgY3VycmVudEl0ZW0uc3RlcCA9IGludHJvSXRlbXMubGVuZ3RoICsgMTsgLy91c2UgcXVlcnlTZWxlY3RvciBmdW5jdGlvbiBvbmx5IHdoZW4gZGV2ZWxvcGVyIHVzZWQgQ1NTIHNlbGVjdG9yCgogICAgICAgIGlmICh0eXBlb2YgY3VycmVudEl0ZW0uZWxlbWVudCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIC8vZ3JhYiB0aGUgZWxlbWVudCB3aXRoIGdpdmVuIHNlbGVjdG9yIGZyb20gdGhlIHBhZ2UKICAgICAgICAgIGN1cnJlbnRJdGVtLmVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGN1cnJlbnRJdGVtLmVsZW1lbnQpOwogICAgICAgIH0gLy9pbnRybyB3aXRob3V0IGVsZW1lbnQKCgogICAgICAgIGlmICh0eXBlb2YgY3VycmVudEl0ZW0uZWxlbWVudCA9PT0gInVuZGVmaW5lZCIgfHwgY3VycmVudEl0ZW0uZWxlbWVudCA9PT0gbnVsbCkgewogICAgICAgICAgdmFyIGZsb2F0aW5nRWxlbWVudFF1ZXJ5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanNGbG9hdGluZ0VsZW1lbnQiKTsKCiAgICAgICAgICBpZiAoZmxvYXRpbmdFbGVtZW50UXVlcnkgPT09IG51bGwpIHsKICAgICAgICAgICAgZmxvYXRpbmdFbGVtZW50UXVlcnkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgZmxvYXRpbmdFbGVtZW50UXVlcnkuY2xhc3NOYW1lID0gImludHJvanNGbG9hdGluZ0VsZW1lbnQiOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGZsb2F0aW5nRWxlbWVudFF1ZXJ5KTsKICAgICAgICAgIH0KCiAgICAgICAgICBjdXJyZW50SXRlbS5lbGVtZW50ID0gZmxvYXRpbmdFbGVtZW50UXVlcnk7CiAgICAgICAgICBjdXJyZW50SXRlbS5wb3NpdGlvbiA9ICJmbG9hdGluZyI7CiAgICAgICAgfQoKICAgICAgICBjdXJyZW50SXRlbS5zY3JvbGxUbyA9IGN1cnJlbnRJdGVtLnNjcm9sbFRvIHx8IF90aGlzLl9vcHRpb25zLnNjcm9sbFRvOwoKICAgICAgICBpZiAodHlwZW9mIGN1cnJlbnRJdGVtLmRpc2FibGVJbnRlcmFjdGlvbiA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIGN1cnJlbnRJdGVtLmRpc2FibGVJbnRlcmFjdGlvbiA9IF90aGlzLl9vcHRpb25zLmRpc2FibGVJbnRlcmFjdGlvbjsKICAgICAgICB9CgogICAgICAgIGlmIChjdXJyZW50SXRlbS5lbGVtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICBpbnRyb0l0ZW1zLnB1c2goY3VycmVudEl0ZW0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICAvL3VzZSBzdGVwcyBmcm9tIGRhdGEtKiBhbm5vdGF0aW9ucwogICAgICB2YXIgZWxtc0xlbmd0aCA9IGFsbEludHJvU3RlcHMubGVuZ3RoOwogICAgICB2YXIgZGlzYWJsZUludGVyYWN0aW9uOyAvL2lmIHRoZXJlJ3Mgbm8gZWxlbWVudCB0byBpbnRybwoKICAgICAgaWYgKGVsbXNMZW5ndGggPCAxKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBmb3JFYWNoKGFsbEludHJvU3RlcHMsIGZ1bmN0aW9uIChjdXJyZW50RWxlbWVudCkgewogICAgICAgIC8vIFBSICM4MAogICAgICAgIC8vIHN0YXJ0IGludHJvIGZvciBncm91cHMgb2YgZWxlbWVudHMKICAgICAgICBpZiAoZ3JvdXAgJiYgY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLWludHJvLWdyb3VwIikgIT09IGdyb3VwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfSAvLyBza2lwIGhpZGRlbiBlbGVtZW50cwoKCiAgICAgICAgaWYgKGN1cnJlbnRFbGVtZW50LnN0eWxlLmRpc3BsYXkgPT09ICJub25lIikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHN0ZXAgPSBwYXJzZUludChjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtc3RlcCIpLCAxMCk7CgogICAgICAgIGlmICh0eXBlb2YgY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLWRpc2FibGUtaW50ZXJhY3Rpb24iKSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIGRpc2FibGVJbnRlcmFjdGlvbiA9ICEhY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLWRpc2FibGUtaW50ZXJhY3Rpb24iKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGlzYWJsZUludGVyYWN0aW9uID0gX3RoaXMuX29wdGlvbnMuZGlzYWJsZUludGVyYWN0aW9uOwogICAgICAgIH0KCiAgICAgICAgaWYgKHN0ZXAgPiAwKSB7CiAgICAgICAgICBpbnRyb0l0ZW1zW3N0ZXAgLSAxXSA9IHsKICAgICAgICAgICAgZWxlbWVudDogY3VycmVudEVsZW1lbnQsCiAgICAgICAgICAgIGludHJvOiBjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtaW50cm8iKSwKICAgICAgICAgICAgc3RlcDogcGFyc2VJbnQoY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLXN0ZXAiKSwgMTApLAogICAgICAgICAgICB0b29sdGlwQ2xhc3M6IGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS10b29sdGlwY2xhc3MiKSwKICAgICAgICAgICAgaGlnaGxpZ2h0Q2xhc3M6IGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1oaWdobGlnaHRjbGFzcyIpLAogICAgICAgICAgICBwb3NpdGlvbjogY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLXBvc2l0aW9uIikgfHwgX3RoaXMuX29wdGlvbnMudG9vbHRpcFBvc2l0aW9uLAogICAgICAgICAgICBzY3JvbGxUbzogY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLXNjcm9sbHRvIikgfHwgX3RoaXMuX29wdGlvbnMuc2Nyb2xsVG8sCiAgICAgICAgICAgIGRpc2FibGVJbnRlcmFjdGlvbjogZGlzYWJsZUludGVyYWN0aW9uCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7IC8vbmV4dCBhZGQgaW50cm8gaXRlbXMgd2l0aG91dCBkYXRhLXN0ZXAKICAgICAgLy90b2RvOiB3ZSBuZWVkIGEgY2xlYW51cCBoZXJlLCB0d28gbG9vcHMgYXJlIHJlZHVuZGFudAoKICAgICAgdmFyIF9uZXh0U3RlcCA9IDA7CiAgICAgIGZvckVhY2goYWxsSW50cm9TdGVwcywgZnVuY3Rpb24gKGN1cnJlbnRFbGVtZW50KSB7CiAgICAgICAgLy8gUFIgIzgwCiAgICAgICAgLy8gc3RhcnQgaW50cm8gZm9yIGdyb3VwcyBvZiBlbGVtZW50cwogICAgICAgIGlmIChncm91cCAmJiBjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtaW50cm8tZ3JvdXAiKSAhPT0gZ3JvdXApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtc3RlcCIpID09PSBudWxsKSB7CiAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGludHJvSXRlbXNbX25leHRTdGVwXSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBfbmV4dFN0ZXArKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0eXBlb2YgY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLWRpc2FibGUtaW50ZXJhY3Rpb24iKSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgZGlzYWJsZUludGVyYWN0aW9uID0gISFjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtZGlzYWJsZS1pbnRlcmFjdGlvbiIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGlzYWJsZUludGVyYWN0aW9uID0gX3RoaXMuX29wdGlvbnMuZGlzYWJsZUludGVyYWN0aW9uOwogICAgICAgICAgfQoKICAgICAgICAgIGludHJvSXRlbXNbX25leHRTdGVwXSA9IHsKICAgICAgICAgICAgZWxlbWVudDogY3VycmVudEVsZW1lbnQsCiAgICAgICAgICAgIGludHJvOiBjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtaW50cm8iKSwKICAgICAgICAgICAgc3RlcDogX25leHRTdGVwICsgMSwKICAgICAgICAgICAgdG9vbHRpcENsYXNzOiBjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtdG9vbHRpcGNsYXNzIiksCiAgICAgICAgICAgIGhpZ2hsaWdodENsYXNzOiBjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtaGlnaGxpZ2h0Y2xhc3MiKSwKICAgICAgICAgICAgcG9zaXRpb246IGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1wb3NpdGlvbiIpIHx8IF90aGlzLl9vcHRpb25zLnRvb2x0aXBQb3NpdGlvbiwKICAgICAgICAgICAgc2Nyb2xsVG86IGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1zY3JvbGx0byIpIHx8IF90aGlzLl9vcHRpb25zLnNjcm9sbFRvLAogICAgICAgICAgICBkaXNhYmxlSW50ZXJhY3Rpb246IGRpc2FibGVJbnRlcmFjdGlvbgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSAvL3JlbW92aW5nIHVuZGVmaW5lZC9udWxsIGVsZW1lbnRzCgoKICAgIHZhciB0ZW1wSW50cm9JdGVtcyA9IFtdOwoKICAgIGZvciAodmFyIHogPSAwOyB6IDwgaW50cm9JdGVtcy5sZW5ndGg7IHorKykgewogICAgICBpZiAoaW50cm9JdGVtc1t6XSkgewogICAgICAgIC8vIGNvcHkgbm9uLWZhbHN5IHZhbHVlcyB0byB0aGUgZW5kIG9mIHRoZSBhcnJheQogICAgICAgIHRlbXBJbnRyb0l0ZW1zLnB1c2goaW50cm9JdGVtc1t6XSk7CiAgICAgIH0KICAgIH0KCiAgICBpbnRyb0l0ZW1zID0gdGVtcEludHJvSXRlbXM7IC8vT2ssIHNvcnQgYWxsIGl0ZW1zIHdpdGggZ2l2ZW4gc3RlcHMKCiAgICBpbnRyb0l0ZW1zLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgcmV0dXJuIGEuc3RlcCAtIGIuc3RlcDsKICAgIH0pOyAvL3NldCBpdCB0byB0aGUgaW50cm9KcyBvYmplY3QKCiAgICB0aGlzLl9pbnRyb0l0ZW1zID0gaW50cm9JdGVtczsgLy9hZGQgb3ZlcmxheSBsYXllciB0byB0aGUgcGFnZQoKICAgIGlmIChhZGRPdmVybGF5TGF5ZXIuY2FsbCh0aGlzLCB0YXJnZXRFbG0pKSB7CiAgICAgIC8vdGhlbiwgc3RhcnQgdGhlIHNob3cKICAgICAgbmV4dFN0ZXAuY2FsbCh0aGlzKTsKCiAgICAgIGlmICh0aGlzLl9vcHRpb25zLmtleWJvYXJkTmF2aWdhdGlvbikgewogICAgICAgIERPTUV2ZW50Lm9uKHdpbmRvdywgImtleWRvd24iLCBvbktleURvd24sIHRoaXMsIHRydWUpOwogICAgICB9IC8vZm9yIHdpbmRvdyByZXNpemUKCgogICAgICBET01FdmVudC5vbih3aW5kb3csICJyZXNpemUiLCBvblJlc2l6ZSwgdGhpcywgdHJ1ZSk7CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgdmFyIHZlcnNpb24gPSAiMy4wLjEiOwogIC8qKgogICAqIEludHJvSnMgbWFpbiBjbGFzcwogICAqCiAgICogQGNsYXNzIEludHJvSnMKICAgKi8KCiAgZnVuY3Rpb24gSW50cm9KcyhvYmopIHsKICAgIHRoaXMuX3RhcmdldEVsZW1lbnQgPSBvYmo7CiAgICB0aGlzLl9pbnRyb0l0ZW1zID0gW107CiAgICB0aGlzLl9vcHRpb25zID0gewogICAgICAvKiBMYWJlbCBEaXNwbGF5IHRvIGJlIFNob3duIGluIHRoZSBoaWdobGlnaHRlZCBkaXYgKi8KICAgICAgbGFiZWxEaXNwbGF5OiAiIiwKCiAgICAgIC8qIE5leHQgYnV0dG9uIGxhYmVsIGluIHRvb2x0aXAgYm94ICovCiAgICAgIG5leHRMYWJlbDogIk5leHQgJnJhcnI7IiwKCiAgICAgIC8qIFByZXZpb3VzIGJ1dHRvbiBsYWJlbCBpbiB0b29sdGlwIGJveCAqLwogICAgICBwcmV2TGFiZWw6ICImbGFycjsgQmFjayIsCgogICAgICAvKiBTa2lwIGJ1dHRvbiBsYWJlbCBpbiB0b29sdGlwIGJveCAqLwogICAgICBza2lwTGFiZWw6ICJTa2lwIiwKCiAgICAgIC8qIERvbmUgYnV0dG9uIGxhYmVsIGluIHRvb2x0aXAgYm94ICovCiAgICAgIGRvbmVMYWJlbDogIkRvbmUiLAoKICAgICAgLyogSGlkZSBwcmV2aW91cyBidXR0b24gaW4gdGhlIGZpcnN0IHN0ZXA/IE90aGVyd2lzZSwgaXQgd2lsbCBiZSBkaXNhYmxlZCBidXR0b24uICovCiAgICAgIGhpZGVQcmV2OiBmYWxzZSwKCiAgICAgIC8qIEhpZGUgbmV4dCBidXR0b24gaW4gdGhlIGxhc3Qgc3RlcD8gT3RoZXJ3aXNlLCBpdCB3aWxsIGJlIGRpc2FibGVkIGJ1dHRvbi4gKi8KICAgICAgaGlkZU5leHQ6IGZhbHNlLAoKICAgICAgLyogRGVmYXVsdCB0b29sdGlwIGJveCBwb3NpdGlvbiAqLwogICAgICB0b29sdGlwUG9zaXRpb246ICJib3R0b20iLAoKICAgICAgLyogTmV4dCBDU1MgY2xhc3MgZm9yIHRvb2x0aXAgYm94ZXMgKi8KICAgICAgdG9vbHRpcENsYXNzOiAiIiwKCiAgICAgIC8qIENTUyBjbGFzcyB0aGF0IGlzIGFkZGVkIHRvIHRoZSBoZWxwZXJMYXllciAqLwogICAgICBoaWdobGlnaHRDbGFzczogIiIsCgogICAgICAvKiBDbG9zZSBpbnRyb2R1Y3Rpb24gd2hlbiBwcmVzc2luZyBFc2NhcGUgYnV0dG9uPyAqLwogICAgICBleGl0T25Fc2M6IHRydWUsCgogICAgICAvKiBDbG9zZSBpbnRyb2R1Y3Rpb24gd2hlbiBjbGlja2luZyBvbiBvdmVybGF5IGxheWVyPyAqLwogICAgICBleGl0T25PdmVybGF5Q2xpY2s6IHRydWUsCgogICAgICAvKiBTaG93IHN0ZXAgbnVtYmVycyBpbiBpbnRyb2R1Y3Rpb24/ICovCiAgICAgIHNob3dTdGVwTnVtYmVyczogdHJ1ZSwKCiAgICAgIC8qIExldCB1c2VyIHVzZSBrZXlib2FyZCB0byBuYXZpZ2F0ZSB0aGUgdG91cj8gKi8KICAgICAga2V5Ym9hcmROYXZpZ2F0aW9uOiB0cnVlLAoKICAgICAgLyogU2hvdyB0b3VyIGNvbnRyb2wgYnV0dG9ucz8gKi8KICAgICAgc2hvd0J1dHRvbnM6IHRydWUsCgogICAgICAvKiBTaG93IHRvdXIgYnVsbGV0cz8gKi8KICAgICAgc2hvd0J1bGxldHM6IHRydWUsCgogICAgICAvKiBTaG93IHRvdXIgcHJvZ3Jlc3M/ICovCiAgICAgIHNob3dQcm9ncmVzczogZmFsc2UsCgogICAgICAvKiBTY3JvbGwgdG8gaGlnaGxpZ2h0ZWQgZWxlbWVudD8gKi8KICAgICAgc2Nyb2xsVG9FbGVtZW50OiB0cnVlLAoKICAgICAgLyoKICAgICAgICogU2hvdWxkIHdlIHNjcm9sbCB0aGUgdG9vbHRpcCBvciB0YXJnZXQgZWxlbWVudD8KICAgICAgICoKICAgICAgICogT3B0aW9ucyBhcmU6ICdlbGVtZW50JyBvciAndG9vbHRpcCcKICAgICAgICovCiAgICAgIHNjcm9sbFRvOiAiZWxlbWVudCIsCgogICAgICAvKiBQYWRkaW5nIHRvIGFkZCBhZnRlciBzY3JvbGxpbmcgd2hlbiBlbGVtZW50IGlzIG5vdCBpbiB0aGUgdmlld3BvcnQgKGluIHBpeGVscykgKi8KICAgICAgc2Nyb2xsUGFkZGluZzogMzAsCgogICAgICAvKiBTZXQgdGhlIG92ZXJsYXkgb3BhY2l0eSAqLwogICAgICBvdmVybGF5T3BhY2l0eTogMC44LAoKICAgICAgLyogUHJlY2VkZW5jZSBvZiBwb3NpdGlvbnMsIHdoZW4gYXV0byBpcyBlbmFibGVkICovCiAgICAgIHBvc2l0aW9uUHJlY2VkZW5jZTogWyJib3R0b20iLCAidG9wIiwgInJpZ2h0IiwgImxlZnQiXSwKCiAgICAgIC8qIERpc2FibGUgYW4gaW50ZXJhY3Rpb24gd2l0aCBlbGVtZW50PyAqLwogICAgICBkaXNhYmxlSW50ZXJhY3Rpb246IGZhbHNlLAoKICAgICAgLyogU2V0IGhvdyBtdWNoIHBhZGRpbmcgdG8gYmUgdXNlZCBhcm91bmQgaGVscGVyIGVsZW1lbnQgKi8KICAgICAgaGVscGVyRWxlbWVudFBhZGRpbmc6IDEwLAoKICAgICAgLyogRGVmYXVsdCBoaW50IHBvc2l0aW9uICovCiAgICAgIGhpbnRQb3NpdGlvbjogInRvcC1taWRkbGUiLAoKICAgICAgLyogSGludCBidXR0b24gbGFiZWwgKi8KICAgICAgaGludEJ1dHRvbkxhYmVsOiAiR290IGl0IiwKCiAgICAgIC8qIEFkZGluZyBhbmltYXRpb24gdG8gaGludHM/ICovCiAgICAgIGhpbnRBbmltYXRpb246IHRydWUsCgogICAgICAvKiBhZGRpdGlvbmFsIGNsYXNzZXMgdG8gcHV0IG9uIHRoZSBidXR0b25zICovCiAgICAgIGJ1dHRvbkNsYXNzOiAiaW50cm9qcy1idXR0b24iCiAgICB9OwogIH0KCiAgdmFyIGludHJvSnMgPSBmdW5jdGlvbiBpbnRyb0pzKHRhcmdldEVsbSkgewogICAgdmFyIGluc3RhbmNlOwoKICAgIGlmIChfdHlwZW9mKHRhcmdldEVsbSkgPT09ICJvYmplY3QiKSB7CiAgICAgIC8vT2ssIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZQogICAgICBpbnN0YW5jZSA9IG5ldyBJbnRyb0pzKHRhcmdldEVsbSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB0YXJnZXRFbG0gPT09ICJzdHJpbmciKSB7CiAgICAgIC8vc2VsZWN0IHRoZSB0YXJnZXQgZWxlbWVudCB3aXRoIHF1ZXJ5IHNlbGVjdG9yCiAgICAgIHZhciB0YXJnZXRFbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0YXJnZXRFbG0pOwoKICAgICAgaWYgKHRhcmdldEVsZW1lbnQpIHsKICAgICAgICBpbnN0YW5jZSA9IG5ldyBJbnRyb0pzKHRhcmdldEVsZW1lbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlcmUgaXMgbm8gZWxlbWVudCB3aXRoIGdpdmVuIHNlbGVjdG9yLiIpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpbnN0YW5jZSA9IG5ldyBJbnRyb0pzKGRvY3VtZW50LmJvZHkpOwogICAgfSAvLyBhZGQgaW5zdGFuY2UgdG8gbGlzdCBvZiBfaW5zdGFuY2VzCiAgICAvLyBwYXNzaW5nIGdyb3VwIHRvIHN0YW1wIHRvIGluY3JlbWVudAogICAgLy8gZnJvbSAwIG9ud2FyZCBzb21ld2hhdCByZWxpYWJseQoKCiAgICBpbnRyb0pzLmluc3RhbmNlc1tzdGFtcChpbnN0YW5jZSwgImludHJvanMtaW5zdGFuY2UiKV0gPSBpbnN0YW5jZTsKICAgIHJldHVybiBpbnN0YW5jZTsKICB9OwogIC8qKgogICAqIEN1cnJlbnQgSW50cm9KcyB2ZXJzaW9uCiAgICoKICAgKiBAcHJvcGVydHkgdmVyc2lvbgogICAqIEB0eXBlIFN0cmluZwogICAqLwoKCiAgaW50cm9Kcy52ZXJzaW9uID0gdmVyc2lvbjsKICAvKioKICAgKiBrZXktdmFsIG9iamVjdCBoZWxwZXIgZm9yIGludHJvSnMgaW5zdGFuY2VzCiAgICoKICAgKiBAcHJvcGVydHkgaW5zdGFuY2VzCiAgICogQHR5cGUgT2JqZWN0CiAgICovCgogIGludHJvSnMuaW5zdGFuY2VzID0ge307IC8vUHJvdG90eXBlCgogIGludHJvSnMuZm4gPSBJbnRyb0pzLnByb3RvdHlwZSA9IHsKICAgIGNsb25lOiBmdW5jdGlvbiBjbG9uZSgpIHsKICAgICAgcmV0dXJuIG5ldyBJbnRyb0pzKHRoaXMpOwogICAgfSwKICAgIHNldE9wdGlvbjogZnVuY3Rpb24gc2V0T3B0aW9uKG9wdGlvbiwgdmFsdWUpIHsKICAgICAgdGhpcy5fb3B0aW9uc1tvcHRpb25dID0gdmFsdWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHNldE9wdGlvbnM6IGZ1bmN0aW9uIHNldE9wdGlvbnMob3B0aW9ucykgewogICAgICB0aGlzLl9vcHRpb25zID0gbWVyZ2VPcHRpb25zKHRoaXMuX29wdGlvbnMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBzdGFydDogZnVuY3Rpb24gc3RhcnQoZ3JvdXApIHsKICAgICAgaW50cm9Gb3JFbGVtZW50LmNhbGwodGhpcywgdGhpcy5fdGFyZ2V0RWxlbWVudCwgZ3JvdXApOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBnb1RvU3RlcDogZnVuY3Rpb24gZ29Ub1N0ZXAkMShzdGVwKSB7CiAgICAgIGdvVG9TdGVwLmNhbGwodGhpcywgc3RlcCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGFkZFN0ZXA6IGZ1bmN0aW9uIGFkZFN0ZXAob3B0aW9ucykgewogICAgICBpZiAoIXRoaXMuX29wdGlvbnMuc3RlcHMpIHsKICAgICAgICB0aGlzLl9vcHRpb25zLnN0ZXBzID0gW107CiAgICAgIH0KCiAgICAgIHRoaXMuX29wdGlvbnMuc3RlcHMucHVzaChvcHRpb25zKTsKCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGFkZFN0ZXBzOiBmdW5jdGlvbiBhZGRTdGVwcyhzdGVwcykgewogICAgICBpZiAoIXN0ZXBzLmxlbmd0aCkgcmV0dXJuOwoKICAgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IHN0ZXBzLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIHRoaXMuYWRkU3RlcChzdGVwc1tpbmRleF0pOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBnb1RvU3RlcE51bWJlcjogZnVuY3Rpb24gZ29Ub1N0ZXBOdW1iZXIkMShzdGVwKSB7CiAgICAgIGdvVG9TdGVwTnVtYmVyLmNhbGwodGhpcywgc3RlcCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIG5leHRTdGVwOiBmdW5jdGlvbiBuZXh0U3RlcCQxKCkgewogICAgICBuZXh0U3RlcC5jYWxsKHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBwcmV2aW91c1N0ZXA6IGZ1bmN0aW9uIHByZXZpb3VzU3RlcCQxKCkgewogICAgICBwcmV2aW91c1N0ZXAuY2FsbCh0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgY3VycmVudFN0ZXA6IGZ1bmN0aW9uIGN1cnJlbnRTdGVwJDEoKSB7CiAgICAgIHJldHVybiBjdXJyZW50U3RlcC5jYWxsKHRoaXMpOwogICAgfSwKICAgIGV4aXQ6IGZ1bmN0aW9uIGV4aXQoZm9yY2UpIHsKICAgICAgZXhpdEludHJvLmNhbGwodGhpcywgdGhpcy5fdGFyZ2V0RWxlbWVudCwgZm9yY2UpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoJDEoKSB7CiAgICAgIHJlZnJlc2guY2FsbCh0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgb25iZWZvcmVjaGFuZ2U6IGZ1bmN0aW9uIG9uYmVmb3JlY2hhbmdlKHByb3ZpZGVkQ2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwcm92aWRlZENhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhpcy5faW50cm9CZWZvcmVDaGFuZ2VDYWxsYmFjayA9IHByb3ZpZGVkQ2FsbGJhY2s7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQcm92aWRlZCBjYWxsYmFjayBmb3Igb25iZWZvcmVjaGFuZ2Ugd2FzIG5vdCBhIGZ1bmN0aW9uIik7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIG9uY2hhbmdlOiBmdW5jdGlvbiBvbmNoYW5nZShwcm92aWRlZENhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvdmlkZWRDYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMuX2ludHJvQ2hhbmdlQ2FsbGJhY2sgPSBwcm92aWRlZENhbGxiYWNrOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiUHJvdmlkZWQgY2FsbGJhY2sgZm9yIG9uY2hhbmdlIHdhcyBub3QgYSBmdW5jdGlvbi4iKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgb25hZnRlcmNoYW5nZTogZnVuY3Rpb24gb25hZnRlcmNoYW5nZShwcm92aWRlZENhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvdmlkZWRDYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMuX2ludHJvQWZ0ZXJDaGFuZ2VDYWxsYmFjayA9IHByb3ZpZGVkQ2FsbGJhY2s7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQcm92aWRlZCBjYWxsYmFjayBmb3Igb25hZnRlcmNoYW5nZSB3YXMgbm90IGEgZnVuY3Rpb24iKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgb25jb21wbGV0ZTogZnVuY3Rpb24gb25jb21wbGV0ZShwcm92aWRlZENhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvdmlkZWRDYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMuX2ludHJvQ29tcGxldGVDYWxsYmFjayA9IHByb3ZpZGVkQ2FsbGJhY2s7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQcm92aWRlZCBjYWxsYmFjayBmb3Igb25jb21wbGV0ZSB3YXMgbm90IGEgZnVuY3Rpb24uIik7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIG9uaGludHNhZGRlZDogZnVuY3Rpb24gb25oaW50c2FkZGVkKHByb3ZpZGVkQ2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwcm92aWRlZENhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhpcy5faGludHNBZGRlZENhbGxiYWNrID0gcHJvdmlkZWRDYWxsYmFjazsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlByb3ZpZGVkIGNhbGxiYWNrIGZvciBvbmhpbnRzYWRkZWQgd2FzIG5vdCBhIGZ1bmN0aW9uLiIpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBvbmhpbnRjbGljazogZnVuY3Rpb24gb25oaW50Y2xpY2socHJvdmlkZWRDYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHByb3ZpZGVkQ2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB0aGlzLl9oaW50Q2xpY2tDYWxsYmFjayA9IHByb3ZpZGVkQ2FsbGJhY2s7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQcm92aWRlZCBjYWxsYmFjayBmb3Igb25oaW50Y2xpY2sgd2FzIG5vdCBhIGZ1bmN0aW9uLiIpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBvbmhpbnRjbG9zZTogZnVuY3Rpb24gb25oaW50Y2xvc2UocHJvdmlkZWRDYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHByb3ZpZGVkQ2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB0aGlzLl9oaW50Q2xvc2VDYWxsYmFjayA9IHByb3ZpZGVkQ2FsbGJhY2s7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQcm92aWRlZCBjYWxsYmFjayBmb3Igb25oaW50Y2xvc2Ugd2FzIG5vdCBhIGZ1bmN0aW9uLiIpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBvbmV4aXQ6IGZ1bmN0aW9uIG9uZXhpdChwcm92aWRlZENhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvdmlkZWRDYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMuX2ludHJvRXhpdENhbGxiYWNrID0gcHJvdmlkZWRDYWxsYmFjazsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlByb3ZpZGVkIGNhbGxiYWNrIGZvciBvbmV4aXQgd2FzIG5vdCBhIGZ1bmN0aW9uLiIpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBvbnNraXA6IGZ1bmN0aW9uIG9uc2tpcChwcm92aWRlZENhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvdmlkZWRDYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMuX2ludHJvU2tpcENhbGxiYWNrID0gcHJvdmlkZWRDYWxsYmFjazsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlByb3ZpZGVkIGNhbGxiYWNrIGZvciBvbnNraXAgd2FzIG5vdCBhIGZ1bmN0aW9uLiIpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBvbmJlZm9yZWV4aXQ6IGZ1bmN0aW9uIG9uYmVmb3JlZXhpdChwcm92aWRlZENhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvdmlkZWRDYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMuX2ludHJvQmVmb3JlRXhpdENhbGxiYWNrID0gcHJvdmlkZWRDYWxsYmFjazsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlByb3ZpZGVkIGNhbGxiYWNrIGZvciBvbmJlZm9yZWV4aXQgd2FzIG5vdCBhIGZ1bmN0aW9uLiIpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBhZGRIaW50czogZnVuY3Rpb24gYWRkSGludHMoKSB7CiAgICAgIHBvcHVsYXRlSGludHMuY2FsbCh0aGlzLCB0aGlzLl90YXJnZXRFbGVtZW50KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgaGlkZUhpbnQ6IGZ1bmN0aW9uIGhpZGVIaW50JDEoc3RlcElkKSB7CiAgICAgIGhpZGVIaW50LmNhbGwodGhpcywgc3RlcElkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgaGlkZUhpbnRzOiBmdW5jdGlvbiBoaWRlSGludHMkMSgpIHsKICAgICAgaGlkZUhpbnRzLmNhbGwodGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHNob3dIaW50OiBmdW5jdGlvbiBzaG93SGludCQxKHN0ZXBJZCkgewogICAgICBzaG93SGludC5jYWxsKHRoaXMsIHN0ZXBJZCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHNob3dIaW50czogZnVuY3Rpb24gc2hvd0hpbnRzJDEoKSB7CiAgICAgIHNob3dIaW50cy5jYWxsKHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICByZW1vdmVIaW50czogZnVuY3Rpb24gcmVtb3ZlSGludHMkMSgpIHsKICAgICAgcmVtb3ZlSGludHMuY2FsbCh0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgcmVtb3ZlSGludDogZnVuY3Rpb24gcmVtb3ZlSGludCQxKHN0ZXBJZCkgewogICAgICByZW1vdmVIaW50KCkuY2FsbCh0aGlzLCBzdGVwSWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBzaG93SGludERpYWxvZzogZnVuY3Rpb24gc2hvd0hpbnREaWFsb2ckMShzdGVwSWQpIHsKICAgICAgc2hvd0hpbnREaWFsb2cuY2FsbCh0aGlzLCBzdGVwSWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9OwogIHJldHVybiBpbnRyb0pzOwp9KTs="},null]}