{"remainingRequest":"/home/vimalesh/CENSE/chatbot-portal/node_modules/thread-loader/dist/cjs.js!/home/vimalesh/CENSE/chatbot-portal/node_modules/babel-loader/lib/index.js!/home/vimalesh/CENSE/chatbot-portal/node_modules/cache-loader/dist/cjs.js??ref--0-0!/home/vimalesh/CENSE/chatbot-portal/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/vimalesh/CENSE/chatbot-portal/src/portal/Chatbot/Dashboard/Data Inputs/ResponseBot.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/vimalesh/CENSE/chatbot-portal/src/portal/Chatbot/Dashboard/Data Inputs/ResponseBot.vue","mtime":1645594423487},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuY29uY2F0IjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZmlsdGVyIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZm9yLWVhY2giOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5pbmNsdWRlcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmluZGV4LW9mIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuam9pbiI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5Lmxhc3QtaW5kZXgtb2YiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5tYXAiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5yZWR1Y2UiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5zbGljZSI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNwbGljZSI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmZ1bmN0aW9uLm5hbWUiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5tYXAiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3Qua2V5cyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC50by1zdHJpbmciOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QudmFsdWVzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMucmVnZXhwLmV4ZWMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5yZWdleHAudG8tc3RyaW5nIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLmluY2x1ZGVzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLml0ZXJhdG9yIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLm1hdGNoIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnJlcGxhY2UiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuc3BsaXQiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcudHJpbSI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuZm9yLWVhY2giOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLml0ZXJhdG9yIjsKaW1wb3J0IF9zbGljZWRUb0FycmF5IGZyb20gIi9ob21lL3ZpbWFsZXNoL0NFTlNFL2NoYXRib3QtcG9ydGFsL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9zbGljZWRUb0FycmF5IjsKaW1wb3J0ICJyZWdlbmVyYXRvci1ydW50aW1lL3J1bnRpbWUiOwppbXBvcnQgX2FzeW5jVG9HZW5lcmF0b3IgZnJvbSAiL2hvbWUvdmltYWxlc2gvQ0VOU0UvY2hhdGJvdC1wb3J0YWwvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2FzeW5jVG9HZW5lcmF0b3IiOwppbXBvcnQgX2RlZmluZVByb3BlcnR5IGZyb20gIi9ob21lL3ZpbWFsZXNoL0NFTlNFL2NoYXRib3QtcG9ydGFsL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9kZWZpbmVQcm9wZXJ0eSI7Cgp2YXIgX25hbWUkY29tcG9uZW50cyRtaXhpOwoKLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KaW1wb3J0IGF4aW9zIGZyb20gImF4aW9zIjsKaW1wb3J0IGFwaV9jYWxscyBmcm9tICJAL3BvcnRhbC9hcGlfY2FsbHMiOwppbXBvcnQgZmluZ2VycHJpbnQgZnJvbSAiQC9wb3J0YWwvY29tcG9uZW50cy9maW5nZXJwcmludCI7CmltcG9ydCB7IGJ1cyB9IGZyb20gIkAvcG9ydGFsL21haW4iOwppbXBvcnQgeyBzZXRUaW1lb3V0IH0gZnJvbSAidGltZXJzIjsKaW1wb3J0IE11bHRpc2VsZWN0IGZyb20gInZ1ZS1tdWx0aXNlbGVjdCI7CmltcG9ydCBWaWRlb1ZpZXdlciBmcm9tICJAL3BvcnRhbC9jb21wb25lbnRzL1Jlc3BvbnNlIEJvdC9WaWRlb1ZpZXdlci52dWUiOwppbXBvcnQgZGVib3VuY2UgZnJvbSAidnVlLWRlYm91bmNlL2Rpc3QvZGVib3VuY2UubWluLmpzIjsgLy8gaW1wb3J0IHsgU29ja2V0IH0gZnJvbSAicGhvZW5peC1zb2NrZXQiOwoKaW1wb3J0IHsgU29ja2V0LCBQcmVzZW5jZSB9IGZyb20gInBob2VuaXgiOwppbXBvcnQgU3RhclJhdGluZyBmcm9tICd2dWUtc3Rhci1yYXRpbmcnOwppbXBvcnQgeyB2b2ljZXJlY29yZGVyLCBzdGFydF92b2ljZV9jb21tdW5pY2F0aW9uLCBmb3JlaWdueGNoYW5nZV9jdXN0b20sIGdlbmVyYXRlX3RpbWUgfSBmcm9tICJAL3BvcnRhbC9taXhpbnMiOwppbXBvcnQgbW9tZW50IGZyb20gIm1vbWVudCI7CmltcG9ydCBzd2FsIGZyb20gInN3ZWV0YWxlcnQyIjsKaW1wb3J0IENlbnNlQ2FydCBmcm9tICcuL0NlbnNlQ2FydC52dWUnOwppbXBvcnQgVnVlTnVtZXJpY0lucHV0IGZyb20gJ3Z1ZS1udW1lcmljLWlucHV0JzsKaW1wb3J0IHNvdW5kIGZyb20gIkAvcG9ydGFsL2Fzc2V0cy9hdWRpby9taXhraXQtYWRkLXRvLWNhcnQud2F2IjsKaW1wb3J0ICJAL3BvcnRhbC9hc3NldHMvanMvc2hvcGlmeS5taW4uanMiOwpleHBvcnQgZGVmYXVsdCAoX25hbWUkY29tcG9uZW50cyRtaXhpID0gewogIG5hbWU6ICJyZXNwb25zZS1ib3QiLAogIGNvbXBvbmVudHM6IHsKICAgIE11bHRpc2VsZWN0OiBNdWx0aXNlbGVjdCwKICAgIFZpZGVvVmlld2VyOiBWaWRlb1ZpZXdlciwKICAgIFN0YXJSYXRpbmc6IFN0YXJSYXRpbmcsCiAgICBDZW5zZUNhcnQ6IENlbnNlQ2FydCwKICAgIFZ1ZU51bWVyaWNJbnB1dDogVnVlTnVtZXJpY0lucHV0CiAgfSwKICBtaXhpbnM6IFt2b2ljZXJlY29yZGVyLCBzdGFydF92b2ljZV9jb21tdW5pY2F0aW9uLCBmb3JlaWdueGNoYW5nZV9jdXN0b20sIGdlbmVyYXRlX3RpbWVdLAogIGRhdGE6IGZ1bmN0aW9uIGRhdGEoKSB7CiAgICByZXR1cm4gewogICAgICBjb21wYW55aWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkLAogICAgICBjb21wYW55bmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZSwKICAgICAgcG9wdXBfbXNnOiAiWW91IGNhbiB0eXBlIOKAmFJlc3RhcnTigJ0gIGF0IDwvYnI+YW55ICB0aW1lIHRvIGdldCBiYWNrPC9icj4gdG8gdGhlIE1haW4gTWVudSIsCiAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRydWUsCiAgICAgIHF1c19hbnM6ICJhbnN3ZXJzIiwKICAgICAgdG9fc2VuZDogIiIsCiAgICAgIGNlbnNlX2VucXVpcnk6IGZhbHNlLAogICAgICBpc19hZ2VudF90eXBpbmc6IGZhbHNlLAogICAgICB1c2VyX25hbWU6ICIiLAogICAgICBzaG93OiBmYWxzZSwKICAgICAgY2hhdDogW10sCiAgICAgIGZpbmdlcnByaW50OiBudWxsLAogICAgICBib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJCb3RUb2tlbiIpLAogICAgICBsZXZlbDogMCwKICAgICAgcmVjb2duaXRpb246IG51bGwsCiAgICAgIGpzb25fZGF0YTogewogICAgICAgIGNyZWF0ZV9hcHBvaW50bWVudDogJ3siVXNlciI6IHsiUGh5c2ljaWFuIjogeyJJRCI6ICJEVDAwMDAwMDAwMDAwMDAwMDIzNyJ9LCJVc2VyTmFtZSI6ImFjIiwiSUQiOiJVUzAwMDAwMDAwMDAwMDAwMDEzOCIsIkFjY291bnQiOiB7IklEIjogIkNPMDAwMjMifSwiVG9rZW4iOiAiWjFyU0dHbTBYcE1XanQzZ2lBRXJQUFdaODRUUU45RnNGTUJMc1UrL0xBdTZ5dWFsTWc2RVAyYnNyd1pqTFB3bTNqNERwUGNHYzVMY0lwM05qZ2ZVc0E9PSIsIlNwZWNpYWx0eSI6IHsiSUQiOiAiUEcwMDAwMDAwMDAwMDAwMDAxNDEiLCAiTmFtZSI6ICJBQyIsICJDb2RlIjogIkFDIn0sIkRvbWFpbiI6ICJnb2dyZWVuYmlsbHMuY29tIn0sIkFwcG9pbnRtZW50IjogeyJEYXRlIjogIjA4LzMwLzIwMTgiLCAiSXNKU09OTm90ZSI6IDAsICJQYXRpZW50IjogeyJDYXNlSUQiOiAiIn19fScsCiAgICAgICAgdmlzaXRzX2ZpbmFsaXplZDogJ3siVXNlciI6IHsiUGh5c2ljaWFuIjogeyJJRCI6ICJEVDAwMDAwMDAwMDAwMDAxMTg4NiJ9LCJVc2VyTmFtZSI6ICJjaCIsIklEIjogIlVTMDAwMDAwMDAwMDAwMDAwMTQzIiwiQWNjb3VudCI6eyJJRCI6IkNPMDAwMjMifSwiVG9rZW4iOiJleUowZVhBaU9pSktWMVFpTENKaGJHY2lPaUpJVXpJMU5pSjkuZXlKMWMyVnlJam9pWVhaa2FIVjBJaXdpWlhod0lqb3hOVEk1TkRneU5qWXpmUS52MWMwSGJ1V3VaWFhwSmZEclhWYzFIUFZ1ZmZibkdjTHFrcGcwem02QW9RIiwiU3BlY2lhbHR5IjogeyJJRCI6ICJQRzAwMDAwMDAwMDAwMDAwMDE0MiIsIkNvZGUiOiAiY2gifSwiRG9tYWluIjogImdyZWVueW91cmJpbGxzLmNvbSJ9LCJTZWFyY2hQYXJhbWV0ZXJzIjogeyJTdGF0dXMiOiAiIiwiT3JkZXJCeSI6ICIiLCJGcm9tRGF0ZSI6ICIwMS8wMS8yMDE4IiwiQ291bnQiOiAiMTAiLCJTZWFyY2hUZXh0IjogIiIsIlR5cGVPZlZpc2l0IjogIkFMTCIsIlNvcnRPcmRlciI6ICJhcHBvaW50bWVudCIsIlN0YXJ0SW5kZXgiOiAiMSIsIkVuZEluZGV4IjogIjEwIiwiVG9EYXRlIjogIjA4LzA2LzIwMTgifX0nLAogICAgICAgIGFwcG9pbnRtZW50c19jb3VudDogJ3siVXNlciI6IHsiUGh5c2ljaWFuIjogeyJJRCI6ICJEVDAwMDAwMDAwMDAwMDAxMTg4NiJ9LCJVc2VyTmFtZSI6ICJjaCIsIklEIjogIlVTMDAwMDAwMDAwMDAwMDAwMTQzIiwiQWNjb3VudCI6eyJJRCI6IkNPMDAwMjMifSwiVG9rZW4iOiJleUowZVhBaU9pSktWMVFpTENKaGJHY2lPaUpJVXpJMU5pSjkuZXlKMWMyVnlJam9pWVhaa2FIVjBJaXdpWlhod0lqb3hOVEk1TkRneU5qWXpmUS52MWMwSGJ1V3VaWFhwSmZEclhWYzFIUFZ1ZmZibkdjTHFrcGcwem02QW9RIiwiU3BlY2lhbHR5IjogeyJJRCI6ICJQRzAwMDAwMDAwMDAwMDAwMDE0MiIsIkNvZGUiOiAiY2gifSwiRG9tYWluIjogImdyZWVueW91cmJpbGxzLmNvbSJ9LCJTZWFyY2hQYXJhbWV0ZXJzIjogeyJTdGF0dXMiOiAiIiwiT3JkZXJCeSI6ICIiLCJGcm9tRGF0ZSI6ICIwMS8wMS8yMDE4IiwiQ291bnQiOiAiMTAiLCJTZWFyY2hUZXh0IjogIiIsIlR5cGVPZlZpc2l0IjogIkFMTCIsIlNvcnRPcmRlciI6ICJhcHBvaW50bWVudCIsIlN0YXJ0SW5kZXgiOiAiMSIsIkVuZEluZGV4IjogIjEwIiwiVG9EYXRlIjogIjA4LzA2LzIwMTgifX0nLAogICAgICAgIGNyZWF0ZV90aWNrZXQ6ICd7IkFjY291bnROYW1lIjpudWxsLCJDYWxsYmFja1Bob25lIjoiIiwiQ29tcGFueUlEIjoiQ08wMDAyMyIsIkRlc2NyaXB0aW9uIjoiRGUiLCJEb21haW5OYW1lIjpudWxsLCJFbWFpbENDIjoiYWJoYXkud0Bjb2RlYXJyYXkudGVjaCIsIkVtYWlsRGVmYXVsdCI6Im1hbmlzaC55QGNvZGVhcnJheS50ZWNoIiwiUHJpb3JpdHkiOiIzIiwiUHJpb3JpdHlJRCI6MCwiUmFpc2VkQnkiOiJsYXd1c2VyIiwiU3RhdHVzIjowLCJTdGF0dXNDb2RlIjpudWxsLCJTdGF0dXNUZXh0IjpudWxsLCJTVHlwZSI6IldQIiwiU3ViamVjdCI6IkRlIiwiU3ViVHlwZSI6IlNBTUQtUCIsIlRpY2tldElEIjowLCJUaWNrZXROdW1iZXIiOm51bGwsIlR5cGUiOjAsIlR5cGVUZXh0IjoiV2Vic2l0ZSBQcm9ibGVtIiwibGlzdEZpbGVzMSI6WyJjaHExLnBkZiJdfScsCiAgICAgICAgZ2V0X3JlcG9ydDogJ3siY29tcGFueUlkIjogIkNPMDAwMjMifScKICAgICAgfSwKICAgICAgc3RvcDogdHJ1ZSwKICAgICAgZGVtb3VybGJpbmQ6IGZhbHNlLAogICAgICByZXZpZXdzdXJsYmluZDogZmFsc2UsCiAgICAgIHJldmlld3N1cmw6ICJodHRwczovL3d3dy55b3V0dWJlLmNvbS9lbWJlZC9wYUFlVzg2ZVFaNCIsCiAgICAgIGRlbW91cmw6IFsiaHR0cHM6Ly93d3cueW91dHViZS5jb20vZW1iZWQvdmlkZW9zZXJpZXM/S2NySm05VXhXM3MmaW5kZXg9MTMmbGlzdD1QTF9qWGxpaDhkZ2tURThDclBwaVdjQTlLeFFlS0haQW50JnQ9MHMiLCAiaHR0cHM6Ly93d3cueW91dHViZS5jb20vZW1iZWQvdmlkZW9zZXJpZXM/cXpTMnFJTkk2SU0mbGlzdD1QTF9qWGxpaDhkZ2tSdTVkZEdYQUdxWjR1TExrb0p6Q2o4JmluZGV4PTIiXSwKICAgICAgY2hhdF93aWRnZXQ6IHsKICAgICAgICBsb2dvOiAiIiwKICAgICAgICB0aXRsZTogIiIsCiAgICAgICAgc3R5bGU6ICIiLAogICAgICAgIGJvdF90aGVtZTogIiIsCiAgICAgICAgYnV0dG9uX2JvcmRlcl90aGVtZTogIiMyNzM2NzkiLAogICAgICAgIHVzZXJfbXNnX2ZvbnRfY29sb3I6ICIjMjczNjc5IiwKICAgICAgICBib3RfcmVzcG9uc2VfZm9udF9jb2xvcjogIiMyNzM2NzkiLAogICAgICAgIGJ1dHRvbl90aGVtZTogIiIsCiAgICAgICAgYnV0dG9uX2FsaWdubWVudDogIiIsCiAgICAgICAgYm90X2ljb246ICIiLAogICAgICAgIGJvdF9iYWNrZ3JvdW5kX2ltYWdlOiAiIiwKICAgICAgICBidXR0b25faG9yaXpvbnRhbF9zcGFjaW5nOiAiMyIsCiAgICAgICAgYnV0dG9uX3ZlcnRpY2FsX3NwYWNpbmc6ICI1IiwKICAgICAgICBoZWFkZXJfYmFja2dyb3VuZDogIiIsCiAgICAgICAgYm90X2ZvbnRfc3R5bGU6ICIiLAogICAgICAgIGJvdF9mb250X2NvbG9yX3NlbmRlcjogIiIsCiAgICAgICAgYm90X2ZvbnRfY29sb3JfcmVjZWl2ZXI6ICIiLAogICAgICAgIGJvdF9mb250X2NvbG9yX2J1dHRvbnM6ICIiLAogICAgICAgIGlzX3Bvd2VyZWRfYnlfY2Vuc2U6IHRydWUKICAgICAgfSwKICAgICAgc2VsZWN0ZWRfZGF0ZTogIiIsCiAgICAgIHNlbGVjdGVkX3RpbWU6ICIiLAogICAgICByZWFzb25fb2ZfdmlzaXQ6ICIiLAogICAgICBwYXRpZW50X25hbWU6ICIiLAogICAgICB2aXNpdG9yX251bWJlcjogIiIsCiAgICAgIGZ1bGxfdGltZV9zbG90czogW10sCiAgICAgIHRpbWVfc2xvdHM6IFtdLAogICAgICBUT0RBWV9EQVRFOiAiIiwKICAgICAgY2hhbm5lbDogbnVsbCwKICAgICAgY2hhdF9zb2NrZXQ6IG51bGwsCiAgICAgIHZvaWNlX3NvY2tldDogbnVsbCwKICAgICAgbGl2ZV9jaGF0X29uOiBmYWxzZSwKICAgICAgbGl2ZV9jaGF0X3Rva2VuOiBudWxsLAogICAgICBjaGF0X2dyb3VwX25hbWU6IG51bGwsCiAgICAgIHRvX3Njcm9sbDogZmFsc2UsCiAgICAgIGZvcm1fcGF5bG9hZDogbnVsbCwKICAgICAgcGhvbmVfbnVtYmVyX3ZhbGlkaXR5OiAvWzAtOV17MTAsMTF9JC8sCiAgICAgIC8vIHVybF9tYXRjaF9yZWdleDogL1xiKGh0dHBzP3xmdHApOlwvXC8oW1xTXSkrXC4oKHBkZnxjc3Z8eGxzeCkpKFtcdz89XSspL2csCiAgICAgIHVybF9tYXRjaF9yZWdleDogL15odHRwcz86XC9cLy4qW1xcXC9dLitcLlsocGRmfGNzdnx4bHN4KV17Miw0fS8sCiAgICAgIC8vIGhhcnNoCiAgICAgIGlzZXhjaGFuZ2U6IGZhbHNlLAogICAgICBpc3JldGFpbGlnZW5jZTogZmFsc2UsCiAgICAgIGN1cnJlbmN5ZXhjaGFuZ2VfbGlzdDogbnVsbCwKICAgICAgc2VsZWN0ZWRfaW5kaWNhdGlvbjogW10sCiAgICAgIHdlbGNvbWVfbWVzc2FnZV9ub3RfeWV0X3JlY2VpdmVkOiB0cnVlLAogICAgICByZXM6IHt9LAogICAgICBpc190eXBpbmdfaW5kaWNhdG9yX29uOiBmYWxzZSwKICAgICAgdGh1bWJzX3VwX2ljb246IHJlcXVpcmUoIkAvcG9ydGFsL2Fzc2V0cy9pbWcvR3JvdXAgNy5zdmciKSwKICAgICAgdGh1bWJzX2Rvd25faWNvbjogcmVxdWlyZSgiQC9wb3J0YWwvYXNzZXRzL2ltZy9Hcm91cCA2LnN2ZyIpLAogICAgICBzaG9waWZ5X3VpOiBudWxsLAogICAgICBzaG9waWZ5X2N1c3RvbWVyX2lkOiBudWxsLAogICAgICAvLyByZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzOiB7fSwKICAgICAgLy8gcmVmdW5kX3NlbGVjdGVkX2l0ZW1zOiBbXSwKICAgICAgc2hvcGlmeV9yZXRhaWxfc2hvcF9uYW1lOiBudWxsLAogICAgICBzaG9wX3VybDogbnVsbCwKICAgICAgaXNfcmV0YWlsX2JvdDogZmFsc2UsCiAgICAgIHNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmQ6IG51bGwsCiAgICAgIHNob3dfc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZF9lcnJvcjogZmFsc2UsCiAgICAgIHN1cHBvcnRfY2hhbm5lbDogbnVsbCwKICAgICAgaXNfc3VwcG9ydF9hZ2VudF9wcmVzZW50OiBmYWxzZSwKICAgICAgcmV0YWlsX3Nob3Bfc3RvcmVmcm9udF90b2tlbjogbnVsbCwKICAgICAgcmV0YWlsX29yZGVyX3JldHJlaXZhbF9vbmx5X2VtYWlsX3JlcXVpcmVkOiBmYWxzZSwKICAgICAgcmV0YWlsX3Nob3BfY3VycmVuY3k6IG51bGwsCiAgICAgIHByb2R1Y3RfbGlzdDogW10sCiAgICAgIHByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3Q6IFtdLAogICAgICBjaGVja2VkX2xpc3Q6IFtdLAogICAgICBjdXJyZW50X3Byb2R1Y3Q6ICIiLAogICAgICBjdXN0b21lcl9lbWFpbDogIiIsCiAgICAgIGlzX3NlbmRlcl9lbWFpbDogZmFsc2UsCiAgICAgIHJlZ19lbWFpbDogL14oWzAtOWEtekEtWl0oWy0uXHddKlswLTlhLXpBLVpdKSpAKFswLTlhLXpBLVpdWy1cd10qWzAtOWEtekEtWl1cLikrW2EtekEtWl17Miw5fSkkLywKICAgICAgc2Nyb2xsUG9zaXRpb246IDAsCiAgICAgIHZpc2libGVfY3VzdG9tX2dyZWV0aW5nc19idXR0b206IGZhbHNlLAogICAgICByZXZpZXdfbWVzc2FnZV9maXJzdDogJycsCiAgICAgIHJldmlld19tZXNzYWdlX3NlY29uZDogJycsCiAgICAgIHJldmlld19yZXNwb25zZV9tZXNzYWdlOiAnJywKICAgICAgZGlzcGxheV9wcm9kdWN0czogZmFsc2UsCiAgICAgIHJldGFpbF93ZWJfZnJhbWV3b3JrOiAiIiwKICAgICAgaXNfY2Vuc2VfY2FydDogZmFsc2UsCiAgICAgIHNob3dfY3VzdG9tX2NhcnQ6IGZhbHNlLAogICAgICBhZGR0b0NhcnRkYXRhOiBbXSwKICAgICAgdG90YWxfcHJvZHVjdHNfcXR5OiAwLAogICAgICBvdmVyX3F0eV93YXJuaW5nOiBmYWxzZSwKICAgICAgY29udGFjdF9oZWxwX2VtYWlsOiBudWxsLAogICAgICBzaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX2xpc3Q6IG51bGwsCiAgICAgIHNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmRfb3B0aW9uOiBbJ09yZGVyZWQgYnkgbWlzdGFrZScsICdPcmRlcmVkIHdyb25nIHByb2R1Y3QnLCAnT3JkZXIgbm90IFJlY2VpdmVkJywgJ05vIGxvbmdlciBuZWVkZWQnLCAnQmV0dGVyIHByaWNlIGF2YWlsYWJsZScsICdSZWNlaXZlZCBkYW1hZ2VkIHByb2R1Y3RzJywgJ090aGVycyddLAogICAgICBvcmRlcl9ub3Rlc19kYXRhOiBbXSwKICAgICAgc2VsZWN0ZWRfb3JkZXJfbmFtZTogIiIsCiAgICAgIGlzX3dvb2NvbW1lcmNlX29yZGVyOiBmYWxzZSwKICAgICAgdmlzaXRvcnNfY3VycmVudF9sb2NhdGlvbjogbnVsbCwKICAgICAgaXNfZGlzcGxheV9iYW5uZXJfb25fbGFuZGluZzogZmFsc2UsCiAgICAgIHZpc2l0b3JzX2N1cnJlbnRfbG9jYXRpb25fdXJsOiAiaHR0cHM6Ly9pcGdlb2xvY2F0aW9uLmFic3RyYWN0YXBpLmNvbS92MS8/YXBpX2tleT0iLmNvbmNhdChwcm9jZXNzLmVudi5WVUVfQVBQX0NVUlJFTlRfTE9DQVRJT05fVE9LRU4pLAogICAgICBncmVldGluZ19idXR0b25zX3Bvc2l0aW9uOiBudWxsCiAgICB9OwogIH0sCiAgcHJvcHM6IHsKICAgIGlzUHJldmlld0JvdDogQm9vbGVhbiwKICAgIGlzRGlhbG9nQm90OiBCb29sZWFuLAogICAgY3VycmVudF9wcmV2aWV3X2Jhbm5lcl9pZDogU3RyaW5nLAogICAgaXNUZXh0VG9Cb3Q6IHsKICAgICAgdHlwZTogQm9vbGVhbiwKICAgICAgZGVmYXVsdDogdHJ1ZQogICAgfSwKICAgIGlzQ2FsbGVkRnJvbVNldHVwOiB7CiAgICAgIHR5cGU6IEJvb2xlYW4sCiAgICAgIGRlZmF1bHQ6IGZhbHNlCiAgICB9CiAgfSwKICBjb21wdXRlZDogewogICAgY3VzdG9tX2dyZWV0aW5nc19idXR0b21fYWxpZ25tZW50OiBmdW5jdGlvbiBjdXN0b21fZ3JlZXRpbmdzX2J1dHRvbV9hbGlnbm1lbnQoKSB7CiAgICAgIGlmICh0aGlzLmlzX3JldGFpbF9ib3QpIHsKICAgICAgICByZXR1cm4gImNvbC1zbS0xMCBweC0wIjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gImNvbC1zbS0xMiBweC0wIjsKICAgICAgfQogICAgfSwKICAgIGNhcnRfYnV0dG9uX2FsaWdubWVudDogZnVuY3Rpb24gY2FydF9idXR0b25fYWxpZ25tZW50KCkgewogICAgICBpZiAodGhpcy5pc19yZXRhaWxfYm90KSB7CiAgICAgICAgcmV0dXJuICJjb2wtc20tMiBweC0wIjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfSwKICAgIGlucHV0X2Rpc2FibGVkOiBmdW5jdGlvbiBpbnB1dF9kaXNhYmxlZCgpIHsKICAgICAgcmV0dXJuIHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCB8fCB0aGlzLndlbGNvbWVfbWVzc2FnZV9ub3RfeWV0X3JlY2VpdmVkOwogICAgfSwKICAgIGNzc1Byb3BzOiBmdW5jdGlvbiBjc3NQcm9wcygpIHsKICAgICAgdmFyIGJvdEF0dHJpYnV0ZXMgPSB7CiAgICAgICAgaGVhZF9jb2xvcjogdGhpcy5jaGF0X3dpZGdldC5oZWFkZXJfYmFja2dyb3VuZAogICAgICB9OwoKICAgICAgaWYgKHRoaXMuY29tcGFueWlkID09PSAicmV0YWlsaWdlbmNlODQ5MjYiKSB7CiAgICAgICAgYm90QXR0cmlidXRlcy5oZWFkX2NvbG9yID0gdGhpcy5jaGF0X3dpZGdldC5ib3RfdGhlbWU7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc2V4Y2hhbmdlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICItLWJvdC1oZWFkLWNvbG9yIjogIiNmZmYiLAogICAgICAgICAgIi0tYm90LXNlbmRlci1jb2xvciI6ICIjMmIzMTg0IiwKICAgICAgICAgICItLWJvdC1idXR0b24tY29sb3IiOiAiI2ZkY2YzOCIsCiAgICAgICAgICAiLS1ib3QtbGluay1jb2xvciI6ICIjMmIzMTg0IiwKICAgICAgICAgICItLWJvdC1idXR0b24tYm9yZGVyIjogIiMyNzM2NzkiLAogICAgICAgICAgIi0tdXNlcl9tc2dfZm9udF9jb2xvciI6ICIjMjczNjc5IiwKICAgICAgICAgICItLWJvdC1yZXNwb25zZS1mb250LWNvbG9yIjogIiMyNzM2NzkiLAogICAgICAgICAgIi0tYm90LWJ1dHRvbi1iYWNrZ3JvdW5kIjogIiMxZGFhZTEiLAogICAgICAgICAgIi0tYm90LWJ1dHRvbnMtYWxpZ25tZW50IjogImNlbnRlciIsCiAgICAgICAgICAiLS1ib3QtYnV0dG9ucy12ZXJ0aWNhbC1zcGFjaW5nIjogIjUlIiwKICAgICAgICAgICItLWJvdC1idXR0b25zLWhvcml6b250YWwtc3BhY2luZyI6ICIzJSIKICAgICAgICB9OwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgICItLWJvdC1oZWFkLWNvbG9yIjogYm90QXR0cmlidXRlcy5oZWFkX2NvbG9yLAogICAgICAgICItLWJvdC1zZW5kZXItY29sb3IiOiB0aGlzLmNoYXRfd2lkZ2V0LmJvdF90aGVtZSwKICAgICAgICAiLS1ib3QtYnV0dG9uLWNvbG9yIjogdGhpcy5jaGF0X3dpZGdldC5ib3RfdGhlbWUsCiAgICAgICAgIi0tYm90LWxpbmstY29sb3IiOiB0aGlzLmNoYXRfd2lkZ2V0LmJvdF90aGVtZSwKICAgICAgICAiLS1ib3QtYnV0dG9uLWJvcmRlciI6IHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX2JvcmRlcl90aGVtZSwKICAgICAgICAiLS11c2VyX21zZ19mb250X2NvbG9yIjogdGhpcy5jaGF0X3dpZGdldC51c2VyX21zZ19mb250X2NvbG9yLAogICAgICAgICItLWJvdC1yZXNwb25zZS1mb250LWNvbG9yIjogdGhpcy5jaGF0X3dpZGdldC5ib3RfcmVzcG9uc2VfZm9udF9jb2xvciwKICAgICAgICAiLS1ib3QtYnV0dG9uLWJhY2tncm91bmQiOiB0aGlzLmNoYXRfd2lkZ2V0LmJ1dHRvbl90aGVtZSwKICAgICAgICAiLS1ib3QtYnV0dG9ucy1hbGlnbm1lbnQiOiB0aGlzLmNoYXRfd2lkZ2V0LmJ1dHRvbl9hbGlnbm1lbnQudmFsdWUsCiAgICAgICAgIi0tYm90LWJ1dHRvbnMtdmVydGljYWwtc3BhY2luZyI6ICIiLmNvbmNhdCh0aGlzLmNoYXRfd2lkZ2V0LmJ1dHRvbl92ZXJ0aWNhbF9zcGFjaW5nLCAiJSIpLAogICAgICAgICItLWJvdC1idXR0b25zLWhvcml6b250YWwtc3BhY2luZyI6ICIiLmNvbmNhdCh0aGlzLmNoYXRfd2lkZ2V0LmJ1dHRvbl9ob3Jpem9udGFsX3NwYWNpbmcsICIlIiksCiAgICAgICAgIi0tYm90LWZvbnQtc3R5bGUiOiB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9mb250X3N0eWxlLnZhbHVlLAogICAgICAgICItLWJvdC1mb250LWNvbG9yLXNlbmRlciI6IHRoaXMuY2hhdF93aWRnZXQuYm90X2ZvbnRfY29sb3Jfc2VuZGVyLAogICAgICAgICItLWJvdC1mb250LWNvbG9yLXJlY2VpdmVyIjogdGhpcy5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9yZWNlaXZlciwKICAgICAgICAiLS1ib3QtZm9udC1jb2xvci1idXR0b25zIjogdGhpcy5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9idXR0b25zCiAgICAgIH07CiAgICB9LAogICAgYm90X2ltZ19pY29uOiBmdW5jdGlvbiBib3RfaW1nX2ljb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgImJhY2tncm91bmQtaW1hZ2UiOiAidXJsKCIuY29uY2F0KHRoaXMuY2hhdF93aWRnZXQuYm90X2ljb24sICIpIikKICAgICAgfTsKICAgIH0sCiAgICBjaGF0X2JvdF9iYWNrZ3JvdW5kX2ltYWdlOiBmdW5jdGlvbiBjaGF0X2JvdF9iYWNrZ3JvdW5kX2ltYWdlKCkgewogICAgICByZXR1cm4gewogICAgICAgICJiYWNrZ3JvdW5kLWltYWdlIjogInVybCgiLmNvbmNhdCh0aGlzLmNoYXRfd2lkZ2V0LmJvdF9iYWNrZ3JvdW5kX2ltYWdlLCAiKSIpCiAgICAgIH07CiAgICB9LAogICAgc2hvcGlmeV9sb2dpbl9idXR0b25fdGV4dDogZnVuY3Rpb24gc2hvcGlmeV9sb2dpbl9idXR0b25fdGV4dCgpIHsKICAgICAgaWYgKHRoaXMucmV0YWlsX29yZGVyX3JldHJlaXZhbF9vbmx5X2VtYWlsX3JlcXVpcmVkKSB7CiAgICAgICAgcmV0dXJuICJHbyI7CiAgICAgIH0KCiAgICAgIHJldHVybiAiTG9naW4iOwogICAgfSwKICAgIGNhcnRfaWNvbl9zdmc6IGZ1bmN0aW9uIGNhcnRfaWNvbl9zdmcoKSB7CiAgICAgIHJldHVybiAiPHN2ZyB4bWxucz1cImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnXCIgdmVyc2lvbj1cIjEuMFwiIHdpZHRoPVwiMTguMDAwMDAwcHRcIiBoZWlnaHQ9XCIxOC4wMDAwMDBwdFwiIHZpZXdCb3g9XCIwIDAgNTEyLjAwMDAwMCA1MTIuMDAwMDAwXCIgcHJlc2VydmVBc3BlY3RSYXRpbz1cInhNaWRZTWlkIG1lZXRcIj48ZyB0cmFuc2Zvcm09XCJ0cmFuc2xhdGUoMC4wMDAwMDAsNTEyLjAwMDAwMCkgc2NhbGUoMC4xMDAwMDAsLTAuMTAwMDAwKVwiIGZpbGw9XCIiLmNvbmNhdCh0aGlzLmNoYXRfd2lkZ2V0LmJvdF9mb250X2NvbG9yX2J1dHRvbnMsICJcIiBzdHJva2U9XCJub25lXCI+PHBhdGggZD1cIk04MSA1MDAyIGMtMTAwIC01MCAtMTA2IC0xODYgLTEyIC0yNDkgMzMgLTIzIDM5IC0yMyAzMTcgLTIzIGwyODQgMCA1IC0yMiBjMyAtMTMgMTcyIC03NDUgMzc1IC0xNjI4IDI3OSAtMTIwOSAzNzYgLTE2MTIgMzkyIC0xNjM2IDQ3IC02OSAtNzIgLTY0IDE1OTkgLTY0IDEzNjcgMCAxNTE0IDIgMTU0NSAxNiAzNyAxOCA2OCA2MiA3OSAxMTEgOSA0NSAtMjQgMTE3IC02NyAxNDMgLTMzIDIwIC00NSAyMCAtMTQ3NSAyMCAtMTM2NCAwIC0xNDQyIDEgLTE0NDcgMTggLTEyIDM3IC0xMDYgNDU0IC0xMDYgNDY4IDAgMTIgMjA2IDE0IDE1MDMgMTQgMTQ3MiAwIDE1MDMgMCAxNTM0IDIwIDE4IDEwIDM5IDMzIDQ4IDUwIDI2IDUwIDQ2OCAyMDMwIDQ2MSAyMDY4IC03IDQ0IC0zOSA4NiAtODAgMTA2IC0zMSAxNSAtMjA4IDE2IC0yMDE0IDE2IGwtMTk4MCAwIC0yNyAxMTggYy03MyAzMTkgLTk0IDM5NSAtMTE3IDQxOSAtNDkgNTMgLTUxIDUzIC00MzAgNTMgLTMxNiAwIC0zNTcgLTIgLTM4NyAtMTh6IG00NzAyIC04NjkgYzIgLTUgLTgxIC0zODEgLTE4NCAtODM4IC0xMDQgLTQ1NiAtMTg4IC04MzEgLTE4OSAtODMzIDAgLTEgLTY1NiAtMSAtMTQ1NyAwIGwtMTQ1OCAzIC0xOTIgODMwIGMtMTA1IDQ1NyAtMTkyIDgzMyAtMTkyIDgzOCAtMSA5IDM2NjcgOSAzNjcyIDB6XCIvPjxwYXRoIGQ9XCJNMjAzOCAxMTY1IGMtMTkwIC00OCAtMzU2IC0yMTYgLTM5OCAtNDAwIC0xNSAtNjQgLTE1IC0xODYgMCAtMjUwIDMxIC0xMzcgMTUxIC0yOTAgMjc3IC0zNTQgMTczIC04NyAzODcgLTc4IDUzOCAyMyAyMTkgMTQ2IDMwNiA0MDcgMjE2IDY0NyAtNTUgMTQ0IC0xODEgMjY4IC0zMjYgMzIwIC03OCAyNyAtMjI3IDM0IC0zMDcgMTR6IG0yMTcgLTI5NSBjNDggLTE5IDEwNCAtNzEgMTI5IC0xMjEgMTExIC0yMjMgLTE0NyAtNDQ5IC0zNTQgLTMxMCAtMTc2IDExOCAtMTMwIDM4MiA3OCA0MzcgNDUgMTIgMTA1IDkgMTQ3IC02elwiLz48cGF0aCBkPVwiTTM4MDYgMTE2NCBjLTEzMyAtMzIgLTI3OCAtMTQ2IC0zNDMgLTI3MCAtMTEzIC0yMTMgLTc1IC00NjIgOTcgLTYzNCAyMTMgLTIxMyA1NDIgLTIxNCA3NTQgLTQgMzUgMzUgNzggODggOTUgMTE4IDM4IDY2IDcxIDE5MCA3MSAyNjYgMCA3NiAtMzMgMjAwIC03MSAyNjYgLTE3IDMwIC02MCA4MyAtOTUgMTE4IC0xMzQgMTMzIC0zMjMgMTg1IC01MDggMTQweiBtMTk1IC0yODggYzQ4IC04IDExMiAtNTYgMTQ2IC0xMDggMjUgLTM4IDI4IC01MiAyOCAtMTI4IDAgLTc2IC0zIC05MCAtMjcgLTEyNyAtNTEgLTc4IC0xMTggLTExNSAtMjA5IC0xMTUgLTEwOSAwIC0yMDMgNjkgLTIzMyAxNzMgLTIwIDY1IC0yMCA3MyAwIDEzOCAxNiA1NiA2OSAxMjMgMTE3IDE0NyAzMiAxNyAxMDQgMzMgMTI3IDI5IDggLTIgMzEgLTYgNTEgLTl6XCIvPjwvZz48L3N2Zz4iKTsKICAgIH0KICB9LAogIHdhdGNoOiB7CiAgICBzY3JvbGxQb3NpdGlvbjogZnVuY3Rpb24gc2Nyb2xsUG9zaXRpb24oKSB7CiAgICAgIGlmICh0aGlzLnNjcm9sbFBvc2l0aW9uID4gMTUwKSB7CiAgICAgICAgdGhpcy52aXNpYmxlX2N1c3RvbV9ncmVldGluZ3NfYnV0dG9tID0gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICh0aGlzLnNjcm9sbFBvc2l0aW9uIDwgMTUwKSB7CiAgICAgICAgdGhpcy52aXNpYmxlX2N1c3RvbV9ncmVldGluZ3NfYnV0dG9tID0gZmFsc2U7CiAgICAgIH0KICAgIH0sCiAgICB0b19zZW5kOiBmdW5jdGlvbiB0b19zZW5kKCkgewogICAgICB0aGlzLmJ1dHRvbl9maWxsKCk7CiAgICB9LAogICAgY2hhdDogZnVuY3Rpb24gY2hhdCgpIHsKICAgICAgdGhpcy5zY3JvbGxfZG93bigpOwogICAgfQogIH0sCiAgYmVmb3JlQ3JlYXRlZDogZnVuY3Rpb24gYmVmb3JlQ3JlYXRlZCgpIHsKICAgIHZhciByb3V0ZV9wYXJhbXMgPSB0aGlzLiRyb3V0ZS5wYXJhbXM7CgogICAgaWYgKHJvdXRlX3BhcmFtcy5yZWxvYWQgPT09IHRydWUpIHsKICAgICAgdGhpcy4kcm91dGVyLmdvKCk7CiAgICB9CiAgfSwKICBiZWZvcmVEZXN0cm95OiBmdW5jdGlvbiBiZWZvcmVEZXN0cm95KCkgewogICAgaWYgKHRoaXMubGl2ZV9jaGF0X29uKSB0aGlzLmRpc2Nvbm5lY3Rfc3VwcG9ydF9jaGF0KCk7CiAgfSwKICBjcmVhdGVkOiBmdW5jdGlvbiBjcmVhdGVkKCkgewogICAgdmFyIF90aGlzID0gdGhpcywKICAgICAgICBfYXhpb3MkcG9zdDsKCiAgICB0aGlzLmxvYWRfd2lkZ2V0X3NldHRpbmdzKCk7CiAgICB2YXIgYm90X3RlbXBsYXRlc19kYXRhID0gdGhpcy4kc2Vzc2lvbi5nZXQoIkJvdFRlbXBsYXRlcyIpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYm90X3RlbXBsYXRlc19kYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChib3RfdGVtcGxhdGVzX2RhdGFbaV0uZG9tYWluID09PSAiUmV0YWlsIiAmJiBib3RfdGVtcGxhdGVzX2RhdGFbaV0uc3Vic2NyaWJlZCA9PT0gdHJ1ZSkgewogICAgICAgIHRoaXMuaXNfcmV0YWlsX2JvdCA9IHRydWU7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy4kc2Vzc2lvbi5oYXMoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIpKSB7fSAvLyB0aGlzLmNoYXQgPSB0aGlzLiRzZXNzaW9uLmdldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIik7CiAgICAvLyBpZiAoIXRoaXMuJHNlc3Npb24uaGFzKCJDaGF0Qm90SW1hZ2VQYXJhbWV0ZXJzIikpIHsKICAgIC8vIH0gZWxzZSB7CiAgICAvLyAgIHRoaXMuY2hhdF93aWRnZXQgPSB0aGlzLiRzZXNzaW9uLmdldCgiQ2hhdEJvdEltYWdlUGFyYW1ldGVycyIpOwogICAgLy8gICB0aGlzLmNoYXRfd2lkZ2V0LnN0eWxlID0gIm1hcmdpbi10b3A6IDVweDtoZWlnaHQ6MzBweDt3aWR0aDphdXRvO21hcmdpbi1sZWZ0OiBhdXRvO21hcmdpbi1yaWdodDogMDsiOwogICAgLy8gfQoKCiAgICBpZiAoIXRoaXMuaXNQcmV2aWV3Qm90KSB7CiAgICAgIGlmICghdGhpcy4kc2Vzc2lvbi5oYXMoIkJvdFRva2VuIikpIHsKICAgICAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5ib3RfcmVzcG9uc2VfdG9rZW4oKSwgewogICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgX3RoaXMuJHNlc3Npb24uc2V0KCJCb3RUb2tlbiIsIHJlc3BvbnNlLmRhdGEpOwoKICAgICAgICAgIF90aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSA9IHJlc3BvbnNlLmRhdGE7CgogICAgICAgICAgX3RoaXMucmVmcmVzaF9jaGF0Ym90KCk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUgPSB0aGlzLiRzZXNzaW9uLmdldCgiQm90VG9rZW4iKTsKICAgICAgICB0aGlzLnJlZnJlc2hfY2hhdGJvdCgpOwogICAgICB9CiAgICB9IC8vIGhhcnNoCgoKICAgIGlmICh0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXkgPT0gIi5lSnhUY3NzdlNzMU16NnRJemtqTVMwODFORGV4TklRS0tVREZNa3BLQ29xdDlQWEx5OHYxMGxCVTZ5WG41LW9sbHVvYkdSaGE2aHFZNnhxWUtCZ2FXQmtaVzVtYTZobWJtNWdZbVNvQkFHYTlIcDAuWFIzVHV3Llg3N0ZfN0xEdE9McDJWdDlzbkZEU28zMW5UdyIpIHsKICAgICAgdGhpcy5pc2V4Y2hhbmdlID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAodGhpcy5jb21wYW55aWQgPT0gInJldGFpbGlnZW5jZTg0OTI2IikgewogICAgICB0aGlzLmlzcmV0YWlsaWdlbmNlID0gdHJ1ZTsKICAgIH0KCiAgICB2YXIgZCA9IG5ldyBEYXRlKCk7CiAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5ib3RfdXNlcl9kYXRhKCksIChfYXhpb3MkcG9zdCA9IHsKICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgdHo6IEludGwuRGF0ZVRpbWVGb3JtYXQoKS5yZXNvbHZlZE9wdGlvbnMoKS50aW1lWm9uZSwKICAgICAgZGF0ZXRpbWU6IGQudG9JU09TdHJpbmcoKSwKICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICBzb3VyY2U6ICJXZWIiCiAgICB9LCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3QsICJ0b2tlbiIsIHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0LCAicm9sZSIsIHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlKSwgX2F4aW9zJHBvc3QpKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge30pOwogICAgYXhpb3MucG9zdChhcGlfY2FsbHMucHJvZHVjdF9zZXR0aW5ncygpLCB7CiAgICAgIGNvbXBhbnlfbmFtZTogdGhpcy5jb21wYW55bmFtZSwKICAgICAgY29tcGFueV9pZDogdGhpcy5jb21wYW55aWQsCiAgICAgIGlzX2VtYWlsX3ZlcmlmaWNhdGlvbl9zdGF0dXM6IHRydWUKICAgIH0sIHsKICAgICAgaGVhZGVyczogewogICAgICAgIEF1dGhvcml6YXRpb246ICJCZWFyZXIgIi5jb25jYXQodGhpcy4kc2Vzc2lvbi5nZXQoImF0IikpCiAgICAgIH0KICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIF90aGlzLmJpZ19zcGlubmVyID0gZmFsc2U7CgogICAgICBpZiAocmVzcG9uc2UuZGF0YSAhPSAiIiAmJiByZXNwb25zZS5kYXRhICE9IG51bGwgJiYgcmVzcG9uc2UuZGF0YSAhPSAiSW50ZXJuYWwgc2VydmVyIEVycm9yIikgewogICAgICAgIHZhciBzdGF0dXMgPSByZXNwb25zZS5kYXRhLnZlcmlmaWNhdGlvbl9zdGF0dXM7CgogICAgICAgIGlmIChzdGF0dXMgPT0gIlN1Y2Nlc3MiKSB7CiAgICAgICAgICBfdGhpcy5pc19zZW5kZXJfZW1haWwgPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfdGhpcy5pc19zZW5kZXJfZW1haWwgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgX3RoaXMuaXNfc2VuZGVyX2VtYWlsID0gZmFsc2U7CiAgICAgIH0KICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlKSB7CiAgICAgIF90aGlzLmJpZ19zcGlubmVyID0gZmFsc2U7CgogICAgICBpZiAoZS5yZXNwb25zZS5zdGF0dXMgPT09IDQxMCB8fCBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDQwIHx8IGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MDkpIHsKICAgICAgICBfdGhpcy4kcm9vdC4kZW1pdCgiU2Vzc2lvbl9FeHBpcmVkIiwgZS5yZXNwb25zZS5kYXRhKTsKICAgICAgfQogICAgfSk7CiAgfQp9LCBfZGVmaW5lUHJvcGVydHkoX25hbWUkY29tcG9uZW50cyRtaXhpLCAiYmVmb3JlRGVzdHJveSIsIGZ1bmN0aW9uIGJlZm9yZURlc3Ryb3koKSB7CiAgdGhpcy4kZm9yY2VVcGRhdGUoKTsKfSksIF9kZWZpbmVQcm9wZXJ0eShfbmFtZSRjb21wb25lbnRzJG1peGksICJtb3VudGVkIiwgZnVuY3Rpb24gbW91bnRlZCgpIHsKICB2YXIgdm0gPSB0aGlzOwogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIGZ1bmN0aW9uIChldikgewogICAgaWYgKGV2LnRhcmdldC5pZCA9PT0gJ3BvcnRhbF9jaGF0X2JvZHlfaWQnKSB7CiAgICAgIHZtLnNjcm9sbFBvc2l0aW9uID0gZXYudGFyZ2V0WyJzY3JvbGxUb3AiXTsKICAgIH0KICB9LCB0cnVlKTsgLy8gbGV0IHJlY2FwdGNoYVNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpCiAgLy8gcmVjYXB0Y2hhU2NyaXB0LnNldEF0dHJpYnV0ZSgnc3JjJywgJ2h0dHBzOi8vc2Rrcy5zaG9waWZ5Y2RuLmNvbS9idXktYnV0dG9uL2xhdGVzdC9idXlidXR0b24uanMnKQogIC8vIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQocmVjYXB0Y2hhU2NyaXB0KQogIC8vIGNvbnN0IHBsdWdpbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogIC8vIHBsdWdpbi5zZXRBdHRyaWJ1dGUoCiAgLy8gICAic3JjIiwKICAvLyAgICJodHRwczovL3Nka3Muc2hvcGlmeWNkbi5jb20vYnV5LWJ1dHRvbi9sYXRlc3QvYnV5YnV0dG9uLmpzIgogIC8vICk7CiAgLy8gcGx1Z2luLmFzeW5jID0gdHJ1ZTsKICAvLyBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHBsdWdpbik7CgogIHRoaXMuc2hvdyA9IGZhbHNlOwoKICBpZiAodGhpcy4kcm91dGUubmFtZSA9PSAiVHJhaW4gdGhlIEJvdCIpIHsKICAgICQoIi5jaGF0LXdyYXAiKS5jc3MoInJpZ2h0IiwgImF1dG8iKTsKICB9CgogIGlmICh0aGlzLiRyb3V0ZS5uYW1lID09ICJEaXJlY3QgUmVzcG9uc2UgQm90IikgewogICAgJCgiLmNoYXQtd3JhcCIpLmNzcygibWFyZ2luVG9wIiwgIjUlIik7CiAgfQoKICB3aW5kb3cuU3BlZWNoUmVjb2duaXRpb24gPSB3aW5kb3cud2Via2l0U3BlZWNoUmVjb2duaXRpb24gfHwgd2luZG93LlNwZWVjaFJlY29nbml0aW9uOwogIHdpbmRvdy5BdWRpb0NvbnRleHQgPSB3aW5kb3cuQXVkaW9Db250ZXh0IHx8IHdpbmRvdy53ZWJraXRBdWRpb0NvbnRleHQ7CiAgbmF2aWdhdG9yLmdldFVzZXJNZWRpYSA9IG5hdmlnYXRvci5nZXRVc2VyTWVkaWEgfHwgbmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYSB8fCBuYXZpZ2F0b3IubW96R2V0VXNlck1lZGlhIHx8IG5hdmlnYXRvci5tc0dldFVzZXJNZWRpYTsKICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHNvbWVMaXN0ZW5lcik7CgogIGZ1bmN0aW9uIHNvbWVMaXN0ZW5lcihldmVudCkgewogICAgdmFyIGVsZW1lbnQgPSBldmVudC50YXJnZXQ7CgogICAgaWYgKChlbGVtZW50LnRhZ05hbWUgPT0gIkkiIHx8IGVsZW1lbnQudGFnTmFtZSA9PSAiQSIpICYmIGVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCJmYS1jbGlwYm9hcmQiKSkgewogICAgICB2YXIgbXNnID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtY29weS1jb250ZW50Iik7CiAgICAgIHZhciB0ZW1wID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKICAgICAgdmFyIHRlbXBNc2cgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShtc2cpOwogICAgICB0ZW1wLmFwcGVuZENoaWxkKHRlbXBNc2cpOwogICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRlbXApOwogICAgICB0ZW1wLnNlbGVjdCgpOwogICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiY29weSIpOwogICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRlbXApOwogICAgfQogIH0KCiAgdGhpcy4kcm9vdC4kZW1pdCgiY2hhbmdlX3NpZGViYXJfbWFpbl9tZW51IiwgIlNpbXVsYXRlIEludGVyYWN0aW9uIik7IC8vVG8gaGlkZSBjZW5zZSBjYXJ0IGlmIGNsaWNrZWQgb3V0c2lkZQoKICBkb2N1bWVudC5vbmNsaWNrID0gZnVuY3Rpb24gKGUpIHsKICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCIjY2FydC1ib3giKSB8fCBlLnRhcmdldC5jbG9zZXN0KCIjY3VzdG9tLWNhcnQiKSkge30gZWxzZSB7CiAgICAgIHZtLmlzX2NlbnNlX2NhcnQgPSBmYWxzZTsKICAgIH0KICB9Owp9KSwgX2RlZmluZVByb3BlcnR5KF9uYW1lJGNvbXBvbmVudHMkbWl4aSwgInVwZGF0ZWQiLCBmdW5jdGlvbiB1cGRhdGVkKCkgewogIHRoaXMuc3VibWl0X2N1c3RvbV9mb3JtKCk7Cn0pLCBfZGVmaW5lUHJvcGVydHkoX25hbWUkY29tcG9uZW50cyRtaXhpLCAibWV0aG9kcyIsIHsKICBsb2FkX3dpZGdldF9zZXR0aW5nczogZnVuY3Rpb24gbG9hZF93aWRnZXRfc2V0dGluZ3MoKSB7CiAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5nZXRfd2lkZ2V0X3NldHRpbmdzKCksIHsKICAgICAgY29tcGFueW5hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgIGNvbXBhbnlpZDogdGhpcy5jb21wYW55aWQsCiAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgIHRva2VuOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikudG9rZW5zLAogICAgICBpc1Nob3c6IHRydWUKICAgIH0sIHsKICAgICAgaGVhZGVyczogewogICAgICAgIEF1dGhvcml6YXRpb246ICJCZWFyZXIgIi5jb25jYXQodGhpcy4kc2Vzc2lvbi5nZXQoImF0IikpCiAgICAgIH0KICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIF90aGlzMi5jaGF0X3dpZGdldC50aXRsZSA9IHJlc3BvbnNlLmRhdGEuV2lkZ2V0VGl0bGU7CiAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5sb2dvID0gcmVzcG9uc2UuZGF0YS5JbWFnZVVybDsKICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJ1dHRvbl90aGVtZSA9IHJlc3BvbnNlLmRhdGEuQnV0dG9uVGhlbWU7CiAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5idXR0b25fYm9yZGVyX3RoZW1lID0gcmVzcG9uc2UuZGF0YS5CdXR0b25Cb3JkZXJUaGVtZSA9PT0gbnVsbCA/IF90aGlzMi5jaGF0X3dpZGdldC5idXR0b25fYm9yZGVyX3RoZW1lIDogcmVzcG9uc2UuZGF0YS5CdXR0b25Cb3JkZXJUaGVtZTsKICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LnVzZXJfbXNnX2ZvbnRfY29sb3IgPSByZXNwb25zZS5kYXRhLlVzZXJNZXNzYWdlRm9udENvbG9yID09PSBudWxsID8gX3RoaXMyLmNoYXRfd2lkZ2V0LnVzZXJfbXNnX2ZvbnRfY29sb3IgOiByZXNwb25zZS5kYXRhLlVzZXJNZXNzYWdlRm9udENvbG9yOwogICAgICBfdGhpczIuY2hhdF93aWRnZXQuYm90X3Jlc3BvbnNlX2ZvbnRfY29sb3IgPSByZXNwb25zZS5kYXRhLkJvdFJlc3BvbnNlRm9udENvbG9yID09PSBudWxsID8gX3RoaXMyLmNoYXRfd2lkZ2V0LmJvdF9yZXNwb25zZV9mb250X2NvbG9yIDogcmVzcG9uc2UuZGF0YS5Cb3RSZXNwb25zZUZvbnRDb2xvcjsKICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJvdF9mb250X3N0eWxlID0gcmVzcG9uc2UuZGF0YS5Cb3RGb250LkZvbnRTdHlsZTsKICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJvdF9mb250X2NvbG9yX3NlbmRlciA9IHJlc3BvbnNlLmRhdGEuQm90Rm9udC5Gb250Q29sb3JTZW5kZXI7CiAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9yZWNlaXZlciA9IHJlc3BvbnNlLmRhdGEuQm90Rm9udC5Gb250Q29sb3JSZWNlaXZlcjsKICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJvdF9mb250X2NvbG9yX2J1dHRvbnMgPSByZXNwb25zZS5kYXRhLkJvdEZvbnQuRm9udENvbG9yQnV0dG9uczsKICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJvdF90aGVtZSA9IHJlc3BvbnNlLmRhdGEuQm90VGhlbWU7CiAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5pc19wb3dlcmVkX2J5X2NlbnNlID0gcmVzcG9uc2UuZGF0YS5Jc1Bvd2VyZWRCeUNlbnNlID09PSB1bmRlZmluZWQgPyBfdGhpczIuY2hhdF93aWRnZXQuaXNfcG93ZXJlZF9ieV9jZW5zZSA6IHJlc3BvbnNlLmRhdGEuSXNQb3dlcmVkQnlDZW5zZTsKICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJ1dHRvbl9hbGlnbm1lbnQgPSByZXNwb25zZS5kYXRhLkJvdFN0eWxpbmc7CiAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5ib3RfaWNvbiA9IHJlc3BvbnNlLmRhdGEuQm90SW1hZ2VVcmw7CiAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5idXR0b25fdmVydGljYWxfc3BhY2luZyA9IHJlc3BvbnNlLmRhdGEuQnV0dG9uU3R5bGluZy52ZXJ0aWNhbDsKICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJ1dHRvbl9ob3Jpem9udGFsX3NwYWNpbmcgPSByZXNwb25zZS5kYXRhLkJ1dHRvblN0eWxpbmcuaG9yaXpvbnRhbDsKICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJvdF9iYWNrZ3JvdW5kX2ltYWdlID0gcmVzcG9uc2UuZGF0YS5CZ0ltYWdlVXJsOwogICAgICBfdGhpczIuY2hhdF93aWRnZXQuaGVhZGVyX2JhY2tncm91bmQgPSByZXNwb25zZS5kYXRhLkhlYWRlclRoZW1lOwoKICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgaXNfdmlzaWJsZV9ncmVldGluZ3MgPSByZXNwb25zZS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlcy5tYXAoZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICAgIHJldHVybiBpdGVtLnZpc2libGUgIT09IHVuZGVmaW5lZCA/IGl0ZW0udmlzaWJsZSA6IHRydWU7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChpc192aXNpYmxlX2dyZWV0aW5ncy5pbmNsdWRlcyh0cnVlKSkgewogICAgICAgICAgX3RoaXMyLmdyZWV0aW5nX2J1dHRvbnNfcG9zaXRpb24gPSByZXNwb25zZS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlcy5sZW5ndGggLSAxOwoKICAgICAgICAgIGlmIChCb29sZWFuKHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzW190aGlzMi5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uXVsnYnV0dG9ucyddKSkgewogICAgICAgICAgICB2YXIgdmlzaWJsZV9idXR0b25zID0gcmVzcG9uc2UuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXNbX3RoaXMyLmdyZWV0aW5nX2J1dHRvbnNfcG9zaXRpb25dWydidXR0b25zJ107CiAgICAgICAgICAgIHZpc2libGVfYnV0dG9ucyA9IHZpc2libGVfYnV0dG9ucy5maWx0ZXIoZnVuY3Rpb24gKGJ1dHRvbikgewogICAgICAgICAgICAgIHJldHVybiBidXR0b25bJ3Zpc2libGUnXSA9PT0gdHJ1ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzW190aGlzMi5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uXVsnYnV0dG9ucyddID0gdmlzaWJsZV9idXR0b25zOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciB2aXNpYmxlX2dyZWV0aW5nc19tYXAgPSBpc192aXNpYmxlX2dyZWV0aW5ncy5yZWR1Y2UoZnVuY3Rpb24gKGFjYywgZSkgewogICAgICAgICAgICByZXR1cm4gYWNjLnNldChlLCAoYWNjLmdldChlKSB8fCAwKSArIDEpOwogICAgICAgICAgfSwgbmV3IE1hcCgpKTsKICAgICAgICAgIHZhciBzcGxpY2VfaW5kZXggPSBbXTsKCiAgICAgICAgICBpZiAodmlzaWJsZV9ncmVldGluZ3NfbWFwLmdldCh0cnVlKSAhPT0gcmVzcG9uc2UuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlc1tfdGhpczIuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbl0udmlzaWJsZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlc1tpXS52aXNpYmxlID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzW2kgLSAxIDwgMCA/IGkgOiBpIC0gMV1bJ2J1dHRvbnMnXSA9IHZpc2libGVfYnV0dG9uczsKICAgICAgICAgICAgICAgICAgICBfdGhpczIuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbiA9IF90aGlzMi5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uIC0gMSA8IDAgPyBfdGhpczIuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbiA6IF90aGlzMi5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uIC0gMTsKICAgICAgICAgICAgICAgICAgICBzcGxpY2VfaW5kZXgucHVzaChpKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGZvciAodmFyIF9pID0gcmVzcG9uc2UuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXMubGVuZ3RoIC0gMTsgX2kgPj0gMDsgX2ktLSkgewogICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzW19pXS52aXNpYmxlID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICBfdGhpczIuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbiA9IF90aGlzMi5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uIC0gMSA8IDAgPyBfdGhpczIuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbiA6IF90aGlzMi5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uIC0gMTsKICAgICAgICAgICAgICAgICAgc3BsaWNlX2luZGV4LnB1c2goX2kpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICh2YXIgX2luZGV4ID0gMDsgX2luZGV4IDwgc3BsaWNlX2luZGV4Lmxlbmd0aDsgX2luZGV4KyspIHsKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlcy5zcGxpY2Uoc3BsaWNlX2luZGV4W19pbmRleF0sIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgX3RoaXMyLnB1c2hfbXNnKHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLCByZXNwb25zZS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlcyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChfdGhpczIuaXNfcmV0YWlsX2JvdCkgewogICAgICAgICAgX3RoaXMyLmxvYWRfY2hhdGJvdF9pbnRlZ3JhdGlvbl9kZXRhaWxzKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoX3RoaXMyLmNoYXRfd2lkZ2V0LmJ1dHRvbl9hbGlnbm1lbnQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5idXR0b25fYWxpZ25tZW50ID0gImZsZXgtZW5kIjsKICAgICAgfQoKICAgICAgaWYgKF90aGlzMi5jaGF0X3dpZGdldC5ib3RfaWNvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJvdF9pY29uID0gIi9pbWcvQm90X2ltZy5wbmciOwogICAgICB9CgogICAgICBfdGhpczIuJHNlc3Npb24uc2V0KCJDaGF0Qm90SW1hZ2VQYXJhbWV0ZXJzIiwgX3RoaXMyLmNoYXRfd2lkZ2V0KTsKCiAgICAgIHZhciBzdHlsaW5nX3ZhbHVlID0gcmVzcG9uc2UuZGF0YS5IZWFkZXJTdHlsaW5nLnZhbHVlOwogICAgICB2YXIgdGVtcF9zdHJpbmcgPSAiIjsKCiAgICAgIGlmIChzdHlsaW5nX3ZhbHVlID09PSAibGVmdCIpIHsKICAgICAgICB0ZW1wX3N0cmluZyA9ICJtYXJnaW4tbGVmdDogMDttYXJnaW4tcmlnaHQ6IGF1dG87IjsKICAgICAgfSBlbHNlIGlmIChzdHlsaW5nX3ZhbHVlID09PSAicmlnaHQiKSB7CiAgICAgICAgdGVtcF9zdHJpbmcgPSAibWFyZ2luLWxlZnQ6IGF1dG87bWFyZ2luLXJpZ2h0OiAwOyI7CiAgICAgIH0gZWxzZSBpZiAoc3R5bGluZ192YWx1ZSA9PT0gImNlbnRlciIpIHsKICAgICAgICB0ZW1wX3N0cmluZyA9ICJtYXJnaW4tbGVmdDogYXV0bzttYXJnaW4tcmlnaHQ6IGF1dG87IjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0ZW1wX3N0cmluZyA9ICJtYXJnaW4tbGVmdDogYXV0bzttYXJnaW4tcmlnaHQ6IGF1dG87IjsKICAgICAgfQoKICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LnN0eWxlID0gIm1hcmdpbi10b3A6IDVweDtoZWlnaHQ6MzBweDt3aWR0aDphdXRvO21heC13aWR0aDoxMDAlICFpbXBvcnRhbnQ7IiArIHRlbXBfc3RyaW5nOwogICAgfSkuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKF90aGlzMi5pc19yZXRhaWxfYm90KSB7CiAgICAgICAgX3RoaXMyLmxvYWRfY2hhdGJvdF9pbnRlZ3JhdGlvbl9kZXRhaWxzKCk7CiAgICAgIH0KCiAgICAgIGlmIChlLnJlc3BvbnNlKSB7CiAgICAgICAgaWYgKGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MTAgfHwgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQ0MCB8fCBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA5KSB7CiAgICAgICAgICBfdGhpczIuJHJvb3QuJGVtaXQoIlNlc3Npb25fRXhwaXJlZCIsIGUucmVzcG9uc2UuZGF0YSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChfdGhpczIuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUgPT0gImdvZ3liIikgewogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LnN0eWxlID0gIm1hcmdpbi10b3A6IDVweDtoZWlnaHQ6MzBweDt3aWR0aDo2MHB4O21hcmdpbi1sZWZ0OiBhdXRvO21hcmdpbi1yaWdodDogYXV0bzsiOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmxvZ28gPSAiL2ltZy9jZW5zZV9pbWFnZS5wbmciOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJvdF9pY29uID0gIi9pbWcvQm90X2ltZy5wbmciOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJ1dHRvbl92ZXJ0aWNhbF9zcGFjaW5nID0gIjUiOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJ1dHRvbl9ob3Jpem9udGFsX3NwYWNpbmcgPSAiMyI7CiAgICAgICAgICBfdGhpczIuY2hhdF93aWRnZXQuYm90X2JhY2tncm91bmRfaW1hZ2UgPSAiIjsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5oZWFkZXJfYmFja2dyb3VuZCA9ICIjZmZmZmZmIjsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5idXR0b25fdGhlbWUgPSAiIzFkYWFlMSI7CiAgICAgICAgICBfdGhpczIuY2hhdF93aWRnZXQudXNlcl9tc2dfZm9udF9jb2xvciA9ICIjMjczNjc5IjsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5ib3RfcmVzcG9uc2VfZm9udF9jb2xvciA9ICIjMjczNjc5IjsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5ib3RfdGhlbWUgPSAiIzI3MzY3OSI7CiAgICAgICAgICBfdGhpczIuY2hhdF93aWRnZXQuYnV0dG9uX2JvcmRlcl90aGVtZSA9ICIjMjczNjc5IjsKICAgICAgICB9IGVsc2UgaWYgKF90aGlzMi4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZSA9PSAiTVQgQ2FyZSIpIHsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5sb2dvID0gIi9pbWcvcm9ib21hdGVfbG9nby5wbmciOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LnN0eWxlID0gIm1hcmdpbi10b3A6IDVweDtoZWlnaHQ6NTBweDt3aWR0aDo5NXB4O21hcmdpbi1sZWZ0OiBhdXRvO21hcmdpbi1yaWdodDogYXV0bzsiOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJvdF9pY29uID0gIi9pbWcvQm90X2ltZy5wbmciOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJ1dHRvbl92ZXJ0aWNhbF9zcGFjaW5nID0gIjUiOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJ1dHRvbl9ob3Jpem9udGFsX3NwYWNpbmcgPSAiMyI7CiAgICAgICAgICBfdGhpczIuY2hhdF93aWRnZXQuYm90X2JhY2tncm91bmRfaW1hZ2UgPSAiIjsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5oZWFkZXJfYmFja2dyb3VuZCA9ICIjZmZmZmZmIjsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5idXR0b25fdGhlbWUgPSAiIzFkYWFlMSI7CiAgICAgICAgICBfdGhpczIuY2hhdF93aWRnZXQuYm90X3RoZW1lID0gIiMyNzM2NzkiOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJ1dHRvbl9ib3JkZXJfdGhlbWUgPSAiIzI3MzY3OSI7CiAgICAgICAgICBfdGhpczIuY2hhdF93aWRnZXQudXNlcl9tc2dfZm9udF9jb2xvciA9ICIjMjczNjc5IjsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5ib3RfcmVzcG9uc2VfZm9udF9jb2xvciA9ICIjMjczNjc5IjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmxvZ28gPSAiL2ltZy9jZW5zZV9pbWFnZS5wbmciOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LnN0eWxlID0gIm1hcmdpbi10b3A6IDVweDtoZWlnaHQ6MzBweDt3aWR0aDo2MHB4O21hcmdpbi1sZWZ0OiBhdXRvO21hcmdpbi1yaWdodDogYXV0bzsiOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJvdF9pY29uID0gIi9pbWcvQm90X2ltZy5wbmciOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJ1dHRvbl92ZXJ0aWNhbF9zcGFjaW5nID0gIjUiOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJ1dHRvbl9ob3Jpem9udGFsX3NwYWNpbmcgPSAiMyI7CiAgICAgICAgICBfdGhpczIuY2hhdF93aWRnZXQuYm90X2JhY2tncm91bmRfaW1hZ2UgPSAiIjsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5oZWFkZXJfYmFja2dyb3VuZCA9ICIjZmZmZmZmIjsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5idXR0b25fdGhlbWUgPSAiIzFkYWFlMSI7CiAgICAgICAgICBfdGhpczIuY2hhdF93aWRnZXQuYm90X3RoZW1lID0gIiMyNzM2NzkiOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJ1dHRvbl9ib3JkZXJfdGhlbWUgPSAiIzI3MzY3OSI7CiAgICAgICAgICBfdGhpczIuY2hhdF93aWRnZXQudXNlcl9tc2dfZm9udF9jb2xvciA9ICIjMjczNjc5IjsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5ib3RfcmVzcG9uc2VfZm9udF9jb2xvciA9ICIjMjczNjc5IjsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5ib3RfZm9udF9zdHlsZSA9ICdSb2JvdG8nOwogICAgICAgICAgX3RoaXMyLmNoYXRfd2lkZ2V0LmJvdF9mb250X2NvbG9yX3NlbmRlciA9ICcjZmZmZmZmJzsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9yZWNlaXZlciA9ICcjMDAwMDAwJzsKICAgICAgICAgIF90aGlzMi5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9idXR0b25zID0gJyNmZmZmZmYnOwogICAgICAgIH0KCiAgICAgICAgX3RoaXMyLiRzZXNzaW9uLnNldCgiQ2hhdEJvdEltYWdlUGFyYW1ldGVycyIsIF90aGlzMi5jaGF0X3dpZGdldCk7CiAgICAgIH0KICAgIH0pOwogIH0sCiAgbG9hZF9jaGF0Ym90X2ludGVncmF0aW9uX2RldGFpbHM6IGZ1bmN0aW9uIGxvYWRfY2hhdGJvdF9pbnRlZ3JhdGlvbl9kZXRhaWxzKCkgewogICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgYXhpb3MucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9pbnRlZ3JhdGlvbl9kZXRhaWxzKCksIHsKICAgICAgaXNfZ2V0OiB0cnVlLAogICAgICBjb21wYW55X25hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICB0b2tlbjogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnRva2VucwogICAgfSwgewogICAgICBoZWFkZXJzOiB7CiAgICAgICAgQXV0aG9yaXphdGlvbjogIkJlYXJlciAiLmNvbmNhdCh0aGlzLiRzZXNzaW9uLmdldCgiYXQiKSkKICAgICAgfQogICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuc3RhdHVzID09PSAic3VjY2VzcyIpIHsKICAgICAgICBfdGhpczMuY2hhdGJvdF9pbnRlZ3JhdGlvbl9kZXRhaWxzX3Jlc3BvbnNlKHJlc3BvbnNlKTsKICAgICAgfQogICAgfSkuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgLy8gdGhpcy5zaG9waWZ5X3JldGFpbF9zaG9wX25hbWUgPSAiZWFydGhvbiI7CiAgICAgIGlmIChlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDEwIHx8IGUucmVzcG9uc2Uuc3RhdHVzID09PSA0NDAgfHwgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQwOSkgewogICAgICAgIF90aGlzMy4kcm9vdC4kZW1pdCgiU2Vzc2lvbl9FeHBpcmVkIiwgZS5yZXNwb25zZS5kYXRhKTsKCiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X2ludGVncmF0aW9uX2RldGFpbHMoKSwgewogICAgICAgICAgICBpc19nZXQ6IHRydWUsCiAgICAgICAgICAgIGNvbXBhbnlfbmFtZTogX3RoaXMzLmNvbXBhbnluYW1lLAogICAgICAgICAgICBjb21wYW55X2lkOiBfdGhpczMuY29tcGFueWlkLAogICAgICAgICAgICBlbWFpbDogX3RoaXMzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiBfdGhpczMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IF90aGlzMy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnRva2VucwogICAgICAgICAgfSwgewogICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogIkJlYXJlciAiLmNvbmNhdChfdGhpczMuJHNlc3Npb24uZ2V0KCJhdCIpKQogICAgICAgICAgICB9CiAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5zdGF0dXMgPT09ICJzdWNjZXNzIikgewogICAgICAgICAgICAgIF90aGlzMy5jaGF0Ym90X2ludGVncmF0aW9uX2RldGFpbHNfcmVzcG9uc2UocmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9LCAxMDAwKTsKICAgICAgfQogICAgfSk7CiAgfSwKICBjaGF0Ym90X2ludGVncmF0aW9uX2RldGFpbHNfcmVzcG9uc2U6IGZ1bmN0aW9uIGNoYXRib3RfaW50ZWdyYXRpb25fZGV0YWlsc19yZXNwb25zZShyZXNwb25zZSkgewogICAgdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9IHJlc3BvbnNlLmRhdGEuZGF0YS5yZXRhaWxfd2ViX2ZyYW1ld29yazsKICAgIHZhciB3ZWJmcmFtZXdvcmsgPSByZXNwb25zZS5kYXRhLmRhdGFbdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayArICdfZGV0YWlscyddOwogICAgdGhpcy5zaG93X2N1c3RvbV9jYXJ0ID0gdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayAhPSBudWxsID8gdHJ1ZSA6IGZhbHNlOwoKICAgIGlmICh3ZWJmcmFtZXdvcmsgIT09IG51bGwgJiYgd2ViZnJhbWV3b3JrICE9PSB7fSkgewogICAgICB0aGlzLnJldGFpbF9zaG9wX2N1cnJlbmN5ID0gd2ViZnJhbWV3b3JrLmJhc2VfY3VycmVuY3kudmFsdWUgfHwgIlVTRCI7CiAgICAgIHRoaXMucmV0YWlsX29yZGVyX3JldHJlaXZhbF9vbmx5X2VtYWlsX3JlcXVpcmVkID0gd2ViZnJhbWV3b3JrLm9yZGVyX3JldHJpZXZhbF9vbmx5X2VtYWlsX3JlcXVpcmVkIHx8IGZhbHNlOwogICAgICB0aGlzLmNvbnRhY3RfaGVscF9lbWFpbCA9IHdlYmZyYW1ld29yay5jb250YWN0X2hlbHBfZW1haWw7CiAgICAgIHRoaXMucmV2aWV3X3Jlc3BvbnNlX21lc3NhZ2UgPSB3ZWJmcmFtZXdvcmsucmV2aWV3X3Jlc3BvbnNlX21lc3NhZ2U7CiAgICAgIHRoaXMucmV2aWV3X21lc3NhZ2VfZmlyc3QgPSB3ZWJmcmFtZXdvcmsucmV2aWV3X21lc3NhZ2VfZmlyc3Q7CiAgICAgIHRoaXMucmV2aWV3X21lc3NhZ2Vfc2Vjb25kID0gd2ViZnJhbWV3b3JrLnJldmlld19tZXNzYWdlX3NlY29uZDsKICAgICAgdGhpcy5kaXNwbGF5X3Byb2R1Y3RzID0gd2ViZnJhbWV3b3JrLmRpc3BsYXlfcHJvZHVjdHNfb25fbGFuZGluZzsKICAgICAgdGhpcy5pc19kaXNwbGF5X2Jhbm5lcl9vbl9sYW5kaW5nID0gd2ViZnJhbWV3b3JrLmlzX2Rpc3BsYXlfYmFubmVyX29uX2xhbmRpbmc7CgogICAgICBpZiAodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIpIHsKICAgICAgICB0aGlzLnNob3BpZnlfcmV0YWlsX3Nob3BfbmFtZSA9IHdlYmZyYW1ld29yay5zaG9waWZ5X3Nob3BfbmFtZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnNob3BfdXJsID0gd2ViZnJhbWV3b3JrW3RoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgKyAnX3Nob3BfdXJsJ107CiAgICAgIH0KICAgIH0gLy8gc2V0VGltZW91dCgoKSA9PiB7CgoKICAgIGlmICghdGhpcy5pc1ByZXZpZXdCb3QpIHsKICAgICAgdGhpcy5nZXRfdmlzaXRvcnNfY3VycmVudF9sb2NhdGlvbigpOwogICAgfSBlbHNlIGlmIChCb29sZWFuKHRoaXMuY3VycmVudF9wcmV2aWV3X2Jhbm5lcl9pZCkpIHsKICAgICAgdGhpcy5wcmV2aWV3X2Jhbm5lcigpOwogICAgfSAvLyB9LCAzMDAwKTsKCiAgfSwKICBjb250YWN0X3VzX3Bob25lX251bWJlcjogZnVuY3Rpb24gY29udGFjdF91c19waG9uZV9udW1iZXIocGhvbmVfbnVtYmVyKSB7CiAgICBpZiAoQm9vbGVhbihwaG9uZV9udW1iZXIpKSB7CiAgICAgIHJldHVybiAiIG9yIGNhbGwgdXMgYXQ6ICIgKyBwaG9uZV9udW1iZXI7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gJyc7CiAgICB9CiAgfSwKICB1cGRhdGVfdmFyaWF0aW9uOiBmdW5jdGlvbiB1cGRhdGVfdmFyaWF0aW9uKGNoYXRfaWQsIHByb2R1Y3RfaW5kZXgsIHRpdGxlKSB7CiAgICBmb3IgKHZhciBpIGluIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnZhcmlhdGlvbnMpIHsKICAgICAgaWYgKHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnZhcmlhdGlvbnNbaV0udmFyaWFudF90aXRsZSA9PSB0aXRsZSkgewogICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLmltZ191cmwgPSB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYXRpb25zW2ldLmltZ191cmw7CiAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0uaWQgPSB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYXRpb25zW2ldLmlkOwogICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnBlcm1hbGluayA9IHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnZhcmlhdGlvbnNbaV0ucGVybWFsaW5rOwogICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnByaWNlID0gdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9uc1tpXS5wcmljZTsKICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS5yZWd1bGFyX3ByaWNlID0gdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9uc1tpXS5yZWd1bGFyX3ByaWNlOwogICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnN0b2NrX3F1YW50aXR5ID0gdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9uc1tpXS5zdG9ja19xdWFudGl0eTsKICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS5zdG9ja19zdGF0dXMgPSB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYXRpb25zW2ldLnN0b2NrX3N0YXR1czsKICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYW50X3RpdGxlID0gdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9uc1tpXS52YXJpYW50X3RpdGxlOwogICAgICB9CiAgICB9IC8vIGNvbnN0IGZvdW5kID0gdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9ucy5zb21lKGVsID0+IGVsLnZhcmlhbnRfdGl0bGUgPT0gIkRlZmF1bHQiKTsKICAgIC8vIGlmICghZm91bmQpIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnZhcmlhdGlvbnMucHVzaChkZWZhdWx0X3ZhbHVlcyk7CgogIH0sCiAgZ2V0X3Zpc2l0b3JzX2N1cnJlbnRfbG9jYXRpb246IGZ1bmN0aW9uIGdldF92aXNpdG9yc19jdXJyZW50X2xvY2F0aW9uKCkgewogICAgaWYgKHRoaXMuaXNfZGlzcGxheV9iYW5uZXJfb25fbGFuZGluZyA9PT0gdHJ1ZSkgewogICAgICB2YXIgY3V0b2ZmID0gbmV3IERhdGUoKTsKICAgICAgdmFyIGRhdGVfdGltZSA9IG1vbWVudC51dGMoY3V0b2ZmLCBbIllZWVktTU0tREQgSEg6bW06c3MiXSkuZm9ybWF0KCJZWVlZLU1NLUREIEhIOm1tOnNzIik7CiAgICAgIHZhciB2bSA9IHRoaXM7CiAgICAgICQuZ2V0SlNPTih2bS52aXNpdG9yc19jdXJyZW50X2xvY2F0aW9uX3VybCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBpZiAoZGF0YSkgewogICAgICAgICAgdm0udmlzaXRvcnNfY3VycmVudF9sb2NhdGlvbiA9IHsKICAgICAgICAgICAgImlwX2FkZHJlc3MiOiBkYXRhLmlwX2FkZHJlc3MsCiAgICAgICAgICAgICJjaXR5IjogZGF0YS5jaXR5LAogICAgICAgICAgICAiY2l0eV9nZW9uYW1lX2lkIjogZGF0YS5jaXR5X2dlb25hbWVfaWQsCiAgICAgICAgICAgICJyZWdpb24iOiBkYXRhLnJlZ2lvbiwKICAgICAgICAgICAgInJlZ2lvbl9pc29fY29kZSI6IGRhdGEucmVnaW9uX2lzb19jb2RlLAogICAgICAgICAgICAicmVnaW9uX2dlb25hbWVfaWQiOiBkYXRhLnJlZ2lvbl9nZW9uYW1lX2lkLAogICAgICAgICAgICAicG9zdGFsX2NvZGUiOiBkYXRhLnBvc3RhbF9jb2RlLAogICAgICAgICAgICAiY291bnRyeSI6IGRhdGEuY291bnRyeSwKICAgICAgICAgICAgImNvdW50cnlfY29kZSI6IGRhdGEuY291bnRyeV9jb2RlLAogICAgICAgICAgICAiY291bnRyeV9nZW9uYW1lX2lkIjogZGF0YS5jb3VudHJ5X2dlb25hbWVfaWQsCiAgICAgICAgICAgICJjb3VudHJ5X2lzX2V1IjogZGF0YS5jb3VudHJ5X2lzX2V1LAogICAgICAgICAgICAiY29udGluZW50IjogZGF0YS5jb250aW5lbnQsCiAgICAgICAgICAgICJjb250aW5lbnRfY29kZSI6IGRhdGEuY29udGluZW50X2NvZGUsCiAgICAgICAgICAgICJjb250aW5lbnRfZ2VvbmFtZV9pZCI6IGRhdGEuY29udGluZW50X2dlb25hbWVfaWQsCiAgICAgICAgICAgICJsb25naXR1ZGUiOiBkYXRhLmxvbmdpdHVkZSwKICAgICAgICAgICAgImxhdGl0dWRlIjogZGF0YS5sYXRpdHVkZSwKICAgICAgICAgICAgInNlY3VyaXR5IjogZGF0YS5zZWN1cml0eSwKICAgICAgICAgICAgImRhdGVfdGltZSI6IGRhdGVfdGltZQogICAgICAgICAgfTsKICAgICAgICAgIHZtLmlzX2Rpc3BsYXlfYmFubmVyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZtLmlzX2Rpc3BsYXlfcHJvZHVjdHMoKTsKICAgICAgICB9CiAgICAgIH0pLmVycm9yKGZ1bmN0aW9uICgpIHsKICAgICAgICB2bS5pc19kaXNwbGF5X3Byb2R1Y3RzKCk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5pc19kaXNwbGF5X3Byb2R1Y3RzKCk7CiAgICB9CiAgfSwKICBwcmV2aWV3X2Jhbm5lcjogZnVuY3Rpb24gcHJldmlld19iYW5uZXIoKSB7CiAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5iYW5uZXJfdGVtcGxhdGUoKSwgewogICAgICBjb21wYW55X25hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICB0b2tlbjogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnRva2VucywKICAgICAgc3Vic2NyaXB0aW9uOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuc3Vic2NyaXB0aW9uLAogICAgICBpc19wcmV2aWV3X2Jhbm5lcjogdHJ1ZSwKICAgICAgYmFubmVyX2lkOiB0aGlzLmN1cnJlbnRfcHJldmlld19iYW5uZXJfaWQKICAgIH0sIHsKICAgICAgaGVhZGVyczogewogICAgICAgIEF1dGhvcml6YXRpb246ICJCZWFyZXIgIi5jb25jYXQodGhpcy4kc2Vzc2lvbi5nZXQoImF0IikpCiAgICAgIH0KICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT0gMjAwKSB7CiAgICAgICAgaWYgKEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXMubGVuZ3RoID4gMCkpIHsKICAgICAgICAgIF90aGlzNC5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICBpZiAoZS5yZXNwb25zZS5zdGF0dXMgPT09IDQxMCB8fCBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDQwIHx8IGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MDkpIHsKICAgICAgICBfdGhpczQuJHJvb3QuJGVtaXQoIlNlc3Npb25fRXhwaXJlZCIsIGUucmVzcG9uc2UuZGF0YSk7CiAgICAgIH0KICAgIH0pOwogIH0sCiAgaXNfZGlzcGxheV9iYW5uZXI6IGZ1bmN0aW9uIGlzX2Rpc3BsYXlfYmFubmVyKCkgewogICAgdmFyIF90aGlzNSA9IHRoaXM7CgogICAgYXhpb3MuZ2V0KGFwaV9jYWxscy5iYW5uZXJfdGVtcGxhdGUoKSwgewogICAgICBwYXJhbXM6IHsKICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgaXNfZGlzcGxheV9iYW5uZXI6IHRydWUsCiAgICAgICAgdmlzaXRvcnNfY3VycmVudF9sb2NhdGlvbjogdGhpcy52aXNpdG9yc19jdXJyZW50X2xvY2F0aW9uCiAgICAgIH0KICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT0gMjAwKSB7CiAgICAgICAgaWYgKEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXMubGVuZ3RoID4gMCkpIHsKICAgICAgICAgIF90aGlzNS5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBfdGhpczUuaXNfZGlzcGxheV9wcm9kdWN0cygpOwogICAgfSkuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgX3RoaXM1LmlzX2Rpc3BsYXlfcHJvZHVjdHMoKTsKCiAgICAgIGlmIChlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDEwIHx8IGUucmVzcG9uc2Uuc3RhdHVzID09PSA0NDAgfHwgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQwOSkgewogICAgICAgIF90aGlzNS4kcm9vdC4kZW1pdCgiU2Vzc2lvbl9FeHBpcmVkIiwgZS5yZXNwb25zZS5kYXRhKTsKICAgICAgfQogICAgfSk7CiAgfSwKICBpc19kaXNwbGF5X3Byb2R1Y3RzOiBmdW5jdGlvbiBpc19kaXNwbGF5X3Byb2R1Y3RzKCkgewogICAgdmFyIF90aGlzNiA9IHRoaXM7CgogICAgaWYgKHRoaXMuZGlzcGxheV9wcm9kdWN0cyA9PT0gdHJ1ZSkgewogICAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5kaXNwbGF5X2xhbmRpbmdfcHJvZHVjdHMoKSwgewogICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgc291cmNlOiAiV2ViIgogICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgIHZhciBwcm9kdWN0c19jb3VudCA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLnByb2R1Y3RzLnByb2R1Y3RzX2xpc3QubGVuZ3RoOwoKICAgICAgICBpZiAocHJvZHVjdHNfY291bnQgPiAwKSB7CiAgICAgICAgICBfdGhpczYucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpOwogICAgICAgIH0KCiAgICAgICAgX3RoaXM2LmlzX3Jldmlld19yYXRpbmcoKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgICBfdGhpczYuaXNfcmV2aWV3X3JhdGluZygpOwoKICAgICAgICBpZiAoZS5yZXNwb25zZS5zdGF0dXMgPT09IDQxMCB8fCBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDQwIHx8IGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MDkpIHsKICAgICAgICAgIF90aGlzNi4kcm9vdC4kZW1pdCgiU2Vzc2lvbl9FeHBpcmVkIiwgZS5yZXNwb25zZS5kYXRhKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5pc19yZXZpZXdfcmF0aW5nKCk7CiAgICB9CiAgfSwKICBjaGVja19zaG9waWZ5X2N1c3RvbWVyX3Rva2VuX2V4cGlyeTogZnVuY3Rpb24gY2hlY2tfc2hvcGlmeV9jdXN0b21lcl90b2tlbl9leHBpcnkoKSB7CiAgICB2YXIgY3V0b2ZmID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW5fZXhwaXJ5Iik7CiAgICBjdXRvZmYgPSBtb21lbnQoY3V0b2ZmLCBbIllZWVktTU0tRERUaGg6bW06c3NaIl0pOwogICAgdmFyIGN1cnJlbnRfdGltZSA9IG5ldyBEYXRlKGN1dG9mZik7CgogICAgaWYgKG1vbWVudCgpLmlzQmVmb3JlKGN1cnJlbnRfdGltZSkpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKICBpc19yZXZpZXdfcmF0aW5nOiBmdW5jdGlvbiBpc19yZXZpZXdfcmF0aW5nKCkgewogICAgdmFyIF90aGlzNyA9IHRoaXM7CgogICAgaWYgKEJvb2xlYW4odGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiKSkgfHwgQm9vbGVhbih0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpKSkgewogICAgICB2YXIgc3RyaW5naWZpZWRfY3VzdG9tZXJfcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICBjdXN0b21lcklkOiB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl9pZCIpLAogICAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpCiAgICAgIH0pOwogICAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgY2hhdDogIi9yZXRyaWV2ZV9jdXN0b21lcl9vcmRlcnMiLmNvbmNhdChzdHJpbmdpZmllZF9jdXN0b21lcl9wYXlsb2FkKSwKICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiBmYWxzZQogICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgIGlmIChCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbSkpIHsKICAgICAgICAgIGlmIChCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbS5vcmRlcnNfbGlzdC5sZW5ndGggPiAwKSkgewogICAgICAgICAgICBfdGhpczcuY2FsbF9yZXZpZXdfcmF0aW5nKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbS5vcmRlcnNfbGlzdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LAogIGNhbGxfcmV2aWV3X3JhdGluZzogZnVuY3Rpb24gY2FsbF9yZXZpZXdfcmF0aW5nKGRhdGEpIHsKICAgIHZhciBfdGhpczggPSB0aGlzOwoKICAgIHZhciBmdWxmaWxsZWRfb3JkZXJzID0gZGF0YS5maWx0ZXIoZnVuY3Rpb24gKGZ1bGZpbGxlZF9vcmRlcikgewogICAgICByZXR1cm4gZnVsZmlsbGVkX29yZGVyLmZ1bGZpbGxtZW50X3N0YXR1cyA9PT0gImZ1bGZpbGxlZCI7CiAgICB9KTsKICAgIHZhciBzb3J0ZWRfZnVsZmlsbGVkX29yZGVycyA9IGZ1bGZpbGxlZF9vcmRlcnMubWFwKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiBpdGVtLmxpbmVfaXRlbXMubWFwKGZ1bmN0aW9uIChwcm9kdWN0KSB7CiAgICAgICAgcmV0dXJuIHByb2R1Y3Q7CiAgICAgIH0pOwogICAgfSk7CiAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5wcm9kdWN0X3Jldmlld19yYXRpbmcoKSwgewogICAgICBjb21wYW55X25hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgIHdlYl9mcmFtZXdvcms6IHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmssCiAgICAgIGlzX2dldF9yZXZpZXdlZF9wcm9kdWN0X2lkOiB0cnVlLAogICAgICByZXZpZXdfcmF0aW5nX2N1c3RvbWVyX2lkOiB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl9pZCIpLAogICAgICByZXZpZXdfcmF0aW5nX2N1c3RvbWVyX2VtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpCiAgICB9LCB7CiAgICAgIGhlYWRlcnM6IHsKICAgICAgICBBdXRob3JpemF0aW9uOiAiQmVhcmVyICIuY29uY2F0KHRoaXMuJHNlc3Npb24uZ2V0KCJhdCIpKQogICAgICB9CiAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpZiAocmVzcG9uc2UuZGF0YS5pc19yZXZpZXcgPT09IHRydWUpIHsKICAgICAgICB2YXIgcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzID0gW107CiAgICAgICAgdmFyIG5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMgPSBbXTsKICAgICAgICB2YXIgcmV2aWV3ZWRfcHJvZHVjdF9pZF9saXN0ID0gcmVzcG9uc2UuZGF0YS5wcm9kdWN0X2lkX2xpc3Q7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydGVkX2Z1bGZpbGxlZF9vcmRlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc29ydGVkX2Z1bGZpbGxlZF9vcmRlcnNbaV0ubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgaWYgKHJldmlld2VkX3Byb2R1Y3RfaWRfbGlzdC5pbmNsdWRlcyhzb3J0ZWRfZnVsZmlsbGVkX29yZGVyc1tpXVtqXS5wcm9kdWN0X2lkKSkgewogICAgICAgICAgICAgIHJldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5wdXNoKHNvcnRlZF9mdWxmaWxsZWRfb3JkZXJzW2ldW2pdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLnB1c2goc29ydGVkX2Z1bGZpbGxlZF9vcmRlcnNbaV1bal0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5sZW5ndGggPiAwICYmIEJvb2xlYW4oX3RoaXM4LnJldmlld19tZXNzYWdlX2ZpcnN0KSA9PT0gdHJ1ZSAmJiBCb29sZWFuKF90aGlzOC5yZXZpZXdfbWVzc2FnZV9zZWNvbmQpID09PSB0cnVlICYmIEJvb2xlYW4oX3RoaXM4LnJldmlld19yZXNwb25zZV9tZXNzYWdlKSA9PT0gdHJ1ZSkgewogICAgICAgICAgYXhpb3MucG9zdChhcGlfY2FsbHMucHJvZHVjdF9yZXZpZXdfcmF0aW5nKCksIHsKICAgICAgICAgICAgY29tcGFueV9uYW1lOiBfdGhpczguY29tcGFueW5hbWUsCiAgICAgICAgICAgIGNvbXBhbnlfaWQ6IF90aGlzOC5jb21wYW55aWQsCiAgICAgICAgICAgIGVtYWlsOiBfdGhpczguJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IF90aGlzOC4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogX3RoaXM4LmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgdXNlcm5hbWU6IF90aGlzOC4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICB3ZWJfZnJhbWV3b3JrOiBfdGhpczgucmV0YWlsX3dlYl9mcmFtZXdvcmssCiAgICAgICAgICAgIGlzX2dldF9wcm9kdWN0X2ltYWdlOiB0cnVlLAogICAgICAgICAgICBwcm9kdWN0X2lkOiBub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzWzBdLnByb2R1Y3RfaWQKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgIEF1dGhvcml6YXRpb246ICJCZWFyZXIgIi5jb25jYXQoX3RoaXM4LiRzZXNzaW9uLmdldCgiYXQiKSkKICAgICAgICAgICAgfQogICAgICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuTVNHID09PSAnSW1hZ2UgUmVjZWl2ZWQgU3VjY2Vzc2Z1bGx5JykgewogICAgICAgICAgICAgIHZhciBwcm9kdWN0X3Jldmlld19pbWdfdXJsID0gcmVzcG9uc2UuZGF0YS5pbWFnZV9zcmM7CiAgICAgICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgICAgIGlzX3Jldmlld19yYXRpbmdfcHJvZHVjdDogdHJ1ZSwKICAgICAgICAgICAgICAgIG5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHM6IG5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHNbMF0sCiAgICAgICAgICAgICAgICByZXZpZXdfbWVzc2FnZV9maXJzdDogX3RoaXM4LnJldmlld19tZXNzYWdlX2ZpcnN0LAogICAgICAgICAgICAgICAgcmV2aWV3X21lc3NhZ2Vfc2Vjb25kOiBfdGhpczgucmV2aWV3X21lc3NhZ2Vfc2Vjb25kLAogICAgICAgICAgICAgICAgcHJvZHVjdF9yZXZpZXdfaW1nX3VybDogcHJvZHVjdF9yZXZpZXdfaW1nX3VybCwKICAgICAgICAgICAgICAgIHByb2R1Y3RfcmF0aW5nOiBudWxsLAogICAgICAgICAgICAgICAgcHJvZHVjdF9yZXZpZXc6ICcnLAogICAgICAgICAgICAgICAgdGltZTogX3RoaXM4LmdlbmVyYXRlX3RpbWUoKQogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIF90aGlzOC5jaGF0LnB1c2gobXNnKTsKCiAgICAgICAgICAgICAgX3RoaXM4LnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSkuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgdG9hc3RyLmVycm9yKCJTb21lIEVycm9yIE9jY3VycmVkLiIpOwoKICAgICAgaWYgKGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MTAgfHwgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQ0MCB8fCBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA5KSB7CiAgICAgICAgX3RoaXM4LiRyb290LiRlbWl0KCJTZXNzaW9uX0V4cGlyZWQiLCBlLnJlc3BvbnNlLmRhdGEpOwogICAgICB9CiAgICB9KTsKICB9LAogIHN1Ym1pdF9yZXZpZXdfcmF0aW5nOiBmdW5jdGlvbiBzdWJtaXRfcmV2aWV3X3JhdGluZyhpbmRleCkgewogICAgdmFyIF90aGlzOSA9IHRoaXM7CgogICAgaWYgKEJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5wcm9kdWN0X3JhdGluZykgPT09IGZhbHNlKSB7CiAgICAgIHN3YWwoewogICAgICAgIHRleHQ6ICJQbGVhc2UgZ2l2ZSByYXRpbmciLAogICAgICAgIHRvYXN0OiB0cnVlLAogICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICB0eXBlOiAid2FybmluZyIsCiAgICAgICAgcG9zaXRpb246ICJ0b3AtZW5kIiwKICAgICAgICB0aW1lcjogNTAwMAogICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0ucHJvZHVjdF9yZXZpZXcpID09PSBmYWxzZSkgewogICAgICBzd2FsKHsKICAgICAgICB0ZXh0OiAiUGxlYXNlIHdyaXRlIHJldmlldyIsCiAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgc2hvd0NhbmNlbEJ1dHRvbjogZmFsc2UsCiAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgIHR5cGU6ICJ3YXJuaW5nIiwKICAgICAgICBwb3NpdGlvbjogInRvcC1lbmQiLAogICAgICAgIHRpbWVyOiA1MDAwCiAgICAgIH0pOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gInNob3BpZnkiKSB7CiAgICAgIHZhciBwcm9kdWN0X2RldGFpbHMgPSB7CiAgICAgICAgInByb2R1Y3RfaWQiOiB0aGlzLmNoYXRbaW5kZXhdLm5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMucHJvZHVjdF9pZCwKICAgICAgICAibmFtZSI6IHRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5uYW1lLAogICAgICAgICJpbWFnZV9zcmMiOiB0aGlzLmNoYXRbaW5kZXhdLnByb2R1Y3RfcmV2aWV3X2ltZ191cmwsCiAgICAgICAgInByaWNlIjogdGhpcy5jaGF0W2luZGV4XS5ub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLnByaWNlLAogICAgICAgICJxdWFudGl0eSI6IHRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5xdWFudGl0eSwKICAgICAgICAidmFyaWFudF9pZCI6IHRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy52YXJpYW50X2lkCiAgICAgIH07CiAgICB9IGVsc2UgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIndvb2NvbW1lcmNlIikgewogICAgICB2YXIgcHJvZHVjdF9kZXRhaWxzID0gewogICAgICAgICJwcm9kdWN0X2lkIjogdGhpcy5jaGF0W2luZGV4XS5ub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLnByb2R1Y3RfaWQsCiAgICAgICAgIm5hbWUiOiB0aGlzLmNoYXRbaW5kZXhdLm5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMubmFtZSwKICAgICAgICAiaW1hZ2Vfc3JjIjogdGhpcy5jaGF0W2luZGV4XS5wcm9kdWN0X3Jldmlld19pbWdfdXJsLAogICAgICAgICJwcmljZSI6IHRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5wcmljZSwKICAgICAgICAicXVhbnRpdHkiOiB0aGlzLmNoYXRbaW5kZXhdLm5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMucXVhbnRpdHksCiAgICAgICAgInZhcmlhbnRfaWQiOiB0aGlzLmNoYXRbaW5kZXhdLm5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMudmFyaWF0aW9uX2lkCiAgICAgIH07CiAgICB9IGVsc2UgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iKSB7CiAgICAgIHZhciBwcm9kdWN0X2RldGFpbHMgPSB7CiAgICAgICAgInByb2R1Y3RfaWQiOiB0aGlzLmNoYXRbaW5kZXhdLm5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMucHJvZHVjdF9pZCwKICAgICAgICAibmFtZSI6IHRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5uYW1lLAogICAgICAgICJpbWFnZV9zcmMiOiB0aGlzLmNoYXRbaW5kZXhdLnByb2R1Y3RfcmV2aWV3X2ltZ191cmwsCiAgICAgICAgInByaWNlIjogdGhpcy5jaGF0W2luZGV4XS5ub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLnByaWNlLAogICAgICAgICJxdWFudGl0eSI6IHRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5xdHlfc2hpcHBlZCwKICAgICAgICAidmFyaWFudF9pZCI6IHRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5za3UKICAgICAgfTsKICAgIH0KCiAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5wcm9kdWN0X3Jldmlld19yYXRpbmcoKSwgewogICAgICBjb21wYW55X25hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgIGlzX3NhdmVfcmV2aWV3X3JhdGluZzogdHJ1ZSwKICAgICAgcmV2aWV3X3JhdGluZ19jdXN0b21lcl9pZDogdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiKSwKICAgICAgcmV2aWV3X3JhdGluZ19jdXN0b21lcl9lbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iKSwKICAgICAgcHJvZHVjdF9yYXRpbmc6IHRoaXMuY2hhdFtpbmRleF0ucHJvZHVjdF9yYXRpbmcsCiAgICAgIHByb2R1Y3RfcmV2aWV3OiB0aGlzLmNoYXRbaW5kZXhdLnByb2R1Y3RfcmV2aWV3LAogICAgICBwcm9kdWN0X2RldGFpbHM6IHByb2R1Y3RfZGV0YWlscwogICAgfSwgewogICAgICBoZWFkZXJzOiB7CiAgICAgICAgQXV0aG9yaXphdGlvbjogIkJlYXJlciAiLmNvbmNhdCh0aGlzLiRzZXNzaW9uLmdldCgiYXQiKSkKICAgICAgfQogICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaWYgKHJlc3BvbnNlLmRhdGEgIT0gIiIgJiYgcmVzcG9uc2UuZGF0YSAhPSBudWxsICYmIHJlc3BvbnNlLmRhdGEgIT0gIkludGVybmFsIHNlcnZlciBFcnJvciIpIHsKICAgICAgICBfdGhpczkuY2hhdFtpbmRleF0uaXNfcmV2aWV3X3JhdGluZ19wcm9kdWN0ID0gZmFsc2U7IC8vIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPSB0aGlzLnJldmlld19yZXNwb25zZV9tZXNzYWdlOwogICAgICAgIC8vIHRoaXMuY2hhdFtpbmRleF0udGltZSA9IHRoaXMuZ2VuZXJhdGVfdGltZSgpOwoKICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgcmVjZWl2ZWQ6IF90aGlzOS5yZXZpZXdfcmVzcG9uc2VfbWVzc2FnZSwKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgdGltZTogX3RoaXM5LmdlbmVyYXRlX3RpbWUoKQogICAgICAgIH07CgogICAgICAgIF90aGlzOS5jaGF0LnB1c2gobXNnKTsKCiAgICAgICAgX3RoaXM5LnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CgogICAgICAgIGlmIChyZXNwb25zZS5kYXRhLk1TRyA9PT0gJ1JldmlldyBTYXZlZCBTdWNjZXNzZnVsbHknKSB7CiAgICAgICAgICBzd2FsKHsKICAgICAgICAgICAgdGV4dDogX3RoaXM5LnJldmlld19yZXNwb25zZV9tZXNzYWdlLAogICAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgICAgc2hvd0NhbmNlbEJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgdHlwZTogInN1Y2Nlc3MiLAogICAgICAgICAgICBwb3NpdGlvbjogInRvcC1lbmQiLAogICAgICAgICAgICB0aW1lcjogNTAwMAogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLk1TRyA9PT0gIlJldmlldyBOb3QgU2F2ZWQgU3VjY2Vzc2Z1bGx5IikgewogICAgICAgICAgc3dhbCh7CiAgICAgICAgICAgIHRleHQ6ICJTb21lIEVycm9yIE9jY3VycmVkLiIsCiAgICAgICAgICAgIHRvYXN0OiB0cnVlLAogICAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgICB0eXBlOiAiZXJyb3IiLAogICAgICAgICAgICBwb3NpdGlvbjogInRvcC1lbmQiLAogICAgICAgICAgICB0aW1lcjogNTAwMAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRvYXN0ci5lcnJvcigiSW50ZXJuYWwgU2VydmVyIEVycm9yIik7CiAgICAgIH0KICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlKSB7CiAgICAgIHRvYXN0ci5lcnJvcigiU29tZSBFcnJvciBPY2N1cnJlZC4iKTsKCiAgICAgIGlmIChlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDEwIHx8IGUucmVzcG9uc2Uuc3RhdHVzID09PSA0NDAgfHwgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQwOSkgewogICAgICAgIF90aGlzOS4kcm9vdC4kZW1pdCgiU2Vzc2lvbl9FeHBpcmVkIiwgZS5yZXNwb25zZS5kYXRhKTsKICAgICAgfQogICAgfSk7CiAgfSwKICBjbG9zZWNhcnQ6IGZ1bmN0aW9uIGNsb3NlY2FydChjbG9zZV9jYXJ0KSB7CiAgICB0aGlzLmlzX2NlbnNlX2NhcnQgPSBjbG9zZV9jYXJ0OwogIH0sCiAgY2FydF9jb21tdW5pY2F0aW9uOiBmdW5jdGlvbiBjYXJ0X2NvbW11bmljYXRpb24oY2FydF9kYXRhKSB7CiAgICB0aGlzLmFkZHRvQ2FydGRhdGEgPSBbXTsKICAgIHRoaXMudG90YWxfcHJvZHVjdHNfcXR5ID0gMDsKCiAgICBmb3IgKHZhciBpIGluIGNhcnRfZGF0YSkgewogICAgICB0aGlzLmFkZHRvQ2FydGRhdGEucHVzaChjYXJ0X2RhdGFbaV0pOwogICAgfQoKICAgIGZvciAodmFyIGogaW4gdGhpcy5hZGR0b0NhcnRkYXRhKSB7CiAgICAgIHRoaXMudG90YWxfcHJvZHVjdHNfcXR5ID0gdGhpcy50b3RhbF9wcm9kdWN0c19xdHkgKyB0aGlzLmFkZHRvQ2FydGRhdGFbal0ub3JkZXJfcXR5OwogICAgfQogIH0sCiAgdXBkYXRlX3F1YW50aXR5OiBmdW5jdGlvbiB1cGRhdGVfcXVhbnRpdHkoZnVuYywgY2hhdF9pZCwgaW5kZXgsIHByb2R1Y3QpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICB0aGlzLm92ZXJfcXR5X3dhcm5pbmcgPSBmYWxzZTsKICAgIHZhciBidXkgPSBwYXJzZUludCh0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0uYnV5X3F0eSk7CiAgICB2YXIgb3JkZXIgPSB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0ub3JkZXJfcXR5OwogICAgdmFyIHN0b2NrID0gdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLnN0b2NrX3F1YW50aXR5OwoKICAgIGlmICh0aGlzLmFkZHRvQ2FydGRhdGEubGVuZ3RoICE9PSAwICYmIHN0b2NrICE9IG51bGwpIHsKICAgICAgZm9yICh2YXIgaSBpbiB0aGlzLmFkZHRvQ2FydGRhdGEpIHsKICAgICAgICBpZiAodGhpcy5hZGR0b0NhcnRkYXRhW2ldLmlkID09IHByb2R1Y3QuaWQpIHsKICAgICAgICAgIHZhciBjYXJ0X29yZGVyX3F0eSA9IHRoaXMuYWRkdG9DYXJ0ZGF0YVtpXS5vcmRlcl9xdHk7CiAgICAgICAgICBzdG9jayA9IHN0b2NrIC0gY2FydF9vcmRlcl9xdHk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdmFyIHRvdGFsID0gYnV5ICsgb3JkZXI7CgogICAgaWYgKGZ1bmMgPT09ICIrIikgewogICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0ub3JkZXJfcXR5ID0gMTsKCiAgICAgIGlmICh0b3RhbCA8PSBzdG9jayB8fCBzdG9jayA9PSBudWxsICYmICFpc05hTih0b3RhbCkpIHsKICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0uYnV5X3F0eSArPSAxOwogICAgICAgIHZtLiRzZXQodm0uY2hhdCwgY2hhdF9pZCwgdm0uY2hhdFtjaGF0X2lkXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLm9yZGVyX3F0eSA9IDI7CgogICAgICAgIGlmIChzdG9jayA9PT0gMCkgewogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkgPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0uYnV5X3F0eSA9IHN0b2NrOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChmdW5jID09PSAiLSIpIHsKICAgICAgaWYgKGJ1eSA+IDEgJiYgIWlzTmFOKHRvdGFsKSkgewogICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5vcmRlcl9xdHkgPSAxOwogICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5idXlfcXR5IC09IDE7CiAgICAgICAgdm0uJHNldCh2bS5jaGF0LCBjaGF0X2lkLCB2bS5jaGF0W2NoYXRfaWRdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0uYnV5X3F0eSA9IDE7CiAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLm9yZGVyX3F0eSA9IDE7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoZnVuYyA9PT0gIm1hbnVhbCIpIHsKICAgICAgdmFyIHF1YW50aXR5ID0gTWF0aC5hYnMocGFyc2VJbnQocHJvZHVjdC5idXlfcXR5KSk7CgogICAgICBpZiAoIWlzTmFOKHF1YW50aXR5KSkgewogICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5vcmRlcl9xdHkgPSAxOwoKICAgICAgICBpZiAocXVhbnRpdHkpIHsKICAgICAgICAgIGlmIChxdWFudGl0eSA8PSBzdG9jayB8fCBzdG9jayA9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5idXlfcXR5ID0gcXVhbnRpdHk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0ub3JkZXJfcXR5ID0gMjsKCiAgICAgICAgICAgIGlmIChzdG9jayA9PT0gMCkgewogICAgICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5idXlfcXR5ID0gMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0uYnV5X3F0eSA9IHN0b2NrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgdm0uJHNldCh2bS5jaGF0LCBjaGF0X2lkLCB2bS5jaGF0W2NoYXRfaWRdKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaXNOYU4odG90YWwpKSB7CiAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkgPSAxOwogICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5vcmRlcl9xdHkgPSAxOwogICAgICAgIHZtLiRzZXQodm0uY2hhdCwgY2hhdF9pZCwgdm0uY2hhdFtjaGF0X2lkXSk7CiAgICAgIH0KICAgIH0KICB9LAogIGFkZHByb2R1Y3Q6IGZ1bmN0aW9uIGFkZHByb2R1Y3QocHJvZHVjdCkgewogICAgdGhpcy50b3RhbF9wcm9kdWN0c19xdHkgPSAwOwogICAgdGhpcy5vdmVyX3F0eV93YXJuaW5nID0gZmFsc2U7CiAgICB2YXIgYXVkaW8gPSBuZXcgQXVkaW8oc291bmQpOwogICAgYXVkaW8ucGxheSgpOwogICAgdmFyIGNhcnQgPSAkKCcjY2Vuc2UtY2FydC1idG4nKTsKICAgIHZhciBjYXJ0X3F0eSA9ICQoJyNjYXJ0LXF0eS1udW0nKTsKICAgIHZhciBjYXJ0X2ltZyA9ICQoJyNjYXJ0LWltZycpOwoKICAgIGlmICh0aGlzLmFkZHRvQ2FydGRhdGEubGVuZ3RoICE9IDAgJiYgcHJvZHVjdC5idXlfcXR5ICE9PSAnJykgewogICAgICB2YXIgY2hlY2sgPSBmYWxzZTsKCiAgICAgIGZvciAodmFyIGkgaW4gdGhpcy5hZGR0b0NhcnRkYXRhKSB7CiAgICAgICAgaWYgKHRoaXMuYWRkdG9DYXJ0ZGF0YVtpXS5pZCA9PSBwcm9kdWN0LmlkKSB7CiAgICAgICAgICBjaGVjayA9IHRydWU7CiAgICAgICAgICB2YXIgYnV5ID0gcHJvZHVjdC5idXlfcXR5ICsgdGhpcy5hZGR0b0NhcnRkYXRhW2ldLm9yZGVyX3F0eTsKCiAgICAgICAgICBpZiAocHJvZHVjdC5zdG9ja19xdWFudGl0eSA+IHRoaXMuYWRkdG9DYXJ0ZGF0YVtpXS5vcmRlcl9xdHkgJiYgYnV5IDw9IHByb2R1Y3Quc3RvY2tfcXVhbnRpdHkpIHsKICAgICAgICAgICAgdGhpcy5hZGR0b0NhcnRkYXRhW2ldLm9yZGVyX3F0eSA9IGJ1eTsKICAgICAgICAgICAgcHJvZHVjdC5vcmRlcl9xdHkgPSAxOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBjYXJ0X3F0eS5hZGRDbGFzcygnY2FydC1xdHknKTsKICAgICAgICAgICAgICBjYXJ0X2ltZy5hZGRDbGFzcygnY2FydC1pbWcnKTsKICAgICAgICAgICAgICBjYXJ0LmFkZENsYXNzKCdzaGFrZScpOwogICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgY2FydF9xdHkucmVtb3ZlQ2xhc3MoJ2NhcnQtcXR5Jyk7CiAgICAgICAgICAgICAgICBjYXJ0X2ltZy5yZW1vdmVDbGFzcygnY2FydC1pbWcnKTsKICAgICAgICAgICAgICAgIGNhcnQucmVtb3ZlQ2xhc3MoJ3NoYWtlJyk7CiAgICAgICAgICAgICAgfSwgNTAwKTsKICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHByb2R1Y3Quc3RvY2tfcXVhbnRpdHkgPT0gbnVsbCkgewogICAgICAgICAgICB0aGlzLmFkZHRvQ2FydGRhdGFbaV0ub3JkZXJfcXR5ID0gYnV5OwogICAgICAgICAgICBwcm9kdWN0Lm9yZGVyX3F0eSA9IDE7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGNhcnRfcXR5LmFkZENsYXNzKCdjYXJ0LXF0eScpOwogICAgICAgICAgICAgIGNhcnRfaW1nLmFkZENsYXNzKCdjYXJ0LWltZycpOwogICAgICAgICAgICAgIGNhcnQuYWRkQ2xhc3MoJ3NoYWtlJyk7CiAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjYXJ0X3F0eS5yZW1vdmVDbGFzcygnY2FydC1xdHknKTsKICAgICAgICAgICAgICAgIGNhcnRfaW1nLnJlbW92ZUNsYXNzKCdjYXJ0LWltZycpOwogICAgICAgICAgICAgICAgY2FydC5yZW1vdmVDbGFzcygnc2hha2UnKTsKICAgICAgICAgICAgICB9LCA1MDApOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHByb2R1Y3Qub3JkZXJfcXR5ID0gMjsKICAgICAgICAgICAgdmFyIHJlcyA9IHByb2R1Y3Quc3RvY2tfcXVhbnRpdHkgLSB0aGlzLmFkZHRvQ2FydGRhdGFbaV0ub3JkZXJfcXR5OwogICAgICAgICAgICBwcm9kdWN0LmJ1eV9xdHkgPSByZXMgPT09IDAgPyAxIDogcmVzOwogICAgICAgICAgICB0aGlzLm92ZXJfcXR5X3dhcm5pbmcgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGNoZWNrICE9IHRydWUgJiYgKHByb2R1Y3QuYnV5X3F0eSA8PSBwcm9kdWN0LnN0b2NrX3F1YW50aXR5IHx8IHByb2R1Y3Quc3RvY2tfcXVhbnRpdHkgPT0gbnVsbCkpIHsKICAgICAgICB0aGlzLmFkZHRvQ2FydGRhdGEucHVzaCh7CiAgICAgICAgICBpZDogcHJvZHVjdC5pZCwKICAgICAgICAgIGltZ191cmw6IHByb2R1Y3QuaW1nX3VybCwKICAgICAgICAgIHByaWNlOiBwcm9kdWN0LnByaWNlLAogICAgICAgICAgc3RvY2tfcXVhbnRpdHk6IHByb2R1Y3Quc3RvY2tfcXVhbnRpdHksCiAgICAgICAgICBvcmRlcl9xdHk6IHByb2R1Y3QuYnV5X3F0eSwKICAgICAgICAgIGJ1eV9xdHk6IDEsCiAgICAgICAgICB2YXJpYW50X3RpdGxlOiBwcm9kdWN0LnZhcmlhbnRfdGl0bGUsCiAgICAgICAgICBzdG9ja19zdGF0dXM6IHByb2R1Y3Quc3RvY2tfc3RhdHVzLAogICAgICAgICAgdGl0bGU6IHByb2R1Y3QudGl0bGUKICAgICAgICB9KTsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNhcnRfcXR5LmFkZENsYXNzKCdjYXJ0LXF0eScpOwogICAgICAgICAgY2FydF9pbWcuYWRkQ2xhc3MoJ2NhcnQtaW1nJyk7CiAgICAgICAgICBjYXJ0LmFkZENsYXNzKCdzaGFrZScpOwogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNhcnRfcXR5LnJlbW92ZUNsYXNzKCdjYXJ0LXF0eScpOwogICAgICAgICAgICBjYXJ0X2ltZy5yZW1vdmVDbGFzcygnY2FydC1pbWcnKTsKICAgICAgICAgICAgY2FydC5yZW1vdmVDbGFzcygnc2hha2UnKTsKICAgICAgICAgIH0sIDUwMCk7CiAgICAgICAgfSwgMCk7CiAgICAgIH0gZWxzZSBpZiAoY2hlY2sgIT0gdHJ1ZSAmJiBwcm9kdWN0LmJ1eV9xdHkgPiBwcm9kdWN0LnN0b2NrX3F1YW50aXR5KSB7CiAgICAgICAgdGhpcy5vdmVyX3F0eV93YXJuaW5nID0gdHJ1ZTsKICAgICAgfQogICAgfSBlbHNlIGlmIChwcm9kdWN0LmJ1eV9xdHkgPD0gcHJvZHVjdC5zdG9ja19xdWFudGl0eSAmJiBwcm9kdWN0LmJ1eV9xdHkgIT09ICcnIHx8IHByb2R1Y3Quc3RvY2tfcXVhbnRpdHkgPT0gbnVsbCkgewogICAgICB0aGlzLmFkZHRvQ2FydGRhdGEucHVzaCh7CiAgICAgICAgaWQ6IHByb2R1Y3QuaWQsCiAgICAgICAgaW1nX3VybDogcHJvZHVjdC5pbWdfdXJsLAogICAgICAgIHByaWNlOiBwcm9kdWN0LnByaWNlLAogICAgICAgIHN0b2NrX3F1YW50aXR5OiBwcm9kdWN0LnN0b2NrX3F1YW50aXR5LAogICAgICAgIG9yZGVyX3F0eTogcHJvZHVjdC5idXlfcXR5LAogICAgICAgIGJ1eV9xdHk6IDEsCiAgICAgICAgdmFyaWFudF90aXRsZTogcHJvZHVjdC52YXJpYW50X3RpdGxlLAogICAgICAgIHN0b2NrX3N0YXR1czogcHJvZHVjdC5zdG9ja19zdGF0dXMsCiAgICAgICAgdGl0bGU6IHByb2R1Y3QudGl0bGUKICAgICAgfSk7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIGNhcnRfcXR5LmFkZENsYXNzKCdjYXJ0LXF0eScpOwogICAgICAgIGNhcnRfaW1nLmFkZENsYXNzKCdjYXJ0LWltZycpOwogICAgICAgIGNhcnQuYWRkQ2xhc3MoJ3NoYWtlJyk7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjYXJ0X3F0eS5yZW1vdmVDbGFzcygnY2FydC1xdHknKTsKICAgICAgICAgIGNhcnRfaW1nLnJlbW92ZUNsYXNzKCdjYXJ0LWltZycpOwogICAgICAgICAgY2FydC5yZW1vdmVDbGFzcygnc2hha2UnKTsKICAgICAgICB9LCA1MDApOwogICAgICB9LCAwKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMub3Zlcl9xdHlfd2FybmluZyA9IHRydWU7CiAgICB9CgogICAgZm9yICh2YXIgaiBpbiB0aGlzLmFkZHRvQ2FydGRhdGEpIHsKICAgICAgdGhpcy50b3RhbF9wcm9kdWN0c19xdHkgPSB0aGlzLnRvdGFsX3Byb2R1Y3RzX3F0eSArIHRoaXMuYWRkdG9DYXJ0ZGF0YVtqXS5vcmRlcl9xdHk7CiAgICB9CiAgfSwKICBzZWxlY3RlZF9wcm9kdWN0OiBmdW5jdGlvbiBzZWxlY3RlZF9wcm9kdWN0KHZhbHVlKSB7CiAgICBpZiAoZXZlbnQudGFyZ2V0LmNoZWNrZWQpIHsKICAgICAgaWYgKHZhbHVlID09ICJhbGwiKSB7CiAgICAgICAgdGhpcy5jaGVja2VkX2xpc3QgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgaSBpbiB0aGlzLnByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3QpIHsKICAgICAgICAgIHRoaXMuY2hlY2tlZF9saXN0LnB1c2godGhpcy5wcm9kdWN0X291dF9vZl9zdG9ja19saXN0W2ldKTsKICAgICAgICB9CgogICAgICAgICQoImlucHV0OmNoZWNrYm94IikucHJvcCgiY2hlY2tlZCIsIGZhbHNlKTsKCiAgICAgICAgZm9yICh2YXIgX2kyID0gMDsgX2kyIDwgdGhpcy5jaGVja2VkX2xpc3QubGVuZ3RoOyBfaTIrKykgewogICAgICAgICAgJCgiI3Byb2R1Y3RfY2hlY2tib3hfIiArIHRoaXMucHJvZHVjdF9vdXRfb2Zfc3RvY2tfbGlzdFtfaTJdLnByb2R1Y3RfaWQpLnByb3AoImNoZWNrZWQiLCB0cnVlKTsKICAgICAgICAgICQoIiNzZWxlY3RhbGwiKS5wcm9wKCJjaGVja2VkIiwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuY2hlY2tlZF9saXN0LnB1c2godmFsdWUpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKCFldmVudC50YXJnZXQuY2hlY2tlZCkgewogICAgICBpZiAodmFsdWUgIT0gImFsbCIpIHsKICAgICAgICB2YXIgc2VsZWN0YWxsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI3NlbGVjdGFsbCIpOwoKICAgICAgICBpZiAoc2VsZWN0YWxsLmNoZWNrZWQpIHsKICAgICAgICAgIHNlbGVjdGFsbC5jaGVja2VkID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB2YXIgdGVtcCA9IHRoaXMuY2hlY2tlZF9saXN0LmZpbHRlcihmdW5jdGlvbiAocHJvZHVjdF9pZCkgewogICAgICAgICAgcmV0dXJuIHByb2R1Y3RfaWQgIT0gdmFsdWU7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5jaGVja2VkX2xpc3QgPSB0ZW1wOwogICAgICB9IGVsc2UgewogICAgICAgICQoImlucHV0OmNoZWNrYm94IikucHJvcCgiY2hlY2tlZCIsIGZhbHNlKTsKCiAgICAgICAgZm9yICh2YXIgX2kzID0gMDsgX2kzIDwgdGhpcy5jaGVja2VkX2xpc3QubGVuZ3RoOyBfaTMrKykgewogICAgICAgICAgJCgiI3Byb2R1Y3RfY2hlY2tib3hfIiArIHRoaXMucHJvZHVjdF9vdXRfb2Zfc3RvY2tfbGlzdFtfaTNdLnByb2R1Y3RfaWQpLnByb3AoImNoZWNrZWQiLCBmYWxzZSk7CiAgICAgICAgICAkKCIjc2VsZWN0YWxsIikucHJvcCgiY2hlY2tlZCIsIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY2hlY2tlZF9saXN0ID0gW107CiAgICAgIH0KICAgIH0KICB9LAogIGNoZWNrX2N1cnJlbnRfcHJvZHVjdF9hY3RpdmU6IGZ1bmN0aW9uIGNoZWNrX2N1cnJlbnRfcHJvZHVjdF9hY3RpdmUoaW5kZXgpIHsKICAgIC8vIGNvbnNvbGUudGFibGUoaW5kZXgsIHRoaXMudGVtcGxhdGVsaXN0W2luZGV4XSwgdGhpcy5jdXJyZW50X3RlbXBsYXRlKTsKICAgIGlmIChCb29sZWFuKHRoaXMucHJvZHVjdF9vdXRfb2Zfc3RvY2tfbGlzdFtpbmRleF0pID09PSB0cnVlKSB7CiAgICAgIHJldHVybiB0aGlzLnByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3RbaW5kZXhdLnByb2R1Y3RfaWQgPT09IHRoaXMuY3VycmVudF9wcm9kdWN0LnByb2R1Y3RfaWQgPyAiY3VycmVudC1hY3RpdmUtdGVtcGxhdGUiIDogbnVsbDsKICAgIH0KICB9LAogIHNob3dfcHJvZHVjdDogZnVuY3Rpb24gc2hvd19wcm9kdWN0KGluZGV4KSB7CiAgICB0aGlzLmN1cnJlbnRfcHJvZHVjdCA9IHRoaXMucHJvZHVjdF9vdXRfb2Zfc3RvY2tfbGlzdFtpbmRleF07CiAgfSwKICBhZGRfdG9fb3V0X29mX3N0b2NrX2xpc3Q6IGZ1bmN0aW9uIGFkZF90b19vdXRfb2Zfc3RvY2tfbGlzdChpdGVtcykgewogICAgdGhpcy5wcm9kdWN0X291dF9vZl9zdG9ja19saXN0ID0gaXRlbXM7CiAgICB0aGlzLmNoZWNrZWRfbGlzdCA9IFtdOwogICAgJCgiaW5wdXQ6Y2hlY2tib3giKS5wcm9wKCJjaGVja2VkIiwgZmFsc2UpOwogIH0sCiAgc3VibWl0X291dF9vZl9zdG9ja19wcm9kdWN0czogZnVuY3Rpb24gc3VibWl0X291dF9vZl9zdG9ja19wcm9kdWN0cygpIHsKICAgIHZhciBfdGhpczEwID0gdGhpczsKCiAgICBpZiAodGhpcy5jaGVja2VkX2xpc3QubGVuZ3RoID09IDApIHsKICAgICAgc3dhbCh7CiAgICAgICAgdGV4dDogIlBsZWFzZSBzZWxlY3Qgc29tZSBwcm9kdWN0cyIsCiAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgcG9zaXRpb246ICJ0b3AtZW5kIiwKICAgICAgICB0eXBlOiAid2FybmluZyIsCiAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgIHRpbWVyOiAyNTAwCiAgICAgIH0pOwogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKHRoaXMuY3VzdG9tZXJfZW1haWwgPT0gIiIgfHwgIXRoaXMucmVnX2VtYWlsLnRlc3QodGhpcy5jdXN0b21lcl9lbWFpbCkpIHsKICAgICAgc3dhbCh7CiAgICAgICAgdGV4dDogIlBsZWFzZSBlbnRlciBhIHZhbGlkIGVtYWlsIGFkZHJlc3MiLAogICAgICAgIHRvYXN0OiB0cnVlLAogICAgICAgIHBvc2l0aW9uOiAidG9wLWVuZCIsCiAgICAgICAgdHlwZTogIndhcm5pbmciLAogICAgICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICB0aW1lcjogMjUwMAogICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHN3YWwoewogICAgICB0ZXh0OiAiUGxlYXNlIHdhaXQgd2hpbGUgd2UgYXJlIHN1Ym1pdHRpbmcgeW91ciBkZXRhaWxzLi4uIiwKICAgICAgdHlwZTogImluZm8iLAogICAgICB0b2FzdDogdHJ1ZSwKICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlCiAgICB9KTsKICAgIHRoaXMuc3Bpbm5lck9uID0gdHJ1ZTsKICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLm91dG9mc3RvY2tlbWFpbG5vdGlmaWNhdGlvbigpLCB7CiAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICBjb21wYW55X25hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgIGVtYWlsOiB0aGlzLmN1c3RvbWVyX2VtYWlsLAogICAgICBwcm9kdWN0X2xpc3Q6IHRoaXMuY2hlY2tlZF9saXN0LAogICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwKICAgIH0sIHsKICAgICAgaGVhZGVyczogewogICAgICAgIEF1dGhvcml6YXRpb246ICJCZWFyZXIgIi5jb25jYXQodGhpcy4kc2Vzc2lvbi5nZXQoImF0IikpCiAgICAgIH0KICAgIH0pLnRoZW4oZnVuY3Rpb24gKF9yZWYpIHsKICAgICAgdmFyIGRhdGEgPSBfcmVmLmRhdGE7CgogICAgICBpZiAoZGF0YS5tZXNzYWdlID09ICJRdWVyeSBFeGVjdXRlZCBTdWNjZXNzZnVsbHkiKSB7CiAgICAgICAgc3dhbCh7CiAgICAgICAgICB0eXBlOiAic3VjY2VzcyIsCiAgICAgICAgICB0ZXh0OiAiWW91J2xsIGJlIG5vdGlmaWVkIHRocm91Z2ggZW1haWwgd2hlbiB0aGUgcHJvZHVjdHMgZ2V0IGJhY2sgaW4gc3RvY2siLAogICAgICAgICAgdGltZXI6IDI1MDAKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgIF90aGlzMTAuY3VzdG9tZXJfZW1haWwgPSAiIjsKICAgICAgICAgIF90aGlzMTAuY2hlY2tlZF9saXN0ID0gW107CiAgICAgICAgICAkKCJpbnB1dDpjaGVja2JveCIpLnByb3AoImNoZWNrZWQiLCBmYWxzZSk7CiAgICAgICAgICAkKCIjbm90aWZ5ZW1haWwiKS5tb2RhbCgiaGlkZSIpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICBfdGhpczEwLnNwaW5uZXJPbiA9IGZhbHNlOwoKICAgICAgaWYgKGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MTAgfHwgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQ0MCB8fCBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA5KSB7CiAgICAgICAgX3RoaXMxMC4kcm9vdC4kZW1pdCgiU2Vzc2lvbl9FeHBpcmVkIiwgZS5yZXNwb25zZS5kYXRhKTsKICAgICAgfQogICAgfSk7CiAgfSwKICByZWZyZXNoX2NoYXRib3Q6IGZ1bmN0aW9uIHJlZnJlc2hfY2hhdGJvdCh0eXBlKSB7CiAgICB2YXIgX3RoaXMxMSA9IHRoaXM7CgogICAgdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkID0gdHJ1ZTsKICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgIGNoYXQ6ICIiLAogICAgICBkYXRhOiAiIiwKICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZAogICAgfSkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICBfdGhpczExLnJlZnJlc2hlZF9vcl9jbG9zZWQgPSBmYWxzZTsKICAgICAgdmFyIHdlbGNvbWVfbXNnX2NvbXBhbmllcyA9IFsiQ3VzdG9tZXJIYXBwaW5lc3M5NTE4NSIsICIzeDVpdmU5OTUzNCIsICJGb3JlaWdueGNoYW5nZTE3NDkxIiwgIjM2MF90ZWNobm9sb2d5Il07CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgey8vIGlmICh0aGlzLnNob3BpZnlfdWkgPT0gbnVsbCAmJiB0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJzaG9waWZ5IikgewogICAgICAgIC8vICAgdGhpcy5pbml0aWFsaXplX3Nob3BpZnlfdWkoKTsKICAgICAgICAvLyB9CiAgICAgIH0sIDEwMCk7CgogICAgICBpZiAodHlwZSA9PSAic3VwcG9ydCIpIHsKICAgICAgICBfdGhpczExLmNoYXQucHVzaCh7CiAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICByZWNlaXZlZDogIklzIHRoZXJlIGFueXRoaW5nIGVsc2UgSSBjYW4gaGVscCB5b3Ugd2l0aD8iLAogICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICB0aW1lOiBfdGhpczExLmdlbmVyYXRlX3RpbWUoKQogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAod2VsY29tZV9tc2dfY29tcGFuaWVzLmluY2x1ZGVzKF90aGlzMTEuY29tcGFueWlkKSkgewogICAgICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgY2hhdDogIi93ZWxjb21lX21lc3NhZ2UiLAogICAgICAgICAgdG9rZW46IF90aGlzMTEuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgdXNlcm5hbWU6IF90aGlzMTEuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICBsaWNlbnNlX2tleTogX3RoaXMxMS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgZGF0YTogIiIsCiAgICAgICAgICByb2xlOiBfdGhpczExLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IGZhbHNlCiAgICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgIF90aGlzMTEucHVzaF9tc2cocmVzcG9uc2UsIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzKTsgLy8gdGhpcy5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSk7CgogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIF90aGlzMTEud2VsY29tZV9tZXNzYWdlX25vdF95ZXRfcmVjZWl2ZWQgPSBmYWxzZTsKICAgICAgfQogICAgfSk7CiAgfSwKICBkb3dubG9hZF9maWxlOiBmdW5jdGlvbiBkb3dubG9hZF9maWxlKHVybCwgZmlsZV9uYW1lKSB7CiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgdmFyIGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICBsaW5rLmhyZWYgPSB1cmw7CiAgICBsaW5rLnNldEF0dHJpYnV0ZSgiZG93bmxvYWQiLCBmaWxlX25hbWUpOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChsaW5rKTsKICAgIGxpbmsuY2xpY2soKTsKICB9LAogIHNjcm9sbF9kaXY6IGZ1bmN0aW9uIHNjcm9sbF9kaXYoKSB7CiAgICB2YXIgZG9jID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmJ1eS1wcm9kdWN0cyIpOwoKICAgIGlmIChldmVudC5kZWx0YVggPiBldmVudC5kZWx0YVkpIHsKICAgICAgZG9jLnNjcm9sbExlZnQgKz0gMTA7CiAgICB9IGVsc2UgaWYgKGV2ZW50LmRlbHRhWCA8IGV2ZW50LmRlbHRhWSkgewogICAgICBkb2Muc2Nyb2xsTGVmdCAtPSAxMDsKICAgIH0KICB9LAogIHNjcm9sbF9kaXYxOiBmdW5jdGlvbiBzY3JvbGxfZGl2MShpdGVtKSB7CiAgICB2YXIgZG9jID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI2J1eV9wcm9kdWN0X2lkXyIuY29uY2F0KGl0ZW0pKTsKCiAgICBpZiAoZXZlbnQuZGVsdGFYID4gZXZlbnQuZGVsdGFZKSB7CiAgICAgIGRvYy5zY3JvbGxMZWZ0ICs9IDEwOwogICAgfSBlbHNlIGlmIChldmVudC5kZWx0YVggPCBldmVudC5kZWx0YVkpIHsKICAgICAgZG9jLnNjcm9sbExlZnQgLT0gMTA7CiAgICB9CiAgfSwKICBzY3JvbGxfZGl2X3JpZ2h0OiBmdW5jdGlvbiBzY3JvbGxfZGl2X3JpZ2h0KGl0ZW0pIHsKICAgIHZhciBkb2MgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjYnV5X3Byb2R1Y3RfaWRfIi5jb25jYXQoaXRlbSkpOwogICAgZG9jLnNjcm9sbExlZnQgKz0gMTAwOwogIH0sCiAgc2Nyb2xsX2Rpdl9sZWZ0OiBmdW5jdGlvbiBzY3JvbGxfZGl2X2xlZnQoaXRlbSkgewogICAgdmFyIGRvYyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNidXlfcHJvZHVjdF9pZF8iLmNvbmNhdChpdGVtKSk7CiAgICBkb2Muc2Nyb2xsTGVmdCAtPSAxMDA7CiAgfSwKICBjYWxsX3N1cHBvcnQ6IGZ1bmN0aW9uIGNhbGxfc3VwcG9ydCh0eXBlKSB7CiAgICB2YXIgX3RoaXMxMiA9IHRoaXM7CgogICAgaWYgKHR5cGUgPT0gIlllcyIpIHsKICAgICAgdmFyIF9heGlvcyRwb3N0MjsKCiAgICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgKF9heGlvcyRwb3N0MiA9IHsKICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgY2hhdDogIi9jYWxsX3N1cHBvcnQiCiAgICAgIH0sIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDIsICJ0b2tlbiIsIHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MiwgInJvbGUiLCB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSksIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDIsICJyZWZyZXNoZWRfb3JfY2xvc2VkIiwgdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkKSwgX2F4aW9zJHBvc3QyKSkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICAgIF90aGlzMTIuY2hhdC5wdXNoKHsKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgcmVjZWl2ZWQ6IHJlc3AuZGF0YS5yZXNwb25zZXNbMF0udGV4dCwKICAgICAgICAgIHRpbWU6IF90aGlzMTIuZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgfSk7IC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwoKCiAgICAgICAgX3RoaXMxMi51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAodHlwZSA9PSAiTm8iKSB7CiAgICAgIHRoaXMuY2hhdC5wdXNoKHRoaXMuY2hhdFswXSk7CiAgICAgIHRoaXMuY2hhdC5wdXNoKHRoaXMuY2hhdFsxXSk7CiAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsgLy8gdGhpcy5yZWZyZXNoX2NoYXRib3QoInN1cHBvcnQiKTsKICAgIH0KICB9LAogIHBhcnNlOiBmdW5jdGlvbiBwYXJzZShzdHJpbmcpIHsKICAgIHZhciBfdGhpczEzID0gdGhpczsKCiAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoL3t7Lio/fX0vZywgZnVuY3Rpb24gKG1hdGNoKSB7CiAgICAgIHZhciB0b2RheSA9IG5ldyBEYXRlKCk7CiAgICAgIHZhciBkZCA9IHRvZGF5LmdldERhdGUoKTsKICAgICAgdmFyIG1tID0gdG9kYXkuZ2V0TW9udGgoKSArIDE7CiAgICAgIHZhciB5eXl5ID0gdG9kYXkuZ2V0RnVsbFllYXIoKTsKCiAgICAgIGlmIChkZCA8IDEwKSB7CiAgICAgICAgZGQgPSAiMCIgKyBkZDsKICAgICAgfQoKICAgICAgaWYgKG1tIDwgMTApIHsKICAgICAgICBtbSA9ICIwIiArIG1tOwogICAgICB9CgogICAgICB0b2RheSA9IGRkICsgIi0iICsgbW0gKyAiLSIgKyB5eXl5OwogICAgICB2YXIgZXhwcmVzc2lvbiA9IG1hdGNoLnNsaWNlKDIsIC0yKTsKICAgICAgX3RoaXMxMy4kZGF0YVtleHByZXNzaW9uXSA9IHRvZGF5OwogICAgICByZXR1cm4gX3RoaXMxMy4kZGF0YVtleHByZXNzaW9uXTsKICAgIH0pOwogIH0sCiAgc2hvd19wb3B1cDogZnVuY3Rpb24gc2hvd19wb3B1cCgpIHsKICAgIHRoaXMuc2hvdyA9IGZhbHNlOwogICAgdGhpcy5zdG9wID0gZmFsc2U7CiAgfSwKICBzdWJfbGVhZl9ub2RlX2NhbGw6IGZ1bmN0aW9uIHN1Yl9sZWFmX25vZGVfY2FsbChkaXZjbGljaykgewogICAgdmFyIF90aGlzMTQgPSB0aGlzOwoKICAgIC8vIHZhciBkaXZjbGljayA9IGV2ZW50LnRhcmdldC5pbm5lclRleHQKICAgIGlmIChkaXZjbGljayA9PSAiV2F0Y2ggRGVtbyBWaWRlbyIpIHsKICAgICAgdGhpcy5kZW1vdXJsYmluZCA9IHRydWU7CiAgICAgIHRoaXMucmV2aWV3c3VybGJpbmQgPSBmYWxzZTsKICAgIH0gZWxzZSBpZiAoZGl2Y2xpY2sgPT0gIlVzZXIgUmV2aWV3cy9UZXN0aW1vbmlhbHMiKSB7CiAgICAgIHRoaXMucmV2aWV3c3VybGJpbmQgPSB0cnVlOwogICAgICB0aGlzLmRlbW91cmxiaW5kID0gZmFsc2U7CiAgICB9CgogICAgaWYgKGRpdmNsaWNrID09ICJXYXRjaCBEZW1vIFZpZGVvIiB8fCBkaXZjbGljayA9PSAiVXNlciBSZXZpZXdzL1Rlc3RpbW9uaWFscyIpIHsKICAgICAgdGhpcy5zaG93ID0gIXRoaXMuc2hvdzsKICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCk7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzMTQuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICB9LCAxMDAwKTsKICAgIH0gZWxzZSBpZiAoZGl2Y2xpY2sgPT0gIkJ1eSBUdXRvcmlhbCIpIHsKICAgICAgdGhpcy5jZW5zZV9lbnF1aXJ5ID0gdHJ1ZTsKICAgICAgYXhpb3MucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgY2hhdDogIi9wZXJzb25hbF9kZXRhaWxzIiwKICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogIiIKICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgcmVjZWl2ZWQ6IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLnRleHQsCiAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgIHRpbWU6IF90aGlzMTQuZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgfTsKCiAgICAgICAgX3RoaXMxNC5jaGF0LnB1c2gobXNnKTsKCiAgICAgICAgX3RoaXMxNC51cGRhdGVfc2Nyb2xsYmFyKCk7CgogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgX3RoaXMxNC5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgfSwgMTAwMCk7IC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICB9KTsKICAgIH0KICB9LAogIHRpY2tldF9udW1iZXI6IGZ1bmN0aW9uIHRpY2tldF9udW1iZXIoKSB7CiAgICB2YXIgcmFuZG9tX251bSA9IE1hdGguZmxvb3IoMTAwMDAwMCArIE1hdGgucmFuZG9tKCkgKiA5MDAwMDAwKTsKICAgIHZhciBjb21wYW55ID0gdGhpcy5jb21wYW55bmFtZS5zbGljZSgwLCAxKS50b1VwcGVyQ2FzZSgpOwogICAgcmV0dXJuICIiLmNvbmNhdChjb21wYW55LCAiXyIpLmNvbmNhdChyYW5kb21fbnVtKTsKICB9LAogIHNlbmRfbWVzc2FnZTogZnVuY3Rpb24gc2VuZF9tZXNzYWdlKHR5cGUsIG1lc3NhZ2UsIHRvX2JlX2Rpc3BsYXllZCkgewogICAgdmFyIF90aGlzMTUgPSB0aGlzOwoKICAgIC8vIGhhcnNoCiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgIGlmICh0aGlzLnNlbGVjdGVkX2luZGljYXRpb25bMF0gIT0gdW5kZWZpbmVkKSB7CiAgICAgIGlmICh0eXBlID09ICJpc19idXR0b24iKSB7CiAgICAgICAgdGhpcy50b19zZW5kID0gbWVzc2FnZS52YWx1ZSArIEpTT04uc3RyaW5naWZ5KHRoaXMucmVzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0eXBlID0gImlzX3Byb21wdCI7CiAgICAgICAgdG9fYmVfZGlzcGxheWVkID0gdGhpcy50b19zZW5kOwogICAgICAgIHRoaXMudG9fc2VuZCA9IHRoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvblswXS52YWx1ZS5zcGxpdCgieyIpWzBdICsgSlNPTi5zdHJpbmdpZnkodGhpcy5yZXMpOwogICAgICB9CiAgICB9CgogICAgaWYgKHR5cGUgPT0gImlzX2J1dHRvbiIpIHsKICAgICAgJCgiI3Jlc3BvbnNlX2JvdF90ZXh0IikucHJvcCgiZGlzYWJsZWQiLCBmYWxzZSk7CgogICAgICBpZiAobWVzc2FnZS52YWx1ZSA9PSAiaXNkaXNhYmxlZCIgJiYgdGhpcy5jb21wYW55aWQgPT0gImNsaW5pY2FsdHJpYWxzODEzNTIiICYmIG1lc3NhZ2UudGl0bGUgPT0gIk5vIikge30gZWxzZSBpZiAobWVzc2FnZS52YWx1ZSA9PT0gIi9saXZlX2NoYXQiKSB7CiAgICAgICAgdGhpcy5zdGFydF9saXZlX2NoYXQoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgdm0gPSB0aGlzOwoKICAgICAgICBmdW5jdGlvbiBfc2VuZF9tc2codG9TZW5kLCBjdXN0b21EaXNwbGF5TXNnKSB7CiAgICAgICAgICB2bS5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKICAgICAgICAgIHZtLmNoYXQucHVzaCh7CiAgICAgICAgICAgIHNlbnQ6IGN1c3RvbURpc3BsYXlNc2cgPyAiIi5jb25jYXQobWVzc2FnZS50aXRsZSwgIiAiKS5jb25jYXQoY3VzdG9tRGlzcGxheU1zZykgOiBtZXNzYWdlLnRpdGxlLAogICAgICAgICAgICBzZW5kaW5nOiB0cnVlLAogICAgICAgICAgICB0aW1lOiB2bS5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICBkZWxpdmVyZWQ6IHRydWUsCiAgICAgICAgICAgIGRyb3Bkb3duOiAiIgogICAgICAgICAgfSk7CiAgICAgICAgICB2bS51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJzZW5kZXIiKTsKCiAgICAgICAgICBpZiAodm0uY2hhdFt0b19iZV9kaXNwbGF5ZWRdICYmIHZtLmNoYXRbdG9fYmVfZGlzcGxheWVkXS5yZW1vdmFibGUgPT0gdHJ1ZSkgewogICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjY2hhdCIgKyB0b19iZV9kaXNwbGF5ZWQpLmNsYXNzTGlzdC5hZGQoIi0tZGVsZXRlIik7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHZtLmNoYXQuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgfSwgODUwKTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlc3BvbnNlX2JvdF90ZXh0IikuZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodm0uY2hhdFt0b19iZV9kaXNwbGF5ZWQgLSAxXSAmJiB2bS5jaGF0W3RvX2JlX2Rpc3BsYXllZCAtIDFdLmlzX211bHRpc2VsZWN0ICYmIChtZXNzYWdlLnRpdGxlID09ICJBcHByb3ZlIiB8fCBtZXNzYWdlLnRpdGxlID09ICJSZWplY3QiIHx8IG1lc3NhZ2UudGl0bGUgPT0gIkNvbW1lbnQgYW5kIFJldHVybiIpKSB7CiAgICAgICAgICAgIHZtLmNoYXRbdG9fYmVfZGlzcGxheWVkIC0gMV0uZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICBjaGF0OiB0b1NlbmQsCiAgICAgICAgICAgIHRva2VuOiB2bS5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIHVzZXJuYW1lOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICBsaWNlbnNlX2tleTogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgcm9sZTogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiB2bS5yZWZyZXNoZWRfb3JfY2xvc2VkCiAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICB2bS5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZtLnNlbGVjdGVkX2luZGljYXRpb24gPSBbXTsKICAgICAgICAgIHZtLnRvX3NlbmQgPSAiIjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNvbXBhbnlpZCA9PSAiMzYwX3RlY2hub2xvZ3kiKSB7CiAgICAgICAgICBpZiAodGhpcy5jaGF0W3RvX2JlX2Rpc3BsYXllZCAtIDFdICYmIHRoaXMuY2hhdFt0b19iZV9kaXNwbGF5ZWQgLSAxXS52YWx1ZV9tYXBwaW5nKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZU1hcHBpbmdEYXRhID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLmNoYXRbdG9fYmVfZGlzcGxheWVkIC0gMV0udmFsdWVfbWFwcGluZykpOwogICAgICAgICAgICB0aGlzLmFkZGRyb3Bkb3dudmFsdWUodmFsdWVNYXBwaW5nRGF0YSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgX3RoaXMxNS50b19zZW5kID0gbWVzc2FnZS52YWx1ZSArIEpTT04uc3RyaW5naWZ5KF90aGlzMTUucmVzKTsKCiAgICAgICAgICAgICAgaWYgKF90aGlzMTUuY2hhdFt0b19iZV9kaXNwbGF5ZWQgLSAxXS52YWx1ZV9tYXBwaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAodmFsdWVNYXBwaW5nRGF0YS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgX3NlbmRfbXNnKG1lc3NhZ2UudmFsdWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgX3NlbmRfbXNnKF90aGlzMTUudG9fc2VuZCwgImZvciAiLmNvbmNhdChfdGhpczE1LnNlbGVjdGVkX2luZGljYXRpb24ubWFwKGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JqLnRpdGxlOwogICAgICAgICAgICAgICAgICB9KS50b1N0cmluZygpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZS52YWx1ZS5zcGxpdCgieyIpLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGN1c3RvbURpc3BsYXlNc2cgPSBPYmplY3QudmFsdWVzKEpTT04ucGFyc2UoInsiLmNvbmNhdChtZXNzYWdlLnZhbHVlLnNwbGl0KCJ7IilbMV0pKSlbMF07CgogICAgICAgICAgICBfc2VuZF9tc2cobWVzc2FnZS52YWx1ZSwgImZvciAiLmNvbmNhdChjdXN0b21EaXNwbGF5TXNnKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2hhdFt0b19iZV9kaXNwbGF5ZWQgLSAxXSAmJiB0aGlzLmNoYXRbdG9fYmVfZGlzcGxheWVkIC0gMV0uc2hvd190ZXh0X2FyZWEpIHsKICAgICAgICAgICAgX3NlbmRfbXNnKG1lc3NhZ2UudmFsdWUpOwoKICAgICAgICAgICAgdGhpcy5jaGF0W3RvX2JlX2Rpc3BsYXllZCAtIDFdLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF9zZW5kX21zZyhtZXNzYWdlLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgX3NlbmRfbXNnKG1lc3NhZ2UudmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmICh0eXBlID09ICJpc19wcm9tcHQiKSB7CiAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICBzZW50OiB0b19iZV9kaXNwbGF5ZWQsCiAgICAgICAgc2VuZGluZzogdHJ1ZSwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICBkZWxpdmVyZWQ6IHRydWUKICAgICAgfSk7CiAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAic2VuZGVyIik7CiAgICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgIC8vIGhvc3Q6IHRoaXMudXNlcl9kYXRhLmhvc3QsCiAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgIGNoYXQ6IHRoaXMudG9fc2VuZAogICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgIF90aGlzMTUucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpOwoKICAgICAgICBfdGhpczE1LmV4MSgpOwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAodGhpcy50b19zZW5kID09ICJSZXN0YXJ0IiB8fCB0aGlzLnRvX3NlbmQgPT0gInJlc3RhcnQiKSB7CiAgICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLnByb21wdF91cmwoKSwgewogICAgICAgIHVpZDogImNlbnNlIiwKICAgICAgICAvLyB0aGlzLmZpbmdlcnByaW50CiAgICAgICAgY29tcGFueWlkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgIGNoYXQ6ICIiCiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgX3RoaXMxNS5jaGF0LnB1c2gocmVzcG9uc2UuZGF0YSk7CgogICAgICAgIF90aGlzMTUudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsgLy8gdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CgoKICAgICAgICBfdGhpczE1LmxldmVsID0gcmVzcG9uc2UuZGF0YS5sZXZlbDsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGUpIHt9KTsKICAgIH0gZWxzZSBpZiAodGhpcy5jZW5zZV9lbnF1aXJ5ID09IHRydWUgJiYgQm9vbGVhbih0aGlzLnRvX3NlbmQpKSB7CiAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgIHZhciBzZW5kX21zZyA9IHsKICAgICAgICBzZW50OiB0aGlzLnRvX3NlbmQsCiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgc2VuZGluZzogdHJ1ZSwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKQogICAgICB9OwogICAgICB0aGlzLmNoYXQucHVzaChzZW5kX21zZyk7IC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwoKICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIpOwogICAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICBjaGF0OiAiL3BlcnNvbmFsX2RldGFpbHMiLAogICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgQ29tcGFueWlkOiAiQ08wMDAyMyIsCiAgICAgICAgZGF0YTogIiIsCiAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogIiIsCiAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleQogICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICByZWNlaXZlZDogcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbMF0udGV4dCwKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgdGltZTogX3RoaXMxNS5nZW5lcmF0ZV90aW1lKCkKICAgICAgICB9OwoKICAgICAgICBfdGhpczE1LmNoYXQucHVzaChtc2cpOyAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKCgogICAgICAgIF90aGlzMTUucmVmcmVzaGVkX29yX2Nsb3NlZCA9IGZhbHNlOwoKICAgICAgICBfdGhpczE1LnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgX3RoaXMxNS5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgIH0pOwogICAgfSBlbHNlIGlmICh0aGlzLmxpdmVfY2hhdF9vbikgewogICAgICAvLyBMSVZFIENIQVQgT04gQ1VTVE9NRVIgTUVTU0FHRVMKICAgICAgaWYgKEJvb2xlYW4odGhpcy51c2VyX25hbWUpID09PSBmYWxzZSkgewogICAgICAgIHRoaXMuY2hhbm5lbC5wdXNoKCJuZXdfbmFtZSIsIHsKICAgICAgICAgIG5hbWU6IHRoaXMudG9fc2VuZAogICAgICAgIH0pOwogICAgICAgIHRoaXMudXNlcl9uYW1lID0gdGhpcy50b19zZW5kOwogICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmNoYW5uZWwucHVzaCgibmV3X25hbWUiLCB7CiAgICAgICAgICBuYW1lOiB0aGlzLnVzZXJfbmFtZQogICAgICAgIH0pOwogICAgICAgIHRoaXMuY2hhbm5lbC5wdXNoKCJuZXdfY2hhdF9tZXNzYWdlIiwgewogICAgICAgICAgbWVzc2FnZTogdGhpcy50b19zZW5kCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICB9CgogICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgc2VudDogdGhpcy50b19zZW5kLAogICAgICAgIHNlbmRpbmc6IHRydWUsCiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCkKICAgICAgfSk7IC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwoKICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJzZW5kZXIiKTsKICAgIH0gZWxzZSBpZiAoQm9vbGVhbih0aGlzLnRvX3NlbmQpICYmIHRoaXMuY2Vuc2VfZW5xdWlyeSAhPSB0cnVlKSB7CiAgICAgIHZhciBfYXhpb3MkcG9zdDM7CgogICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgc2VuZGluZzogdHJ1ZSwKICAgICAgICBzZW50OiB0aGlzLnRvX3NlbmQsCiAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCkKICAgICAgfSk7IC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwoKICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJzZW5kZXIiKTsKICAgICAgYXhpb3MucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCAoX2F4aW9zJHBvc3QzID0gewogICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICBjaGF0OiB0aGlzLnRvX3NlbmQKICAgICAgfSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MywgInRva2VuIiwgdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3QzLCAicm9sZSIsIHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MywgInJlZnJlc2hlZF9vcl9jbG9zZWQiLCB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQpLCBfYXhpb3MkcG9zdDMpKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgIF90aGlzMTUucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpOwogICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICAgIF90aGlzMTUudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgfSk7CiAgICB9CgogICAgdGhpcy50b19zZW5kID0gIiI7CiAgfSwKICBpbml0aWF0ZV9zdXBwb3J0X2NoYXQ6IGZ1bmN0aW9uIGluaXRpYXRlX3N1cHBvcnRfY2hhdCgpIHsKICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICByZWNlaXZlZDogIlNvcnJ5IEkgYW0gbm90IGdldHRpbmcgeW91ciBxdWVzdGlvbiIsCiAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlCiAgICB9KTsKICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICByZWNlaXZlZDogIldvdWxkIHlvdSBsaWtlIHRvIHRhbGsgd2l0aCBzdXBwb3J0IHRlYW0/IiwKICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgIHNob3dfYnV0dG9uczogdHJ1ZSwKICAgICAgc3VwcG9ydF9idXR0b25zOiB0cnVlLAogICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKQogICAgfSk7CiAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgfSwKICBkaXNjb25uZWN0X3N1cHBvcnRfY2hhdDogZnVuY3Rpb24gZGlzY29ubmVjdF9zdXBwb3J0X2NoYXQoKSB7CiAgICB0aGlzLmNoYW5uZWwucHVzaCgic3RvcHBlZF9jaGF0IiwgewogICAgICBuYW1lOiB0aGlzLnVzZXJfbmFtZSwKICAgICAgbWVzc2FnZTogIiBoYXMgZW5kZWQgdGhlIGNvbnZlcnNhdGlvbi4iCiAgICB9KTsKICAgIHRoaXMuY2hhbm5lbC5sZWF2ZSgpOwogICAgdGhpcy5saXZlX2NoYXRfdG9rZW4gPSBudWxsOwogICAgdGhpcy5jaGF0X2dyb3VwX25hbWUgPSBudWxsOwogICAgdGhpcy51c2VyX25hbWUgPSAiIjsKICAgIHRoaXMuY2hhdF9zb2NrZXQuZGlzY29ubmVjdCgpOwogICAgdGhpcy5saXZlX2NoYXRfb24gPSBmYWxzZTsKICB9LAogIGdlbmVyYXRlX3BheW1lbnQ6IGZ1bmN0aW9uIGdlbmVyYXRlX3BheW1lbnQocHJpY2UsIG5hbWUpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAga2V5OiAicnpwX3Rlc3RfU25EVGFQbm5jZmxpRHQiLAogICAgICBhbW91bnQ6IHByaWNlICogMTAwLAogICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgY29tcGFueV9uYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lLAogICAgICBuYW1lOiAiQ2Vuc2UgQUkiLAogICAgICBjdXJyZW5jeTogIklOUiIsCiAgICAgIGRlc2NyaXB0aW9uOiAiSW5zdGlsbCBJbnRlbGxpZ2VuY2UiLAogICAgICBpbWFnZTogIi9pbWcvY2Vuc2VfaW1hZ2UucG5nIiwKICAgICAgLy8gQ09NUEFOWSBMT0dPCiAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIGhhbmRsZXIocmVzcG9uc2UpIHsKICAgICAgICB2YXIgY29udGFjdCA9ICQoJyNjb250YWN0W3R5cGU9InRlbCJdJykudmFsdWU7CiAgICAgICAgdmFyIGVtYWlsID0gJCgnI2VtYWlsW3R5cGU9ImVtYWlsIl0nKS52YWx1ZTsKICAgICAgICB2bS5wYXltZW50aWQgPSByZXNwb25zZS5yYXpvcnBheV9wYXltZW50X2lkOwoKICAgICAgICBpZiAodHJhbnNmZXJfYWNjb3VudCAhPSBudWxsKSB7CiAgICAgICAgICB2bS50cmFuc2Zlcl9wYXltZW50KHRyYW5zZmVyX2FjY291bnQsIHByaWNlICogMTAwLCAiSU5SIiwgbmFtZSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVmaWxsOiB7CiAgICAgICAgbmFtZTogIiIsCiAgICAgICAgLy8gcGFzcyBjdXN0b21lciBuYW1lCiAgICAgICAgZW1haWw6ICIiLAogICAgICAgIC8vIGN1c3RvbWVyIGVtYWlsCiAgICAgICAgY29udGFjdDogIiIgLy8gY3VzdG9tZXIgcGhvbmUgbm8uCgogICAgICB9LAogICAgICBub3RlczogewogICAgICAgIGFkZHJlc3M6ICJhZGRyZXNzIiAvLyBjdXN0b21lciBhZGRyZXNzCgogICAgICB9LAogICAgICB0aGVtZTogewogICAgICAgIGNvbG9yOiAiIzI4Mzc3NyIgLy8gc2NyZWVuIGNvbG9yCgogICAgICB9CiAgICB9OwogICAgdmFyIHJ6cDEgPSBuZXcgUmF6b3JwYXkob3B0aW9ucyk7CiAgICByenAxLm9wZW4oKTsKICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgfSwKICBjaGF0X3Jlc3BvbnNlX2Vycm9yOiBmdW5jdGlvbiBjaGF0X3Jlc3BvbnNlX2Vycm9yKCkgewogICAgdGhpcy5jaGF0LnB1c2goewogICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICByZWNlaXZlZDogIlNvcnJ5IEknbSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uIiwKICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCkKICAgIH0pOyAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKCiAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgfSwKICBzZW5kX3JlcXVlc3RfanNvbjogZnVuY3Rpb24gc2VuZF9yZXF1ZXN0X2pzb24obWVzc2FnZSkgewogICAgdmFyIF9heGlvcyRwb3N0NCwKICAgICAgICBfdGhpczE2ID0gdGhpczsKCiAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIChfYXhpb3MkcG9zdDQgPSB7CiAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbAogICAgfSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0NCwgInRva2VuIiwgdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3Q0LCAicm9sZSIsIHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0NCwgInJlZnJlc2hlZF9vcl9jbG9zZWQiLCB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3Q0LCAiY2hhdCIsICIiKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0NCwgInNvdXJjZSIsICJXZWIiKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0NCwgImRhdGEiLCB0aGlzLmpzb25fZGF0YVttZXNzYWdlLnJlc3BvbnNlc1swXS5pbnRlbnRdKSwgX2F4aW9zJHBvc3Q0KSkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICBfdGhpczE2LmNoYXQucHVzaCh7CiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgIHJlY2VpdmVkOiByZXNwLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA9PSAwID8gIlNvcnJ5IEknbSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uIiA6IHJlc3AuZGF0YS5yZXNwb25zZXNbMF0udGV4dCwKICAgICAgICB0aW1lOiBfdGhpczE2LmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICBpbWFnZTogcmVzcC5kYXRhLnJlc3BvbnNlc1swXS5pbWcgPT0gIiIgPyBudWxsIDogcmVzcC5kYXRhLnJlc3BvbnNlc1swXS5pbWcKICAgICAgfSk7IC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwoKCiAgICAgIF90aGlzMTYudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgIH0pOwogIH0sCiAgcmVzcG9uc2VfaGFuZGxpbmc6IGZ1bmN0aW9uIHJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlLCB0eXBlKSB7CiAgICB2YXIgaSA9IDA7CiAgICB2YXIgZGVsYXkgPSA1MDsgLy8gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCAhPSB1bmRlZmluZWQgPyA1MDAKICAgIC8vIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQubGVuZ3RoID4gMTAKICAgIC8vICAgPyA1MDAKICAgIC8vICAgOiA1MDA7CgogICAgdmFyIHZtID0gdGhpczsKICAgIHZtLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGhhbmRsZV9yZXNwb25zZSgpOwogICAgfSwgZGVsYXkpOwoKICAgIGZ1bmN0aW9uIGhhbmRsZV9yZXNwb25zZSgpIHsKICAgICAgdmFyIF90aGlzMTcgPSB0aGlzOwoKICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgdm0uaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwoKICAgICAgICBpZiAocmVzcG9uc2UuZGF0YSA9PSBudWxsIHx8IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICB2bS5jaGF0X3Jlc3BvbnNlX2Vycm9yKCk7CiAgICAgICAgfSBlbHNlIGlmIChCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnJlcXVlc3RfanNvbikgPT0gdHJ1ZSkgewogICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQgIT0gbnVsbCkgewogICAgICAgICAgICB2bS5jaGF0LnB1c2goewogICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgICByZWNlaXZlZDogcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCwKICAgICAgICAgICAgICB0aW1lOiB2bS5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICAgICAgaW1hZ2U6IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmltZywKICAgICAgICAgICAgICB2aWRlbzogcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udmlkZW8KICAgICAgICAgICAgfSk7IC8vIHZtLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdm0uY2hhdCk7CgogICAgICAgICAgICB2bS51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQgPT0gImdvZ3liNDUwX2NyZWF0ZV90aWNrZXQiKSB7CiAgICAgICAgICAgIHZhciBfYXhpb3MkcG9zdDU7CgogICAgICAgICAgICB2YXIgbmFtZSA9ICIiLmNvbmNhdCh2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmZpcnN0X25hbWUsICIgIikuY29uY2F0KHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGFzdF9uYW1lKTsKICAgICAgICAgICAgdmFyIHBheWxvYWQgPSB7CiAgICAgICAgICAgICAgdXNlcm5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgY29tcGFueW5hbWU6IHZtLmNvbXBhbnluYW1lLAogICAgICAgICAgICAgIGNvbXBhbnlpZDogdm0uY29tcGFueWlkLAogICAgICAgICAgICAgIHVzZXJfcm9sZTogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgICAgIGVtYWlsOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgIHRva2VuOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnRva2VucywKICAgICAgICAgICAgICB0aWNrZXRfaXNzdWU6ICIiLAogICAgICAgICAgICAgIHRpY2tldF9udW1iZXI6IHZtLnRpY2tldF9udW1iZXIoKSwKICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogIiIsCiAgICAgICAgICAgICAgZmlsZV9jb250ZW50OiBudWxsLAogICAgICAgICAgICAgIGZpbGVfbmFtZTogbnVsbCwKICAgICAgICAgICAgICBpc0VkaXQ6IGZhbHNlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeShwYXlsb2FkKTsKICAgICAgICAgICAgYXhpb3MucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCAoX2F4aW9zJHBvc3Q1ID0gewogICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgIHRva2VuOiB2bS5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgdXNlcm5hbWU6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwKICAgICAgICAgICAgfSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0NSwgInRva2VuIiwgdm0uYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0NSwgInJvbGUiLCB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3Q1LCAicmVmcmVzaGVkX29yX2Nsb3NlZCIsIHZtLnJlZnJlc2hlZF9vcl9jbG9zZWQpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3Q1LCAiY2hhdCIsICIiKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0NSwgInNvdXJjZSIsICJXZWIiKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0NSwgImRhdGEiLCBwYXlsb2FkKSwgX2F4aW9zJHBvc3Q1KSkudGhlbihmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgICAgIHZtLmNoYXQucHVzaCh7CiAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgIHJlY2VpdmVkOiByZXNwLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA9PSAwID8gIlNvcnJ5IEknbSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uIiA6IHJlc3AuZGF0YS5yZXNwb25zZXNbaV0udGV4dCwKICAgICAgICAgICAgICAgIHRpbWU6IHZtLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgICAgIGltYWdlOiByZXNwLmRhdGEucmVzcG9uc2VzW2ldLmltZywKICAgICAgICAgICAgICAgIHZpZGVvOiByZXNwLmRhdGEucmVzcG9uc2VzW2ldLnZpZGVvIHx8IG51bGwKICAgICAgICAgICAgICB9KTsgLy8gdm0uJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB2bS5jaGF0KTsKCiAgICAgICAgICAgICAgdm0ubmV3X3VwZGF0ZV9yZXNwb25zZShpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmludGVudCA9PSAiY3JlYXRlX2FwcG9pbnRtZW50IikgewogICAgICAgICAgICB2YXIgdG9kYXlfZGF0ZSA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLnNjaGVkdWxlX2FwcG9pbnRtZW50X3VybCgpLCB7CiAgICAgICAgICAgICAgY29tcGFueW5hbWU6IHZtLmNvbXBhbnluYW1lLAogICAgICAgICAgICAgIGNvbXBhbnlpZDogdm0uY29tcGFueWlkLAogICAgICAgICAgICAgIERhdGU6IHRvZGF5X2RhdGUuZ2V0RnVsbFllYXIoKSArICItIiArICh0b2RheV9kYXRlLmdldE1vbnRoKCkgPCA5ID8gIjAiICsgKHRvZGF5X2RhdGUuZ2V0TW9udGgoKSArIDEpIDogdG9kYXlfZGF0ZS5nZXRNb250aCgpICsgMSkgKyAiLSIgKyB0b2RheV9kYXRlLmdldERhdGUoKSAvLyBNb250aCBvYmplY3QgZG9jdW1lbnQgaXQKICAgICAgICAgICAgICAvLyBEYXRlOiBzdGFydF90aW1lLAoKICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsvLyBjb25zb2xlLmxvZyhyZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgICAvLyB0aGlzLnRpbWVfc2xvdHMgPSB0aGlzLmZ1bGxfdGltZV9zbG90czsKICAgICAgICAgICAgICAvLyBpZiAocmVzcG9uc2UuZGF0YS5TbG90ICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIC8vICAgaWYgKHJlc3BvbnNlLmRhdGEuU2xvdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgLy8gICAgIGxldCBpbmRleDsKICAgICAgICAgICAgICAvLyAgICAgZm9yICh2YXIgaSBpbiByZXNwb25zZS5kYXRhLlNsb3QpIHsKICAgICAgICAgICAgICAvLyAgICAgICBpbmRleCA9IHRoaXMudGltZV9zbG90cy5pbmRleE9mKHJlc3BvbnNlLmRhdGEuU2xvdFtpXSk7CiAgICAgICAgICAgICAgLy8gICAgICAgaWYgKGluZGV4ICE9IC0xKSB7CiAgICAgICAgICAgICAgLy8gICAgICAgICB0aGlzLnRpbWVfc2xvdHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgICAvLyAgICAgICB9CiAgICAgICAgICAgICAgLy8gICAgIH0KICAgICAgICAgICAgICAvLyAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gICB9CiAgICAgICAgICAgICAgLy8gfQogICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZtLnNlbmRfcmVxdWVzdF9qc29uKHJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW50ZW50ID09ICJyZV9vcmRlcl9wcm9kdWN0c19hY3Rpb24iKSB7CiAgICAgICAgICAvLyB2bS5zZW5kX3Nob3BpZnlfY3VzdG9tZXJfaWQoKTsKICAgICAgICAgIHZhciBfbXNnID0gewogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgdGltZTogaSA9PSByZXNwb25zZS5kYXRhLnJlc3BvbnNlcy5sZW5ndGggLSAxID8gdm0uZ2VuZXJhdGVfdGltZSgpIDogbnVsbCwKICAgICAgICAgICAgYXNrX2ZlZWRiYWNrOiBCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmFza19mZWVkYmFjaykKICAgICAgICAgIH07CiAgICAgICAgICBfbXNnLnJlY2VpdmluZyA9IHRydWU7CiAgICAgICAgICBfbXNnLmZldGNoX3Nob3BpZnlfZGV0YWlscyA9IHRydWU7CiAgICAgICAgICBfbXNnLmlzX3JlZnVuZCA9IGZhbHNlOwogICAgICAgICAgX21zZy5yZXR1cm5fc2hvcGlmeV9lbWFpbCA9IHRydWU7CiAgICAgICAgICBfbXNnLnJlY2VpdmVkID0gIlBsZWFzZSBsb2dpbiB3aXRoIHlvdXIgY3JlZGVudGlhbHMgZm9yIGJldHRlciBleHBlcmllbmNlIDopIjsKICAgICAgICAgIF9tc2cubWV0YWRhdGEgPSB7CiAgICAgICAgICAgIGVudGl0eTogcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uZW50aXR5LAogICAgICAgICAgICB0ZXh0OiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0CiAgICAgICAgICB9OwogICAgICAgICAgdm0uY2hhdC5wdXNoKF9tc2cpOyAvLyB2bS5zZW5kX3Nob3BpZnlfY3VzdG9tZXJfaWQobnVsbCxmYWxzZSxyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXSk7CiAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQgPT0gInN1cHBvcnRfc3Vic2NyaXB0aW9uX2RhdGEiKSB7CiAgICAgICAgICAvLyB2bS5zZW5kX3Nob3BpZnlfY3VzdG9tZXJfaWQoKTsKICAgICAgICAgIHZtLnN1cHBvcnRfc3Vic2NyaXB0aW9uX2RhdGEoKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmludGVudCA9PSAicHJvZHVjdF9ieV9kYXRlIikgewogICAgICAgICAgdmFyIF9heGlvcyRwb3N0NjsKCiAgICAgICAgICB2bS5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKICAgICAgICAgIHZhciBjdXRvZmYgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgdmFyIGN1cnJlbnRfZGF0ZV90aW1lID0gbW9tZW50KGN1dG9mZikuZm9ybWF0KCJZWVlZLU1NLUREIEhIOm1tOnNzIik7CiAgICAgICAgICB2YXIgZm9ybV9wYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICB1c3JfbXNnOiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS51c3JfbXNnLAogICAgICAgICAgICBjdXJyZW50X3VzZXJfZGF0ZTogY3VycmVudF9kYXRlX3RpbWUKICAgICAgICAgIH0pOwogICAgICAgICAgYXhpb3MucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCAoX2F4aW9zJHBvc3Q2ID0gewogICAgICAgICAgICBsaWNlbnNlX2tleTogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHZtLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgdXNlcm5hbWU6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwKICAgICAgICAgIH0sIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDYsICJ0b2tlbiIsIHZtLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSksIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDYsICJyb2xlIiwgdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0NiwgInJlZnJlc2hlZF9vcl9jbG9zZWQiLCB2bS5yZWZyZXNoZWRfb3JfY2xvc2VkKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0NiwgImNoYXQiLCAiL3Byb2R1Y3RfYnlfZGF0ZSIuY29uY2F0KGZvcm1fcGF5bG9hZCkpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3Q2LCAic291cmNlIiwgIldlYiIpLCBfYXhpb3MkcG9zdDYpKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICB2bS5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ucmV0dXJuX2ludGVudCkgPT0gdHJ1ZSkgewogICAgICAgICAgdmFyIF9heGlvcyRwb3N0NzsKCiAgICAgICAgICBfdGhpczE3LmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICAgICAgYXhpb3MucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCAoX2F4aW9zJHBvc3Q3ID0gewogICAgICAgICAgICBsaWNlbnNlX2tleTogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHZtLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgdXNlcm5hbWU6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwKICAgICAgICAgIH0sIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDcsICJ0b2tlbiIsIHZtLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSksIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDcsICJyb2xlIiwgdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0NywgInJlZnJlc2hlZF9vcl9jbG9zZWQiLCB2bS5yZWZyZXNoZWRfb3JfY2xvc2VkKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0NywgImNoYXQiLCAiLyIgKyByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3Q3LCAic291cmNlIiwgIldlYiIpLCBfYXhpb3MkcG9zdDcpKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICB2bS5oYW5kbGVfcmVzcG9uc2UocmVzcG9uc2UpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmICh2bS5jb21wYW55aWQgPT0gIjN4NWl2ZTk5NTM0IiAmJiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQgIT0gdW5kZWZpbmVkICYmIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmludGVudCA9PSAiY29uZnVzaW9uIikgewogICAgICAgICAgdm0uY29uZnVzaW9uX21lc3NhZ2UoIi9uZWVkX2hlbHAiKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmJ1dHRvbnMgIT0gdW5kZWZpbmVkICYmIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmJ1dHRvbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgdm0ubG9hZF9idXR0b25zKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLCBpLCB0eXBlKTsKICAgICAgICB9IGVsc2UgaWYgKEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY3VzdG9tKSAmJiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20udHlwZSkgewogICAgICAgICAgLy8gQ0hhbmdlICB0aGUgY29uZGl0aW9uIGhlcmUKICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20udHlwZSAhPSB1bmRlZmluZWQgJiYgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY3VzdG9tLnR5cGUgPT0gIm11bHRpc2VsZWN0X2Ryb3Bkb3duIikgewogICAgICAgICAgICB2bS5tdWx0aXNlbGVjdF9sb2FkKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLCBpKTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY3VzdG9tLnR5cGUgIT0gdW5kZWZpbmVkICYmIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmN1c3RvbS50eXBlID09ICJ0YWJsZSIpIHsKICAgICAgICAgICAgdm0ubG9hZF90YWJsZShyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXSwgaSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmN1c3RvbS50eXBlICE9IHVuZGVmaW5lZCAmJiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20udHlwZSA9PSAicmV0YWlsIikgewogICAgICAgICAgICB2bS5kaXNwbGF5X3Byb2R1Y3RzX2NoYXQocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0sIGksIHR5cGUpOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20uc2hvd190ZXh0X2FyZWEpIHsKICAgICAgICAgICAgdm0ubG9hZF90ZXh0X2FyZWEocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0sIGkpOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20uYnV0dG9ucyAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdm0ubG9hZF9idXR0b25zKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmN1c3RvbSwgaSwgdHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLm1lc3NhZ2luZ19wbGF0Zm9ybXMpICYmIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLm1lc3NhZ2luZ19wbGF0Zm9ybXMubGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgLy8gY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgIHRpbWU6IGkgPT0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXMubGVuZ3RoIC0gMSA/IHZtLmdlbmVyYXRlX3RpbWUoKSA6IG51bGwsCiAgICAgICAgICAgIGFza19mZWVkYmFjazogQm9vbGVhbihyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5hc2tfZmVlZGJhY2spLAogICAgICAgICAgICBzaG93X21lc3NhZ2luZ19wbGF0Zm9ybXM6IHRydWUsCiAgICAgICAgICAgIC8vIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgLy8gcmVjZWl2ZWQ6IlBsZWFzZSBmZWVsIGZyZWUgdG8gcmVhY2hvdXQgdG8gdXMgYXQgOiAiICsgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY29udGFjdF91c19lbWFpbCAgKyB2bS5jb250YWN0X3VzX3Bob25lX251bWJlcihyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jb250YWN0X3VzX3Bob25lX251bWJlcikgKyIgb3IgZHJvcCB1cyBhIG1lc3NhZ2UiLAogICAgICAgICAgICBtZXNzYWdpbmdfcGxhdGZvcm1zX2RhdGE6IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLm1lc3NhZ2luZ19wbGF0Zm9ybXMKICAgICAgICAgIH07CiAgICAgICAgICB2bS5jaGF0LnB1c2gobXNnKTsKICAgICAgICB9IGVsc2UgaWYgKEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaXNfcHJldmlld19iYW5uZXIpKSB7CiAgICAgICAgICB2bS5kaXNwbGF5X2Jhbm5lcihyZXNwb25zZS5kYXRhLnJlc3BvbnNlcywgaSk7CiAgICAgICAgfSBlbHNlIGlmIChCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmlzX2Rpc3BsYXlfYmFubmVyKSkgewogICAgICAgICAgdm0uZGlzcGxheV9iYW5uZXIocmVzcG9uc2UuZGF0YS5yZXNwb25zZXMsIGkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgdGltZTogaSA9PSByZXNwb25zZS5kYXRhLnJlc3BvbnNlcy5sZW5ndGggLSAxID8gdm0uZ2VuZXJhdGVfdGltZSgpIDogbnVsbCwKICAgICAgICAgICAgYXNrX2ZlZWRiYWNrOiBCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmFza19mZWVkYmFjaykKICAgICAgICAgIH07CgogICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIG1zZy5yZWNlaXZlZCA9ICJTb3JyeSB3ZSBhcmUgbm90IGdldHRpbmcgeW91ciBxdWVzdGlvbi4iOwogICAgICAgICAgICBtc2cucmVjZWl2aW5nID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGVtcGxhdGUgPT09ICJ1dHRlcl9kZWZhdWx0IikgewogICAgICAgICAgICBtc2cucmVjZWl2aW5nID0gdHJ1ZTsKICAgICAgICAgICAgbXNnLnJlY2VpdmVkID0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ubWVzc2FnZS5zcGxpdCgne2VtYWlsfScpLmpvaW4odm0uY29udGFjdF9oZWxwX2VtYWlsKTsKICAgICAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQgIT0gdW5kZWZpbmVkICYmIHZtLnVybF9tYXRjaF9yZWdleC50ZXN0KHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQpKSB7CiAgICAgICAgICAgIHZtLmRpc3BsYXlfZmlsZV9jaGF0KHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQpOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5nZXRfY29tcGFueV9kZXRhaWxzID09PSAiVHJ1ZSIgJiYgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW50ZW50ID09PSAiY2Vuc2Vfc3VwcG9ydF90aWNrZXQiKSB7CiAgICAgICAgICAgIHZhciBfYXhpb3MkcG9zdDg7CgogICAgICAgICAgICB2YXIgY19pZCA9IHZtLnJldHVybl9kb2N1bWVudF9jb29raWVzKCdjb21wYW55X2lkJyk7CiAgICAgICAgICAgIHZhciBjX25hbWUgPSB2bS5yZXR1cm5fZG9jdW1lbnRfY29va2llcygnY29tcGFueV9uYW1lJyk7CiAgICAgICAgICAgIHZhciBjX2VtYWlsID0gdm0ucmV0dXJuX2RvY3VtZW50X2Nvb2tpZXMoJ2NvbXBhbnlfZW1haWwnKTsKICAgICAgICAgICAgYXhpb3MucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCAoX2F4aW9zJHBvc3Q4ID0gewogICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgIHRva2VuOiB2bS5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgdXNlcm5hbWU6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwKICAgICAgICAgICAgfSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0OCwgInRva2VuIiwgdm0uYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0OCwgInJvbGUiLCB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3Q4LCAicmVmcmVzaGVkX29yX2Nsb3NlZCIsIHZtLnJlZnJlc2hlZF9vcl9jbG9zZWQpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3Q4LCAiY2hhdCIsIEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICBjb21wYW55X2lkOiBjX2lkLAogICAgICAgICAgICAgIGNvbXBhbnlfbmFtZTogY19uYW1lLAogICAgICAgICAgICAgIGVtYWlsOiBjX2VtYWlsCiAgICAgICAgICAgIH0pKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0OCwgInNvdXJjZSIsICJXZWIiKSwgX2F4aW9zJHBvc3Q4KSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICB2bS5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0ICE9IHVuZGVmaW5lZCAmJiAhcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dC5pbmNsdWRlcygiRG93bmxvYWQgeW91ciBtYW5pZmVzdCBoZXJlIikpIHsKICAgICAgICAgICAgbXNnLnJlY2VpdmVkID0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dDsKICAgICAgICAgICAgbXNnLnJlY2VpdmluZyA9IHRydWU7CiAgICAgICAgICAgIG1zZy5pbWFnZSA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmltZzsKICAgICAgICAgICAgbXNnLmltYWdlID0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW1hZ2U7CiAgICAgICAgICAgIG1zZy52aWRlb3MgPSByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS52aWRlbyB8fCBmYWxzZTsKICAgICAgICAgICAgbXNnLm9yZGVyX3N0YXR1cyA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLm9yZGVyX3N0YXR1czsKICAgICAgICAgICAgbXNnLmlzX29yZGVyX3N0YXR1cyA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmlzX29yZGVyX3N0YXR1cyB8fCBmYWxzZTsKICAgICAgICAgICAgbXNnLm9mZmVycyA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLm9mZmVycyB8fCBmYWxzZTsKICAgICAgICAgICAgbXNnLmZldGNoX3Nob3BpZnlfZGV0YWlscyA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmZldGNoX3Nob3BpZnlfZGV0YWlscyB8fCBmYWxzZTsKICAgICAgICAgICAgbXNnLm9yZGVyX2l0ZW1zID0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ub3JkZXJfaXRlbXM7CiAgICAgICAgICAgIG1zZy5zaG9waWZ5X2ZldGNoX2N1c3RvbWVyX2lkX2Zvcl9vZmZlcnMgPSByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5zaG9waWZ5X2ZldGNoX2N1c3RvbWVyX2lkX2Zvcl9vZmZlcnMgfHwgZmFsc2U7IC8vIGlmIChtc2cuc2hvcGlmeV9mZXRjaF9jdXN0b21lcl9pZF9mb3Jfb2ZmZXJzID09PSB0cnVlKSB7CiAgICAgICAgICAgIC8vICAgdm0uc2hvcGlmeV9jaGVja19jdXN0b21lcl9sb2dnZWRfaW4oKTsKICAgICAgICAgICAgLy8gICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgLy8gfQoKICAgICAgICAgICAgaWYgKG1zZy5vZmZlcnMubGVuZ3RoIDwgMSkgewogICAgICAgICAgICAgIG1zZy5vZmZlcnMgPSBmYWxzZTsKICAgICAgICAgICAgICBtc2cucmVjZWl2ZWQgPSAiU29ycnkgd2UgZG8gbm90IGhhdmUgYW55IG9mZmVycyBjdXJyZW50bHksIHBsZWFzZSBjaGVjayBiYWNrIGxhdGVyLiI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZtLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQgPT0gImNoYXRfc3VwcG9ydCIpIHsKICAgICAgICAgICAgdm0uc3RhcnRfbGl2ZV9jaGF0KCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQgIT0gdW5kZWZpbmVkICYmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0LmluY2x1ZGVzKCJEb3dubG9hZCB5b3VyIG1hbmlmZXN0IGhlcmUiKSB8fCByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0LmluY2x1ZGVzKC8ucGRmLykpKSB7CiAgICAgICAgICAgIHZtLmRpc3BsYXlfZmlsZV9jaGF0KHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldKTsKICAgICAgICAgIH0gZWxzZSBpZiAoQm9vbGVhbihyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5wcm9kdWN0cykgJiYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnByb2R1Y3RzLmxlbmd0aCA+IDAgfHwgT2JqZWN0LmtleXMocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ucHJvZHVjdHMpLmxlbmd0aCkpIHsKICAgICAgICAgICAgdm0uZGlzcGxheV9wcm9kdWN0c19jaGF0KHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLCBpLCB0eXBlKTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaXNfcmVmdW5kID09ICJUcnVlIikgewogICAgICAgICAgICB2bS5sb2FkX3JlZnVuZHMocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0pOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5zaG9waWZ5X2ZldGNoX2N1c3RvbWVyX2lkID09PSB0cnVlKSB7CiAgICAgICAgICAgIHZtLnNob3BpZnlfY2hlY2tfY3VzdG9tZXJfbG9nZ2VkX2luKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmltYWdlICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICBtc2cuaW1hZ2UgPSByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbWFnZTsKICAgICAgICAgICAgbXNnLnJlY2VpdmluZyA9IHRydWU7CiAgICAgICAgICAgIHZtLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS52aWRlbyAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgbXNnLnZpZGVvcyA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnZpZGVvIHx8IGZhbHNlOwogICAgICAgICAgICA7CiAgICAgICAgICAgIG1zZy5yZWNlaXZpbmcgPSB0cnVlOwogICAgICAgICAgICB2bS5jaGF0LnB1c2gobXNnKTsKICAgICAgICAgICAgdm0ubmV3X3VwZGF0ZV9yZXNwb25zZShpKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChpIDwgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXMubGVuZ3RoIC0gMSkgewogICAgICAgICAgaSArPSAxOwogICAgICAgICAgdm0uaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7IC8vIGRlbGF5ID0KICAgICAgICAgIC8vICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgIC8vICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dC5sZW5ndGggPiAxMAogICAgICAgICAgLy8gICAgID8gMjAwMAogICAgICAgICAgLy8gICAgIDogNTAwOwoKICAgICAgICAgIGRlbGF5ID0gNTAwOwogICAgICAgICAgaGFuZGxlX3Jlc3BvbnNlKCk7CiAgICAgICAgfQogICAgICB9LCBkZWxheSk7CiAgICB9CiAgfSwKICBkaXNwbGF5X2Jhbm5lcjogZnVuY3Rpb24gZGlzcGxheV9iYW5uZXIocmVzcG9uc2UsIGkpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICB2YXIgcG9zaXRpb25fMSA9IHJlc3BvbnNlW2ldLmJhbm5lcl9jb250ZW50X3Bvc2l0aW9uWzBdWydpZCddOwogICAgdmFyIHBvc2l0aW9uXzIgPSByZXNwb25zZVtpXS5iYW5uZXJfY29udGVudF9wb3NpdGlvblsxXVsnaWQnXTsKICAgIHZhciBwb3NpdGlvbl8zID0gcmVzcG9uc2VbaV0uYmFubmVyX2NvbnRlbnRfcG9zaXRpb25bMl1bJ2lkJ107CiAgICB2YXIgaXNfZGF0YV9wb3NpdGlvbl8xID0gcmVzcG9uc2VbaV1bcG9zaXRpb25fMV07CiAgICB2YXIgaXNfZGF0YV9wb3NpdGlvbl8yID0gcmVzcG9uc2VbaV1bcG9zaXRpb25fMl07CiAgICB2YXIgaXNfZGF0YV9wb3NpdGlvbl8zID0gcmVzcG9uc2VbaV1bcG9zaXRpb25fM107CgogICAgaWYgKEJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8xKSkgewogICAgICB2YXIgbXNnID0gewogICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgIHRpbWU6IGkgPT0gcmVzcG9uc2UubGVuZ3RoIC0gMSAmJiAhKEJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8yKSB8fCBCb29sZWFuKGlzX2RhdGFfcG9zaXRpb25fMykpID8gdm0uZ2VuZXJhdGVfdGltZSgpIDogbnVsbCwKICAgICAgICBhc2tfZmVlZGJhY2s6IEJvb2xlYW4ocmVzcG9uc2VbaV0uYXNrX2ZlZWRiYWNrKSwKICAgICAgICBiYW5uZXJfaW1nX2xpbms6IHJlc3BvbnNlW2ldLmJhbm5lcl9pbWdfbGluawogICAgICB9OwogICAgICBtc2cuc2hvd19ib3RfaW1nID0gdHJ1ZTsKICAgICAgbXNnWydzaG93XycgKyBwb3NpdGlvbl8xXSA9IHRydWU7CiAgICAgIG1zZ1twb3NpdGlvbl8xXSA9IGlzX2RhdGFfcG9zaXRpb25fMTsKICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgIHZtLm5ld191cGRhdGVfcmVzcG9uc2UoaSk7CgogICAgICBpZiAoQm9vbGVhbihpc19kYXRhX3Bvc2l0aW9uXzIpKSB7CiAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgdGltZTogaSA9PSByZXNwb25zZS5sZW5ndGggLSAxICYmICFCb29sZWFuKGlzX2RhdGFfcG9zaXRpb25fMykgPyB2bS5nZW5lcmF0ZV90aW1lKCkgOiBudWxsLAogICAgICAgICAgYXNrX2ZlZWRiYWNrOiBCb29sZWFuKHJlc3BvbnNlW2ldLmFza19mZWVkYmFjayksCiAgICAgICAgICBiYW5uZXJfaW1nX2xpbms6IHJlc3BvbnNlW2ldLmJhbm5lcl9pbWdfbGluawogICAgICAgIH07CiAgICAgICAgbXNnLnNob3dfYm90X2ltZyA9IGZhbHNlOwogICAgICAgIG1zZ1snc2hvd18nICsgcG9zaXRpb25fMl0gPSB0cnVlOwogICAgICAgIG1zZ1twb3NpdGlvbl8yXSA9IGlzX2RhdGFfcG9zaXRpb25fMjsKICAgICAgICB2bS5jaGF0LnB1c2gobXNnKTsKICAgICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwogICAgICB9CgogICAgICBpZiAoQm9vbGVhbihpc19kYXRhX3Bvc2l0aW9uXzMpKSB7CiAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgdGltZTogaSA9PSByZXNwb25zZS5sZW5ndGggLSAxID8gdm0uZ2VuZXJhdGVfdGltZSgpIDogbnVsbCwKICAgICAgICAgIGFza19mZWVkYmFjazogQm9vbGVhbihyZXNwb25zZVtpXS5hc2tfZmVlZGJhY2spLAogICAgICAgICAgYmFubmVyX2ltZ19saW5rOiByZXNwb25zZVtpXS5iYW5uZXJfaW1nX2xpbmsKICAgICAgICB9OwogICAgICAgIG1zZy5zaG93X2JvdF9pbWcgPSBmYWxzZTsKICAgICAgICBtc2dbJ3Nob3dfJyArIHBvc2l0aW9uXzNdID0gdHJ1ZTsKICAgICAgICBtc2dbcG9zaXRpb25fM10gPSBpc19kYXRhX3Bvc2l0aW9uXzM7CiAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgdm0ubmV3X3VwZGF0ZV9yZXNwb25zZShpKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChCb29sZWFuKGlzX2RhdGFfcG9zaXRpb25fMikpIHsKICAgICAgdmFyIG1zZyA9IHsKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICB0aW1lOiBpID09IHJlc3BvbnNlLmxlbmd0aCAtIDEgJiYgIUJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8zKSA/IHZtLmdlbmVyYXRlX3RpbWUoKSA6IG51bGwsCiAgICAgICAgYXNrX2ZlZWRiYWNrOiBCb29sZWFuKHJlc3BvbnNlW2ldLmFza19mZWVkYmFjayksCiAgICAgICAgYmFubmVyX2ltZ19saW5rOiByZXNwb25zZVtpXS5iYW5uZXJfaW1nX2xpbmsKICAgICAgfTsKICAgICAgbXNnLnNob3dfYm90X2ltZyA9IHRydWU7CiAgICAgIG1zZ1snc2hvd18nICsgcG9zaXRpb25fMl0gPSB0cnVlOwogICAgICBtc2dbcG9zaXRpb25fMl0gPSBpc19kYXRhX3Bvc2l0aW9uXzI7CiAgICAgIHZtLmNoYXQucHVzaChtc2cpOwogICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwoKICAgICAgaWYgKEJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8zKSkgewogICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIHRpbWU6IGkgPT0gcmVzcG9uc2UubGVuZ3RoIC0gMSA/IHZtLmdlbmVyYXRlX3RpbWUoKSA6IG51bGwsCiAgICAgICAgICBhc2tfZmVlZGJhY2s6IEJvb2xlYW4ocmVzcG9uc2VbaV0uYXNrX2ZlZWRiYWNrKSwKICAgICAgICAgIGJhbm5lcl9pbWdfbGluazogcmVzcG9uc2VbaV0uYmFubmVyX2ltZ19saW5rCiAgICAgICAgfTsKICAgICAgICBtc2cuc2hvd19ib3RfaW1nID0gZmFsc2U7CiAgICAgICAgbXNnWydzaG93XycgKyBwb3NpdGlvbl8zXSA9IHRydWU7CiAgICAgICAgbXNnW3Bvc2l0aW9uXzNdID0gaXNfZGF0YV9wb3NpdGlvbl8zOwogICAgICAgIHZtLmNoYXQucHVzaChtc2cpOwogICAgICAgIHZtLm5ld191cGRhdGVfcmVzcG9uc2UoaSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoQm9vbGVhbihpc19kYXRhX3Bvc2l0aW9uXzMpKSB7CiAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgdGltZTogaSA9PSByZXNwb25zZS5sZW5ndGggLSAxID8gdm0uZ2VuZXJhdGVfdGltZSgpIDogbnVsbCwKICAgICAgICBhc2tfZmVlZGJhY2s6IEJvb2xlYW4ocmVzcG9uc2VbaV0uYXNrX2ZlZWRiYWNrKSwKICAgICAgICBiYW5uZXJfaW1nX2xpbms6IHJlc3BvbnNlW2ldLmJhbm5lcl9pbWdfbGluawogICAgICB9OwogICAgICBtc2cuc2hvd19ib3RfaW1nID0gdHJ1ZTsKICAgICAgbXNnWydzaG93XycgKyBwb3NpdGlvbl8zXSA9IHRydWU7CiAgICAgIG1zZ1twb3NpdGlvbl8zXSA9IGlzX2RhdGFfcG9zaXRpb25fMzsKICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgIHZtLm5ld191cGRhdGVfcmVzcG9uc2UoaSk7CiAgICB9CiAgfSwKICBwdXNoX21zZzogZnVuY3Rpb24gcHVzaF9tc2cocmVzcG9uc2VzLCByZXNwb25zZSkgewogICAgdmFyIF90aGlzMTggPSB0aGlzOwoKICAgIHZhciBpbmRleCA9IDA7CiAgICB2YXIgdm0gPSB0aGlzOwogICAgdmFyIGRlbGF5ID0gNTA7IC8vIHB1c2hfY2hhdChyZXNwb25zZVtpbmRleF0sIGRlbGF5KTsKICAgIC8vIGZ1bmN0aW9uIHB1c2hfY2hhdChtc2csIHRpbWVfZGVsYXkpIHsKCiAgICB2YXIgX2xvb3AgPSBmdW5jdGlvbiBfbG9vcChpKSB7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIC8vIHdoaWxlIChpIDwgcmVzcG9uc2UubGVuZ3RoKSB7CiAgICAgICAgLy8gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgdmFyIG1zZyA9IHJlc3BvbnNlW2ldOwogICAgICAgIHZtLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOyAvLyBzZXRUaW1lb3V0KCgpID0+IHsKCiAgICAgICAgdm0uaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwoKICAgICAgICBpZiAocmVzcG9uc2VzLmRhdGEucmVzcG9uc2VzW2ldLmJ1dHRvbnMgIT0gdW5kZWZpbmVkICYmIEJvb2xlYW4ocmVzcG9uc2VzLmRhdGEucmVzcG9uc2VzW2ldLmJ1dHRvbnMubGVuZ3RoID4gMCkpIHsKICAgICAgICAgIHZtLmxvYWRfYnV0dG9ucyhyZXNwb25zZXMuZGF0YS5yZXNwb25zZXNbaV0sICJpc19idXR0b24iLCAzMDAwLCB0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdm0uY2hhdC5wdXNoKHsKICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgcmVjZWl2ZWQ6IG1zZy50ZXh0LAogICAgICAgICAgICBvZmZlcnM6IG1zZy5vZmZlcnMgfHwgZmFsc2UsCiAgICAgICAgICAgIHRpbWU6IGkgPT0gcmVzcG9uc2UubGVuZ3RoIC0gMSA/IHZtLmdlbmVyYXRlX3RpbWUoKSA6IHVuZGVmaW5lZAogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoX3RoaXMxOC5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uID09IGkpIHsKICAgICAgICAgIGlmICh2bS5pc19yZXRhaWxfYm90KSB2bS5sb2FkX2NoYXRib3RfaW50ZWdyYXRpb25fZGV0YWlscygpOwogICAgICAgIH0KICAgICAgfSwgaSAqIDEwNTApOwogICAgICAkKCIudGltZSIpLmxhc3QoKS5jc3MoImRpc3BsYXkiLCAibm9uZSIpOwogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAkKCIudGltZSIpLmxhc3QoKS5jc3MoImRpc3BsYXkiLCAiYmxvY2siKTsKCiAgICAgICAgaWYgKGkgPCByZXNwb25zZS5sZW5ndGggLSAxKSB7Ly8gaSArPSAxOwogICAgICAgICAgLy8gZGVsYXkgPSA1MDA7CiAgICAgICAgICAvLyBwdXNoX2NoYXQocmVzcG9uc2VbaW5kZXhdLCBkZWxheSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZtLndlbGNvbWVfbWVzc2FnZV9ub3RfeWV0X3JlY2VpdmVkID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9LCA1MDApOyAvLyBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgLy8gfSwgMTAwMCk7CiAgICAgIC8vIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAvLyBpICs9MTsKICAgICAgLy8gfQogICAgICAvLyB9LCA0MDApOwogICAgICAvLyB9LCB0aW1lX2RlbGF5KTsKICAgICAgLy8gfSwgaSogNTAwKTsKICAgIH07CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNwb25zZS5sZW5ndGg7IGkrKykgewogICAgICBfbG9vcChpKTsKICAgIH0KCiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgdm0uZGVtb19yZXRhaWxfcXVlc3Rpb24oKTsKICAgIH0sIGRlbGF5KTsgLy8gfQogIH0sCiAgY29uZnVzaW9uX21lc3NhZ2U6IGZ1bmN0aW9uIGNvbmZ1c2lvbl9tZXNzYWdlKG1zZ19zdHJpbmcpIHsKICAgIHZhciBfdGhpczE5ID0gdGhpczsKCiAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgY2hhdDogbXNnX3N0cmluZywKICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICBzb3VyY2U6ICJXZWIiLAogICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICBkYXRhOiAiIiwKICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IGZhbHNlCiAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBfdGhpczE5LnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgIH0pOwogIH0sCiAgZGlzcGxheV9wcm9kdWN0c19jaGF0OiBmdW5jdGlvbiBkaXNwbGF5X3Byb2R1Y3RzX2NoYXQobWVzc2FnZSwgaW5kZXgsIHR5cGUpIHsKICAgIHZhciBfdGhpczIwID0gdGhpczsKCiAgICB2YXIgbXNnID0gewogICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCkKICAgIH07CgogICAgaWYgKG1lc3NhZ2UucHJvZHVjdHMuaXNfcHJvZHVjdHNfbGlzdCkgewogICAgICBtc2cuaXNfcHJvZHVjdHNfbGlzdCA9IG1lc3NhZ2UucHJvZHVjdHMuaXNfcHJvZHVjdHNfbGlzdDsKICAgICAgbXNnLnByb2R1Y3RzX2xpc3QgPSBtZXNzYWdlLnByb2R1Y3RzLnByb2R1Y3RzX2xpc3Q7CgogICAgICBpZiAobWVzc2FnZS5wcm9kdWN0cy5wcm9kdWN0c19saXN0Lmxlbmd0aCA9PT0gMCkgewogICAgICAgIG1zZy5yZWNlaXZlZCA9ICJTb3JyeSwgd2UgY291bGQgbm90IGZpbmQgd2hhdCB5b3Ugc2VhcmNoZWQgZm9yIjsKICAgICAgICBtc2cucmVjZWl2aW5nID0gdHJ1ZTsKICAgICAgfSAvLyBzZXRUaW1lb3V0KCgpID0+IHsKCgogICAgICBpZiAoQm9vbGVhbihtZXNzYWdlLnByb2R1Y3RzLnRleHQpID09PSB0cnVlKSB7CiAgICAgICAgbXNnLnJlY2VpdmVkID0gbWVzc2FnZS5wcm9kdWN0cy50ZXh0OwogICAgICAgIG1zZy5yZWNlaXZpbmcgPSB0cnVlOwogICAgICB9CgogICAgICB0aGlzLnByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3QgPSBbXTsKCiAgICAgIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICdzaG9waWZ5JykgewogICAgICAgIG1zZy5wcm9kdWN0c19saXN0LmZvckVhY2goZnVuY3Rpb24gKHByb2R1Y3QpIHsKICAgICAgICAgIGZvciAodmFyIF9pNCA9IDA7IF9pNCA8IHByb2R1Y3QudmFyaWF0aW9ucy5sZW5ndGg7IF9pNCsrKSB7CiAgICAgICAgICAgIF90aGlzMjAucHJvZHVjdF9saXN0LnB1c2goewogICAgICAgICAgICAgIHByb2R1Y3RfaWQ6IHByb2R1Y3QudmFyaWF0aW9uc1tfaTRdLmlkLAogICAgICAgICAgICAgIHByb2R1Y3RfdGl0bGU6IHByb2R1Y3QudGl0bGUsCiAgICAgICAgICAgICAgdmFyaWFudF90aXRsZTogcHJvZHVjdC52YXJpYXRpb25zW19pNF0udmFyaWFudF90aXRsZSwKICAgICAgICAgICAgICB2YXJpYW50X2lkOiBwcm9kdWN0LnZhcmlhdGlvbnNbX2k0XS5pZCwKICAgICAgICAgICAgICBzdG9ja19zdGF0dXM6IHByb2R1Y3QudmFyaWF0aW9uc1tfaTRdLnN0b2NrX3N0YXR1cyB8fCAiaW5zdG9jayIsCiAgICAgICAgICAgICAgYmFja19pbl9zdG9jazogZmFsc2UsCiAgICAgICAgICAgICAgcHJvZHVjdEltYWdlOiBwcm9kdWN0LnZhcmlhdGlvbnNbX2k0XS5pbWdfdXJsID09IG51bGwgPyBwcm9kdWN0LmltZ191cmwgOiBwcm9kdWN0LnZhcmlhdGlvbnNbX2k0XS5pbWdfdXJsLAogICAgICAgICAgICAgIG9ubGluZVN0b3JlVVJMOiBwcm9kdWN0LnZhcmlhdGlvbnNbX2k0XS5wZXJtYWxpbmsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAnd29vY29tbWVyY2UnKSB7CiAgICAgICAgbXNnLnByb2R1Y3RzX2xpc3QuZm9yRWFjaChmdW5jdGlvbiAocHJvZHVjdCkgewogICAgICAgICAgaWYgKHByb2R1Y3QudmFyaWF0aW9ucyAmJiBwcm9kdWN0LnZhcmlhdGlvbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBmb3IgKHZhciBfaTUgPSAwOyBfaTUgPCBwcm9kdWN0LnZhcmlhdGlvbnMubGVuZ3RoOyBfaTUrKykgewogICAgICAgICAgICAgIF90aGlzMjAucHJvZHVjdF9saXN0LnB1c2goewogICAgICAgICAgICAgICAgcHJvZHVjdF9pZDogcHJvZHVjdC5pZCwKICAgICAgICAgICAgICAgIHByb2R1Y3RfdGl0bGU6IHByb2R1Y3QudGl0bGUsCiAgICAgICAgICAgICAgICB2YXJpYW50X3RpdGxlOiBwcm9kdWN0LnZhcmlhdGlvbnNbX2k1XS52YXJpYW50X3RpdGxlLAogICAgICAgICAgICAgICAgdmFyaWFudF9pZDogcHJvZHVjdC52YXJpYXRpb25zW19pNV0uaWQsCiAgICAgICAgICAgICAgICBzdG9ja19zdGF0dXM6IHByb2R1Y3QudmFyaWF0aW9uc1tfaTVdLnN0b2NrX3N0YXR1cyB8fCAiaW5zdG9jayIsCiAgICAgICAgICAgICAgICBiYWNrX2luX3N0b2NrOiBmYWxzZSwKICAgICAgICAgICAgICAgIHByb2R1Y3RJbWFnZTogcHJvZHVjdC52YXJpYXRpb25zW19pNV0uaW1nX3VybCA9PSBudWxsID8gcHJvZHVjdC5pbWdfdXJsIDogcHJvZHVjdC52YXJpYXRpb25zW19pNV0uaW1nX3VybCwKICAgICAgICAgICAgICAgIG9ubGluZVN0b3JlVVJMOiBwcm9kdWN0LnBlcm1hbGluawogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfdGhpczIwLnByb2R1Y3RfbGlzdC5wdXNoKHsKICAgICAgICAgICAgICBwcm9kdWN0X2lkOiBwcm9kdWN0LmlkLAogICAgICAgICAgICAgIHByb2R1Y3RfdGl0bGU6IHByb2R1Y3QudGl0bGUsCiAgICAgICAgICAgICAgdmFyaWFudF90aXRsZTogbnVsbCwKICAgICAgICAgICAgICB2YXJpYW50X2lkOiBudWxsLAogICAgICAgICAgICAgIHN0b2NrX3N0YXR1czogcHJvZHVjdC5zdG9ja19zdGF0dXMgfHwgImluc3RvY2siLAogICAgICAgICAgICAgIGJhY2tfaW5fc3RvY2s6IGZhbHNlLAogICAgICAgICAgICAgIHByb2R1Y3RJbWFnZTogcHJvZHVjdC5pbWdfdXJsLAogICAgICAgICAgICAgIG9ubGluZVN0b3JlVVJMOiBwcm9kdWN0LnBlcm1hbGluawogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICdtYWdlbnRvJykgewogICAgICAgIG1zZy5wcm9kdWN0c19saXN0LmZvckVhY2goZnVuY3Rpb24gKHByb2R1Y3QpIHsKICAgICAgICAgIGlmIChwcm9kdWN0LnZhcmlhdGlvbnMgJiYgcHJvZHVjdC52YXJpYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgZm9yICh2YXIgX2k2ID0gMDsgX2k2IDwgcHJvZHVjdC52YXJpYXRpb25zLmxlbmd0aDsgX2k2KyspIHsKICAgICAgICAgICAgICBfdGhpczIwLnByb2R1Y3RfbGlzdC5wdXNoKHsKICAgICAgICAgICAgICAgIHByb2R1Y3RfaWQ6IHByb2R1Y3QuaWQsCiAgICAgICAgICAgICAgICBwcm9kdWN0X3RpdGxlOiBwcm9kdWN0LnRpdGxlLAogICAgICAgICAgICAgICAgdmFyaWFudF90aXRsZTogcHJvZHVjdC52YXJpYXRpb25zW19pNl0udmFyaWFudF90aXRsZSwKICAgICAgICAgICAgICAgIHZhcmlhbnRfaWQ6IHByb2R1Y3QudmFyaWF0aW9uc1tfaTZdLmlkLAogICAgICAgICAgICAgICAgc3RvY2tfc3RhdHVzOiBwcm9kdWN0LnN0b2NrX3N0YXR1cyB8fCAiaW5zdG9jayIsCiAgICAgICAgICAgICAgICBiYWNrX2luX3N0b2NrOiBmYWxzZSwKICAgICAgICAgICAgICAgIHByb2R1Y3RJbWFnZTogcHJvZHVjdC52YXJpYXRpb25zW19pNl0uaW1nX3VybCA9PSBudWxsID8gcHJvZHVjdC5pbWdfdXJsIDogcHJvZHVjdC52YXJpYXRpb25zW19pNl0uaW1nX3VybCwKICAgICAgICAgICAgICAgIG9ubGluZVN0b3JlVVJMOiBwcm9kdWN0LnZhcmlhdGlvbnNbX2k2XS5wZXJtYWxpbmsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX3RoaXMyMC5wcm9kdWN0X2xpc3QucHVzaCh7CiAgICAgICAgICAgICAgcHJvZHVjdF9pZDogcHJvZHVjdC5pZCwKICAgICAgICAgICAgICBwcm9kdWN0X3RpdGxlOiBwcm9kdWN0LnRpdGxlLAogICAgICAgICAgICAgIHZhcmlhbnRfdGl0bGU6IG51bGwsCiAgICAgICAgICAgICAgdmFyaWFudF9pZDogbnVsbCwKICAgICAgICAgICAgICBzdG9ja19zdGF0dXM6IHByb2R1Y3Quc3RvY2tfc3RhdHVzIHx8ICJpbnN0b2NrIiwKICAgICAgICAgICAgICBiYWNrX2luX3N0b2NrOiBmYWxzZSwKICAgICAgICAgICAgICBwcm9kdWN0SW1hZ2U6IHByb2R1Y3QuaW1nX3VybCwKICAgICAgICAgICAgICBvbmxpbmVTdG9yZVVSTDogcHJvZHVjdC5wZXJtYWxpbmsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgaW4gbXNnLnByb2R1Y3RzX2xpc3QpIHsKICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS5vcmRlcl9xdHkgPSAxOwogICAgICAgIG1zZy5wcm9kdWN0c19saXN0W2ldLmJ1eV9xdHkgPSAxOwoKICAgICAgICBpZiAobXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9ucyAmJiBtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0W2ldLmlkID0gbXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9uc1swXS5pZDsKICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0W2ldLmltZ191cmwgPSBtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYXRpb25zWzBdLmltZ191cmwgPT09IG51bGwgPyBtc2cucHJvZHVjdHNfbGlzdFtpXS5pbWdfdXJsIDogbXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9uc1swXS5pbWdfdXJsOwogICAgICAgICAgbXNnLnByb2R1Y3RzX2xpc3RbaV0ucGVybWFsaW5rID0gbXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9uc1swXS5wZXJtYWxpbms7CiAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYW50X3RpdGxlID0gbXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9uc1swXS52YXJpYW50X3RpdGxlOwogICAgICAgICAgbXNnLnByb2R1Y3RzX2xpc3RbaV0uc3RvY2tfcXVhbnRpdHkgPSBtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYXRpb25zWzBdLnN0b2NrX3F1YW50aXR5OwogICAgICAgICAgbXNnLnByb2R1Y3RzX2xpc3RbaV0uc3RvY2tfc3RhdHVzID0gbXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9uc1swXS5zdG9ja19zdGF0dXM7CiAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS5wcmljZSA9IG1zZy5wcm9kdWN0c19saXN0W2ldLnZhcmlhdGlvbnNbMF0ucHJpY2U7CiAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS5yZWd1bGFyX3ByaWNlID0gbXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9uc1swXS5yZWd1bGFyX3ByaWNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgbXNnLm5ld19wcm9kdWN0cyA9IHRydWU7CiAgICAgIHRoaXMuc2hvd19jdXN0b21fY2FydCA9IHRydWU7CiAgICAgIHZhciBuZXdsaXN0ID0gdGhpcy5wcm9kdWN0X2xpc3QuZmlsdGVyKGZ1bmN0aW9uIChwcm9kdWN0KSB7CiAgICAgICAgcmV0dXJuIHByb2R1Y3RbInN0b2NrX3N0YXR1cyJdID09PSAib3V0b2ZzdG9jayI7CiAgICAgIH0pOwogICAgICBtc2cucHJvZHVjdF9vdXRfb2Zfc3RvY2tfbGlzdCA9IG5ld2xpc3Q7CgogICAgICBpZiAobXNnLnByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3QubGVuZ3RoID4gMCAmJiAhdGhpcy5kaXNwbGF5X3Byb2R1Y3RzKSB7CiAgICAgICAgbXNnLnByb2R1Y3Rfb3V0X29mX3N0b2NrID0gdHJ1ZTsKICAgICAgfQoKICAgICAgdGhpcy5kaXNwbGF5X3Byb2R1Y3RzID0gZmFsc2U7IC8vIH0sIDIwMDApOwoKICAgICAgaWYgKHR5cGUgPT09ICJkaXNwbGF5X3N1Y2Nlc3NfdG9hc3RyIikgewogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgc3dhbCh7CiAgICAgICAgICAgIHRleHQ6ICJUZXN0aW5nIENvbXBsZXRlZCBTdWNjZXNzZnVsbHkhIFBsZWFzZSBQcm9jZWVkIHRvIHRoZSBuZXh0IHN0ZXAuIiwKICAgICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgICAgICBzaG93Q29uZmlybUJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgIHR5cGU6ICJzdWNjZXNzIiwKICAgICAgICAgICAgdGltZXI6IDUwMDAsCiAgICAgICAgICAgIHRpbWVyUHJvZ3Jlc3NCYXI6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0sIDEyMDApOwogICAgICB9IC8vIH0sIDMwKTsKCiAgICB9IGVsc2UgaWYgKG1lc3NhZ2UucHJvZHVjdHMubGVuZ3RoKSB7CiAgICAgIG1zZy5pc3Byb2R1Y3QgPSB0cnVlOwogICAgICBtc2cuZWxlbWVudHMgPSBtZXNzYWdlOwogICAgfQoKICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7IC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwoKICAgIHRoaXMubmV3X3VwZGF0ZV9yZXNwb25zZShpbmRleCk7CiAgICB0aGlzLnByb2R1Y3RfbGlzdCA9IFtdOwogIH0sCiAgZGlzcGxheV9maWxlX2NoYXQ6IGZ1bmN0aW9uIGRpc3BsYXlfZmlsZV9jaGF0KG1lc3NhZ2UpIHsKICAgIHZhciBtc2cgPSB7CiAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKQogICAgfTsKICAgIHZhciB0ZW1wID0gbWVzc2FnZS5zcGxpdCgiRG93bmxvYWQgeW91ciBtYW5pZmVzdCBoZXJlICIpOwogICAgdmFyIHVybCA9IG1lc3NhZ2UubWF0Y2godGhpcy51cmxfbWF0Y2hfcmVnZXgpWzBdOwogICAgbXNnLnVybCA9IG1lc3NhZ2UuaW5jbHVkZXMoIkRvd25sb2FkIHlvdXIgbWFuaWZlc3QgaGVyZSAiKSA/IHRlbXBbMV0gOiB1cmw7CiAgICBtc2cucmVjZWl2aW5nID0gZmFsc2U7CiAgICBtc2cuZmlsZV9uYW1lID0gdXJsLnNwbGl0KC9eLipbXFxcL10vKVsxXS5zcGxpdCgiLyIpLnBvcCgpLnNwbGl0KCI/IilbMF07CiAgICB0aGlzLmNoYXQucHVzaChtc2cpOyAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKCiAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgfSwKICBnZW5lcmF0ZV9vcmRlcl9kZXRhaWxzOiBmdW5jdGlvbiBnZW5lcmF0ZV9vcmRlcl9kZXRhaWxzKG9yZGVyKSB7fSwKICBhZGRkcm9wZG93bnZhbHVlOiBmdW5jdGlvbiBhZGRkcm9wZG93bnZhbHVlKHZhbHVlKSB7CiAgICB2YXIgX3RoaXMyMSA9IHRoaXM7CgogICAgcmV0dXJuIF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZSgpIHsKICAgICAgdmFyIGksIHBhcnNlZEpzb247CiAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlJChfY29udGV4dCkgewogICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBfdGhpczIxLnNlbGVjdGVkX2luZGljYXRpb24gPSB2YWx1ZTsKCiAgICAgICAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIF90aGlzMjEudG9fc2VuZCA9ICIiOwogICAgICAgICAgICAgICAgX3RoaXMyMS5yZXMgPSB7fTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgX3RoaXMyMS5zZWxlY3RlZF9pbmRpY2F0aW9uLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHBhcnNlZEpzb24gPSBKU09OLnBhcnNlKCJ7Ii5jb25jYXQoX3RoaXMyMS5zZWxlY3RlZF9pbmRpY2F0aW9uW2ldLnZhbHVlLnNwbGl0KCJ7IilbMV0pKTsKCiAgICAgICAgICAgICAgICAgIGlmIChpID09IDApIHsKICAgICAgICAgICAgICAgICAgICBfdGhpczIxLnRvX3NlbmQgPSBfdGhpczIxLnNlbGVjdGVkX2luZGljYXRpb25baV0udGl0bGU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMyMS50b19zZW5kID0gX3RoaXMyMS50b19zZW5kICsgIiwgIiArIF90aGlzMjEuc2VsZWN0ZWRfaW5kaWNhdGlvbltpXS50aXRsZTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYgKF90aGlzMjEucmVzW09iamVjdC5rZXlzKHBhcnNlZEpzb24pWzBdLnRvU3RyaW5nKCldID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIF90aGlzMjEucmVzW09iamVjdC5rZXlzKHBhcnNlZEpzb24pWzBdLnRvU3RyaW5nKCldID0gT2JqZWN0LnZhbHVlcyhwYXJzZWRKc29uKVswXS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIF90aGlzMjEucmVzW09iamVjdC5rZXlzKHBhcnNlZEpzb24pWzBdLnRvU3RyaW5nKCldID0gX3RoaXMyMS5yZXNbT2JqZWN0LmtleXMocGFyc2VkSnNvbilbMF0udG9TdHJpbmcoKV0gKyAiLCIgKyBPYmplY3QudmFsdWVzKHBhcnNlZEpzb24pWzBdLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGhpczIxLmJ1dHRvbl9maWxsKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF90aGlzMjEudG9fc2VuZCA9ICIiOwogICAgICAgICAgICAgICAgX3RoaXMyMS5yZXMgPSB7fTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIF90aGlzMjEuYnV0dG9uX2ZpbGwoKTsKCiAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgX2NhbGxlZSk7CiAgICB9KSkoKTsKICB9LAogIGJ1dHRvbl9maWxsOiBmdW5jdGlvbiBidXR0b25fZmlsbCgpIHsKICAgIGlmICh0aGlzLnRvX3NlbmQgPT0gIiIpIHsKICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI3NlbmRfYnV0dG9uIikuY2xhc3NMaXN0LnJlbW92ZSgiZmlsbGVkIik7CiAgICB9IGVsc2UgaWYgKHRoaXMudG9fc2VuZCAhPSAiIikgewogICAgICBpZiAodGhpcy5saXZlX2NoYXRfb24pIHsKICAgICAgICB0aGlzLmNoYW5uZWwucHVzaCgic3RhcnRlZF90eXBpbmciKTsKICAgICAgICB0aGlzLnN0b3BfdHlwaW5nKHRoaXMpOwogICAgICB9CgogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjc2VuZF9idXR0b24iKS5jbGFzc0xpc3QuYWRkKCJmaWxsZWQiKTsKICAgIH0KICB9LAogIHN0b3BfdHlwaW5nOiBkZWJvdW5jZShmdW5jdGlvbiAodm0pIHsKICAgIHZtLmNoYW5uZWwucHVzaCgic3RvcHBlZF90eXBpbmciKTsKICB9LCAxMDAwKSwKICBzY3JvbGxfZG93bjogZnVuY3Rpb24gc2Nyb2xsX2Rvd24oKSB7CiAgICBpZiAoZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmNoYXQtYm9keSIpLnNjcm9sbEhlaWdodCAtIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5jaGF0LWJvZHkiKS5zY3JvbGxUb3AgPD0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmNoYXQtYm9keSIpLmNsaWVudEhlaWdodCkgewogICAgICB0aGlzLnRvX3Njcm9sbCA9IGZhbHNlOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy50b19zY3JvbGwgPSB0cnVlOwogICAgfQogIH0sCiAgbG9hZF9idXR0b25zOiBmdW5jdGlvbiBsb2FkX2J1dHRvbnMobWVzc2FnZSwgaW5kZXgsIHR5cGUsIGdyZWV0aW5nX2J1dHRvbikgewogICAgdmFyIF90aGlzMjIgPSB0aGlzOwoKICAgIGlmICh0eXBlID09PSAiZGlzcGxheV9zdWNjZXNzX3RvYXN0ciIpIHsKICAgICAgc3dhbCh7CiAgICAgICAgdGV4dDogIlNvbWUgZXJyb3Igb2NjdXJyZWQgd2hpbGUgdGVzdGluZy4iLAogICAgICAgIHRvYXN0OiB0cnVlLAogICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICB0eXBlOiAiZXJyb3IiLAogICAgICAgIHRpbWVyOiA1MDAwCiAgICAgIH0pOwogICAgICB2YXIgbXNnID0gewogICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgIGFza19mZWVkYmFjazogZmFsc2UsCiAgICAgICAgcmVjZWl2ZWQ6ICJTb21lIGVycm9yIG9jY3VycmVkIHdoaWxlIHRlc3RpbmcuIFBsZWFzZSB0cnkgYnkgcmVmcmVzaGluZyB0aGUgYnJvd3NlciEgSWYgdGhlIGlzc3VlIHBlcnNpc3RzLCBwbGVhc2UgY29udGFjdCBzeXN0ZW0gYWRtaW4uIiwKICAgICAgICByZWNlaXZpbmc6IHRydWUKICAgICAgfTsKICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBtc2cgPSB7CiAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICBidXR0b25zX2xpc3Q6IFtdLAogICAgICBidXR0b25fcHJlZml4OiBtZXNzYWdlLnByZWZpeCwKICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICByZWNlaXZlZDogbWVzc2FnZS50ZXh0LAogICAgICB0aW1lOiBudWxsCiAgICB9OwoKICAgIGlmIChCb29sZWFuKGdyZWV0aW5nX2J1dHRvbikpIHsKICAgICAgbXNnLmdyZWV0aW5nX2J1dHRvbiA9IGZhbHNlOwogICAgfSBlbHNlIHsKICAgICAgbXNnLmN1c3RvbV9idXR0b25zID0gZmFsc2U7CiAgICB9CgogICAgaWYgKG1lc3NhZ2UuYnV0dG9ucy5sZW5ndGggPT0gMykgewogICAgICBpZiAobWVzc2FnZS5idXR0b25zWzBdLnRpdGxlID09ICJFeGNoYW5nZSBSYXRlIiAmJiBtZXNzYWdlLmJ1dHRvbnNbMV0udGl0bGUgPT0gIlRyYWNrIE15IFBhcmNlbCIgJiYgbWVzc2FnZS5idXR0b25zWzJdLnRpdGxlID09ICJDYWxsIEhlbHBkZXNrIikgewogICAgICAgIG1zZy5yZW1vdmFibGUgPSBmYWxzZTsKICAgICAgfQogICAgfQoKICAgIGlmIChtZXNzYWdlLnRleHQgPT0gIldvdWxkIHlvdSBsaWtlIHRvIHNoYXJlIHlvdXIgbmFtZSBhbmQgbnVtYmVyPyIgJiYgdGhpcy5pc2V4Y2hhbmdlKSB7CiAgICAgICQoIiNyZXNwb25zZV9ib3RfdGV4dCIpLnByb3AoImRpc2FibGVkIiwgdHJ1ZSk7CiAgICB9CgogICAgZm9yICh2YXIgaSBpbiBtZXNzYWdlLmJ1dHRvbnMpIHsKICAgICAgaWYgKG1zZy5idXR0b25fcHJlZml4ICE9IG51bGwpIHsKICAgICAgICBtc2cuYnV0dG9uc19saXN0LnB1c2goewogICAgICAgICAgdGl0bGU6IG1lc3NhZ2UuYnV0dG9uc1tpXS50aXRsZSwKICAgICAgICAgIHZhbHVlOiBtc2cuYnV0dG9uX3ByZWZpeCArIG1lc3NhZ2UuYnV0dG9uc1tpXS52YWx1ZQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIG1zZy5idXR0b25zX2xpc3QucHVzaCh7CiAgICAgICAgICB0aXRsZTogbWVzc2FnZS5idXR0b25zW2ldLnRpdGxlLAogICAgICAgICAgdmFsdWU6IG1lc3NhZ2UuYnV0dG9uc1tpXS52YWx1ZQogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAobXNnLmJ1dHRvbnNfbGlzdFtpXS50aXRsZSA9PSAiTm8iICYmIG1lc3NhZ2UudGV4dCAhPSAiQ2FuIEkgaGVscCB5b3Ugd2l0aCBhbnl0aGluZyBlbHNlPyIgJiYgdGhpcy5jb21wYW55aWQgPT0gImNsaW5pY2FsdHJpYWxzODEzNTIiKSB7CiAgICAgICAgbXNnLmJ1dHRvbnNfbGlzdFtpXS52YWx1ZSA9ICJpc2Rpc2FibGVkIjsKICAgICAgfQogICAgfSAvLyBzZXRUaW1lb3V0KCgpID0+IHsKCgogICAgdmFyIGNoYXRJbmRleCA9IHRoaXMuY2hhdC5wdXNoKG1zZyk7CgogICAgaWYgKGluZGV4ID09ICJpc19idXR0b24iIHx8IGluZGV4ID09IDApIHsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCQoIi5jaGF0LWJvZHkiKS5jaGlsZHJlbigpLmxhc3QoKS5oZWlnaHQoKSAvICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA8IDAuNSkgewogICAgICAgICAgX3RoaXMyMi5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMSwgMTUwMCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIF90aGlzMjIuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDUwLCAxNTAwLCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0sIDEwMDApOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5zY3JvbGxfZG93bigpOwogICAgfQoKICAgIGlmIChCb29sZWFuKGdyZWV0aW5nX2J1dHRvbikpIHsKICAgICAgdGhpcy5jaGF0W2NoYXRJbmRleCAtIDFdLmdyZWV0aW5nX2J1dHRvbiA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmNoYXRbY2hhdEluZGV4IC0gMV0uY3VzdG9tX2J1dHRvbnMgPSB0cnVlOwogICAgfSAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKCgogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIF90aGlzMjIuY2hhdFtjaGF0SW5kZXggLSAxXS50aW1lID0gX3RoaXMyMi5nZW5lcmF0ZV90aW1lKCk7CiAgICB9LCA1MDApOyAvLyB9LCA1MDApOwogIH0sCiAgbXVsdGlzZWxlY3RfbG9hZDogZnVuY3Rpb24gbXVsdGlzZWxlY3RfbG9hZChtZXNzYWdlLCBpbmRleCkgewogICAgdmFyIG1zZyA9IHsKICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgIG11bHRpc2VsZWN0X3ZhbHVlczogbWVzc2FnZS5jdXN0b20udmFsdWVzLAogICAgICBwbGFjZWhvbGRlcjogbWVzc2FnZS5jdXN0b20ucGxhY2Vob2xkZXIsCiAgICAgIGlzX211bHRpc2VsZWN0OiB0cnVlLAogICAgICB2YWx1ZV9tYXBwaW5nOiBbXSwKICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICByZWNlaXZlZDogbWVzc2FnZS50ZXh0LAogICAgICBkaXNhYmxlZDogZmFsc2UsCiAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpCiAgICB9OwogICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICB9LAogIGxvYWRfdGFibGU6IGZ1bmN0aW9uIGxvYWRfdGFibGUobWVzc2FnZSwgaW5kZXgpIHsKICAgIHZhciBfdGhpczIzID0gdGhpczsKCiAgICB2YXIgbXNnID0gewogICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgY29sX2xpc3Q6IE9iamVjdC5rZXlzKG1lc3NhZ2UuY3VzdG9tLnZhbHVlc1swXSksCiAgICAgIHRhYmxlX3ZhbHVlOiBtZXNzYWdlLmN1c3RvbS52YWx1ZXMsCiAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgcmVjZWl2ZWQ6IG1lc3NhZ2UudGV4dCwKICAgICAgaXNfdGFibGU6IHRydWUsCiAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpCiAgICB9OwogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIF90aGlzMjMuY2hhdC5wdXNoKG1zZyk7CgogICAgICBpZiAoaW5kZXggPT0gMCkgewogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCQoIi5jaGF0LWJvZHkiKS5jaGlsZHJlbigpLmxhc3QoKS5oZWlnaHQoKSAvICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA8IDAuNSkgewogICAgICAgICAgICBfdGhpczIzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxLCAxNTAwKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF90aGlzMjMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDAuNywgMTUwMCk7CiAgICAgICAgICB9CiAgICAgICAgfSwgMTAwMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgX3RoaXMyMy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMTAwLCAxNTAwLCB0cnVlKTsKCiAgICAgICAgX3RoaXMyMy5zY3JvbGxfZG93bigpOwogICAgICB9CiAgICB9LCAyNTAwKTsKICB9LAogIGxvYWRfdGV4dF9hcmVhOiBmdW5jdGlvbiBsb2FkX3RleHRfYXJlYShtZXNzYWdlLCBpbmRleCkgewogICAgdmFyIF90aGlzMjQgPSB0aGlzOwoKICAgIHZhciBtc2cgPSB7CiAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgIHJlY2VpdmVkOiBtZXNzYWdlLnRleHQsCiAgICAgIHNob3dfdGV4dF9hcmVhOiB0cnVlLAogICAgICBkaXNhYmxlZDogZmFsc2UsCiAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpCiAgICB9OwogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIF90aGlzMjQuY2hhdC5wdXNoKG1zZyk7CgogICAgICBpZiAoaW5kZXggPT0gMCkgewogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCQoIi5jaGF0LWJvZHkiKS5jaGlsZHJlbigpLmxhc3QoKS5oZWlnaHQoKSAvICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA8IDAuNSkgewogICAgICAgICAgICBfdGhpczI0LmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxLCAxNTAwKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF90aGlzMjQuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDAuNywgMTUwMCk7CiAgICAgICAgICB9CiAgICAgICAgfSwgMTAwMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgX3RoaXMyNC5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMTAwLCAxNTAwLCB0cnVlKTsKCiAgICAgICAgX3RoaXMyNC5zY3JvbGxfZG93bigpOwogICAgICB9CiAgICB9LCAyNTAwKTsKICB9LAogIHN0YXJ0X2xpdmVfY2hhdDogZnVuY3Rpb24gc3RhcnRfbGl2ZV9jaGF0KCkgewogICAgLy8gdmFyIG1zZyA9IHt9OwogICAgLy8gbXNnLnJlY2VpdmluZyA9IHRydWU7CiAgICAvLyBtc2cucmVjZWl2ZWQgPQogICAgLy8gICAiSSBhbSBjb25uZWN0aW5nIHlvdSB0byBvbmUgb2Ygb3VyIHN1cHBvcnQgYWdlbnRzLiBQbGVhc2Ugd2FpdCBmb3IgYSB3aGlsZS4iOwogICAgLy8gbXNnLmNvbnZlcnNhdGlvbl9vbmx5ID0gdHJ1ZTsKICAgIC8vIG1zZy50aW1lID0gdGhpcy5nZW5lcmF0ZV90aW1lKCk7CiAgICAvLyB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAvLyB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgLy8gdGhpcy5jaGF0LnB1c2goewogICAgLy8gICByZWNlaXZpbmc6IHRydWUsCiAgICAvLyAgIHJlY2VpdmVkOiAiV2hhdCdzIHlvdXIgbmFtZT8iLAogICAgLy8gICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgIC8vICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAvLyB9KTsKICAgIC8vIHRoaXMubmV3X3VwZGF0ZV9yZXNwb25zZSgwKTsKICAgIC8vIHRoaXMuc2Nyb2xsX2Rvd24oKTsKICAgIHRoaXMuY2hhdF9zb2NrZXQgPSBuZXcgU29ja2V0KHByb2Nlc3MuZW52LlZVRV9BUFBfTElWRV9DSEFUX1dFQlNPQ0tFVF9FTkRQT0lOVCwgewogICAgICBwYXJhbXM6IHsKICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgIHRva2VuOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikudG9rZW5zLAogICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlCiAgICAgIH0KICAgIH0pOwogICAgdGhpcy5jaGF0X3NvY2tldC5jb25uZWN0KCk7CiAgICB0aGlzLnN1cHBvcnRfY2hhbm5lbCA9IHRoaXMuY2hhdF9zb2NrZXQuY2hhbm5lbCgiY29tcGFuaWVzOiIgKyB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lKTsKICAgIHRoaXMuc3VwcG9ydF9jaGFubmVsLmpvaW4oKTsKICAgIHZhciB2bSA9IHRoaXM7CiAgICB0aGlzLnN1cHBvcnRfY2hhbm5lbC5wdXNoKCJjdXN0b21lcl93YW50c19wcmVzZW5jZSIpOwogICAgdGhpcy5zdXBwb3J0X2NoYW5uZWwub24oImN1c3RvbWVyX2dldHNfcHJlc2VuY2UiLCBmdW5jdGlvbiAocmVzKSB7CiAgICAgIGNvbnNvbGUubG9nKCJjdXN0b21lcl9nZXRzX3ByZXNlbmNlIHJlcyIsIHJlcyk7CgogICAgICBpZiAoQm9vbGVhbihyZXNbdm0uY29tcGFueW5hbWVdKSA9PT0gdHJ1ZSkgewogICAgICAgIHZhciBjb21wYW55X3ByZXNlbmNlID0gcmVzW3ZtLmNvbXBhbnluYW1lXVsibWV0YXMiXTsgLy8gY29uc29sZS5sb2coY29tcGFueV9wcmVzZW5jZSk7CgogICAgICAgIHZhciBzZWxmX3VzZXJfaW5kZXggPSBjb21wYW55X3ByZXNlbmNlLm1hcChmdW5jdGlvbiAoZSkgewogICAgICAgICAgcmV0dXJuIGUudXNlcl9pbmZvLnVzZXJuYW1lOwogICAgICAgIH0pLmluZGV4T2Yodm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCk7CgogICAgICAgIGlmIChzZWxmX3VzZXJfaW5kZXggIT09IC0xKSB7CiAgICAgICAgICBjb21wYW55X3ByZXNlbmNlLnNwbGljZShzZWxmX3VzZXJfaW5kZXgsIDEpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHByZXNlbnRfcm9sZV9saXN0ID0gW107CiAgICAgICAgY29tcGFueV9wcmVzZW5jZS5maWx0ZXIoZnVuY3Rpb24gKGVhY2gpIHsKICAgICAgICAgIHJldHVybiBwcmVzZW50X3JvbGVfbGlzdC5wdXNoKGVhY2gudXNlcl9pbmZvLnJvbGUpOwogICAgICAgIH0pOwogICAgICAgIHZhciB1bmlxdWVfcm9sZV9saXN0ID0gcHJlc2VudF9yb2xlX2xpc3QuZmlsdGVyKGZ1bmN0aW9uICh4LCBpLCBhKSB7CiAgICAgICAgICByZXR1cm4gYS5pbmRleE9mKHgpID09IGk7CiAgICAgICAgfSk7CgogICAgICAgIGlmICh1bmlxdWVfcm9sZV9saXN0LmluY2x1ZGVzKCJBZG1pbiIpIHx8IHVuaXF1ZV9yb2xlX2xpc3QuaW5jbHVkZXMoInN1cHBvcnQgYWdlbnQiKSkgewogICAgICAgICAgdm0uaXNfc3VwcG9ydF9hZ2VudF9wcmVzZW50ID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdm0uaXNfc3VwcG9ydF9hZ2VudF9wcmVzZW50ID0gZmFsc2U7CiAgICAgICAgICBjb25zb2xlLmxvZygiY29taW5nIGhlcmUgbm90IGEgc3VwcG9ydCBhIGFnZW50Iik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZtLmlzX3N1cHBvcnRfYWdlbnRfcHJlc2VudCA9IGZhbHNlOwogICAgICB9CgogICAgICB2bS5jb25uZWN0X3N1cHBvcnRfYWdlbnQoKTsgLy8gY29uc29sZS5sb2cocmVzKQogICAgfSk7IC8vIHByZXNlbmNlLm9uU3luYygocmVzKSA9PiB7CiAgICAvLyBjb25zb2xlLmxvZyhyZXMpCiAgICAvLyB9KQogICAgLy8gYXhpb3MuZ2V0KGFwaV9jYWxscy5jaGF0X2dyb3VwX2FwaSgpKS50aGVuKChyZXNwb25zZSkgPT4gewogICAgLy8gICB0aGlzLmNoYXRfZ3JvdXBfbmFtZSA9IHJlc3BvbnNlLmRhdGEuY2hhdF9ncm91cF9uYW1lOwogICAgLy8gICB0aGlzLmxpdmVfY2hhdF90b2tlbiA9IHJlc3BvbnNlLmRhdGEudG9rZW47CiAgICAvLyAgIHRoaXMubGl2ZV9jaGF0X29uID0gdHJ1ZTsKICAgIC8vICAgdGhpcy5jaGF0X3NvY2tldCA9IG5ldyBTb2NrZXQoCiAgICAvLyAgICAgcHJvY2Vzcy5lbnYuVlVFX0FQUF9MSVZFX0NIQVRfV0VCU09DS0VUX0VORFBPSU5ULAogICAgLy8gICAgIHsKICAgIC8vICAgICAgIHBhcmFtczogewogICAgLy8gICAgICAgICBjb21wYW55OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lLAogICAgLy8gICAgICAgICBjaGF0X2dyb3VwX25hbWU6IHRoaXMuY2hhdF9ncm91cF9uYW1lLAogICAgLy8gICAgICAgICB0b2tlbjogdGhpcy5saXZlX2NoYXRfdG9rZW4sCiAgICAvLyAgICAgICB9LAogICAgLy8gICAgIH0KICAgIC8vICAgKTsKICAgIC8vICAgdGhpcy5jaGF0X3NvY2tldC5jb25uZWN0KCk7CiAgICAvLyAgIHRoaXMuY2hhbm5lbCA9IHRoaXMuY2hhdF9zb2NrZXQuY2hhbm5lbCgKICAgIC8vICAgICAiY3VzdG9tZXJzX2dyb3VwczoiICsgdGhpcy5jaGF0X2dyb3VwX25hbWUKICAgIC8vICAgKTsKICAgIC8vICAgdGhpcy5jaGFubmVsLmpvaW4oKTsKICAgIC8vICAgdGhpcy5jaGFubmVsLnB1c2goImN1c3RvbWVyX25lZWRzX3N1cHBvcnRfYWdlbnQiKTsKICAgIC8vICAgdGhpcy5jaGFubmVsLm9uKCJuZXdfY2hhdF9tZXNzYWdlIiwgKHJlcykgPT4gewogICAgLy8gICAgIGlmIChyZXMuc2VuZGVyICE9ICJjdXN0b21lciIpIHsKICAgIC8vICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgIC8vICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgLy8gICAgICAgICByZWNlaXZlZDogcmVzLm1lc3NhZ2UsCiAgICAvLyAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgLy8gICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgIC8vICAgICAgIH0pOwogICAgLy8gICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAvLyAgICAgICAgIHRoaXMuc2Nyb2xsX2Rvd24oKTsKICAgIC8vICAgICAgICAgaWYgKAogICAgLy8gICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5jaGlsZHJlbigpLmxhc3QoKS5oZWlnaHQoKSAvCiAgICAvLyAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPAogICAgLy8gICAgICAgICAgIDAuNQogICAgLy8gICAgICAgICApIHsKICAgIC8vICAgICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxLCAxNTAwKTsKICAgIC8vICAgICAgICAgfSBlbHNlIGlmICgKICAgIC8vICAgICAgICAgICAkKCIucmVjZWl2ZXIiKS5sYXN0KCkucGFyZW50KCkuaGVpZ2h0KCkgLwogICAgLy8gICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpID4KICAgIC8vICAgICAgICAgICAgIDAuNSAmJgogICAgLy8gICAgICAgICAgICQoIi5yZWNlaXZlciIpLmxhc3QoKS5wYXJlbnQoKS5oZWlnaHQoKSAvCiAgICAvLyAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPAogICAgLy8gICAgICAgICAgICAgMC42CiAgICAvLyAgICAgICAgICkgewogICAgLy8gICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDAuOSwgMTUwMCk7CiAgICAvLyAgICAgICAgIH0gZWxzZSB7CiAgICAvLyAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMC43NSwgMTUwMCk7CiAgICAvLyAgICAgICAgIH0KICAgIC8vICAgICAgIH0sIDEwMDApOwogICAgLy8gICAgICAgaWYgKAogICAgLy8gICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgLSAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikgIT0KICAgIC8vICAgICAgICAgMAogICAgLy8gICAgICAgKSB7CiAgICAvLyAgICAgICAgIHRoaXMuc2Nyb2xsX2Rvd24oKTsKICAgIC8vICAgICAgIH0KICAgIC8vICAgICB9CiAgICAvLyAgIH0pOwogICAgLy8gICB0aGlzLmNoYW5uZWwub24oInN0b3BwZWRfY2hhdCIsIChyZXMpID0+IHsKICAgIC8vICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAvLyAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgIC8vICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgIC8vICAgICAgIHJlY2VpdmVkOiAiU3VwcG9ydCBhZ2VudCAiICsgcmVzLm1lc3NhZ2UsCiAgICAvLyAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgIC8vICAgICB9KTsKICAgIC8vICAgICB0aGlzLmxpdmVfY2hhdF9vbiA9IGZhbHNlOwogICAgLy8gICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgIC8vICAgfSk7CiAgICAvLyAgIHRoaXMuY2hhbm5lbC5vbigic3RhcnRlZF90eXBpbmciLCAocmVzKSA9PiB7CiAgICAvLyAgICAgdGhpcy5pc19hZ2VudF90eXBpbmcgPSB0cnVlOwogICAgLy8gICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAvLyAgIH0pOwogICAgLy8gICB0aGlzLmNoYW5uZWwub24oInN0b3BwZWRfdHlwaW5nIiwgKHJlcykgPT4gewogICAgLy8gICAgIHRoaXMuaXNfYWdlbnRfdHlwaW5nID0gZmFsc2U7CiAgICAvLyAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAvLyAgIH0pOwogICAgLy8gfSk7CiAgfSwKICBjb25uZWN0X3N1cHBvcnRfYWdlbnQ6IGZ1bmN0aW9uIGNvbm5lY3Rfc3VwcG9ydF9hZ2VudCgpIHsKICAgIHZhciBfdGhpczI1ID0gdGhpczsKCiAgICB2YXIgdm0gPSB0aGlzOwogICAgdGhpcy5zdXBwb3J0X2NoYW5uZWwubGVhdmUoKTsKICAgIHRoaXMuY2hhdF9zb2NrZXQuZGlzY29ubmVjdCgpOwogICAgdGhpcy5jaGF0X3NvY2tldCA9IG51bGw7CgogICAgaWYgKHRoaXMuaXNfc3VwcG9ydF9hZ2VudF9wcmVzZW50ID09PSB0cnVlKSB7CiAgICAgIHZhciBtc2cgPSB7fTsKICAgICAgbXNnLnJlY2VpdmluZyA9IHRydWU7CiAgICAgIG1zZy5yZWNlaXZlZCA9ICJJIGFtIGNvbm5lY3RpbmcgeW91IHRvIG9uZSBvZiBvdXIgc3VwcG9ydCBhZ2VudHMuIFBsZWFzZSB3YWl0IGZvciBhIHdoaWxlLiI7CiAgICAgIG1zZy5jb252ZXJzYXRpb25fb25seSA9IHRydWU7CiAgICAgIG1zZy50aW1lID0gdGhpcy5nZW5lcmF0ZV90aW1lKCk7CiAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICByZWNlaXZlZDogIldoYXQncyB5b3VyIG5hbWU/IiwKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKQogICAgICB9KTsKICAgICAgdGhpcy5uZXdfdXBkYXRlX3Jlc3BvbnNlKDApOwogICAgICB0aGlzLnNjcm9sbF9kb3duKCk7CiAgICAgIGF4aW9zLmdldChhcGlfY2FsbHMuY2hhdF9ncm91cF9hcGkoKSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICBfdGhpczI1LmNoYXRfZ3JvdXBfbmFtZSA9IHJlc3BvbnNlLmRhdGEuY2hhdF9ncm91cF9uYW1lOwogICAgICAgIF90aGlzMjUubGl2ZV9jaGF0X3Rva2VuID0gcmVzcG9uc2UuZGF0YS50b2tlbjsKICAgICAgICBfdGhpczI1LmxpdmVfY2hhdF9vbiA9IHRydWU7CiAgICAgICAgX3RoaXMyNS5jaGF0X3NvY2tldCA9IG5ldyBTb2NrZXQocHJvY2Vzcy5lbnYuVlVFX0FQUF9MSVZFX0NIQVRfV0VCU09DS0VUX0VORFBPSU5ULCB7CiAgICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgY29tcGFueTogX3RoaXMyNS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZSwKICAgICAgICAgICAgY2hhdF9ncm91cF9uYW1lOiBfdGhpczI1LmNoYXRfZ3JvdXBfbmFtZSwKICAgICAgICAgICAgdG9rZW46IF90aGlzMjUubGl2ZV9jaGF0X3Rva2VuCiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIF90aGlzMjUuY2hhdF9zb2NrZXQuY29ubmVjdCgpOwoKICAgICAgICBfdGhpczI1LmNoYW5uZWwgPSBfdGhpczI1LmNoYXRfc29ja2V0LmNoYW5uZWwoImN1c3RvbWVyc19ncm91cHM6IiArIF90aGlzMjUuY2hhdF9ncm91cF9uYW1lKTsKCiAgICAgICAgX3RoaXMyNS5jaGFubmVsLmpvaW4oKTsKCiAgICAgICAgX3RoaXMyNS5jaGFubmVsLnB1c2goImN1c3RvbWVyX25lZWRzX3N1cHBvcnRfYWdlbnQiKTsKCiAgICAgICAgc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgdm0uY2hhbm5lbC5wdXNoKCJjdXN0b21lcl9ncm91cF9wcmVzZW5jZSIpOwogICAgICAgIH0sIDIwMDApOwogICAgICAgIHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZtLmNoYW5uZWwucHVzaCgiY3VzdG9tZXJfZ3JvdXBfc2VsZl9wcmVzZW5jZSIpOwogICAgICAgIH0sIDIwMDApOwoKICAgICAgICBfdGhpczI1LmNoYW5uZWwub24oImN1c3RvbWVyX2dyb3VwX3NlbGZfcHJlc2VuY2UiLCBmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygiQ1VTVE9NRVIgR1JPVVAgUFJFU0VOQ0UiLCByZXMpOwogICAgICAgIH0pOwoKICAgICAgICBfdGhpczI1LmNoYW5uZWwub24oIm5ld19jaGF0X21lc3NhZ2UiLCBmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICBpZiAocmVzLnNlbmRlciAhPSAiY3VzdG9tZXIiKSB7CiAgICAgICAgICAgIF90aGlzMjUuY2hhdC5wdXNoKHsKICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2ZWQ6IHJlcy5tZXNzYWdlLAogICAgICAgICAgICAgIHRpbWU6IF90aGlzMjUuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgX3RoaXMyNS5zY3JvbGxfZG93bigpOwoKICAgICAgICAgICAgICBpZiAoJCgiLmNoYXQtYm9keSIpLmNoaWxkcmVuKCkubGFzdCgpLmhlaWdodCgpIC8gJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIDwgMC41KSB7CiAgICAgICAgICAgICAgICBfdGhpczI1LmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxLCAxNTAwKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQoIi5yZWNlaXZlciIpLmxhc3QoKS5wYXJlbnQoKS5oZWlnaHQoKSAvICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA+IDAuNSAmJiAkKCIucmVjZWl2ZXIiKS5sYXN0KCkucGFyZW50KCkuaGVpZ2h0KCkgLyAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPCAwLjYpIHsKICAgICAgICAgICAgICAgIF90aGlzMjUuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDAuOSwgMTUwMCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF90aGlzMjUuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDAuNzUsIDE1MDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgMTAwMCk7CgogICAgICAgICAgICBpZiAoJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIC0gJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbEhlaWdodCIpICE9IDApIHsKICAgICAgICAgICAgICBfdGhpczI1LnNjcm9sbF9kb3duKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgX3RoaXMyNS5jaGFubmVsLm9uKCJzdG9wcGVkX2NoYXQiLCBmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICBfdGhpczI1LmNoYXQucHVzaCh7CiAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgIHJlY2VpdmVkOiAiU3VwcG9ydCBhZ2VudCAiICsgcmVzLm1lc3NhZ2UsCiAgICAgICAgICAgIHRpbWU6IF90aGlzMjUuZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgICB9KTsKCiAgICAgICAgICBfdGhpczI1LmxpdmVfY2hhdF9vbiA9IGZhbHNlOwoKICAgICAgICAgIF90aGlzMjUuY2hhbm5lbC5sZWF2ZSgpOwoKICAgICAgICAgIF90aGlzMjUubGl2ZV9jaGF0X3Rva2VuID0gbnVsbDsKICAgICAgICAgIF90aGlzMjUuY2hhdF9ncm91cF9uYW1lID0gbnVsbDsKICAgICAgICAgIF90aGlzMjUudXNlcl9uYW1lID0gIiI7CgogICAgICAgICAgX3RoaXMyNS5jaGF0X3NvY2tldC5kaXNjb25uZWN0KCk7CgogICAgICAgICAgX3RoaXMyNS51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgIH0pOwoKICAgICAgICBfdGhpczI1LmNoYW5uZWwub24oInN0YXJ0ZWRfdHlwaW5nIiwgZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgX3RoaXMyNS5pc19hZ2VudF90eXBpbmcgPSB0cnVlOwogICAgICAgICAgX3RoaXMyNS5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKICAgICAgICB9KTsKCiAgICAgICAgX3RoaXMyNS5jaGFubmVsLm9uKCJzdG9wcGVkX3R5cGluZyIsIGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgIF90aGlzMjUuaXNfYWdlbnRfdHlwaW5nID0gZmFsc2U7CiAgICAgICAgICBfdGhpczI1LmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnN1cHBvcnRfc3Vic2NyaXB0aW9uX2RhdGEoKTsKICAgIH0KICB9LAogIHN1Ym1pdF9jdXN0b21fZm9ybTogZnVuY3Rpb24gc3VibWl0X2N1c3RvbV9mb3JtKCkgewogICAgdmFyIF90aGlzMjYgPSB0aGlzOwoKICAgIGlmIChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjZGV0YWlsc19mb3JtIikgIT0gbnVsbCkgewogICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNkZXRhaWxzX2Zvcm0iKTsKICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJzdWJtaXQiLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOyAvLyBhY3R1YWwgbG9naWMsIGUuZy4gdmFsaWRhdGUgdGhlIGZvcm0KCiAgICAgICAgdmFyIHF1ZXJ5U3RyaW5nID0gJCgiI2RldGFpbHNfZm9ybSIpLnNlcmlhbGl6ZUFycmF5KCk7CgogICAgICAgIGlmIChfdGhpczI2LmZvcm1fcGF5bG9hZCA9PSBudWxsKSB7CiAgICAgICAgICB2YXIgX2F4aW9zJHBvc3Q5OwoKICAgICAgICAgIF90aGlzMjYuZm9ybV9wYXlsb2FkID0ge307CgogICAgICAgICAgZm9yICh2YXIgaSBpbiBxdWVyeVN0cmluZykgewogICAgICAgICAgICBfdGhpczI2LmZvcm1fcGF5bG9hZFtxdWVyeVN0cmluZ1tpXS5uYW1lXSA9IHF1ZXJ5U3RyaW5nW2ldLnZhbHVlOwogICAgICAgICAgfQoKICAgICAgICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLmJvdF91c2VyX2RhdGEoKSwgKF9heGlvcyRwb3N0OSA9IHsKICAgICAgICAgICAgbGljZW5zZV9rZXk6IF90aGlzMjYuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgZGF0YTogX3RoaXMyNi5mb3JtX3BheWxvYWQsCiAgICAgICAgICAgIHRva2VuOiBfdGhpczI2LmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgdXNlcm5hbWU6IF90aGlzMjYuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgc291cmNlOiAiV2ViIgogICAgICAgICAgfSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0OSwgInRva2VuIiwgX3RoaXMyNi5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3Q5LCAicm9sZSIsIF90aGlzMjYuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlKSwgX2F4aW9zJHBvc3Q5KSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEgPT0gIkJvdCBVc2VyIERhdGEgU2F2ZWQgU3VjY2Vzc2Z1bGx5IikgewogICAgICAgICAgICAgICQoIiNkZXRhaWxzX2Zvcm0gOmlucHV0IikucHJvcCgiZGlzYWJsZWQiLCB0cnVlKTsKICAgICAgICAgICAgICAkKCIjZGV0YWlsc19mb3JtIDpidXR0b24iKS5wcm9wKCJkaXNhYmxlZCIsIHRydWUpOwoKICAgICAgICAgICAgICBfdGhpczI2LnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CgogICAgICAgICAgICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICAgICAgY2hhdDogIi9kZXRhaWxzX2Zvcm0iLAogICAgICAgICAgICAgICAgdG9rZW46IF90aGlzMjYuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgICAgdXNlcm5hbWU6IF90aGlzMjYuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgICAgICBsaWNlbnNlX2tleTogX3RoaXMyNi4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgRGV0YWlsczogSlNPTi5zdHJpbmdpZnkoX3RoaXMyNi5mb3JtX3BheWxvYWQpLAogICAgICAgICAgICAgICAgcm9sZTogX3RoaXMyNi4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiBmYWxzZQogICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICAgICAgICAgIF90aGlzMjYucmVzcG9uc2VfaGFuZGxpbmcocmVzcCk7CgogICAgICAgICAgICAgICAgX3RoaXMyNi5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMSwgMTAwMCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LAogIHVwZGF0ZV9zY3JvbGxiYXI6IGZ1bmN0aW9uIHVwZGF0ZV9zY3JvbGxiYXIodHlwZSwgbXNnVHlwZSwgaXN3ZWxjb21lLCBkZWxheV92YWx1ZSkgewogICAgdmFyIF90aGlzMjcgPSB0aGlzOwoKICAgIHZhciBzY3JvbGxfZGVsYXkgPSBpc3dlbGNvbWUgPT0gImlzX3dlbGNvbWUiID8gZGVsYXlfdmFsdWUgOiAyMDAwOwogICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKCiAgICBpZiAobXNnVHlwZSA9PSAicmVzcG9uc2UiKSB7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzMjcuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICB9LCBzY3JvbGxfZGVsYXkpOwogICAgfSBlbHNlIGlmIChtc2dUeXBlID09ICJzZW5kZXIiKSB7CiAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDEsIDc1MCk7CiAgICB9CgogICAgaWYgKG1zZ1R5cGUgPT0gInJlc3BvbnNlIikgewogICAgICBpZiAodHlwZSA9PSAidXB0b19lbmQiKSB7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbFRvcCIpIDwgJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbEhlaWdodCIpKSB7CiAgICAgICAgICAgIGlmICgkKCIucmVjZWl2ZXIiKS5sYXN0KCkucGFyZW50KCkuaGVpZ2h0KCkgLyAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPiAwLjUpIHsKICAgICAgICAgICAgICBfdGhpczI3LmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgwLjc1LCAxNTAwKTsKCiAgICAgICAgICAgICAgX3RoaXMyNy5zY3JvbGxfZG93bigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKCQoIi5yZWNlaXZlciIpLmxhc3QoKS5wYXJlbnQoKS5oZWlnaHQoKSAvICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA8IDAuNSkgewogICAgICAgICAgICBfdGhpczI3LmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxLCBzY3JvbGxfZGVsYXkpOwogICAgICAgICAgfQogICAgICAgIH0sIHNjcm9sbF9kZWxheSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuY2hhdC1ib2R5Iikuc2Nyb2xsVG9wID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmNoYXQtYm9keSIpLnNjcm9sbEhlaWdodCAtIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5jaGF0LWJvZHkiKS5sYXN0Q2hpbGQuc2Nyb2xsSGVpZ2h0OwogICAgICAgIH0sIDEwMDApOwogICAgICB9CiAgICB9CiAgfSwKICBuZXdfdXBkYXRlX3Jlc3BvbnNlOiBmdW5jdGlvbiBuZXdfdXBkYXRlX3Jlc3BvbnNlKGluZGV4KSB7CiAgICB2YXIgX3RoaXMyOCA9IHRoaXM7CgogICAgaWYgKGluZGV4ID09IDApIHsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMyOC5zY3JvbGxfZG93bigpOwoKICAgICAgICBpZiAoJCgiLmNoYXQtYm9keSIpLmNoaWxkcmVuKCkubGFzdCgpLmhlaWdodCgpIC8gJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIDwgMC41KSB7CiAgICAgICAgICBfdGhpczI4LmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxLCAxNTAwKTsKICAgICAgICB9IGVsc2UgaWYgKCQoIi5yZWNlaXZlciIpLmxhc3QoKS5wYXJlbnQoKS5oZWlnaHQoKSAvICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA+IDAuNSAmJiAkKCIucmVjZWl2ZXIiKS5sYXN0KCkucGFyZW50KCkuaGVpZ2h0KCkgLyAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPCAwLjYpIHsKICAgICAgICAgIF90aGlzMjguYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDEsIDE1MDApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfdGhpczI4LmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxLCAxNTAwKTsKICAgICAgICB9CiAgICAgIH0sIDEwMDApOwogICAgfQoKICAgIGlmICgkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgLSAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikgIT0gMCkgewogICAgICB0aGlzLnNjcm9sbF9kb3duKCk7CiAgICB9CgogICAgaWYgKCQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSAtICQoIi5jaGF0LWJvZHkiKS5wcm9wKCJzY3JvbGxIZWlnaHQiKSA9PT0gMCkgewogICAgICB0aGlzLnRvX3Njcm9sbCA9IGZhbHNlOwogICAgfQogIH0sCiAgYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsOiBmdW5jdGlvbiBhbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoc2NhbGUsIGRlbGF5LCBvZmZzZXQpIHsKICAgIGlmIChCb29sZWFuKG9mZnNldCkpIHsKICAgICAgJCgiLmNoYXQtYm9keSIpLmFuaW1hdGUoewogICAgICAgIHNjcm9sbFRvcDogJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbFRvcCIpICsgc2NhbGUKICAgICAgfSwgZGVsYXkpOwogICAgfSBlbHNlIHsKICAgICAgJCgiLmNoYXQtYm9keSIpLmFuaW1hdGUoewogICAgICAgIHNjcm9sbFRvcDogc2NhbGUgKiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikKICAgICAgfSwgZGVsYXkpOwogICAgfQogIH0sCiAgYWRkX2JvdF91bmFuc3dlcmVkX3F1ZXN0aW9uOiBmdW5jdGlvbiBhZGRfYm90X3VuYW5zd2VyZWRfcXVlc3Rpb24oaW5kZXgsIG1ldGhvZCkgewogICAgdmFyIF90aGlzMjkgPSB0aGlzOwoKICAgIGF4aW9zLnB1dChhcGlfY2FsbHMuZ2V0X3VuYW5zd2VyZWRfdXJsKCksIHsKICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICBib3RfYW5zd2VyOiB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkLAogICAgICB1c2VyX3F1ZXJ5OiB0aGlzLmNoYXRbaW5kZXggLSAxXS5zZW50LAogICAgICBmZWVkYmFjazogbWV0aG9kID8gImxpa2UiIDogImRpc2xpa2UiLAogICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICBjb21wYW55aWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkLAogICAgICBjb21wYW55bmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZQogICAgfSwgewogICAgICBoZWFkZXJzOiB7CiAgICAgICAgQXV0aG9yaXphdGlvbjogIkJlYXJlciAiLmNvbmNhdCh0aGlzLiRzZXNzaW9uLmdldCgiYXQiKSkKICAgICAgfQogICAgfSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIF90aGlzMjkuY2hhdFtpbmRleF0uYXNrX2ZlZWRiYWNrID0gZmFsc2U7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAoKSB7fSk7CiAgfSwKICBsb2FkX3JlZnVuZHM6IGZ1bmN0aW9uIGxvYWRfcmVmdW5kcygpIHsKICAgIHZhciBfdGhpczMwID0gdGhpczsKCiAgICB2YXIgbXNnID0gewogICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgaXNfcmVmdW5kOiB0cnVlLAogICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgIHJlY2VpdmVkOiB0aGlzLnJldGFpbF9vcmRlcl9yZXRyZWl2YWxfb25seV9lbWFpbF9yZXF1aXJlZCA/ICJQbGVhc2UgZW50ZXIgZW1haWwgdG8gZmV0Y2ggeW91ciBvcmRlcnMuIiA6ICJQbGVhc2UgbG9naW4gdG8gZmV0Y2ggeW91ciByZWNlbnQgb3JkZXJzIiwKICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCkKICAgIH07CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGxhdGVzdENoYXRJbmRleCA9IF90aGlzMzAuY2hhdC5wdXNoKG1zZyk7CgogICAgICBsYXRlc3RDaGF0SW5kZXggLT0gMTsKICAgICAgX3RoaXMzMC5jaGF0W2xhdGVzdENoYXRJbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzID0gdHJ1ZTsKCiAgICAgIF90aGlzMzAuc2Nyb2xsX2Rvd24oKTsKICAgIH0sIDEwMDApOwogIH0sCiAgdmlld19vcmRlcl9kZXRhaWxzOiBmdW5jdGlvbiB2aWV3X29yZGVyX2RldGFpbHMoY2hhdEluZGV4LCBvcmRlckluZGV4LCBvcmRlckxpbmVJdGVtcywgb3JkZXJSZWZ1bmRzKSB7CiAgICB2YXIgX3RoaXMzMSA9IHRoaXM7CgogICAgdGhpcy5jaGF0W2NoYXRJbmRleF0ucmVmdW5kX3NlbGVjdGVkX2l0ZW1zID0gW107CiAgICB0aGlzLmNoYXRbY2hhdEluZGV4XS5zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX2xpc3QgPSBudWxsOwogICAgdGhpcy5jaGF0W2NoYXRJbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZCA9IG51bGw7CiAgICB0aGlzLmNoYXRbY2hhdEluZGV4XS5yZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzID0gT2JqZWN0KHRoaXMuY2hhdFtjaGF0SW5kZXhdLnJlZnVuZF9vcmRlcnNfbGlzdFtvcmRlckluZGV4XSk7CiAgICB0aGlzLmNoYXRbY2hhdEluZGV4XS5yZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzLmxpbmVfaXRlbXMgPSBvcmRlckxpbmVJdGVtcy5tYXAoZnVuY3Rpb24gKGxpbmVJdGVtKSB7CiAgICAgIHZhciBsaW5lSXRlbU5vZGUgPSBsaW5lSXRlbTsKICAgICAgbGluZUl0ZW1Ob2RlLnNlbGVjdGVkX3F1YW50aXR5ID0gX3RoaXMzMS5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAibWFnZW50byIgPyBsaW5lSXRlbS5xdHlfb3JkZXJlZCA6IGxpbmVJdGVtLnF1YW50aXR5OwogICAgICBsaW5lSXRlbU5vZGUuYWxyZWFkeV9yZWZ1bmRlZF9xdHkgPSBfdGhpczMxLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJtYWdlbnRvIiA/IGxpbmVJdGVtLnF0eV9yZWZ1bmRlZCA6IDA7CiAgICAgIGxpbmVJdGVtTm9kZS5xdHlfYXZhaWxhYmxlX2Zvcl9yZWZ1bmQgPSBfdGhpczMxLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJtYWdlbnRvIiA/IGxpbmVJdGVtLnF0eV9vcmRlcmVkIDogbGluZUl0ZW0ucXVhbnRpdHk7CiAgICAgIGxpbmVJdGVtTm9kZS5wcm9kdWN0X2lkID0gbGluZUl0ZW0ucHJvZHVjdF9pZDsKICAgICAgbGluZUl0ZW1Ob2RlLnZhcmlhbnRfaWQgPSBfdGhpczMxLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJtYWdlbnRvIiA/IGxpbmVJdGVtLnNrdSA6IGxpbmVJdGVtLnZhcmlhbnRfaWQ7CiAgICAgIHJldHVybiBsaW5lSXRlbU5vZGU7CiAgICB9KTsKCiAgICBpZiAoQm9vbGVhbihvcmRlclJlZnVuZHMpID09PSB0cnVlKSB7CiAgICAgIG9yZGVyUmVmdW5kcyA9IG9yZGVyUmVmdW5kcy5tYXAoZnVuY3Rpb24gKGxpbmVJdGVtKSB7CiAgICAgICAgcmV0dXJuIGxpbmVJdGVtLnJlZnVuZF9saW5lX2l0ZW1zWzBdOwogICAgICB9KTsKICAgICAgdmFyIEFscmVhZHlSZWZ1bmRlZFF0eSA9IFtdOwogICAgICBvcmRlclJlZnVuZHMucmVkdWNlKGZ1bmN0aW9uIChyZXMsIHZhbHVlKSB7CiAgICAgICAgaWYgKCFyZXNbdmFsdWUubGluZV9pdGVtX2lkXSkgewogICAgICAgICAgcmVzW3ZhbHVlLmxpbmVfaXRlbV9pZF0gPSB7CiAgICAgICAgICAgIGxpbmVfaXRlbV9pZDogdmFsdWUubGluZV9pdGVtX2lkLAogICAgICAgICAgICBxdWFudGl0eTogMAogICAgICAgICAgfTsKICAgICAgICAgIEFscmVhZHlSZWZ1bmRlZFF0eS5wdXNoKHJlc1t2YWx1ZS5saW5lX2l0ZW1faWRdKTsKICAgICAgICB9CgogICAgICAgIHJlc1t2YWx1ZS5saW5lX2l0ZW1faWRdLnF1YW50aXR5ICs9IHZhbHVlLnF1YW50aXR5OwogICAgICAgIHJldHVybiByZXM7CiAgICAgIH0sIHt9KTsKICAgICAgdmFyIHRlbXAgPSB0aGlzLmNoYXRbY2hhdEluZGV4XS5yZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzLmxpbmVfaXRlbXM7CiAgICAgIHRoaXMuY2hhdFtjaGF0SW5kZXhdLnJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMubGluZV9pdGVtcyA9IHRlbXAubWFwKGZ1bmN0aW9uIChsaW5lSXRlbSkgewogICAgICAgIHZhciBsaW5lSXRlbU5vZGUgPSBsaW5lSXRlbTsKCiAgICAgICAgZm9yICh2YXIgaSBpbiBBbHJlYWR5UmVmdW5kZWRRdHkpIHsKICAgICAgICAgIGlmIChsaW5lSXRlbS5pZCA9PSBBbHJlYWR5UmVmdW5kZWRRdHlbaV0ubGluZV9pdGVtX2lkKSB7CiAgICAgICAgICAgIGxpbmVJdGVtTm9kZS5hbHJlYWR5X3JlZnVuZGVkX3F0eSA9IEFscmVhZHlSZWZ1bmRlZFF0eVtpXVsncXVhbnRpdHknXTsKICAgICAgICAgICAgbGluZUl0ZW1Ob2RlLnF0eV9hdmFpbGFibGVfZm9yX3JlZnVuZCA9IGxpbmVJdGVtLnF1YW50aXR5IC0gQWxyZWFkeVJlZnVuZGVkUXR5W2ldWydxdWFudGl0eSddOwogICAgICAgICAgICBsaW5lSXRlbU5vZGUuc2VsZWN0ZWRfcXVhbnRpdHkgPSBsaW5lSXRlbS5xdWFudGl0eSAtIEFscmVhZHlSZWZ1bmRlZFF0eVtpXVsncXVhbnRpdHknXTsKICAgICAgICAgICAgbGluZUl0ZW1Ob2RlLnByb2R1Y3RfaWQgPSBsaW5lSXRlbS5wcm9kdWN0X2lkOwogICAgICAgICAgICBsaW5lSXRlbU5vZGUudmFyaWFudF9pZCA9IF90aGlzMzEucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iID8gbGluZUl0ZW0uc2t1IDogbGluZUl0ZW0udmFyaWFudF9pZDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIDsKICAgICAgICByZXR1cm4gbGluZUl0ZW1Ob2RlOwogICAgICB9KTsKICAgIH0KCiAgICB0aGlzLiRzZXQodGhpcy5jaGF0LCBjaGF0SW5kZXgsIHRoaXMuY2hhdFtjaGF0SW5kZXhdKTsKICB9LAogIHJlZnJlc2hfb3JfcmVtb3ZlX29yZGVyX2RldGFpbHM6IGZ1bmN0aW9uIHJlZnJlc2hfb3JfcmVtb3ZlX29yZGVyX2RldGFpbHMoY2hhdEluZGV4LCB2YWwpIHsKICAgIGlmICh2YWwgPT0gInJlbW92ZSIpIHsKICAgICAgdGhpcy5jaGF0W2NoYXRJbmRleF0ucmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlscyA9IHt9OwogICAgfQoKICAgIHRoaXMuJHNldCh0aGlzLmNoYXQsIGNoYXRJbmRleCwgdGhpcy5jaGF0W2NoYXRJbmRleF0pOwogIH0sCiAgbG9hZF9jdXN0b21lcl9vcmRlcnM6IGZ1bmN0aW9uIGxvYWRfY3VzdG9tZXJfb3JkZXJzKG9yZGVyc0RhdGEsIGluZGV4LCBvcmRlcl90eXBlKSB7CiAgICB2YXIgX3RoaXMzMiA9IHRoaXM7CgogICAgLy8gdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9IGBPcmRlciAke29yZGVyTmFtZX1gOwogICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKCiAgICBpZiAob3JkZXJfdHlwZSA9PT0gInJlZnVuZCIpIHsKICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJGZXRjaGluZyB5b3VyIG9yZGVycyAuLi4iOwogICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9vcmRlcnNfbGlzdCA9IG9yZGVyc0RhdGEubWFwKGZ1bmN0aW9uIChvcmRlcikgewogICAgICAgIHZhciBvcmRlck9iamVjdCA9IG9yZGVyOwogICAgICAgIG9yZGVyT2JqZWN0LmNyZWF0ZWRfYXQgPSBtb21lbnQob3JkZXJPYmplY3QuY3JlYXRlZF9hdCwgWyJZWVlZLU1NLUREVGg6bTpzWiJdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIik7CiAgICAgICAgb3JkZXJPYmplY3QubmFtZSA9IF90aGlzMzIucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gInNob3BpZnkiID8gb3JkZXJPYmplY3QubmFtZSA6IG9yZGVyT2JqZWN0LmlkOwogICAgICAgIG9yZGVyT2JqZWN0LnByb2Nlc3NlZEF0ID0gbW9tZW50KG9yZGVyT2JqZWN0LmNyZWF0ZWRfYXQsIFsiWVlZWS1NTS1ERFRoaDptbTpzc1oiXSkuZm9ybWF0KCJEbyBNTU0gWVlZWSIpOyAvLyBjdXJfbm9kZS5mdWxmaWxsbWVudFN0YXR1cyA9IGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1czsKCiAgICAgICAgb3JkZXJPYmplY3QuZnVsZmlsbG1lbnRfc3RhdHVzID0gQm9vbGVhbihvcmRlck9iamVjdC5mdWxmaWxsbWVudF9zdGF0dXMpID09PSB0cnVlID8gb3JkZXJPYmplY3QuZnVsZmlsbG1lbnRfc3RhdHVzIDogIlVuZnVsZmlsbGVkIjsgLy8gU2V0IG9ubHkgZmlyc3QgY2hhcmFjdGVyIHRvIHVwcGVyY2FzZSB3aGlsZSByZW1haW5pbmcgY2hhcmFjdGVycyBzZXQgdG8gbG93ZXJjYXNlCgogICAgICAgIG9yZGVyT2JqZWN0LmZ1bGZpbGxtZW50X3N0YXR1cyA9IG9yZGVyT2JqZWN0LmZ1bGZpbGxtZW50X3N0YXR1cy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG9yZGVyT2JqZWN0LmZ1bGZpbGxtZW50X3N0YXR1cy5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICBpZiAoX3RoaXMzMi5yZXRhaWxfd2ViX2ZyYW1ld29yayAhPSAic2hvcGlmeSIpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb3JkZXJPYmplY3Qub3JkZXJfbm90ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgb3JkZXJPYmplY3Qub3JkZXJfbm90ZXNbaV0uZGF0ZV9jcmVhdGVkID0gbW9tZW50KG9yZGVyT2JqZWN0Lm9yZGVyX25vdGVzW2ldLmRhdGVfY3JlYXRlZCwgWyJZWVlZLU1NLUREVGhoOm1tOnNzWiJdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIEhIOm1tIGEiKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBvcmRlck9iamVjdDsKICAgICAgfSk7CgogICAgICBpZiAodGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJUaGVyZSBhcmUgbm8gb3JkZXJzIHRvIGJlIGRpc3BsYXllZCI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJTZWxlY3QgdGhlIG9yZGVyIHRoYXQgeW91IHdpc2ggdG8gcmV0dXJuIjsKICAgICAgfSAvLyB0aGlzLnJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMgPSB7fTsKCgogICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMgPSB7fTsKICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfc2VsZWN0ZWRfaXRlbXMgPSBbXTsKICAgICAgdGhpcy5jaGF0W2luZGV4XS5zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX2xpc3QgPSBudWxsOwogICAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmQgPSBudWxsOwogICAgICB0aGlzLmNoYXRbaW5kZXhdLmNvbnZlcnNhdGlvbl9vbmx5ID0gZmFsc2U7CiAgICAgIHRoaXMuY2hhdFtpbmRleF0uY29udmVyc2F0aW9uX29ubHkgPSB0cnVlOwogICAgfSBlbHNlIGlmIChvcmRlcl90eXBlID09PSAiYWxsX29yZGVycyIpIHsKICAgICAgdmFyIG9yZGVyc19kYXRhID0gb3JkZXJzRGF0YSwKICAgICAgICAgIGNvbXBsZXRlX29yZGVyc19kYXRhID0gW107CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9yZGVyc19kYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGN1cl9ub2RlID0gb3JkZXJzX2RhdGFbaV07CiAgICAgICAgY3VyX25vZGUucHJvY2Vzc2VkQXQgPSBtb21lbnQoY3VyX25vZGUuY3JlYXRlZF9hdCwgWyJZWVlZLU1NLUREVGhoOm1tOnNzWiJdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIik7IC8vIGN1cl9ub2RlLmZ1bGZpbGxtZW50U3RhdHVzID0gY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzOwoKICAgICAgICBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMgPSBCb29sZWFuKGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cykgPT09IHRydWUgPyBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMgOiAiVW5mdWxmaWxsZWQiOyAvLyAvLyBTZXQgb25seSBmaXJzdCBjaGFyYWN0ZXIgdG8gdXBwZXJjYXNlIHdoaWxlIHJlbWFpbmluZyBjaGFyYWN0ZXJzIHNldCB0byBsb3dlcmNhc2UKCiAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzID0gY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzLnNsaWNlKDEpLnRvTG93ZXJDYXNlKCk7CgogICAgICAgIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrICE9ICJzaG9waWZ5IikgewogICAgICAgICAgZm9yICh2YXIgX2k3ID0gMDsgX2k3IDwgY3VyX25vZGUub3JkZXJfbm90ZXMubGVuZ3RoOyBfaTcrKykgewogICAgICAgICAgICBjdXJfbm9kZS5vcmRlcl9ub3Rlc1tfaTddLmRhdGVfY3JlYXRlZCA9IG1vbWVudChjdXJfbm9kZS5vcmRlcl9ub3Rlc1tfaTddLmRhdGVfY3JlYXRlZCwgWyJZWVlZLU1NLUREVGhoOm1tOnNzWiJdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIEhIOm1tIGEiKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNvbXBsZXRlX29yZGVyc19kYXRhLnB1c2goewogICAgICAgICAgbmFtZTogdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIgPyBjdXJfbm9kZS5uYW1lIDogY3VyX25vZGUuaWQsCiAgICAgICAgICBwcm9jZXNzZWRfZGF0ZTogY3VyX25vZGUucHJvY2Vzc2VkQXQsCiAgICAgICAgICBmdWxmaWxsbWVudF9zdGF0dXM6IGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cywKICAgICAgICAgIHN0YXR1c191cmw6IGN1cl9ub2RlLm9yZGVyX3N0YXR1c191cmwsCiAgICAgICAgICBvcmRlcl9ub3RlczogdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIgPyBudWxsIDogY3VyX25vZGUub3JkZXJfbm90ZXMKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGhpcy5jaGF0W2luZGV4XS5zaG93X2FsbF9vcmRlcnNfbGlzdCA9IHRydWU7CiAgICAgIHRoaXMuY2hhdFtpbmRleF0uYWxsX29yZGVyc19saXN0ID0gY29tcGxldGVfb3JkZXJzX2RhdGE7CgogICAgICBpZiAodGhpcy5jaGF0W2luZGV4XS5hbGxfb3JkZXJzX2xpc3QubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJUaGVyZSBhcmUgbm8gb3JkZXJzIHRvIGJlIGRpc3BsYXllZCI7CiAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5zaG93X2FsbF9vcmRlcnNfbGlzdCA9IGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPSAiUGxlYXNlIEZpbmQgQmVsb3cgWW91ciBMYXRlc3QgT3JkZXJzOiI7CiAgICAgIH0KCiAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZW50X29yZGVyc19saXN0ID0gY29tcGxldGVfb3JkZXJzX2RhdGE7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzMzIuY2hhdFtpbmRleF0uY29udmVyc2F0aW9uX29ubHkgPSB0cnVlOwogICAgICB9LCA1MDApOwogICAgfQoKICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogIH0sCiAgc3VibWl0X3JlZnVuZF9yZXF1ZXN0OiBmdW5jdGlvbiBzdWJtaXRfcmVmdW5kX3JlcXVlc3QocmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlscywgaW5kZXgpIHsKICAgIHZhciBfdGhpczMzID0gdGhpczsKCiAgICBpZiAodGhpcy5jaGF0W2luZGV4XS5zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX2xpc3QgPT09IG51bGwpIHsKICAgICAgdGhpcy5zaG93X3Nob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmRfZXJyb3IgPSB0cnVlOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHRoaXMuY2hhdFtpbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZF9saXN0ID09PSAnT3RoZXJzJykgewogICAgICBpZiAodGhpcy5jaGF0W2luZGV4XS5zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kID09PSBudWxsIHx8IHRoaXMuY2hhdFtpbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZCA9PT0gIiIpIHsKICAgICAgICB0aGlzLnNob3dfc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZF9lcnJvciA9IHRydWU7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmQgPSB0aGlzLmNoYXRbaW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmRfbGlzdDsKICAgIH0gLy8gZWxzZSB7CgoKICAgIHRoaXMuc2hvd19zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX2Vycm9yID0gZmFsc2U7CiAgICB2YXIgaXRlbXNfdG9fcmVmdW5kID0gcmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlscy5saW5lX2l0ZW1zLmZpbHRlcihmdW5jdGlvbiAobGluZUl0ZW0pIHsKICAgICAgaWYgKF90aGlzMzMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gJ21hZ2VudG8nKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMzMuY2hhdFtpbmRleF0ucmVmdW5kX3NlbGVjdGVkX2l0ZW1zLmluY2x1ZGVzKGxpbmVJdGVtLnByb2R1Y3RfaWQpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBfdGhpczMzLmNoYXRbaW5kZXhdLnJlZnVuZF9zZWxlY3RlZF9pdGVtcy5pbmNsdWRlcyhsaW5lSXRlbS5pZCk7CiAgICAgIH0KICAgIH0pOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXNfdG9fcmVmdW5kLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChpdGVtc190b19yZWZ1bmRbaV0uc2VsZWN0ZWRfcXVhbnRpdHkgPT09IG51bGwgfHwgQm9vbGVhbihpdGVtc190b19yZWZ1bmRbaV0uc2VsZWN0ZWRfcXVhbnRpdHkpID09PSBmYWxzZSkgewogICAgICAgIHN3YWwoewogICAgICAgICAgdGV4dDogIlBsZWFzZSBlbnRlciB0aGUgcHJvZHVjdCBxdWFudGl0eSBpbiBudW1lcmljIG9ubHkiLAogICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICBwb3NpdGlvbjogInRvcC1lbmQiLAogICAgICAgICAgdHlwZTogIndhcm5pbmciLAogICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgdGltZXI6IDUwMDAKICAgICAgICB9KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KCiAgICB2YXIgcmVmdW5kX3BheWxvYWRfc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoewogICAgICBvcmRlcklkOiByZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzLmlkLAogICAgICBvcmRlcl9uYW1lOiByZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzLm5hbWUsCiAgICAgIGN1c3RvbWVyX2lkOiB0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQsCiAgICAgIGZ1bGZpbGxtZW50X3N0YXR1czogcmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlscy5mdWxmaWxsbWVudF9zdGF0dXMsCiAgICAgIHBheW1lbnRfc3RhdHVzOiByZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzLnBheW1lbnRfc3RhdHVzLAogICAgICBjdXJyZW5jeTogdGhpcy5yZXRhaWxfc2hvcF9jdXJyZW5jeSwKICAgICAgbGluZUl0ZW1zOiBpdGVtc190b19yZWZ1bmQubWFwKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGxpbmVfaXRlbV9pZDogX3RoaXMzMy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAnbWFnZW50bycgPyBpdGVtLnByb2R1Y3RfaWQgOiBpdGVtLmlkLAogICAgICAgICAgcXVhbnRpdHk6IGl0ZW0uc2VsZWN0ZWRfcXVhbnRpdHksCiAgICAgICAgICBwcm9kdWN0X2lkOiBpdGVtLnByb2R1Y3RfaWQsCiAgICAgICAgICB2YXJpYW50X2lkOiBpdGVtLnZhcmlhbnRfaWQKICAgICAgICB9OwogICAgICB9KSwKICAgICAgcmVmdW5kUmVhc29uOiB0aGlzLmNoYXRbaW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmQKICAgIH0pOwogICAgdmFyIHJlZnVuZF9pbnRlbnQgPSAiL3Byb2Nlc3NfcmVmdW5kX3JlcXVlc3QiLmNvbmNhdChyZWZ1bmRfcGF5bG9hZF9zdHJpbmcpOwogICAgdmFyIHJlZnVuZF9vYmplY3QgPSB7CiAgICAgIHRpdGxlOiAiUHJvY2VlZCIsCiAgICAgIHZhbHVlOiByZWZ1bmRfaW50ZW50CiAgICB9OyAvLyBjb25zb2xlLmxvZyhyZWZ1bmRfaW50ZW50KTsKCiAgICB0aGlzLnNlbmRfbWVzc2FnZSgiaXNfYnV0dG9uIiwgcmVmdW5kX29iamVjdCk7CiAgICB0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMgPSB7fTsKICAgIHRoaXMuY2hhdFtpbmRleF0ucmVmdW5kX3NlbGVjdGVkX2l0ZW1zID0gW107CiAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmRfbGlzdCA9IG51bGw7CiAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmQgPSBudWxsOwogICAgdGhpcy5jaGF0LnNwbGljZShpbmRleCwgMSk7IC8vIH0KICB9LAogIHNob3BpZnlfZm9ybV9mb2N1czogZnVuY3Rpb24gc2hvcGlmeV9mb3JtX2ZvY3VzKGluZGV4KSB7CiAgICBpZiAodGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9PT0gIldlIGFyZSBzb3JyeSwgeW91ciBjcmVkZW50aWFscyBhcmUgaW52YWxpZC4gUGxlYXNlIHRyeSBhZ2FpbiA6KSIpIHsKICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJQbGVhc2UgbG9naW4gd2l0aCB5b3VyIGNyZWRlbnRpYWxzIGZvciBiZXR0ZXIgZXhwZXJpZW5jZSA6KSI7CiAgICB9CiAgfSwKICBzaG9waWZ5X2NyZWF0ZV9jdXN0b21lcl90b2tlbjogZnVuY3Rpb24gc2hvcGlmeV9jcmVhdGVfY3VzdG9tZXJfdG9rZW4oaW5kZXgsIGlzUmVmdW5kKSB7CiAgICB2YXIgX2F4aW9zJHBvc3QxMCwKICAgICAgICBfdGhpczM0ID0gdGhpczsKCiAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgaXNSZWZ1bmQgPSBpc1JlZnVuZCB8fCBmYWxzZTsKCiAgICBpZiAodGhpcy5jaGF0W2luZGV4XS5yZXR1cm5fc2hvcGlmeV9lbWFpbCA9PT0gdHJ1ZSAmJiAhaXNSZWZ1bmQpIHsKICAgICAgdGhpcy5zZW5kX3Nob3BpZnlfY3VzdG9tZXJfaWQoaW5kZXgsIHRydWUpOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHNob3BfZW5kcG9pbnQgPSB0aGlzLnNob3BpZnlfcmV0YWlsX3Nob3BfbmFtZSArICIubXlzaG9waWZ5LmNvbSI7CiAgICB2YXIgcXVlcnlTdHJpbmcgPSAkKCIjc2hvcGlmeV9sb2dpbl9mb3JtIikuc2VyaWFsaXplQXJyYXkoKTsKICAgIHZhciBmb3JtX3BheWxvYWQgPSB7fTsKICAgIGZvcm1fcGF5bG9hZFsic2hvcGlmeV9pc19vbmx5X2VtYWlsIl0gPSB0aGlzLnJldGFpbF9vcmRlcl9yZXRyZWl2YWxfb25seV9lbWFpbF9yZXF1aXJlZDsKICAgIGZvcm1fcGF5bG9hZFsnZW1haWwnXSA9IHRoaXMuY2hhdFtpbmRleF0uY3VzdG9tZXJfZW1haWxfaWQ7CiAgICBmb3JtX3BheWxvYWRbJ3Bhc3N3b3JkJ10gPSB0aGlzLmNoYXRbaW5kZXhdLmN1c3RvbWVyX3Bhc3N3b3JkOyAvLyBmb3IgKHZhciBpIGluIHF1ZXJ5U3RyaW5nKSB7CiAgICAvLyAgIGZvcm1fcGF5bG9hZFtxdWVyeVN0cmluZ1tpXS5uYW1lXSA9IHRoaXMuY2hhdFtpbmRleF0uY3VzdG9tZXJfZW1haWxfaWQ7CiAgICAvLyB9CgogICAgZm9ybV9wYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkoZm9ybV9wYXlsb2FkKTsKICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgKF9heGlvcyRwb3N0MTAgPSB7CiAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgY2hhdDogIi9zaG9waWZ5X2NyZWF0ZV9jdXN0b21lcl90b2tlbiIuY29uY2F0KGZvcm1fcGF5bG9hZCkKICAgIH0sIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDEwLCAidG9rZW4iLCB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSksIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDEwLCAicm9sZSIsIHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MTAsICJyZWZyZXNoZWRfb3JfY2xvc2VkIiwgdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkKSwgX2F4aW9zJHBvc3QxMCkpLnRoZW4oZnVuY3Rpb24gKF9yZWYyKSB7CiAgICAgIHZhciBkYXRhID0gX3JlZjIuZGF0YTsKCiAgICAgIC8vIGNvbnNvbGUubG9nKGRhdGEpOwogICAgICAvLyBpZiAoQm9vbGVhbihkYXRhLnJlc3BvbnNlc1swXS5EYXRhLmFjY2Vzc1Rva2VuKSkgewogICAgICAvLyAgIGxldCBjdXN0b21lclRva2VuID0gZGF0YS5yZXNwb25zZXNbMF0uRGF0YS5hY2Nlc3NUb2tlbjsKICAgICAgLy8gICBsZXQgdG9rZW5FeHBpcnkgPSBkYXRhLnJlc3BvbnNlc1swXS5EYXRhLmV4cGlyZXNBdDsKICAgICAgLy8gICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIsIGN1c3RvbWVyVG9rZW4pOwogICAgICAvLyAgIHRoaXMuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuX2V4cGlyeSIsIHRva2VuRXhwaXJ5KTsKICAgICAgLy8gICB0aGlzLnNob3BpZnlfZmV0Y2hfb3JkZXJzKGN1c3RvbWVyVG9rZW4sIGluZGV4LCBpc1JlZnVuZCk7CiAgICAgIC8vIH0gZWxzZSB7CiAgICAgIC8vICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9CiAgICAgIC8vICAgICAiV2UgYXJlIHNvcnJ5LCB5b3VyIGNyZWRlbnRpYWxzIGFyZSBpbnZhbGlkLiBQbGVhc2UgdHJ5IGFnYWluIDopIjsKICAgICAgLy8gfQogICAgICBpZiAoZGF0YS5yZXNwb25zZXNbMF0udG9rZW5fdHlwZSA9PT0gImN1c3RvbWVyX3Rva2VuIikgewogICAgICAgIGlmIChCb29sZWFuKGRhdGEucmVzcG9uc2VzWzBdLkRhdGEpKSB7CiAgICAgICAgICBpZiAoX3RoaXMzNC5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIpIHsKICAgICAgICAgICAgdmFyIGN1c3RvbWVyVG9rZW4gPSBkYXRhLnJlc3BvbnNlc1swXS5EYXRhLmFjY2Vzc1Rva2VuOwogICAgICAgICAgICB2YXIgdG9rZW5FeHBpcnkgPSBkYXRhLnJlc3BvbnNlc1swXS5EYXRhLmV4cGlyZXNBdDsKCiAgICAgICAgICAgIF90aGlzMzQuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIiwgY3VzdG9tZXJUb2tlbik7CgogICAgICAgICAgICBfdGhpczM0LiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbl9leHBpcnkiLCB0b2tlbkV4cGlyeSk7CgogICAgICAgICAgICBfdGhpczM0LnNob3BpZnlfZmV0Y2hfb3JkZXJzKGN1c3RvbWVyVG9rZW4sIGluZGV4LCBpc1JlZnVuZCwgInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iKTsKICAgICAgICAgIH0gZWxzZSBpZiAoX3RoaXMzNC5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAid29vY29tbWVyY2UiKSB7CiAgICAgICAgICAgIHZhciBfY3VzdG9tZXJUb2tlbiA9IGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbWVyX2RhdGEuY3VzdG9tZXJfZW1haWw7CiAgICAgICAgICAgIHZhciBfdG9rZW5FeHBpcnkgPSBkYXRhLnJlc3BvbnNlc1swXS5EYXRhLmV4cGlyZXNBdDsKICAgICAgICAgICAgdmFyIGN1c3RvbWVySWQgPSBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b21lcl9kYXRhLmN1c3RvbWVyX2lkOwogICAgICAgICAgICBfdGhpczM0LnNob3BpZnlfY3VzdG9tZXJfaWQgPSBjdXN0b21lcklkOwoKICAgICAgICAgICAgX3RoaXMzNC4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iLCBfY3VzdG9tZXJUb2tlbik7CgogICAgICAgICAgICBfdGhpczM0LiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbl9leHBpcnkiLCBfdG9rZW5FeHBpcnkpOwoKICAgICAgICAgICAgX3RoaXMzNC4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiLCBjdXN0b21lcklkKTsKCiAgICAgICAgICAgIF90aGlzMzQuc2hvcGlmeV9mZXRjaF9vcmRlcnMoX2N1c3RvbWVyVG9rZW4sIGluZGV4LCBpc1JlZnVuZCwgInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iKTsKICAgICAgICAgIH0gZWxzZSBpZiAoX3RoaXMzNC5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAibWFnZW50byIpIHsKICAgICAgICAgICAgdmFyIF9jdXN0b21lclRva2VuMiA9IGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbWVyX2RhdGEuY3VzdG9tZXJfZW1haWw7CiAgICAgICAgICAgIHZhciBfdG9rZW5FeHBpcnkyID0gZGF0YS5yZXNwb25zZXNbMF0uRGF0YS5leHBpcmVzQXQ7CiAgICAgICAgICAgIHZhciBfY3VzdG9tZXJJZCA9IGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbWVyX2RhdGEuY3VzdG9tZXJfaWQ7CiAgICAgICAgICAgIF90aGlzMzQuc2hvcGlmeV9jdXN0b21lcl9pZCA9IF9jdXN0b21lcklkOwoKICAgICAgICAgICAgX3RoaXMzNC4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iLCBfY3VzdG9tZXJUb2tlbjIpOwoKICAgICAgICAgICAgX3RoaXMzNC4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW5fZXhwaXJ5IiwgX3Rva2VuRXhwaXJ5Mik7CgogICAgICAgICAgICBfdGhpczM0LiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl9pZCIsIF9jdXN0b21lcklkKTsKCiAgICAgICAgICAgIF90aGlzMzQuc2hvcGlmeV9mZXRjaF9vcmRlcnMoX2N1c3RvbWVyVG9rZW4yLCBpbmRleCwgaXNSZWZ1bmQsICJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIF90aGlzMzQuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPSAiV2UgYXJlIHNvcnJ5LCB5b3VyIGNyZWRlbnRpYWxzIGFyZSBpbnZhbGlkLiBQbGVhc2UgdHJ5IGFnYWluIDopIjsKICAgICAgICAgIF90aGlzMzQuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChkYXRhLnJlc3BvbnNlc1swXS50b2tlbl90eXBlID09PSAiY3VzdG9tZXJfaWQiKSB7CiAgICAgICAgLy8gaWYgKEJvb2xlYW4oZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfaWQpKSB7CiAgICAgICAgaWYgKF90aGlzMzQucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gInNob3BpZnkiKSB7CiAgICAgICAgICB2YXIgX2N1c3RvbWVySWQyID0gZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfaWQ7CiAgICAgICAgICB2YXIgY3VzdG9tZXJFbWFpbCA9IGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbWVyX2VtYWlsOwogICAgICAgICAgX3RoaXMzNC5zaG9waWZ5X2N1c3RvbWVyX2lkID0gX2N1c3RvbWVySWQyOwoKICAgICAgICAgIF90aGlzMzQuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIiwgX2N1c3RvbWVySWQyKTsKCiAgICAgICAgICBfdGhpczM0LiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIsIGN1c3RvbWVyRW1haWwpOwoKICAgICAgICAgIF90aGlzMzQuc2hvcGlmeV9mZXRjaF9vcmRlcnMoX2N1c3RvbWVySWQyLCBpbmRleCwgaXNSZWZ1bmQsICJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CiAgICAgICAgfSBlbHNlIGlmIChfdGhpczM0LnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJ3b29jb21tZXJjZSIpIHsKICAgICAgICAgIHZhciBfY3VzdG9tZXJJZDMgPSBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b21lcl9pZDsKICAgICAgICAgIHZhciBfY3VzdG9tZXJFbWFpbCA9IGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbWVyX2VtYWlsOwoKICAgICAgICAgIF90aGlzMzQuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIiwgX2N1c3RvbWVySWQzKTsKCiAgICAgICAgICBfdGhpczM0LiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIsIF9jdXN0b21lckVtYWlsKTsKCiAgICAgICAgICBfdGhpczM0LnNob3BpZnlfZmV0Y2hfb3JkZXJzKF9jdXN0b21lcklkMywgaW5kZXgsIGlzUmVmdW5kLCAic2hvcGlmeV9jdXN0b21lcl9pZCIpOwogICAgICAgIH0gZWxzZSBpZiAoX3RoaXMzNC5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAibWFnZW50byIpIHsKICAgICAgICAgIHZhciBfY3VzdG9tZXJJZDQgPSBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b21lcl9pZDsKICAgICAgICAgIHZhciBfY3VzdG9tZXJFbWFpbDIgPSBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b21lcl9lbWFpbDsKCiAgICAgICAgICBfdGhpczM0LiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl9pZCIsIF9jdXN0b21lcklkNCk7CgogICAgICAgICAgX3RoaXMzNC4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iLCBfY3VzdG9tZXJFbWFpbDIpOwoKICAgICAgICAgIF90aGlzMzQuc2hvcGlmeV9mZXRjaF9vcmRlcnMoX2N1c3RvbWVySWQ0LCBpbmRleCwgaXNSZWZ1bmQsICJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CiAgICAgICAgfSAvLyB9IAogICAgICAgIGVsc2UgewogICAgICAgICAgICBfdGhpczM0LmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gIldlIGFyZSBzb3JyeSwgY291bGQgbm90IGZpbmQgYW55IHJlY29yZHMgd2l0aCB0aGlzIGVtYWlsLiBQbGVhc2UgdHJ5IGFnYWluIDopIjsKICAgICAgICAgICAgX3RoaXMzNC5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgX3RoaXMzNC5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJXZSBhcmUgc29ycnksIHlvdXIgY3JlZGVudGlhbHMgYXJlIGludmFsaWQuIFBsZWFzZSB0cnkgYWdhaW4gOikiOwogICAgICAgIF90aGlzMzQuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICB9IC8vIHRoaXMuY2hhdC5zcGxpY2UoaW5kZXgsIDEpOwoKICAgIH0pOwogIH0sCiAgc2hvcGlmeV9mZXRjaF9jdXN0b21lcl9pZDogZnVuY3Rpb24gc2hvcGlmeV9mZXRjaF9jdXN0b21lcl9pZChjdXN0b21lckFjY2Vzc1Rva2VuLCBpbmRleCwgdG9rZW5fdHlwZSkgewogICAgdmFyIF90aGlzMzUgPSB0aGlzOwoKICAgIHZhciBzaG9wX2VuZHBvaW50ID0gdGhpcy5zaG9waWZ5X3JldGFpbF9zaG9wX25hbWUgKyAiLm15c2hvcGlmeS5jb20iOwogICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKCiAgICBpZiAoIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QpKSB7CiAgICAgIGlmICh0b2tlbl90eXBlID09PSAic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpIHsKICAgICAgICB2YXIgX2F4aW9zJHBvc3QxMTsKCiAgICAgICAgdmFyIHN0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBjdXN0b21lcl9hY2Nlc3NfdG9rZW46IGN1c3RvbWVyQWNjZXNzVG9rZW4gLy9zaG9waWZ5IGFjY2VzcyB0b2tlbiA9PSBlbWFpbCBmb3Igd29vY29tbWVyY2UKCiAgICAgICAgfSk7CiAgICAgICAgYXhpb3MucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCAoX2F4aW9zJHBvc3QxMSA9IHsKICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgIGNoYXQ6ICIvc2hvcGlmeV9nZXRfY3VzdG9tZXJfaWRfYW5kX29yZGVycyIuY29uY2F0KHN0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWQpCiAgICAgICAgfSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MTEsICJ0b2tlbiIsIHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MTEsICJyb2xlIiwgdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3QxMSwgInJlZnJlc2hlZF9vcl9jbG9zZWQiLCB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQpLCBfYXhpb3MkcG9zdDExKSkudGhlbihmdW5jdGlvbiAoX3JlZjMpIHsKICAgICAgICAgIHZhciBkYXRhID0gX3JlZjMuZGF0YTsKCiAgICAgICAgICBpZiAoQm9vbGVhbihkYXRhLnJlc3BvbnNlc1swXS5jdXN0b20pKSB7CiAgICAgICAgICAgIF90aGlzMzUubG9hZF9jdXN0b21lcl9vcmRlcnMoZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tLm9yZGVyc19saXN0LCBpbmRleCwgInJlZnVuZCIpOyAvLyB0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQgPSBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b20uY3VzdG9tZXJfaWQ7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX3RoaXMzNS5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJTb21lIEVycm9yIE9jY3VycmVkLiBQbGVhc2UgVHJ5IEFnYWluIjsKICAgICAgICAgICAgX3RoaXMzNS5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICB9IC8vICAgbGV0IGN1c3RvbWVySWQgPSBhdG9iKGRhdGEuZGF0YS5jdXN0b21lci5pZCk7CiAgICAgICAgICAvLyAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IGN1c3RvbWVySWQuc2xpY2UoCiAgICAgICAgICAvLyAgICAgY3VzdG9tZXJJZC5sYXN0SW5kZXhPZigiLyIpICsgMQogICAgICAgICAgLy8gICApOwogICAgICAgICAgLy8gICBsZXQgc3RyaW5naWZpZWRfY3VzdG9tZXJfcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIC8vICAgICBjdXN0b21lcklkOiB0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQsCiAgICAgICAgICAvLyAgIH0pOwogICAgICAgICAgLy8gICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gIkZldGNoaW5nIHlvdXIgb3JkZXIgZGV0YWlscyAuLi4iOwogICAgICAgICAgLy8gICBheGlvcwogICAgICAgICAgLy8gICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgIC8vICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAvLyAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAvLyAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgLy8gICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgIC8vICAgICAgIGNoYXQ6IGAvcmV0cmlldmVfY3VzdG9tZXJfb3JkZXJzJHtzdHJpbmdpZmllZF9jdXN0b21lcl9wYXlsb2FkfWAsCiAgICAgICAgICAvLyAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAvLyAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgIC8vICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICAgIC8vICAgICB9KQogICAgICAgICAgLy8gICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgLy8gICAgICAgdGhpcy5sb2FkX2N1c3RvbWVyX29yZGVycygKICAgICAgICAgIC8vICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tLm9yZGVyc19saXN0LAogICAgICAgICAgLy8gICAgICAgICBpbmRleAogICAgICAgICAgLy8gICAgICAgKTsKICAgICAgICAgIC8vICAgICB9KQogICAgICAgICAgLy8gICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgLy8gICAgICAgY29uc29sZS5sb2coZSk7CiAgICAgICAgICAvLyAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICAvLyAgICAgfSk7CgogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHRva2VuX3R5cGUgPT0gInNob3BpZnlfY3VzdG9tZXJfaWQiKSB7CiAgICAgICAgdmFyIF9heGlvcyRwb3N0MTI7CgogICAgICAgIHZhciBfc3RyaW5naWZpZWRfY3VzdG9tZXJfcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIGN1c3RvbWVySWQ6IHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZAogICAgICAgIH0pOwoKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gIkZldGNoaW5nIHlvdXIgb3JkZXIgZGV0YWlscyAuLi4iOwogICAgICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgKF9heGlvcyRwb3N0MTIgPSB7CiAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICBjaGF0OiAiL3JldHJpZXZlX2N1c3RvbWVyX29yZGVycyIuY29uY2F0KF9zdHJpbmdpZmllZF9jdXN0b21lcl9wYXlsb2FkKQogICAgICAgIH0sIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDEyLCAidG9rZW4iLCB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSksIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDEyLCAicm9sZSIsIHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MTIsICJyZWZyZXNoZWRfb3JfY2xvc2VkIiwgdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkKSwgX2F4aW9zJHBvc3QxMikpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICBfdGhpczM1LmxvYWRfY3VzdG9tZXJfb3JkZXJzKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbS5vcmRlcnNfbGlzdCwgaW5kZXgsICJyZWZ1bmQiKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAgX3RoaXMzNS5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICBjb25zb2xlLmxvZyhlKTsKCiAgICAgICAgICBfdGhpczM1LnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9LAogIHNob3BpZnlfZmV0Y2hfb3JkZXJzOiBmdW5jdGlvbiBzaG9waWZ5X2ZldGNoX29yZGVycyhjdXN0b21lckFjY2Vzc1Rva2VuLCBpbmRleCwgaXNSZWZ1bmQsIHRva2VuX3R5cGUpIHsKICAgIHZhciBfdGhpczM2ID0gdGhpczsKCiAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgaXNSZWZ1bmQgPSBpc1JlZnVuZCB8fCBmYWxzZTsKICAgIHRoaXMuY2hhdFtpbmRleF0uY29udmVyc2F0aW9uX29ubHkgPSBmYWxzZTsKICAgIHZhciBzaG9wX2VuZHBvaW50ID0gdGhpcy5zaG9waWZ5X3JldGFpbF9zaG9wX25hbWUgKyAiLm15c2hvcGlmeS5jb20iOwoKICAgIGlmICh0b2tlbl90eXBlID09PSAic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpIHsKICAgICAgdmFyIF9heGlvcyRwb3N0MTM7CgogICAgICB2YXIgc3RyaW5naWZpZWRfY3VzdG9tZXJfcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICBjdXN0b21lcl9hY2Nlc3NfdG9rZW46IGN1c3RvbWVyQWNjZXNzVG9rZW4gLy93b29jb21tZXJjZSBjdXN0b21lciBlbWFpbAoKICAgICAgfSk7CiAgICAgIGF4aW9zLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgKF9heGlvcyRwb3N0MTMgPSB7CiAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgIGNoYXQ6ICIvc2hvcGlmeV9nZXRfY3VzdG9tZXJfb3JkZXJzIi5jb25jYXQoc3RyaW5naWZpZWRfY3VzdG9tZXJfcGF5bG9hZCkKICAgICAgfSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MTMsICJ0b2tlbiIsIHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MTMsICJyb2xlIiwgdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3QxMywgInJlZnJlc2hlZF9vcl9jbG9zZWQiLCB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQpLCBfYXhpb3MkcG9zdDEzKSkudGhlbihmdW5jdGlvbiAoX3JlZjQpIHsKICAgICAgICB2YXIgZGF0YSA9IF9yZWY0LmRhdGE7CiAgICAgICAgX3RoaXMzNi5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CgogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgY3VzdG9tZXJJZCA9IGF0b2IoZGF0YS5yZXNwb25zZXNbMF0uZGF0YS5jdXN0b21lci5pZCk7CiAgICAgICAgICBfdGhpczM2LnNob3BpZnlfY3VzdG9tZXJfaWQgPSBjdXN0b21lcklkLnNsaWNlKGN1c3RvbWVySWQubGFzdEluZGV4T2YoIi8iKSArIDEpOwoKICAgICAgICAgIF90aGlzMzYuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIiwgX3RoaXMzNi5zaG9waWZ5X2N1c3RvbWVyX2lkKTsKICAgICAgICB9IGNhdGNoIChlKSB7fQoKICAgICAgICBpZiAoX3RoaXMzNi5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIpIHsKICAgICAgICAgIHZhciBvcmRlcnNEYXRhID0gZGF0YS5yZXNwb25zZXNbMF0uZGF0YS5jdXN0b21lci5vcmRlcnMuZWRnZXM7CgogICAgICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PSAibnVtYmVyIiAmJiBvcmRlcnNEYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgLy8gb3JkZXJzRGF0YSA9IG9yZGVyc0RhdGFbMF0ubm9kZTsKICAgICAgICAgICAgLy8gbGV0IG9yZGVyTmFtZSA9IG9yZGVyc0RhdGEubmFtZTsKICAgICAgICAgICAgLy8gbGV0IG9yZGVyU3RhdHVzVXJsID0gb3JkZXJzRGF0YS5zdGF0dXNVcmw7CiAgICAgICAgICAgIC8vIGxldCBvcmRlclByb2Nlc3NpbmdEYXRlID0gbW9tZW50KG9yZGVyc0RhdGEucHJvY2Vzc2VkQXQsIFsKICAgICAgICAgICAgLy8gICAiWVlZWS1NTS1ERFRoaDptbTpzc1oiLAogICAgICAgICAgICAvLyBdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIik7CiAgICAgICAgICAgIGlmIChpc1JlZnVuZCkgewogICAgICAgICAgICAgIF90aGlzMzYuc2hvcGlmeV9mZXRjaF9jdXN0b21lcl9pZChjdXN0b21lckFjY2Vzc1Rva2VuLCBpbmRleCwgInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBfdGhpczM2LmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsgLy8gICBsZXQgb3JkZXJGdWxmaWxsbWVudFN0YXR1cyA9IG9yZGVyc0RhdGEuZnVsZmlsbG1lbnRTdGF0dXMucmVwbGFjZSgKICAgICAgICAgICAgICAvLyAgICAgIl8iLAogICAgICAgICAgICAgIC8vICAgICAiICIKICAgICAgICAgICAgICAvLyAgICk7CiAgICAgICAgICAgICAgLy8gICBsZXQgc3VjY2Vzc2Z1bE9yZGVyRnVsZmlsbG1lbnRzID0KICAgICAgICAgICAgICAvLyAgICAgb3JkZXJzRGF0YS5zdWNjZXNzZnVsRnVsZmlsbG1lbnRzOwogICAgICAgICAgICAgIC8vICAgLy8gU2V0IG9ubHkgZmlyc3QgY2hhcmFjdGVyIHRvIHVwcGVyY2FzZSB3aGlsZSByZW1haW5pbmcgY2hhcmFjdGVycyBzZXQgdG8gbG93ZXJjYXNlCiAgICAgICAgICAgICAgLy8gICBvcmRlckZ1bGZpbGxtZW50U3RhdHVzID0KICAgICAgICAgICAgICAvLyAgICAgb3JkZXJGdWxmaWxsbWVudFN0YXR1cy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArCiAgICAgICAgICAgICAgLy8gICAgIG9yZGVyRnVsZmlsbG1lbnRTdGF0dXMuc2xpY2UoMSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAvLyAgIGxldCBvcmRlckRldGFpbHNNc2cgPSBgSGVyZSdzIHRoZSBzdGF0dXMgb2YgeW91ciByZWNlbnQgb3JkZXI6PGJyPgogICAgICAgICAgICAgIC8vIE9yZGVyIC0gPGEgaHJlZj0iJHtvcmRlclN0YXR1c1VybH0iIHRhcmdldD0iX2JsYW5rIj4jJHtvcmRlck5hbWV9PC9hPjxicj4KICAgICAgICAgICAgICAvLyBPcmRlciBQcm9jZXNzZWQgT246ICR7b3JkZXJQcm9jZXNzaW5nRGF0ZX08YnI+CiAgICAgICAgICAgICAgLy8gRnVsZmlsbG1lbnQgU3RhdHVzOiAke29yZGVyRnVsZmlsbG1lbnRTdGF0dXN9PGJyPmA7CiAgICAgICAgICAgICAgLy8gICBpZiAob3JkZXJGdWxmaWxsbWVudFN0YXR1cyA9PSAiRlVMRklMTEVEIikgewogICAgICAgICAgICAgIC8vICAgICBzdWNjZXNzZnVsT3JkZXJGdWxmaWxsbWVudHMgPSBzdWNjZXNzZnVsT3JkZXJGdWxmaWxsbWVudHNbMF07CiAgICAgICAgICAgICAgLy8gICAgIG9yZGVyRGV0YWlsc01zZyArPSBgWW91IGNhbiB0cmFjayB5b3VyIG9yZGVyIGhlcmU8YSBocmVmPSIke3N1Y2Nlc3NmdWxPcmRlckZ1bGZpbGxtZW50cy50cmFja2luZ0luZm8udXJsfSIgZGF0YS1jb3B5LWNvbnRlbnQ9IiR7c3VjY2Vzc2Z1bE9yZGVyRnVsZmlsbG1lbnRzLnRyYWNraW5nSW5mby5udW1iZXJ9Ij4KICAgICAgICAgICAgICAvLyAgICR7c3VjY2Vzc2Z1bE9yZGVyRnVsZmlsbG1lbnRzLnRyYWNraW5nSW5mby5udW1iZXJ9PC9hPjxpIGNsYXNzPSJmYSBmYS1jbGlwYm9hcmQgbWwtMiIgYXJpYS1oaWRkZW49InRydWUiIGRhdGEtY29weS1jb250ZW50PSIke3N1Y2Nlc3NmdWxPcmRlckZ1bGZpbGxtZW50cy50cmFja2luZ0luZm8ubnVtYmVyfSI+PC9pPjxicj5gOwogICAgICAgICAgICAgIC8vICAgfQogICAgICAgICAgICAgIC8vICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9IG9yZGVyRGV0YWlsc01zZzsKCiAgICAgICAgICAgICAgdmFyIG9yZGVyc19kYXRhID0gZGF0YS5yZXNwb25zZXNbMF0uZGF0YS5jdXN0b21lci5vcmRlcnMuZWRnZXMsCiAgICAgICAgICAgICAgICAgIGNvbXBsZXRlX29yZGVyc19kYXRhID0gW107CgogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb3JkZXJzX2RhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjdXJfbm9kZSA9IG9yZGVyc19kYXRhW2ldLm5vZGU7CiAgICAgICAgICAgICAgICBjdXJfbm9kZS5wcm9jZXNzZWRBdCA9IG1vbWVudChjdXJfbm9kZS5wcm9jZXNzZWRBdCwgWyJZWVlZLU1NLUREVGhoOm1tOnNzWiJdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIik7CiAgICAgICAgICAgICAgICBjdXJfbm9kZS5mdWxmaWxsbWVudFN0YXR1cyA9IGN1cl9ub2RlLmZ1bGZpbGxtZW50U3RhdHVzLnJlcGxhY2UoIl8iLCAiICIpOyAvLyBTZXQgb25seSBmaXJzdCBjaGFyYWN0ZXIgdG8gdXBwZXJjYXNlIHdoaWxlIHJlbWFpbmluZyBjaGFyYWN0ZXJzIHNldCB0byBsb3dlcmNhc2UKCiAgICAgICAgICAgICAgICBjdXJfbm9kZS5mdWxmaWxsbWVudFN0YXR1cyA9IGN1cl9ub2RlLmZ1bGZpbGxtZW50U3RhdHVzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgY3VyX25vZGUuZnVsZmlsbG1lbnRTdGF0dXMuc2xpY2UoMSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIGNvbXBsZXRlX29yZGVyc19kYXRhLnB1c2goewogICAgICAgICAgICAgICAgICBuYW1lOiBjdXJfbm9kZS5uYW1lLAogICAgICAgICAgICAgICAgICBwcm9jZXNzZWRfZGF0ZTogY3VyX25vZGUucHJvY2Vzc2VkQXQsCiAgICAgICAgICAgICAgICAgIGZ1bGZpbGxtZW50X3N0YXR1czogY3VyX25vZGUuZnVsZmlsbG1lbnRTdGF0dXMsCiAgICAgICAgICAgICAgICAgIHN0YXR1c191cmw6IGN1cl9ub2RlLnN0YXR1c1VybAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBfdGhpczM2LmNoYXRbaW5kZXhdLnNob3dfYWxsX29yZGVyc19saXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICBfdGhpczM2LmNoYXRbaW5kZXhdLmFsbF9vcmRlcnNfbGlzdCA9IGNvbXBsZXRlX29yZGVyc19kYXRhOwogICAgICAgICAgICAgIF90aGlzMzYuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPSAiUGxlYXNlIEZpbmQgQmVsb3cgWW91ciBMYXRlc3QgT3JkZXJzOiI7CiAgICAgICAgICAgICAgX3RoaXMzNi5jaGF0W2luZGV4XS5yZWNlbnRfb3JkZXJzX2xpc3QgPSBkYXRhLnJlc3BvbnNlc1swXS5kYXRhLmN1c3RvbWVyLm9yZGVycy5lZGdlczsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBfdGhpczM2LmNoYXRbaW5kZXhdLmNvbnZlcnNhdGlvbl9vbmx5ID0gdHJ1ZTsKICAgICAgICAgIH0sIDUwMCk7CiAgICAgICAgfSBlbHNlIGlmIChfdGhpczM2LnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJ3b29jb21tZXJjZSIpIHsKICAgICAgICAgIGlmIChpc1JlZnVuZCkgewogICAgICAgICAgICBfdGhpczM2LmxvYWRfY3VzdG9tZXJfb3JkZXJzKGRhdGEucmVzcG9uc2VzWzBdLmRhdGEuY3VzdG9tZXIub3JkZXJzLCBpbmRleCwgaXNSZWZ1bmQgPyAicmVmdW5kIiA6ICJhbGxfb3JkZXJzIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfdGhpczM2LmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICAgICAgdmFyIF9vcmRlcnNfZGF0YSA9IGRhdGEucmVzcG9uc2VzWzBdLmRhdGEuY3VzdG9tZXIub3JkZXJzLAogICAgICAgICAgICAgICAgX2NvbXBsZXRlX29yZGVyc19kYXRhID0gW107CgogICAgICAgICAgICBmb3IgKHZhciBfaTggPSAwOyBfaTggPCBfb3JkZXJzX2RhdGEubGVuZ3RoOyBfaTgrKykgewogICAgICAgICAgICAgIHZhciBjdXJfbm9kZSA9IF9vcmRlcnNfZGF0YVtfaThdOwogICAgICAgICAgICAgIGN1cl9ub2RlLnByb2Nlc3NlZEF0ID0gbW9tZW50KGN1cl9ub2RlLmNyZWF0ZWRfYXQsIFsiWVlZWS1NTS1ERFRoaDptbTpzc1oiXSkuZm9ybWF0KCJEbyBNTU0gWVlZWSIpOwogICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cyA9IEJvb2xlYW4oY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzKSA9PT0gdHJ1ZSA/IGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cyA6ICJVbmZ1bGZpbGxlZCI7IC8vIFNldCBvbmx5IGZpcnN0IGNoYXJhY3RlciB0byB1cHBlcmNhc2Ugd2hpbGUgcmVtYWluaW5nIGNoYXJhY3RlcnMgc2V0IHRvIGxvd2VyY2FzZQoKICAgICAgICAgICAgICBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMgPSBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMuc2xpY2UoMSkudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAgICAgZm9yICh2YXIgX2k5ID0gMDsgX2k5IDwgY3VyX25vZGUub3JkZXJfbm90ZXMubGVuZ3RoOyBfaTkrKykgewogICAgICAgICAgICAgICAgY3VyX25vZGUub3JkZXJfbm90ZXNbX2k5XS5kYXRlX2NyZWF0ZWQgPSBtb21lbnQoY3VyX25vZGUub3JkZXJfbm90ZXNbX2k5XS5kYXRlX2NyZWF0ZWQsIFsiWVlZWS1NTS1ERFRoaDptbTpzc1oiXSkuZm9ybWF0KCJEbyBNTU0gWVlZWSBISDptbSBhIik7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBfY29tcGxldGVfb3JkZXJzX2RhdGEucHVzaCh7CiAgICAgICAgICAgICAgICBuYW1lOiBjdXJfbm9kZS5pZCwKICAgICAgICAgICAgICAgIHByb2Nlc3NlZF9kYXRlOiBjdXJfbm9kZS5wcm9jZXNzZWRBdCwKICAgICAgICAgICAgICAgIGZ1bGZpbGxtZW50X3N0YXR1czogY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzLAogICAgICAgICAgICAgICAgc3RhdHVzX3VybDogY3VyX25vZGUub3JkZXJfc3RhdHVzX3VybCwKICAgICAgICAgICAgICAgIG9yZGVyX25vdGVzOiBjdXJfbm9kZS5vcmRlcl9ub3RlcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfdGhpczM2LmNoYXRbaW5kZXhdLnNob3dfYWxsX29yZGVyc19saXN0ID0gdHJ1ZTsKICAgICAgICAgICAgX3RoaXMzNi5jaGF0W2luZGV4XS5hbGxfb3JkZXJzX2xpc3QgPSBfY29tcGxldGVfb3JkZXJzX2RhdGE7CiAgICAgICAgICAgIF90aGlzMzYuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPSAiUGxlYXNlIEZpbmQgQmVsb3cgWW91ciBMYXRlc3QgT3JkZXJzOiI7CiAgICAgICAgICAgIF90aGlzMzYuY2hhdFtpbmRleF0uc2hvd19hbGxfb3JkZXJzX2xpc3QgPSB0cnVlOwogICAgICAgICAgICBfdGhpczM2LmNoYXRbaW5kZXhdLnJlY2VudF9vcmRlcnNfbGlzdCA9IF9jb21wbGV0ZV9vcmRlcnNfZGF0YTsKICAgICAgICAgIH0KCiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgX3RoaXMzNi5jaGF0W2luZGV4XS5jb252ZXJzYXRpb25fb25seSA9IHRydWU7CiAgICAgICAgICB9LCA1MDApOwogICAgICAgIH0gZWxzZSBpZiAoX3RoaXMzNi5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAibWFnZW50byIpIHsKICAgICAgICAgIGlmIChpc1JlZnVuZCkgewogICAgICAgICAgICBfdGhpczM2LmxvYWRfY3VzdG9tZXJfb3JkZXJzKGRhdGEucmVzcG9uc2VzWzBdLmRhdGEuY3VzdG9tZXIub3JkZXJzLCBpbmRleCwgaXNSZWZ1bmQgPyAicmVmdW5kIiA6ICJhbGxfb3JkZXJzIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfdGhpczM2LmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICAgICAgdmFyIF9vcmRlcnNfZGF0YTIgPSBkYXRhLnJlc3BvbnNlc1swXS5kYXRhLmN1c3RvbWVyLm9yZGVycywKICAgICAgICAgICAgICAgIF9jb21wbGV0ZV9vcmRlcnNfZGF0YTIgPSBbXTsKCiAgICAgICAgICAgIGZvciAodmFyIF9pMTAgPSAwOyBfaTEwIDwgX29yZGVyc19kYXRhMi5sZW5ndGg7IF9pMTArKykgewogICAgICAgICAgICAgIHZhciBjdXJfbm9kZSA9IF9vcmRlcnNfZGF0YTJbX2kxMF07CiAgICAgICAgICAgICAgY3VyX25vZGUucHJvY2Vzc2VkQXQgPSBtb21lbnQoY3VyX25vZGUuY3JlYXRlZF9hdCwgWyJZWVlZLU1NLUREVGhoOm1tOnNzWiJdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIik7CiAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzID0gQm9vbGVhbihjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMpID09PSB0cnVlID8gY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzIDogIlVuZnVsZmlsbGVkIjsgLy8gU2V0IG9ubHkgZmlyc3QgY2hhcmFjdGVyIHRvIHVwcGVyY2FzZSB3aGlsZSByZW1haW5pbmcgY2hhcmFjdGVycyBzZXQgdG8gbG93ZXJjYXNlCgogICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cyA9IGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cy5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICBmb3IgKHZhciBfaTExID0gMDsgX2kxMSA8IGN1cl9ub2RlLm9yZGVyX25vdGVzLmxlbmd0aDsgX2kxMSsrKSB7CiAgICAgICAgICAgICAgICBjdXJfbm9kZS5vcmRlcl9ub3Rlc1tfaTExXS5kYXRlX2NyZWF0ZWQgPSBtb21lbnQoY3VyX25vZGUub3JkZXJfbm90ZXNbX2kxMV0uZGF0ZV9jcmVhdGVkLCBbIllZWVktTU0tRERUaGg6bW06c3NaIl0pLmZvcm1hdCgiRG8gTU1NIFlZWVkgSEg6bW0gYSIpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgX2NvbXBsZXRlX29yZGVyc19kYXRhMi5wdXNoKHsKICAgICAgICAgICAgICAgIG5hbWU6IGN1cl9ub2RlLmlkLAogICAgICAgICAgICAgICAgcHJvY2Vzc2VkX2RhdGU6IGN1cl9ub2RlLnByb2Nlc3NlZEF0LAogICAgICAgICAgICAgICAgZnVsZmlsbG1lbnRfc3RhdHVzOiBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMsCiAgICAgICAgICAgICAgICBzdGF0dXNfdXJsOiBjdXJfbm9kZS5vcmRlcl9zdGF0dXNfdXJsLAogICAgICAgICAgICAgICAgb3JkZXJfbm90ZXM6IGN1cl9ub2RlLm9yZGVyX25vdGVzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF90aGlzMzYuY2hhdFtpbmRleF0uc2hvd19hbGxfb3JkZXJzX2xpc3QgPSB0cnVlOwogICAgICAgICAgICBfdGhpczM2LmNoYXRbaW5kZXhdLmFsbF9vcmRlcnNfbGlzdCA9IF9jb21wbGV0ZV9vcmRlcnNfZGF0YTI7CiAgICAgICAgICAgIF90aGlzMzYuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPSAiUGxlYXNlIEZpbmQgQmVsb3cgWW91ciBMYXRlc3QgT3JkZXJzOiI7CiAgICAgICAgICAgIF90aGlzMzYuY2hhdFtpbmRleF0uc2hvd19hbGxfb3JkZXJzX2xpc3QgPSB0cnVlOwogICAgICAgICAgICBfdGhpczM2LmNoYXRbaW5kZXhdLnJlY2VudF9vcmRlcnNfbGlzdCA9IF9jb21wbGV0ZV9vcmRlcnNfZGF0YTI7CiAgICAgICAgICB9CgogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIF90aGlzMzYuY2hhdFtpbmRleF0uY29udmVyc2F0aW9uX29ubHkgPSB0cnVlOwogICAgICAgICAgfSwgNTAwKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIGlmICh0b2tlbl90eXBlID09PSAic2hvcGlmeV9jdXN0b21lcl9pZCIpIHsKICAgICAgdmFyIF9heGlvcyRwb3N0MTQ7CgogICAgICBpZiAoQm9vbGVhbih0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQpID09PSBmYWxzZSkgewogICAgICAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IHRoaXMuJHNlc3Npb24uZ2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CiAgICAgIH0KCiAgICAgIHZhciBzaG9waWZ5X2N1c3RvbWVyX2VtYWlsID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iKTsKCiAgICAgIHZhciBfc3RyaW5naWZpZWRfY3VzdG9tZXJfcGF5bG9hZDIgPSBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgY3VzdG9tZXJJZDogdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkLAogICAgICAgIGVtYWlsOiBzaG9waWZ5X2N1c3RvbWVyX2VtYWlsCiAgICAgIH0pOwoKICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJGZXRjaGluZyB5b3VyIG9yZGVyIGRldGFpbHMgLi4uIjsKICAgICAgYXhpb3MucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCAoX2F4aW9zJHBvc3QxNCA9IHsKICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgY2hhdDogIi9yZXRyaWV2ZV9jdXN0b21lcl9vcmRlcnMiLmNvbmNhdChfc3RyaW5naWZpZWRfY3VzdG9tZXJfcGF5bG9hZDIpCiAgICAgIH0sIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDE0LCAidG9rZW4iLCB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSksIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDE0LCAicm9sZSIsIHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MTQsICJyZWZyZXNoZWRfb3JfY2xvc2VkIiwgdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkKSwgX2F4aW9zJHBvc3QxNCkpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbS5vcmRlcnNfbGlzdC5sZW5ndGggPT0gMCAmJiBfdGhpczM2LnJldGFpbF9vcmRlcl9yZXRyZWl2YWxfb25seV9lbWFpbF9yZXF1aXJlZCkgewogICAgICAgICAgX3RoaXMzNi5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICBfdGhpczM2LmNoYXRbaW5kZXhdLmNvbnZlcnNhdGlvbl9vbmx5ID0gdHJ1ZTsKICAgICAgICAgIF90aGlzMzYuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPSAiVGhlcmUgYXJlIG5vIG9yZGVycyB0byBiZSBkaXNwbGF5ZWQgZm9yIHRoZSBnaXZlbiBFbWFpbCBvciBQaG9uZSBudW1iZXIiOwogICAgICAgICAgX3RoaXMzNi5zaG9waWZ5X2N1c3RvbWVyX2lkID0gbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgX3RoaXMzNi5sb2FkX2N1c3RvbWVyX29yZGVycyhyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1swXS5jdXN0b20ub3JkZXJzX2xpc3QsIGluZGV4LCBpc1JlZnVuZCA/ICJyZWZ1bmQiIDogImFsbF9vcmRlcnMiKTsKICAgICAgICB9CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgX3RoaXMzNi5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgY29uc29sZS5sb2coZSk7CgogICAgICAgIF90aGlzMzYudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgfSk7CiAgICB9CiAgfSwKICBzaG9waWZ5X2lzX3Rva2VuX3ZhbGlkOiBmdW5jdGlvbiBzaG9waWZ5X2lzX3Rva2VuX3ZhbGlkKGluZGV4LCBpc1JlZnVuZCkgewogICAgaXNSZWZ1bmQgPSBpc1JlZnVuZCB8fCBmYWxzZTsKCiAgICBpZiAodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIpIHsKICAgICAgaWYgKHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzICYmICFCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSAmJiAhQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJlY2VudF9vcmRlcnNfbGlzdCkgfHwgdGhpcy5jaGF0W2luZGV4XS5mZXRjaF9zaG9waWZ5X2RldGFpbHMgJiYgQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLmlzX3JlZnVuZCkgJiYgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QpIHx8IHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzICYmIEJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZXR1cm5fc2hvcGlmeV9lbWFpbCkpIHsKICAgICAgICBpZiAodGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQpIHsKICAgICAgICAgIGlmIChCb29sZWFuKHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCkpIHsKICAgICAgICAgICAgdmFyIGN1c3RvbWVyVG9rZW4gPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpOwoKICAgICAgICAgICAgaWYgKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSB7CiAgICAgICAgICAgICAgdGhpcy5zaG9waWZ5X2ZldGNoX2N1c3RvbWVyX2lkKGN1c3RvbWVyVG9rZW4sIGluZGV4LCAic2hvcGlmeV9jdXN0b21lcl9pZCIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2hhdFtpbmRleF0ucmV0dXJuX3Nob3BpZnlfZW1haWwpIHsKICAgICAgICAgICAgICB0aGlzLnNlbmRfc2hvcGlmeV9jdXN0b21lcl9pZChpbmRleCwgZmFsc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMoY3VzdG9tZXJUb2tlbiwgaW5kZXgsIGlzUmVmdW5kLCAic2hvcGlmeV9jdXN0b21lcl9pZCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBzaG9waWZ5X3N0b3JlX2NpZCA9IHRoaXMuZ2V0X3Nob3BpZnlfc3RvcmVfd2luZG93X2N1c3RvbWVyX2lkKCk7CgogICAgICAgICAgaWYgKEJvb2xlYW4oc2hvcGlmeV9zdG9yZV9jaWQpID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBsZXQgY3V0b2ZmID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW5fZXhwaXJ5Iik7CiAgICAgICAgICAgIC8vIGN1dG9mZiA9IG1vbWVudChjdXRvZmYsIFsiWVlZWS1NTS1ERFRoaDptbTpzc1oiXSk7CiAgICAgICAgICAgIC8vIGlmIChtb21lbnQoKS5pc0JlZm9yZShjdXRvZmYpKSB7CiAgICAgICAgICAgIC8vIGxldCBzaG9waWZ5X3N0b3JlX2NpZCA9IHRoaXMuZ2V0X3Nob3BpZnlfc3RvcmVfd2luZG93X2N1c3RvbWVyX2lkKCk7CiAgICAgICAgICAgIC8vIGxldCBzaG9waWZ5X3N0b3JlX2NpZCA9IDUzMDIwMDE4OTM0NDc7IC8vaGFyZGNvZGVkOiByZW1vdmUgYWZ0ZXIgdGVzdGluZwogICAgICAgICAgICBpZiAoc2hvcGlmeV9zdG9yZV9jaWQgPT09IG51bGwgfHwgc2hvcGlmeV9zdG9yZV9jaWQgPT0gdW5kZWZpbmVkIHx8IHNob3BpZnlfc3RvcmVfY2lkID09ICIiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IHNob3BpZnlfc3RvcmVfY2lkOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgX2N1c3RvbWVyVG9rZW4zID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXRbaW5kZXhdLmlzX3JlZnVuZCkgewogICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9jdXN0b21lcl9pZChfY3VzdG9tZXJUb2tlbjMsIGluZGV4LCAic2hvcGlmeV9jdXN0b21lcl9pZCIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2hhdFtpbmRleF0ucmV0dXJuX3Nob3BpZnlfZW1haWwpIHsKICAgICAgICAgICAgICB0aGlzLnNlbmRfc2hvcGlmeV9jdXN0b21lcl9pZChpbmRleCwgZmFsc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMoX2N1c3RvbWVyVG9rZW4zLCBpbmRleCwgaXNSZWZ1bmQsICJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyB9IGVsc2UgewogICAgICAgICAgICAvLyAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgLy8gfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSBlbHNlIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJ3b29jb21tZXJjZSIpIHsKICAgICAgaWYgKHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzICYmICFCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSAmJiAhQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJlY2VudF9vcmRlcnNfbGlzdCkgfHwgdGhpcy5jaGF0W2luZGV4XS5mZXRjaF9zaG9waWZ5X2RldGFpbHMgJiYgQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLmlzX3JlZnVuZCkgJiYgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QpIHx8IHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzICYmIEJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZXR1cm5fc2hvcGlmeV9lbWFpbCkpIHsKICAgICAgICBpZiAodGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQpIHsKICAgICAgICAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IHRoaXMuJHNlc3Npb24uZ2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CgogICAgICAgICAgaWYgKEJvb2xlYW4odGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkKSkgewogICAgICAgICAgICB2YXIgX2N1c3RvbWVyVG9rZW40ID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiKTsKCiAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMoX2N1c3RvbWVyVG9rZW40LCBpbmRleCwgaXNSZWZ1bmQsICJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgd29vY29tbWVyY2Vfc3RvcmVfbG9naW5fZGV0YWlsID0gdGhpcy5nZXRfd29vY29tbWVyY2Vfc3RvcmVfd2luZG93X2N1c3RvbWVyX2VtYWlsKCk7CgogICAgICAgICAgaWYgKEJvb2xlYW4od29vY29tbWVyY2Vfc3RvcmVfbG9naW5fZGV0YWlsKSA9PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl9pZCIsIHdvb2NvbW1lcmNlX3N0b3JlX2xvZ2luX2RldGFpbFswXSk7CiAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIiwgd29vY29tbWVyY2Vfc3RvcmVfbG9naW5fZGV0YWlsWzFdKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXRbaW5kZXhdLmlzX3JlZnVuZCkgewogICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9jdXN0b21lcl9pZCh3b29jb21tZXJjZV9zdG9yZV9sb2dpbl9kZXRhaWxbMF0sIGluZGV4LCAic2hvcGlmeV9jdXN0b21lcl9pZCIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMod29vY29tbWVyY2Vfc3RvcmVfbG9naW5fZGV0YWlsWzBdLCBpbmRleCwgaXNSZWZ1bmQsICJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSAvLyBpZiAoIXRoaXMuJHNlc3Npb24uaGFzKCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuX2V4cGlyeSIpKSB7CiAgICAgICAgICAvLyAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgLy8gICB9IGVsc2UgewogICAgICAgICAgLy8gICAgIGxldCBjdXRvZmYgPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbl9leHBpcnkiKTsKICAgICAgICAgIC8vICAgICBjdXRvZmYgPSBtb21lbnQoY3V0b2ZmLCBbIllZWVktTU0tRERUaGg6bW06c3NaIl0pOwogICAgICAgICAgLy8gICAgIGxldCBjdXJyZW50X3RpbWUgPSBuZXcgRGF0ZShjdXRvZmYpOwogICAgICAgICAgLy8gICAgIGlmIChtb21lbnQoKS5pc0JlZm9yZShjdXJyZW50X3RpbWUpKSB7CiAgICAgICAgICAvLyAgICAgICBsZXQgY3VzdG9tZXJUb2tlbiA9IHRoaXMuJHNlc3Npb24uZ2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIik7CiAgICAgICAgICAvLyAgICAgICB0aGlzLnNob3BpZnlfZmV0Y2hfb3JkZXJzKAogICAgICAgICAgLy8gICAgICAgICAgIGN1c3RvbWVyVG9rZW4sCiAgICAgICAgICAvLyAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAvLyAgICAgICAgICAgaXNSZWZ1bmQsCiAgICAgICAgICAvLyAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iCiAgICAgICAgICAvLyAgICAgICAgICk7CiAgICAgICAgICAvLyAgICAgICByZXR1cm4gdHJ1ZTsgICAgICAgICAgICAKICAgICAgICAgIC8vICAgICB9ZWxzZSB7CiAgICAgICAgICAvLyAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAvLyAgICAgfQogICAgICAgICAgLy8gICB9CgogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSBlbHNlIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJtYWdlbnRvIikgewogICAgICBpZiAodGhpcy5jaGF0W2luZGV4XS5mZXRjaF9zaG9waWZ5X2RldGFpbHMgJiYgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5pc19yZWZ1bmQpICYmICFCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0ucmVjZW50X29yZGVyc19saXN0KSB8fCB0aGlzLmNoYXRbaW5kZXhdLmZldGNoX3Nob3BpZnlfZGV0YWlscyAmJiBCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSAmJiAhQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9vcmRlcnNfbGlzdCkgfHwgdGhpcy5jaGF0W2luZGV4XS5mZXRjaF9zaG9waWZ5X2RldGFpbHMgJiYgQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJldHVybl9zaG9waWZ5X2VtYWlsKSkgewogICAgICAgIGlmICh0aGlzLnJldGFpbF9vcmRlcl9yZXRyZWl2YWxfb25seV9lbWFpbF9yZXF1aXJlZCkgewogICAgICAgICAgdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiKTsKCiAgICAgICAgICBpZiAoQm9vbGVhbih0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQpKSB7CiAgICAgICAgICAgIHZhciBfY3VzdG9tZXJUb2tlbjUgPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl9pZCIpOwoKICAgICAgICAgICAgdGhpcy5zaG9waWZ5X2ZldGNoX29yZGVycyhfY3VzdG9tZXJUb2tlbjUsIGluZGV4LCBpc1JlZnVuZCwgInNob3BpZnlfY3VzdG9tZXJfaWQiKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBtYWdlbnRvX3N0b3JlX2xvZ2luX2RldGFpbCA9IHRoaXMuZ2V0X21hZ2VudG9fc3RvcmVfd2luZG93X2N1c3RvbWVyX2VtYWlsKCk7CgogICAgICAgICAgaWYgKEJvb2xlYW4obWFnZW50b19zdG9yZV9sb2dpbl9kZXRhaWwpID09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIiwgbWFnZW50b19zdG9yZV9sb2dpbl9kZXRhaWxbMF0pOwogICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIsIG1hZ2VudG9fc3RvcmVfbG9naW5fZGV0YWlsWzFdKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmNoYXRbaW5kZXhdLmlzX3JlZnVuZCkgewogICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9jdXN0b21lcl9pZChtYWdlbnRvX3N0b3JlX2xvZ2luX2RldGFpbFswXSwgaW5kZXgsICJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5zaG9waWZ5X2ZldGNoX29yZGVycyhtYWdlbnRvX3N0b3JlX2xvZ2luX2RldGFpbFswXSwgaW5kZXgsIGlzUmVmdW5kLCAic2hvcGlmeV9jdXN0b21lcl9pZCIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gLy8gaWYgKCF0aGlzLiRzZXNzaW9uLmhhcygic2hvcGlmeV9jdXN0b21lcl90b2tlbl9leHBpcnkiKSkgewogICAgICAgICAgLy8gICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIC8vICAgfSBlbHNlIHsKICAgICAgICAgIC8vICAgICBsZXQgY3V0b2ZmID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW5fZXhwaXJ5Iik7CiAgICAgICAgICAvLyAgICAgY3V0b2ZmID0gbW9tZW50KGN1dG9mZiwgWyJZWVlZLU1NLUREVGhoOm1tOnNzWiJdKTsKICAgICAgICAgIC8vICAgICBsZXQgY3VycmVudF90aW1lID0gbmV3IERhdGUoY3V0b2ZmKTsKICAgICAgICAgIC8vICAgICBpZiAobW9tZW50KCkuaXNCZWZvcmUoY3VycmVudF90aW1lKSkgewogICAgICAgICAgLy8gICAgICAgbGV0IGN1c3RvbWVyVG9rZW4gPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpOwogICAgICAgICAgLy8gICAgICAgdGhpcy5zaG9waWZ5X2ZldGNoX29yZGVycygKICAgICAgICAgIC8vICAgICAgICAgICBjdXN0b21lclRva2VuLAogICAgICAgICAgLy8gICAgICAgICAgIGluZGV4LAogICAgICAgICAgLy8gICAgICAgICAgIGlzUmVmdW5kLAogICAgICAgICAgLy8gICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIgogICAgICAgICAgLy8gICAgICAgICApOwogICAgICAgICAgLy8gICAgICAgcmV0dXJuIHRydWU7ICAgICAgICAgICAgCiAgICAgICAgICAvLyAgICAgfWVsc2UgewogICAgICAgICAgLy8gICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgLy8gICAgIH0KICAgICAgICAgIC8vICAgfQoKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICB9LAogIGluaXRpYWxpemVfc2hvcGlmeV91aTogZnVuY3Rpb24gaW5pdGlhbGl6ZV9zaG9waWZ5X3VpKCkgewogICAgaWYgKHdpbmRvdy5TaG9waWZ5IHx8IHRoaXMuaXNfcmV0YWlsX2JvdCB8fCB0aGlzLmNvbXBhbnlpZCA9PSAiY2Vuc2VyZXRhaWw0OTE0MCIpIHsKICAgICAgdmFyIGNsaWVudCA9IFNob3BpZnlCdXkuYnVpbGRDbGllbnQoewogICAgICAgIGRvbWFpbjogd2luZG93LlNob3BpZnkgPyB3aW5kb3cuU2hvcGlmeS5zaG9wIDogdGhpcy5zaG9waWZ5X3JldGFpbF9zaG9wX25hbWUgKyAiLm15c2hvcGlmeS5jb20iLAogICAgICAgIHN0b3JlZnJvbnRBY2Nlc3NUb2tlbjogdGhpcy5yZXRhaWxfc2hvcF9zdG9yZWZyb250X3Rva2VuCiAgICAgIH0pOwogICAgICB0aGlzLnNob3BpZnlfdWkgPSBTaG9waWZ5QnV5LlVJLmluaXQoY2xpZW50KTsgLy8gaWYgKHRoaXMuJHNlc3Npb24uZ2V0KCJJc1BvcnRhbE1haW50YWluZW5jZSIpID09PSBmYWxzZSkgewoKICAgICAgdGhpcy5zaG9waWZ5X3VpLmNyZWF0ZUNvbXBvbmVudCgiY2FydCIsIHsKICAgICAgICBub2RlOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY2FydERpdiIpLAogICAgICAgIHRvZ2dsZXM6IFt7CiAgICAgICAgICBub2RlOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgidG9nZ2xlIikKICAgICAgICB9XSwKICAgICAgICBtb25leUZvcm1hdDogdGhpcy5yZXRhaWxfc2hvcF9jdXJyZW5jeSArICIge3ttb25leV93aXRoX2N1cnJlbmN5fX0iLAogICAgICAgIG9wdGlvbnM6IHsKICAgICAgICAgIHRvZ2dsZTogewogICAgICAgICAgICBzdGlja3k6IGZhbHNlCiAgICAgICAgICB9LAogICAgICAgICAgcG9wdXA6IGZhbHNlCiAgICAgICAgfQogICAgICB9KTsgLy8gfQogICAgfQogIH0sCiAgaW5pdGlhbGl6ZV9zaG9waWZ5X2J1dHRvbnM6IGZ1bmN0aW9uIGluaXRpYWxpemVfc2hvcGlmeV9idXR0b25zKHByb2R1Y3RfaWQsIGluZGV4LCB2YXJpYW50X2lkKSB7CiAgICB2YXIgX3RoaXMzNyA9IHRoaXM7CgogICAgdHJ5IHsKICAgICAgdGhpcy5zaG9waWZ5X3VpLmNyZWF0ZUNvbXBvbmVudCgicHJvZHVjdCIsIHsKICAgICAgICBpZDogcHJvZHVjdF9pZCwKICAgICAgICB2YXJpYW50SWQ6IHZhcmlhbnRfaWQsCiAgICAgICAgbW9uZXlGb3JtYXQ6IHRoaXMucmV0YWlsX3Nob3BfY3VycmVuY3kgKyAiIHt7bW9uZXlfd2l0aF9jdXJyZW5jeX19IiwKICAgICAgICBvcHRpb25zOiB7CiAgICAgICAgICBwcm9kdWN0OiB7CiAgICAgICAgICAgIGNvbnRlbnRzOiB7CiAgICAgICAgICAgICAgb3B0aW9uczogdHJ1ZSwKICAgICAgICAgICAgICBxdWFudGl0eTogdHJ1ZSwKICAgICAgICAgICAgICBxdWFudGl0eUluY3JlbWVudDogdHJ1ZSwKICAgICAgICAgICAgICBxdWFudGl0eURlY3JlbWVudDogdHJ1ZSwKICAgICAgICAgICAgICB2YXJpYW50VGl0bGU6IHRydWUgLy8gYnV0dG9uV2l0aFF1YW50aXR5OiBmYWxzZSwKCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0eWxlczogewogICAgICAgICAgICAgIHF1YW50aXR5OiB7CiAgICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgICAianVzdGlmeS1jb250ZW50IjogImNlbnRlciIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG5vZGU6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJwcm9kdWN0XyIuY29uY2F0KHByb2R1Y3RfaWQsICJfIikuY29uY2F0KGluZGV4KSkKICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICBfdGhpczM3LmNoZWNrX25vX3Byb2R1Y3RzKCk7CgogICAgICAgIGZvciAodmFyIGkgaW4gX3RoaXMzNy5wcm9kdWN0X2xpc3QpIHsKICAgICAgICAgIGlmIChwcm9kdWN0X2lkID09IF90aGlzMzcucHJvZHVjdF9saXN0W2ldLnByb2R1Y3RfaWQpIHsKICAgICAgICAgICAgX3RoaXMzNy5wcm9kdWN0X2xpc3RbaV0uYXZhaWxhYmxlRm9yU2FsZSA9IHJlc3BvbnNlLnZpZXdEYXRhLmF2YWlsYWJsZUZvclNhbGU7CiAgICAgICAgICAgIF90aGlzMzcucHJvZHVjdF9saXN0W2ldLnByb2R1Y3RJbWFnZSA9IHJlc3BvbnNlLmNhY2hlZEltYWdlLnNyYzsKICAgICAgICAgICAgX3RoaXMzNy5wcm9kdWN0X2xpc3RbaV0ub25saW5lU3RvcmVVUkwgPSByZXNwb25zZS5vbmxpbmVTdG9yZVVSTDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZSkgewogICAgICB2YXIgbXNnID0gewogICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgIGFza19mZWVkYmFjazogZmFsc2UsCiAgICAgICAgcmVjZWl2ZWQ6ICJTb21lIGVycm9yIG9jY3VycmVkIHdoaWxlIHRlc3RpbmcuIFBsZWFzZSB0cnkgYnkgcmVmcmVzaGluZyB0aGUgYnJvd3NlciEgSWYgdGhlIGlzc3VlIHBlcnNpc3RzLCBwbGVhc2UgY29udGFjdCBzeXN0ZW0gYWRtaW4uIiwKICAgICAgICByZWNlaXZpbmc6IHRydWUKICAgICAgfTsKICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgIH0KICB9LAogIGRlbW9fcmV0YWlsX3F1ZXN0aW9uOiBmdW5jdGlvbiBkZW1vX3JldGFpbF9xdWVzdGlvbigpIHsKICAgIHZhciBfdGhpczM4ID0gdGhpczsKCiAgICBpZiAodGhpcy5pc19yZXRhaWxfYm90ICYmIHRoaXMuaXNDYWxsZWRGcm9tU2V0dXApIHsKICAgICAgYXhpb3MucG9zdChhcGlfY2FsbHMudGVtcGxhdGVfc3lub255bXMoKSwgewogICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICAgIGNvbXBhbnlfbmFtZTogdGhpcy5jb21wYW55bmFtZSwKICAgICAgICBpc19nZXRfcHJvZHVjdF9saXN0OiB0cnVlCiAgICAgIH0sIHsKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICBBdXRob3JpemF0aW9uOiAiQmVhcmVyICIuY29uY2F0KHRoaXMuJHNlc3Npb24uZ2V0KCJhdCIpKQogICAgICAgIH0KICAgICAgfSkudGhlbihmdW5jdGlvbiAoX3JlZjUpIHsKICAgICAgICB2YXIgZGF0YSA9IF9yZWY1LmRhdGE7CiAgICAgICAgX3RoaXMzOC5zcGlubmVyT24gPSBmYWxzZTsKCiAgICAgICAgaWYgKGRhdGEuc3RhdHVzID09PSAiU3VjY2VzcyIpIHsKICAgICAgICAgIHZhciBwcm9kdWN0X25hbWVzX2xpc3QgPSBkYXRhLnByb2R1Y3RfbmFtZXNfbGlzdDsKICAgICAgICAgIHZhciBpdGVtID0gcHJvZHVjdF9uYW1lc19saXN0W01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHByb2R1Y3RfbmFtZXNfbGlzdC5sZW5ndGgpXTsKICAgICAgICAgIF90aGlzMzgudG9fc2VuZCA9ICJQbGVhc2Ugc2hvdyBtZSAiLmNvbmNhdChpdGVtKTsKICAgICAgICAgIHN3YWwoewogICAgICAgICAgICB0ZXh0OiAiVGVzdGluZyBvZiBCb3QgaW4gUHJvZ3Jlc3MsIFNlYXJjaGluZyBmb3IgYSBwcm9kdWN0IGZyb20geW91ciBTdG9yZSEiLAogICAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgICAgc2hvd0NhbmNlbEJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgdHlwZTogImluZm8iLAogICAgICAgICAgICB0aW1lcjogNTAwMAogICAgICAgICAgfSk7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gJCgiI3NlbmRfYnRuIikuY2xpY2soKQogICAgICAgICAgICBfdGhpczM4LmNoYXQucHVzaCh7CiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgc2VuZGluZzogdHJ1ZSwKICAgICAgICAgICAgICBzZW50OiBfdGhpczM4LnRvX3NlbmQsCiAgICAgICAgICAgICAgdGltZTogX3RoaXMzOC5nZW5lcmF0ZV90aW1lKCkKICAgICAgICAgICAgfSk7IC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwoKCiAgICAgICAgICAgIF90aGlzMzgudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAic2VuZGVyIik7CgogICAgICAgICAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgICBjaGF0OiBfdGhpczM4LnRvX3NlbmQsCiAgICAgICAgICAgICAgdG9rZW46IF90aGlzMzguYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgIHVzZXJuYW1lOiBfdGhpczM4LiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgICBsaWNlbnNlX2tleTogX3RoaXMzOC4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgIHJvbGU6IF90aGlzMzguJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IF90aGlzMzgucmVmcmVzaGVkX29yX2Nsb3NlZAogICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICAgIC8vIHJlc3BvbnNlLmRhdGEgPSB7CiAgICAgICAgICAgICAgLy8gICByZXNwb25zZXM6IFsKICAgICAgICAgICAgICAvLyAgICAgewogICAgICAgICAgICAgIC8vICAgICAgIGJ1dHRvbnM6IFsKICAgICAgICAgICAgICAvLyAgICAgICAgIHsgdGl0bGU6ICJDYWxsIFN1cHBvcnQiLCB2YWx1ZTogIi9jYWxsX3N1cHBvcnQiIH0sCiAgICAgICAgICAgICAgLy8gICAgICAgICB7IHRpdGxlOiAiTGl2ZSBDaGF0IiwgdmFsdWU6ICIvbGl2ZV9jaGF0IiB9LAogICAgICAgICAgICAgIC8vICAgICAgIF0sCiAgICAgICAgICAgICAgLy8gICAgICAgaW50ZW50OiAiY29uZnVzaW9uIiwKICAgICAgICAgICAgICAvLyAgICAgICB0ZXh0OiAiU29ycnkgSSBhbSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uIiwKICAgICAgICAgICAgICAvLyAgICAgfSwKICAgICAgICAgICAgICAvLyAgIF0sCiAgICAgICAgICAgICAgLy8gfTsKICAgICAgICAgICAgICBfdGhpczM4LnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlLCAiZGlzcGxheV9zdWNjZXNzX3RvYXN0ciIpOyAvLyBzd2FsKHsKICAgICAgICAgICAgICAvLyAgIHRleHQ6ICJUZXN0aW5nIENvbXBsZXRlZCBTdWNjZXNzZnVsbHkhIFBsZWFzZSBQcm9jZWVkIHRvIHRoZSBuZXh0IHN0ZXAuIiwKICAgICAgICAgICAgICAvLyAgIHRvYXN0OiB0cnVlLAogICAgICAgICAgICAgIC8vICAgc2hvd0NhbmNlbEJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgICAgLy8gICBzaG93Q29uZmlybUJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgICAgLy8gICB0eXBlOiAic3VjY2VzcyIsCiAgICAgICAgICAgICAgLy8gICB0aW1lcjogNTAwMCwKICAgICAgICAgICAgICAvLyAgIHRpbWVyUHJvZ3Jlc3NCYXI6IHRydWUsCiAgICAgICAgICAgICAgLy8gfSkKCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBfdGhpczM4LnRvX3NlbmQgPSAiIjsKICAgICAgICAgIH0sIDMyMDApOwogICAgICAgIH0KICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgICBfdGhpczM4LnNwaW5uZXJPbiA9IGZhbHNlOyAvLyBjb25zb2xlLmxvZyhlKTsKICAgICAgICAvLyBzd2FsKHsKICAgICAgICAvLyAgIHRleHQ6ICJUZXN0aW5nIEZpbmlzaGVkLlNvbWUgRXJyb3IgT2NjdXJyZWQsIFBsZWFzZSBUcnkgQWdhaW4iLAogICAgICAgIC8vICAgdG9hc3Q6IHRydWUsCiAgICAgICAgLy8gICBzaG93Q2FuY2VsQnV0dG9uOiBmYWxzZSwKICAgICAgICAvLyAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICAvLyAgIHR5cGU6ICJlcnJvciIsCiAgICAgICAgLy8gICB0aW1lcjogMjAwMCwKICAgICAgICAvLyAgIHRpbWVyUHJvZ3Jlc3NCYXI6IHRydWUsCiAgICAgICAgLy8gfSkKCiAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgdGltZTogX3RoaXMzOC5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICBhc2tfZmVlZGJhY2s6IGZhbHNlLAogICAgICAgICAgcmVjZWl2ZWQ6ICJTb21lIGVycm9yIG9jY3VycmVkIHdoaWxlIHRlc3RpbmcuIFBsZWFzZSB0cnkgYnkgcmVmcmVzaGluZyB0aGUgYnJvd3NlciEgSWYgdGhlIGlzc3VlIHBlcnNpc3RzLCBwbGVhc2UgY29udGFjdCBzeXN0ZW0gYWRtaW4uIiwKICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZQogICAgICAgIH07CgogICAgICAgIF90aGlzMzguY2hhdC5wdXNoKG1zZyk7CiAgICAgIH0pOwogICAgfQogIH0sCiAgc2hvcGlmeV9jaGVja19jdXN0b21lcl9sb2dnZWRfaW46IGZ1bmN0aW9uIHNob3BpZnlfY2hlY2tfY3VzdG9tZXJfbG9nZ2VkX2luKCkgewogICAgdmFyIF9heGlvcyRwb3N0MTUsCiAgICAgICAgX3RoaXMzOSA9IHRoaXM7CgogICAgdmFyIGN1c3RvbWVyX2RhdGEgPSB7CiAgICAgIGlzX2N1c3RvbWVyX2xvZ2dlZF9pbjogZmFsc2UsCiAgICAgIGN1c3RvbWVyX2lkOiBudWxsCiAgICB9OwoKICAgIGlmIChCb29sZWFuKHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCkpIHsKICAgICAgY3VzdG9tZXJfZGF0YS5pc19jdXN0b21lcl9sb2dnZWRfaW4gPSB0cnVlOwogICAgICBjdXN0b21lcl9kYXRhLmN1c3RvbWVyX2lkID0gdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkOwogICAgfQoKICAgIHZhciBzdHJpbmdpZmllZF9jdXN0b21lcl9wYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkoewogICAgICBjdXN0b21lcl9kYXRhOiBjdXN0b21lcl9kYXRhCiAgICB9KTsKICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICBheGlvcy5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIChfYXhpb3MkcG9zdDE1ID0gewogICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgIGNoYXQ6ICIvc2hvcGlmeV9yZXRyZWl2ZV9jdXN0b21lcl9zcGVjaWZpY19vZmZlcnMiLmNvbmNhdChzdHJpbmdpZmllZF9jdXN0b21lcl9wYXlsb2FkKQogICAgfSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MTUsICJ0b2tlbiIsIHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MTUsICJyb2xlIiwgdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3QxNSwgInJlZnJlc2hlZF9vcl9jbG9zZWQiLCB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQpLCBfYXhpb3MkcG9zdDE1KSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgX3RoaXMzOS5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSwgbnVsbCk7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICBjb25zb2xlLmxvZyhlKTsKCiAgICAgIF90aGlzMzkudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgIH0pOwogIH0sCiAgc2VuZF9zaG9waWZ5X2N1c3RvbWVyX2lkOiBmdW5jdGlvbiBzZW5kX3Nob3BpZnlfY3VzdG9tZXJfaWQoaW5kZXgsIGlzX2xvZ2luLCBtZXRhZGF0YSkgewogICAgdmFyIF90aGlzNDAgPSB0aGlzOwoKICAgIC8vIGRlYnVnZ2VyOwogICAgLy8gY29uc29sZS5sb2coInNlbmRfc2hvcGlmeV9jdXN0b21lcl9jbGciKTsKICAgIC8vIGlzX2xvZ2luID0gZmFsc2U7CiAgICBpZiAoaXNfbG9naW4gPT09IHRydWUpIHsKICAgICAgdmFyIF9heGlvcyRwb3N0MTY7CgogICAgICB2YXIgcXVlcnlTdHJpbmcgPSAkKCIjc2hvcGlmeV9sb2dpbl9mb3JtIikuc2VyaWFsaXplQXJyYXkoKTsKICAgICAgdmFyIGZvcm1fcGF5bG9hZCA9IHt9OwogICAgICBmb3JtX3BheWxvYWRbInNob3BpZnlfaXNfb25seV9lbWFpbCJdID0gdGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQ7CiAgICAgIGZvcm1fcGF5bG9hZFsidGV4dCJdID0gdGhpcy5jaGF0W2luZGV4XS5tZXRhZGF0YS50ZXh0OwogICAgICBmb3JtX3BheWxvYWRbImVudGl0eSJdID0gdGhpcy5jaGF0W2luZGV4XS5tZXRhZGF0YS5lbnRpdHk7CgogICAgICBmb3IgKHZhciBpIGluIHF1ZXJ5U3RyaW5nKSB7CiAgICAgICAgZm9ybV9wYXlsb2FkW3F1ZXJ5U3RyaW5nW2ldLm5hbWVdID0gdGhpcy5jaGF0W2luZGV4XS5jdXN0b21lcl9lbWFpbF9pZDsKICAgICAgfQoKICAgICAgZm9ybV9wYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkoZm9ybV9wYXlsb2FkKTsKICAgICAgYXhpb3MucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCAoX2F4aW9zJHBvc3QxNiA9IHsKICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgY2hhdDogIi9yZV9vcmRlcl9wcm9kdWN0c19hY3Rpb24iLmNvbmNhdChmb3JtX3BheWxvYWQpCiAgICAgIH0sIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDE2LCAidG9rZW4iLCB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSksIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDE2LCAicm9sZSIsIHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlKSwgX2RlZmluZVByb3BlcnR5KF9heGlvcyRwb3N0MTYsICJyZWZyZXNoZWRfb3JfY2xvc2VkIiwgdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkKSwgX2F4aW9zJHBvc3QxNikpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgX3RoaXM0MC5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICIiOwogICAgICAgIF90aGlzNDAuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzID0gZmFsc2U7CgogICAgICAgIF90aGlzNDAuY2hhdC5zcGxpY2UoaW5kZXgsIDEpOwoKICAgICAgICBfdGhpczQwLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgIGNvbnNvbGUubG9nKCJFcnJvciA6Pj4gIiwgZXJyKTsKICAgICAgfSk7CiAgICB9IGVsc2Ugey8vIGxldCBmb3JtX3BheWxvYWQgPSB7CiAgICAgIC8vICAgZW1haWw6J2FzaGlzaC5pQGNvZGVhcnJheS50ZWNoJywKICAgICAgLy8gICBwYXNzd29yZDogIiIsCiAgICAgIC8vICAgc2hvcGlmeV9pc19vbmx5X2VtYWlsOiBmYWxzZSwKICAgICAgLy8gICB0ZXh0OiB0aGlzLmNoYXRbaW5kZXhdLm1ldGFkYXRhLnRleHQsCiAgICAgIC8vICAgZW50aXR5IDogdGhpcy5jaGF0W2luZGV4XS5tZXRhZGF0YS5lbnRpdHkKICAgICAgLy8gfTsKICAgICAgLy8gZm9ybV9wYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkoZm9ybV9wYXlsb2FkKTsKICAgICAgLy8gYXhpb3MKICAgICAgLy8gICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgIC8vICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAvLyAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAvLyAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgLy8gICAgIHNvdXJjZTogIldlYiIsCiAgICAgIC8vICAgICBjaGF0OiBgL3JlX29yZGVyX3Byb2R1Y3RzX2FjdGlvbiR7Zm9ybV9wYXlsb2FkfWAsCiAgICAgIC8vICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgIC8vICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgLy8gICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgLy8gICB9KQogICAgICAvLyAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAvLyAgICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YSk7CiAgICAgIC8vICAgICBjb25zb2xlLmxvZyh0aGlzKTsKICAgICAgLy8gICAgIHRoaXMucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpCiAgICAgIC8vICAgfSkKICAgICAgLy8gICAuY2F0Y2goKGVycikgPT4gewogICAgICAvLyAgICAgY29uc29sZS5sb2coIkVycm9yIDo+PiAiLCBlcnIpOwogICAgICAvLyAgIH0pOwogICAgfQogIH0sCiAgb3Blbl9tZXNzYWdpbmdfZnJhbWV3b3JrX2ludGVncmF0aW9uOiBmdW5jdGlvbiBvcGVuX21lc3NhZ2luZ19mcmFtZXdvcmtfaW50ZWdyYXRpb24odXJsKSB7CiAgICB2YXIgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgIGxpbmsuaHJlZiA9IHVybDsgLy8gbGluay5zZXRBdHRyaWJ1dGUoImRvd25sb2FkIiwgZmlsZV9uYW1lKTsKCiAgICBsaW5rLnNldEF0dHJpYnV0ZSgidGFyZ2V0IiwgIl9ibGFuayIpOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChsaW5rKTsKICAgIGxpbmsuY2xpY2soKTsKICAgIGxpbmsucmVtb3ZlKCk7CiAgfSwKICBzdXBwb3J0X3N1YnNjcmlwdGlvbl9kYXRhOiBmdW5jdGlvbiBzdXBwb3J0X3N1YnNjcmlwdGlvbl9kYXRhKCkgewogICAgdmFyIF9heGlvcyRwb3N0MTcsCiAgICAgICAgX3RoaXM0MSA9IHRoaXM7CgogICAgYXhpb3MucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCAoX2F4aW9zJHBvc3QxNyA9IHsKICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsCiAgICB9LCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3QxNywgInRva2VuIiwgdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3QxNywgInJvbGUiLCB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSksIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDE3LCAicmVmcmVzaGVkX29yX2Nsb3NlZCIsIHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCksIF9kZWZpbmVQcm9wZXJ0eShfYXhpb3MkcG9zdDE3LCAiY2hhdCIsICIvc3VwcG9ydF9zdWJzY3JpcHRpb25fZGF0YSIpLCBfZGVmaW5lUHJvcGVydHkoX2F4aW9zJHBvc3QxNywgInNvdXJjZSIsICJXZWIiKSwgX2F4aW9zJHBvc3QxNykpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIF90aGlzNDEucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpOwogICAgfSk7CiAgfSwKICBjaGVja19ub19wcm9kdWN0czogZnVuY3Rpb24gY2hlY2tfbm9fcHJvZHVjdHMoKSB7CiAgICB2YXIgcHJvZHVjdHNfZGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2R1Y3RzX2xpc3RfZGl2Jyk7CiAgICB2YXIgZGlzcGxheV9ub25lX2NvdW50ID0gMDsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb2R1Y3RzX2Rpdi5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBpZiAocHJvZHVjdHNfZGl2LmNoaWxkcmVuW2ldLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIikgewogICAgICAgIGRpc3BsYXlfbm9uZV9jb3VudCArPSAxOwogICAgICB9CiAgICB9CgogICAgaWYgKGRpc3BsYXlfbm9uZV9jb3VudCA9PT0gcHJvZHVjdHNfZGl2LmNoaWxkcmVuLmxlbmd0aCkgewogICAgICB2YXIgbXNnID0gewogICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgIHJlY2VpdmVkOiAiU29ycnksIHdlIGNvdWxkIG5vdCBmaW5kIGFueSBwcm9kdWN0cy4gUGxlYXNlIHRyeSByZXBocmFzaW5nIHRvIHNlYXJjaCBhIGRpZmZlcmVudCBwcm9kdWN0ISIsCiAgICAgICAgcmVjZWl2aW5nOiB0cnVlCiAgICAgIH07CiAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICB9CiAgfSwKICBnZXRfbWFnZW50b19zdG9yZV93aW5kb3dfY3VzdG9tZXJfZW1haWw6IGZ1bmN0aW9uIGdldF9tYWdlbnRvX3N0b3JlX3dpbmRvd19jdXN0b21lcl9lbWFpbCgpIHsKICAgIHRyeSB7CiAgICAgIHZhciBjdXJyID0gSlNPTi5wYXJzZSh0aGlzLnVzZXJfZGF0YS5tYWdlbnRvX2N1c3RvbWVyX2RhdGEpOwoKICAgICAgaWYgKEJvb2xlYW4oY3Vyci5pZCkgPT0gdHJ1ZSAmJiBCb29sZWFuKGN1cnIuZW1haWwpID09IHRydWUpIHsKICAgICAgICB2YXIgY3VzdG9tZXIgPSBbY3Vyci5pZCwgY3Vyci5lbWFpbF07CiAgICAgICAgcmV0dXJuIGN1c3RvbWVyOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7fQoKICAgIHJldHVybiBudWxsOwogIH0sCiAgZ2V0X3dvb2NvbW1lcmNlX3N0b3JlX3dpbmRvd19jdXN0b21lcl9lbWFpbDogZnVuY3Rpb24gZ2V0X3dvb2NvbW1lcmNlX3N0b3JlX3dpbmRvd19jdXN0b21lcl9lbWFpbCgpIHsKICAgIHRyeSB7CiAgICAgIHZhciBjdXJyID0gdGhpcy51c2VyX2RhdGEud29vX2N1cnJlbnRfdXNlcjsKCiAgICAgIGlmIChjdXJyLklEICE9PSAwICYmIGN1cnIuYWxsY2Fwcy5jdXN0b21lciA9PSB0cnVlKSB7CiAgICAgICAgdmFyIGN1c3RvbWVyID0gW2N1cnIuZGF0YS5JRCwgY3Vyci5kYXRhLnVzZXJfZW1haWxdOwogICAgICAgIHJldHVybiBjdXN0b21lcjsKICAgICAgfQogICAgfSBjYXRjaCAoZSkge30KCiAgICByZXR1cm4gbnVsbDsKICB9LAogIGdldF9zaG9waWZ5X3N0b3JlX3dpbmRvd19jdXN0b21lcl9pZDogZnVuY3Rpb24gZ2V0X3Nob3BpZnlfc3RvcmVfd2luZG93X2N1c3RvbWVyX2lkKCkgewogICAgdHJ5IHsKICAgICAgdmFyIGN1cnIgPSB3aW5kb3cuU2hvcGlmeUFuYWx5dGljcy5tZXRhLnBhZ2UuY3VzdG9tZXJJZDsKCiAgICAgIGlmIChjdXJyICE9PSB1bmRlZmluZWQgJiYgY3VyciAhPT0gbnVsbCAmJiBjdXJyICE9PSAiIikgewogICAgICAgIHJldHVybiBjdXJyOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7fQoKICAgIHRyeSB7CiAgICAgIHZhciBfY3VyciA9IHdpbmRvdy5tZXRhLnBhZ2UuY3VzdG9tZXJJZDsKCiAgICAgIGlmIChfY3VyciAhPT0gdW5kZWZpbmVkICYmIF9jdXJyICE9PSBudWxsICYmIF9jdXJyICE9PSAiIikgewogICAgICAgIHJldHVybiBfY3VycjsKICAgICAgfQogICAgfSBjYXRjaCAoZSkge30KCiAgICB0cnkgewogICAgICB2YXIgX2N1cnIyID0gX3N0LmNpZDsKCiAgICAgIGlmIChfY3VycjIgIT09IHVuZGVmaW5lZCAmJiBfY3VycjIgIT09IG51bGwgJiYgX2N1cnIyICE9PSAiIikgewogICAgICAgIHJldHVybiBfY3VycjI7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHt9CgogICAgcmV0dXJuIG51bGw7CiAgfSwKICBub19vcmRlcnNfdG9fYmVfc2hvd246IGZ1bmN0aW9uIG5vX29yZGVyc190b19iZV9zaG93bihpbmRleCkgewogICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJJdCBzZWVtcyB5b3UgaGF2ZSBubyBvcmRlcnMgcmlnaHQgbm93ISI7CiAgfSwKICBjaGFuZ2VfY2hhdF90ZXh0X3RvX2xvZ2luX3JlZGlyZWN0OiBmdW5jdGlvbiBjaGFuZ2VfY2hhdF90ZXh0X3RvX2xvZ2luX3JlZGlyZWN0KGluZGV4KSB7CiAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gJzxwIHN0eWxlPSJ3aWR0aDphdXRvO21hcmdpbi1ib3R0b206MDsiPiBQbGVhc2UgbG9naW4gb24gdGhlIHN0b3JlIGJ5IGNsaWNraW5nIDxhIHRpdGxlPSJUaGlzIGZlYXR1cmUgaXMgb25seSBhdmFpbGFibGUgb24gdGhlIHN0b3JlIHdlYnNpdGUuImNsYXNzPSJib3QtcmVzcG9uc2Utc3R5bGUiIHN0eWxlPSJjdXJzb3I6IG5vdC1hbGxvd2VkOyIgaHJlZj0iamF2YXNjcmlwdDogdm9pZCgwKSI+IGhlcmUgPC9hPjwvcD4nOwogIH0sCiAgcmV0dXJuX2RvY3VtZW50X2Nvb2tpZXM6IGZ1bmN0aW9uIHJldHVybl9kb2N1bWVudF9jb29raWVzKG5hbWUpIHsKICAgIC8vIGNvbnN0IHZhbHVlID0gYDsgJHtkb2N1bWVudC5jb29raWV9YDsKICAgIC8vIGNvbnN0IHBhcnRzID0gdmFsdWUuc3BsaXQoYDsgJHtuYW1lfT1gKTsKICAgIC8vIGlmIChwYXJ0cy5sZW5ndGggPT09IDIpIHJldHVybiBwYXJ0cy5wb3AoKS5zcGxpdCgnOycpLnNoaWZ0KCk7CiAgICB2YXIgY29va2llID0ge307CiAgICBkb2N1bWVudC5jb29raWUuc3BsaXQoJzsnKS5mb3JFYWNoKGZ1bmN0aW9uIChlbCkgewogICAgICB2YXIgX2VsJHNwbGl0ID0gZWwuc3BsaXQoJz0nKSwKICAgICAgICAgIF9lbCRzcGxpdDIgPSBfc2xpY2VkVG9BcnJheShfZWwkc3BsaXQsIDIpLAogICAgICAgICAgayA9IF9lbCRzcGxpdDJbMF0sCiAgICAgICAgICB2ID0gX2VsJHNwbGl0MlsxXTsKCiAgICAgIGNvb2tpZVtrLnRyaW0oKV0gPSB2OwogICAgfSk7CiAgICByZXR1cm4gY29va2llW25hbWVdOwogIH0sCiAgYXZhaWxhYmxlX3F0eTogZnVuY3Rpb24gYXZhaWxhYmxlX3F0eShzdG9ja19xdHksIGlkKSB7CiAgICBpZiAodGhpcy5hZGR0b0NhcnRkYXRhLmxlbmd0aCAhPSAwKSB7CiAgICAgIGZvciAodmFyIGkgaW4gdGhpcy5hZGR0b0NhcnRkYXRhKSB7CiAgICAgICAgaWYgKHRoaXMuYWRkdG9DYXJ0ZGF0YVtpXS5pZCA9PT0gaWQpIHsKICAgICAgICAgIHZhciByZXMgPSBzdG9ja19xdHkgLSB0aGlzLmFkZHRvQ2FydGRhdGFbaV0ub3JkZXJfcXR5OwogICAgICAgICAgcmV0dXJuIHJlcyA9PSAwID8gInJlYWNoZWQiIDogcmVzOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHN0b2NrX3F0eTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBzdG9ja19xdHk7CiAgICB9CiAgfQp9KSwgX25hbWUkY29tcG9uZW50cyRtaXhpKTs="},null]}