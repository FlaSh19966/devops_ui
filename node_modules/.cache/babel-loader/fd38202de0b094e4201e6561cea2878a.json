{"remainingRequest":"/home/vimalesh/CENSE/chatbot-portal/node_modules/thread-loader/dist/cjs.js!/home/vimalesh/CENSE/chatbot-portal/node_modules/babel-loader/lib/index.js!/home/vimalesh/CENSE/chatbot-portal/node_modules/eslint-loader/index.js??ref--13-0!/home/vimalesh/CENSE/chatbot-portal/src/portal/Chatbot/Dashboard/Layout/intro.js","dependencies":[{"path":"/home/vimalesh/CENSE/chatbot-portal/src/portal/Chatbot/Dashboard/Layout/intro.js","mtime":1643027096176},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/eslint-loader/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:cmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN5bWJvbCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN5bWJvbC5kZXNjcmlwdGlvbiIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN5bWJvbC5pdGVyYXRvciIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmNvbmNhdCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmluY2x1ZGVzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuaW5kZXgtb2YiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5zbGljZSIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNwbGljZSIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC50by1zdHJpbmciKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5yZWdleHAuZXhlYyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC50by1zdHJpbmciKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuaW5jbHVkZXMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuaXRlcmF0b3IiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcubWF0Y2giKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcucmVwbGFjZSIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5zcGxpdCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuaXRlcmF0b3IiKTsKCnZhciBfdHlwZW9mMiA9IHJlcXVpcmUoIi9ob21lL3ZpbWFsZXNoL0NFTlNFL2NoYXRib3QtcG9ydGFsL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL3R5cGVvZiIpOwoKLyohCiAqIEludHJvLmpzIHYzLjAuMQogKiBodHRwczovL2dpdGh1Yi5jb20vdXNhYmxpY2EvaW50cm8uanMKICoKICogQ29weXJpZ2h0IChDKSAyMDE3LTIwMjAgQWZzaGluIE1laHJhYmFuaSAoQGFmc2hpbm1laCkuCiAqIGh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS91c2FibGljYS9pbnRyby5qcy9tYXN0ZXIvbGljZW5zZS5tZAogKgogKiBEYXRlOiBTYXQsIDE3IE9jdCAyMDIwIDEwOjM2OjIwIEdNVAogKi8KdmFyIF9yZXF1aXJlID0gcmVxdWlyZSgiZDMiKSwKICAgIGltYWdlID0gX3JlcXVpcmUuaW1hZ2U7CgooZnVuY3Rpb24gKGdsb2JhbCwgZmFjdG9yeSkgewogICh0eXBlb2YgZXhwb3J0cyA9PT0gInVuZGVmaW5lZCIgPyAidW5kZWZpbmVkIiA6IF90eXBlb2YyKGV4cG9ydHMpKSA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgPyBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKSA6IHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCA/IGRlZmluZShmYWN0b3J5KSA6IChnbG9iYWwgPSBnbG9iYWwgfHwgc2VsZiwgZ2xvYmFsLmludHJvSnMgPSBmYWN0b3J5KCkpOwp9KSh0aGlzLCBmdW5jdGlvbiAoKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBmdW5jdGlvbiBfdHlwZW9mKG9iaikgewogICAgIkBiYWJlbC9oZWxwZXJzIC0gdHlwZW9mIjsKCiAgICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID09PSAic3ltYm9sIikgewogICAgICBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsKICAgICAgICByZXR1cm4gdHlwZW9mIG9iajsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIF90eXBlb2YgPSBmdW5jdGlvbiBfdHlwZW9mKG9iaikgewogICAgICAgIHJldHVybiBvYmogJiYgdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBvYmouY29uc3RydWN0b3IgPT09IFN5bWJvbCAmJiBvYmogIT09IFN5bWJvbC5wcm90b3R5cGUgPyAic3ltYm9sIiA6IHR5cGVvZiBvYmo7CiAgICAgIH07CiAgICB9CgogICAgcmV0dXJuIF90eXBlb2Yob2JqKTsKICB9CiAgLyoqCiAgICogT3ZlcndyaXRlcyBvYmoxJ3MgdmFsdWVzIHdpdGggb2JqMidzIGFuZCBhZGRzIG9iajIncyBpZiBub24gZXhpc3RlbnQgaW4gb2JqMQogICAqIHZpYTogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xNzEyNTEvaG93LWNhbi1pLW1lcmdlLXByb3BlcnRpZXMtb2YtdHdvLWphdmFzY3JpcHQtb2JqZWN0cy1keW5hbWljYWxseQogICAqCiAgICogQHBhcmFtIG9iajEKICAgKiBAcGFyYW0gb2JqMgogICAqIEByZXR1cm5zIG9iajMgYSBuZXcgb2JqZWN0IGJhc2VkIG9uIG9iajEgYW5kIG9iajIKICAgKi8KCgogIGZ1bmN0aW9uIG1lcmdlT3B0aW9ucyhvYmoxLCBvYmoyKSB7CiAgICB2YXIgb2JqMyA9IHt9OwogICAgdmFyIGF0dHJuYW1lOwoKICAgIGZvciAoYXR0cm5hbWUgaW4gb2JqMSkgewogICAgICBvYmozW2F0dHJuYW1lXSA9IG9iajFbYXR0cm5hbWVdOwogICAgfQoKICAgIGZvciAoYXR0cm5hbWUgaW4gb2JqMikgewogICAgICBvYmozW2F0dHJuYW1lXSA9IG9iajJbYXR0cm5hbWVdOwogICAgfQoKICAgIHJldHVybiBvYmozOwogIH0KICAvKioKICAgKiBNYXJrIGFueSBvYmplY3Qgd2l0aCBhbiBpbmNyZW1lbnRpbmcgbnVtYmVyCiAgICogdXNlZCBmb3Iga2VlcGluZyB0cmFjayBvZiBvYmplY3RzCiAgICoKICAgKiBAcGFyYW0gT2JqZWN0IG9iaiAgIEFueSBvYmplY3Qgb3IgRE9NIEVsZW1lbnQKICAgKiBAcGFyYW0gU3RyaW5nIGtleQogICAqIEByZXR1cm4gT2JqZWN0CiAgICovCgoKICB2YXIgc3RhbXAgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIga2V5cyA9IHt9OwogICAgcmV0dXJuIGZ1bmN0aW9uIHN0YW1wKG9iaikgewogICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiAiaW50cm9qcy1zdGFtcCI7IC8vIGVhY2ggZ3JvdXAgaW5jcmVtZW50cyBmcm9tIDAKCiAgICAgIGtleXNba2V5XSA9IGtleXNba2V5XSB8fCAwOyAvLyBzdGFtcCBvbmx5IG9uY2UgcGVyIG9iamVjdAoKICAgICAgaWYgKG9ialtrZXldID09PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyBpbmNyZW1lbnQga2V5IGZvciBlYWNoIG5ldyBvYmplY3QKICAgICAgICBvYmpba2V5XSA9IGtleXNba2V5XSsrOwogICAgICB9CgogICAgICByZXR1cm4gb2JqW2tleV07CiAgICB9OwogIH0oKTsKICAvKioKICAgKiBJdGVyYXRlcyBhcnJheXMKICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IGFycgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZvckVhY2hGbmMKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb21wbGV0ZUZuYwogICAqIEByZXR1cm4ge051bGx9CiAgICovCgoKICBmdW5jdGlvbiBmb3JFYWNoKGFyciwgZm9yRWFjaEZuYywgY29tcGxldGVGbmMpIHsKICAgIC8vIGluIGNhc2UgYXJyIGlzIGFuIGVtcHR5IHF1ZXJ5IHNlbGVjdG9yIG5vZGUgbGlzdAogICAgaWYgKGFycikgewogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgZm9yRWFjaEZuYyhhcnJbaV0sIGkpOwogICAgICB9CiAgICB9CgogICAgaWYgKHR5cGVvZiBjb21wbGV0ZUZuYyA9PT0gImZ1bmN0aW9uIikgewogICAgICBjb21wbGV0ZUZuYygpOwogICAgfQogIH0KICAvKioKICAgKiBSZW1vdmUgYSBjbGFzcyBmcm9tIGFuIGVsZW1lbnQKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX3JlbW92ZUNsYXNzCiAgICogQHBhcmFtIHtPYmplY3R9IGVsZW1lbnQKICAgKiBAcGFyYW0ge1JlZ0V4cHxTdHJpbmd9IGNsYXNzTmFtZVJlZ2V4IGNhbiBiZSByZWdleCBvciBzdHJpbmcKICAgKiBAcmV0dXJucyBudWxsCiAgICovCgoKICBmdW5jdGlvbiByZW1vdmVDbGFzcyhlbGVtZW50LCBjbGFzc05hbWVSZWdleCkgewogICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBTVkdFbGVtZW50KSB7CiAgICAgIHZhciBwcmUgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgiY2xhc3MiKSB8fCAiIjsKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgcHJlLnJlcGxhY2UoY2xhc3NOYW1lUmVnZXgsICIiKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgIiIpKTsKICAgIH0gZWxzZSB7CiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gZWxlbWVudC5jbGFzc05hbWUucmVwbGFjZShjbGFzc05hbWVSZWdleCwgIiIpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAiIik7CiAgICB9CiAgfQogIC8qKgogICAqIERPTUV2ZW50IEhhbmRsZXMgYWxsIERPTSBldmVudHMKICAgKgogICAqIG1ldGhvZHM6CiAgICoKICAgKiBvbiAtIGFkZCBldmVudCBoYW5kbGVyCiAgICogb2ZmIC0gcmVtb3ZlIGV2ZW50CiAgICovCgoKICB2YXIgRE9NRXZlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBET01FdmVudCgpIHsKICAgICAgdmFyIGV2ZW50c19rZXkgPSAiaW50cm9qc19ldmVudCI7CiAgICAgIC8qKgogICAgICAgKiBHZXRzIGEgdW5pcXVlIElEIGZvciBhbiBldmVudCBsaXN0ZW5lcgogICAgICAgKgogICAgICAgKiBAcGFyYW0gb2JqIE9iamVjdAogICAgICAgKiBAcGFyYW0gdHlwZSBldmVudCB0eXBlCiAgICAgICAqIEBwYXJhbSBsaXN0ZW5lciBGdW5jdGlvbgogICAgICAgKiBAcGFyYW0gY29udGV4dCBPYmplY3QKICAgICAgICogQHJldHVybiBTdHJpbmcKICAgICAgICovCgogICAgICB0aGlzLl9pZCA9IGZ1bmN0aW9uIChvYmosIHR5cGUsIGxpc3RlbmVyLCBjb250ZXh0KSB7CiAgICAgICAgcmV0dXJuIHR5cGUgKyBzdGFtcChsaXN0ZW5lcikgKyAoY29udGV4dCA/ICJfIi5jb25jYXQoc3RhbXAoY29udGV4dCkpIDogIiIpOwogICAgICB9OwogICAgICAvKioKICAgICAgICogQWRkcyBldmVudCBsaXN0ZW5lcgogICAgICAgKgogICAgICAgKiBAcGFyYW0gb2JqIE9iamVjdCBvYmoKICAgICAgICogQHBhcmFtIHR5cGUgU3RyaW5nCiAgICAgICAqIEBwYXJhbSBsaXN0ZW5lciBGdW5jdGlvbgogICAgICAgKiBAcGFyYW0gY29udGV4dCBPYmplY3QKICAgICAgICogQHBhcmFtIHVzZUNhcHR1cmUgQm9vbGVhbgogICAgICAgKiBAcmV0dXJuIG51bGwKICAgICAgICovCgoKICAgICAgdGhpcy5vbiA9IGZ1bmN0aW9uIChvYmosIHR5cGUsIGxpc3RlbmVyLCBjb250ZXh0LCB1c2VDYXB0dXJlKSB7CiAgICAgICAgdmFyIGlkID0gdGhpcy5faWQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiBoYW5kbGVyKGUpIHsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lci5jYWxsKGNvbnRleHQgfHwgb2JqLCBlIHx8IHdpbmRvdy5ldmVudCk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKCJhZGRFdmVudExpc3RlbmVyIiBpbiBvYmopIHsKICAgICAgICAgIG9iai5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZXIsIHVzZUNhcHR1cmUpOwogICAgICAgIH0gZWxzZSBpZiAoImF0dGFjaEV2ZW50IiBpbiBvYmopIHsKICAgICAgICAgIG9iai5hdHRhY2hFdmVudCgib24iLmNvbmNhdCh0eXBlKSwgaGFuZGxlcik7CiAgICAgICAgfQoKICAgICAgICBvYmpbZXZlbnRzX2tleV0gPSBvYmpbZXZlbnRzX2tleV0gfHwge307CiAgICAgICAgb2JqW2V2ZW50c19rZXldW2lkXSA9IGhhbmRsZXI7CiAgICAgIH07CiAgICAgIC8qKgogICAgICAgKiBSZW1vdmVzIGV2ZW50IGxpc3RlbmVyCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSBvYmogT2JqZWN0CiAgICAgICAqIEBwYXJhbSB0eXBlIFN0cmluZwogICAgICAgKiBAcGFyYW0gbGlzdGVuZXIgRnVuY3Rpb24KICAgICAgICogQHBhcmFtIGNvbnRleHQgT2JqZWN0CiAgICAgICAqIEBwYXJhbSB1c2VDYXB0dXJlIEJvb2xlYW4KICAgICAgICogQHJldHVybiBudWxsCiAgICAgICAqLwoKCiAgICAgIHRoaXMub2ZmID0gZnVuY3Rpb24gKG9iaiwgdHlwZSwgbGlzdGVuZXIsIGNvbnRleHQsIHVzZUNhcHR1cmUpIHsKICAgICAgICB2YXIgaWQgPSB0aGlzLl9pZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICB2YXIgaGFuZGxlciA9IG9ialtldmVudHNfa2V5XSAmJiBvYmpbZXZlbnRzX2tleV1baWRdOwoKICAgICAgICBpZiAoIWhhbmRsZXIpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICgicmVtb3ZlRXZlbnRMaXN0ZW5lciIgaW4gb2JqKSB7CiAgICAgICAgICBvYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBoYW5kbGVyLCB1c2VDYXB0dXJlKTsKICAgICAgICB9IGVsc2UgaWYgKCJkZXRhY2hFdmVudCIgaW4gb2JqKSB7CiAgICAgICAgICBvYmouZGV0YWNoRXZlbnQoIm9uIi5jb25jYXQodHlwZSksIGhhbmRsZXIpOwogICAgICAgIH0KCiAgICAgICAgb2JqW2V2ZW50c19rZXldW2lkXSA9IG51bGw7CiAgICAgIH07CiAgICB9CgogICAgcmV0dXJuIG5ldyBET01FdmVudCgpOwogIH0oKTsKICAvKioKICAgKiBBcHBlbmQgYSBjbGFzcyB0byBhbiBlbGVtZW50CiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9hZGRDbGFzcwogICAqIEBwYXJhbSB7T2JqZWN0fSBlbGVtZW50CiAgICogQHBhcmFtIHtTdHJpbmd9IGNsYXNzTmFtZQogICAqIEByZXR1cm5zIG51bGwKICAgKi8KCgogIGZ1bmN0aW9uIGFkZENsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSkgewogICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBTVkdFbGVtZW50KSB7CiAgICAgIC8vIHN2ZwogICAgICB2YXIgcHJlID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoImNsYXNzIikgfHwgIiI7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJjbGFzcyIsICIiLmNvbmNhdChwcmUsICIgIikuY29uY2F0KGNsYXNzTmFtZSkpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKGVsZW1lbnQuY2xhc3NMaXN0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyBjaGVjayBmb3IgbW9kZXJuIGNsYXNzTGlzdCBwcm9wZXJ0eQogICAgICAgIHZhciBjbGFzc2VzID0gY2xhc3NOYW1lLnNwbGl0KCIgIik7CiAgICAgICAgZm9yRWFjaChjbGFzc2VzLCBmdW5jdGlvbiAoY2xzKSB7CiAgICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoY2xzKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICghZWxlbWVudC5jbGFzc05hbWUubWF0Y2goY2xhc3NOYW1lKSkgewogICAgICAgIC8vIGNoZWNrIGlmIGVsZW1lbnQgZG9lc24ndCBhbHJlYWR5IGhhdmUgY2xhc3NOYW1lCiAgICAgICAgZWxlbWVudC5jbGFzc05hbWUgKz0gIiAiLmNvbmNhdChjbGFzc05hbWUpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIEdldCBhbiBlbGVtZW50IENTUyBwcm9wZXJ0eSBvbiB0aGUgcGFnZQogICAqIFRoYW5rcyB0byBKYXZhU2NyaXB0IEtpdDogaHR0cDovL3d3dy5qYXZhc2NyaXB0a2l0LmNvbS9kaHRtbHR1dG9ycy9kaHRtbGNhc2NhZGU0LnNodG1sCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9nZXRQcm9wVmFsdWUKICAgKiBAcGFyYW0ge09iamVjdH0gZWxlbWVudAogICAqIEBwYXJhbSB7U3RyaW5nfSBwcm9wTmFtZQogICAqIEByZXR1cm5zIHN0cmluZyBwcm9wZXJ0eSB2YWx1ZQogICAqLwoKCiAgZnVuY3Rpb24gZ2V0UHJvcFZhbHVlKGVsZW1lbnQsIHByb3BOYW1lKSB7CiAgICB2YXIgcHJvcFZhbHVlID0gIiI7CgogICAgaWYgKGVsZW1lbnQuY3VycmVudFN0eWxlKSB7CiAgICAgIC8vSUUKICAgICAgcHJvcFZhbHVlID0gZWxlbWVudC5jdXJyZW50U3R5bGVbcHJvcE5hbWVdOwogICAgfSBlbHNlIGlmIChkb2N1bWVudC5kZWZhdWx0VmlldyAmJiBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKSB7CiAgICAgIC8vT3RoZXJzCiAgICAgIHByb3BWYWx1ZSA9IGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgbnVsbCkuZ2V0UHJvcGVydHlWYWx1ZShwcm9wTmFtZSk7CiAgICB9IC8vUHJldmVudCBleGNlcHRpb24gaW4gSUUKCgogICAgaWYgKHByb3BWYWx1ZSAmJiBwcm9wVmFsdWUudG9Mb3dlckNhc2UpIHsKICAgICAgcmV0dXJuIHByb3BWYWx1ZS50b0xvd2VyQ2FzZSgpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHByb3BWYWx1ZTsKICAgIH0KICB9CiAgLyoqCiAgICogVG8gc2V0IHRoZSBzaG93IGVsZW1lbnQKICAgKiBUaGlzIGZ1bmN0aW9uIHNldCBhIHJlbGF0aXZlIChpbiBtb3N0IGNhc2VzKSBwb3NpdGlvbiBhbmQgY2hhbmdlcyB0aGUgei1pbmRleAogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfc2V0U2hvd0VsZW1lbnQKICAgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0RWxlbWVudAogICAqLwoKCiAgZnVuY3Rpb24gc2V0U2hvd0VsZW1lbnQoX3JlZikgewogICAgdmFyIGVsZW1lbnQgPSBfcmVmLmVsZW1lbnQ7CiAgICB2YXIgcGFyZW50RWxtOyAvLyB3ZSBuZWVkIHRvIGFkZCB0aGlzIHNob3cgZWxlbWVudCBjbGFzcyB0byB0aGUgcGFyZW50IG9mIFNWRyBlbGVtZW50cwogICAgLy8gYmVjYXVzZSB0aGUgU1ZHIGVsZW1lbnRzIGNhbid0IGhhdmUgaW5kZXBlbmRlbnQgei1pbmRleAoKICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgU1ZHRWxlbWVudCkgewogICAgICBwYXJlbnRFbG0gPSBlbGVtZW50LnBhcmVudE5vZGU7CgogICAgICB3aGlsZSAoZWxlbWVudC5wYXJlbnROb2RlICE9PSBudWxsKSB7CiAgICAgICAgaWYgKCFwYXJlbnRFbG0udGFnTmFtZSB8fCBwYXJlbnRFbG0udGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiYm9keSIpIGJyZWFrOwoKICAgICAgICBpZiAocGFyZW50RWxtLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gInN2ZyIpIHsKICAgICAgICAgIGFkZENsYXNzKHBhcmVudEVsbSwgImludHJvanMtc2hvd0VsZW1lbnQgaW50cm9qcy1yZWxhdGl2ZVBvc2l0aW9uIik7CiAgICAgICAgfQoKICAgICAgICBwYXJlbnRFbG0gPSBwYXJlbnRFbG0ucGFyZW50Tm9kZTsKICAgICAgfQogICAgfQoKICAgIGFkZENsYXNzKGVsZW1lbnQsICJpbnRyb2pzLXNob3dFbGVtZW50Iik7CiAgICB2YXIgY3VycmVudEVsZW1lbnRQb3NpdGlvbiA9IGdldFByb3BWYWx1ZShlbGVtZW50LCAicG9zaXRpb24iKTsKCiAgICBpZiAoY3VycmVudEVsZW1lbnRQb3NpdGlvbiAhPT0gImFic29sdXRlIiAmJiBjdXJyZW50RWxlbWVudFBvc2l0aW9uICE9PSAicmVsYXRpdmUiICYmIGN1cnJlbnRFbGVtZW50UG9zaXRpb24gIT09ICJmaXhlZCIpIHsKICAgICAgLy9jaGFuZ2UgdG8gbmV3IGludHJvIGl0ZW0KICAgICAgYWRkQ2xhc3MoZWxlbWVudCwgImludHJvanMtcmVsYXRpdmVQb3NpdGlvbiIpOwogICAgfQoKICAgIHBhcmVudEVsbSA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCiAgICB3aGlsZSAocGFyZW50RWxtICE9PSBudWxsKSB7CiAgICAgIGlmICghcGFyZW50RWxtLnRhZ05hbWUgfHwgcGFyZW50RWxtLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gImJvZHkiKSBicmVhazsgLy9maXggVGhlIFN0YWNraW5nIENvbnRleHQgcHJvYmxlbS4KICAgICAgLy9Nb3JlIGRldGFpbDogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvR3VpZGUvQ1NTL1VuZGVyc3RhbmRpbmdfel9pbmRleC9UaGVfc3RhY2tpbmdfY29udGV4dAoKICAgICAgdmFyIHpJbmRleCA9IGdldFByb3BWYWx1ZShwYXJlbnRFbG0sICJ6LWluZGV4Iik7CiAgICAgIHZhciBvcGFjaXR5ID0gcGFyc2VGbG9hdChnZXRQcm9wVmFsdWUocGFyZW50RWxtLCAib3BhY2l0eSIpKTsKICAgICAgdmFyIHRyYW5zZm9ybSA9IGdldFByb3BWYWx1ZShwYXJlbnRFbG0sICJ0cmFuc2Zvcm0iKSB8fCBnZXRQcm9wVmFsdWUocGFyZW50RWxtLCAiLXdlYmtpdC10cmFuc2Zvcm0iKSB8fCBnZXRQcm9wVmFsdWUocGFyZW50RWxtLCAiLW1vei10cmFuc2Zvcm0iKSB8fCBnZXRQcm9wVmFsdWUocGFyZW50RWxtLCAiLW1zLXRyYW5zZm9ybSIpIHx8IGdldFByb3BWYWx1ZShwYXJlbnRFbG0sICItby10cmFuc2Zvcm0iKTsKCiAgICAgIGlmICgvWzAtOV0rLy50ZXN0KHpJbmRleCkgfHwgb3BhY2l0eSA8IDEgfHwgdHJhbnNmb3JtICE9PSAibm9uZSIgJiYgdHJhbnNmb3JtICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBhZGRDbGFzcyhwYXJlbnRFbG0sICJpbnRyb2pzLWZpeFBhcmVudCIpOwogICAgICB9CgogICAgICBwYXJlbnRFbG0gPSBwYXJlbnRFbG0ucGFyZW50Tm9kZTsKICAgIH0KICB9CiAgLyoqCiAgICogc2Nyb2xsIGEgc2Nyb2xsYWJsZSBlbGVtZW50IHRvIGEgY2hpbGQgZWxlbWVudAogICAqCiAgICogQHBhcmFtIEVsZW1lbnQgcGFyZW50CiAgICogQHBhcmFtIEVsZW1lbnQgZWxlbWVudAogICAqIEByZXR1cm4gTnVsbAogICAqLwoKCiAgZnVuY3Rpb24gc2Nyb2xsUGFyZW50VG9FbGVtZW50KHBhcmVudCwgX3JlZikgewogICAgdmFyIG9mZnNldFRvcCA9IF9yZWYub2Zmc2V0VG9wOwogICAgcGFyZW50LnNjcm9sbFRvcCA9IG9mZnNldFRvcCAtIHBhcmVudC5vZmZzZXRUb3A7CiAgfQogIC8qKgogICAqIEZpbmQgdGhlIG5lYXJlc3Qgc2Nyb2xsYWJsZSBwYXJlbnQKICAgKiBjb3BpZWQgZnJvbSBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zNTkzOTg4Ni9maW5kLWZpcnN0LXNjcm9sbGFibGUtcGFyZW50CiAgICoKICAgKiBAcGFyYW0gRWxlbWVudCBlbGVtZW50CiAgICogQHJldHVybiBFbGVtZW50CiAgICovCgoKICBmdW5jdGlvbiBnZXRTY3JvbGxQYXJlbnQoZWxlbWVudCkgewogICAgdmFyIHN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCk7CiAgICB2YXIgZXhjbHVkZVN0YXRpY1BhcmVudCA9IHN0eWxlLnBvc2l0aW9uID09PSAiYWJzb2x1dGUiOwogICAgdmFyIG92ZXJmbG93UmVnZXggPSAvKGF1dG98c2Nyb2xsKS87CiAgICBpZiAoc3R5bGUucG9zaXRpb24gPT09ICJmaXhlZCIpIHJldHVybiBkb2N1bWVudC5ib2R5OwoKICAgIGZvciAodmFyIHBhcmVudCA9IGVsZW1lbnQ7IHBhcmVudCA9IHBhcmVudC5wYXJlbnRFbGVtZW50OykgewogICAgICBzdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHBhcmVudCk7CgogICAgICBpZiAoZXhjbHVkZVN0YXRpY1BhcmVudCAmJiBzdHlsZS5wb3NpdGlvbiA9PT0gInN0YXRpYyIpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgaWYgKG92ZXJmbG93UmVnZXgudGVzdChzdHlsZS5vdmVyZmxvdyArIHN0eWxlLm92ZXJmbG93WSArIHN0eWxlLm92ZXJmbG93WCkpIHJldHVybiBwYXJlbnQ7CiAgICB9CgogICAgcmV0dXJuIGRvY3VtZW50LmJvZHk7CiAgfQogIC8qKgogICAqIFByb3ZpZGVzIGEgY3Jvc3MtYnJvd3NlciB3YXkgdG8gZ2V0IHRoZSBzY3JlZW4gZGltZW5zaW9ucwogICAqIHZpYTogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy81ODY0NDY3L2ludGVybmV0LWV4cGxvcmVyLWlubmVyaGVpZ2h0CiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9nZXRXaW5TaXplCiAgICogQHJldHVybnMge09iamVjdH0gd2lkdGggYW5kIGhlaWdodCBhdHRyaWJ1dGVzCiAgICovCgoKICBmdW5jdGlvbiBnZXRXaW5TaXplKCkgewogICAgaWYgKHdpbmRvdy5pbm5lcldpZHRoICE9PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB3aWR0aDogd2luZG93LmlubmVyV2lkdGgsCiAgICAgICAgaGVpZ2h0OiB3aW5kb3cuaW5uZXJIZWlnaHQKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBEID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgICByZXR1cm4gewogICAgICAgIHdpZHRoOiBELmNsaWVudFdpZHRoLAogICAgICAgIGhlaWdodDogRC5jbGllbnRIZWlnaHQKICAgICAgfTsKICAgIH0KICB9CiAgLyoqCiAgICogQ2hlY2sgdG8gc2VlIGlmIHRoZSBlbGVtZW50IGlzIGluIHRoZSB2aWV3cG9ydCBvciBub3QKICAgKiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzEyMzk5OS9ob3ctdG8tdGVsbC1pZi1hLWRvbS1lbGVtZW50LWlzLXZpc2libGUtaW4tdGhlLWN1cnJlbnQtdmlld3BvcnQKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX2VsZW1lbnRJblZpZXdwb3J0CiAgICogQHBhcmFtIHtPYmplY3R9IGVsCiAgICovCgoKICBmdW5jdGlvbiBlbGVtZW50SW5WaWV3cG9ydChlbCkgewogICAgdmFyIHJlY3QgPSBlbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIHJldHVybiByZWN0LnRvcCA+PSAwICYmIHJlY3QubGVmdCA+PSAwICYmIHJlY3QuYm90dG9tICsgODAgPD0gd2luZG93LmlubmVySGVpZ2h0ICYmIC8vIGFkZCA4MCB0byBnZXQgdGhlIHRleHQgcmlnaHQKICAgIHJlY3QucmlnaHQgPD0gd2luZG93LmlubmVyV2lkdGg7CiAgfQogIC8qKgogICAqIFRvIGNoYW5nZSB0aGUgc2Nyb2xsIG9mIGB3aW5kb3dgIGFmdGVyIGhpZ2hsaWdodGluZyBhbiBlbGVtZW50CiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9zY3JvbGxUbwogICAqIEBwYXJhbSB7U3RyaW5nfSBzY3JvbGxUbwogICAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXRFbGVtZW50CiAgICogQHBhcmFtIHtPYmplY3R9IHRvb2x0aXBMYXllcgogICAqLwoKCiAgZnVuY3Rpb24gc2Nyb2xsVG8oc2Nyb2xsVG8sIF9yZWYsIHRvb2x0aXBMYXllcikgewogICAgdmFyIGVsZW1lbnQgPSBfcmVmLmVsZW1lbnQ7CiAgICBpZiAoc2Nyb2xsVG8gPT09ICJvZmYiKSByZXR1cm47CiAgICB2YXIgcmVjdDsKICAgIGlmICghdGhpcy5fb3B0aW9ucy5zY3JvbGxUb0VsZW1lbnQpIHJldHVybjsKCiAgICBpZiAoc2Nyb2xsVG8gPT09ICJ0b29sdGlwIikgewogICAgICByZWN0ID0gdG9vbHRpcExheWVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgfSBlbHNlIHsKICAgICAgcmVjdCA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICB9CgogICAgaWYgKCFlbGVtZW50SW5WaWV3cG9ydChlbGVtZW50KSkgewogICAgICB2YXIgd2luSGVpZ2h0ID0gZ2V0V2luU2l6ZSgpLmhlaWdodDsKICAgICAgdmFyIHRvcCA9IHJlY3QuYm90dG9tIC0gKHJlY3QuYm90dG9tIC0gcmVjdC50b3ApOyAvLyBUT0RPIChhZnNoaW5tKTogZG8gd2UgbmVlZCBzY3JvbGwgcGFkZGluZyBub3c/CiAgICAgIC8vIEkgaGF2ZSBjaGFuZ2VkIHRoZSBzY3JvbGwgb3B0aW9uIGFuZCBub3cgaXQgc2Nyb2xscyB0aGUgd2luZG93IHRvCiAgICAgIC8vIHRoZSBjZW50ZXIgb2YgdGhlIHRhcmdldCBlbGVtZW50IG9yIHRvb2x0aXAuCgogICAgICBpZiAodG9wIDwgMCB8fCBlbGVtZW50LmNsaWVudEhlaWdodCA+IHdpbkhlaWdodCkgewogICAgICAgIHdpbmRvdy5zY3JvbGxCeSgwLCByZWN0LnRvcCAtICh3aW5IZWlnaHQgLyAyIC0gcmVjdC5oZWlnaHQgLyAyKSAtIHRoaXMuX29wdGlvbnMuc2Nyb2xsUGFkZGluZyk7IC8vIDMwcHggcGFkZGluZyBmcm9tIGVkZ2UgdG8gbG9vayBuaWNlCiAgICAgICAgLy9TY3JvbGwgZG93bgogICAgICB9IGVsc2UgewogICAgICAgIHdpbmRvdy5zY3JvbGxCeSgwLCByZWN0LnRvcCAtICh3aW5IZWlnaHQgLyAyIC0gcmVjdC5oZWlnaHQgLyAyKSArIHRoaXMuX29wdGlvbnMuc2Nyb2xsUGFkZGluZyk7IC8vIDMwcHggcGFkZGluZyBmcm9tIGVkZ2UgdG8gbG9vayBuaWNlCiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogU2V0dGluZyBhbmNob3JzIHRvIGJlaGF2ZSBsaWtlIGJ1dHRvbnMKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX3NldEFuY2hvckFzQnV0dG9uCiAgICovCgoKICBmdW5jdGlvbiBzZXRBbmNob3JBc0J1dHRvbihhbmNob3IpIHsKICAgIGFuY2hvci5zZXRBdHRyaWJ1dGUoInJvbGUiLCAiYnV0dG9uIik7CiAgICBhbmNob3IudGFiSW5kZXggPSAwOwogIH0KICAvKioKICAgKiBHZXQgYW4gZWxlbWVudCBwb3NpdGlvbiBvbiB0aGUgcGFnZQogICAqIFRoYW5rcyB0byBgbWVvdXdgOiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS80NDI0NzQvMzc1OTY2CiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9nZXRPZmZzZXQKICAgKiBAcGFyYW0ge09iamVjdH0gZWxlbWVudAogICAqIEByZXR1cm5zIEVsZW1lbnQncyBwb3NpdGlvbiBpbmZvCiAgICovCgoKICBmdW5jdGlvbiBnZXRPZmZzZXQoZWxlbWVudCkgewogICAgdmFyIGJvZHkgPSBkb2N1bWVudC5ib2R5OwogICAgdmFyIGRvY0VsID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgdmFyIHNjcm9sbFRvcCA9IHdpbmRvdy5wYWdlWU9mZnNldCB8fCBkb2NFbC5zY3JvbGxUb3AgfHwgYm9keS5zY3JvbGxUb3A7CiAgICB2YXIgc2Nyb2xsTGVmdCA9IHdpbmRvdy5wYWdlWE9mZnNldCB8fCBkb2NFbC5zY3JvbGxMZWZ0IHx8IGJvZHkuc2Nyb2xsTGVmdDsKICAgIHZhciB4ID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIHJldHVybiB7CiAgICAgIHRvcDogeC50b3AgKyBzY3JvbGxUb3AsCiAgICAgIHdpZHRoOiB4LndpZHRoLAogICAgICBoZWlnaHQ6IHguaGVpZ2h0LAogICAgICBsZWZ0OiB4LmxlZnQgKyBzY3JvbGxMZWZ0CiAgICB9OwogIH0KICAvKioKICAgKiBDaGVja3MgdG8gc2VlIGlmIHRhcmdldCBlbGVtZW50IChvciBwYXJlbnRzKSBwb3NpdGlvbiBpcyBmaXhlZCBvciBub3QKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX2lzRml4ZWQKICAgKiBAcGFyYW0ge09iamVjdH0gZWxlbWVudAogICAqIEByZXR1cm5zIEJvb2xlYW4KICAgKi8KCgogIGZ1bmN0aW9uIGlzRml4ZWQoZWxlbWVudCkgewogICAgdmFyIHAgPSBlbGVtZW50LnBhcmVudE5vZGU7CgogICAgaWYgKCFwIHx8IHAubm9kZU5hbWUgPT09ICJIVE1MIikgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKGdldFByb3BWYWx1ZShlbGVtZW50LCAicG9zaXRpb24iKSA9PT0gImZpeGVkIikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICByZXR1cm4gaXNGaXhlZChwKTsKICB9CiAgLyoqCiAgICogVXBkYXRlIHRoZSBwb3NpdGlvbiBvZiB0aGUgaGVscGVyIGxheWVyIG9uIHRoZSBzY3JlZW4KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX3NldEhlbHBlckxheWVyUG9zaXRpb24KICAgKiBAcGFyYW0ge09iamVjdH0gaGVscGVyTGF5ZXIKICAgKi8KCgogIGZ1bmN0aW9uIHNldEhlbHBlckxheWVyUG9zaXRpb24oaGVscGVyTGF5ZXIpIHsKICAgIGlmIChoZWxwZXJMYXllcikgewogICAgICAvL3ByZXZlbnQgZXJyb3Igd2hlbiBgdGhpcy5fY3VycmVudFN0ZXBgIGluIHVuZGVmaW5lZAogICAgICBpZiAoIXRoaXMuX2ludHJvSXRlbXNbdGhpcy5fY3VycmVudFN0ZXBdKSByZXR1cm47CiAgICAgIHZhciBjdXJyZW50RWxlbWVudCA9IHRoaXMuX2ludHJvSXRlbXNbdGhpcy5fY3VycmVudFN0ZXBdOwogICAgICB2YXIgZWxlbWVudFBvc2l0aW9uID0gZ2V0T2Zmc2V0KGN1cnJlbnRFbGVtZW50LmVsZW1lbnQpOwogICAgICB2YXIgd2lkdGhIZWlnaHRQYWRkaW5nID0gdGhpcy5fb3B0aW9ucy5oZWxwZXJFbGVtZW50UGFkZGluZzsgLy8gSWYgdGhlIHRhcmdldCBlbGVtZW50IGlzIGZpeGVkLCB0aGUgdG9vbHRpcCBzaG91bGQgYmUgZml4ZWQgYXMgd2VsbC4KICAgICAgLy8gT3RoZXJ3aXNlLCByZW1vdmUgYSBmaXhlZCBjbGFzcyB0aGF0IG1heSBiZSBsZWZ0IG92ZXIgZnJvbSB0aGUgcHJldmlvdXMKICAgICAgLy8gc3RlcC4KCiAgICAgIGlmIChpc0ZpeGVkKGN1cnJlbnRFbGVtZW50LmVsZW1lbnQpKSB7CiAgICAgICAgYWRkQ2xhc3MoaGVscGVyTGF5ZXIsICJpbnRyb2pzLWZpeGVkVG9vbHRpcCIpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlbW92ZUNsYXNzKGhlbHBlckxheWVyLCAiaW50cm9qcy1maXhlZFRvb2x0aXAiKTsKICAgICAgfQoKICAgICAgaWYgKGN1cnJlbnRFbGVtZW50LnBvc2l0aW9uID09PSAiZmxvYXRpbmciKSB7CiAgICAgICAgd2lkdGhIZWlnaHRQYWRkaW5nID0gMDsKICAgICAgfSAvL3NldCBuZXcgcG9zaXRpb24gdG8gaGVscGVyIGxheWVyCgoKICAgICAgaGVscGVyTGF5ZXIuc3R5bGUuY3NzVGV4dCA9ICJ3aWR0aDogIi5jb25jYXQoZWxlbWVudFBvc2l0aW9uLndpZHRoICsgd2lkdGhIZWlnaHRQYWRkaW5nLCAicHg7IGhlaWdodDoiKS5jb25jYXQoZWxlbWVudFBvc2l0aW9uLmhlaWdodCArIHdpZHRoSGVpZ2h0UGFkZGluZywgInB4OyB0b3A6IikuY29uY2F0KGVsZW1lbnRQb3NpdGlvbi50b3AgLSB3aWR0aEhlaWdodFBhZGRpbmcgLyAyLCAicHg7bGVmdDogIikuY29uY2F0KGVsZW1lbnRQb3NpdGlvbi5sZWZ0IC0gd2lkdGhIZWlnaHRQYWRkaW5nIC8gMiwgInB4OyIpOwogICAgfQogIH0KICAvKioKICAgKiBTZXQgdG9vbHRpcCBsZWZ0IHNvIGl0IGRvZXNuJ3QgZ28gb2ZmIHRoZSByaWdodCBzaWRlIG9mIHRoZSB3aW5kb3cKICAgKgogICAqIEByZXR1cm4gYm9vbGVhbiB0cnVlLCBpZiB0b29sdGlwTGF5ZXJTdHlsZUxlZnQgaXMgb2suICBmYWxzZSwgb3RoZXJ3aXNlLgogICAqLwoKCiAgZnVuY3Rpb24gY2hlY2tSaWdodCh0YXJnZXRPZmZzZXQsIHRvb2x0aXBMYXllclN0eWxlTGVmdCwgdG9vbHRpcE9mZnNldCwgd2luZG93U2l6ZSwgdG9vbHRpcExheWVyKSB7CiAgICBpZiAodGFyZ2V0T2Zmc2V0LmxlZnQgKyB0b29sdGlwTGF5ZXJTdHlsZUxlZnQgKyB0b29sdGlwT2Zmc2V0LndpZHRoID4gd2luZG93U2l6ZS53aWR0aCkgewogICAgICAvLyBvZmYgdGhlIHJpZ2h0IHNpZGUgb2YgdGhlIHdpbmRvdwogICAgICB0b29sdGlwTGF5ZXIubGVmdCA9ICIiLmNvbmNhdCh3aW5kb3dTaXplLndpZHRoIC0gdG9vbHRpcE9mZnNldC53aWR0aCAtIHRhcmdldE9mZnNldC5sZWZ0LCAicHgiKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHRvb2x0aXBMYXllci5sZWZ0ID0gIiIuY29uY2F0KHRvb2x0aXBMYXllclN0eWxlTGVmdCwgInB4Iik7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgLyoqCiAgICogU2V0IHRvb2x0aXAgcmlnaHQgc28gaXQgZG9lc24ndCBnbyBvZmYgdGhlIGxlZnQgc2lkZSBvZiB0aGUgd2luZG93CiAgICoKICAgKiBAcmV0dXJuIGJvb2xlYW4gdHJ1ZSwgaWYgdG9vbHRpcExheWVyU3R5bGVSaWdodCBpcyBvay4gIGZhbHNlLCBvdGhlcndpc2UuCiAgICovCgoKICBmdW5jdGlvbiBjaGVja0xlZnQodGFyZ2V0T2Zmc2V0LCB0b29sdGlwTGF5ZXJTdHlsZVJpZ2h0LCB0b29sdGlwT2Zmc2V0LCB0b29sdGlwTGF5ZXIpIHsKICAgIGlmICh0YXJnZXRPZmZzZXQubGVmdCArIHRhcmdldE9mZnNldC53aWR0aCAtIHRvb2x0aXBMYXllclN0eWxlUmlnaHQgLSB0b29sdGlwT2Zmc2V0LndpZHRoIDwgMCkgewogICAgICAvLyBvZmYgdGhlIGxlZnQgc2lkZSBvZiB0aGUgd2luZG93CiAgICAgIHRvb2x0aXBMYXllci5zdHlsZS5sZWZ0ID0gIiIuY29uY2F0KC10YXJnZXRPZmZzZXQubGVmdCwgInB4Iik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICB0b29sdGlwTGF5ZXIuc3R5bGUucmlnaHQgPSAiIi5jb25jYXQodG9vbHRpcExheWVyU3R5bGVSaWdodCwgInB4Iik7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgLyoqCiAgICogUmVtb3ZlIGFuIGVudHJ5IGZyb20gYSBzdHJpbmcgYXJyYXkgaWYgaXQncyB0aGVyZSwgZG9lcyBub3RoaW5nIGlmIGl0IGlzbid0IHRoZXJlLgogICAqCiAgICogQHBhcmFtIHtBcnJheX0gc3RyaW5nQXJyYXkKICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyaW5nVG9SZW1vdmUKICAgKi8KCgogIGZ1bmN0aW9uIHJlbW92ZUVudHJ5KHN0cmluZ0FycmF5LCBzdHJpbmdUb1JlbW92ZSkgewogICAgaWYgKHN0cmluZ0FycmF5LmluY2x1ZGVzKHN0cmluZ1RvUmVtb3ZlKSkgewogICAgICBzdHJpbmdBcnJheS5zcGxpY2Uoc3RyaW5nQXJyYXkuaW5kZXhPZihzdHJpbmdUb1JlbW92ZSksIDEpOwogICAgfQogIH0KICAvKioKICAgKiBhdXRvLWRldGVybWluZSBhbGlnbm1lbnQKICAgKiBAcGFyYW0ge0ludGVnZXJ9ICBvZmZzZXRMZWZ0CiAgICogQHBhcmFtIHtJbnRlZ2VyfSAgdG9vbHRpcFdpZHRoCiAgICogQHBhcmFtIHtPYmplY3R9ICAgd2luZG93U2l6ZQogICAqIEBwYXJhbSB7U3RyaW5nfSAgIGRlc2lyZWRBbGlnbm1lbnQKICAgKiBAcmV0dXJuIHtTdHJpbmd9ICBjYWxjdWxhdGVkQWxpZ25tZW50CiAgICovCgoKICBmdW5jdGlvbiBfZGV0ZXJtaW5lQXV0b0FsaWdubWVudChvZmZzZXRMZWZ0LCB0b29sdGlwV2lkdGgsIF9yZWYsIGRlc2lyZWRBbGlnbm1lbnQpIHsKICAgIHZhciB3aWR0aCA9IF9yZWYud2lkdGg7CiAgICB2YXIgaGFsZlRvb2x0aXBXaWR0aCA9IHRvb2x0aXBXaWR0aCAvIDI7CiAgICB2YXIgd2luV2lkdGggPSBNYXRoLm1pbih3aWR0aCwgd2luZG93LnNjcmVlbi53aWR0aCk7CiAgICB2YXIgcG9zc2libGVBbGlnbm1lbnRzID0gWyItbGVmdC1hbGlnbmVkIiwgIi1taWRkbGUtYWxpZ25lZCIsICItcmlnaHQtYWxpZ25lZCJdOwogICAgdmFyIGNhbGN1bGF0ZWRBbGlnbm1lbnQgPSAiIjsgLy8gdmFsaWQgbGVmdCBtdXN0IGJlIGF0IGxlYXN0IGEgdG9vbHRpcFdpZHRoCiAgICAvLyBhd2F5IGZyb20gcmlnaHQgc2lkZQoKICAgIGlmICh3aW5XaWR0aCAtIG9mZnNldExlZnQgPCB0b29sdGlwV2lkdGgpIHsKICAgICAgcmVtb3ZlRW50cnkocG9zc2libGVBbGlnbm1lbnRzLCAiLWxlZnQtYWxpZ25lZCIpOwogICAgfSAvLyB2YWxpZCBtaWRkbGUgbXVzdCBiZSBhdCBsZWFzdCBoYWxmCiAgICAvLyB3aWR0aCBhd2F5IGZyb20gYm90aCBzaWRlcwoKCiAgICBpZiAob2Zmc2V0TGVmdCA8IGhhbGZUb29sdGlwV2lkdGggfHwgd2luV2lkdGggLSBvZmZzZXRMZWZ0IDwgaGFsZlRvb2x0aXBXaWR0aCkgewogICAgICByZW1vdmVFbnRyeShwb3NzaWJsZUFsaWdubWVudHMsICItbWlkZGxlLWFsaWduZWQiKTsKICAgIH0gLy8gdmFsaWQgcmlnaHQgbXVzdCBiZSBhdCBsZWFzdCBhIHRvb2x0aXBXaWR0aAogICAgLy8gd2lkdGggYXdheSBmcm9tIGxlZnQgc2lkZQoKCiAgICBpZiAob2Zmc2V0TGVmdCA8IHRvb2x0aXBXaWR0aCkgewogICAgICByZW1vdmVFbnRyeShwb3NzaWJsZUFsaWdubWVudHMsICItcmlnaHQtYWxpZ25lZCIpOwogICAgfQoKICAgIGlmIChwb3NzaWJsZUFsaWdubWVudHMubGVuZ3RoKSB7CiAgICAgIGlmIChwb3NzaWJsZUFsaWdubWVudHMuaW5jbHVkZXMoZGVzaXJlZEFsaWdubWVudCkpIHsKICAgICAgICAvLyB0aGUgZGVzaXJlZCBhbGlnbm1lbnQgaXMgdmFsaWQKICAgICAgICBjYWxjdWxhdGVkQWxpZ25tZW50ID0gZGVzaXJlZEFsaWdubWVudDsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBwaWNrIHRoZSBmaXJzdCB2YWxpZCBwb3NpdGlvbiwgaW4gb3JkZXIKICAgICAgICBjYWxjdWxhdGVkQWxpZ25tZW50ID0gcG9zc2libGVBbGlnbm1lbnRzWzBdOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBpZiBzY3JlZW4gd2lkdGggaXMgdG9vIHNtYWxsCiAgICAgIC8vIGZvciBBTlkgYWxpZ25tZW50LCBtaWRkbGUgaXMKICAgICAgLy8gcHJvYmFibHkgdGhlIGJlc3QgZm9yIHZpc2liaWxpdHkKICAgICAgY2FsY3VsYXRlZEFsaWdubWVudCA9ICItbWlkZGxlLWFsaWduZWQiOwogICAgfQoKICAgIHJldHVybiBjYWxjdWxhdGVkQWxpZ25tZW50OwogIH0KICAvKioKICAgKiBEZXRlcm1pbmVzIHRoZSBwb3NpdGlvbiBvZiB0aGUgdG9vbHRpcCBiYXNlZCBvbiB0aGUgcG9zaXRpb24gcHJlY2VkZW5jZSBhbmQgYXZhaWxhYmlsaXR5CiAgICogb2Ygc2NyZWVuIHNwYWNlLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9ICAgIHRhcmdldEVsZW1lbnQKICAgKiBAcGFyYW0ge09iamVjdH0gICAgdG9vbHRpcExheWVyCiAgICogQHBhcmFtIHtTdHJpbmd9ICAgIGRlc2lyZWRUb29sdGlwUG9zaXRpb24KICAgKiBAcmV0dXJuIHtTdHJpbmd9ICAgY2FsY3VsYXRlZFBvc2l0aW9uCiAgICovCgoKICBmdW5jdGlvbiBfZGV0ZXJtaW5lQXV0b1Bvc2l0aW9uKHRhcmdldEVsZW1lbnQsIHRvb2x0aXBMYXllciwgZGVzaXJlZFRvb2x0aXBQb3NpdGlvbikgewogICAgLy8gVGFrZSBhIGNsb25lIG9mIHBvc2l0aW9uIHByZWNlZGVuY2UuIFRoZXNlIHdpbGwgYmUgdGhlIGF2YWlsYWJsZQogICAgdmFyIHBvc3NpYmxlUG9zaXRpb25zID0gdGhpcy5fb3B0aW9ucy5wb3NpdGlvblByZWNlZGVuY2Uuc2xpY2UoKTsKCiAgICB2YXIgd2luZG93U2l6ZSA9IGdldFdpblNpemUoKTsKICAgIHZhciB0b29sdGlwSGVpZ2h0ID0gZ2V0T2Zmc2V0KHRvb2x0aXBMYXllcikuaGVpZ2h0ICsgMTA7CiAgICB2YXIgdG9vbHRpcFdpZHRoID0gZ2V0T2Zmc2V0KHRvb2x0aXBMYXllcikud2lkdGggKyAyMDsKICAgIHZhciB0YXJnZXRFbGVtZW50UmVjdCA9IHRhcmdldEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7IC8vIElmIHdlIGNoZWNrIGFsbCB0aGUgcG9zc2libGUgYXJlYXMsIGFuZCB0aGVyZSBhcmUgbm8gdmFsaWQgcGxhY2VzIGZvciB0aGUgdG9vbHRpcCwgdGhlIGVsZW1lbnQKICAgIC8vIG11c3QgdGFrZSB1cCBtb3N0IG9mIHRoZSBzY3JlZW4gcmVhbCBlc3RhdGUuIFNob3cgdGhlIHRvb2x0aXAgZmxvYXRpbmcgaW4gdGhlIG1pZGRsZSBvZiB0aGUgc2NyZWVuLgoKICAgIHZhciBjYWxjdWxhdGVkUG9zaXRpb24gPSAiZmxvYXRpbmciOwogICAgLyoKICAgICAqIGF1dG8gZGV0ZXJtaW5lIHBvc2l0aW9uCiAgICAgKi8KICAgIC8vIENoZWNrIGZvciBzcGFjZSBiZWxvdwoKICAgIGlmICh0YXJnZXRFbGVtZW50UmVjdC5ib3R0b20gKyB0b29sdGlwSGVpZ2h0ID4gd2luZG93U2l6ZS5oZWlnaHQpIHsKICAgICAgcmVtb3ZlRW50cnkocG9zc2libGVQb3NpdGlvbnMsICJib3R0b20iKTsKICAgIH0gLy8gQ2hlY2sgZm9yIHNwYWNlIGFib3ZlCgoKICAgIGlmICh0YXJnZXRFbGVtZW50UmVjdC50b3AgLSB0b29sdGlwSGVpZ2h0IDwgMCkgewogICAgICByZW1vdmVFbnRyeShwb3NzaWJsZVBvc2l0aW9ucywgInRvcCIpOwogICAgfSAvLyBDaGVjayBmb3Igc3BhY2UgdG8gdGhlIHJpZ2h0CgoKICAgIGlmICh0YXJnZXRFbGVtZW50UmVjdC5yaWdodCArIHRvb2x0aXBXaWR0aCA+IHdpbmRvd1NpemUud2lkdGgpIHsKICAgICAgcmVtb3ZlRW50cnkocG9zc2libGVQb3NpdGlvbnMsICJyaWdodCIpOwogICAgfSAvLyBDaGVjayBmb3Igc3BhY2UgdG8gdGhlIGxlZnQKCgogICAgaWYgKHRhcmdldEVsZW1lbnRSZWN0LmxlZnQgLSB0b29sdGlwV2lkdGggPCAwKSB7CiAgICAgIHJlbW92ZUVudHJ5KHBvc3NpYmxlUG9zaXRpb25zLCAibGVmdCIpOwogICAgfSAvLyBAdmFyIHtTdHJpbmd9ICBleDogJ3JpZ2h0LWFsaWduZWQnCgoKICAgIHZhciBkZXNpcmVkQWxpZ25tZW50ID0gZnVuY3Rpb24gKHBvcykgewogICAgICB2YXIgaHlwaGVuSW5kZXggPSBwb3MuaW5kZXhPZigiLSIpOwoKICAgICAgaWYgKGh5cGhlbkluZGV4ICE9PSAtMSkgewogICAgICAgIC8vIGhhcyBhbGlnbm1lbnQKICAgICAgICByZXR1cm4gcG9zLnN1YnN0cihoeXBoZW5JbmRleCk7CiAgICAgIH0KCiAgICAgIHJldHVybiAiIjsKICAgIH0oZGVzaXJlZFRvb2x0aXBQb3NpdGlvbiB8fCAiIik7IC8vIHN0cmlwIGFsaWdubWVudCBmcm9tIHBvc2l0aW9uCgoKICAgIGlmIChkZXNpcmVkVG9vbHRpcFBvc2l0aW9uKSB7CiAgICAgIC8vIGV4OiAiYm90dG9tLXJpZ2h0LWFsaWduZWQiCiAgICAgIC8vIHNob3VsZCByZXR1cm4gJ2JvdHRvbScKICAgICAgZGVzaXJlZFRvb2x0aXBQb3NpdGlvbiA9IGRlc2lyZWRUb29sdGlwUG9zaXRpb24uc3BsaXQoIi0iKVswXTsKICAgIH0KCiAgICBpZiAocG9zc2libGVQb3NpdGlvbnMubGVuZ3RoKSB7CiAgICAgIGlmIChkZXNpcmVkVG9vbHRpcFBvc2l0aW9uICE9PSAiYXV0byIgJiYgcG9zc2libGVQb3NpdGlvbnMuaW5jbHVkZXMoZGVzaXJlZFRvb2x0aXBQb3NpdGlvbikpIHsKICAgICAgICAvLyBJZiB0aGUgcmVxdWVzdGVkIHBvc2l0aW9uIGlzIGluIHRoZSBsaXN0LCBjaG9vc2UgdGhhdAogICAgICAgIGNhbGN1bGF0ZWRQb3NpdGlvbiA9IGRlc2lyZWRUb29sdGlwUG9zaXRpb247CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gUGljayB0aGUgZmlyc3QgdmFsaWQgcG9zaXRpb24sIGluIG9yZGVyCiAgICAgICAgY2FsY3VsYXRlZFBvc2l0aW9uID0gcG9zc2libGVQb3NpdGlvbnNbMF07CiAgICAgIH0KICAgIH0gLy8gb25seSB0b3AgYW5kIGJvdHRvbSBwb3NpdGlvbnMgaGF2ZSBvcHRpb25hbCBhbGlnbm1lbnRzCgoKICAgIGlmIChbInRvcCIsICJib3R0b20iXS5pbmNsdWRlcyhjYWxjdWxhdGVkUG9zaXRpb24pKSB7CiAgICAgIGNhbGN1bGF0ZWRQb3NpdGlvbiArPSBfZGV0ZXJtaW5lQXV0b0FsaWdubWVudCh0YXJnZXRFbGVtZW50UmVjdC5sZWZ0LCB0b29sdGlwV2lkdGgsIHdpbmRvd1NpemUsIGRlc2lyZWRBbGlnbm1lbnQpOwogICAgfQoKICAgIHJldHVybiBjYWxjdWxhdGVkUG9zaXRpb247CiAgfQogIC8qKgogICAqIFJlbmRlciB0b29sdGlwIGJveCBpbiB0aGUgcGFnZQogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBwbGFjZVRvb2x0aXAKICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSB0YXJnZXRFbGVtZW50CiAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gdG9vbHRpcExheWVyCiAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gYXJyb3dMYXllcgogICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGhlbHBlck51bWJlckxheWVyCiAgICogQHBhcmFtIHtCb29sZWFufSBoaW50TW9kZQogICAqLwoKCiAgZnVuY3Rpb24gcGxhY2VUb29sdGlwKHRhcmdldEVsZW1lbnQsIHRvb2x0aXBMYXllciwgYXJyb3dMYXllciwgaGVscGVyTnVtYmVyTGF5ZXIsIGhpbnRNb2RlKSB7CiAgICB2YXIgdG9vbHRpcENzc0NsYXNzID0gIiI7CiAgICB2YXIgY3VycmVudFN0ZXBPYmo7CiAgICB2YXIgdG9vbHRpcE9mZnNldDsKICAgIHZhciB0YXJnZXRPZmZzZXQ7CiAgICB2YXIgd2luZG93U2l6ZTsKICAgIHZhciBjdXJyZW50VG9vbHRpcFBvc2l0aW9uOwogICAgaGludE1vZGUgPSBoaW50TW9kZSB8fCBmYWxzZTsgLy9yZXNldCB0aGUgb2xkIHN0eWxlCgogICAgdG9vbHRpcExheWVyLnN0eWxlLnRvcCA9IG51bGw7CiAgICB0b29sdGlwTGF5ZXIuc3R5bGUucmlnaHQgPSBudWxsOwogICAgdG9vbHRpcExheWVyLnN0eWxlLmJvdHRvbSA9IG51bGw7CiAgICB0b29sdGlwTGF5ZXIuc3R5bGUubGVmdCA9IG51bGw7CiAgICB0b29sdGlwTGF5ZXIuc3R5bGUubWFyZ2luTGVmdCA9IG51bGw7CiAgICB0b29sdGlwTGF5ZXIuc3R5bGUubWFyZ2luVG9wID0gbnVsbDsKICAgIGFycm93TGF5ZXIuc3R5bGUuZGlzcGxheSA9ICJpbmhlcml0IjsKCiAgICBpZiAodHlwZW9mIGhlbHBlck51bWJlckxheWVyICE9PSAidW5kZWZpbmVkIiAmJiBoZWxwZXJOdW1iZXJMYXllciAhPT0gbnVsbCkgewogICAgICBoZWxwZXJOdW1iZXJMYXllci5zdHlsZS50b3AgPSBudWxsOwogICAgICBoZWxwZXJOdW1iZXJMYXllci5zdHlsZS5sZWZ0ID0gbnVsbDsKICAgIH0gLy9wcmV2ZW50IGVycm9yIHdoZW4gYHRoaXMuX2N1cnJlbnRTdGVwYCBpcyB1bmRlZmluZWQKCgogICAgaWYgKCF0aGlzLl9pbnRyb0l0ZW1zW3RoaXMuX2N1cnJlbnRTdGVwXSkgcmV0dXJuOyAvL2lmIHdlIGhhdmUgYSBjdXN0b20gY3NzIGNsYXNzIGZvciBlYWNoIHN0ZXAKCiAgICBjdXJyZW50U3RlcE9iaiA9IHRoaXMuX2ludHJvSXRlbXNbdGhpcy5fY3VycmVudFN0ZXBdOwoKICAgIGlmICh0eXBlb2YgY3VycmVudFN0ZXBPYmoudG9vbHRpcENsYXNzID09PSAic3RyaW5nIikgewogICAgICB0b29sdGlwQ3NzQ2xhc3MgPSBjdXJyZW50U3RlcE9iai50b29sdGlwQ2xhc3M7CiAgICB9IGVsc2UgewogICAgICB0b29sdGlwQ3NzQ2xhc3MgPSB0aGlzLl9vcHRpb25zLnRvb2x0aXBDbGFzczsKICAgIH0KCiAgICB0b29sdGlwTGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtdG9vbHRpcCAiLmNvbmNhdCh0b29sdGlwQ3NzQ2xhc3MpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAiIik7CiAgICB0b29sdGlwTGF5ZXIuc2V0QXR0cmlidXRlKCJyb2xlIiwgImRpYWxvZyIpOwogICAgY3VycmVudFRvb2x0aXBQb3NpdGlvbiA9IHRoaXMuX2ludHJvSXRlbXNbdGhpcy5fY3VycmVudFN0ZXBdLnBvc2l0aW9uOyAvLyBGbG9hdGluZyBpcyBhbHdheXMgdmFsaWQsIG5vIHBvaW50IGluIGNhbGN1bGF0aW5nCgogICAgaWYgKGN1cnJlbnRUb29sdGlwUG9zaXRpb24gIT09ICJmbG9hdGluZyIpIHsvLyBjdXJyZW50VG9vbHRpcFBvc2l0aW9uID0gX2RldGVybWluZUF1dG9Qb3NpdGlvbi5jYWxsKHRoaXMsIHRhcmdldEVsZW1lbnQsIHRvb2x0aXBMYXllciwgY3VycmVudFRvb2x0aXBQb3NpdGlvbik7CiAgICB9CgogICAgdmFyIHRvb2x0aXBMYXllclN0eWxlTGVmdDsKICAgIHRhcmdldE9mZnNldCA9IGdldE9mZnNldCh0YXJnZXRFbGVtZW50KTsKICAgIHRvb2x0aXBPZmZzZXQgPSBnZXRPZmZzZXQodG9vbHRpcExheWVyKTsKICAgIHdpbmRvd1NpemUgPSBnZXRXaW5TaXplKCk7CiAgICBhZGRDbGFzcyh0b29sdGlwTGF5ZXIsICJpbnRyb2pzLSIuY29uY2F0KGN1cnJlbnRUb29sdGlwUG9zaXRpb24pKTsKCiAgICBzd2l0Y2ggKGN1cnJlbnRUb29sdGlwUG9zaXRpb24pIHsKICAgICAgY2FzZSAidG9wLXJpZ2h0LWFsaWduZWQiOgogICAgICAgIGFycm93TGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtYXJyb3cgYm90dG9tLXJpZ2h0IjsKICAgICAgICB2YXIgdG9vbHRpcExheWVyU3R5bGVSaWdodCA9IDA7CiAgICAgICAgY2hlY2tMZWZ0KHRhcmdldE9mZnNldCwgdG9vbHRpcExheWVyU3R5bGVSaWdodCwgdG9vbHRpcE9mZnNldCwgdG9vbHRpcExheWVyKTsKICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUuYm90dG9tID0gIiIuY29uY2F0KHRhcmdldE9mZnNldC5oZWlnaHQgKyAyMCwgInB4Iik7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICJ0b3AtbWlkZGxlLWFsaWduZWQiOgogICAgICAgIGFycm93TGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtYXJyb3cgYm90dG9tLW1pZGRsZSI7CiAgICAgICAgdmFyIHRvb2x0aXBMYXllclN0eWxlTGVmdFJpZ2h0ID0gdGFyZ2V0T2Zmc2V0LndpZHRoIC8gMiAtIHRvb2x0aXBPZmZzZXQud2lkdGggLyAyOyAvLyBhIGZpeCBmb3IgbWlkZGxlIGFsaWduZWQgaGludHMKCiAgICAgICAgaWYgKGhpbnRNb2RlKSB7CiAgICAgICAgICB0b29sdGlwTGF5ZXJTdHlsZUxlZnRSaWdodCArPSA1OwogICAgICAgIH0KCiAgICAgICAgaWYgKGNoZWNrTGVmdCh0YXJnZXRPZmZzZXQsIHRvb2x0aXBMYXllclN0eWxlTGVmdFJpZ2h0LCB0b29sdGlwT2Zmc2V0LCB0b29sdGlwTGF5ZXIpKSB7CiAgICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUucmlnaHQgPSBudWxsOwogICAgICAgICAgY2hlY2tSaWdodCh0YXJnZXRPZmZzZXQsIHRvb2x0aXBMYXllclN0eWxlTGVmdFJpZ2h0LCB0b29sdGlwT2Zmc2V0LCB3aW5kb3dTaXplLCB0b29sdGlwTGF5ZXIpOwogICAgICAgIH0KCiAgICAgICAgdG9vbHRpcExheWVyLnN0eWxlLmJvdHRvbSA9ICIiLmNvbmNhdCh0YXJnZXRPZmZzZXQuaGVpZ2h0ICsgMjAsICJweCIpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAidG9wLWxlZnQtYWxpZ25lZCI6IC8vIHRvcC1sZWZ0LWFsaWduZWQgaXMgdGhlIHNhbWUgYXMgdGhlIGRlZmF1bHQgdG9wCgogICAgICBjYXNlICJ0b3AiOgogICAgICAgIGFycm93TGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtYXJyb3cgYm90dG9tIjsKICAgICAgICB0b29sdGlwTGF5ZXJTdHlsZUxlZnQgPSBoaW50TW9kZSA/IDAgOiAxNTsKICAgICAgICBjaGVja1JpZ2h0KHRhcmdldE9mZnNldCwgdG9vbHRpcExheWVyU3R5bGVMZWZ0LCB0b29sdGlwT2Zmc2V0LCB3aW5kb3dTaXplLCB0b29sdGlwTGF5ZXIpOwogICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS5ib3R0b20gPSAiIi5jb25jYXQodGFyZ2V0T2Zmc2V0LmhlaWdodCArIDIwLCAicHgiKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgInJpZ2h0IjoKICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUubGVmdCA9ICIiLmNvbmNhdCh0YXJnZXRPZmZzZXQud2lkdGggKyAyMCArIDYzLCAicHgiKTsKICAgICAgICB2YXIgaW1hZ2VMYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwogICAgICAgIGltYWdlTGF5ZXIuc3JjID0gIi9pbWcvR3JvdXAzLnN2ZyI7CiAgICAgICAgdmFyIHBhcmVudF9kaXZfZm9yX2ltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImN1c3RvbS1hcnJvdy1pbWFnZS1jZW5zZSIpOwoKICAgICAgICBpZiAodGFyZ2V0T2Zmc2V0LnRvcCArIHRvb2x0aXBPZmZzZXQuaGVpZ2h0ID4gd2luZG93U2l6ZS5oZWlnaHQpIHsKICAgICAgICAgIC8vIEluIHRoaXMgY2FzZSwgcmlnaHQgd291bGQgaGF2ZSBmYWxsZW4gYmVsb3cgdGhlIGJvdHRvbSBvZiB0aGUgc2NyZWVuLgogICAgICAgICAgLy8gTW9kaWZ5IHNvIHRoYXQgdGhlIGJvdHRvbSBvZiB0aGUgdG9vbHRpcCBjb25uZWN0cyB3aXRoIHRoZSB0YXJnZXQKICAgICAgICAgIC8vIGFycm93TGF5ZXIuYXBwZW5kQ2hpbGQoaW1hZ2VMYXllcik7CiAgICAgICAgICAvLyBwYXJlbnRfZGl2X2Zvcl9pbWFnZS5hcHBlbmRDaGlsZChpbWFnZUxheWVyKTsKICAgICAgICAgIHBhcmVudF9kaXZfZm9yX2ltYWdlLnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKICAgICAgICAgIHBhcmVudF9kaXZfZm9yX2ltYWdlLnN0eWxlLmxlZnQgPSAiLTY3cHgiOwogICAgICAgICAgcGFyZW50X2Rpdl9mb3JfaW1hZ2Uuc3R5bGUudG9wID0gIiIuY29uY2F0KHRhcmdldE9mZnNldC5oZWlnaHQgLSAxMCwgInB4Iik7CiAgICAgICAgICBhcnJvd0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWFycm93IGxlZnQtYm90dG9tIjsKICAgICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS50b3AgPSAiLSIuY29uY2F0KHRvb2x0aXBPZmZzZXQuaGVpZ2h0IC0gdGFyZ2V0T2Zmc2V0LmhlaWdodCAtIDIwLCAicHgiKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gYXJyb3dMYXllci5hcHBlbmRDaGlsZChpbWFnZUxheWVyKTsKICAgICAgICAgIC8vIHBhcmVudF9kaXZfZm9yX2ltYWdlLmFwcGVuZENoaWxkKGltYWdlTGF5ZXIpOwogICAgICAgICAgcGFyZW50X2Rpdl9mb3JfaW1hZ2Uuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICAgICAgcGFyZW50X2Rpdl9mb3JfaW1hZ2Uuc3R5bGUubGVmdCA9ICItNjdweCI7CiAgICAgICAgICBwYXJlbnRfZGl2X2Zvcl9pbWFnZS5zdHlsZS50b3AgPSAiIi5jb25jYXQodGFyZ2V0T2Zmc2V0LmhlaWdodCAtIDEwLCAicHgiKTsgLy8gYXJyb3dMYXllci5jbGFzc05hbWUgPSAiaW50cm9qcy1hcnJvdyBsZWZ0IjsKCiAgICAgICAgICBhcnJvd0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWFycm93IGxlZnQtYm90dG9tIjsKICAgICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS50b3AgPSAiLSIuY29uY2F0KHRvb2x0aXBPZmZzZXQuaGVpZ2h0IC0gdGFyZ2V0T2Zmc2V0LmhlaWdodCAtIDIwLCAicHgiKTsKICAgICAgICB9CgogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAibGVmdCI6CiAgICAgICAgaWYgKCFoaW50TW9kZSAmJiB0aGlzLl9vcHRpb25zLnNob3dTdGVwTnVtYmVycyA9PT0gdHJ1ZSkgewogICAgICAgICAgdG9vbHRpcExheWVyLnN0eWxlLnRvcCA9ICIxNXB4IjsKICAgICAgICB9CgogICAgICAgIGlmICh0YXJnZXRPZmZzZXQudG9wICsgdG9vbHRpcE9mZnNldC5oZWlnaHQgPiB3aW5kb3dTaXplLmhlaWdodCkgewogICAgICAgICAgLy8gSW4gdGhpcyBjYXNlLCBsZWZ0IHdvdWxkIGhhdmUgZmFsbGVuIGJlbG93IHRoZSBib3R0b20gb2YgdGhlIHNjcmVlbi4KICAgICAgICAgIC8vIE1vZGlmeSBzbyB0aGF0IHRoZSBib3R0b20gb2YgdGhlIHRvb2x0aXAgY29ubmVjdHMgd2l0aCB0aGUgdGFyZ2V0CiAgICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUudG9wID0gIi0iLmNvbmNhdCh0b29sdGlwT2Zmc2V0LmhlaWdodCAtIHRhcmdldE9mZnNldC5oZWlnaHQgLSAyMCwgInB4Iik7CiAgICAgICAgICBhcnJvd0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWFycm93IHJpZ2h0LWJvdHRvbSI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFycm93TGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtYXJyb3cgcmlnaHQiOwogICAgICAgIH0KCiAgICAgICAgdG9vbHRpcExheWVyLnN0eWxlLnJpZ2h0ID0gIiIuY29uY2F0KHRhcmdldE9mZnNldC53aWR0aCArIDIwLCAicHgiKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgImZsb2F0aW5nIjoKICAgICAgICBhcnJvd0xheWVyLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7IC8vd2UgaGF2ZSB0byBhZGp1c3QgdGhlIHRvcCBhbmQgbGVmdCBvZiBsYXllciBtYW51YWxseSBmb3IgaW50cm8gaXRlbXMgd2l0aG91dCBlbGVtZW50CgogICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS5sZWZ0ID0gIjUwJSI7CiAgICAgICAgdG9vbHRpcExheWVyLnN0eWxlLnRvcCA9ICI1MCUiOwogICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS5tYXJnaW5MZWZ0ID0gIi0iLmNvbmNhdCh0b29sdGlwT2Zmc2V0LndpZHRoIC8gMiwgInB4Iik7CiAgICAgICAgdG9vbHRpcExheWVyLnN0eWxlLm1hcmdpblRvcCA9ICItIi5jb25jYXQodG9vbHRpcE9mZnNldC5oZWlnaHQgLyAyLCAicHgiKTsKCiAgICAgICAgaWYgKHR5cGVvZiBoZWxwZXJOdW1iZXJMYXllciAhPT0gInVuZGVmaW5lZCIgJiYgaGVscGVyTnVtYmVyTGF5ZXIgIT09IG51bGwpIHsKICAgICAgICAgIGhlbHBlck51bWJlckxheWVyLnN0eWxlLmxlZnQgPSAiLSIuY29uY2F0KHRvb2x0aXBPZmZzZXQud2lkdGggLyAyICsgMTgsICJweCIpOwogICAgICAgICAgaGVscGVyTnVtYmVyTGF5ZXIuc3R5bGUudG9wID0gIi0iLmNvbmNhdCh0b29sdGlwT2Zmc2V0LmhlaWdodCAvIDIgKyAxOCwgInB4Iik7CiAgICAgICAgfQoKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgImJvdHRvbS1yaWdodC1hbGlnbmVkIjoKICAgICAgICBhcnJvd0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWFycm93IHRvcC1yaWdodCI7CiAgICAgICAgdG9vbHRpcExheWVyU3R5bGVSaWdodCA9IDA7CiAgICAgICAgY2hlY2tMZWZ0KHRhcmdldE9mZnNldCwgdG9vbHRpcExheWVyU3R5bGVSaWdodCwgdG9vbHRpcE9mZnNldCwgdG9vbHRpcExheWVyKTsKICAgICAgICB0b29sdGlwTGF5ZXIuc3R5bGUudG9wID0gIiIuY29uY2F0KHRhcmdldE9mZnNldC5oZWlnaHQgKyAyMCwgInB4Iik7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICJib3R0b20tbWlkZGxlLWFsaWduZWQiOgogICAgICAgIGFycm93TGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtYXJyb3cgdG9wLW1pZGRsZSI7CiAgICAgICAgdG9vbHRpcExheWVyU3R5bGVMZWZ0UmlnaHQgPSB0YXJnZXRPZmZzZXQud2lkdGggLyAyIC0gdG9vbHRpcE9mZnNldC53aWR0aCAvIDI7IC8vIGEgZml4IGZvciBtaWRkbGUgYWxpZ25lZCBoaW50cwoKICAgICAgICBpZiAoaGludE1vZGUpIHsKICAgICAgICAgIHRvb2x0aXBMYXllclN0eWxlTGVmdFJpZ2h0ICs9IDU7CiAgICAgICAgfQoKICAgICAgICBpZiAoY2hlY2tMZWZ0KHRhcmdldE9mZnNldCwgdG9vbHRpcExheWVyU3R5bGVMZWZ0UmlnaHQsIHRvb2x0aXBPZmZzZXQsIHRvb2x0aXBMYXllcikpIHsKICAgICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS5yaWdodCA9IG51bGw7CiAgICAgICAgICBjaGVja1JpZ2h0KHRhcmdldE9mZnNldCwgdG9vbHRpcExheWVyU3R5bGVMZWZ0UmlnaHQsIHRvb2x0aXBPZmZzZXQsIHdpbmRvd1NpemUsIHRvb2x0aXBMYXllcik7CiAgICAgICAgfQoKICAgICAgICB2YXIgZ2V0X2xlZnRfb2Zmc2V0ID0gTWF0aC5tYXgoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoKTsKICAgICAgICB2YXIgZ2V0X3RvcF9vZmZzZXQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0OyAvLyB0b29sdGlwTGF5ZXIuc3R5bGUudG9wID0gIiIuY29uY2F0KHRhcmdldE9mZnNldC5oZWlnaHQgKyAyMCwgInB4Iik7CgogICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS50b3AgPSAiIi5jb25jYXQoZ2V0X3RvcF9vZmZzZXQgLyAyLjMsICJweCIpOwogICAgICAgIHRvb2x0aXBMYXllci5zdHlsZS5sZWZ0ID0gIiIuY29uY2F0KGdldF9sZWZ0X29mZnNldCAvIDIuNSwgInB4Iik7CiAgICAgICAgYnJlYWs7CiAgICAgIC8vIGNhc2UgJ2JvdHRvbS1sZWZ0LWFsaWduZWQnOgogICAgICAvLyBCb3R0b20tbGVmdC1hbGlnbmVkIGlzIHRoZSBzYW1lIGFzIHRoZSBkZWZhdWx0IGJvdHRvbQogICAgICAvLyBjYXNlICdib3R0b20nOgogICAgICAvLyBCb3R0b20gZ29pbmcgdG8gZm9sbG93IHRoZSBkZWZhdWx0IGJlaGF2aW9yCgogICAgICBkZWZhdWx0OgogICAgICAgIGFycm93TGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtYXJyb3cgdG9wIjsKICAgICAgICB0b29sdGlwTGF5ZXJTdHlsZUxlZnQgPSAwOwogICAgICAgIGNoZWNrUmlnaHQodGFyZ2V0T2Zmc2V0LCB0b29sdGlwTGF5ZXJTdHlsZUxlZnQsIHRvb2x0aXBPZmZzZXQsIHdpbmRvd1NpemUsIHRvb2x0aXBMYXllcik7CiAgICAgICAgdG9vbHRpcExheWVyLnN0eWxlLnRvcCA9ICIiLmNvbmNhdCh0YXJnZXRPZmZzZXQuaGVpZ2h0ICsgMjAsICJweCIpOwogICAgfQogIH0KICAvKioKICAgKiBUbyByZW1vdmUgYWxsIHNob3cgZWxlbWVudChzKQogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfcmVtb3ZlU2hvd0VsZW1lbnQKICAgKi8KCgogIGZ1bmN0aW9uIHJlbW92ZVNob3dFbGVtZW50KCkgewogICAgdmFyIGVsbXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCIuaW50cm9qcy1zaG93RWxlbWVudCIpOwogICAgZm9yRWFjaChlbG1zLCBmdW5jdGlvbiAoZWxtKSB7CiAgICAgIHJlbW92ZUNsYXNzKGVsbSwgL2ludHJvanMtW2EtekEtWl0rL2cpOwogICAgfSk7CiAgfQogIC8qKgogICAqIEdldHMgdGhlIGN1cnJlbnQgcHJvZ3Jlc3MgcGVyY2VudGFnZQogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfZ2V0UHJvZ3Jlc3MKICAgKiBAcmV0dXJucyBjdXJyZW50IHByb2dyZXNzIHBlcmNlbnRhZ2UKICAgKi8KCgogIGZ1bmN0aW9uIF9nZXRQcm9ncmVzcygpIHsKICAgIC8vIFN0ZXBzIGFyZSAwIGluZGV4ZWQKICAgIHZhciBjdXJyZW50U3RlcCA9IHBhcnNlSW50KHRoaXMuX2N1cnJlbnRTdGVwICsgMSwgMTApOwogICAgcmV0dXJuIGN1cnJlbnRTdGVwIC8gdGhpcy5faW50cm9JdGVtcy5sZW5ndGggKiAxMDA7CiAgfQogIC8qKgogICAqIEFkZCBkaXNhYmxlaW50ZXJhY3Rpb24gbGF5ZXIgYW5kIGFkanVzdCB0aGUgc2l6ZSBhbmQgcG9zaXRpb24gb2YgdGhlIGxheWVyCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9kaXNhYmxlSW50ZXJhY3Rpb24KICAgKi8KCgogIGZ1bmN0aW9uIF9kaXNhYmxlSW50ZXJhY3Rpb24oKSB7CiAgICB2YXIgZGlzYWJsZUludGVyYWN0aW9uTGF5ZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy1kaXNhYmxlSW50ZXJhY3Rpb24iKTsKCiAgICBpZiAoZGlzYWJsZUludGVyYWN0aW9uTGF5ZXIgPT09IG51bGwpIHsKICAgICAgZGlzYWJsZUludGVyYWN0aW9uTGF5ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZGlzYWJsZUludGVyYWN0aW9uTGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtZGlzYWJsZUludGVyYWN0aW9uIjsKCiAgICAgIHRoaXMuX3RhcmdldEVsZW1lbnQuYXBwZW5kQ2hpbGQoZGlzYWJsZUludGVyYWN0aW9uTGF5ZXIpOwogICAgfQoKICAgIHNldEhlbHBlckxheWVyUG9zaXRpb24uY2FsbCh0aGlzLCBkaXNhYmxlSW50ZXJhY3Rpb25MYXllcik7CiAgfQogIC8qKgogICAqIFNob3cgYW4gZWxlbWVudCBvbiB0aGUgcGFnZQogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfc2hvd0VsZW1lbnQKICAgKiBAcGFyYW0ge09iamVjdH0gdGFyZ2V0RWxlbWVudAogICAqLwoKCiAgZnVuY3Rpb24gX3Nob3dFbGVtZW50KHRhcmdldEVsZW1lbnQpIHsKICAgIGlmICh0eXBlb2YgdGhpcy5faW50cm9DaGFuZ2VDYWxsYmFjayAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhpcy5faW50cm9DaGFuZ2VDYWxsYmFjay5jYWxsKHRoaXMsIHRhcmdldEVsZW1lbnQuZWxlbWVudCk7CiAgICB9CgogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIG9sZEhlbHBlckxheWVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtaGVscGVyTGF5ZXIiKTsKICAgIHZhciBvbGRSZWZlcmVuY2VMYXllciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLXRvb2x0aXBSZWZlcmVuY2VMYXllciIpOwogICAgdmFyIGhpZ2hsaWdodENsYXNzID0gImludHJvanMtaGVscGVyTGF5ZXIiOwogICAgdmFyIG5leHRUb29sdGlwQnV0dG9uOwogICAgdmFyIHByZXZUb29sdGlwQnV0dG9uOwogICAgdmFyIHNraXBUb29sdGlwQnV0dG9uOwogICAgdmFyIHNjcm9sbFBhcmVudDsgLy9jaGVjayBmb3IgYSBjdXJyZW50IHN0ZXAgaGlnaGxpZ2h0IGNsYXNzCgogICAgaWYgKHR5cGVvZiB0YXJnZXRFbGVtZW50LmhpZ2hsaWdodENsYXNzID09PSAic3RyaW5nIikgewogICAgICBoaWdobGlnaHRDbGFzcyArPSAiICIuY29uY2F0KHRhcmdldEVsZW1lbnQuaGlnaGxpZ2h0Q2xhc3MpOwogICAgfSAvL2NoZWNrIGZvciBvcHRpb25zIGhpZ2hsaWdodCBjbGFzcwoKCiAgICBpZiAodHlwZW9mIHRoaXMuX29wdGlvbnMuaGlnaGxpZ2h0Q2xhc3MgPT09ICJzdHJpbmciKSB7CiAgICAgIGhpZ2hsaWdodENsYXNzICs9ICIgIi5jb25jYXQodGhpcy5fb3B0aW9ucy5oaWdobGlnaHRDbGFzcyk7CiAgICB9CgogICAgaWYgKG9sZEhlbHBlckxheWVyICE9PSBudWxsKSB7CiAgICAgIHZhciBvbGRIZWxwZXJOdW1iZXJMYXllciA9IG9sZFJlZmVyZW5jZUxheWVyLnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWhlbHBlck51bWJlckxheWVyIik7CiAgICAgIHZhciBvbGR0b29sdGlwTGF5ZXIgPSBvbGRSZWZlcmVuY2VMYXllci5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy10b29sdGlwdGV4dCIpOwogICAgICB2YXIgb2xkQXJyb3dMYXllciA9IG9sZFJlZmVyZW5jZUxheWVyLnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWFycm93Iik7CiAgICAgIHZhciBvbGR0b29sdGlwQ29udGFpbmVyID0gb2xkUmVmZXJlbmNlTGF5ZXIucXVlcnlTZWxlY3RvcigiLmludHJvanMtdG9vbHRpcCIpOwogICAgICBza2lwVG9vbHRpcEJ1dHRvbiA9IG9sZFJlZmVyZW5jZUxheWVyLnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLXNraXBidXR0b24iKTsKICAgICAgcHJldlRvb2x0aXBCdXR0b24gPSBvbGRSZWZlcmVuY2VMYXllci5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy1wcmV2YnV0dG9uIik7CiAgICAgIG5leHRUb29sdGlwQnV0dG9uID0gb2xkUmVmZXJlbmNlTGF5ZXIucXVlcnlTZWxlY3RvcigiLmludHJvanMtbmV4dGJ1dHRvbiIpOyAvL3VwZGF0ZSBvciByZXNldCB0aGUgaGVscGVyIGhpZ2hsaWdodCBjbGFzcwoKICAgICAgb2xkSGVscGVyTGF5ZXIuY2xhc3NOYW1lID0gaGlnaGxpZ2h0Q2xhc3M7IC8vaGlkZSB0aGUgdG9vbHRpcAoKICAgICAgaWYgKGRvY3VtZW50LmNvbnRhaW5zKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJsYWJlbF9kaXNwbGF5X2RpdiIpKSkgewogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJsYWJlbF9kaXNwbGF5X2RpdiIpLnJlbW92ZSgpOwogICAgICB9CgogICAgICBpZiAodGFyZ2V0RWxlbWVudC5sYWJlbERpc3BsYXkgIT09ICJXRUxDT01FIikgewogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjdXN0b20tYXJyb3ctaW1hZ2UtY2Vuc2UiKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY3VzdG9tLWFycm93LWltYWdlLWNlbnNlIikuc3R5bGUub3BhY2l0eSA9IDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImN1c3RvbS1hcnJvdy1pbWFnZS1jZW5zZSIpLnN0eWxlLm9wYWNpdHkgPSAwOwogICAgICB9CgogICAgICB2YXIgbGFiZWxfZGlzcGxheV9kaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgbGFiZWxfZGlzcGxheV9kaXYuaWQgPSAibGFiZWxfZGlzcGxheV9kaXYiOwogICAgICBsYWJlbF9kaXNwbGF5X2Rpdi5zdHlsZS5jb2xvciA9ICIjRkZGRkZGIjsKICAgICAgbGFiZWxfZGlzcGxheV9kaXYuc3R5bGUudGV4dEFsaWduID0gImNlbnRlciI7CiAgICAgIGxhYmVsX2Rpc3BsYXlfZGl2LnN0eWxlLm1hcmdpblRvcCA9ICIwLjVyZW0iOwogICAgICBsYWJlbF9kaXNwbGF5X2Rpdi5pbm5lckhUTUwgPSB0YXJnZXRFbGVtZW50LmxhYmVsRGlzcGxheTsKICAgICAgb2xkSGVscGVyTGF5ZXIuYXBwZW5kQ2hpbGQobGFiZWxfZGlzcGxheV9kaXYpOyAvLyBvbGRIZWxwZXJMYXllci5pbm5lckhUTUwgPSB0YXJnZXRFbGVtZW50LmxhYmVsRGlzcGxheTsKCiAgICAgIG9sZHRvb2x0aXBDb250YWluZXIuc3R5bGUub3BhY2l0eSA9IDA7CiAgICAgIG9sZHRvb2x0aXBDb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCiAgICAgIGlmIChvbGRIZWxwZXJOdW1iZXJMYXllciAhPT0gbnVsbCkgewogICAgICAgIHZhciBsYXN0SW50cm9JdGVtID0gdGhpcy5faW50cm9JdGVtc1t0YXJnZXRFbGVtZW50LnN0ZXAgLSAyID49IDAgPyB0YXJnZXRFbGVtZW50LnN0ZXAgLSAyIDogMF07CgogICAgICAgIGlmIChsYXN0SW50cm9JdGVtICE9PSBudWxsICYmIHRoaXMuX2RpcmVjdGlvbiA9PT0gImZvcndhcmQiICYmIGxhc3RJbnRyb0l0ZW0ucG9zaXRpb24gPT09ICJmbG9hdGluZyIgfHwgdGhpcy5fZGlyZWN0aW9uID09PSAiYmFja3dhcmQiICYmIHRhcmdldEVsZW1lbnQucG9zaXRpb24gPT09ICJmbG9hdGluZyIpIHsKICAgICAgICAgIG9sZEhlbHBlck51bWJlckxheWVyLnN0eWxlLm9wYWNpdHkgPSAwOwogICAgICAgIH0KICAgICAgfSAvLyBzY3JvbGwgdG8gZWxlbWVudAoKCiAgICAgIHNjcm9sbFBhcmVudCA9IGdldFNjcm9sbFBhcmVudCh0YXJnZXRFbGVtZW50LmVsZW1lbnQpOwoKICAgICAgaWYgKHNjcm9sbFBhcmVudCAhPT0gZG9jdW1lbnQuYm9keSkgewogICAgICAgIC8vIHRhcmdldCBpcyB3aXRoaW4gYSBzY3JvbGxhYmxlIGVsZW1lbnQKICAgICAgICBzY3JvbGxQYXJlbnRUb0VsZW1lbnQoc2Nyb2xsUGFyZW50LCB0YXJnZXRFbGVtZW50LmVsZW1lbnQpOwogICAgICB9IC8vIHNldCBuZXcgcG9zaXRpb24gdG8gaGVscGVyIGxheWVyCgoKICAgICAgc2V0SGVscGVyTGF5ZXJQb3NpdGlvbi5jYWxsKHNlbGYsIG9sZEhlbHBlckxheWVyKTsKICAgICAgc2V0SGVscGVyTGF5ZXJQb3NpdGlvbi5jYWxsKHNlbGYsIG9sZFJlZmVyZW5jZUxheWVyKTsgLy9yZW1vdmUgYGludHJvanMtZml4UGFyZW50YCBjbGFzcyBmcm9tIHRoZSBlbGVtZW50cwoKICAgICAgdmFyIGZpeFBhcmVudHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCIuaW50cm9qcy1maXhQYXJlbnQiKTsKICAgICAgZm9yRWFjaChmaXhQYXJlbnRzLCBmdW5jdGlvbiAocGFyZW50KSB7CiAgICAgICAgcmVtb3ZlQ2xhc3MocGFyZW50LCAvaW50cm9qcy1maXhQYXJlbnQvZyk7CiAgICAgIH0pOyAvL3JlbW92ZSBvbGQgY2xhc3NlcyBpZiB0aGUgZWxlbWVudCBzdGlsbCBleGlzdAoKICAgICAgcmVtb3ZlU2hvd0VsZW1lbnQoKTsgLy93ZSBzaG91bGQgd2FpdCB1bnRpbCB0aGUgQ1NTMyB0cmFuc2l0aW9uIGlzIGNvbXBldGVkIChpdCdzIDAuMyBzZWMpIHRvIHByZXZlbnQgaW5jb3JyZWN0IGBoZWlnaHRgIGFuZCBgd2lkdGhgIGNhbGN1bGF0aW9uCgogICAgICBpZiAoc2VsZi5fbGFzdFNob3dFbGVtZW50VGltZXIpIHsKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHNlbGYuX2xhc3RTaG93RWxlbWVudFRpbWVyKTsKICAgICAgfQoKICAgICAgc2VsZi5fbGFzdFNob3dFbGVtZW50VGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy9zZXQgY3VycmVudCBzdGVwIHRvIHRoZSBsYWJlbAogICAgICAgIGlmIChvbGRIZWxwZXJOdW1iZXJMYXllciAhPT0gbnVsbCkgewogICAgICAgICAgb2xkSGVscGVyTnVtYmVyTGF5ZXIuaW5uZXJIVE1MID0gdGFyZ2V0RWxlbWVudC5zdGVwOwogICAgICAgIH0gLy9zZXQgY3VycmVudCB0b29sdGlwIHRleHQKCgogICAgICAgIHZhciB0b29sdGlwSGVhZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaDUiKTsKICAgICAgICB0b29sdGlwSGVhZGVyLnN0eWxlLmNvbG9yID0gIiMyODM4NzciOwogICAgICAgIHRvb2x0aXBIZWFkZXIuc3R5bGUuZm9udEZhbWlseSA9ICJydWJpayI7CiAgICAgICAgdG9vbHRpcEhlYWRlci5pbm5lckhUTUwgPSB0YXJnZXRFbGVtZW50LmxhYmVsRGlzcGxheTsKICAgICAgICB2YXIgdG9vbHRpcEJvZHkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICB0b29sdGlwQm9keS5pbm5lckhUTUwgPSB0YXJnZXRFbGVtZW50LmludHJvOwogICAgICAgIG9sZHRvb2x0aXBMYXllci5pbm5lckhUTUwgPSAiIjsKICAgICAgICBvbGR0b29sdGlwTGF5ZXIuc3R5bGUubWF4V2lkdGggPSAiIjsKICAgICAgICBvbGR0b29sdGlwTGF5ZXIuc3R5bGUubWluV2lkdGggPSAiNDYwcHgiOyAvLyB0b29sdGlwVGV4dExheWVyLnN0eWxlLm1heFdpZHRoID0gIjMwMHB4IjsKICAgICAgICAvLyBvbGR0b29sdGlwTGF5ZXIuaW5uZXJIVE1MID0gdGFyZ2V0RWxlbWVudC5pbnRybzsgLy9zZXQgdGhlIHRvb2x0aXAgcG9zaXRpb24KCiAgICAgICAgb2xkdG9vbHRpcExheWVyLmFwcGVuZENoaWxkKHRvb2x0aXBIZWFkZXIpOwogICAgICAgIG9sZHRvb2x0aXBMYXllci5hcHBlbmRDaGlsZCh0b29sdGlwQm9keSk7CiAgICAgICAgb2xkdG9vbHRpcExheWVyLnN0eWxlLm1hcmdpbkJvdHRvbSA9ICItMS41MnJlbSI7CiAgICAgICAgb2xkdG9vbHRpcENvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICBvbGR0b29sdGlwTGF5ZXIuc3R5bGUucGFkZGluZ0xlZnQgPSAiMXJlbSI7IC8vIG9sZHRvb2x0aXBDb250YWluZXIuc3R5bGUuY3NzVGV4dCA9ICJtYXgtd2lkdGg6IDcwMHB4ICFpbXBvcnRhbnQiOyAKCiAgICAgICAgcGxhY2VUb29sdGlwLmNhbGwoc2VsZiwgdGFyZ2V0RWxlbWVudC5lbGVtZW50LCBvbGR0b29sdGlwQ29udGFpbmVyLCBvbGRBcnJvd0xheWVyLCBvbGRIZWxwZXJOdW1iZXJMYXllcik7IC8vY2hhbmdlIGFjdGl2ZSBidWxsZXQKCiAgICAgICAgaWYgKHNlbGYuX29wdGlvbnMuc2hvd0J1bGxldHMpIHsKICAgICAgICAgIG9sZFJlZmVyZW5jZUxheWVyLnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWJ1bGxldHMgbGkgPiBhLmFjdGl2ZSIpLmNsYXNzTmFtZSA9ICIiOwogICAgICAgICAgb2xkUmVmZXJlbmNlTGF5ZXIucXVlcnlTZWxlY3RvcigiLmludHJvanMtYnVsbGV0cyBsaSA+IGFbZGF0YS1zdGVwbnVtYmVyPVwiIi5jb25jYXQodGFyZ2V0RWxlbWVudC5zdGVwLCAiXCJdIikpLmNsYXNzTmFtZSA9ICJhY3RpdmUiOwogICAgICAgIH0gLy8gb2xkUmVmZXJlbmNlTGF5ZXIucXVlcnlTZWxlY3RvcigiLmludHJvanMtcHJvZ3Jlc3MgLmludHJvanMtcHJvZ3Jlc3NiYXIiKS5zdHlsZS5jc3NUZXh0ID0gIndpZHRoOiIuY29uY2F0KF9nZXRQcm9ncmVzcy5jYWxsKHNlbGYpLCAiJTsiKTsKICAgICAgICAvLyBvbGRSZWZlcmVuY2VMYXllci5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy1wcm9ncmVzcyAuaW50cm9qcy1wcm9ncmVzc2JhciIpLnNldEF0dHJpYnV0ZSgiYXJpYS12YWx1ZW5vdyIsIF9nZXRQcm9ncmVzcy5jYWxsKHNlbGYpKTsgLy9zaG93IHRoZSB0b29sdGlwCgoKICAgICAgICBvbGR0b29sdGlwQ29udGFpbmVyLnN0eWxlLm9wYWNpdHkgPSAxOwogICAgICAgIGlmIChvbGRIZWxwZXJOdW1iZXJMYXllcikgb2xkSGVscGVyTnVtYmVyTGF5ZXIuc3R5bGUub3BhY2l0eSA9IDE7IC8vcmVzZXQgYnV0dG9uIGZvY3VzCgogICAgICAgIGlmICh0eXBlb2Ygc2tpcFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIHNraXBUb29sdGlwQnV0dG9uICE9PSBudWxsICYmIC9pbnRyb2pzLWRvbmVidXR0b24vZ2kudGVzdChza2lwVG9vbHRpcEJ1dHRvbi5jbGFzc05hbWUpKSB7CiAgICAgICAgICAvLyBza2lwIGJ1dHRvbiBpcyBub3cgImRvbmUiIGJ1dHRvbgogICAgICAgICAgc2tpcFRvb2x0aXBCdXR0b24uZm9jdXMoKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0VG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgbmV4dFRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgICAgIC8vc3RpbGwgaW4gdGhlIHRvdXIsIGZvY3VzIG9uIG5leHQKICAgICAgICAgIG5leHRUb29sdGlwQnV0dG9uLmZvY3VzKCk7CiAgICAgICAgfSAvLyBjaGFuZ2UgdGhlIHNjcm9sbCBvZiB0aGUgd2luZG93LCBpZiBuZWVkZWQKCgogICAgICAgIHNjcm9sbFRvLmNhbGwoc2VsZiwgdGFyZ2V0RWxlbWVudC5zY3JvbGxUbywgdGFyZ2V0RWxlbWVudCwgb2xkdG9vbHRpcExheWVyKTsKICAgICAgfSwgMzUwKTsgLy8gZW5kIG9mIG9sZCBlbGVtZW50IGlmLWVsc2UgY29uZGl0aW9uCiAgICB9IGVsc2UgewogICAgICB2YXIgaGVscGVyTGF5ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgdmFyIHJlZmVyZW5jZUxheWVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHZhciBhcnJvd0xheWVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHZhciB0b29sdGlwTGF5ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgdmFyIHRvb2x0aXBUZXh0TGF5ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgdmFyIGJ1bGxldHNMYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICB2YXIgcHJvZ3Jlc3NMYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICB2YXIgYnV0dG9uc0xheWVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHZhciBpbWFnZUxheWVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7CiAgICAgIGltYWdlTGF5ZXIuc3JjID0gIi9pbWcvR3JvdXAzLnN2ZyI7CiAgICAgIGltYWdlTGF5ZXIuaWQgPSAiY3VzdG9tLWFycm93LWltYWdlLWNlbnNlIjsKICAgICAgaW1hZ2VMYXllci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICBoZWxwZXJMYXllci5jbGFzc05hbWUgPSBoaWdobGlnaHRDbGFzczsKICAgICAgcmVmZXJlbmNlTGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtdG9vbHRpcFJlZmVyZW5jZUxheWVyIjsgLy8gc2Nyb2xsIHRvIGVsZW1lbnQKCiAgICAgIHNjcm9sbFBhcmVudCA9IGdldFNjcm9sbFBhcmVudCh0YXJnZXRFbGVtZW50LmVsZW1lbnQpOwoKICAgICAgaWYgKHNjcm9sbFBhcmVudCAhPT0gZG9jdW1lbnQuYm9keSkgewogICAgICAgIC8vIHRhcmdldCBpcyB3aXRoaW4gYSBzY3JvbGxhYmxlIGVsZW1lbnQKICAgICAgICBzY3JvbGxQYXJlbnRUb0VsZW1lbnQoc2Nyb2xsUGFyZW50LCB0YXJnZXRFbGVtZW50LmVsZW1lbnQpOwogICAgICB9IC8vc2V0IG5ldyBwb3NpdGlvbiB0byBoZWxwZXIgbGF5ZXIKCgogICAgICBzZXRIZWxwZXJMYXllclBvc2l0aW9uLmNhbGwoc2VsZiwgaGVscGVyTGF5ZXIpOwogICAgICBzZXRIZWxwZXJMYXllclBvc2l0aW9uLmNhbGwoc2VsZiwgcmVmZXJlbmNlTGF5ZXIpOyAvL2FkZCBoZWxwZXIgbGF5ZXIgdG8gdGFyZ2V0IGVsZW1lbnQKCiAgICAgIHRoaXMuX3RhcmdldEVsZW1lbnQuYXBwZW5kQ2hpbGQoaGVscGVyTGF5ZXIpOyAvLyB0aGlzLl90YXJnZXRFbGVtZW50LmFwcGVuZENoaWxkKGltYWdlTGF5ZXIpOwoKCiAgICAgIHRoaXMuX3RhcmdldEVsZW1lbnQuYXBwZW5kQ2hpbGQocmVmZXJlbmNlTGF5ZXIpOwoKICAgICAgYXJyb3dMYXllci5jbGFzc05hbWUgPSAiaW50cm9qcy1hcnJvdyI7CiAgICAgIHRvb2x0aXBUZXh0TGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtdG9vbHRpcHRleHQiOwogICAgICB2YXIgdG9vbHRpcEhlYWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImg1Iik7CiAgICAgIHRvb2x0aXBIZWFkZXIuc3R5bGUuY29sb3IgPSAiIzI4Mzg3NyI7CiAgICAgIHRvb2x0aXBIZWFkZXIuaW5uZXJIVE1MID0gIldFTENPTUUiOwogICAgICB2YXIgdG9vbHRpcEJvZHkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgdG9vbHRpcEJvZHkuaW5uZXJIVE1MID0gdGFyZ2V0RWxlbWVudC5pbnRybzsKICAgICAgdG9vbHRpcFRleHRMYXllci5pbm5lckhUTUwgPSAiIjsKICAgICAgdG9vbHRpcFRleHRMYXllci5zdHlsZS5taW5XaWR0aCA9ICI1MDBweCI7CiAgICAgIHRvb2x0aXBUZXh0TGF5ZXIuc3R5bGUubWF4V2lkdGggPSAiMzAwcHgiOwogICAgICB0b29sdGlwVGV4dExheWVyLmFwcGVuZENoaWxkKHRvb2x0aXBIZWFkZXIpOwogICAgICB0b29sdGlwVGV4dExheWVyLmFwcGVuZENoaWxkKHRvb2x0aXBCb2R5KTsKICAgICAgdG9vbHRpcFRleHRMYXllci5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiMCI7IC8vIHRvb2x0aXBUZXh0TGF5ZXIuaW5uZXJIVE1MID0gdGFyZ2V0RWxlbWVudC5pbnRybzsKICAgICAgLy8gdmFyIGxhYmVsX2Rpc3BsYXlfZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIC8vIGxhYmVsX2Rpc3BsYXlfZGl2LmlkID0gImxhYmVsX2Rpc3BsYXlfZGl2IjsKICAgICAgLy8gbGFiZWxfZGlzcGxheV9kaXYuc3R5bGUuY29sb3IgPSAiI0ZGRkZGRiI7CiAgICAgIC8vIGxhYmVsX2Rpc3BsYXlfZGl2LnN0eWxlLnRleHRBbGlnbiA9ICJjZW50ZXIiOwogICAgICAvLyBsYWJlbF9kaXNwbGF5X2Rpdi5zdHlsZS5tYXJnaW5Ub3AgPSAiMC41cmVtIjsKICAgICAgLy8gbGFiZWxfZGlzcGxheV9kaXYuaW5uZXJIVE1MID0gdGFyZ2V0RWxlbWVudC5sYWJlbERpc3BsYXk7CiAgICAgIC8vIGhlbHBlckxheWVyLmFwcGVuZENoaWxkKGxhYmVsX2Rpc3BsYXlfZGl2KTsKICAgICAgLy8gaGVscGVyTGF5ZXIuaW5uZXJIVE1MID0gdGFyZ2V0RWxlbWVudC5sYWJlbERpc3BsYXk7CgogICAgICBidWxsZXRzTGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtYnVsbGV0cyI7CgogICAgICBpZiAodGhpcy5fb3B0aW9ucy5zaG93QnVsbGV0cyA9PT0gZmFsc2UpIHsKICAgICAgICBidWxsZXRzTGF5ZXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgfQoKICAgICAgdmFyIHVsQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidWwiKTsKICAgICAgdWxDb250YWluZXIuc2V0QXR0cmlidXRlKCJyb2xlIiwgInRhYmxpc3QiKTsKCiAgICAgIHZhciBhbmNob3JDbGljayA9IGZ1bmN0aW9uIGFuY2hvckNsaWNrKCkgewogICAgICAgIHNlbGYuZ29Ub1N0ZXAodGhpcy5nZXRBdHRyaWJ1dGUoImRhdGEtc3RlcG51bWJlciIpKTsKICAgICAgfTsKCiAgICAgIGZvckVhY2godGhpcy5faW50cm9JdGVtcywgZnVuY3Rpb24gKF9yZWYsIGkpIHsKICAgICAgICB2YXIgc3RlcCA9IF9yZWYuc3RlcDsKICAgICAgICB2YXIgaW5uZXJMaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CiAgICAgICAgdmFyIGFuY2hvckxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgICAgaW5uZXJMaS5zZXRBdHRyaWJ1dGUoInJvbGUiLCAicHJlc2VudGF0aW9uIik7CiAgICAgICAgYW5jaG9yTGluay5zZXRBdHRyaWJ1dGUoInJvbGUiLCAidGFiIik7CiAgICAgICAgYW5jaG9yTGluay5vbmNsaWNrID0gYW5jaG9yQ2xpY2s7CgogICAgICAgIGlmIChpID09PSB0YXJnZXRFbGVtZW50LnN0ZXAgLSAxKSB7CiAgICAgICAgICBhbmNob3JMaW5rLmNsYXNzTmFtZSA9ICJhY3RpdmUiOwogICAgICAgIH0KCiAgICAgICAgc2V0QW5jaG9yQXNCdXR0b24oYW5jaG9yTGluayk7CiAgICAgICAgYW5jaG9yTGluay5pbm5lckhUTUwgPSAiJm5ic3A7IjsKICAgICAgICBhbmNob3JMaW5rLnNldEF0dHJpYnV0ZSgiZGF0YS1zdGVwbnVtYmVyIiwgc3RlcCk7CiAgICAgICAgaW5uZXJMaS5hcHBlbmRDaGlsZChhbmNob3JMaW5rKTsKICAgICAgICB1bENvbnRhaW5lci5hcHBlbmRDaGlsZChpbm5lckxpKTsKICAgICAgfSk7CiAgICAgIGJ1bGxldHNMYXllci5hcHBlbmRDaGlsZCh1bENvbnRhaW5lcik7CiAgICAgIHByb2dyZXNzTGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtcHJvZ3Jlc3MiOwoKICAgICAgaWYgKHRoaXMuX29wdGlvbnMuc2hvd1Byb2dyZXNzID09PSBmYWxzZSkgewogICAgICAgIHByb2dyZXNzTGF5ZXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgfQoKICAgICAgdmFyIHByb2dyZXNzQmFyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHByb2dyZXNzQmFyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLXByb2dyZXNzYmFyIjsKICAgICAgcHJvZ3Jlc3NCYXIuc2V0QXR0cmlidXRlKCJyb2xlIiwgInByb2dyZXNzIik7CiAgICAgIHByb2dyZXNzQmFyLnNldEF0dHJpYnV0ZSgiYXJpYS12YWx1ZW1pbiIsIDApOwogICAgICBwcm9ncmVzc0Jhci5zZXRBdHRyaWJ1dGUoImFyaWEtdmFsdWVtYXgiLCAxMDApOwogICAgICBwcm9ncmVzc0Jhci5zZXRBdHRyaWJ1dGUoImFyaWEtdmFsdWVub3ciLCBfZ2V0UHJvZ3Jlc3MuY2FsbCh0aGlzKSk7CiAgICAgIHByb2dyZXNzQmFyLnN0eWxlLmNzc1RleHQgPSAid2lkdGg6Ii5jb25jYXQoX2dldFByb2dyZXNzLmNhbGwodGhpcyksICIlOyIpOwogICAgICBwcm9ncmVzc0xheWVyLmFwcGVuZENoaWxkKHByb2dyZXNzQmFyKTsKICAgICAgYnV0dG9uc0xheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLXRvb2x0aXBidXR0b25zIjsKCiAgICAgIGlmICh0aGlzLl9vcHRpb25zLnNob3dCdXR0b25zID09PSBmYWxzZSkgewogICAgICAgIGJ1dHRvbnNMYXllci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICB9CgogICAgICB0b29sdGlwTGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtdG9vbHRpcCI7IC8vIHRvb2x0aXBMYXllci5zdHlsZS5jc3NUZXh0ID0gIm1heC13aWR0aDogMzAwcHggIWltcG9ydGFudCI7IAoKICAgICAgdG9vbHRpcExheWVyLmFwcGVuZENoaWxkKHRvb2x0aXBUZXh0TGF5ZXIpOwogICAgICB0b29sdGlwTGF5ZXIuYXBwZW5kQ2hpbGQoaW1hZ2VMYXllcik7IC8vIHRvb2x0aXBMYXllci5hcHBlbmRDaGlsZChidWxsZXRzTGF5ZXIpOwogICAgICAvLyB0b29sdGlwTGF5ZXIuYXBwZW5kQ2hpbGQocHJvZ3Jlc3NMYXllcik7IC8vYWRkIGhlbHBlciBsYXllciBudW1iZXIKCiAgICAgIHZhciBoZWxwZXJOdW1iZXJMYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKCiAgICAgIGlmICh0aGlzLl9vcHRpb25zLnNob3dTdGVwTnVtYmVycyA9PT0gdHJ1ZSkgewogICAgICAgIGhlbHBlck51bWJlckxheWVyLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWhlbHBlck51bWJlckxheWVyIjsKICAgICAgICBoZWxwZXJOdW1iZXJMYXllci5pbm5lckhUTUwgPSB0YXJnZXRFbGVtZW50LnN0ZXA7CiAgICAgICAgcmVmZXJlbmNlTGF5ZXIuYXBwZW5kQ2hpbGQoaGVscGVyTnVtYmVyTGF5ZXIpOwogICAgICB9CgogICAgICB0b29sdGlwTGF5ZXIuYXBwZW5kQ2hpbGQoYXJyb3dMYXllcik7CiAgICAgIHJlZmVyZW5jZUxheWVyLmFwcGVuZENoaWxkKHRvb2x0aXBMYXllcik7IC8vbmV4dCBidXR0b24KCiAgICAgIG5leHRUb29sdGlwQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwoKICAgICAgbmV4dFRvb2x0aXBCdXR0b24ub25jbGljayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoc2VsZi5faW50cm9JdGVtcy5sZW5ndGggLSAxICE9PSBzZWxmLl9jdXJyZW50U3RlcCkgewogICAgICAgICAgbmV4dFN0ZXAuY2FsbChzZWxmKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBzZXRBbmNob3JBc0J1dHRvbihuZXh0VG9vbHRpcEJ1dHRvbik7CiAgICAgIG5leHRUb29sdGlwQnV0dG9uLmlubmVySFRNTCA9IHRoaXMuX29wdGlvbnMubmV4dExhYmVsOyAvL3ByZXZpb3VzIGJ1dHRvbgoKICAgICAgcHJldlRvb2x0aXBCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgIHByZXZUb29sdGlwQnV0dG9uLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgogICAgICBwcmV2VG9vbHRpcEJ1dHRvbi5vbmNsaWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChzZWxmLl9jdXJyZW50U3RlcCAhPT0gMCkgewogICAgICAgICAgcHJldmlvdXNTdGVwLmNhbGwoc2VsZik7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgc2V0QW5jaG9yQXNCdXR0b24ocHJldlRvb2x0aXBCdXR0b24pOwogICAgICBwcmV2VG9vbHRpcEJ1dHRvbi5pbm5lckhUTUwgPSB0aGlzLl9vcHRpb25zLnByZXZMYWJlbDsgLy9za2lwIGJ1dHRvbgoKICAgICAgc2tpcFRvb2x0aXBCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgIHNraXBUb29sdGlwQnV0dG9uLmNsYXNzTmFtZSA9ICIiLmNvbmNhdCh0aGlzLl9vcHRpb25zLmJ1dHRvbkNsYXNzLCAiIGludHJvanMtc2tpcGJ1dHRvbiAiKTsKICAgICAgc2V0QW5jaG9yQXNCdXR0b24oc2tpcFRvb2x0aXBCdXR0b24pOwogICAgICBza2lwVG9vbHRpcEJ1dHRvbi5pbm5lckhUTUwgPSB0aGlzLl9vcHRpb25zLnNraXBMYWJlbDsKCiAgICAgIHNraXBUb29sdGlwQnV0dG9uLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHNlbGYuX2ludHJvSXRlbXMubGVuZ3RoIC0gMSA9PT0gc2VsZi5fY3VycmVudFN0ZXAgJiYgdHlwZW9mIHNlbGYuX2ludHJvQ29tcGxldGVDYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgc2VsZi5faW50cm9Db21wbGV0ZUNhbGxiYWNrLmNhbGwoc2VsZik7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHNlbGYuX2ludHJvU2tpcENhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBzZWxmLl9pbnRyb1NraXBDYWxsYmFjay5jYWxsKHNlbGYpOwogICAgICAgIH0KCiAgICAgICAgZXhpdEludHJvLmNhbGwoc2VsZiwgc2VsZi5fdGFyZ2V0RWxlbWVudCk7CiAgICAgIH07CgogICAgICBidXR0b25zTGF5ZXIuYXBwZW5kQ2hpbGQoc2tpcFRvb2x0aXBCdXR0b24pOyAvL2luIG9yZGVyIHRvIHByZXZlbnQgZGlzcGxheWluZyBuZXh0L3ByZXZpb3VzIGJ1dHRvbiBhbHdheXMKCiAgICAgIGlmICh0aGlzLl9pbnRyb0l0ZW1zLmxlbmd0aCA+IDEpIHsKICAgICAgICBidXR0b25zTGF5ZXIuYXBwZW5kQ2hpbGQocHJldlRvb2x0aXBCdXR0b24pOwogICAgICAgIGJ1dHRvbnNMYXllci5hcHBlbmRDaGlsZChuZXh0VG9vbHRpcEJ1dHRvbik7CiAgICAgIH0KCiAgICAgIHRvb2x0aXBMYXllci5hcHBlbmRDaGlsZChidXR0b25zTGF5ZXIpOyAvL3NldCBwcm9wZXIgcG9zaXRpb24KCiAgICAgIHBsYWNlVG9vbHRpcC5jYWxsKHNlbGYsIHRhcmdldEVsZW1lbnQuZWxlbWVudCwgdG9vbHRpcExheWVyLCBhcnJvd0xheWVyLCBoZWxwZXJOdW1iZXJMYXllcik7IC8vIGNoYW5nZSB0aGUgc2Nyb2xsIG9mIHRoZSB3aW5kb3csIGlmIG5lZWRlZAoKICAgICAgc2Nyb2xsVG8uY2FsbCh0aGlzLCB0YXJnZXRFbGVtZW50LnNjcm9sbFRvLCB0YXJnZXRFbGVtZW50LCB0b29sdGlwTGF5ZXIpOyAvL2VuZCBvZiBuZXcgZWxlbWVudCBpZi1lbHNlIGNvbmRpdGlvbgogICAgfSAvLyByZW1vdmluZyBwcmV2aW91cyBkaXNhYmxlIGludGVyYWN0aW9uIGxheWVyCgoKICAgIHZhciBkaXNhYmxlSW50ZXJhY3Rpb25MYXllciA9IHNlbGYuX3RhcmdldEVsZW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtZGlzYWJsZUludGVyYWN0aW9uIik7CgogICAgaWYgKGRpc2FibGVJbnRlcmFjdGlvbkxheWVyKSB7CiAgICAgIGRpc2FibGVJbnRlcmFjdGlvbkxheWVyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZGlzYWJsZUludGVyYWN0aW9uTGF5ZXIpOwogICAgfSAvL2Rpc2FibGUgaW50ZXJhY3Rpb24KCgogICAgaWYgKHRhcmdldEVsZW1lbnQuZGlzYWJsZUludGVyYWN0aW9uKSB7CiAgICAgIF9kaXNhYmxlSW50ZXJhY3Rpb24uY2FsbChzZWxmKTsKICAgIH0gLy8gd2hlbiBpdCdzIHRoZSBmaXJzdCBzdGVwIG9mIHRvdXIKCgogICAgaWYgKHRoaXMuX2N1cnJlbnRTdGVwID09PSAwICYmIHRoaXMuX2ludHJvSXRlbXMubGVuZ3RoID4gMSkgewogICAgICBpZiAodHlwZW9mIHNraXBUb29sdGlwQnV0dG9uICE9PSAidW5kZWZpbmVkIiAmJiBza2lwVG9vbHRpcEJ1dHRvbiAhPT0gbnVsbCkgewogICAgICAgIHNraXBUb29sdGlwQnV0dG9uLmNsYXNzTmFtZSA9ICIiLmNvbmNhdCh0aGlzLl9vcHRpb25zLmJ1dHRvbkNsYXNzLCAiIGludHJvanMtc2tpcGJ1dHRvbiIpOwogICAgICAgIHNraXBUb29sdGlwQnV0dG9uLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgbmV4dFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIG5leHRUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgbmV4dFRvb2x0aXBCdXR0b24uY2xhc3NOYW1lID0gIiIuY29uY2F0KHRoaXMuX29wdGlvbnMuYnV0dG9uQ2xhc3MsICIgaW50cm9qcy1uZXh0YnV0dG9uIik7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9vcHRpb25zLmhpZGVQcmV2ID09PSB0cnVlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBwcmV2VG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgcHJldlRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgICAgIHByZXZUb29sdGlwQnV0dG9uLmNsYXNzTmFtZSA9ICIiLmNvbmNhdCh0aGlzLl9vcHRpb25zLmJ1dHRvbkNsYXNzLCAiIGludHJvanMtcHJldmJ1dHRvbiBpbnRyb2pzLWhpZGRlbiIpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBuZXh0VG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgbmV4dFRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgICAgIGFkZENsYXNzKG5leHRUb29sdGlwQnV0dG9uLCAiaW50cm9qcy1mdWxsYnV0dG9uIik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0eXBlb2YgcHJldlRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIHByZXZUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgICBwcmV2VG9vbHRpcEJ1dHRvbi5jbGFzc05hbWUgPSAiIi5jb25jYXQodGhpcy5fb3B0aW9ucy5idXR0b25DbGFzcywgIiBpbnRyb2pzLXByZXZidXR0b24gaW50cm9qcy1kaXNhYmxlZCIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHR5cGVvZiBza2lwVG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgc2tpcFRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgICBza2lwVG9vbHRpcEJ1dHRvbi5pbm5lckhUTUwgPSB0aGlzLl9vcHRpb25zLnNraXBMYWJlbDsKICAgICAgfQogICAgfSBlbHNlIGlmICh0aGlzLl9pbnRyb0l0ZW1zLmxlbmd0aCAtIDEgPT09IHRoaXMuX2N1cnJlbnRTdGVwIHx8IHRoaXMuX2ludHJvSXRlbXMubGVuZ3RoID09PSAxKSB7CiAgICAgIC8vIGxhc3Qgc3RlcCBvZiB0b3VyCiAgICAgIGlmICh0eXBlb2Ygc2tpcFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIHNraXBUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgc2tpcFRvb2x0aXBCdXR0b24uaW5uZXJIVE1MID0gdGhpcy5fb3B0aW9ucy5kb25lTGFiZWw7IC8vIGFkZGluZyBkb25lYnV0dG9uIGNsYXNzIGluIGFkZGl0aW9uIHRvIHNraXBidXR0b24KCiAgICAgICAgc2tpcFRvb2x0aXBCdXR0b24uc3R5bGUuZGlzcGxheSA9ICJpbmxpbmUtYmxvY2siOwogICAgICAgIGFkZENsYXNzKHNraXBUb29sdGlwQnV0dG9uLCAiaW50cm9qcy1kb25lYnV0dG9uIik7CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgcHJldlRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIHByZXZUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgcHJldlRvb2x0aXBCdXR0b24uY2xhc3NOYW1lID0gIiIuY29uY2F0KHRoaXMuX29wdGlvbnMuYnV0dG9uQ2xhc3MsICIgaW50cm9qcy1wcmV2YnV0dG9uIik7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9vcHRpb25zLmhpZGVOZXh0ID09PSB0cnVlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBuZXh0VG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgbmV4dFRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgICAgIG5leHRUb29sdGlwQnV0dG9uLmNsYXNzTmFtZSA9ICIiLmNvbmNhdCh0aGlzLl9vcHRpb25zLmJ1dHRvbkNsYXNzLCAiIGludHJvanMtbmV4dGJ1dHRvbiBpbnRyb2pzLWhpZGRlbiIpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBwcmV2VG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgcHJldlRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgICAgIGFkZENsYXNzKHByZXZUb29sdGlwQnV0dG9uLCAiaW50cm9qcy1mdWxsYnV0dG9uIik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0eXBlb2YgbmV4dFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIG5leHRUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgICBuZXh0VG9vbHRpcEJ1dHRvbi5jbGFzc05hbWUgPSAiIi5jb25jYXQodGhpcy5fb3B0aW9ucy5idXR0b25DbGFzcywgIiBpbnRyb2pzLW5leHRidXR0b24gaW50cm9qcy1kaXNhYmxlZCIpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gc3RlcHMgYmV0d2VlbiBzdGFydCBhbmQgZW5kCiAgICAgIGlmICh0eXBlb2Ygc2tpcFRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIHNraXBUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgICAgc2tpcFRvb2x0aXBCdXR0b24uc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICBza2lwVG9vbHRpcEJ1dHRvbi5jbGFzc05hbWUgPSAiIi5jb25jYXQodGhpcy5fb3B0aW9ucy5idXR0b25DbGFzcywgIiBpbnRyb2pzLXNraXBidXR0b24iKTsKICAgICAgfQoKICAgICAgaWYgKHR5cGVvZiBwcmV2VG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgcHJldlRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgICBwcmV2VG9vbHRpcEJ1dHRvbi5jbGFzc05hbWUgPSAiIi5jb25jYXQodGhpcy5fb3B0aW9ucy5idXR0b25DbGFzcywgIiBpbnRyb2pzLXByZXZidXR0b24iKTsKICAgICAgfQoKICAgICAgaWYgKHR5cGVvZiBuZXh0VG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgbmV4dFRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgICBuZXh0VG9vbHRpcEJ1dHRvbi5jbGFzc05hbWUgPSAiIi5jb25jYXQodGhpcy5fb3B0aW9ucy5idXR0b25DbGFzcywgIiBpbnRyb2pzLW5leHRidXR0b24iKTsKICAgICAgfQoKICAgICAgaWYgKHR5cGVvZiBza2lwVG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgc2tpcFRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgICBza2lwVG9vbHRpcEJ1dHRvbi5pbm5lckhUTUwgPSB0aGlzLl9vcHRpb25zLnNraXBMYWJlbDsKICAgICAgfQogICAgfQoKICAgIGlmICh0eXBlb2YgcHJldlRvb2x0aXBCdXR0b24gIT09ICJ1bmRlZmluZWQiICYmIHByZXZUb29sdGlwQnV0dG9uICE9PSBudWxsKSB7CiAgICAgIHByZXZUb29sdGlwQnV0dG9uLnNldEF0dHJpYnV0ZSgicm9sZSIsICJidXR0b24iKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIG5leHRUb29sdGlwQnV0dG9uICE9PSAidW5kZWZpbmVkIiAmJiBuZXh0VG9vbHRpcEJ1dHRvbiAhPT0gbnVsbCkgewogICAgICBuZXh0VG9vbHRpcEJ1dHRvbi5zZXRBdHRyaWJ1dGUoInJvbGUiLCAiYnV0dG9uIik7CiAgICB9CgogICAgaWYgKHR5cGVvZiBza2lwVG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgc2tpcFRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgc2tpcFRvb2x0aXBCdXR0b24uc2V0QXR0cmlidXRlKCJyb2xlIiwgImJ1dHRvbiIpOwogICAgfSAvL1NldCBmb2N1cyBvbiAibmV4dCIgYnV0dG9uLCBzbyB0aGF0IGhpdHRpbmcgRW50ZXIgYWx3YXlzIG1vdmVzIHlvdSBvbnRvIHRoZSBuZXh0IHN0ZXAKCgogICAgaWYgKHR5cGVvZiBuZXh0VG9vbHRpcEJ1dHRvbiAhPT0gInVuZGVmaW5lZCIgJiYgbmV4dFRvb2x0aXBCdXR0b24gIT09IG51bGwpIHsKICAgICAgbmV4dFRvb2x0aXBCdXR0b24uZm9jdXMoKTsKICAgIH0KCiAgICBzZXRTaG93RWxlbWVudCh0YXJnZXRFbGVtZW50KTsKCiAgICBpZiAodHlwZW9mIHRoaXMuX2ludHJvQWZ0ZXJDaGFuZ2VDYWxsYmFjayAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhpcy5faW50cm9BZnRlckNoYW5nZUNhbGxiYWNrLmNhbGwodGhpcywgdGFyZ2V0RWxlbWVudC5lbGVtZW50KTsKICAgIH0KICB9CiAgLyoqCiAgICogR28gdG8gc3BlY2lmaWMgc3RlcCBvZiBpbnRyb2R1Y3Rpb24KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX2dvVG9TdGVwCiAgICovCgoKICBmdW5jdGlvbiBnb1RvU3RlcChzdGVwKSB7CiAgICAvL2JlY2F1c2Ugc3RlcHMgc3RhcnRzIHdpdGggemVybwogICAgdGhpcy5fY3VycmVudFN0ZXAgPSBzdGVwIC0gMjsKCiAgICBpZiAodHlwZW9mIHRoaXMuX2ludHJvSXRlbXMgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIG5leHRTdGVwLmNhbGwodGhpcyk7CiAgICB9CiAgfQogIC8qKgogICAqIEdvIHRvIHRoZSBzcGVjaWZpYyBzdGVwIG9mIGludHJvZHVjdGlvbiB3aXRoIHRoZSBleHBsaWNpdCBbZGF0YS1zdGVwXSBudW1iZXIKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX2dvVG9TdGVwTnVtYmVyCiAgICovCgoKICBmdW5jdGlvbiBnb1RvU3RlcE51bWJlcihzdGVwKSB7CiAgICB0aGlzLl9jdXJyZW50U3RlcE51bWJlciA9IHN0ZXA7CgogICAgaWYgKHR5cGVvZiB0aGlzLl9pbnRyb0l0ZW1zICE9PSAidW5kZWZpbmVkIikgewogICAgICBuZXh0U3RlcC5jYWxsKHRoaXMpOwogICAgfQogIH0KICAvKioKICAgKiBHbyB0byBuZXh0IHN0ZXAgb24gaW50cm8KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX25leHRTdGVwCiAgICovCgoKICBmdW5jdGlvbiBuZXh0U3RlcCgpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgdGhpcy5fZGlyZWN0aW9uID0gImZvcndhcmQiOwoKICAgIGlmICh0eXBlb2YgdGhpcy5fY3VycmVudFN0ZXBOdW1iZXIgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGZvckVhY2godGhpcy5faW50cm9JdGVtcywgZnVuY3Rpb24gKF9yZWYsIGkpIHsKICAgICAgICB2YXIgc3RlcCA9IF9yZWYuc3RlcDsKCiAgICAgICAgaWYgKHN0ZXAgPT09IF90aGlzLl9jdXJyZW50U3RlcE51bWJlcikgewogICAgICAgICAgX3RoaXMuX2N1cnJlbnRTdGVwID0gaSAtIDE7CiAgICAgICAgICBfdGhpcy5fY3VycmVudFN0ZXBOdW1iZXIgPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBpZiAodHlwZW9mIHRoaXMuX2N1cnJlbnRTdGVwID09PSAidW5kZWZpbmVkIikgewogICAgICB0aGlzLl9jdXJyZW50U3RlcCA9IDA7CiAgICB9IGVsc2UgewogICAgICArK3RoaXMuX2N1cnJlbnRTdGVwOwogICAgfQoKICAgIHZhciBuZXh0U3RlcCA9IHRoaXMuX2ludHJvSXRlbXNbdGhpcy5fY3VycmVudFN0ZXBdOwogICAgdmFyIGNvbnRpbnVlU3RlcCA9IHRydWU7CgogICAgaWYgKHR5cGVvZiB0aGlzLl9pbnRyb0JlZm9yZUNoYW5nZUNhbGxiYWNrICE9PSAidW5kZWZpbmVkIikgewogICAgICBjb250aW51ZVN0ZXAgPSB0aGlzLl9pbnRyb0JlZm9yZUNoYW5nZUNhbGxiYWNrLmNhbGwodGhpcywgbmV4dFN0ZXAuZWxlbWVudCk7CiAgICB9IC8vIGlmIGBvbmJlZm9yZWNoYW5nZWAgcmV0dXJuZWQgYGZhbHNlYCwgc3RvcCBkaXNwbGF5aW5nIHRoZSBlbGVtZW50CgoKICAgIGlmIChjb250aW51ZVN0ZXAgPT09IGZhbHNlKSB7CiAgICAgIC0tdGhpcy5fY3VycmVudFN0ZXA7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBpZiAodGhpcy5faW50cm9JdGVtcy5sZW5ndGggPD0gdGhpcy5fY3VycmVudFN0ZXApIHsKICAgICAgLy9lbmQgb2YgdGhlIGludHJvCiAgICAgIC8vY2hlY2sgaWYgYW55IGNhbGxiYWNrIGlzIGRlZmluZWQKICAgICAgaWYgKHR5cGVvZiB0aGlzLl9pbnRyb0NvbXBsZXRlQ2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB0aGlzLl9pbnRyb0NvbXBsZXRlQ2FsbGJhY2suY2FsbCh0aGlzKTsKICAgICAgfQoKICAgICAgZXhpdEludHJvLmNhbGwodGhpcywgdGhpcy5fdGFyZ2V0RWxlbWVudCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBfc2hvd0VsZW1lbnQuY2FsbCh0aGlzLCBuZXh0U3RlcCk7CiAgfQogIC8qKgogICAqIEdvIHRvIHByZXZpb3VzIHN0ZXAgb24gaW50cm8KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX3ByZXZpb3VzU3RlcAogICAqLwoKCiAgZnVuY3Rpb24gcHJldmlvdXNTdGVwKCkgewogICAgdGhpcy5fZGlyZWN0aW9uID0gImJhY2t3YXJkIjsKCiAgICBpZiAodGhpcy5fY3VycmVudFN0ZXAgPT09IDApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC0tdGhpcy5fY3VycmVudFN0ZXA7CiAgICB2YXIgbmV4dFN0ZXAgPSB0aGlzLl9pbnRyb0l0ZW1zW3RoaXMuX2N1cnJlbnRTdGVwXTsKICAgIHZhciBjb250aW51ZVN0ZXAgPSB0cnVlOwoKICAgIGlmICh0eXBlb2YgdGhpcy5faW50cm9CZWZvcmVDaGFuZ2VDYWxsYmFjayAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgY29udGludWVTdGVwID0gdGhpcy5faW50cm9CZWZvcmVDaGFuZ2VDYWxsYmFjay5jYWxsKHRoaXMsIG5leHRTdGVwLmVsZW1lbnQpOwogICAgfSAvLyBpZiBgb25iZWZvcmVjaGFuZ2VgIHJldHVybmVkIGBmYWxzZWAsIHN0b3AgZGlzcGxheWluZyB0aGUgZWxlbWVudAoKCiAgICBpZiAoY29udGludWVTdGVwID09PSBmYWxzZSkgewogICAgICArK3RoaXMuX2N1cnJlbnRTdGVwOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgX3Nob3dFbGVtZW50LmNhbGwodGhpcywgbmV4dFN0ZXApOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHN0ZXAgb2YgdGhlIGludHJvCiAgICoKICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0KICAgKi8KCgogIGZ1bmN0aW9uIGN1cnJlbnRTdGVwKCkgewogICAgcmV0dXJuIHRoaXMuX2N1cnJlbnRTdGVwOwogIH0KICAvKioKICAgKiBvbiBrZXlDb2RlOgogICAqIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9LZXlib2FyZEV2ZW50L2tleUNvZGUKICAgKiBUaGlzIGZlYXR1cmUgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tIHRoZSBXZWIgc3RhbmRhcmRzLgogICAqIFRob3VnaCBzb21lIGJyb3dzZXJzIG1heSBzdGlsbCBzdXBwb3J0IGl0LCBpdCBpcyBpbgogICAqIHRoZSBwcm9jZXNzIG9mIGJlaW5nIGRyb3BwZWQuCiAgICogSW5zdGVhZCwgeW91IHNob3VsZCB1c2UgS2V5Ym9hcmRFdmVudC5jb2RlLAogICAqIGlmIGl0J3MgaW1wbGVtZW50ZWQuCiAgICoKICAgKiBqUXVlcnkncyBhcHByb2FjaCBpcyB0byB0ZXN0IGZvcgogICAqICAgKDEpIGUud2hpY2gsIHRoZW4KICAgKiAgICgyKSBlLmNoYXJDb2RlLCB0aGVuCiAgICogICAoMykgZS5rZXlDb2RlCiAgICogaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnkvYmxvYi9hNmIwNzA1Mjk0ZDMzNmFlMmY2M2Y3Mjc2ZGUwZGExMTk1NDk1MzYzL3NyYy9ldmVudC5qcyNMNjM4CiAgICoKICAgKiBAcGFyYW0gdHlwZSB2YXIKICAgKiBAcmV0dXJuIHR5cGUKICAgKi8KCgogIGZ1bmN0aW9uIG9uS2V5RG93bihlKSB7CiAgICB2YXIgY29kZSA9IGUuY29kZSA9PT0gbnVsbCA/IGUud2hpY2ggOiBlLmNvZGU7IC8vIGlmIGNvZGUvZS53aGljaCBpcyBudWxsCgogICAgaWYgKGNvZGUgPT09IG51bGwpIHsKICAgICAgY29kZSA9IGUuY2hhckNvZGUgPT09IG51bGwgPyBlLmtleUNvZGUgOiBlLmNoYXJDb2RlOwogICAgfQoKICAgIGlmICgoY29kZSA9PT0gIkVzY2FwZSIgfHwgY29kZSA9PT0gMjcpICYmIHRoaXMuX29wdGlvbnMuZXhpdE9uRXNjID09PSB0cnVlKSB7CiAgICAgIC8vZXNjYXBlIGtleSBwcmVzc2VkLCBleGl0IHRoZSBpbnRybwogICAgICAvL2NoZWNrIGlmIGV4aXQgY2FsbGJhY2sgaXMgZGVmaW5lZAogICAgICBleGl0SW50cm8uY2FsbCh0aGlzLCB0aGlzLl90YXJnZXRFbGVtZW50KTsKICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gIkFycm93TGVmdCIgfHwgY29kZSA9PT0gMzcpIHsKICAgICAgLy9sZWZ0IGFycm93CiAgICAgIHByZXZpb3VzU3RlcC5jYWxsKHRoaXMpOwogICAgfSBlbHNlIGlmIChjb2RlID09PSAiQXJyb3dSaWdodCIgfHwgY29kZSA9PT0gMzkpIHsKICAgICAgLy9yaWdodCBhcnJvdwogICAgICBuZXh0U3RlcC5jYWxsKHRoaXMpOwogICAgfSBlbHNlIGlmIChjb2RlID09PSAiRW50ZXIiIHx8IGNvZGUgPT09IDEzKSB7CiAgICAgIC8vc3JjRWxlbWVudCA9PT0gaWUKICAgICAgdmFyIHRhcmdldCA9IGUudGFyZ2V0IHx8IGUuc3JjRWxlbWVudDsKCiAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0LmNsYXNzTmFtZS5tYXRjaCgiaW50cm9qcy1wcmV2YnV0dG9uIikpIHsKICAgICAgICAvL3VzZXIgaGl0IGVudGVyIHdoaWxlIGZvY3VzaW5nIG9uIHByZXZpb3VzIGJ1dHRvbgogICAgICAgIHByZXZpb3VzU3RlcC5jYWxsKHRoaXMpOwogICAgICB9IGVsc2UgaWYgKHRhcmdldCAmJiB0YXJnZXQuY2xhc3NOYW1lLm1hdGNoKCJpbnRyb2pzLXNraXBidXR0b24iKSkgewogICAgICAgIC8vdXNlciBoaXQgZW50ZXIgd2hpbGUgZm9jdXNpbmcgb24gc2tpcCBidXR0b24KICAgICAgICBpZiAodGhpcy5faW50cm9JdGVtcy5sZW5ndGggLSAxID09PSB0aGlzLl9jdXJyZW50U3RlcCAmJiB0eXBlb2YgdGhpcy5faW50cm9Db21wbGV0ZUNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICB0aGlzLl9pbnRyb0NvbXBsZXRlQ2FsbGJhY2suY2FsbCh0aGlzKTsKICAgICAgICB9CgogICAgICAgIGV4aXRJbnRyby5jYWxsKHRoaXMsIHRoaXMuX3RhcmdldEVsZW1lbnQpOwogICAgICB9IGVsc2UgaWYgKHRhcmdldCAmJiB0YXJnZXQuZ2V0QXR0cmlidXRlKCJkYXRhLXN0ZXBudW1iZXIiKSkgewogICAgICAgIC8vIHVzZXIgaGl0IGVudGVyIHdoaWxlIGZvY3VzaW5nIG9uIHN0ZXAgYnVsbGV0CiAgICAgICAgdGFyZ2V0LmNsaWNrKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy9kZWZhdWx0IGJlaGF2aW9yIGZvciByZXNwb25kaW5nIHRvIGVudGVyCiAgICAgICAgbmV4dFN0ZXAuY2FsbCh0aGlzKTsKICAgICAgfSAvL3ByZXZlbnQgZGVmYXVsdCBiZWhhdmlvdXIgb24gaGl0dGluZyBFbnRlciwgdG8gcHJldmVudCBzdGVwcyBiZWluZyBza2lwcGVkIGluIHNvbWUgYnJvd3NlcnMKCgogICAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlLnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgIH0KICAgIH0KICB9CiAgLyoKICAgKiBtYWtlcyBhIGNvcHkgb2YgdGhlIG9iamVjdAogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX2Nsb25lT2JqZWN0CiAgICovCgoKICBmdW5jdGlvbiBjbG9uZU9iamVjdChvYmplY3QpIHsKICAgIGlmIChvYmplY3QgPT09IG51bGwgfHwgX3R5cGVvZihvYmplY3QpICE9PSAib2JqZWN0IiB8fCB0eXBlb2Ygb2JqZWN0Lm5vZGVUeXBlICE9PSAidW5kZWZpbmVkIikgewogICAgICByZXR1cm4gb2JqZWN0OwogICAgfQoKICAgIHZhciB0ZW1wID0ge307CgogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgICBpZiAodHlwZW9mIHdpbmRvdy5qUXVlcnkgIT09ICJ1bmRlZmluZWQiICYmIG9iamVjdFtrZXldIGluc3RhbmNlb2Ygd2luZG93LmpRdWVyeSkgewogICAgICAgIHRlbXBba2V5XSA9IG9iamVjdFtrZXldOwogICAgICB9IGVsc2UgewogICAgICAgIHRlbXBba2V5XSA9IGNsb25lT2JqZWN0KG9iamVjdFtrZXldKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0ZW1wOwogIH0KICAvKioKICAgKiBHZXQgYSBxdWVyeXNlbGVjdG9yIHdpdGhpbiB0aGUgaGludCB3cmFwcGVyCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gc2VsZWN0b3IKICAgKiBAcmV0dXJuIHtOb2RlTGlzdHxBcnJheX0KICAgKi8KCgogIGZ1bmN0aW9uIGhpbnRRdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKSB7CiAgICB2YXIgaGludHNXcmFwcGVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtaGludHMiKTsKICAgIHJldHVybiBoaW50c1dyYXBwZXIgPyBoaW50c1dyYXBwZXIucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikgOiBbXTsKICB9CiAgLyoqCiAgICogSGlkZSBhIGhpbnQKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgaGlkZUhpbnQKICAgKi8KCgogIGZ1bmN0aW9uIGhpZGVIaW50KHN0ZXBJZCkgewogICAgdmFyIGhpbnQgPSBoaW50UXVlcnlTZWxlY3RvckFsbCgiLmludHJvanMtaGludFtkYXRhLXN0ZXA9XCIiLmNvbmNhdChzdGVwSWQsICJcIl0iKSlbMF07CiAgICByZW1vdmVIaW50VG9vbHRpcC5jYWxsKHRoaXMpOwoKICAgIGlmIChoaW50KSB7CiAgICAgIGFkZENsYXNzKGhpbnQsICJpbnRyb2pzLWhpZGVoaW50Iik7CiAgICB9IC8vIGNhbGwgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBhbnkpCgoKICAgIGlmICh0eXBlb2YgdGhpcy5faGludENsb3NlQ2FsbGJhY2sgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRoaXMuX2hpbnRDbG9zZUNhbGxiYWNrLmNhbGwodGhpcywgc3RlcElkKTsKICAgIH0KICB9CiAgLyoqCiAgICogSGlkZSBhbGwgaGludHMKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgaGlkZUhpbnRzCiAgICovCgoKICBmdW5jdGlvbiBoaWRlSGludHMoKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHZhciBoaW50cyA9IGhpbnRRdWVyeVNlbGVjdG9yQWxsKCIuaW50cm9qcy1oaW50Iik7CiAgICBmb3JFYWNoKGhpbnRzLCBmdW5jdGlvbiAoaGludCkgewogICAgICBoaWRlSGludC5jYWxsKF90aGlzLCBoaW50LmdldEF0dHJpYnV0ZSgiZGF0YS1zdGVwIikpOwogICAgfSk7CiAgfQogIC8qKgogICAqIFNob3cgYWxsIGhpbnRzCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAbWV0aG9kIF9zaG93SGludHMKICAgKi8KCgogIGZ1bmN0aW9uIHNob3dIaW50cygpIHsKICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgIHZhciBoaW50cyA9IGhpbnRRdWVyeVNlbGVjdG9yQWxsKCIuaW50cm9qcy1oaW50Iik7CgogICAgaWYgKGhpbnRzICYmIGhpbnRzLmxlbmd0aCkgewogICAgICBmb3JFYWNoKGhpbnRzLCBmdW5jdGlvbiAoaGludCkgewogICAgICAgIHNob3dIaW50LmNhbGwoX3RoaXMyLCBoaW50LmdldEF0dHJpYnV0ZSgiZGF0YS1zdGVwIikpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHBvcHVsYXRlSGludHMuY2FsbCh0aGlzLCB0aGlzLl90YXJnZXRFbGVtZW50KTsKICAgIH0KICB9CiAgLyoqCiAgICogU2hvdyBhIGhpbnQKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2Qgc2hvd0hpbnQKICAgKi8KCgogIGZ1bmN0aW9uIHNob3dIaW50KHN0ZXBJZCkgewogICAgdmFyIGhpbnQgPSBoaW50UXVlcnlTZWxlY3RvckFsbCgiLmludHJvanMtaGludFtkYXRhLXN0ZXA9XCIiLmNvbmNhdChzdGVwSWQsICJcIl0iKSlbMF07CgogICAgaWYgKGhpbnQpIHsKICAgICAgcmVtb3ZlQ2xhc3MoaGludCwgL2ludHJvanMtaGlkZWhpbnQvZyk7CiAgICB9CiAgfQogIC8qKgogICAqIFJlbW92ZXMgYWxsIGhpbnQgZWxlbWVudHMgb24gdGhlIHBhZ2UKICAgKiBVc2VmdWwgd2hlbiB5b3Ugd2FudCB0byBkZXN0cm95IHRoZSBlbGVtZW50cyBhbmQgYWRkIHRoZW0gYWdhaW4gKGUuZy4gYSBtb2RhbCBvciBwb3B1cCkKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgcmVtb3ZlSGludHMKICAgKi8KCgogIGZ1bmN0aW9uIHJlbW92ZUhpbnRzKCkgewogICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgdmFyIGhpbnRzID0gaGludFF1ZXJ5U2VsZWN0b3JBbGwoIi5pbnRyb2pzLWhpbnQiKTsKICAgIGZvckVhY2goaGludHMsIGZ1bmN0aW9uIChoaW50KSB7CiAgICAgIHJlbW92ZUhpbnQuY2FsbChfdGhpczMsIGhpbnQuZ2V0QXR0cmlidXRlKCJkYXRhLXN0ZXAiKSk7CiAgICB9KTsKICB9CiAgLyoqCiAgICogUmVtb3ZlIG9uZSBzaW5nbGUgaGludCBlbGVtZW50IGZyb20gdGhlIHBhZ2UKICAgKiBVc2VmdWwgd2hlbiB5b3Ugd2FudCB0byBkZXN0cm95IHRoZSBlbGVtZW50IGFuZCBhZGQgdGhlbSBhZ2FpbiAoZS5nLiBhIG1vZGFsIG9yIHBvcHVwKQogICAqIFVzZSByZW1vdmVIaW50cyBpZiB5b3Ugd2FudCB0byByZW1vdmUgYWxsIGVsZW1lbnRzLgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCByZW1vdmVIaW50CiAgICovCgoKICBmdW5jdGlvbiByZW1vdmVIaW50KHN0ZXBJZCkgewogICAgdmFyIGhpbnQgPSBoaW50UXVlcnlTZWxlY3RvckFsbCgiLmludHJvanMtaGludFtkYXRhLXN0ZXA9XCIiLmNvbmNhdChzdGVwSWQsICJcIl0iKSlbMF07CgogICAgaWYgKGhpbnQpIHsKICAgICAgaGludC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGhpbnQpOwogICAgfQogIH0KICAvKioKICAgKiBBZGQgYWxsIGF2YWlsYWJsZSBoaW50cyB0byB0aGUgcGFnZQogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBhZGRIaW50cwogICAqLwoKCiAgZnVuY3Rpb24gYWRkSGludHMoKSB7CiAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgaGludHNXcmFwcGVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtaGludHMiKTsKCiAgICBpZiAoaGludHNXcmFwcGVyID09PSBudWxsKSB7CiAgICAgIGhpbnRzV3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBoaW50c1dyYXBwZXIuY2xhc3NOYW1lID0gImludHJvanMtaGludHMiOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGFuIGV2ZW50IGhhbmRsZXIgdW5pcXVlIHRvIHRoZSBoaW50IGl0ZXJhdGlvbgogICAgICoKICAgICAqIEBwYXJhbSB7SW50ZWdlcn0gaQogICAgICogQHJldHVybiB7RnVuY3Rpb259CiAgICAgKi8KCgogICAgdmFyIGdldEhpbnRDbGljayA9IGZ1bmN0aW9uIGdldEhpbnRDbGljayhpKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoZSkgewogICAgICAgIHZhciBldnQgPSBlID8gZSA6IHdpbmRvdy5ldmVudDsKCiAgICAgICAgaWYgKGV2dC5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICB9CgogICAgICAgIGlmIChldnQuY2FuY2VsQnViYmxlICE9PSBudWxsKSB7CiAgICAgICAgICBldnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHNob3dIaW50RGlhbG9nLmNhbGwoc2VsZiwgaSk7CiAgICAgIH07CiAgICB9OwoKICAgIGZvckVhY2godGhpcy5faW50cm9JdGVtcywgZnVuY3Rpb24gKGl0ZW0sIGkpIHsKICAgICAgLy8gYXZvaWQgYXBwZW5kIGEgaGludCB0d2ljZQogICAgICBpZiAoZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtaGludFtkYXRhLXN0ZXA9XCIiLmNvbmNhdChpLCAiXCJdIikpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgaGludCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgICAgc2V0QW5jaG9yQXNCdXR0b24oaGludCk7CiAgICAgIGhpbnQub25jbGljayA9IGdldEhpbnRDbGljayhpKTsKICAgICAgaGludC5jbGFzc05hbWUgPSAiaW50cm9qcy1oaW50IjsKCiAgICAgIGlmICghaXRlbS5oaW50QW5pbWF0aW9uKSB7CiAgICAgICAgYWRkQ2xhc3MoaGludCwgImludHJvanMtaGludC1uby1hbmltIik7CiAgICAgIH0gLy8gaGludCdzIHBvc2l0aW9uIHNob3VsZCBiZSBmaXhlZCBpZiB0aGUgdGFyZ2V0IGVsZW1lbnQncyBwb3NpdGlvbiBpcyBmaXhlZAoKCiAgICAgIGlmIChpc0ZpeGVkKGl0ZW0uZWxlbWVudCkpIHsKICAgICAgICBhZGRDbGFzcyhoaW50LCAiaW50cm9qcy1maXhlZGhpbnQiKTsKICAgICAgfQoKICAgICAgdmFyIGhpbnREb3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgaGludERvdC5jbGFzc05hbWUgPSAiaW50cm9qcy1oaW50LWRvdCI7CiAgICAgIHZhciBoaW50UHVsc2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgaGludFB1bHNlLmNsYXNzTmFtZSA9ICJpbnRyb2pzLWhpbnQtcHVsc2UiOwogICAgICBoaW50LmFwcGVuZENoaWxkKGhpbnREb3QpOwogICAgICBoaW50LmFwcGVuZENoaWxkKGhpbnRQdWxzZSk7CiAgICAgIGhpbnQuc2V0QXR0cmlidXRlKCJkYXRhLXN0ZXAiLCBpKTsgLy8gd2Ugc3dhcCB0aGUgaGludCBlbGVtZW50IHdpdGggdGFyZ2V0IGVsZW1lbnQKICAgICAgLy8gYmVjYXVzZSBfc2V0SGVscGVyTGF5ZXJQb3NpdGlvbiB1c2VzIGBlbGVtZW50YCBwcm9wZXJ0eQoKICAgICAgaXRlbS50YXJnZXRFbGVtZW50ID0gaXRlbS5lbGVtZW50OwogICAgICBpdGVtLmVsZW1lbnQgPSBoaW50OyAvLyBhbGlnbiB0aGUgaGludCBwb3NpdGlvbgoKICAgICAgYWxpZ25IaW50UG9zaXRpb24uY2FsbChfdGhpczQsIGl0ZW0uaGludFBvc2l0aW9uLCBoaW50LCBpdGVtLnRhcmdldEVsZW1lbnQpOwogICAgICBoaW50c1dyYXBwZXIuYXBwZW5kQ2hpbGQoaGludCk7CiAgICB9KTsgLy8gYWRkaW5nIHRoZSBoaW50cyB3cmFwcGVyCgogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChoaW50c1dyYXBwZXIpOyAvLyBjYWxsIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAoaWYgYW55KQoKICAgIGlmICh0eXBlb2YgdGhpcy5faGludHNBZGRlZENhbGxiYWNrICE9PSAidW5kZWZpbmVkIikgewogICAgICB0aGlzLl9oaW50c0FkZGVkQ2FsbGJhY2suY2FsbCh0aGlzKTsKICAgIH0KICB9CiAgLyoqCiAgICogQWxpZ25zIGhpbnQgcG9zaXRpb24KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgYWxpZ25IaW50UG9zaXRpb24KICAgKiBAcGFyYW0ge1N0cmluZ30gcG9zaXRpb24KICAgKiBAcGFyYW0ge09iamVjdH0gaGludAogICAqIEBwYXJhbSB7T2JqZWN0fSBlbGVtZW50CiAgICovCgoKICBmdW5jdGlvbiBhbGlnbkhpbnRQb3NpdGlvbihwb3NpdGlvbiwgX3JlZiwgZWxlbWVudCkgewogICAgdmFyIHN0eWxlID0gX3JlZi5zdHlsZTsgLy8gZ2V0L2NhbGN1bGF0ZSBvZmZzZXQgb2YgdGFyZ2V0IGVsZW1lbnQKCiAgICB2YXIgb2Zmc2V0ID0gZ2V0T2Zmc2V0LmNhbGwodGhpcywgZWxlbWVudCk7CiAgICB2YXIgaWNvbldpZHRoID0gMjA7CiAgICB2YXIgaWNvbkhlaWdodCA9IDIwOyAvLyBhbGlnbiB0aGUgaGludCBlbGVtZW50CgogICAgc3dpdGNoIChwb3NpdGlvbikgewogICAgICBkZWZhdWx0OgogICAgICBjYXNlICJ0b3AtbGVmdCI6CiAgICAgICAgc3R5bGUubGVmdCA9ICIiLmNvbmNhdChvZmZzZXQubGVmdCwgInB4Iik7CiAgICAgICAgc3R5bGUudG9wID0gIiIuY29uY2F0KG9mZnNldC50b3AsICJweCIpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAidG9wLXJpZ2h0IjoKICAgICAgICBzdHlsZS5sZWZ0ID0gIiIuY29uY2F0KG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoIC0gaWNvbldpZHRoLCAicHgiKTsKICAgICAgICBzdHlsZS50b3AgPSAiIi5jb25jYXQob2Zmc2V0LnRvcCwgInB4Iik7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICJib3R0b20tbGVmdCI6CiAgICAgICAgc3R5bGUubGVmdCA9ICIiLmNvbmNhdChvZmZzZXQubGVmdCwgInB4Iik7CiAgICAgICAgc3R5bGUudG9wID0gIiIuY29uY2F0KG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0IC0gaWNvbkhlaWdodCwgInB4Iik7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICJib3R0b20tcmlnaHQiOgogICAgICAgIHN0eWxlLmxlZnQgPSAiIi5jb25jYXQob2Zmc2V0LmxlZnQgKyBvZmZzZXQud2lkdGggLSBpY29uV2lkdGgsICJweCIpOwogICAgICAgIHN0eWxlLnRvcCA9ICIiLmNvbmNhdChvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodCAtIGljb25IZWlnaHQsICJweCIpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAibWlkZGxlLWxlZnQiOgogICAgICAgIHN0eWxlLmxlZnQgPSAiIi5jb25jYXQob2Zmc2V0LmxlZnQsICJweCIpOwogICAgICAgIHN0eWxlLnRvcCA9ICIiLmNvbmNhdChvZmZzZXQudG9wICsgKG9mZnNldC5oZWlnaHQgLSBpY29uSGVpZ2h0KSAvIDIsICJweCIpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAibWlkZGxlLXJpZ2h0IjoKICAgICAgICBzdHlsZS5sZWZ0ID0gIiIuY29uY2F0KG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoIC0gaWNvbldpZHRoLCAicHgiKTsKICAgICAgICBzdHlsZS50b3AgPSAiIi5jb25jYXQob2Zmc2V0LnRvcCArIChvZmZzZXQuaGVpZ2h0IC0gaWNvbkhlaWdodCkgLyAyLCAicHgiKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgIm1pZGRsZS1taWRkbGUiOgogICAgICAgIHN0eWxlLmxlZnQgPSAiIi5jb25jYXQob2Zmc2V0LmxlZnQgKyAob2Zmc2V0LndpZHRoIC0gaWNvbldpZHRoKSAvIDIsICJweCIpOwogICAgICAgIHN0eWxlLnRvcCA9ICIiLmNvbmNhdChvZmZzZXQudG9wICsgKG9mZnNldC5oZWlnaHQgLSBpY29uSGVpZ2h0KSAvIDIsICJweCIpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAiYm90dG9tLW1pZGRsZSI6CiAgICAgICAgc3R5bGUubGVmdCA9ICIiLmNvbmNhdChvZmZzZXQubGVmdCArIChvZmZzZXQud2lkdGggLSBpY29uV2lkdGgpIC8gMiwgInB4Iik7CiAgICAgICAgc3R5bGUudG9wID0gIiIuY29uY2F0KG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0IC0gaWNvbkhlaWdodCwgInB4Iik7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICJ0b3AtbWlkZGxlIjoKICAgICAgICBzdHlsZS5sZWZ0ID0gIiIuY29uY2F0KG9mZnNldC5sZWZ0ICsgKG9mZnNldC53aWR0aCAtIGljb25XaWR0aCkgLyAyLCAicHgiKTsKICAgICAgICBzdHlsZS50b3AgPSAiIi5jb25jYXQob2Zmc2V0LnRvcCwgInB4Iik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIC8qKgogICAqIFRyaWdnZXJzIHdoZW4gdXNlciBjbGlja3Mgb24gdGhlIGhpbnQgZWxlbWVudAogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfc2hvd0hpbnREaWFsb2cKICAgKiBAcGFyYW0ge051bWJlcn0gc3RlcElkCiAgICovCgoKICBmdW5jdGlvbiBzaG93SGludERpYWxvZyhzdGVwSWQpIHsKICAgIHZhciBoaW50RWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWhpbnRbZGF0YS1zdGVwPVwiIi5jb25jYXQoc3RlcElkLCAiXCJdIikpOwogICAgdmFyIGl0ZW0gPSB0aGlzLl9pbnRyb0l0ZW1zW3N0ZXBJZF07IC8vIGNhbGwgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBhbnkpCgogICAgaWYgKHR5cGVvZiB0aGlzLl9oaW50Q2xpY2tDYWxsYmFjayAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhpcy5faGludENsaWNrQ2FsbGJhY2suY2FsbCh0aGlzLCBoaW50RWxlbWVudCwgaXRlbSwgc3RlcElkKTsKICAgIH0gLy8gcmVtb3ZlIGFsbCBvcGVuIHRvb2x0aXBzCgoKICAgIHZhciByZW1vdmVkU3RlcCA9IHJlbW92ZUhpbnRUb29sdGlwLmNhbGwodGhpcyk7IC8vIHRvIHRvZ2dsZSB0aGUgdG9vbHRpcAoKICAgIGlmIChwYXJzZUludChyZW1vdmVkU3RlcCwgMTApID09PSBzdGVwSWQpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciB0b29sdGlwTGF5ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHZhciB0b29sdGlwVGV4dExheWVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB2YXIgYXJyb3dMYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdmFyIHJlZmVyZW5jZUxheWVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB0b29sdGlwTGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtdG9vbHRpcCI7CgogICAgdG9vbHRpcExheWVyLm9uY2xpY2sgPSBmdW5jdGlvbiAoZSkgewogICAgICAvL0lFOSAmIE90aGVyIEJyb3dzZXJzCiAgICAgIGlmIChlLnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgIH0gLy9JRTggYW5kIExvd2VyCiAgICAgIGVsc2UgewogICAgICAgICAgZS5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgIH0KICAgIH07CgogICAgdG9vbHRpcFRleHRMYXllci5jbGFzc05hbWUgPSAiaW50cm9qcy10b29sdGlwdGV4dCI7CiAgICB2YXIgdG9vbHRpcFdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJwIik7CiAgICB0b29sdGlwV3JhcHBlci5pbm5lckhUTUwgPSBpdGVtLmhpbnQ7CiAgICB2YXIgY2xvc2VCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICBjbG9zZUJ1dHRvbi5jbGFzc05hbWUgPSB0aGlzLl9vcHRpb25zLmJ1dHRvbkNsYXNzOwogICAgY2xvc2VCdXR0b24uc2V0QXR0cmlidXRlKCJyb2xlIiwgImJ1dHRvbiIpOwogICAgY2xvc2VCdXR0b24uaW5uZXJIVE1MID0gdGhpcy5fb3B0aW9ucy5oaW50QnV0dG9uTGFiZWw7CiAgICBjbG9zZUJ1dHRvbi5vbmNsaWNrID0gaGlkZUhpbnQuYmluZCh0aGlzLCBzdGVwSWQpOwogICAgdG9vbHRpcFRleHRMYXllci5hcHBlbmRDaGlsZCh0b29sdGlwV3JhcHBlcik7CiAgICB0b29sdGlwVGV4dExheWVyLmFwcGVuZENoaWxkKGNsb3NlQnV0dG9uKTsKICAgIGFycm93TGF5ZXIuY2xhc3NOYW1lID0gImludHJvanMtYXJyb3ciOwogICAgdG9vbHRpcExheWVyLmFwcGVuZENoaWxkKGFycm93TGF5ZXIpOwogICAgdG9vbHRpcExheWVyLmFwcGVuZENoaWxkKHRvb2x0aXBUZXh0TGF5ZXIpOyAvLyBzZXQgY3VycmVudCBzdGVwIGZvciBfcGxhY2VUb29sdGlwIGZ1bmN0aW9uCgogICAgdGhpcy5fY3VycmVudFN0ZXAgPSBoaW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtc3RlcCIpOyAvLyBhbGlnbiByZWZlcmVuY2UgbGF5ZXIgcG9zaXRpb24KCiAgICByZWZlcmVuY2VMYXllci5jbGFzc05hbWUgPSAiaW50cm9qcy10b29sdGlwUmVmZXJlbmNlTGF5ZXIgaW50cm9qcy1oaW50UmVmZXJlbmNlIjsKICAgIHJlZmVyZW5jZUxheWVyLnNldEF0dHJpYnV0ZSgiZGF0YS1zdGVwIiwgaGludEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLXN0ZXAiKSk7CiAgICBzZXRIZWxwZXJMYXllclBvc2l0aW9uLmNhbGwodGhpcywgcmVmZXJlbmNlTGF5ZXIpOwogICAgcmVmZXJlbmNlTGF5ZXIuYXBwZW5kQ2hpbGQodG9vbHRpcExheWVyKTsKICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocmVmZXJlbmNlTGF5ZXIpOyAvL3NldCBwcm9wZXIgcG9zaXRpb24KCiAgICBwbGFjZVRvb2x0aXAuY2FsbCh0aGlzLCBoaW50RWxlbWVudCwgdG9vbHRpcExheWVyLCBhcnJvd0xheWVyLCBudWxsLCB0cnVlKTsKICB9CiAgLyoqCiAgICogUmVtb3ZlcyBvcGVuIGhpbnQgKHRvb2x0aXAgaGludCkKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX3JlbW92ZUhpbnRUb29sdGlwCiAgICovCgoKICBmdW5jdGlvbiByZW1vdmVIaW50VG9vbHRpcCgpIHsKICAgIHZhciB0b29sdGlwID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtaGludFJlZmVyZW5jZSIpOwoKICAgIGlmICh0b29sdGlwKSB7CiAgICAgIHZhciBzdGVwID0gdG9vbHRpcC5nZXRBdHRyaWJ1dGUoImRhdGEtc3RlcCIpOwogICAgICB0b29sdGlwLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodG9vbHRpcCk7CiAgICAgIHJldHVybiBzdGVwOwogICAgfQogIH0KICAvKioKICAgKiBTdGFydCBwYXJzaW5nIGhpbnQgaXRlbXMKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXRFbG0KICAgKiBAbWV0aG9kIF9zdGFydEhpbnQKICAgKi8KCgogIGZ1bmN0aW9uIHBvcHVsYXRlSGludHModGFyZ2V0RWxtKSB7CiAgICB2YXIgX3RoaXM1ID0gdGhpczsKCiAgICB0aGlzLl9pbnRyb0l0ZW1zID0gW107CgogICAgaWYgKHRoaXMuX29wdGlvbnMuaGludHMpIHsKICAgICAgZm9yRWFjaCh0aGlzLl9vcHRpb25zLmhpbnRzLCBmdW5jdGlvbiAoaGludCkgewogICAgICAgIHZhciBjdXJyZW50SXRlbSA9IGNsb25lT2JqZWN0KGhpbnQpOwoKICAgICAgICBpZiAodHlwZW9mIGN1cnJlbnRJdGVtLmVsZW1lbnQgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAvL2dyYWIgdGhlIGVsZW1lbnQgd2l0aCBnaXZlbiBzZWxlY3RvciBmcm9tIHRoZSBwYWdlCiAgICAgICAgICBjdXJyZW50SXRlbS5lbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihjdXJyZW50SXRlbS5lbGVtZW50KTsKICAgICAgICB9CgogICAgICAgIGN1cnJlbnRJdGVtLmhpbnRQb3NpdGlvbiA9IGN1cnJlbnRJdGVtLmhpbnRQb3NpdGlvbiB8fCBfdGhpczUuX29wdGlvbnMuaGludFBvc2l0aW9uOwogICAgICAgIGN1cnJlbnRJdGVtLmhpbnRBbmltYXRpb24gPSBjdXJyZW50SXRlbS5oaW50QW5pbWF0aW9uIHx8IF90aGlzNS5fb3B0aW9ucy5oaW50QW5pbWF0aW9uOwoKICAgICAgICBpZiAoY3VycmVudEl0ZW0uZWxlbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgX3RoaXM1Ll9pbnRyb0l0ZW1zLnB1c2goY3VycmVudEl0ZW0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgaGludHMgPSB0YXJnZXRFbG0ucXVlcnlTZWxlY3RvckFsbCgiKltkYXRhLWhpbnRdIik7CgogICAgICBpZiAoIWhpbnRzIHx8ICFoaW50cy5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gLy9maXJzdCBhZGQgaW50cm8gaXRlbXMgd2l0aCBkYXRhLXN0ZXAKCgogICAgICBmb3JFYWNoKGhpbnRzLCBmdW5jdGlvbiAoY3VycmVudEVsZW1lbnQpIHsKICAgICAgICAvLyBoaW50IGFuaW1hdGlvbgogICAgICAgIHZhciBoaW50QW5pbWF0aW9uID0gY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLWhpbnRhbmltYXRpb24iKTsKCiAgICAgICAgaWYgKGhpbnRBbmltYXRpb24pIHsKICAgICAgICAgIGhpbnRBbmltYXRpb24gPSBoaW50QW5pbWF0aW9uID09PSAidHJ1ZSI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGhpbnRBbmltYXRpb24gPSBfdGhpczUuX29wdGlvbnMuaGludEFuaW1hdGlvbjsKICAgICAgICB9CgogICAgICAgIF90aGlzNS5faW50cm9JdGVtcy5wdXNoKHsKICAgICAgICAgIGVsZW1lbnQ6IGN1cnJlbnRFbGVtZW50LAogICAgICAgICAgaGludDogY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLWhpbnQiKSwKICAgICAgICAgIGhpbnRQb3NpdGlvbjogY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLWhpbnRwb3NpdGlvbiIpIHx8IF90aGlzNS5fb3B0aW9ucy5oaW50UG9zaXRpb24sCiAgICAgICAgICBoaW50QW5pbWF0aW9uOiBoaW50QW5pbWF0aW9uLAogICAgICAgICAgdG9vbHRpcENsYXNzOiBjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtdG9vbHRpcGNsYXNzIiksCiAgICAgICAgICBwb3NpdGlvbjogY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLXBvc2l0aW9uIikgfHwgX3RoaXM1Ll9vcHRpb25zLnRvb2x0aXBQb3NpdGlvbgogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICBhZGRIaW50cy5jYWxsKHRoaXMpOwogICAgLyoKICAgIHRvZG86CiAgICB0aGVzZSBldmVudHMgc2hvdWxkIGJlIHJlbW92ZWQgYXQgc29tZSBwb2ludAogICAgKi8KCiAgICBET01FdmVudC5vbihkb2N1bWVudCwgImNsaWNrIiwgcmVtb3ZlSGludFRvb2x0aXAsIHRoaXMsIGZhbHNlKTsKICAgIERPTUV2ZW50Lm9uKHdpbmRvdywgInJlc2l6ZSIsIHJlQWxpZ25IaW50cywgdGhpcywgdHJ1ZSk7CiAgfQogIC8qKgogICAqIFJlLWFsaWducyBhbGwgaGludCBlbGVtZW50cwogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfcmVBbGlnbkhpbnRzCiAgICovCgoKICBmdW5jdGlvbiByZUFsaWduSGludHMoKSB7CiAgICB2YXIgX3RoaXM2ID0gdGhpczsKCiAgICBmb3JFYWNoKHRoaXMuX2ludHJvSXRlbXMsIGZ1bmN0aW9uIChfcmVmMikgewogICAgICB2YXIgdGFyZ2V0RWxlbWVudCA9IF9yZWYyLnRhcmdldEVsZW1lbnQsCiAgICAgICAgICBoaW50UG9zaXRpb24gPSBfcmVmMi5oaW50UG9zaXRpb24sCiAgICAgICAgICBlbGVtZW50ID0gX3JlZjIuZWxlbWVudDsKCiAgICAgIGlmICh0eXBlb2YgdGFyZ2V0RWxlbWVudCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGFsaWduSGludFBvc2l0aW9uLmNhbGwoX3RoaXM2LCBoaW50UG9zaXRpb24sIGVsZW1lbnQsIHRhcmdldEVsZW1lbnQpOwogICAgfSk7CiAgfQogIC8qKgogICAqIFVwZGF0ZSBwbGFjZW1lbnQgb2YgdGhlIGludHJvIG9iamVjdHMgb24gdGhlIHNjcmVlbgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwoKCiAgZnVuY3Rpb24gcmVmcmVzaCgpIHsKICAgIC8vIHJlLWFsaWduIGludHJvcwogICAgc2V0SGVscGVyTGF5ZXJQb3NpdGlvbi5jYWxsKHRoaXMsIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWhlbHBlckxheWVyIikpOwogICAgc2V0SGVscGVyTGF5ZXJQb3NpdGlvbi5jYWxsKHRoaXMsIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLXRvb2x0aXBSZWZlcmVuY2VMYXllciIpKTsKICAgIHNldEhlbHBlckxheWVyUG9zaXRpb24uY2FsbCh0aGlzLCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy1kaXNhYmxlSW50ZXJhY3Rpb24iKSk7IC8vIHJlLWFsaWduIHRvb2x0aXAKCiAgICBpZiAodGhpcy5fY3VycmVudFN0ZXAgIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9jdXJyZW50U3RlcCAhPT0gbnVsbCkgewogICAgICB2YXIgb2xkSGVscGVyTnVtYmVyTGF5ZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy1oZWxwZXJOdW1iZXJMYXllciIpOwogICAgICB2YXIgb2xkQXJyb3dMYXllciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5pbnRyb2pzLWFycm93Iik7CiAgICAgIHZhciBvbGR0b29sdGlwQ29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtdG9vbHRpcCIpOwogICAgICBwbGFjZVRvb2x0aXAuY2FsbCh0aGlzLCB0aGlzLl9pbnRyb0l0ZW1zW3RoaXMuX2N1cnJlbnRTdGVwXS5lbGVtZW50LCBvbGR0b29sdGlwQ29udGFpbmVyLCBvbGRBcnJvd0xheWVyLCBvbGRIZWxwZXJOdW1iZXJMYXllcik7CiAgICB9IC8vcmUtYWxpZ24gaGludHMKCgogICAgcmVBbGlnbkhpbnRzLmNhbGwodGhpcyk7CiAgICByZXR1cm4gdGhpczsKICB9CgogIGZ1bmN0aW9uIG9uUmVzaXplKCkgewogICAgcmVmcmVzaC5jYWxsKHRoaXMpOwogIH0KICAvKioKICAgKiBFeGl0IGZyb20gaW50cm8KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBtZXRob2QgX2V4aXRJbnRybwogICAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXRFbGVtZW50CiAgICogQHBhcmFtIHtCb29sZWFufSBmb3JjZSAtIFNldHRpbmcgdG8gYHRydWVgIHdpbGwgc2tpcCB0aGUgcmVzdWx0IG9mIGJlZm9yZUV4aXQgY2FsbGJhY2sKICAgKi8KCgogIGZ1bmN0aW9uIGV4aXRJbnRybyh0YXJnZXRFbGVtZW50LCBmb3JjZSkgewogICAgdmFyIGNvbnRpbnVlRXhpdCA9IHRydWU7IC8vIGNhbGxpbmcgb25iZWZvcmVleGl0IGNhbGxiYWNrCiAgICAvLwogICAgLy8gSWYgdGhpcyBjYWxsYmFjayByZXR1cm4gYGZhbHNlYCwgaXQgd291bGQgaGFsdCB0aGUgcHJvY2VzcwoKICAgIGlmICh0aGlzLl9pbnRyb0JlZm9yZUV4aXRDYWxsYmFjayAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGNvbnRpbnVlRXhpdCA9IHRoaXMuX2ludHJvQmVmb3JlRXhpdENhbGxiYWNrLmNhbGwodGhpcyk7CiAgICB9IC8vIHNraXAgdGhpcyBjaGVjayBpZiBgZm9yY2VgIHBhcmFtZXRlciBpcyBgdHJ1ZWAKICAgIC8vIG90aGVyd2lzZSwgaWYgYG9uYmVmb3JlZXhpdGAgcmV0dXJuZWQgYGZhbHNlYCwgZG9uJ3QgZXhpdCB0aGUgaW50cm8KCgogICAgaWYgKCFmb3JjZSAmJiBjb250aW51ZUV4aXQgPT09IGZhbHNlKSByZXR1cm47IC8vcmVtb3ZlIG92ZXJsYXkgbGF5ZXJzIGZyb20gdGhlIHBhZ2UKCiAgICB2YXIgb3ZlcmxheUxheWVycyA9IHRhcmdldEVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgiLmludHJvanMtb3ZlcmxheSIpOwoKICAgIGlmIChvdmVybGF5TGF5ZXJzICYmIG92ZXJsYXlMYXllcnMubGVuZ3RoKSB7CiAgICAgIGZvckVhY2gob3ZlcmxheUxheWVycywgZnVuY3Rpb24gKG92ZXJsYXlMYXllcikgewogICAgICAgIG92ZXJsYXlMYXllci5zdHlsZS5vcGFjaXR5ID0gMDsKICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgIHRoaXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzKTsKICAgICAgICAgIH0KICAgICAgICB9LmJpbmQob3ZlcmxheUxheWVyKSwgNTAwKTsKICAgICAgfSk7CiAgICB9IC8vcmVtb3ZlIGFsbCBoZWxwZXIgbGF5ZXJzCgoKICAgIHZhciBoZWxwZXJMYXllciA9IHRhcmdldEVsZW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtaGVscGVyTGF5ZXIiKTsKCiAgICBpZiAoaGVscGVyTGF5ZXIpIHsKICAgICAgaGVscGVyTGF5ZXIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChoZWxwZXJMYXllcik7CiAgICB9CgogICAgdmFyIHJlZmVyZW5jZUxheWVyID0gdGFyZ2V0RWxlbWVudC5xdWVyeVNlbGVjdG9yKCIuaW50cm9qcy10b29sdGlwUmVmZXJlbmNlTGF5ZXIiKTsKCiAgICBpZiAocmVmZXJlbmNlTGF5ZXIpIHsKICAgICAgcmVmZXJlbmNlTGF5ZXIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChyZWZlcmVuY2VMYXllcik7CiAgICB9IC8vcmVtb3ZlIGRpc2FibGVJbnRlcmFjdGlvbkxheWVyCgoKICAgIHZhciBkaXNhYmxlSW50ZXJhY3Rpb25MYXllciA9IHRhcmdldEVsZW1lbnQucXVlcnlTZWxlY3RvcigiLmludHJvanMtZGlzYWJsZUludGVyYWN0aW9uIik7CgogICAgaWYgKGRpc2FibGVJbnRlcmFjdGlvbkxheWVyKSB7CiAgICAgIGRpc2FibGVJbnRlcmFjdGlvbkxheWVyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZGlzYWJsZUludGVyYWN0aW9uTGF5ZXIpOwogICAgfSAvL3JlbW92ZSBpbnRybyBmbG9hdGluZyBlbGVtZW50CgoKICAgIHZhciBmbG9hdGluZ0VsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuaW50cm9qc0Zsb2F0aW5nRWxlbWVudCIpOwoKICAgIGlmIChmbG9hdGluZ0VsZW1lbnQpIHsKICAgICAgZmxvYXRpbmdFbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZmxvYXRpbmdFbGVtZW50KTsKICAgIH0KCiAgICByZW1vdmVTaG93RWxlbWVudCgpOyAvL3JlbW92ZSBgaW50cm9qcy1maXhQYXJlbnRgIGNsYXNzIGZyb20gdGhlIGVsZW1lbnRzCgogICAgdmFyIGZpeFBhcmVudHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCIuaW50cm9qcy1maXhQYXJlbnQiKTsKICAgIGZvckVhY2goZml4UGFyZW50cywgZnVuY3Rpb24gKHBhcmVudCkgewogICAgICByZW1vdmVDbGFzcyhwYXJlbnQsIC9pbnRyb2pzLWZpeFBhcmVudC9nKTsKICAgIH0pOyAvL2NsZWFuIGxpc3RlbmVycwoKICAgIERPTUV2ZW50Lm9mZih3aW5kb3csICJrZXlkb3duIiwgb25LZXlEb3duLCB0aGlzLCB0cnVlKTsKICAgIERPTUV2ZW50Lm9mZih3aW5kb3csICJyZXNpemUiLCBvblJlc2l6ZSwgdGhpcywgdHJ1ZSk7IC8vY2hlY2sgaWYgYW55IGNhbGxiYWNrIGlzIGRlZmluZWQKCiAgICBpZiAodGhpcy5faW50cm9FeGl0Q2FsbGJhY2sgIT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzLl9pbnRyb0V4aXRDYWxsYmFjay5jYWxsKHRoaXMpOwogICAgfSAvL3NldCB0aGUgc3RlcCB0byB6ZXJvCgoKICAgIHRoaXMuX2N1cnJlbnRTdGVwID0gdW5kZWZpbmVkOwogIH0KICAvKioKICAgKiBBZGQgb3ZlcmxheSBsYXllciB0byB0aGUgcGFnZQogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfYWRkT3ZlcmxheUxheWVyCiAgICogQHBhcmFtIHtPYmplY3R9IHRhcmdldEVsbQogICAqLwoKCiAgZnVuY3Rpb24gYWRkT3ZlcmxheUxheWVyKHRhcmdldEVsbSkgewogICAgdmFyIG92ZXJsYXlMYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdmFyIHN0eWxlVGV4dCA9ICIiOwogICAgdmFyIHNlbGYgPSB0aGlzOyAvL3NldCBjc3MgY2xhc3MgbmFtZQoKICAgIG92ZXJsYXlMYXllci5jbGFzc05hbWUgPSAiaW50cm9qcy1vdmVybGF5IjsgLy9jaGVjayBpZiB0aGUgdGFyZ2V0IGVsZW1lbnQgaXMgYm9keSwgd2Ugc2hvdWxkIGNhbGN1bGF0ZSB0aGUgc2l6ZSBvZiBvdmVybGF5IGxheWVyIGluIGEgYmV0dGVyIHdheQoKICAgIGlmICghdGFyZ2V0RWxtLnRhZ05hbWUgfHwgdGFyZ2V0RWxtLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gImJvZHkiKSB7CiAgICAgIHN0eWxlVGV4dCArPSAidG9wOiAwO2JvdHRvbTogMDsgbGVmdDogMDtyaWdodDogMDtwb3NpdGlvbjogZml4ZWQ7IjsKICAgICAgb3ZlcmxheUxheWVyLnN0eWxlLmNzc1RleHQgPSBzdHlsZVRleHQ7CiAgICB9IGVsc2UgewogICAgICAvL3NldCBvdmVybGF5IGxheWVyIHBvc2l0aW9uCiAgICAgIHZhciBlbGVtZW50UG9zaXRpb24gPSBnZXRPZmZzZXQodGFyZ2V0RWxtKTsKCiAgICAgIGlmIChlbGVtZW50UG9zaXRpb24pIHsKICAgICAgICBzdHlsZVRleHQgKz0gIndpZHRoOiAiLmNvbmNhdChlbGVtZW50UG9zaXRpb24ud2lkdGgsICJweDsgaGVpZ2h0OiIpLmNvbmNhdChlbGVtZW50UG9zaXRpb24uaGVpZ2h0LCAicHg7IHRvcDoiKS5jb25jYXQoZWxlbWVudFBvc2l0aW9uLnRvcCwgInB4O2xlZnQ6ICIpLmNvbmNhdChlbGVtZW50UG9zaXRpb24ubGVmdCwgInB4OyIpOwogICAgICAgIG92ZXJsYXlMYXllci5zdHlsZS5jc3NUZXh0ID0gc3R5bGVUZXh0OwogICAgICB9CiAgICB9CgogICAgdGFyZ2V0RWxtLmFwcGVuZENoaWxkKG92ZXJsYXlMYXllcik7CgogICAgb3ZlcmxheUxheWVyLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChzZWxmLl9vcHRpb25zLmV4aXRPbk92ZXJsYXlDbGljayA9PT0gdHJ1ZSkgewogICAgICAgIGV4aXRJbnRyby5jYWxsKHNlbGYsIHRhcmdldEVsbSk7CiAgICAgIH0KICAgIH07CgogICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBzdHlsZVRleHQgKz0gIm9wYWNpdHk6ICIuY29uY2F0KHNlbGYuX29wdGlvbnMub3ZlcmxheU9wYWNpdHkudG9TdHJpbmcoKSwgIjsiKTsKICAgICAgb3ZlcmxheUxheWVyLnN0eWxlLmNzc1RleHQgPSBzdHlsZVRleHQ7CiAgICB9LCAxMCk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgLyoqCiAgICogSW5pdGlhdGUgYSBuZXcgaW50cm9kdWN0aW9uL2d1aWRlIGZyb20gYW4gZWxlbWVudCBpbiB0aGUgcGFnZQogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICogQG1ldGhvZCBfaW50cm9Gb3JFbGVtZW50CiAgICogQHBhcmFtIHtPYmplY3R9IHRhcmdldEVsbQogICAqIEBwYXJhbSB7U3RyaW5nfSBncm91cAogICAqIEByZXR1cm5zIHtCb29sZWFufSBTdWNjZXNzIG9yIG5vdD8KICAgKi8KCgogIGZ1bmN0aW9uIGludHJvRm9yRWxlbWVudCh0YXJnZXRFbG0sIGdyb3VwKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHZhciBhbGxJbnRyb1N0ZXBzID0gdGFyZ2V0RWxtLnF1ZXJ5U2VsZWN0b3JBbGwoIipbZGF0YS1pbnRyb10iKTsKICAgIHZhciBpbnRyb0l0ZW1zID0gW107CgogICAgaWYgKHRoaXMuX29wdGlvbnMuc3RlcHMpIHsKICAgICAgLy91c2Ugc3RlcHMgcGFzc2VkIHByb2dyYW1tYXRpY2FsbHkKICAgICAgZm9yRWFjaCh0aGlzLl9vcHRpb25zLnN0ZXBzLCBmdW5jdGlvbiAoc3RlcCkgewogICAgICAgIHZhciBjdXJyZW50SXRlbSA9IGNsb25lT2JqZWN0KHN0ZXApOyAvL3NldCB0aGUgc3RlcAoKICAgICAgICBjdXJyZW50SXRlbS5zdGVwID0gaW50cm9JdGVtcy5sZW5ndGggKyAxOyAvL3VzZSBxdWVyeVNlbGVjdG9yIGZ1bmN0aW9uIG9ubHkgd2hlbiBkZXZlbG9wZXIgdXNlZCBDU1Mgc2VsZWN0b3IKCiAgICAgICAgaWYgKHR5cGVvZiBjdXJyZW50SXRlbS5lbGVtZW50ID09PSAic3RyaW5nIikgewogICAgICAgICAgLy9ncmFiIHRoZSBlbGVtZW50IHdpdGggZ2l2ZW4gc2VsZWN0b3IgZnJvbSB0aGUgcGFnZQogICAgICAgICAgY3VycmVudEl0ZW0uZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoY3VycmVudEl0ZW0uZWxlbWVudCk7CiAgICAgICAgfSAvL2ludHJvIHdpdGhvdXQgZWxlbWVudAoKCiAgICAgICAgaWYgKHR5cGVvZiBjdXJyZW50SXRlbS5lbGVtZW50ID09PSAidW5kZWZpbmVkIiB8fCBjdXJyZW50SXRlbS5lbGVtZW50ID09PSBudWxsKSB7CiAgICAgICAgICB2YXIgZmxvYXRpbmdFbGVtZW50UXVlcnkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuaW50cm9qc0Zsb2F0aW5nRWxlbWVudCIpOwoKICAgICAgICAgIGlmIChmbG9hdGluZ0VsZW1lbnRRdWVyeSA9PT0gbnVsbCkgewogICAgICAgICAgICBmbG9hdGluZ0VsZW1lbnRRdWVyeSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICBmbG9hdGluZ0VsZW1lbnRRdWVyeS5jbGFzc05hbWUgPSAiaW50cm9qc0Zsb2F0aW5nRWxlbWVudCI7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZmxvYXRpbmdFbGVtZW50UXVlcnkpOwogICAgICAgICAgfQoKICAgICAgICAgIGN1cnJlbnRJdGVtLmVsZW1lbnQgPSBmbG9hdGluZ0VsZW1lbnRRdWVyeTsKICAgICAgICAgIGN1cnJlbnRJdGVtLnBvc2l0aW9uID0gImZsb2F0aW5nIjsKICAgICAgICB9CgogICAgICAgIGN1cnJlbnRJdGVtLnNjcm9sbFRvID0gY3VycmVudEl0ZW0uc2Nyb2xsVG8gfHwgX3RoaXMuX29wdGlvbnMuc2Nyb2xsVG87CgogICAgICAgIGlmICh0eXBlb2YgY3VycmVudEl0ZW0uZGlzYWJsZUludGVyYWN0aW9uID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgY3VycmVudEl0ZW0uZGlzYWJsZUludGVyYWN0aW9uID0gX3RoaXMuX29wdGlvbnMuZGlzYWJsZUludGVyYWN0aW9uOwogICAgICAgIH0KCiAgICAgICAgaWYgKGN1cnJlbnRJdGVtLmVsZW1lbnQgIT09IG51bGwpIHsKICAgICAgICAgIGludHJvSXRlbXMucHVzaChjdXJyZW50SXRlbSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIC8vdXNlIHN0ZXBzIGZyb20gZGF0YS0qIGFubm90YXRpb25zCiAgICAgIHZhciBlbG1zTGVuZ3RoID0gYWxsSW50cm9TdGVwcy5sZW5ndGg7CiAgICAgIHZhciBkaXNhYmxlSW50ZXJhY3Rpb247IC8vaWYgdGhlcmUncyBubyBlbGVtZW50IHRvIGludHJvCgogICAgICBpZiAoZWxtc0xlbmd0aCA8IDEpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGZvckVhY2goYWxsSW50cm9TdGVwcywgZnVuY3Rpb24gKGN1cnJlbnRFbGVtZW50KSB7CiAgICAgICAgLy8gUFIgIzgwCiAgICAgICAgLy8gc3RhcnQgaW50cm8gZm9yIGdyb3VwcyBvZiBlbGVtZW50cwogICAgICAgIGlmIChncm91cCAmJiBjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtaW50cm8tZ3JvdXAiKSAhPT0gZ3JvdXApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9IC8vIHNraXAgaGlkZGVuIGVsZW1lbnRzCgoKICAgICAgICBpZiAoY3VycmVudEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgc3RlcCA9IHBhcnNlSW50KGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1zdGVwIiksIDEwKTsKCiAgICAgICAgaWYgKHR5cGVvZiBjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtZGlzYWJsZS1pbnRlcmFjdGlvbiIpICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgZGlzYWJsZUludGVyYWN0aW9uID0gISFjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtZGlzYWJsZS1pbnRlcmFjdGlvbiIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkaXNhYmxlSW50ZXJhY3Rpb24gPSBfdGhpcy5fb3B0aW9ucy5kaXNhYmxlSW50ZXJhY3Rpb247CiAgICAgICAgfQoKICAgICAgICBpZiAoc3RlcCA+IDApIHsKICAgICAgICAgIGludHJvSXRlbXNbc3RlcCAtIDFdID0gewogICAgICAgICAgICBlbGVtZW50OiBjdXJyZW50RWxlbWVudCwKICAgICAgICAgICAgaW50cm86IGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1pbnRybyIpLAogICAgICAgICAgICBzdGVwOiBwYXJzZUludChjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtc3RlcCIpLCAxMCksCiAgICAgICAgICAgIHRvb2x0aXBDbGFzczogY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLXRvb2x0aXBjbGFzcyIpLAogICAgICAgICAgICBoaWdobGlnaHRDbGFzczogY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLWhpZ2hsaWdodGNsYXNzIiksCiAgICAgICAgICAgIHBvc2l0aW9uOiBjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtcG9zaXRpb24iKSB8fCBfdGhpcy5fb3B0aW9ucy50b29sdGlwUG9zaXRpb24sCiAgICAgICAgICAgIHNjcm9sbFRvOiBjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtc2Nyb2xsdG8iKSB8fCBfdGhpcy5fb3B0aW9ucy5zY3JvbGxUbywKICAgICAgICAgICAgZGlzYWJsZUludGVyYWN0aW9uOiBkaXNhYmxlSW50ZXJhY3Rpb24KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9KTsgLy9uZXh0IGFkZCBpbnRybyBpdGVtcyB3aXRob3V0IGRhdGEtc3RlcAogICAgICAvL3RvZG86IHdlIG5lZWQgYSBjbGVhbnVwIGhlcmUsIHR3byBsb29wcyBhcmUgcmVkdW5kYW50CgogICAgICB2YXIgX25leHRTdGVwID0gMDsKICAgICAgZm9yRWFjaChhbGxJbnRyb1N0ZXBzLCBmdW5jdGlvbiAoY3VycmVudEVsZW1lbnQpIHsKICAgICAgICAvLyBQUiAjODAKICAgICAgICAvLyBzdGFydCBpbnRybyBmb3IgZ3JvdXBzIG9mIGVsZW1lbnRzCiAgICAgICAgaWYgKGdyb3VwICYmIGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1pbnRyby1ncm91cCIpICE9PSBncm91cCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1zdGVwIikgPT09IG51bGwpIHsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW50cm9JdGVtc1tfbmV4dFN0ZXBdID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIF9uZXh0U3RlcCsrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHR5cGVvZiBjdXJyZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtZGlzYWJsZS1pbnRlcmFjdGlvbiIpICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICBkaXNhYmxlSW50ZXJhY3Rpb24gPSAhIWN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1kaXNhYmxlLWludGVyYWN0aW9uIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkaXNhYmxlSW50ZXJhY3Rpb24gPSBfdGhpcy5fb3B0aW9ucy5kaXNhYmxlSW50ZXJhY3Rpb247CiAgICAgICAgICB9CgogICAgICAgICAgaW50cm9JdGVtc1tfbmV4dFN0ZXBdID0gewogICAgICAgICAgICBlbGVtZW50OiBjdXJyZW50RWxlbWVudCwKICAgICAgICAgICAgaW50cm86IGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1pbnRybyIpLAogICAgICAgICAgICBzdGVwOiBfbmV4dFN0ZXAgKyAxLAogICAgICAgICAgICB0b29sdGlwQ2xhc3M6IGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS10b29sdGlwY2xhc3MiKSwKICAgICAgICAgICAgaGlnaGxpZ2h0Q2xhc3M6IGN1cnJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1oaWdobGlnaHRjbGFzcyIpLAogICAgICAgICAgICBwb3NpdGlvbjogY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLXBvc2l0aW9uIikgfHwgX3RoaXMuX29wdGlvbnMudG9vbHRpcFBvc2l0aW9uLAogICAgICAgICAgICBzY3JvbGxUbzogY3VycmVudEVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLXNjcm9sbHRvIikgfHwgX3RoaXMuX29wdGlvbnMuc2Nyb2xsVG8sCiAgICAgICAgICAgIGRpc2FibGVJbnRlcmFjdGlvbjogZGlzYWJsZUludGVyYWN0aW9uCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IC8vcmVtb3ZpbmcgdW5kZWZpbmVkL251bGwgZWxlbWVudHMKCgogICAgdmFyIHRlbXBJbnRyb0l0ZW1zID0gW107CgogICAgZm9yICh2YXIgeiA9IDA7IHogPCBpbnRyb0l0ZW1zLmxlbmd0aDsgeisrKSB7CiAgICAgIGlmIChpbnRyb0l0ZW1zW3pdKSB7CiAgICAgICAgLy8gY29weSBub24tZmFsc3kgdmFsdWVzIHRvIHRoZSBlbmQgb2YgdGhlIGFycmF5CiAgICAgICAgdGVtcEludHJvSXRlbXMucHVzaChpbnRyb0l0ZW1zW3pdKTsKICAgICAgfQogICAgfQoKICAgIGludHJvSXRlbXMgPSB0ZW1wSW50cm9JdGVtczsgLy9Paywgc29ydCBhbGwgaXRlbXMgd2l0aCBnaXZlbiBzdGVwcwoKICAgIGludHJvSXRlbXMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICByZXR1cm4gYS5zdGVwIC0gYi5zdGVwOwogICAgfSk7IC8vc2V0IGl0IHRvIHRoZSBpbnRyb0pzIG9iamVjdAoKICAgIHRoaXMuX2ludHJvSXRlbXMgPSBpbnRyb0l0ZW1zOyAvL2FkZCBvdmVybGF5IGxheWVyIHRvIHRoZSBwYWdlCgogICAgaWYgKGFkZE92ZXJsYXlMYXllci5jYWxsKHRoaXMsIHRhcmdldEVsbSkpIHsKICAgICAgLy90aGVuLCBzdGFydCB0aGUgc2hvdwogICAgICBuZXh0U3RlcC5jYWxsKHRoaXMpOwoKICAgICAgaWYgKHRoaXMuX29wdGlvbnMua2V5Ym9hcmROYXZpZ2F0aW9uKSB7CiAgICAgICAgRE9NRXZlbnQub24od2luZG93LCAia2V5ZG93biIsIG9uS2V5RG93biwgdGhpcywgdHJ1ZSk7CiAgICAgIH0gLy9mb3Igd2luZG93IHJlc2l6ZQoKCiAgICAgIERPTUV2ZW50Lm9uKHdpbmRvdywgInJlc2l6ZSIsIG9uUmVzaXplLCB0aGlzLCB0cnVlKTsKICAgIH0KCiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICB2YXIgdmVyc2lvbiA9ICIzLjAuMSI7CiAgLyoqCiAgICogSW50cm9KcyBtYWluIGNsYXNzCiAgICoKICAgKiBAY2xhc3MgSW50cm9KcwogICAqLwoKICBmdW5jdGlvbiBJbnRyb0pzKG9iaikgewogICAgdGhpcy5fdGFyZ2V0RWxlbWVudCA9IG9iajsKICAgIHRoaXMuX2ludHJvSXRlbXMgPSBbXTsKICAgIHRoaXMuX29wdGlvbnMgPSB7CiAgICAgIC8qIExhYmVsIERpc3BsYXkgdG8gYmUgU2hvd24gaW4gdGhlIGhpZ2hsaWdodGVkIGRpdiAqLwogICAgICBsYWJlbERpc3BsYXk6ICIiLAoKICAgICAgLyogTmV4dCBidXR0b24gbGFiZWwgaW4gdG9vbHRpcCBib3ggKi8KICAgICAgbmV4dExhYmVsOiAiTmV4dCAmcmFycjsiLAoKICAgICAgLyogUHJldmlvdXMgYnV0dG9uIGxhYmVsIGluIHRvb2x0aXAgYm94ICovCiAgICAgIHByZXZMYWJlbDogIiZsYXJyOyBCYWNrIiwKCiAgICAgIC8qIFNraXAgYnV0dG9uIGxhYmVsIGluIHRvb2x0aXAgYm94ICovCiAgICAgIHNraXBMYWJlbDogIlNraXAiLAoKICAgICAgLyogRG9uZSBidXR0b24gbGFiZWwgaW4gdG9vbHRpcCBib3ggKi8KICAgICAgZG9uZUxhYmVsOiAiRG9uZSIsCgogICAgICAvKiBIaWRlIHByZXZpb3VzIGJ1dHRvbiBpbiB0aGUgZmlyc3Qgc3RlcD8gT3RoZXJ3aXNlLCBpdCB3aWxsIGJlIGRpc2FibGVkIGJ1dHRvbi4gKi8KICAgICAgaGlkZVByZXY6IGZhbHNlLAoKICAgICAgLyogSGlkZSBuZXh0IGJ1dHRvbiBpbiB0aGUgbGFzdCBzdGVwPyBPdGhlcndpc2UsIGl0IHdpbGwgYmUgZGlzYWJsZWQgYnV0dG9uLiAqLwogICAgICBoaWRlTmV4dDogZmFsc2UsCgogICAgICAvKiBEZWZhdWx0IHRvb2x0aXAgYm94IHBvc2l0aW9uICovCiAgICAgIHRvb2x0aXBQb3NpdGlvbjogImJvdHRvbSIsCgogICAgICAvKiBOZXh0IENTUyBjbGFzcyBmb3IgdG9vbHRpcCBib3hlcyAqLwogICAgICB0b29sdGlwQ2xhc3M6ICIiLAoKICAgICAgLyogQ1NTIGNsYXNzIHRoYXQgaXMgYWRkZWQgdG8gdGhlIGhlbHBlckxheWVyICovCiAgICAgIGhpZ2hsaWdodENsYXNzOiAiIiwKCiAgICAgIC8qIENsb3NlIGludHJvZHVjdGlvbiB3aGVuIHByZXNzaW5nIEVzY2FwZSBidXR0b24/ICovCiAgICAgIGV4aXRPbkVzYzogdHJ1ZSwKCiAgICAgIC8qIENsb3NlIGludHJvZHVjdGlvbiB3aGVuIGNsaWNraW5nIG9uIG92ZXJsYXkgbGF5ZXI/ICovCiAgICAgIGV4aXRPbk92ZXJsYXlDbGljazogdHJ1ZSwKCiAgICAgIC8qIFNob3cgc3RlcCBudW1iZXJzIGluIGludHJvZHVjdGlvbj8gKi8KICAgICAgc2hvd1N0ZXBOdW1iZXJzOiB0cnVlLAoKICAgICAgLyogTGV0IHVzZXIgdXNlIGtleWJvYXJkIHRvIG5hdmlnYXRlIHRoZSB0b3VyPyAqLwogICAgICBrZXlib2FyZE5hdmlnYXRpb246IHRydWUsCgogICAgICAvKiBTaG93IHRvdXIgY29udHJvbCBidXR0b25zPyAqLwogICAgICBzaG93QnV0dG9uczogdHJ1ZSwKCiAgICAgIC8qIFNob3cgdG91ciBidWxsZXRzPyAqLwogICAgICBzaG93QnVsbGV0czogdHJ1ZSwKCiAgICAgIC8qIFNob3cgdG91ciBwcm9ncmVzcz8gKi8KICAgICAgc2hvd1Byb2dyZXNzOiBmYWxzZSwKCiAgICAgIC8qIFNjcm9sbCB0byBoaWdobGlnaHRlZCBlbGVtZW50PyAqLwogICAgICBzY3JvbGxUb0VsZW1lbnQ6IHRydWUsCgogICAgICAvKgogICAgICAgKiBTaG91bGQgd2Ugc2Nyb2xsIHRoZSB0b29sdGlwIG9yIHRhcmdldCBlbGVtZW50PwogICAgICAgKgogICAgICAgKiBPcHRpb25zIGFyZTogJ2VsZW1lbnQnIG9yICd0b29sdGlwJwogICAgICAgKi8KICAgICAgc2Nyb2xsVG86ICJlbGVtZW50IiwKCiAgICAgIC8qIFBhZGRpbmcgdG8gYWRkIGFmdGVyIHNjcm9sbGluZyB3aGVuIGVsZW1lbnQgaXMgbm90IGluIHRoZSB2aWV3cG9ydCAoaW4gcGl4ZWxzKSAqLwogICAgICBzY3JvbGxQYWRkaW5nOiAzMCwKCiAgICAgIC8qIFNldCB0aGUgb3ZlcmxheSBvcGFjaXR5ICovCiAgICAgIG92ZXJsYXlPcGFjaXR5OiAwLjgsCgogICAgICAvKiBQcmVjZWRlbmNlIG9mIHBvc2l0aW9ucywgd2hlbiBhdXRvIGlzIGVuYWJsZWQgKi8KICAgICAgcG9zaXRpb25QcmVjZWRlbmNlOiBbImJvdHRvbSIsICJ0b3AiLCAicmlnaHQiLCAibGVmdCJdLAoKICAgICAgLyogRGlzYWJsZSBhbiBpbnRlcmFjdGlvbiB3aXRoIGVsZW1lbnQ/ICovCiAgICAgIGRpc2FibGVJbnRlcmFjdGlvbjogZmFsc2UsCgogICAgICAvKiBTZXQgaG93IG11Y2ggcGFkZGluZyB0byBiZSB1c2VkIGFyb3VuZCBoZWxwZXIgZWxlbWVudCAqLwogICAgICBoZWxwZXJFbGVtZW50UGFkZGluZzogMTAsCgogICAgICAvKiBEZWZhdWx0IGhpbnQgcG9zaXRpb24gKi8KICAgICAgaGludFBvc2l0aW9uOiAidG9wLW1pZGRsZSIsCgogICAgICAvKiBIaW50IGJ1dHRvbiBsYWJlbCAqLwogICAgICBoaW50QnV0dG9uTGFiZWw6ICJHb3QgaXQiLAoKICAgICAgLyogQWRkaW5nIGFuaW1hdGlvbiB0byBoaW50cz8gKi8KICAgICAgaGludEFuaW1hdGlvbjogdHJ1ZSwKCiAgICAgIC8qIGFkZGl0aW9uYWwgY2xhc3NlcyB0byBwdXQgb24gdGhlIGJ1dHRvbnMgKi8KICAgICAgYnV0dG9uQ2xhc3M6ICJpbnRyb2pzLWJ1dHRvbiIKICAgIH07CiAgfQoKICB2YXIgaW50cm9KcyA9IGZ1bmN0aW9uIGludHJvSnModGFyZ2V0RWxtKSB7CiAgICB2YXIgaW5zdGFuY2U7CgogICAgaWYgKF90eXBlb2YodGFyZ2V0RWxtKSA9PT0gIm9iamVjdCIpIHsKICAgICAgLy9PaywgY3JlYXRlIGEgbmV3IGluc3RhbmNlCiAgICAgIGluc3RhbmNlID0gbmV3IEludHJvSnModGFyZ2V0RWxtKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHRhcmdldEVsbSA9PT0gInN0cmluZyIpIHsKICAgICAgLy9zZWxlY3QgdGhlIHRhcmdldCBlbGVtZW50IHdpdGggcXVlcnkgc2VsZWN0b3IKICAgICAgdmFyIHRhcmdldEVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHRhcmdldEVsbSk7CgogICAgICBpZiAodGFyZ2V0RWxlbWVudCkgewogICAgICAgIGluc3RhbmNlID0gbmV3IEludHJvSnModGFyZ2V0RWxlbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGVyZSBpcyBubyBlbGVtZW50IHdpdGggZ2l2ZW4gc2VsZWN0b3IuIik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGluc3RhbmNlID0gbmV3IEludHJvSnMoZG9jdW1lbnQuYm9keSk7CiAgICB9IC8vIGFkZCBpbnN0YW5jZSB0byBsaXN0IG9mIF9pbnN0YW5jZXMKICAgIC8vIHBhc3NpbmcgZ3JvdXAgdG8gc3RhbXAgdG8gaW5jcmVtZW50CiAgICAvLyBmcm9tIDAgb253YXJkIHNvbWV3aGF0IHJlbGlhYmx5CgoKICAgIGludHJvSnMuaW5zdGFuY2VzW3N0YW1wKGluc3RhbmNlLCAiaW50cm9qcy1pbnN0YW5jZSIpXSA9IGluc3RhbmNlOwogICAgcmV0dXJuIGluc3RhbmNlOwogIH07CiAgLyoqCiAgICogQ3VycmVudCBJbnRyb0pzIHZlcnNpb24KICAgKgogICAqIEBwcm9wZXJ0eSB2ZXJzaW9uCiAgICogQHR5cGUgU3RyaW5nCiAgICovCgoKICBpbnRyb0pzLnZlcnNpb24gPSB2ZXJzaW9uOwogIC8qKgogICAqIGtleS12YWwgb2JqZWN0IGhlbHBlciBmb3IgaW50cm9KcyBpbnN0YW5jZXMKICAgKgogICAqIEBwcm9wZXJ0eSBpbnN0YW5jZXMKICAgKiBAdHlwZSBPYmplY3QKICAgKi8KCiAgaW50cm9Kcy5pbnN0YW5jZXMgPSB7fTsgLy9Qcm90b3R5cGUKCiAgaW50cm9Kcy5mbiA9IEludHJvSnMucHJvdG90eXBlID0gewogICAgY2xvbmU6IGZ1bmN0aW9uIGNsb25lKCkgewogICAgICByZXR1cm4gbmV3IEludHJvSnModGhpcyk7CiAgICB9LAogICAgc2V0T3B0aW9uOiBmdW5jdGlvbiBzZXRPcHRpb24ob3B0aW9uLCB2YWx1ZSkgewogICAgICB0aGlzLl9vcHRpb25zW29wdGlvbl0gPSB2YWx1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgc2V0T3B0aW9uczogZnVuY3Rpb24gc2V0T3B0aW9ucyhvcHRpb25zKSB7CiAgICAgIHRoaXMuX29wdGlvbnMgPSBtZXJnZU9wdGlvbnModGhpcy5fb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHN0YXJ0OiBmdW5jdGlvbiBzdGFydChncm91cCkgewogICAgICBpbnRyb0ZvckVsZW1lbnQuY2FsbCh0aGlzLCB0aGlzLl90YXJnZXRFbGVtZW50LCBncm91cCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGdvVG9TdGVwOiBmdW5jdGlvbiBnb1RvU3RlcCQxKHN0ZXApIHsKICAgICAgZ29Ub1N0ZXAuY2FsbCh0aGlzLCBzdGVwKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgYWRkU3RlcDogZnVuY3Rpb24gYWRkU3RlcChvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy5fb3B0aW9ucy5zdGVwcykgewogICAgICAgIHRoaXMuX29wdGlvbnMuc3RlcHMgPSBbXTsKICAgICAgfQoKICAgICAgdGhpcy5fb3B0aW9ucy5zdGVwcy5wdXNoKG9wdGlvbnMpOwoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgYWRkU3RlcHM6IGZ1bmN0aW9uIGFkZFN0ZXBzKHN0ZXBzKSB7CiAgICAgIGlmICghc3RlcHMubGVuZ3RoKSByZXR1cm47CgogICAgICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgc3RlcHMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgdGhpcy5hZGRTdGVwKHN0ZXBzW2luZGV4XSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGdvVG9TdGVwTnVtYmVyOiBmdW5jdGlvbiBnb1RvU3RlcE51bWJlciQxKHN0ZXApIHsKICAgICAgZ29Ub1N0ZXBOdW1iZXIuY2FsbCh0aGlzLCBzdGVwKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgbmV4dFN0ZXA6IGZ1bmN0aW9uIG5leHRTdGVwJDEoKSB7CiAgICAgIG5leHRTdGVwLmNhbGwodGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHByZXZpb3VzU3RlcDogZnVuY3Rpb24gcHJldmlvdXNTdGVwJDEoKSB7CiAgICAgIHByZXZpb3VzU3RlcC5jYWxsKHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBjdXJyZW50U3RlcDogZnVuY3Rpb24gY3VycmVudFN0ZXAkMSgpIHsKICAgICAgcmV0dXJuIGN1cnJlbnRTdGVwLmNhbGwodGhpcyk7CiAgICB9LAogICAgZXhpdDogZnVuY3Rpb24gZXhpdChmb3JjZSkgewogICAgICBleGl0SW50cm8uY2FsbCh0aGlzLCB0aGlzLl90YXJnZXRFbGVtZW50LCBmb3JjZSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2gkMSgpIHsKICAgICAgcmVmcmVzaC5jYWxsKHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBvbmJlZm9yZWNoYW5nZTogZnVuY3Rpb24gb25iZWZvcmVjaGFuZ2UocHJvdmlkZWRDYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHByb3ZpZGVkQ2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB0aGlzLl9pbnRyb0JlZm9yZUNoYW5nZUNhbGxiYWNrID0gcHJvdmlkZWRDYWxsYmFjazsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlByb3ZpZGVkIGNhbGxiYWNrIGZvciBvbmJlZm9yZWNoYW5nZSB3YXMgbm90IGEgZnVuY3Rpb24iKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgb25jaGFuZ2U6IGZ1bmN0aW9uIG9uY2hhbmdlKHByb3ZpZGVkQ2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwcm92aWRlZENhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhpcy5faW50cm9DaGFuZ2VDYWxsYmFjayA9IHByb3ZpZGVkQ2FsbGJhY2s7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQcm92aWRlZCBjYWxsYmFjayBmb3Igb25jaGFuZ2Ugd2FzIG5vdCBhIGZ1bmN0aW9uLiIpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBvbmFmdGVyY2hhbmdlOiBmdW5jdGlvbiBvbmFmdGVyY2hhbmdlKHByb3ZpZGVkQ2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwcm92aWRlZENhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhpcy5faW50cm9BZnRlckNoYW5nZUNhbGxiYWNrID0gcHJvdmlkZWRDYWxsYmFjazsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlByb3ZpZGVkIGNhbGxiYWNrIGZvciBvbmFmdGVyY2hhbmdlIHdhcyBub3QgYSBmdW5jdGlvbiIpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBvbmNvbXBsZXRlOiBmdW5jdGlvbiBvbmNvbXBsZXRlKHByb3ZpZGVkQ2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwcm92aWRlZENhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhpcy5faW50cm9Db21wbGV0ZUNhbGxiYWNrID0gcHJvdmlkZWRDYWxsYmFjazsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlByb3ZpZGVkIGNhbGxiYWNrIGZvciBvbmNvbXBsZXRlIHdhcyBub3QgYSBmdW5jdGlvbi4iKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgb25oaW50c2FkZGVkOiBmdW5jdGlvbiBvbmhpbnRzYWRkZWQocHJvdmlkZWRDYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHByb3ZpZGVkQ2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB0aGlzLl9oaW50c0FkZGVkQ2FsbGJhY2sgPSBwcm92aWRlZENhbGxiYWNrOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiUHJvdmlkZWQgY2FsbGJhY2sgZm9yIG9uaGludHNhZGRlZCB3YXMgbm90IGEgZnVuY3Rpb24uIik7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIG9uaGludGNsaWNrOiBmdW5jdGlvbiBvbmhpbnRjbGljayhwcm92aWRlZENhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvdmlkZWRDYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMuX2hpbnRDbGlja0NhbGxiYWNrID0gcHJvdmlkZWRDYWxsYmFjazsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlByb3ZpZGVkIGNhbGxiYWNrIGZvciBvbmhpbnRjbGljayB3YXMgbm90IGEgZnVuY3Rpb24uIik7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIG9uaGludGNsb3NlOiBmdW5jdGlvbiBvbmhpbnRjbG9zZShwcm92aWRlZENhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvdmlkZWRDYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMuX2hpbnRDbG9zZUNhbGxiYWNrID0gcHJvdmlkZWRDYWxsYmFjazsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlByb3ZpZGVkIGNhbGxiYWNrIGZvciBvbmhpbnRjbG9zZSB3YXMgbm90IGEgZnVuY3Rpb24uIik7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIG9uZXhpdDogZnVuY3Rpb24gb25leGl0KHByb3ZpZGVkQ2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwcm92aWRlZENhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhpcy5faW50cm9FeGl0Q2FsbGJhY2sgPSBwcm92aWRlZENhbGxiYWNrOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiUHJvdmlkZWQgY2FsbGJhY2sgZm9yIG9uZXhpdCB3YXMgbm90IGEgZnVuY3Rpb24uIik7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIG9uc2tpcDogZnVuY3Rpb24gb25za2lwKHByb3ZpZGVkQ2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwcm92aWRlZENhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhpcy5faW50cm9Ta2lwQ2FsbGJhY2sgPSBwcm92aWRlZENhbGxiYWNrOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiUHJvdmlkZWQgY2FsbGJhY2sgZm9yIG9uc2tpcCB3YXMgbm90IGEgZnVuY3Rpb24uIik7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIG9uYmVmb3JlZXhpdDogZnVuY3Rpb24gb25iZWZvcmVleGl0KHByb3ZpZGVkQ2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwcm92aWRlZENhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhpcy5faW50cm9CZWZvcmVFeGl0Q2FsbGJhY2sgPSBwcm92aWRlZENhbGxiYWNrOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiUHJvdmlkZWQgY2FsbGJhY2sgZm9yIG9uYmVmb3JlZXhpdCB3YXMgbm90IGEgZnVuY3Rpb24uIik7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGFkZEhpbnRzOiBmdW5jdGlvbiBhZGRIaW50cygpIHsKICAgICAgcG9wdWxhdGVIaW50cy5jYWxsKHRoaXMsIHRoaXMuX3RhcmdldEVsZW1lbnQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBoaWRlSGludDogZnVuY3Rpb24gaGlkZUhpbnQkMShzdGVwSWQpIHsKICAgICAgaGlkZUhpbnQuY2FsbCh0aGlzLCBzdGVwSWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBoaWRlSGludHM6IGZ1bmN0aW9uIGhpZGVIaW50cyQxKCkgewogICAgICBoaWRlSGludHMuY2FsbCh0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgc2hvd0hpbnQ6IGZ1bmN0aW9uIHNob3dIaW50JDEoc3RlcElkKSB7CiAgICAgIHNob3dIaW50LmNhbGwodGhpcywgc3RlcElkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgc2hvd0hpbnRzOiBmdW5jdGlvbiBzaG93SGludHMkMSgpIHsKICAgICAgc2hvd0hpbnRzLmNhbGwodGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHJlbW92ZUhpbnRzOiBmdW5jdGlvbiByZW1vdmVIaW50cyQxKCkgewogICAgICByZW1vdmVIaW50cy5jYWxsKHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICByZW1vdmVIaW50OiBmdW5jdGlvbiByZW1vdmVIaW50JDEoc3RlcElkKSB7CiAgICAgIHJlbW92ZUhpbnQoKS5jYWxsKHRoaXMsIHN0ZXBJZCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHNob3dIaW50RGlhbG9nOiBmdW5jdGlvbiBzaG93SGludERpYWxvZyQxKHN0ZXBJZCkgewogICAgICBzaG93SGludERpYWxvZy5jYWxsKHRoaXMsIHN0ZXBJZCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH07CiAgcmV0dXJuIGludHJvSnM7Cn0pOw=="},null]}