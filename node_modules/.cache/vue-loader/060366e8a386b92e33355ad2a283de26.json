{"remainingRequest":"/home/vimalesh/CENSE/chatbot-portal/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/vimalesh/CENSE/chatbot-portal/src/portal/Chatbot/Dashboard/HR Management/HrScheduler.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/vimalesh/CENSE/chatbot-portal/src/portal/Chatbot/Dashboard/HR Management/HrScheduler.vue","mtime":1655466542524},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCmltcG9ydCBhcGlfY2FsbHMgZnJvbSAiQC9wb3J0YWwvYXBpX2NhbGxzIjsKaW1wb3J0IGF4aW9zIGZyb20gImF4aW9zIjsKaW1wb3J0IG1vbWVudCBmcm9tICJtb21lbnQiOwppbXBvcnQgc3dhbCBmcm9tICJzd2VldGFsZXJ0MiI7Ci8vIGltcG9ydCBUaW1lUGlja2VyIGZyb20gImFudC1kZXNpZ24tdnVlL2xpYi90aW1lLXBpY2tlciI7CmltcG9ydCBDYWxlbmRhciBmcm9tICIuLi8uLi8uLi8uLi8uLi9wdWJsaWMvanMvdHVpLWNhbGVuZGFyLm1pbi5qcyI7CmltcG9ydCBEYXRlUGlja2VyIGZyb20gInR1aS1kYXRlLXBpY2tlciI7CmltcG9ydCAidHVpLWRhdGUtcGlja2VyL2Rpc3QvdHVpLWRhdGUtcGlja2VyLmNzcyI7CmltcG9ydCAiLi4vLi4vLi4vLi4vLi4vcHVibGljL2Nzcy9zZWdvZS11aS5jc3MiCmltcG9ydCAiLi4vLi4vLi4vLi4vLi4vcHVibGljL2Nzcy90dWktY2FsZW5kYXIubWluLmNzcyI7CmV4cG9ydCBkZWZhdWx0IHsKICBuYW1lOiAiSW50ZXJ2aWV3IFNjaGVkdWxlciIsCiAgZGF0YSAoKSB7CiAgICByZXR1cm4gewogICAgICBjYWxlbmRhckluc3RhbmNlOiBudWxsLAogICAgICBjdXJyZW50X2NhbGVuZGFyX3ZpZXc6ICdkYXknLAogICAgICBzaG93X3NwaW5uZXI6IGZhbHNlLAogICAgICBzZWxlY3RlZF90aW1lOiAiIiwKICAgICAgZGlzcGxheV9zZWxlY3RlZF90aW1lOiAiIiwKICAgICAgc2NoZWR1bGVkX3RpbWU6ICIiLAogICAgICBzZWxlY3RlZF9kYXRlOiAiIiwKICAgICAgY2FuZGlkYXRlX25hbWU6ICIiLAogICAgICB2aXNpdG9yX251bWJlcjogIiIsCiAgICAgIGNhbmRpZGF0ZV9wb3NpdGlvbjogIiIsCiAgICAgIGNhbmRpZGF0ZV9lbWFpbDogIiIsCiAgICAgIHNjaGVkdWxlX2xpc3Q6IFtdLAogICAgICBzZWxlY3RlZF9zY2hlZHVsZV9pZDogIiIsCiAgICAgIHNlbGVjdGVkX3NjaGVkdWxlX3Zpc2l0X3Nsb3Q6ICIiLAogICAgICBpc0VkaXQ6IGZhbHNlLAogICAgICBzcGlubmVyT246IGZhbHNlLAogICAgICBwaG9uZV9udW1iZXJfdmFsaWRpdHk6IC9cK1swLTldezksMTR9JC8sCiAgICAgIGZ1bGxfdGltZV9zbG90czogW10sCiAgICAgIHRpbWVfc2xvdHM6IFtdLAogICAgICB3b3JraW5nX2hyczogewogICAgICAgICAgICAiTW9uZGF5IiA6IFsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBdLAogICAgICAgICAgICAiVHVlc2RheSIgOiBbCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgXSwKICAgICAgICAgICAgIldlZG5lc2RheSIgOiBbCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgXSwKICAgICAgICAgICAgIlRodXJzZGF5IiA6IFsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBdLAogICAgICAgICAgICAiRnJpZGF5IiA6IFsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBdLAogICAgICAgICAgICAiU2F0dXJkYXkiIDogWwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgICJTdW5kYXkiIDogWwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIF0KICAgICAgICB9LAogICAgICBzZWxlY3RlZF90aW1lX3Nsb3Q6ICIiLAogICAgICBidWZmZXJfdGltZV9wZXJpb2Q6ICIiLAogICAgICBtaW5pbXVtX25vdGljZV9kYXlzOiAiIiwKICAgICAgbWVldGluZ19kYXlzX3JhbmdlOiAiIiwKICAgICAgdXNlcl9yb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgc2NoZWR1bGluZ19jb250YWN0X251bWJlcjogIiIsCiAgICAgIGZpbGVfbGFiZWw6ICJDaG9vc2UgRmlsZSIsCiAgICAgIHdlZWtfZGF5czogWwogICAgICAgICJNb25kYXkiLAogICAgICAgICJUdWVzZGF5IiwKICAgICAgICAiV2VkbmVzZGF5IiwKICAgICAgICAiVGh1cnNkYXkiLAogICAgICAgICJGcmlkYXkiLAogICAgICAgICJTYXR1cmRheSIsCiAgICAgICAgIlN1bmRheSIKICAgICAgXSwKICAgICAgZGF5c0luTW9udGg6IFtdLAogICAgICBhY3RpdmVNb250aFllYXI6ICcnLAogICAgICBjc3ZfZmlsZTogIiIsCiAgICAgIHNob3dfY2hlY2tfYW5kX2NoYW5nZV9zdGF0dXM6IHRydWUsCiAgICAgIHVzZXJfdHlwZTogbnVsbCwKICAgICAgdmlzaXRfc3RhdHVzX2RhdGE6IG51bGwsCiAgICAgIHZpc2l0X3N0YXR1c19jb21wYXJpc29uX2RhdGE6IFtdLAogICAgICBkYWlseV9kYXRlOiAiIiwKICAgICAgaXNSZXNjaGVkdWxlOiB0cnVlLAogICAgICBkYXRlcGlja2VySW5zdGFuY2U6IG51bGwsCiAgICAgIG5ld19zZWxlY3RlZF9kYXRlOiAiIiwKICAgICAgZWRpdF9zY2hlZHVsaW5nOiBmYWxzZSwKICAgICAgdGVtcF9kYXRhOiAiIiwKICAgICAgaXNBcHBvaW50bWVudENvbmZpcm1lZDogZmFsc2UsCiAgICAgIGFwcG9pbnRtZW50U3RhdHVzOiAiIiwKICAgICAgdmlzaXRTdGF0dXM6ICIiLAogICAgICBBcHBvaW50bWVudElEOiAnJywKICAgICAgaXNSZXNjaGVkdWxldGltZTogZmFsc2UsCiAgICAgIHRlbXBfbmFtZTogIiIsCiAgICAgIHRlbXBfcG9zaXRpb246ICIiLAogICAgICB0ZW1wX2VtYWlsOiAiIiwKICAgICAgdGVtcF9hcHBvaW50bWVudF9kYXRlOiAiIiwKICAgICAgdGVtcF9hcHBvaW50bWVudF90aW1lOiAiIiwKICAgICAgdGVtcF90aW1lX3Nsb3RzOiBbXSwKICAgICAgY29tcGFueWlkOiAiIiwKICAgICAgY29tcGFueW5hbWU6ICIiLAogICAgICBzdXBwb3J0X251bWJlcnNfbGlzdDogW10sCiAgICAgIGZpbGxlZF90aW1lX3Nsb3RzX3NlbGVjdGVkX2RhdGU6W10KICAgIH07CiAgfSwKICBjb21wb25lbnRzOiB7CiAgICAvLyBUaW1lUGlja2VyCiAgfSwKICBjb21wdXRlZDogewogICAgdmFsaWRQaG9uZU51bWJlciAoKSB7CiAgICAgIGlmICh0aGlzLnBob25lX251bWJlcl92YWxpZGl0eS50ZXN0KHRoaXMuc2NoZWR1bGluZ19jb250YWN0X251bWJlci5yZXBsYWNlKC9ccysvZywgJycpKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAiUGxlYXNlIGVudGVyIGEgdmFsaWQgcGhvbmUgbnVtYmVyIGluIHRoZSBmb3JtYXQ6ICtDb3VudHJ5Q29kZSBOdW1iZXIiOwogICAgICB9CiAgICB9LAogICAgY3JlYXRlTW9kYWxUaXRsZSAoKSB7CiAgICAgIHJldHVybiB0aGlzLmNhbmRpZGF0ZV9uYW1lLnNwbGl0KCcgJykuc2xpY2UoMCwgMSkubWFwKHdvcmQgPT4gd29yZC5jaGFyQXQoMCkpLmpvaW4oJycpLnRvVXBwZXJDYXNlKCkKICAgIH0sCiAgICB0aW1lU2xvdHNMaXN0ICgpIHsKICAgICAgbGV0IGxpc3QgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gMjM7IGkgKz0gMSkgewogICAgICAgIGxpc3QucHVzaCh7CiAgICAgICAgICBkaXNwbGF5OiBtb21lbnQoaSwgWydoJ10pLmZvcm1hdCgnaDptbSBBJyksCiAgICAgICAgICB2YWx1ZTogbW9tZW50KGksIFsnaCddKS5mb3JtYXQoJ0g6bW0nKQogICAgICAgIH0pCiAgICAgIH0KICAgICAgcmV0dXJuIGxpc3Q7CiAgICB9CiAgfSwKICB3YXRjaDogewogICAgY3VycmVudF9jYWxlbmRhcl92aWV3IChuZXdWYWwpIHsKICAgICAgdGhpcy50b2dnbGVfdmlldyhuZXdWYWwpCiAgICB9CiAgfSwKICBtb3VudGVkICgpIHsKICAgIHRoaXMuc2hvd19zcGlubmVyID0gdHJ1ZTsKICAgIHZhciB2bSA9IHRoaXM7CiAgICB0aGlzLmNhbGVuZGFySW5zdGFuY2UgPSBuZXcgQ2FsZW5kYXIoIiNjYWxlbmRhciIsIHsKICAgICAgZGVmYXVsdFZpZXc6ICJkYXkiLAogICAgICB0YXNrVmlldzogZmFsc2UsCiAgICAgIHNjaGVkdWxlVmlldzogWyJ0aW1lIl0sCiAgICAgIHRoZW1lOiB7CiAgICAgICAgJ21vbnRoLmRheW5hbWUudGV4dEFsaWduJzogJ2NlbnRlcicsCiAgICAgICAgJ21vbnRoLmRheW5hbWUudGV4dFRyYW5zZm9ybSc6ICd1cHBlcmNhc2UnLAogICAgICAgICd3ZWVrLmRheW5hbWUuYm9yZGVyTGVmdCc6ICcxcHggc29saWQgI0RGREZERicsCiAgICAgICAgJ21vbnRoLnNjaGVkdWxlLmJvcmRlclJhZGl1cyc6ICcycHgnLAogICAgICAgICdtb250aC5zY2hlZHVsZS5tYXJnaW5Ub3AnOiAnMnB4JywKICAgICAgICAnbW9udGguc2NoZWR1bGUubWFyZ2luTGVmdCc6ICc4cHgnLAogICAgICAgICdtb250aC5zY2hlZHVsZS5tYXJnaW5SaWdodCc6ICc4cHgnLAogICAgICAgICd3ZWVrLmRheWdyaWQuYmFja2dyb3VuZENvbG9yJzogJ25vbmUnLAogICAgICAgICd3ZWVrLmRheW5hbWUudGV4dEFsaWduJzogJ2NlbnRlcicsCiAgICAgICAgJ3dlZWsuZGF5bmFtZS50ZXh0VHJhbnNmb3JtJzogJ3VwcGVyY2FzZScsCiAgICAgICAgJ3dlZWsudGltZWdyaWRIb3Jpem9udGFsTGluZS5ib3JkZXJCb3R0b20nOiAnMXB4IGRhc2hlZCAjRjFGMUYxJywKICAgICAgICAnd2Vlay50aW1lZ3JpZC5ib3JkZXJSaWdodCc6ICcxcHggc29saWQgI0RGREZERicsCiAgICAgIH0sCiAgICAgIHRlbXBsYXRlOiB7CiAgICAgICAgbW9udGhHcmlkSGVhZGVyOiBmdW5jdGlvbiAoZGF5TW9kZWwpIHsKICAgICAgICAgIHZhciBkYXRlID0gbW9tZW50KGRheU1vZGVsLmRhdGUsIFsnWVlZWS1NTS1ERCddKS5mb3JtYXQoJ0REJyk7CiAgICAgICAgICB2YXIgY2xhc3NOYW1lcyA9IFsndHVpLWZ1bGwtY2FsZW5kYXItd2Vla2RheS1ncmlkLWRhdGUgJ107CgogICAgICAgICAgaWYgKGRheU1vZGVsLmlzVG9kYXkpIHsKICAgICAgICAgICAgY2xhc3NOYW1lcy5wdXNoKCd0dWktZnVsbC1jYWxlbmRhci13ZWVrZGF5LWdyaWQtZGF0ZS1kZWNvcmF0b3InKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPSInICsgY2xhc3NOYW1lcy5qb2luKCcgJykgKyAnIj4nICsgZGF0ZSArICc8L3NwYW4+JzsKICAgICAgICB9LAogICAgICAgIG1vbnRoRGF5bmFtZTogZnVuY3Rpb24gKG1vZGVsKSB7CiAgICAgICAgICByZXR1cm4gYDxzcGFuIHN0eWxlPSJjb2xvcjojOTU5NTk1Ij4keyhtb2RlbC5sYWJlbCkudG9TdHJpbmcoKS50b0xvY2FsZVVwcGVyQ2FzZSgpfTwvc3Bhbj5gOwogICAgICAgIH0sCiAgICAgICAgd2Vla0RheW5hbWU6IGZ1bmN0aW9uIChtb2RlbCkgewogICAgICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz0idHVpLWZ1bGwtY2FsZW5kYXItZGF5bmFtZS1kYXRlIj48L3NwYW4+Jm5ic3A7Jm5ic3A7PHNwYW4gY2xhc3M9InR1aS1mdWxsLWNhbGVuZGFyLWRheW5hbWUtbmFtZSI+JyArIG1vZGVsLmRheU5hbWUudG9Mb2NhbGVVcHBlckNhc2UoKSArICc8L3NwYW4+JzsKICAgICAgICB9LAogICAgICB9LAogICAgICB1c2VDcmVhdGlvblBvcHVwOiBmYWxzZSwKICAgICAgdXNlRGV0YWlsUG9wdXA6IGZhbHNlCiAgICB9KTsKICAgIHRoaXMuY3VycmVudF9jYWxlbmRhcl92aWV3ID0gImRheSIKICAgIHRoaXMuY2FsZW5kYXJJbnN0YW5jZS5vbigiY2xpY2tEYXluYW1lIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKHZtLmNhbGVuZGFySW5zdGFuY2UuZ2V0Vmlld05hbWUoKSA9PT0gIndlZWsiKSB7CiAgICAgICAgdm0uY2FsZW5kYXJJbnN0YW5jZS5zZXREYXRlKG5ldyBEYXRlKGUuZGF0ZSkpOwogICAgICAgIHZtLmNhbGVuZGFySW5zdGFuY2UuY2hhbmdlVmlldygiZGF5IiwgdHJ1ZSk7CiAgICAgICAgdGhpcy5jdXJyZW50X2NhbGVuZGFyX3ZpZXcgPSAiZGF5IgogICAgICAgIHZtLnNldFJlbmRlclJhbmdlVGV4dCgpOwogICAgICB9CiAgICB9KTsKICAgIHRoaXMuY2FsZW5kYXJJbnN0YW5jZS5vbigiYWZ0ZXJSZW5kZXJTY2hlZHVsZSIsIGZ1bmN0aW9uIChlKSB7CiAgICB9KTsKICAgIHRoaXMuc2V0UmVuZGVyUmFuZ2VUZXh0KCk7CiAgICB0aGlzLmNhbGVuZGFySW5zdGFuY2Uub24oImJlZm9yZUNyZWF0ZVNjaGVkdWxlIiwgZSA9PiB7CiAgICAgIHRoaXMubmV3X3NjaGVkdWxlKGUuc3RhcnQuX2RhdGUpOwogICAgICBlLmd1aWRlLmNsZWFyR3VpZGVFbGVtZW50KCk7CiAgICB9KTsKICAgIHRoaXMuY2FsZW5kYXJJbnN0YW5jZS5vbigiY2xpY2tTY2hlZHVsZSIsIGZ1bmN0aW9uIChldmVudCkgewogICAgICBpZiAoZXZlbnQuc2NoZWR1bGUucmF3LmlzSG9saWRheSkgewogICAgICAgIHRvYXN0ci5lcnJvcigKICAgICAgICAgICJZb3UgY2Fubm90IGVudGVyIGEgc2NoZWR1bGUgZm9yIHRoaXMgZGF0ZS4gXG4gUmVhc29uOiAiICsKICAgICAgICAgIGV2ZW50LnNjaGVkdWxlLnJhdy5yZWFzb24KICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBzY2hlZHVsZSA9IGV2ZW50LnNjaGVkdWxlOwogICAgICAgIHZtLmNhbmRpZGF0ZV9uYW1lID0gc2NoZWR1bGUudGl0bGU7CiAgICAgICAgdm0uY2FuZGlkYXRlX3Bvc2l0aW9uID0gc2NoZWR1bGUucmF3LmNhbmRpZGF0ZV9wb3NpdGlvbjsKICAgICAgICB2bS5jYW5kaWRhdGVfZW1haWwgPSBzY2hlZHVsZS5yYXcuY2FuZGlkYXRlX2VtYWlsOwogICAgICAgIHZtLnZpc2l0b3JfbnVtYmVyID0gc2NoZWR1bGUucmF3LnBob25lX251bWJlcjsKICAgICAgICBsZXQgc2VsZWN0ZWRfdGltZSA9CiAgICAgICAgICBzY2hlZHVsZS5yYXcuc3RhcnQgKyAiLSIgKyBzY2hlZHVsZS5yYXcuZW5kOwogICAgICAgIGxldCBzZWxlY3RlZF90aW1lX3N0YXJ0ID0gbW9tZW50KHNjaGVkdWxlLnJhdy5zdGFydCwgWydISDptbSddKS5mb3JtYXQoJ2hoOm1tIEEnKTsKICAgICAgICBsZXQgc2VsZWN0ZWRfdGltZV9lbmQgPSBtb21lbnQoc2NoZWR1bGUucmF3LmVuZCwgWydISDptbSddKS5mb3JtYXQoJ2hoOm1tIEEnKTsKICAgICAgICB2bS5kaXNwbGF5X3NlbGVjdGVkX3RpbWUgPSBgJHtzZWxlY3RlZF90aW1lX3N0YXJ0fSAtICR7c2VsZWN0ZWRfdGltZV9lbmR9YDsKICAgICAgICB2bS5zZWxlY3RlZF9zY2hlZHVsZV9pZCA9IHNjaGVkdWxlLmlkOwogICAgICAgIHZtLnNlbGVjdGVkX3NjaGVkdWxlX3Zpc2l0X3Nsb3QgPSBzY2hlZHVsZS5yYXcudmlzaXRfc2xvdDsKICAgICAgICB2bS5nZXRfdGltZV9zbG90cygKICAgICAgICAgIHNjaGVkdWxlLnN0YXJ0Ll9kYXRlLAogICAgICAgICAgIiNzY2hlZHVsZV9kZXRhaWxzIiwKICAgICAgICAgIHNlbGVjdGVkX3RpbWUKICAgICAgICApOwogICAgICAgIHZtLmFwcG9pbnRtZW50U3RhdHVzID0gc2NoZWR1bGUucmF3LmFwcG9pbnRtZW50X3N0YXR1czsKICAgICAgICB2bS5BcHBvaW50bWVudElEID0gc2NoZWR1bGUucmF3LmFwcG9pbnRtZW50X2lkOwogICAgICAgIHZtLnZpc2l0U3RhdHVzID0gc2NoZWR1bGUucmF3LnZpc2l0X3N0YXR1cwogICAgICAgIHZtLm9wZW5DaGVja0FuZENoYW5nZVN0YXR1c01vZGFsKHNjaGVkdWxlLnJhdy5hcHBvaW50bWVudF9pZCwgc2NoZWR1bGUuc3RhcnQuX2RhdGUpCiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMudXBkYXRlX3NjaGVkdWxlc19saXN0KCkKCiAgICAkKCIjc2NoZWR1bGVfZGV0YWlscyIpLm9uKCJoaWRkZW4uYnMubW9kYWwiLCAoKSA9PiB7CiAgICAgIGlmICghdm0uZWRpdF9zY2hlZHVsaW5nKSB7CiAgICAgICAgdm0uY2FuZGlkYXRlX25hbWUgPSAiIjsKICAgICAgICB2bS5jYW5kaWRhdGVfcG9zaXRpb24gPSAiIjsKICAgICAgICB2bS5jYW5kaWRhdGVfZW1haWwgPSAiIjsKICAgICAgICB2bS52aXNpdG9yX251bWJlciA9ICIiOwogICAgICAgIHZtLnNlbGVjdGVkX3RpbWUgPSAiIjsKICAgICAgICB2bS5pc0VkaXQgPSBmYWxzZTsKICAgICAgICB2bS5zZWxlY3RlZF9zY2hlZHVsZV9pZCA9ICIiOwogICAgICAgIHZtLnNlbGVjdGVkX3NjaGVkdWxlX3Zpc2l0X3Nsb3QgPSAiIjsKICAgICAgICB2bS5pc1Jlc2NoZWR1bGV0aW1lID0gZmFsc2U7CiAgICAgICAgdm0uZWRpdF9zY2hlZHVsaW5nID0gZmFsc2U7CiAgICAgIH0KICAgIH0pOwogICAgJCgiI3NjaGVkdWxlX2NyZWF0ZSIpLm9uKCJoaWRkZW4uYnMubW9kYWwiLCAoKSA9PiB7CiAgICAgIHZtLmNhbmRpZGF0ZV9uYW1lID0gIiI7CiAgICAgIHZtLmNhbmRpZGF0ZV9wb3NpdGlvbiA9ICIiOwogICAgICB2bS5jYW5kaWRhdGVfZW1haWwgPSAiIjsKICAgICAgdm0udmlzaXRvcl9udW1iZXIgPSAiIjsKICAgICAgdm0uc2VsZWN0ZWRfdGltZSA9ICIiOwogICAgfSk7CiAgICAkKCIjc2NoZWR1bGluZ19tb2RhbCIpLm9uKCJoaWRkZW4uYnMubW9kYWwiLCAoKSA9PiB7CiAgICAgIHZtLnNjaGVkdWxpbmdfY29udGFjdF9udW1iZXIgPSAiIjsKICAgICAgdm0uY3N2X2ZpbGUgPSAiIjsKICAgICAgdm0uZmlsZV9sYWJlbCA9ICJDaG9vc2UgRmlsZSI7CiAgICB9KTsKCiAgICB2YXIgeCwgaSwgaiwgbCwgbGwsIHNlbEVsbW50LCBhLCBiLCBjLCB2bSA9IHRoaXM7CiAgICAvKmxvb2sgZm9yIGFueSBlbGVtZW50cyB3aXRoIHRoZSBjbGFzcyAiY3VzdG9tLXNjaGVkdWxlci1zZWxlY3QiOiovCiAgICB4ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiY3VzdG9tLXNjaGVkdWxlci1zZWxlY3QiKTsKICAgIGwgPSB4Lmxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBsOyBpKyspIHsKICAgICAgc2VsRWxtbnQgPSB4W2ldLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJzZWxlY3QiKVswXTsKICAgICAgbGwgPSBzZWxFbG1udC5sZW5ndGg7CiAgICAgIC8qZm9yIGVhY2ggZWxlbWVudCwgY3JlYXRlIGEgbmV3IERJViB0aGF0IHdpbGwgYWN0IGFzIHRoZSBzZWxlY3RlZCBpdGVtOiovCiAgICAgIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJESVYiKTsKICAgICAgYS5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgInNlbGVjdC1zZWxlY3RlZCIpOwogICAgICBhLmlubmVySFRNTCA9IHNlbEVsbW50Lm9wdGlvbnNbc2VsRWxtbnQuc2VsZWN0ZWRJbmRleF0uaW5uZXJIVE1MOwogICAgICB4W2ldLmFwcGVuZENoaWxkKGEpOwogICAgICAvKmZvciBlYWNoIGVsZW1lbnQsIGNyZWF0ZSBhIG5ldyBESVYgdGhhdCB3aWxsIGNvbnRhaW4gdGhlIG9wdGlvbiBsaXN0OiovCiAgICAgIGIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJESVYiKTsKICAgICAgYi5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgInNlbGVjdC1pdGVtcyBzZWxlY3QtaGlkZSIpOwogICAgICBmb3IgKGogPSAxOyBqIDwgbGw7IGorKykgewogICAgICAgIC8qZm9yIGVhY2ggb3B0aW9uIGluIHRoZSBvcmlnaW5hbCBzZWxlY3QgZWxlbWVudCwKICAgICAgICBjcmVhdGUgYSBuZXcgRElWIHRoYXQgd2lsbCBhY3QgYXMgYW4gb3B0aW9uIGl0ZW06Ki8KICAgICAgICBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiRElWIik7CiAgICAgICAgYy5pbm5lckhUTUwgPSBzZWxFbG1udC5vcHRpb25zW2pdLmlubmVySFRNTDsKICAgICAgICBjLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIC8qd2hlbiBhbiBpdGVtIGlzIGNsaWNrZWQsIHVwZGF0ZSB0aGUgb3JpZ2luYWwgc2VsZWN0IGJveCwKICAgICAgICAgIGFuZCB0aGUgc2VsZWN0ZWQgaXRlbToqLwogICAgICAgICAgdmFyIHksIGksIGssIHMsIGgsIHNsLCB5bDsKICAgICAgICAgIHMgPSB0aGlzLnBhcmVudE5vZGUucGFyZW50Tm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2VsZWN0IilbMF07CiAgICAgICAgICBzbCA9IHMubGVuZ3RoOwogICAgICAgICAgaCA9IHRoaXMucGFyZW50Tm9kZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2w7IGkrKykgewogICAgICAgICAgICBpZiAocy5vcHRpb25zW2ldLmlubmVySFRNTCA9PSB0aGlzLmlubmVySFRNTCkgewogICAgICAgICAgICAgIHMuc2VsZWN0ZWRJbmRleCA9IGk7CiAgICAgICAgICAgICAgaC5pbm5lckhUTUwgPSB0aGlzLmlubmVySFRNTDsKICAgICAgICAgICAgICB5ID0gdGhpcy5wYXJlbnROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoInNhbWUtYXMtc2VsZWN0ZWQiKTsKICAgICAgICAgICAgICB5bCA9IHkubGVuZ3RoOwogICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCB5bDsgaysrKSB7CiAgICAgICAgICAgICAgICB5W2tdLnJlbW92ZUF0dHJpYnV0ZSgiY2xhc3MiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgInNhbWUtYXMtc2VsZWN0ZWQiKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaC5jbGljaygpOwogICAgICAgICAgdm0uY3VycmVudF9jYWxlbmRhcl92aWV3ID0gc2VsRWxtbnQudmFsdWUKICAgICAgICB9KTsKICAgICAgICBiLmFwcGVuZENoaWxkKGMpOwogICAgICB9CiAgICAgIHhbaV0uYXBwZW5kQ2hpbGQoYik7CiAgICAgIGEuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBmdW5jdGlvbiAoZSkgewogICAgICAgIC8qd2hlbiB0aGUgc2VsZWN0IGJveCBpcyBjbGlja2VkLCBjbG9zZSBhbnkgb3RoZXIgc2VsZWN0IGJveGVzLAogICAgICAgIGFuZCBvcGVuL2Nsb3NlIHRoZSBjdXJyZW50IHNlbGVjdCBib3g6Ki8KICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIGNsb3NlQWxsU2VsZWN0KHRoaXMpOwogICAgICAgIHRoaXMubmV4dFNpYmxpbmcuY2xhc3NMaXN0LnRvZ2dsZSgic2VsZWN0LWhpZGUiKTsKICAgICAgICB0aGlzLmNsYXNzTGlzdC50b2dnbGUoInNlbGVjdC1hcnJvdy1hY3RpdmUiKTsKICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiBjbG9zZUFsbFNlbGVjdCAoZWxtbnQpIHsKICAgICAgLyphIGZ1bmN0aW9uIHRoYXQgd2lsbCBjbG9zZSBhbGwgc2VsZWN0IGJveGVzIGluIHRoZSBkb2N1bWVudCwKICAgICAgZXhjZXB0IHRoZSBjdXJyZW50IHNlbGVjdCBib3g6Ki8KICAgICAgdmFyIHgsIHksIGksIHhsLCB5bCwgYXJyTm8gPSBbXTsKICAgICAgeCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoInNlbGVjdC1pdGVtcyIpOwogICAgICB5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgic2VsZWN0LXNlbGVjdGVkIik7CiAgICAgIHhsID0geC5sZW5ndGg7CiAgICAgIHlsID0geS5sZW5ndGg7CiAgICAgIGZvciAoaSA9IDA7IGkgPCB5bDsgaSsrKSB7CiAgICAgICAgaWYgKGVsbW50ID09IHlbaV0pIHsKICAgICAgICAgIGFyck5vLnB1c2goaSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeVtpXS5jbGFzc0xpc3QucmVtb3ZlKCJzZWxlY3QtYXJyb3ctYWN0aXZlIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAoaSA9IDA7IGkgPCB4bDsgaSsrKSB7CiAgICAgICAgaWYgKGFyck5vLmluZGV4T2YoaSkpIHsKICAgICAgICAgIHhbaV0uY2xhc3NMaXN0LmFkZCgic2VsZWN0LWhpZGUiKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qaWYgdGhlIHVzZXIgY2xpY2tzIGFueXdoZXJlIG91dHNpZGUgdGhlIHNlbGVjdCBib3gsCiAgICB0aGVuIGNsb3NlIGFsbCBzZWxlY3QgYm94ZXM6Ki8KICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgY2xvc2VBbGxTZWxlY3QpOwogIH0sCiAgbWV0aG9kczogewogICAgaW50ZXJ2aWV3ZXJzX2RldGFpbCgpIHsKICAgICAgLy9Uby1EbwoKICAgICAgLy8gaXNfZ2V0ICsgZ2V0X2FsbCAtPiByZXR1cm5zIGFsbCBpbnRlcnZpZXdlcnMgbGlzdAogICAgICAvLyBpc19nZXQgKyByZXFfaW50ZXJ2aWV3ZXJfZW1haWwgLT4gcmV0dXJucyBzaW5nbGUgaW50ZXJ2aWV3ZXIgZGV0YWlscyB3aXRoIHRoZWlyIHdvcmtpbmcgaG91cgogICAgICAKICAgICAgLy8gY29tcGFueV9pZCA9IHJlcXVlc3QuanNvbi5nZXQoJ2NvbXBhbnlfaWQnLCBOb25lKQogICAgICAvLyBjb21wYW55X25hbWUgPSByZXF1ZXN0Lmpzb24uZ2V0KCdjb21wYW55X25hbWUnLCBOb25lKQogICAgICAvLyBpc19nZXQgPSByZXF1ZXN0Lmpzb24uZ2V0KCdpc19nZXQnLCBGYWxzZSkKICAgICAgLy8gZ2V0X2FsbCA9IHJlcXVlc3QuanNvbi5nZXQoJ2dldF9hbGwnLCBGYWxzZSkKICAgICAgLy8gaXNfc2F2ZSA9IHJlcXVlc3QuanNvbi5nZXQoJ2lzX3NhdmUnLCBGYWxzZSkKICAgICAgLy8gaXNfZWRpdCA9IHJlcXVlc3QuanNvbi5nZXQoJ2lzX2VkaXQnLCBGYWxzZSkKICAgICAgLy8gaXNfc2VhcmNoID0gcmVxdWVzdC5qc29uLmdldCgnaXNfc2VhcmNoJywgRmFsc2UpCiAgICAgIC8vIHNlYXJjaF9rZXkgPSByZXF1ZXN0Lmpzb24uZ2V0KCdzZWFyY2hfa2V5JywgTm9uZSkKICAgICAgLy8gcmVxX2ludGVydmlld2VyX2VtYWlsID0gcmVxdWVzdC5qc29uLmdldCgncmVxX2ludGVydmlld2VyX2VtYWlsJywgTm9uZSkKICAgICAgLy8gaW50ZXJ2aWV3ZXJzX2RldGFpbCA9IHJlcXVlc3QuanNvbi5nZXQoJ2ludGVydmlld2Vyc19kZXRhaWwnLCBOb25lKQogICAgICAvLyBwYWdlX25vID0gcmVxdWVzdC5qc29uLmdldCgncGFnZV9ubycsIDEpCiAgICAgIC8vIHBlcl9wYWdlID0gcmVxdWVzdC5qc29uLmdldCgncGVyX3BhZ2UnLCAxMCkKICAgIH0sCiAgICBhZGRfdGltaW5nX3Nsb3QoZGF5cykgewogICAgICB2YXIgdm0gPSB0aGlzOwogICAgICBpZihCb29sZWFuKHRoaXMud29ya2luZ19ocnNbZGF5c10pKXsKICAgICAgICB0aGlzLndvcmtpbmdfaHJzW2RheXNdLnB1c2goewogICAgICAgICAgRW5kVGltZTogIiIsIAogICAgICAgICAgU3RhcnRUaW1lOiAiIgogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMud29ya2luZ19ocnNbZGF5c10gPSBbewogICAgICAgICAgRW5kVGltZTogIiIsIAogICAgICAgICAgU3RhcnRUaW1lOiAiIgogICAgICAgIH1dCiAgICAgIH0KICAgICAgdm0uJHNldCh2bS53b3JraW5nX2hycywgZGF5cywgdm0ud29ya2luZ19ocnNbZGF5c10pOwogICAgfSwKICAgIHJlbW92ZV90aW1pbmdfc2xvdChkYXlzLGluZGV4KSB7CiAgICAgIHRoaXMud29ya2luZ19ocnNbZGF5c10uc3BsaWNlKGluZGV4LCAxKTsKICAgIH0sCiAgICBvcGVuX3NjaGVkdWxpbmdfbW9kYWwgKCkgewogICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IHRydWU7CiAgICAgIHRoaXMuZWRpdF9zY2hlZHVsaW5nID0gZmFsc2U7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoYXBpX2NhbGxzLnNjaGVkdWxpbmdfc2V0dGluZ3NfdXJsKCksIHsKICAgICAgICAgIGNvbXBhbnlfbmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZSwKICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkLAogICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICB0b2tlbjogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnRva2VucywKICAgICAgICAgIGdldFNjaGVkdWxpbmdJbmZvOiB0cnVlCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLiRzZXNzaW9uLmdldCgiYXQiKX1gLAogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSBmYWxzZTsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YSAhPSBudWxsICYmCiAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuU2NoZWR1bGluZ19pbmZvICE9IHVuZGVmaW5lZAogICAgICAgICAgKSB7CiAgICAgICAgICAgIHRoaXMuc2NoZWR1bGluZ19jb250YWN0X251bWJlciA9CiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5TY2hlZHVsaW5nX2luZm8ucGhvbmVfbnVtYmVyOwogICAgICAgICAgICB0aGlzLnNlbGVjdGVkX3RpbWVfc2xvdCA9IHJlc3BvbnNlLmRhdGEuU2NoZWR1bGluZ19pbmZvLnRpbWVfc2xvdCAhPT0gbnVsbCA/IHJlc3BvbnNlLmRhdGEuU2NoZWR1bGluZ19pbmZvLnRpbWVfc2xvdCA6ICIiOwogICAgICAgICAgICB0aGlzLmJ1ZmZlcl90aW1lX3BlcmlvZCA9IHJlc3BvbnNlLmRhdGEuU2NoZWR1bGluZ19pbmZvLmJ1ZmZlcl90aW1lICE9PSBudWxsID8gcmVzcG9uc2UuZGF0YS5TY2hlZHVsaW5nX2luZm8uYnVmZmVyX3RpbWUgOiAiIjsKICAgICAgICAgICAgdGhpcy5taW5pbXVtX25vdGljZV9kYXlzID0gcmVzcG9uc2UuZGF0YS5TY2hlZHVsaW5nX2luZm8ubWluaW11bV9ub3RpY2VfZGF5cyAhPT0gbnVsbCA/IHJlc3BvbnNlLmRhdGEuU2NoZWR1bGluZ19pbmZvLm1pbmltdW1fbm90aWNlX2RheXMgOiAiIjsKICAgICAgICAgICAgdGhpcy5tZWV0aW5nX2RheXNfcmFuZ2UgPSByZXNwb25zZS5kYXRhLlNjaGVkdWxpbmdfaW5mby5tZWV0aW5nX2RheXNfcmFuZ2UgIT09IG51bGwgPyByZXNwb25zZS5kYXRhLlNjaGVkdWxpbmdfaW5mby5tZWV0aW5nX2RheXNfcmFuZ2UgOiAiIjsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuU2NoZWR1bGluZ19pbmZvLkhvbGlkYXlfbGlzdF9maWxlX25hbWUgPT0gIiIgfHwKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLlNjaGVkdWxpbmdfaW5mby5Ib2xpZGF5X2xpc3RfZmlsZV9uYW1lID09IG51bGwKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5maWxlX2xhYmVsID0KICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuU2NoZWR1bGluZ19pbmZvLkhvbGlkYXlfbGlzdF9maWxlX25hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYocmVzcG9uc2UuZGF0YS5TY2hlZHVsaW5nX2luZm8ud29ya2luZ19ocnMgIT0gbnVsbCB8fCAKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5TY2hlZHVsaW5nX2luZm8ud29ya2luZ19ocnMgIT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICB0aGlzLndvcmtpbmdfaHJzID0gcmVzcG9uc2UuZGF0YS5TY2hlZHVsaW5nX2luZm8ud29ya2luZ19ocnM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJCgiI3NjaGVkdWxpbmdfbW9kYWwiKS5tb2RhbCgic2hvdyIpOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGVyciA9PiB7CiAgICAgICAgICAvLyBjb25zb2xlLmxvZyhlcnIpOwogICAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSBmYWxzZTsKICAgICAgICAgICQoIiNzY2hlZHVsaW5nX21vZGFsIikubW9kYWwoImhpZGUiKTsKICAgICAgICAgIHRvYXN0ci5lcnJvcigiSW50ZXJuYWwgU2VydmVyIEVycm9yIik7CiAgICAgICAgfSk7CiAgICB9LAogICAgZ2V0X3RpbWVfc2xvdHMgKHN0YXJ0X2RhdGUsIHR5cGUsIHNlbGVjdGVkX3RpbWUsIGlzX3Jlc2NoZWR1bGluZykgewogICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IHRydWU7CiAgICAgIHRoaXMuZWRpdF9zY2hlZHVsaW5nID0gaXNfcmVzY2hlZHVsaW5nID09PSAiaXNfcmVzY2hlZHVsaW5nIjsKICAgICAgaWYgKGlzX3Jlc2NoZWR1bGluZyA9PT0gImlzX3Jlc2NoZWR1bGluZyIpIHsKICAgICAgICB0aGlzLmhpZGVfbW9kYWwoInNjaGVkdWxlX2RldGFpbHMiKQogICAgICB9CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmhyX2dldF9zY2hlZHVsZV9hcHBvaW50bWVudCgpLCB7CiAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUsCiAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICBEYXRlOiBtb21lbnQoc3RhcnRfZGF0ZSkuZm9ybWF0KCdZWVlZLU1NLUREJyksCiAgICAgICAgICBhcHBvaW50bWVudF9kYXRlOiBtb21lbnQoc3RhcnRfZGF0ZSkuZm9ybWF0KCdZWVlZLU1NLUREJykKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuJHNlc3Npb24uZ2V0KCJhdCIpfWAsCiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IGZhbHNlOwogICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEgPT0gbnVsbCkgewogICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5tc2cgPT0gIlBsZWFzZSB1cGRhdGUgeW91ciBzY2hlZHVsZXIgc2V0dGluZ3MiCiAgICAgICAgICApIHsKICAgICAgICAgICAgdG9hc3RyLmVycm9yKCJQbGVhc2UgdXBkYXRlIHlvdXIgc2NoZWR1bGVyIHNldHRpbmdzIik7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEubXNnID09ICJJbnRlcm5hbCBTZXJ2ZXIgRXJyb3IiKSB7CiAgICAgICAgICAgIHRvYXN0ci5lcnJvcigiSW50ZXJuYWwgU2VydmVyIEVycm9yIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5mdWxsX3RpbWVfc2xvdHMgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgdmFyIGR0ID0gbmV3IERhdGUoKTsKICAgICAgICAgICAgICB0aGlzLmZ1bGxfdGltZV9zbG90cyA9IFtdOwogICAgICAgICAgICAgIHZhciBnZXRfZnVsbF9zbG90X2xpc3QgPSB0cnVlOwogICAgICAgICAgICAgIHZhciB0ZW1wX3N0YXJ0X2RhdGUgPSBuZXcgRGF0ZShzdGFydF9kYXRlKTsKICAgICAgICAgICAgICBpZiAodGVtcF9zdGFydF9kYXRlLmdldEZ1bGxZZWFyKCkgPiBkdC5nZXRGdWxsWWVhcigpKSB7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZW1wX3N0YXJ0X2RhdGUuZ2V0RnVsbFllYXIoKSA9PSBkdC5nZXRGdWxsWWVhcigpKSB7CiAgICAgICAgICAgICAgICBpZiAodGVtcF9zdGFydF9kYXRlLmdldE1vbnRoKCkgPiBkdC5nZXRNb250aCgpKSB7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRlbXBfc3RhcnRfZGF0ZS5nZXRNb250aCgpID09IGR0LmdldE1vbnRoKCkpIHsKICAgICAgICAgICAgICAgICAgaWYgKHRlbXBfc3RhcnRfZGF0ZS5nZXREYXRlKCkgPiBkdC5nZXREYXRlKCkpIHsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZW1wX3N0YXJ0X2RhdGUuZ2V0RGF0ZSgpID09IGR0LmdldERhdGUoKSkgewogICAgICAgICAgICAgICAgICAgIGdldF9mdWxsX3Nsb3RfbGlzdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIGlmIChtb21lbnQoc3RhcnRfZGF0ZSkuZGlmZihtb21lbnQoKSwgImRheSIpIDw9IDApIHsKICAgICAgICAgICAgICAvLyAgIGdldF9mdWxsX3Nsb3RfbGlzdCA9IGZhbHNlOwogICAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgICBpZiAoZ2V0X2Z1bGxfc2xvdF9saXN0KSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIHJlc3BvbnNlLmRhdGEuZnVsbF90aW1lX3Nsb3RzKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuZnVsbF90aW1lX3Nsb3RzLnB1c2goewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiByZXNwb25zZS5kYXRhLmZ1bGxfdGltZV9zbG90c1tpXSwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiB0aGlzLmdlbmVyYXRlX3RpbWUoCiAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZ1bGxfdGltZV9zbG90c1tpXS5zcGxpdCgiLSIpWzBdLAogICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5mdWxsX3RpbWVfc2xvdHNbaV0uc3BsaXQoIi0iKVsxXQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiByZXNwb25zZS5kYXRhLmZ1bGxfdGltZV9zbG90cykgewogICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgIGR0LmdldEhvdXJzKCkgPAogICAgICAgICAgICAgICAgICAgICAgTnVtYmVyKAogICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZ1bGxfdGltZV9zbG90c1tpXS5zcGxpdCgiLSIpWzBdLnNwbGl0KCI6IilbMF0KICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICApIHsgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZnVsbF90aW1lX3Nsb3RzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcmVzcG9uc2UuZGF0YS5mdWxsX3RpbWVfc2xvdHNbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IHRoaXMuZ2VuZXJhdGVfdGltZSgKICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZ1bGxfdGltZV9zbG90c1tpXS5zcGxpdCgiLSIpWzBdLAogICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZnVsbF90aW1lX3Nsb3RzW2ldLnNwbGl0KCItIilbMV0KICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBmb3IgKHZhciBpIGluIHJlc3BvbnNlLmRhdGEuYXZhaWxhYmxlX3RpbWVfc2xvdHMpIHsKICAgICAgICAgICAgICAgIC8vICAgdGhpcy5mdWxsX3RpbWVfc2xvdHMucHVzaCh7CiAgICAgICAgICAgICAgICAvLyAgICAgdmFsdWU6IHJlc3BvbnNlLmRhdGEuYXZhaWxhYmxlX3RpbWVfc2xvdHNbaV0sCiAgICAgICAgICAgICAgICAvLyAgICAgdGV4dDogdGhpcy5nZW5lcmF0ZV90aW1lKAogICAgICAgICAgICAgICAgLy8gICAgICAgcmVzcG9uc2UuZGF0YS5hdmFpbGFibGVfdGltZV9zbG90c1tpXS5zcGxpdCgiLSIpWzBdLAogICAgICAgICAgICAgICAgLy8gICAgICAgcmVzcG9uc2UuZGF0YS5hdmFpbGFibGVfdGltZV9zbG90c1tpXS5zcGxpdCgiLSIpWzFdCiAgICAgICAgICAgICAgICAvLyAgICAgKQogICAgICAgICAgICAgICAgLy8gICB9KTsKICAgICAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKEJvb2xlYW4oc2VsZWN0ZWRfdGltZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNFZGl0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkX3RpbWUgPSBzZWxlY3RlZF90aW1lOwogICAgICAgICAgICAgICAgdGhpcy5zY2hlZHVsZWRfdGltZSA9IHRoaXMuZ2VuZXJhdGVfdGltZSgKICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRfdGltZS5zcGxpdCgiLSIpWzBdLAogICAgICAgICAgICAgICAgICBzZWxlY3RlZF90aW1lLnNwbGl0KCItIilbMV0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB0aGlzLnRpbWVfc2xvdHMgPSBbXTsKICAgICAgICAgICAgICAgIC8vIHRoaXMudGltZV9zbG90cy5wdXNoKHsKICAgICAgICAgICAgICAgIC8vICAgdmFsdWU6IHNlbGVjdGVkX3RpbWUsCiAgICAgICAgICAgICAgICAvLyAgIHRleHQ6IHRoaXMuZ2VuZXJhdGVfdGltZSgKICAgICAgICAgICAgICAgIC8vICAgICBzZWxlY3RlZF90aW1lLnNwbGl0KCItIilbMF0sCiAgICAgICAgICAgICAgICAvLyAgICAgc2VsZWN0ZWRfdGltZS5zcGxpdCgiLSIpWzFdCiAgICAgICAgICAgICAgICAvLyAgICkKICAgICAgICAgICAgICAgIC8vIH0pCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIHRoaXMuZnVsbF90aW1lX3Nsb3RzKSB7CiAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZpbGxlZF90aW1lX3Nsb3RzLmluZGV4T2YoCiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZ1bGxfdGltZV9zbG90c1tpXS52YWx1ZQogICAgICAgICAgICAgICAgICAgICkgPT0gLTEgfHwgdGhpcy5zZWxlY3RlZF90aW1lID09IHRoaXMuZnVsbF90aW1lX3Nsb3RzW2ldLnZhbHVlCiAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudGltZV9zbG90cy5wdXNoKHRoaXMuZnVsbF90aW1lX3Nsb3RzW2ldKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gZm9yICh2YXIgaSBpbiB0aGlzLmZ1bGxfdGltZV9zbG90cykgewogICAgICAgICAgICAgICAgLy8gICB0aGlzLnRpbWVfc2xvdHMucHVzaCh0aGlzLmZ1bGxfdGltZV9zbG90c1tpXSk7CiAgICAgICAgICAgICAgICAvLyB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghQm9vbGVhbihzZWxlY3RlZF90aW1lKSkgewogICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuZmlsbGVkX3RpbWVfc2xvdHMubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgICAgICAgdGhpcy50aW1lX3Nsb3RzID0gdGhpcy5mdWxsX3RpbWVfc2xvdHM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhpcy50aW1lX3Nsb3RzID0gW107CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gdGhpcy5mdWxsX3RpbWVfc2xvdHMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZpbGxlZF90aW1lX3Nsb3RzLmluZGV4T2YoCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZnVsbF90aW1lX3Nsb3RzW2ldLnZhbHVlCiAgICAgICAgICAgICAgICAgICAgICApID09IC0xCiAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWVfc2xvdHMucHVzaCh0aGlzLmZ1bGxfdGltZV9zbG90c1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vICB0aGlzLnRpbWVfc2xvdHMgPSByZXNwb25zZS5kYXRhLmF2YWlsYWJsZV90aW1lX3Nsb3RzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGhpcy50aW1lX3Nsb3RzLmxlbmd0aCA9PT0gMCAmJiB0eXBlID09ICdzY2hlZHVsZV9kZXRhaWxzJykgewogICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCdObyBGcmVlIFNsb3RzIGZvciB0aGlzIERhdGUnKQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkKHR5cGUpLm1vZGFsKCJzaG93Iik7CiAgICAgICAgICAgICAgICB0aGlzLnRlbXBfbmFtZSA9IHRoaXMuY2FuZGlkYXRlX25hbWU7CiAgICAgICAgICAgICAgICB0aGlzLnRlbXBfcG9zaXRpb24gPSB0aGlzLmNhbmRpZGF0ZV9wb3NpdGlvbjsKICAgICAgICAgICAgICAgIHRoaXMudGVtcF9lbWFpbCA9IHRoaXMuY2FuZGlkYXRlX2VtYWlsOwogICAgICAgICAgICAgICAgdGhpcy50ZW1wX2FwcG9pbnRtZW50X3RpbWUgPSB0aGlzLnNlbGVjdGVkX3RpbWU7CiAgICAgICAgICAgICAgICB0aGlzLmlzUmVzY2hlZHVsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgbkRhdGUgPSBuZXcgRGF0ZSgKICAgICAgICAgICAgICAgICAgc3RhcnRfZGF0ZS5nZXRGdWxsWWVhcigpICsKICAgICAgICAgICAgICAgICAgIi0iICsKICAgICAgICAgICAgICAgICAgKHN0YXJ0X2RhdGUuZ2V0TW9udGgoKSA8IDkKICAgICAgICAgICAgICAgICAgICA/ICIwIiArIChzdGFydF9kYXRlLmdldE1vbnRoKCkgKyAxKQogICAgICAgICAgICAgICAgICAgIDogc3RhcnRfZGF0ZS5nZXRNb250aCgpICsgMSkgKwogICAgICAgICAgICAgICAgICAiLSIgKwogICAgICAgICAgICAgICAgICBzdGFydF9kYXRlLmdldERhdGUoKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHRoaXMudGVtcF9kYXRhID0gbkRhdGU7CiAgICAgICAgICAgICAgICB0aGlzLnByZXZpb3VzX3Zpc2l0X2RhdGUgPSBuRGF0ZTsKICAgICAgICAgICAgICAgIHRoaXMudGVtcF9hcHBvaW50bWVudF9kYXRlID0gbW9tZW50KG5EYXRlKS5mb3JtYXQoIk1NLURELVlZWVkiKTsKICAgICAgICAgICAgICAgIHZhciBtaWRhdGUgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5kYXRlcGlja2VySW5zdGFuY2UgPSBuZXcgRGF0ZVBpY2tlcigiI2RhdGVwaWNrZXIiLCB7CiAgICAgICAgICAgICAgICAgIGRhdGU6IG5EYXRlLAogICAgICAgICAgICAgICAgICBtaW5EYXRlOiBtaWRhdGUsCiAgICAgICAgICAgICAgICAgIGlucHV0OiB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogIiNkYXRlcGlja2VyLWlucHV0IiwKICAgICAgICAgICAgICAgICAgICBmb3JtYXQ6ICJ5eXl5LU1NLWRkIgogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBzZXRSYW5nZXM6IChbCiAgICAgICAgICAgICAgICAgICAgW25ldyBEYXRlKCksIG5ldyBEYXRlKDIwNTAsIDEyLCAxMildLAogICAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgdm0gPSB0aGlzOwogICAgICAgICAgICAgICAgdGhpcy5kYXRlcGlja2VySW5zdGFuY2Uub24oImNsb3NlIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAvL3ZhciB4PSBuRGF0ZQogICAgICAgICAgICAgICAgICB2bS5jaGVja2RhdGUoKTsKICAgICAgICAgICAgICAgICAgLy8gJCgiI2RhdGVwaWNrZXItaW5wdXQiKVswXS52YWx1ZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyB9LCAxMDAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGVycm9yID0+IHsKICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgICAvLyBjb25zb2xlLmxvZyhlcnJvcik7CiAgICAgICAgICB0b2FzdHIuZXJyb3IoIkludGVybmFsIFNlcnZlciBFcnJvciIpOwogICAgICAgIH0pOwogICAgfSwKICAgIHNhbXBsZV9ob2xpZGF5ICgpIHsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgdGhpcy5zcGlubmVyT24gPSB0cnVlOwogICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IHRydWU7CiAgICAgIGF4aW9zKHsKICAgICAgICBtZXRob2Q6ICJwb3N0IiwKICAgICAgICB1cmw6IGFwaV9jYWxscy5ob2xpZGF5X2ZpbGVfZG93bmxvYWQoKSwKICAgICAgICByZXNwb25zZVR5cGU6ICJibG9iIiwKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICB9LAogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGlzSG9saWRheUZpbGU6IHRydWUsCiAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICAgIGNvbXBhbnlfbmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZSwKICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICB0b2tlbjogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnRva2VucywKICAgICAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwKICAgICAgICB9CiAgICAgIH0pLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgdGhpcy5zcGlubmVyT24gPSBmYWxzZTsKICAgICAgICBpZihyZXNwb25zZS5kYXRhLm1lc3NhZ2UgPT09ICJOb3QgYWJsZSB0byBkb3dubG9hZCBmaWxlIil7CiAgICAgICAgICBzd2FsLmZpcmUoewogICAgICAgICAgICB0aXRsZTogIlNvbWUgRXJyb3IgT2NjdXJyZWQuIFBsZWFzZSBUcnkgQWdhaW4iLAogICAgICAgICAgICB0eXBlOiAiZXJyb3IiLAogICAgICAgICAgICB0aW1lcjogMjUwMAogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgdXJsID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoW3Jlc3BvbnNlLmRhdGFdKSk7CiAgICAgICAgdmFyIGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgICAgbGluay5ocmVmID0gdXJsOwogICAgICAgIGxpbmsuc2V0QXR0cmlidXRlKCJkb3dubG9hZCIsICJob2xpZGF5U2FtcGxlRmlsZS5jc3YiKTsKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmspOwogICAgICAgIGxpbmsuY2xpY2soKTsKICAgICAgICB9CiAgICAgIH0pLmNhdGNoKChlKT0+IHsKICAgICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IGZhbHNlOwogICAgICAgIHRoaXMuc3Bpbm5lck9uID0gZmFsc2U7CiAgICAgICAgc3dhbC5maXJlKHsKICAgICAgICAgIHRpdGxlOiAiU29tZSBFcnJvciBPY2N1cnJlZC4gUGxlYXNlIFRyeSBBZ2FpbiIsCiAgICAgICAgICB0eXBlOiAiZXJyb3IiLAogICAgICAgICAgdGltZXI6IDI1MDAKICAgICAgICB9KTsKICAgICAgICBpZiAoCiAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDEwIHx8CiAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDQwIHx8CiAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA5CiAgICAgICAgKSB7CiAgICAgICAgICB0aGlzLiRyb290LiRlbWl0KCJTZXNzaW9uX0V4cGlyZWQiLCBlLnJlc3BvbnNlLmRhdGEpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgZmlsZWlucHV0IChlKSB7CiAgICAgIGxldCBmaWxlcyA9IGUudGFyZ2V0LmZpbGVzIHx8IGUuZGF0YVRyYW5zZmVyLmZpbGVzOwogICAgICBpZiAoZmlsZXNbMF0uc2l6ZSA8IDEwMDAwMDApIHsKICAgICAgICBpZiAoZmlsZXNbMF0ubmFtZS5pbmNsdWRlcygiY3N2IikpIHsKICAgICAgICAgIHRoaXMuZmlsZV9sYWJlbCA9IGZpbGVzWzBdLm5hbWU7CiAgICAgICAgICB0aGlzLmNyZWF0ZUNTVihmaWxlc1swXSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRvYXN0ci5lcnJvcigiVXBsb2FkIG9ubHkgLmNzdiBmaWxlIHdpdGggc2l6ZSBsZXNzIHRoYW4gMU1CIik7CiAgICAgIH0KICAgICAgaWYgKCFmaWxlcy5sZW5ndGgpIHJldHVybjsKICAgIH0sCiAgICBjcmVhdGVDU1YgKGZpbGUsIHR5cGUpIHsKICAgICAgbGV0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgICAgIHJlYWRlci5vbmxvYWQgPSBlID0+IHsKICAgICAgICB0aGlzLmNzdl9maWxlID0gZS50YXJnZXQucmVzdWx0LnNwbGl0KCJiYXNlNjQsIilbMV07CiAgICAgIH07CiAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpOwogICAgfSwKICAgIHNlbmRfc2NoZWR1bGluZyAoKSB7CiAgICAgIHZhciBjaGVjayA9IGZhbHNlOwogICAgICBmb3IgKHZhciBpIGluIHRoaXMud29ya2luZ19ocnMpIHsKICAgICAgICBmb3IgKHZhciBqIGluIHRoaXMud29ya2luZ19ocnNbaV0pIHsKICAgICAgICAgIGlmKHRoaXMud29ya2luZ19ocnNbaV1bal0uU3RhcnRUaW1lID09ICIiIHx8IHRoaXMud29ya2luZ19ocnNbaV1bal0uRW5kVGltZSA9PSAiIil7CiAgICAgICAgICAgIGNoZWNrID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYoY2hlY2sgPT0gdHJ1ZSkgewogICAgICAgIHN3YWwuZmlyZSh7CiAgICAgICAgICB0aXRsZTogIkZpbGwgdGltZSBzbG90cyIsCiAgICAgICAgICB0eXBlOiAid2FybmluZyIsCiAgICAgICAgICB0aW1lcjogMzAwMAogICAgICAgIH0pOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBpZiAodGhpcy51c2VyX3JvbGUgPT0gIkFkbWluIikgewogICAgICBpZiAoCiAgICAgICAgdGhpcy5zZWxlY3RlZF90aW1lX3Nsb3QgIT0gIiIgJiYKICAgICAgICB0aGlzLnNjaGVkdWxpbmdfY29udGFjdF9udW1iZXIgIT0gIiIgJiYgCiAgICAgICAgdGhpcy52YWxpZFBob25lTnVtYmVyID09IHRydWUgJiYKICAgICAgICB0aGlzLmJ1ZmZlcl90aW1lX3BlcmlvZCAhPSAiIiAmJgogICAgICAgIHRoaXMubWluaW11bV9ub3RpY2VfZGF5cyAhPSAiIiAmJgogICAgICAgIHRoaXMubWVldGluZ19kYXlzX3JhbmdlICE9ICIiCiAgICAgICkgewogICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gdHJ1ZTsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLnNjaGVkdWxpbmdfc2V0dGluZ3NfdXJsKCksIHsKICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lLAogICAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICAgIGdldFNjaGVkdWxpbmdJbmZvOiBmYWxzZSwKICAgICAgICAgICAgaXN1cGRhdGU6IHRydWUsCiAgICAgICAgICAgIC8vIHVwZGF0ZUNvbnRhY3Q6IHRydWUsCiAgICAgICAgICAgIENvbnRhY3ROdW1iZXI6IHRoaXMuc2NoZWR1bGluZ19jb250YWN0X251bWJlciwKICAgICAgICAgICAgdGltZXNsb3Q6IE51bWJlcih0aGlzLnNlbGVjdGVkX3RpbWVfc2xvdCksCiAgICAgICAgICAgIGJ1ZmZlcl90aW1lOiBOdW1iZXIodGhpcy5idWZmZXJfdGltZV9wZXJpb2QpLAogICAgICAgICAgICBtZWV0aW5nX2RheXNfcmFuZ2U6IE51bWJlcih0aGlzLm1lZXRpbmdfZGF5c19yYW5nZSksCiAgICAgICAgICAgIG1pbmltdW1fbm90aWNlX2RheXM6IE51bWJlcih0aGlzLm1pbmltdW1fbm90aWNlX2RheXMpLAogICAgICAgICAgICB3b3JraW5nX2hyczogdGhpcy53b3JraW5nX2hycywKICAgICAgICAgICAgaXN1cGRhdGVIb2xpZGF5OiB0aGlzLmNzdl9maWxlICE9ICIiID8gdHJ1ZSA6IGZhbHNlLAogICAgICAgICAgICBob2xpZGF5X2xpc3RfZmlsZV9uYW1lOiB0aGlzLmZpbGVfbGFiZWwsCiAgICAgICAgICAgIGhvbGlkYXlfbGlzdF9maWxlX2RhdGE6CiAgICAgICAgICAgICAgdGhpcy5jc3ZfZmlsZSA9PSAiIiA/IG51bGwgOiB0aGlzLmNzdl9maWxlLAogICAgICAgICAgfSx7CiAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuJHNlc3Npb24uZ2V0KCJhdCIpfWAsCiAgICAgICAgfSwKICAgICAgICAgIH0pCiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaGlkZV9tb2RhbCgic2NoZWR1bGluZ19tb2RhbCIpCiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhICE9IG51bGwgJiYKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLm1zZyA9PSAiU2NoZWR1bGluZyBpbmZvIHVwZGF0ZWQiCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHRvYXN0ci5zdWNjZXNzKAogICAgICAgICAgICAgICAgIllvdXIgc2NoZWR1bGluZyBpbmZvcm1hdGlvbiBoYXMgYmVlbiB1cGRhdGVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHRoaXMudXBkYXRlX3NjaGVkdWxlc19saXN0KCkKICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLm1zZyA9PSAiSW52YWxpZCBIZWFkZXIiKSB7CiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKAogICAgICAgICAgICAgICAgIlBsZWFzZSBlbnRlciB5b3VyIGhlYWRlcnMgYXMgcHJvdmlkZWQgaW4gdGhlIHNhbXBsZSBmaWxlIGJlbG93LiIKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEubXNnID09ICIiKSB7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgJCgiI3NjaGVkdWxpbmdfbW9kYWwiKS5tb2RhbCgiaGlkZSIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRvYXN0ci5lcnJvcigiSW50ZXJuYWwgU2VydmVyIEVycm9yIik7CiAgICAgICAgICAgICAgJCgiI3NjaGVkdWxpbmdfbW9kYWwiKS5tb2RhbCgiaGlkZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBpZiAodGhpcy52YWxpZFBob25lTnVtYmVyICE9IHRydWUgICYmIHRoaXMuc2NoZWR1bGluZ19jb250YWN0X251bWJlciAhPSAiIil7CiAgICAgICAgLy8gICB0b2FzdHIuZXJyb3IoIk1vYmlsZSBudW1iZXIgaXMgaW52YWxpZCwgcGxlYXNlIGVudGVyIGluIGZvcm1hdDogKyBDb3VudHJ5Q29kZSBOdW1iZXIiKTsKICAgICAgICAvLyB9ZWxzZXsKICAgICAgICAgIHRvYXN0ci5lcnJvcigiUGxlYXNlIGVudGVyIGFsbCB0aGUgcmVxdWlyZWQgZmllbGRzLiIpOwogICAgICAgIC8vIH0KICAgICAgfQogICAgfSwKICAgIGdlbmVyYXRlX3RpbWUgKHN0YXJ0X3RpbWUsIGVuZF90aW1lKSB7CiAgICAgIHZhciBzdGFydCA9IG1vbWVudChzdGFydF90aW1lLCBbImhoOm1tIl0pLmZvcm1hdCgiaGg6bW0gQSIpCiAgICAgIHZhciBlbmQgPSBtb21lbnQoZW5kX3RpbWUsIFsiaGg6bW0iXSkuZm9ybWF0KCJoaDptbSBBIikKCiAgICAgIHJldHVybiBgJHtzdGFydH0tJHtlbmR9YDsKICAgIH0sCiAgICBuZXdfc2NoZWR1bGUgKHN0YXJ0RGF0ZSkgewogICAgICBsZXQgc2NoZWR1bGVEYXRlID0gJycKICAgICAgaWYgKG1vbWVudChzdGFydERhdGUsICdZWVlZLU1NLUREJywgdHJ1ZSkuaXNWYWxpZCgpKSB7CiAgICAgICAgc2NoZWR1bGVEYXRlID0gc3RhcnREYXRlCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2NoZWR1bGVEYXRlID0gdGhpcy5jYWxlbmRhckluc3RhbmNlLmdldERhdGUoKQogICAgICB9CgogICAgICBsZXQgaG9saWRheV9kYXRlID0gdGhpcy5zY2hlZHVsZV9saXN0LmZpbHRlcihzY2hlZHVsZSA9PiB7CiAgICAgICAgcmV0dXJuICgKICAgICAgICAgIG1vbWVudChzY2hlZHVsZS5zdGFydCkuZm9ybWF0KCJZWVlZIE1NTU0gREQiKSA9PQogICAgICAgICAgbW9tZW50KHNjaGVkdWxlRGF0ZSkuZm9ybWF0KCJZWVlZIE1NTU0gREQiKSAmJgogICAgICAgICAgc2NoZWR1bGUucmF3LmlzSG9saWRheSA9PSB0cnVlCiAgICAgICAgKTsKICAgICAgfSk7CiAgICAgIGxldCB0b2RheV90aW1lID0gbmV3IERhdGUoKTsKICAgICAgbGV0IHN0YXJ0X3RpbWUgPSBzY2hlZHVsZURhdGU7CiAgICAgIHRoaXMuc2VsZWN0ZWRfZGF0ZSA9IHN0YXJ0X3RpbWU7CiAgICAgIHN0YXJ0X3RpbWUuc2V0SG91cnMoMCwgMCwgMCwgMCk7CiAgICAgIGlmICgKICAgICAgICB0aGlzLmRhdGVfY29uZGl0aW9uKHRvZGF5X3RpbWUsIHN0YXJ0X3RpbWUpICYmCiAgICAgICAgaG9saWRheV9kYXRlLmxlbmd0aCA9PSAwICYmCiAgICAgICAgbW9tZW50KHN0YXJ0X3RpbWUpLmZvcm1hdCgiZGRkZCIpICE9ICJTdW5kYXkiCiAgICAgICkgewogICAgICAgIHRoaXMuZ2V0X3RpbWVfc2xvdHMoc2NoZWR1bGVEYXRlLCAiI3NjaGVkdWxlX2NyZWF0ZSIpOwogICAgICB9IGVsc2UgaWYgKGhvbGlkYXlfZGF0ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgdG9hc3RyLmVycm9yKAogICAgICAgICAgIllvdSBjYW5ub3QgZW50ZXIgYSBzY2hlZHVsZSBmb3IgdGhpcyBkYXRlLiBcbiBSZWFzb246ICIgKwogICAgICAgICAgaG9saWRheV9kYXRlWzBdLnJhdy5yZWFzb24KICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICB9CiAgICB9LAogICAgY3JlYXRlX2FwcG9pbnRtZW50ICgpIHsKICAgICAgY29uc3QgcmVnZXggPSAvXCtbMC05XXs5LDE0fSQvOwogICAgICBjb25zdCB4ID0gdGhpcy52aXNpdG9yX251bWJlci5yZXBsYWNlKC9ccysvZywgJycpOwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICBpZiAoCiAgICAgICAgdGhpcy5jYW5kaWRhdGVfcG9zaXRpb24gPT0gIiIgfHwKICAgICAgICB0aGlzLmNhbmRpZGF0ZV9lbWFpbCA9PSAiIiB8fAogICAgICAgIHRoaXMuY2FuZGlkYXRlX25hbWUgPT0gIiIgfHwKICAgICAgICB0aGlzLnZpc2l0b3JfbnVtYmVyID09ICIiIHx8CiAgICAgICAgdGhpcy5zZWxlY3RlZF90aW1lID09ICIiCiAgICAgICkgewogICAgICAgIHRvYXN0ci5lcnJvcigiUGxlYXNlIGVudGVyIGFsbCB0aGUgcmVxdWlyZWQgZmllbGRzLiIpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoIXJlZ2V4LnRlc3QoeCkpIHsKICAgICAgICB0b2FzdHIuZXJyb3IoIk1vYmlsZSBudW1iZXIgaXMgaW52YWxpZCwgcGxlYXNlIGVudGVyIGluIGZvcm1hdDogKyBDb3VudHJ5Q29kZSBOdW1iZXIiKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRWRpdCkgewogICAgICAgIGxldCBhcHBvaW50bWVudF9wYXlsb2FkID0gewogICAgICAgICAgQ2FuZGlkYXRlTmFtZTogdGhpcy5jYW5kaWRhdGVfbmFtZSwKICAgICAgICAgIENhbmRpZGF0ZVBvc2l0aW9uOiB0aGlzLmNhbmRpZGF0ZV9wb3NpdGlvbiwKICAgICAgICAgIENhbmRpZGF0ZUVtYWlsOiB0aGlzLmNhbmRpZGF0ZV9lbWFpbCwKICAgICAgICAgIFZpc2l0U2xvdDogdGhpcy5zZWxlY3RlZF90aW1lLAogICAgICAgICAgUGhvbmVOdW1iZXI6IHRoaXMudmlzaXRvcl9udW1iZXIsCiAgICAgICAgICBWaXNpdERhdGU6IHRoaXMuc2VsZWN0ZWRfc2NoZWR1bGVfdmlzaXRfc2xvdC5zcGxpdCgiICIpWzBdCiAgICAgICAgfTsKICAgICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IHRydWU7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5zY2hlZHVsZV9lZGl0X2RlbGV0ZV91cmwoKSwgewogICAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUsCiAgICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkLAogICAgICAgICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnRva2VucywKICAgICAgICAgICAgZGF0ZTogdGhpcy5zZWxlY3RlZF9zY2hlZHVsZV92aXNpdF9zbG90LnNwbGl0KCIgIilbMF0sCiAgICAgICAgICAgIGlzX2VkaXQ6IHRoaXMuaXNFZGl0LAogICAgICAgICAgICBhcHBvaW50bWVudF9pZDogdGhpcy5zZWxlY3RlZF9zY2hlZHVsZV9pZCwKICAgICAgICAgICAgYXBwb2ludG1lbnRfaW5mbzogYXBwb2ludG1lbnRfcGF5bG9hZAogICAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLiRzZXNzaW9uLmdldCgiYXQiKX1gLAogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLm1zZyAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLm1zZyA9PSAiRWRpdCBBcHBvaW50bWVudCIKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdG9hc3RyLnN1Y2Nlc3MoIllvdXIgYXBwb2ludG1lbnQgaGFzIGJlZW4gZWRpdGVkIHN1Y2Nlc3NmdWxseS4iKTsKICAgICAgICAgICAgICB0aGlzLmhpZGVfbW9kYWwoInNjaGVkdWxlX2NyZWF0ZSIpCiAgICAgICAgICAgICAgdGhpcy51cGRhdGVfc2NoZWR1bGVzX2xpc3QoKQogICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEubXNnID09ICJJbnRlcm5hbCBTZXJ2ZXIgRXJyb3IiKSB7CiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCJJbnRlcm5hbCBTZXJ2ZXIgRXJyb3IiKTsKICAgICAgICAgICAgICB0aGlzLmhpZGVfbW9kYWwoInNjaGVkdWxlX2RldGFpbHMiKQogICAgICAgICAgICB9CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGUgPT4gewogICAgICAgICAgICB0b2FzdHIuZXJyb3IoIkludGVybmFsIFNlcnZlciBFcnJvciIpOwogICAgICAgICAgICB0aGlzLmhpZGVfbW9kYWwoInNjaGVkdWxlX2RldGFpbHMiKQogICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSB0cnVlOwogICAgICAgIGF4aW9zCiAgICAgICAgICAucG9zdChhcGlfY2FsbHMuc2NoZWR1bGVfYXBwb2ludG1lbnRfdXJsKCksIHsKICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lLAogICAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICAgIHBob25lX251bWJlcjogdGhpcy52aXNpdG9yX251bWJlciwKICAgICAgICAgICAgY2FuZGlkYXRlX25hbWU6IHRoaXMuY2FuZGlkYXRlX25hbWUsCiAgICAgICAgICAgIGNhbmRpZGF0ZV9wb3NpdGlvbjogdGhpcy5jYW5kaWRhdGVfcG9zaXRpb24sCiAgICAgICAgICAgIGNhbmRpZGF0ZV9wb3NpdGlvbjogdGhpcy5jYW5kaWRhdGVfZW1haWwsCiAgICAgICAgICAgIHZpc2l0X3Nsb3Q6IHRoaXMuc2VsZWN0ZWRfdGltZSwKICAgICAgICAgICAgdmlzaXRfZGF0ZTogJCgiI2RhdGVwaWNrZXItaW5wdXQiKVswXS52YWx1ZQogICAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLiRzZXNzaW9uLmdldCgiYXQiKX1gLAogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLm1zZyAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLm1zZyA9PSAiQXBwb2ludG1lbnQgQWRkZWQgU3VjY2Vzc2Z1bGx5IgogICAgICAgICAgICApIHsKICAgICAgICAgICAgICB0b2FzdHIuc3VjY2VzcygiWW91ciBhcHBvaW50bWVudCBoYXMgYmVlbiBjcmVhdGVkIHN1Y2Nlc3NmdWxseS4iKTsKICAgICAgICAgICAgICB0aGlzLmhpZGVfbW9kYWwoInNjaGVkdWxlX2NyZWF0ZSIpCiAgICAgICAgICAgICAgdGhpcy51cGRhdGVfc2NoZWR1bGVzX2xpc3QoKQogICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEubXNnID09ICJJbnRlcm5hbCBTZXJ2ZXIgRXJyb3IiKSB7CiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCJJbnRlcm5hbCBTZXJ2ZXIgRXJyb3IiKTsKICAgICAgICAgICAgICB0aGlzLmhpZGVfbW9kYWwoInNjaGVkdWxlX2NyZWF0ZSIpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgIHRvYXN0ci5lcnJvcigiSW50ZXJuYWwgU2VydmVyIEVycm9yIik7CiAgICAgICAgICAgIHRoaXMuaGlkZV9tb2RhbCgic2NoZWR1bGVfY3JlYXRlIikKICAgICAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSBmYWxzZTsKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgZGVsZXRlX2FwcG9pbnRtZW50ICgpIHsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgc3dhbAogICAgICAgIC5maXJlKHsKICAgICAgICAgIHRpdGxlOiAiQXJlIHlvdSBzdXJlPyIsCiAgICAgICAgICB0ZXh0OiAiWW91IHdvbid0IGJlIGFibGUgdG8gcmV2ZXJ0IHRoaXMhIiwKICAgICAgICAgIHR5cGU6ICJ3YXJuaW5nIiwKICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IHRydWUsCiAgICAgICAgICBjb25maXJtQnV0dG9uQ29sb3I6ICIjMzA4NWQ2IiwKICAgICAgICAgIGNhbmNlbEJ1dHRvbkNvbG9yOiAiI2QzMyIsCiAgICAgICAgICBjb25maXJtQnV0dG9uVGV4dDogIlllcywgZGVsZXRlISEiCiAgICAgICAgfSkKICAgICAgICAudGhlbihyZXN1bHQgPT4gewogICAgICAgICAgaWYgKHJlc3VsdC52YWx1ZSkgewogICAgICAgICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IHRydWU7CiAgICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLnNjaGVkdWxlX2VkaXRfZGVsZXRlX3VybCgpLCB7CiAgICAgICAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUsCiAgICAgICAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICAgICAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICAgICAgICBpc19kZWxldGU6IHRydWUsCiAgICAgICAgICAgICAgICBkYXRlOiB0aGlzLnNlbGVjdGVkX3NjaGVkdWxlX3Zpc2l0X3Nsb3Quc3BsaXQoIiAiKVswXSwKICAgICAgICAgICAgICAgIGFwcG9pbnRtZW50X2lkOiB0aGlzLnNlbGVjdGVkX3NjaGVkdWxlX2lkCiAgICAgICAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLiRzZXNzaW9uLmdldCgiYXQiKX1gLAogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZV9tb2RhbCgic2NoZWR1bGVfZGV0YWlscyIpCiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5tc2cgPT0gIkRlbGV0ZWQgU3VjY2Vzc2Z1bGx5IikgewogICAgICAgICAgICAgICAgICB0b2FzdHIuc3VjY2VzcygKICAgICAgICAgICAgICAgICAgICAiWW91ciBhcHBvaW50bWVudCBoYXMgYmVlbiBkZWxldGVkIHN1Y2Nlc3NmdWxseS4iCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlX3NjaGVkdWxlc19saXN0KCkKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5tc2cgPT0gIkludGVybmFsIFNlcnZlciBFcnJvciIpIHsKICAgICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCJJbnRlcm5hbCBTZXJ2ZXIgRXJyb3IiKTsKICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlX21vZGFsKCJzY2hlZHVsZV9kZXRhaWxzIikKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC5jYXRjaChlID0+IHsKICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcigiSW50ZXJuYWwgU2VydmVyIEVycm9yIik7CiAgICAgICAgICAgICAgICB0aGlzLmhpZGVfbW9kYWwoInNjaGVkdWxlX2RldGFpbHMiKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKICAgIHJlbmRlcl9zY2hlZHVsZSAoZGF0YSkgewogICAgICBsZXQgc2NoZWR1bGUgPSBbXTsKICAgICAgZm9yICh2YXIgaSBpbiBkYXRhKSB7CiAgICAgICAgZm9yICh2YXIgaiBpbiBkYXRhW2ldKSB7CiAgICAgICAgICBpZiAoaiA9PSAiSG9saWRheSIpIHsKICAgICAgICAgICAgc2NoZWR1bGUucHVzaCh7CiAgICAgICAgICAgICAgaWQ6IGosCiAgICAgICAgICAgICAgY2FsZW5kYXJJZDogIjEiLAogICAgICAgICAgICAgIHRpdGxlOiAiSG9saWRheSIsCiAgICAgICAgICAgICAgY2F0ZWdvcnk6ICJ0aW1lIiwKICAgICAgICAgICAgICBkdWVEYXRlQ2xhc3M6ICIiLAogICAgICAgICAgICAgIHJhdzogewogICAgICAgICAgICAgICAgcmVhc29uOiBkYXRhW2ldW2pdLlJlYXNvbiwKICAgICAgICAgICAgICAgIGlzSG9saWRheTogdHJ1ZQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc3RhcnQ6IHRoaXMuc2V0X3RpbWVfaW50ZXJ2YWxzKGksICIwMDowMCIpLAogICAgICAgICAgICAgIGVuZDogdGhpcy5zZXRfdGltZV9pbnRlcnZhbHMoaSwgIjIzOjU5IikKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgLy8gQXBwb2ludG1lbnRTdGF0dXM6ICJub25lIgogICAgICAgICAgICAvLyBQaG9uZU51bWJlcjogIis5MTk4Njk1MzM5MDc2IgogICAgICAgICAgICAvLyBSZXNjaGVkdWxlZEFwcG9pbnRtZW50RnJvbTogbnVsbAogICAgICAgICAgICAvLyBSZXNjaGVkdWxlZEFwcG9pbnRtZW50VG86IG51bGwKICAgICAgICAgICAgLy8gUmVzY2hlZHVsZWRGcm9tOiBudWxsCiAgICAgICAgICAgIC8vIFJlc2NoZWR1bGVkVG86IG51bGwKICAgICAgICAgICAgLy8gU3ltcHRvbXM6ICJqampqaiIKICAgICAgICAgICAgLy8gVmlzaXREYXRlOiAiVHVlLCAxOSBBcHIgMjAyMiAwMDowMDowMCBHTVQiCiAgICAgICAgICAgIC8vIFZpc2l0UmVhc29uOiAiZ2dnIgogICAgICAgICAgICAvLyBWaXNpdFNsb3Q6ICIyMDIyLTA0LTE5IDA4OjAwLTA5OjAwIgogICAgICAgICAgICAvLyBWaXNpdFN0YXR1czogIm5vdC12aXNpdGVkIgogICAgICAgICAgICAvLyBWaXNpdG9yTmFtZTogImFraSIKCgogICAgICAgICAgICAvLyBBcHBvaW50bWVudFN0YXR1czogIm5vbmUiCiAgICAgICAgICAgIC8vIENhbmRpZGF0ZUNvbnRhY3ROdW1iZXI6ICI4ODg4ODk5OTk5IgogICAgICAgICAgICAvLyBDYW5kaWRhdGVFbWFpbDogInNhZ2FyLmJoYW51c2hhbGlAc2FrZWMuYWMuaW4iCiAgICAgICAgICAgIC8vIENhbmRpZGF0ZU5hbWU6ICJzYWdhciBiaGFudXNoYWxpIgogICAgICAgICAgICAvLyBDYW5kaWRhdGVQb3NpdGlvbjogIlB5dGhvbiIKICAgICAgICAgICAgLy8gQ2FuZGlkYXRlVmlzaXRTbG90OiAiMjAyMi0wNC0yMCAwOTo0NS0xMDoxNSIKICAgICAgICAgICAgLy8gUmVzY2hlZHVsZWRBcHBvaW50bWVudEZyb206IG51bGwKICAgICAgICAgICAgLy8gUmVzY2hlZHVsZWRBcHBvaW50bWVudFRvOiBudWxsCiAgICAgICAgICAgIC8vIFJlc2NoZWR1bGVkRnJvbTogbnVsbAogICAgICAgICAgICAvLyBSZXNjaGVkdWxlZFRvOiBudWxsCiAgICAgICAgICAgIC8vIFZpc2l0RGF0ZTogIldlZCwgMjAgQXByIDIwMjIgMDA6MDA6MDAgR01UIgogICAgICAgICAgICAvLyBWaXNpdFN0YXR1czogIm5vdC12aXNpdGVkIgoKICAgICAgICAgICAgc2NoZWR1bGUucHVzaCh7CiAgICAgICAgICAgICAgaWQ6IGosCiAgICAgICAgICAgICAgY2FsZW5kYXJJZDogIjEiLAogICAgICAgICAgICAgIHRpdGxlOiBkYXRhW2ldW2pdLkNhbmRpZGF0ZU5hbWUsCiAgICAgICAgICAgICAgLy90aXRsZTogdGhpcy5jYWxlbmRhckluc3RhbmNlLnRlbXBsYXRlKCksCiAgICAgICAgICAgICAgY2F0ZWdvcnk6ICJ0aW1lIiwKICAgICAgICAgICAgICBkdWVEYXRlQ2xhc3M6ICIiLAogICAgICAgICAgICAgIHJhdzogewogICAgICAgICAgICAgICAgcGhvbmVfbnVtYmVyOiBkYXRhW2ldW2pdLkNhbmRpZGF0ZUNvbnRhY3ROdW1iZXIsCiAgICAgICAgICAgICAgICBjYW5kaWRhdGVfcG9zaXRpb246IGRhdGFbaV1bal0uQ2FuZGlkYXRlUG9zaXRpb24sCiAgICAgICAgICAgICAgICBjYW5kaWRhdGVfZW1haWw6IGRhdGFbaV1bal0uQ2FuZGlkYXRlRW1haWwsCiAgICAgICAgICAgICAgICAvLyByZWFzb246IGRhdGFbaV1bal0uVmlzaXRSZWFzb24sCiAgICAgICAgICAgICAgICAvLyBzeW1wdG9tczogZGF0YVtpXVtqXS5TeW1wdG9tcywKICAgICAgICAgICAgICAgIHZpc2l0X3Nsb3Q6IGRhdGFbaV1bal0uQ2FuZGlkYXRlVmlzaXRTbG90LAogICAgICAgICAgICAgICAgc3RhcnQ6IGRhdGFbaV1bal0uQ2FuZGlkYXRlVmlzaXRTbG90LnNwbGl0KCIgIilbMV0uc3BsaXQoIi0iKVswXSwKICAgICAgICAgICAgICAgIGVuZDogZGF0YVtpXVtqXS5DYW5kaWRhdGVWaXNpdFNsb3Quc3BsaXQoIiAiKVsxXS5zcGxpdCgiLSIpWzFdLAogICAgICAgICAgICAgICAgaXNIb2xpZGF5OiBmYWxzZSwKICAgICAgICAgICAgICAgIGFwcG9pbnRtZW50X3N0YXR1czogZGF0YVtpXVtqXS5BcHBvaW50bWVudFN0YXR1cywKICAgICAgICAgICAgICAgIHZpc2l0X3N0YXR1czogZGF0YVtpXVtqXS5WaXNpdFN0YXR1cywKICAgICAgICAgICAgICAgIGFwcG9pbnRtZW50X2lkOiBqCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzdGFydDogdGhpcy5zZXRfdGltZV9pbnRlcnZhbHMoCiAgICAgICAgICAgICAgICBkYXRhW2ldW2pdLkNhbmRpZGF0ZVZpc2l0U2xvdC5zcGxpdCgiICIpWzBdLAogICAgICAgICAgICAgICAgZGF0YVtpXVtqXS5DYW5kaWRhdGVWaXNpdFNsb3Quc3BsaXQoIiAiKVsxXS5zcGxpdCgiLSIpWzBdCiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICBlbmQ6IGRhdGFbaV1bal0uQ2FuZGlkYXRlVmlzaXRTbG90LnNwbGl0KCIgIilbMV0uc3BsaXQoIi0iKVsxXSA9PSAiMDA6MDAiCiAgICAgICAgICAgICAgPyB0aGlzLnNldF90aW1lX2ludGVydmFscygKICAgICAgICAgICAgICAgICAgZGF0YVtpXVtqXS5DYW5kaWRhdGVWaXNpdFNsb3Quc3BsaXQoIiAiKVswXSwKICAgICAgICAgICAgICAgICAgIjIzOjU5IgogICAgICAgICAgICAgICAgKTp0aGlzLnNldF90aW1lX2ludGVydmFscygKICAgICAgICAgICAgICAgICAgZGF0YVtpXVtqXS5DYW5kaWRhdGVWaXNpdFNsb3Quc3BsaXQoIiAiKVswXSwKICAgICAgICAgICAgICAgICAgZGF0YVtpXVtqXS5DYW5kaWRhdGVWaXNpdFNsb3Quc3BsaXQoIiAiKVsxXS5zcGxpdCgiLSIpWzFdCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLnNjaGVkdWxlX2xpc3QgPSBzY2hlZHVsZTsKICAgICAgdGhpcy5jYWxlbmRhckluc3RhbmNlLmNsZWFyKCkKICAgICAgdGhpcy5jYWxlbmRhckluc3RhbmNlLmNyZWF0ZVNjaGVkdWxlcyhzY2hlZHVsZSk7CiAgICAgIHRoaXMuY2FsZW5kYXJJbnN0YW5jZS5yZW5kZXIoKTsKICAgIH0sCiAgICBzZXRSZW5kZXJSYW5nZVRleHQgKCkgewogICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IGZhbHNlOwogICAgICB2YXIgcmVuZGVyUmFuZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVuZGVyUmFuZ2UiKTsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLmNhbGVuZGFySW5zdGFuY2UuZ2V0T3B0aW9ucygpOwogICAgICB2YXIgdmlld05hbWUgPSB0aGlzLmNhbGVuZGFySW5zdGFuY2UuZ2V0Vmlld05hbWUoKTsKICAgICAgdmFyIGh0bWwgPSBbXTsKICAgICAgaWYgKAogICAgICAgICh2aWV3TmFtZSA9PT0gIm1vbnRoIiAmJgogICAgICAgICAgKCFvcHRpb25zLm1vbnRoLnZpc2libGVXZWVrc0NvdW50IHx8CiAgICAgICAgICAgIG9wdGlvbnMubW9udGgudmlzaWJsZVdlZWtzQ291bnQgPiA0KQogICAgICAgICAgfHwgdmlld05hbWUgPT09ICJkYXkiKQogICAgICApIHsKICAgICAgICBodG1sLnB1c2goCiAgICAgICAgICBtb21lbnQodGhpcy5jYWxlbmRhckluc3RhbmNlLmdldERhdGUoKS5nZXRUaW1lKCkpLmZvcm1hdCgKICAgICAgICAgICAgIk1NTU0gWVlZWSIKICAgICAgICAgICkKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIGxldCBzdGFydERhdGUgPSB0aGlzLmNhbGVuZGFySW5zdGFuY2UuZ2V0RGF0ZVJhbmdlU3RhcnQoKS5nZXRUaW1lKCkKICAgICAgICBsZXQgZW5kRGF0ZSA9IHRoaXMuY2FsZW5kYXJJbnN0YW5jZS5nZXREYXRlUmFuZ2VFbmQoKS5nZXRUaW1lKCkKCiAgICAgICAgaWYgKG1vbWVudChlbmREYXRlKS5zdWJ0cmFjdChzdGFydERhdGUsICd5ZWFyJykpIHsKICAgICAgICAgIGh0bWwucHVzaCgKICAgICAgICAgICAgYCR7bW9tZW50KHN0YXJ0RGF0ZSkuZm9ybWF0KCJEIE1NTU0gWVlZWSIpfSB0byAke21vbWVudChlbmREYXRlKS5mb3JtYXQoIkQgTU1NTSBZWVlZIil9YAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKG1vbWVudChlbmREYXRlKS5zdWJ0cmFjdChzdGFydERhdGUsICdtb250aCcpKSB7CiAgICAgICAgICBodG1sLnB1c2goCiAgICAgICAgICAgIGAke21vbWVudChzdGFydERhdGUpLmZvcm1hdCgiRCBNTU1NIil9IHRvICR7bW9tZW50KGVuZERhdGUpLmZvcm1hdCgiRCBNTU1NIFlZWVkiKX1gCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBodG1sLnB1c2goCiAgICAgICAgICAgIGAke21vbWVudChzdGFydERhdGUpLmZvcm1hdCgiRCIpfSB0byAke21vbWVudChlbmREYXRlKS5mb3JtYXQoIkQgTU1NTSBZWVlZIil9YAogICAgICAgICAgKTsKICAgICAgICB9CgogICAgICB9CiAgICAgIHRoaXMuZ2VuZXJhdGVfZGF5c19pbl9tb250aChtb21lbnQodGhpcy5jYWxlbmRhckluc3RhbmNlLmdldERhdGUoKS5nZXRUaW1lKCkpLmZvcm1hdCgnRCcpLCBtb21lbnQodGhpcy5jYWxlbmRhckluc3RhbmNlLmdldERhdGUoKS5nZXRUaW1lKCkpLmZvcm1hdCgnTU1NTScpLCBtb21lbnQodGhpcy5jYWxlbmRhckluc3RhbmNlLmdldERhdGUoKS5nZXRUaW1lKCkpLmZvcm1hdCgiWVlZWSIpKQogICAgICByZW5kZXJSYW5nZS5pbm5lckhUTUwgPSBodG1sLmpvaW4oIiIpOwogICAgICB0aGlzLmRhaWx5X2RhdGUgPSByZW5kZXJSYW5nZS5pbm5lckhUTUw7CiAgICB9LAogICAgZGF0ZV9jb25kaXRpb24gKGZyb21fb2JqZWN0LCB0b19vYmplY3QpIHsKICAgICAgaWYgKGZyb21fb2JqZWN0ICE9PSBudWxsICYmIHRvX29iamVjdCAhPT0gbnVsbCkgewogICAgICAgIGlmICh0b19vYmplY3QuZ2V0RnVsbFllYXIoKSA+IGZyb21fb2JqZWN0LmdldEZ1bGxZZWFyKCkpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAodG9fb2JqZWN0LmdldEZ1bGxZZWFyKCkgPT0gZnJvbV9vYmplY3QuZ2V0RnVsbFllYXIoKSkgewogICAgICAgICAgaWYgKHRvX29iamVjdC5nZXRNb250aCgpID4gZnJvbV9vYmplY3QuZ2V0TW9udGgoKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAodG9fb2JqZWN0LmdldE1vbnRoKCkgPT0gZnJvbV9vYmplY3QuZ2V0TW9udGgoKSkgewogICAgICAgICAgICBpZiAoTnVtYmVyKHRvX29iamVjdC5nZXREYXRlKCkpID49IE51bWJlcihmcm9tX29iamVjdC5nZXREYXRlKCkpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gZWxzZSByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoZnJvbV9vYmplY3QgPT09IG51bGwgJiYgdG9fb2JqZWN0ID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSByZXR1cm4gZmFsc2U7CiAgICB9LAogICAgdG9nZ2xlX3ZpZXcgKHR5cGUpIHsKICAgICAgaWYgKHR5cGUgPT0gImRheSIpIHsKICAgICAgICB0aGlzLnNob3dfY2hlY2tfYW5kX2NoYW5nZV9zdGF0dXMgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2hvd19jaGVja19hbmRfY2hhbmdlX3N0YXR1cyA9IGZhbHNlOwogICAgICB9CiAgICAgIHRoaXMuY2FsZW5kYXJJbnN0YW5jZS5jaGFuZ2VWaWV3KHR5cGUsIHRydWUpOwogICAgICB0aGlzLnNldFJlbmRlclJhbmdlVGV4dCgpOwogICAgfSwKICAgIHN3aXRjaF9jYWxlbmRhciAodHlwZSwgZGF0ZSkgewogICAgICBpZiAodHlwZSA9PSAidG9kYXkiKSB7CiAgICAgICAgdGhpcy5jdXJyZW50X2NhbGVuZGFyX3ZpZXcgPSAiZGF5IjsKICAgICAgICB0aGlzLmNhbGVuZGFySW5zdGFuY2UudG9kYXkoKTsKICAgICAgICAvLyB0aGlzLnNldFJlbmRlclJhbmdlVGV4dCgpOwogICAgICB9IGVsc2UgaWYgKAogICAgICAgIHRoaXMuY2FsZW5kYXJJbnN0YW5jZS5fdmlld05hbWUgPT0gIndlZWsiIHx8CiAgICAgICAgdGhpcy5jYWxlbmRhckluc3RhbmNlLl92aWV3TmFtZSA9PSAiZGF5IgogICAgICApIHsKICAgICAgICBpZiAodHlwZSA9PSAibmV4dCIpIHsKICAgICAgICAgIHRoaXMuY2FsZW5kYXJJbnN0YW5jZS5uZXh0KCk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09ICJwcmV2IikgewogICAgICAgICAgdGhpcy5jYWxlbmRhckluc3RhbmNlLnByZXYoKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAiY3VzdG9tIikgewogICAgICAgICAgdGhpcy5jYWxlbmRhckluc3RhbmNlLnNldERhdGUobmV3IERhdGUodGhpcy5jYWxlbmRhckluc3RhbmNlLmdldERhdGUoKS5zZXREYXRlKGRhdGUpKSkKICAgICAgICB9CiAgICAgICAgLy8gdGhpcy5zZXRSZW5kZXJSYW5nZVRleHQoKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmNhbGVuZGFySW5zdGFuY2UuX3ZpZXdOYW1lID09ICJtb250aCIpIHsKICAgICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IHRydWU7CiAgICAgICAgaWYgKHR5cGUgPT0gIm5leHQiKSB7CiAgICAgICAgICB0aGlzLmNhbGVuZGFySW5zdGFuY2UubmV4dCgpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PSAicHJldiIpIHsKICAgICAgICAgIHRoaXMuY2FsZW5kYXJJbnN0YW5jZS5wcmV2KCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gdHJ1ZTsKICAgICAgYXhpb3MKICAgICAgICAucG9zdChhcGlfY2FsbHMuaHJfZ2V0X3NjaGVkdWxlX2luZm9fdXJsKCksIHsKICAgICAgICAgIGNvbXBhbnlfbmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZSwKICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkLAogICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICB0b2tlbjogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnRva2VucywKICAgICAgICAgIGZpcnN0X2RheTogdGhpcy5tb250aF9yYW5nZSgic3RhcnRfdGltZSIpLAogICAgICAgICAgbGFzdF9kYXk6IHRoaXMubW9udGhfcmFuZ2UoImVuZF90aW1lIikKICAgICAgICB9LAogICAgICB7CiAgICAgICAgaGVhZGVyczogewogICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuJHNlc3Npb24uZ2V0KCJhdCIpfWAsCiAgICAgICAgfQogICAgICB9KQogICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnJlbmRlcl9zY2hlZHVsZShyZXNwb25zZS5kYXRhLlNjaGVkdWxpbmdfaW5mbyk7CiAgICAgICAgfSk7CiAgICAgIHRoaXMuc2V0UmVuZGVyUmFuZ2VUZXh0KCk7CiAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICB9LAogICAgbW9udGhfcmFuZ2UgKHR5cGUpIHsKICAgICAgbGV0IHRpbWUgPSBtb21lbnQodGhpcy5jYWxlbmRhckluc3RhbmNlLmdldERhdGUoKS5nZXRUaW1lKCkpOwogICAgICB0aW1lID0gbW9tZW50KHRpbWUpLmRheXNJbk1vbnRoKCk7CiAgICAgIGlmICh0eXBlID09ICJzdGFydF90aW1lIikgewogICAgICAgIGxldCBzdGFydF90aW1lID0gbnVsbDsKICAgICAgICBpZih0aGlzLmNhbGVuZGFySW5zdGFuY2UuX3ZpZXdOYW1lID09ICJ3ZWVrIil7CiAgICAgICAgICBzdGFydF90aW1lID0gdGhpcy5jYWxlbmRhckluc3RhbmNlLl9yZW5kZXJSYW5nZS5zdGFydC5fZGF0ZQogICAgICAgIH1lbHNlIHsKICAgICAgICAgIHN0YXJ0X3RpbWUgPSBuZXcgRGF0ZSgKICAgICAgICAgICAgdGhpcy5jYWxlbmRhckluc3RhbmNlLmdldERhdGUoKS5fZGF0ZS5nZXRGdWxsWWVhcigpLAogICAgICAgICAgICB0aGlzLmNhbGVuZGFySW5zdGFuY2UuZ2V0RGF0ZSgpLl9kYXRlLmdldE1vbnRoKCksCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHN0YXJ0X3RpbWUgPQogICAgICAgICAgc3RhcnRfdGltZS5nZXRGdWxsWWVhcigpICsKICAgICAgICAgICItIiArCiAgICAgICAgICAoc3RhcnRfdGltZS5nZXRNb250aCgpIDwgOQogICAgICAgICAgICA/ICIwIiArIChzdGFydF90aW1lLmdldE1vbnRoKCkgKyAxKQogICAgICAgICAgICA6IHN0YXJ0X3RpbWUuZ2V0TW9udGgoKSArIDEpICsKICAgICAgICAgICItIiArCiAgICAgICAgICAoc3RhcnRfdGltZS5nZXREYXRlKCkgPCAxMAogICAgICAgICAgICA/ICIwIiArIHN0YXJ0X3RpbWUuZ2V0RGF0ZSgpCiAgICAgICAgICAgIDogc3RhcnRfdGltZS5nZXREYXRlKCkpOwogICAgICAgIHJldHVybiBzdGFydF90aW1lOwogICAgICB9IGVsc2UgaWYgKHR5cGUgPT0gImVuZF90aW1lIikgewogICAgICAgIGxldCBlbmRfdGltZSA9IG51bGw7CiAgICAgICAgaWYodGhpcy5jYWxlbmRhckluc3RhbmNlLl92aWV3TmFtZSA9PSAid2VlayIpewogICAgICAgICAgZW5kX3RpbWUgPSB0aGlzLmNhbGVuZGFySW5zdGFuY2UuX3JlbmRlclJhbmdlLmVuZC5fZGF0ZQogICAgICAgIH1lbHNlIHsKICAgICAgICAgICAgZW5kX3RpbWUgPSBuZXcgRGF0ZSgKICAgICAgICAgICAgdGhpcy5jYWxlbmRhckluc3RhbmNlLmdldERhdGUoKS5fZGF0ZS5nZXRGdWxsWWVhcigpLAogICAgICAgICAgICB0aGlzLmNhbGVuZGFySW5zdGFuY2UuZ2V0RGF0ZSgpLl9kYXRlLmdldE1vbnRoKCksCiAgICAgICAgICAgIHRpbWUKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGVuZF90aW1lID0KICAgICAgICAgIGVuZF90aW1lLmdldEZ1bGxZZWFyKCkgKwogICAgICAgICAgIi0iICsKICAgICAgICAgIChlbmRfdGltZS5nZXRNb250aCgpIDwgOQogICAgICAgICAgICA/ICIwIiArIChlbmRfdGltZS5nZXRNb250aCgpICsgMSkKICAgICAgICAgICAgOiBlbmRfdGltZS5nZXRNb250aCgpICsgMSkgKwogICAgICAgICAgIi0iICsKICAgICAgICAgIChlbmRfdGltZS5nZXREYXRlKCkgPCAxMAogICAgICAgICAgICA/ICIwIiArIGVuZF90aW1lLmdldERhdGUoKQogICAgICAgICAgICA6IGVuZF90aW1lLmdldERhdGUoKSk7CiAgICAgICAgcmV0dXJuIGVuZF90aW1lOwogICAgICB9CiAgICB9LAogICAgZ2VuZXJhdGVfZGF5c19pbl9tb250aCAoZGF5LCBtb250aCwgeWVhcikgewogICAgICBsZXQgdG90YWxfZGF5cyA9IG1vbWVudChgJHttb250aH0gJHt5ZWFyfWAsIFsnTU1NTSBZWVlZJ10pLmRheXNJbk1vbnRoKCkKICAgICAgdGhpcy5kYXlzSW5Nb250aCA9IFtdCiAgICAgIGZvciAobGV0IGkgPSAxLCBuID0gdG90YWxfZGF5czsgaSA8PSBuOyBpKyspIHsKICAgICAgICB0aGlzLmRheXNJbk1vbnRoLnB1c2goewogICAgICAgICAgZGF5OiBtb21lbnQoYCR7aX0gJHttb250aH0gJHt5ZWFyfWAsIFsnRCBNTU1NIFlZWVknXSkuZm9ybWF0KCdkZCcpLAogICAgICAgICAgZGF0ZTogaSwKICAgICAgICAgIGlzX2FjdGl2ZTogbW9tZW50KGAke2RheX0gJHttb250aH0gJHt5ZWFyfWAsIFsnRCBNTU1NIFlZWVknXSkuaXNTYW1lKG1vbWVudChgJHtpfSAke21vbnRofSAke3llYXJ9YCwgWydEIE1NTU0gWVlZWSddKSwgJ2RheScpCiAgICAgICAgfSkKICAgICAgfQogICAgfSwKICAgIHNldF90aW1lX2ludGVydmFscyAoeWVhciwgdGltZSkgewogICAgICB2YXIgdm0gPSBuZXcgRGF0ZSgKICAgICAgICB5ZWFyLnNwbGl0KCItIilbMF0sCiAgICAgICAgeWVhci5zcGxpdCgiLSIpWzFdIC0gMSwKICAgICAgICB5ZWFyLnNwbGl0KCItIilbMl0sCiAgICAgICAgdGltZS5zcGxpdCgiOiIpWzBdLAogICAgICAgIHRpbWUuc3BsaXQoIjoiKVsxXQogICAgICApOwogICAgICB2bSA9IG1vbWVudCh2bSkuZm9ybWF0KCk7CiAgICAgIHJldHVybiB2bTsKICAgIH0sCiAgICBvcGVuQ2hlY2tBbmRDaGFuZ2VTdGF0dXNNb2RhbCAoQXBwb2ludG1lbnRJRCwgc2NoZWR1bGVEYXRlKSB7CiAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gdHJ1ZTsKICAgICAgLy8gdmFyIGRhdGVUb1NlbmQgPSBtb21lbnQodGhpcy5jYWxlbmRhckluc3RhbmNlLmdldERhdGUoKS5nZXRUaW1lKCkpLmZvcm1hdCgKICAgICAgLy8gICAiWVlZWS1NTS1ERCIKICAgICAgLy8gKTsKCiAgICAgIHZhciBkYXRlVG9TZW5kID0gbW9tZW50KHNjaGVkdWxlRGF0ZSkuZm9ybWF0KAogICAgICAgICJZWVlZLU1NLUREIgogICAgICApOwoKICAgICAgLy8gdmFyIGRhdGVvYmogPSBuZXcgRGF0ZShtb21lbnQodGhpcy5jYWxlbmRhckluc3RhbmNlLmdldERhdGUoKS5nZXRUaW1lKCkpLmZvcm1hdCgiTU1NTSBERCwgWVlZWSIpKTsKICAgICAgYXhpb3MKICAgICAgICAucG9zdChhcGlfY2FsbHMuaHJfdmlzaXRfc3RhdHVzX2luZm8oKSwgewogICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lLAogICAgICAgICAgY29tcGFueV9pZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfaWQsCiAgICAgICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgIHRva2VuOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikudG9rZW5zLAogICAgICAgICAgZGF0ZTogZGF0ZVRvU2VuZCwKICAgICAgICAgIGlzX2dldDogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5kYXRhLmxlbmd0aCAhPSAwKSB7CiAgICAgICAgICAgIGxldCBhcHBvaW50bWVudEZpbHRlciA9IHJlc3BvbnNlLmRhdGEuZGF0YS5maWx0ZXIoYXBwdCA9PiB7CiAgICAgICAgICAgICAgcmV0dXJuIGFwcHRbIkFwcG9pbnRtZW50SUQiXSA9PSBBcHBvaW50bWVudElECiAgICAgICAgICAgIH0pCgogICAgICAgICAgICBpZiAoYXBwb2ludG1lbnRGaWx0ZXIubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgdGhpcy52aXNpdFN0YXR1cyA9IGFwcG9pbnRtZW50RmlsdGVyWzBdWyJWaXNpdFN0YXR1cyJdCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmlzaXRfc3RhdHVzX2RhdGEgPSByZXNwb25zZS5kYXRhLmRhdGE7CiAgICAgICAgICAgIHZhciBjb25maXJtZWRfYXBwdCA9IFtdOwogICAgICAgICAgICB2YXIgbm9uZV9hcHB0ID0gW107CiAgICAgICAgICAgIHZhciByZXNjaGVkdWxlX2FwcHQgPSBbXTsKICAgICAgICAgICAgdmFyIGRlbGV0ZWRfYXBwdCA9IFtdOwoKICAgICAgICAgICAgLy8gdGhpcy52aXNpdF9zdGF0dXNfY29tcGFyaXNvbl9kYXRhID0gdGhpcy52aXNpdF9zdGF0dXNfZGF0YS5zbGljZSgpOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudmlzaXRfc3RhdHVzX2RhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRoaXMuc2NoZWR1bGVfbGlzdC5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgLy8gdGhpcy52aXNpdF9zdGF0dXNfZGF0YVtpXVsiQ29tcGFyZVZpc2l0U3RhdHVzIl0gPQogICAgICAgICAgICAgICAgLy8gICByZXNwb25zZS5kYXRhLmRhdGFbaV0uVmlzaXRTdGF0dXM7CiAgICAgICAgICAgICAgICBpZiAodGhpcy52aXNpdF9zdGF0dXNfZGF0YVtpXS5BcHBvaW50bWVudElEID09PSB0aGlzLnNjaGVkdWxlX2xpc3Rbal0uaWQpIHsKICAgICAgICAgICAgICAgICAgdGhpcy52aXNpdF9zdGF0dXNfZGF0YVtpXVsiQXBwb2ludG1lbnRTdGF0dXMiXSA9IHRoaXMuc2NoZWR1bGVfbGlzdFtqXS5yYXcuYXBwb2ludG1lbnRfc3RhdHVzCiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnZpc2l0X3N0YXR1c19kYXRhW2ldWyJBcHBvaW50bWVudFN0YXR1cyJdID09PSAnY29uZmlybWVkJykgewogICAgICAgICAgICAgICAgICAgIGNvbmZpcm1lZF9hcHB0LnB1c2godGhpcy52aXNpdF9zdGF0dXNfZGF0YVtpXSkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodGhpcy52aXNpdF9zdGF0dXNfZGF0YVtpXVsiQXBwb2ludG1lbnRTdGF0dXMiXSA9PT0gJ25vbmUnKSB7CiAgICAgICAgICAgICAgICAgICAgbm9uZV9hcHB0LnB1c2godGhpcy52aXNpdF9zdGF0dXNfZGF0YVtpXSkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodGhpcy52aXNpdF9zdGF0dXNfZGF0YVtpXVsiQXBwb2ludG1lbnRTdGF0dXMiXSA9PT0gJ3Jlc2NoZWR1bGVkJykgewogICAgICAgICAgICAgICAgICAgIHJlc2NoZWR1bGVfYXBwdC5wdXNoKHRoaXMudmlzaXRfc3RhdHVzX2RhdGFbaV0pCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudmlzaXRfc3RhdHVzX2RhdGFbaV1bIkFwcG9pbnRtZW50U3RhdHVzIl0gPT09ICdkZWxldGVkJykgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZWRfYXBwdC5wdXNoKHRoaXMudmlzaXRfc3RhdHVzX2RhdGFbaV0pCiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIC8vICB0aGlzLnZpc2l0X3N0YXR1c19kYXRhID0gW107CiAgICAgICAgICAgICAgICAgIC8vICB0aGlzLnZpc2l0X3N0YXR1c19kYXRhICs9IG5vbmVfYXBwdDsKICAgICAgICAgICAgICAgICAgLy8gIHRoaXMudmlzaXRfc3RhdHVzX2RhdGEgKz0gY29uZmlybWVkX2FwcHQ7CiAgICAgICAgICAgICAgICAgIC8vICB0aGlzLnZpc2l0X3N0YXR1c19kYXRhICs9IHJlc2NoZWR1bGVfYXBwdDsKICAgICAgICAgICAgICAgICAgLy8gIHRoaXMudmlzaXRfc3RhdHVzX2RhdGEgKz0gZGVsZXRlZF9hcHB0OwoKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIHRoaXMudmlzaXRfc3RhdHVzX2NvbXBhcmlzb25fZGF0YS5wdXNoKHJlc3BvbnNlLmRhdGEuZGF0YVtpXSk7CiAgICAgICAgICAgICAgICB0aGlzLnZpc2l0X3N0YXR1c19kYXRhW2ldWyJDb21wYXJlVmlzaXRTdGF0dXMiXSA9CiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZGF0YVtpXS5WaXNpdFN0YXR1czsKCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudmlzaXRfc3RhdHVzX2RhdGEgPSBbXTsKICAgICAgICAgICAgdGhpcy52aXNpdF9zdGF0dXNfZGF0YSA9IHRoaXMudmlzaXRfc3RhdHVzX2RhdGEuY29uY2F0KG5vbmVfYXBwdCwgY29uZmlybWVkX2FwcHQsIHJlc2NoZWR1bGVfYXBwdCwgZGVsZXRlZF9hcHB0KTsKICAgICAgICAgICAgLy8gIHRoaXMudmlzaXRfc3RhdHVzX2RhdGEuY29uY2F0KCBjb25maXJtZWRfYXBwdCk7CiAgICAgICAgICAgIC8vICB0aGlzLnZpc2l0X3N0YXR1c19kYXRhLmNvbmNhdChyZXNjaGVkdWxlX2FwcHQpOwogICAgICAgICAgICAvLyAgdGhpcy52aXNpdF9zdGF0dXNfZGF0YS5jb25jYXQoZGVsZXRlZF9hcHB0KTsKCiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmIChyZXNwb25zZS5kYXRhLm1zZyA9PT0gJ05vIEFwcG9pbnRtZW50cyBTY2hlZHVsZWQnIHx8IHJlc3BvbnNlLmRhdGEuZGF0YS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgdGhpcy52aXNpdF9zdGF0dXNfZGF0YSA9IFtdOwogICAgICAgICAgICBzd2FsCiAgICAgICAgICAgICAgLmZpcmUoewogICAgICAgICAgICAgICAgdGV4dDogIk5vIEFwcG9pbnRtZW50cyBoYXZlIGJlZW4gc2NoZWR1bGVkIGZvciAiICsgIiAiICsgdGhpcy5kYWlseV9kYXRlLAogICAgICAgICAgICAgICAgdHlwZTogIndhcm5pbmciLAogICAgICAgICAgICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiAiIzMwODVkNiIsCiAgICAgICAgICAgICAgICBjYW5jZWxCdXR0b25Db2xvcjogIiNkMzMiLAogICAgICAgICAgICAgICAgY29uZmlybUJ1dHRvblRleHQ6ICJPa2F5IgogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgLnRoZW4ocmVzdWx0ID0+IHsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goZXJyID0+IHsKICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgICB0b2FzdHIuZXJyb3IoIkludGVybmFsIFNlcnZlciBFcnJvciIpCiAgICAgICAgfSkKICAgICAgICA7CiAgICB9LAogICAgY2hhbmdlU2luZ2xlVmlzaXRTdGF0dXMoKXsKICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSB0cnVlOwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB2YXIgZGF0ZVRvU2VuZCA9ICQoIiNkYXRlcGlja2VyLWlucHV0IilbMF0udmFsdWU7CiAgICAgIHZhciBmb3JtTGVuZ3RoID0gdGhpcy52aXNpdF9zdGF0dXNfZGF0YS5sZW5ndGg7CiAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZvcm1MZW5ndGg7IGkrKykgewogICAgICAgIGlmKHRoaXMudmlzaXRfc3RhdHVzX2RhdGFbaV0uQXBwb2ludG1lbnRJRCA9PT0gdGhpcy5BcHBvaW50bWVudElEKXsKICAgICAgICBhcnJheS5wdXNoKHsKICAgICAgICAgICAgQXBwb2ludG1lbnRJRDogdGhpcy52aXNpdF9zdGF0dXNfZGF0YVtpXS5BcHBvaW50bWVudElELAogICAgICAgICAgICBWaXNpdG9yTmFtZTogdGhpcy52aXNpdF9zdGF0dXNfZGF0YVtpXS5WaXNpdG9yTmFtZSwKICAgICAgICAgICAgVmlzaXRTbG90OiB0aGlzLnZpc2l0X3N0YXR1c19kYXRhW2ldLlZpc2l0U2xvdCwKICAgICAgICAgICAgQXBwb2ludG1lbnRTdGF0dXM6IHRoaXMudmlzaXRfc3RhdHVzX2RhdGFbaV0uQXBwb2ludG1lbnRTdGF0dXMsCiAgICAgICAgICAgIFZpc2l0U3RhdHVzOiB0aGlzLnZpc2l0U3RhdHVzCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGFycmF5Lmxlbmd0aCA+IDApIHsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmhyX3Zpc2l0X3N0YXR1c19pbmZvKCksIHsKICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lLAogICAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICAgIHJlc3BvbnNlX3Zpc2l0X3N0YXR1czogYXJyYXksCiAgICAgICAgICAgIGlzX2VkaXQ6IHRydWUsCiAgICAgICAgICAgIGRhdGU6IGRhdGVUb1NlbmQKICAgICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IGZhbHNlOwogICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5tc2cgPT0gIlZpc2l0IFN0YXR1cyBFZGl0ZWQiKSB7CiAgICAgICAgICAgICAgdG9hc3RyLnN1Y2Nlc3MoIlZpc2l0IFN0YXR1cyBDaGFuZ2VkIFN1Y2Nlc3NmdWxseSIpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSBmYWxzZTsKICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoIlNvbWUgRXJyb3IgT2NjdXJyZWQiKQogICAgICAgICAgICB9CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGVycm9yID0+IHsKICAgICAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSBmYWxzZTsKICAgICAgICAgICAgdG9hc3RyLmVycm9yKCJTb21lIEVycm9yIE9jY3VycmVkIikKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgY2hhbmdlVmlzaXRTdGF0dXMgKCkgewogICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IHRydWU7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIHZhciBkYXRlVG9TZW5kID0gJCgiI2RhdGVwaWNrZXItaW5wdXQiKVswXS52YWx1ZTsKICAgICAgdmFyIGZvcm1MZW5ndGggPSB0aGlzLnZpc2l0X3N0YXR1c19kYXRhLmxlbmd0aDsKICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZm9ybUxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKAogICAgICAgICAgdGhpcy52aXNpdF9zdGF0dXNfZGF0YVtpXS5Db21wYXJlVmlzaXRTdGF0dXMgPT09CiAgICAgICAgICB0aGlzLnZpc2l0U3RhdHVzCiAgICAgICAgICAvLyB0aGlzLnZpc2l0X3N0YXR1c19kYXRhW2ldLlZpc2l0U3RhdHVzCiAgICAgICAgKSB7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFycmF5LnB1c2goewogICAgICAgICAgICBBcHBvaW50bWVudElEOiB0aGlzLnZpc2l0X3N0YXR1c19kYXRhW2ldLkFwcG9pbnRtZW50SUQsCiAgICAgICAgICAgIFZpc2l0b3JOYW1lOiB0aGlzLnZpc2l0X3N0YXR1c19kYXRhW2ldLlZpc2l0b3JOYW1lLAogICAgICAgICAgICBWaXNpdFNsb3Q6IHRoaXMudmlzaXRfc3RhdHVzX2RhdGFbaV0uVmlzaXRTbG90LAogICAgICAgICAgICBBcHBvaW50bWVudFN0YXR1czogdGhpcy52aXNpdF9zdGF0dXNfZGF0YVtpXS5BcHBvaW50bWVudFN0YXR1cywKICAgICAgICAgICAgVmlzaXRTdGF0dXM6IHRoaXMudmlzaXRTdGF0dXMKICAgICAgICAgICAgLy8gVmlzaXRTdGF0dXM6IHRoaXMudmlzaXRfc3RhdHVzX2RhdGFbaV0uVmlzaXRTdGF0dXMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoYXJyYXkubGVuZ3RoID4gMCkgewogICAgICAgIGF4aW9zCiAgICAgICAgICAucG9zdChhcGlfY2FsbHMuaHJfdmlzaXRfc3RhdHVzX2luZm8oKSwgewogICAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUsCiAgICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkLAogICAgICAgICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnRva2VucywKICAgICAgICAgICAgcmVzcG9uc2VfdmlzaXRfc3RhdHVzOiBhcnJheSwKICAgICAgICAgICAgaXNfZWRpdDogdHJ1ZSwKICAgICAgICAgICAgZGF0ZTogZGF0ZVRvU2VuZAogICAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLiRzZXNzaW9uLmdldCgiYXQiKX1gLAogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLm1zZyA9PSAiVmlzaXQgU3RhdHVzIEVkaXRlZCIpIHsKICAgICAgICAgICAgICB0b2FzdHIuc3VjY2VzcygiVmlzaXQgU3RhdHVzIENoYW5nZWQgU3VjY2Vzc2Z1bGx5IikKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IGZhbHNlOwogICAgICAgICAgICAgIHRvYXN0ci5lcnJvcigiU29tZSBFcnJvciBPY2N1cnJlZCIpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4gewogICAgICAgICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IGZhbHNlOwogICAgICAgICAgICB0b2FzdHIuZXJyb3IoIlNvbWUgRXJyb3IgT2NjdXJyZWQiKQogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICBjb25maXJtUmVzY2hlZHVsZSAoKSB7CiAgICAgIGNvbnN0IGlzX2ludmFsaWQgPSAobW9tZW50KHRoaXMudGVtcF9hcHBvaW50bWVudF9kYXRlLCBbJ01NLURELVlZWVknXSkKICAgICAgICAuZGlmZihtb21lbnQoJCgiI2RhdGVwaWNrZXItaW5wdXQiKVswXS52YWx1ZSwgWydZWVlZLU1NLUREJ10pLCAiZGF5IikgPT09IDApCiAgICAgICAgJiYgKHRoaXMudGVtcF9hcHBvaW50bWVudF90aW1lID09IHRoaXMuc2VsZWN0ZWRfdGltZSk7CiAgICAgIGlmIChpc19pbnZhbGlkKSB7CiAgICAgICAgc3dhbAogICAgICAgICAgLmZpcmUoewogICAgICAgICAgICB0eXBlOiAid2FybmluZyIsCiAgICAgICAgICAgIHRleHQ6ICJJdCBsb29rcyBsaWtlIHlvdSBoYXZlIG5vdCBtYWRlIGFueSBjaGFuZ2UgdG8gdGhlIGFwcG9pbnRtZW50IGRhdGUgYW5kIGFwcG9pbnRtZW50IHRpbWUiLAogICAgICAgICAgICBzaG93Q29uZmlybUJ1dHRvbjogdHJ1ZSwKICAgICAgICAgICAgdGltZXI6OTAwMCwKICAgICAgICAgIH0pLnRoZW4ocmVzdWx0ID0+IHsKICAgICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICgKICAgICAgICB0aGlzLmZpbGxlZF90aW1lX3Nsb3RzX3NlbGVjdGVkX2RhdGUuaW5jbHVkZXModGhpcy5zZWxlY3RlZF90aW1lKSB8fCB0aGlzLnNlbGVjdGVkX3RpbWUgPT0gIiIKICAgICAgKSB7CiAgICAgICAgdG9hc3RyLmVycm9yKCJQbGVhc2UgZW50ZXIgYWxsIHRoZSByZXF1aXJlZCBmaWVsZHMuIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gdHJ1ZTsKICAgICAgICB2YXIgZGF0ZVNlbGVjdGVkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImRhdGVwaWNrZXItaW5wdXQiKS52YWx1ZTsKICAgICAgICB2YXIgcHJldmlvdXNEYXRlID0gbW9tZW50KHRoaXMudGVtcF9hcHBvaW50bWVudF9kYXRlLCBbJ01NLURELVlZWVknXSkuZm9ybWF0KCdZWVlZLU1NLUREJyk7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5ocl9yZXNjaGVkdWxlX2FwcG9pbnRtZW50KCksIHsKICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lLAogICAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICAgICAgcGhvbmVfbnVtYmVyOiB0aGlzLnZpc2l0b3JfbnVtYmVyLAogICAgICAgICAgICBjYW5kaWRhdGVfbmFtZTogdGhpcy5jYW5kaWRhdGVfbmFtZSwKICAgICAgICAgICAgY2FuZGlkYXRlX3Bvc2l0aW9uOiB0aGlzLmNhbmRpZGF0ZV9wb3NpdGlvbiwKICAgICAgICAgICAgdmlzaXRfc2xvdDogdGhpcy5zZWxlY3RlZF90aW1lLAogICAgICAgICAgICBjYW5kaWRhdGVfcG9zaXRpb246IHRoaXMuY2FuZGlkYXRlX3Bvc2l0aW9uLAogICAgICAgICAgICBjYW5kaWRhdGVfZW1haWw6IHRoaXMuY2FuZGlkYXRlX2VtYWlsLAogICAgICAgICAgICB2aXNpdF9kYXRlOiBkYXRlU2VsZWN0ZWQsCiAgICAgICAgICAgIHByZXZpb3VzX3Zpc2l0X2RhdGU6IHByZXZpb3VzRGF0ZSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJCb3RUb2tlbiIpLAogICAgICAgICAgICBhcHBvaW50bWVudF9pZDogdGhpcy5zZWxlY3RlZF9zY2hlZHVsZV9pZAogICAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLiRzZXNzaW9uLmdldCgiYXQiKX1gLAogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgIC8vIHRoaXMuaGlkZV9tb2RhbCgic2NoZWR1bGluZ19tb2RhbCIpCiAgICAgICAgICAgIHRoaXMuZWRpdF9zY2hlZHVsaW5nID0gZmFsc2UKICAgICAgICAgICAgdGhpcy5oaWRlX21vZGFsKCJzY2hlZHVsZV9jcmVhdGUiKQogICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5tc2cgPT0gIkFwcG9pbnRtZW50IFJlc2NoZWR1bGVkIFN1Y2Nlc3NmdWxseSIpIHsKICAgICAgICAgICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IGZhbHNlOwogICAgICAgICAgICAgIHRvYXN0ci5zdWNjZXNzKCJBcHBvaW50bWVudCBIYXMgQmVlbiBSZXNjaGVkdWxlZCBTdWNjZXNzZnVsbHkiKTsKICAgICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY2hlZHVsZXNfbGlzdCgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSBmYWxzZTsKICAgICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY2hlZHVsZXNfbGlzdCgpOwogICAgICAgICAgICAgIHRvYXN0ci5lcnJvcigiU29tZXRoaW5nIFdlbnQgV3JvbmciKTsKICAgICAgICAgICAgICAvLyBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAvLyAgIHRoaXMuJHJvdXRlci5nbygpOwogICAgICAgICAgICAgIC8vIH0sIDEwMDApOwogICAgICAgICAgICB9CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGVycm9yID0+IHsKICAgICAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSBmYWxzZTsKICAgICAgICAgICAgdG9hc3RyLmVycm9yKCJTb21lIEVycm9yIE9jY3VycmVkIik7CiAgICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIGtlZXBjaGVja2luZ2RhdGUgKCkgewogICAgICB2YXIgdm0gPSB0aGlzOwogICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IHRydWU7CiAgICAgIHRoaXMuZGF0ZXBpY2tlckluc3RhbmNlLm9uKCJjbG9zZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyB2bS5zaG93X3NwaW5uZXIgPSB0cnVlOwogICAgICAgIHZtLmNoZWNrZGF0ZSgpOwogICAgICB9KTsKICAgIH0sCiAgICBjaGVja2RhdGUgKCkgewogICAgICAvL2V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIHZhciBkdCA9IG5ldyBEYXRlKCk7CiAgICAgIGlmICh0aGlzLmRhdGVfY29uZGl0aW9uKGR0LCBuZXcgRGF0ZSgkKCIjZGF0ZXBpY2tlci1pbnB1dCIpWzBdLnZhbHVlKSkpIHsKICAgICAgICB0aGlzLnNlbGVjdGVkX2RhdGUgPSAkKCIjZGF0ZXBpY2tlci1pbnB1dCIpWzBdLnZhbHVlOwogICAgICAgIHZhciBzdGFydF9kYXRlID0gJCgiI2RhdGVwaWNrZXItaW5wdXQiKVswXS52YWx1ZTsKICAgICAgICB2YXIgc2VsZWN0ZWRfdGltZSA9IHRoaXMuc2VsZWN0ZWRfdGltZQogICAgICAgIHZhciB0aW1lID0KICAgICAgICAgIGR0LmdldEhvdXJzKCkgKyAiOiIgKyBkdC5nZXRNaW51dGVzKCkgKyAiOiIgKyBkdC5nZXRTZWNvbmRzKCk7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5ocl9nZXRfc2NoZWR1bGVfYXBwb2ludG1lbnQoKSwgewogICAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUsCiAgICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkLAogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnRva2VucywKICAgICAgICAgICAgcGhvbmVfbnVtYmVyOiB0aGlzLnZpc2l0b3JfbnVtYmVyLAogICAgICAgICAgICBEYXRlOiB0aGlzLnNlbGVjdGVkX2RhdGUsCiAgICAgICAgICAgIGFwcG9pbnRtZW50X2RhdGU6IHRoaXMuc2VsZWN0ZWRfZGF0ZSwKICAgICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbAogICAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLiRzZXNzaW9uLmdldCgiYXQiKX1gLAogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgIHRoaXMubmV3X3NlbGVjdGVkX2RhdGUgPSAkKCIjZGF0ZXBpY2tlci1pbnB1dCIpWzBdLnZhbHVlOwogICAgICAgICAgICAvLyAgJCgiI2RhdGVwaWNrZXItaW5wdXQiKVswXS52YWx1ZSA9IHRoaXMuc2VsZWN0ZWRfZGF0ZTsKCiAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhID09IG51bGwpIHsKICAgICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLm1zZyA9PSAiUGxlYXNlIHVwZGF0ZSB5b3VyIHNjaGVkdWxlciBzZXR0aW5ncyIKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCJQbGVhc2UgdXBkYXRlIHlvdXIgc2NoZWR1bGVyIHNldHRpbmdzIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5tc2cgPT0gIkludGVybmFsIFNlcnZlciBFcnJvciIpIHsKICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoIkludGVybmFsIFNlcnZlciBFcnJvciIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIGlmIChyZXNwb25zZS5kYXRhLkZ1bGxUaW1lU2xvdCAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAvLyAgIHZhciBkdCA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAgICAgLy8gICB0aGlzLmZ1bGxfdGltZV9zbG90cyA9IFtdOwogICAgICAgICAgICAgIC8vICAgdGhpcy50aW1lX3Nsb3RzID0gW107CiAgICAgICAgICAgICAgLy8gICAvLyBmb3IgKHZhciBpIGluIHRoaXMuZnVsbF90aW1lX3Nsb3RzKSB7CiAgICAgICAgICAgICAgLy8gICAvLyAgICAgdGhpcy5mdWxsX3RpbWVfc2xvdHMucHVzaCh7CiAgICAgICAgICAgICAgLy8gICAvLyAgICAgdmFsdWU6IHJlc3BvbnNlLmRhdGEuRnVsbFRpbWVTbG90W2ldLAogICAgICAgICAgICAgIC8vICAgLy8gICAgIHRleHQ6IHRoaXMuZ2VuZXJhdGVfdGltZSgKICAgICAgICAgICAgICAvLyAgIC8vICAgICAgIHJlc3BvbnNlLmRhdGEuRnVsbFRpbWVTbG90W2ldLnNwbGl0KCItIilbMF0sCiAgICAgICAgICAgICAgLy8gICAvLyAgICAgICByZXNwb25zZS5kYXRhLkZ1bGxUaW1lU2xvdFtpXS5zcGxpdCgiLSIpWzFdCiAgICAgICAgICAgICAgLy8gICAvLyAgICAgKQogICAgICAgICAgICAgIC8vICAgLy8gICAgIH0pOwogICAgICAgICAgICAgIC8vICAgLy8gICBpZiAoCiAgICAgICAgICAgICAgLy8gICAvLyAgICAgcmVzcG9uc2UuZGF0YS5BdmFpbGFibGVUaW1lU2xvdC5pbmRleE9mKAogICAgICAgICAgICAgIC8vICAgLy8gICAgICAgdGhpcy5mdWxsX3RpbWVfc2xvdHNbaV0udmFsdWUKICAgICAgICAgICAgICAvLyAgIC8vICAgICApID09IC0xCiAgICAgICAgICAgICAgLy8gICAvLyAgICkgewogICAgICAgICAgICAgIC8vICAgLy8gICAgIHRoaXMudGltZV9zbG90cy5wdXNoKHRoaXMuZnVsbF90aW1lX3Nsb3RzW2ldKTsKICAgICAgICAgICAgICAvLyAgIC8vICAgfQogICAgICAgICAgICAgIC8vICAgLy8gfQogICAgICAgICAgICAgIC8vICAgICBmb3IodmFyIGkgaW4gcmVzcG9uc2UuZGF0YS5hdmFpbGFibGVfdGltZV9zbG90cyl7CiAgICAgICAgICAgICAgLy8gICAgICAgdGhpcy5mdWxsX3RpbWVfc2xvdHMucHVzaCh7CiAgICAgICAgICAgICAgLy8gICAgICAgICB2YWx1ZTogcmVzcG9uc2UuZGF0YS5hdmFpbGFibGVfdGltZV9zbG90c1tpXSwKICAgICAgICAgICAgICAvLyAgICAgICAgIHRleHQ6IHRoaXMuZ2VuZXJhdGVfdGltZSgKICAgICAgICAgICAgICAvLyAgICAgICAgIHJlc3BvbnNlLmRhdGEuYXZhaWxhYmxlX3RpbWVfc2xvdHNbaV0uc3BsaXQoIi0iKVswXSwKICAgICAgICAgICAgICAvLyAgICAgICAgIHJlc3BvbnNlLmRhdGEuYXZhaWxhYmxlX3RpbWVfc2xvdHNbaV0uc3BsaXQoIi0iKVsxXQogICAgICAgICAgICAgIC8vICAgICAgICAgKQogICAgICAgICAgICAgIC8vICAgICAgIH0pCiAgICAgICAgICAgICAgLy8gICAgIH0KICAgICAgICAgICAgICAvLyAgICAgJCgiI2RhdGVwaWNrZXItaW5wdXQiKVswXS52YWx1ZSA9IHRoaXMuc2VsZWN0ZWRfZGF0ZQoKICAgICAgICAgICAgICAvLyB9CgogICAgICAgICAgICAgIHRoaXMuaXNSZXNjaGVkdWxldGltZSA9IHRydWU7CiAgICAgICAgICAgICAgdGhpcy5mdWxsX3RpbWVfc2xvdHMgPSBbXTsKICAgICAgICAgICAgICB0aGlzLnRpbWVfc2xvdHMgPSBbXTsKICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5mdWxsX3RpbWVfc2xvdHMgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB2YXIgZHQgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5mdWxsX3RpbWVfc2xvdHMgPSBbXTsKICAgICAgICAgICAgICAgIHZhciBnZXRfZnVsbF9zbG90X2xpc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgdmFyIHRlbXBfc3RhcnRfZGF0ZSA9IG5ldyBEYXRlKHN0YXJ0X2RhdGUpOwogICAgICAgICAgICAgICAgaWYgKHRlbXBfc3RhcnRfZGF0ZS5nZXRGdWxsWWVhcigpID4gZHQuZ2V0RnVsbFllYXIoKSkgewogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZW1wX3N0YXJ0X2RhdGUuZ2V0RnVsbFllYXIoKSA9PSBkdC5nZXRGdWxsWWVhcigpKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0ZW1wX3N0YXJ0X2RhdGUuZ2V0TW9udGgoKSA+IGR0LmdldE1vbnRoKCkpIHsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZW1wX3N0YXJ0X2RhdGUuZ2V0TW9udGgoKSA9PSBkdC5nZXRNb250aCgpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlbXBfc3RhcnRfZGF0ZS5nZXREYXRlKCkgPiBkdC5nZXREYXRlKCkpIHsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRlbXBfc3RhcnRfZGF0ZS5nZXREYXRlKCkgPT0gZHQuZ2V0RGF0ZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICBnZXRfZnVsbF9zbG90X2xpc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChnZXRfZnVsbF9zbG90X2xpc3QpIHsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiByZXNwb25zZS5kYXRhLmZ1bGxfdGltZV9zbG90cykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZnVsbF90aW1lX3Nsb3RzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHJlc3BvbnNlLmRhdGEuZnVsbF90aW1lX3Nsb3RzW2ldLAogICAgICAgICAgICAgICAgICAgICAgdGV4dDogdGhpcy5nZW5lcmF0ZV90aW1lKAogICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZ1bGxfdGltZV9zbG90c1tpXS5zcGxpdCgiLSIpWzBdLAogICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZ1bGxfdGltZV9zbG90c1tpXS5zcGxpdCgiLSIpWzFdCiAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gcmVzcG9uc2UuZGF0YS5mdWxsX3RpbWVfc2xvdHMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICBkdC5nZXRIb3VycygpIDwKICAgICAgICAgICAgICAgICAgICAgIE51bWJlcigKICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5mdWxsX3RpbWVfc2xvdHNbaV0uc3BsaXQoIi0iKVswXS5zcGxpdCgiOiIpWzBdCiAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZ1bGxfdGltZV9zbG90cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHJlc3BvbnNlLmRhdGEuZnVsbF90aW1lX3Nsb3RzW2ldLAogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiB0aGlzLmdlbmVyYXRlX3RpbWUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5mdWxsX3RpbWVfc2xvdHNbaV0uc3BsaXQoIi0iKVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmZ1bGxfdGltZV9zbG90c1tpXS5zcGxpdCgiLSIpWzFdCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gaWYgKHNlbGVjdGVkX3RpbWUgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAvLyAgIHRoaXMuaXNFZGl0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyAgIHRoaXMuc2VsZWN0ZWRfdGltZSA9IHNlbGVjdGVkX3RpbWU7CiAgICAgICAgICAgICAgICAvLyAgIHRoaXMuc2NoZWR1bGVkX3RpbWUgPSB0aGlzLmdlbmVyYXRlX3RpbWUoCiAgICAgICAgICAgICAgICAvLyAgICAgc2VsZWN0ZWRfdGltZS5zcGxpdCgiLSIpWzBdLAogICAgICAgICAgICAgICAgLy8gICAgIHNlbGVjdGVkX3RpbWUuc3BsaXQoIi0iKVsxXQogICAgICAgICAgICAgICAgLy8gICApOwogICAgICAgICAgICAgICAgLy8gfSBlbHNlIGlmIChzZWxlY3RlZF90aW1lID09IHVuZGVmaW5lZCkgewoKICAgICAgICAgICAgICAgIHRoaXMuZmlsbGVkX3RpbWVfc2xvdHNfc2VsZWN0ZWRfZGF0ZSA9IHJlc3BvbnNlLmRhdGEuZmlsbGVkX3RpbWVfc2xvdHM7CgogICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuZmlsbGVkX3RpbWVfc2xvdHMubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgICAgICAgdGhpcy50aW1lX3Nsb3RzID0gdGhpcy5mdWxsX3RpbWVfc2xvdHM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aGlzLnRpbWVfc2xvdHMgPSBbXTsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiB0aGlzLmZ1bGxfdGltZV9zbG90cykgewogICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZmlsbGVkX3RpbWVfc2xvdHMuaW5kZXhPZigKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mdWxsX3RpbWVfc2xvdHNbaV0udmFsdWUKICAgICAgICAgICAgICAgICAgICAgICkgPT0gLTEKICAgICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGltZV9zbG90cy5wdXNoKHRoaXMuZnVsbF90aW1lX3Nsb3RzW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gdGhpcy50aW1lX3Nsb3RzID0gcmVzcG9uc2UuZGF0YS5hdmFpbGFibGVfdGltZV9zbG90czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNob3dfc3Bpbm5lciA9IGZhbHNlOwogICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgIHRvYXN0ci5lcnJvcigiUGxlYXNlIFNlbGVjdCBBIFZhbGlkIERhdGUiKTsKICAgICAgICB0aGlzLmRhdGVwaWNrZXJJbnN0YW5jZS5vcGVuKCk7CiAgICAgICAgJCgiI2RhdGVwaWNrZXItaW5wdXQiKVswXS52YWx1ZSA9IHRoaXMubmV3X3NlbGVjdGVkX2RhdGU7CiAgICAgIH0KICAgIH0sCiAgICBzZW5kX3JlbWluZGVyIChBcHBvaW50bWVudElEKSB7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIHN3YWwKICAgICAgICAuZmlyZSh7CiAgICAgICAgICB0aXRsZTogIkFyZSB5b3Ugc3VyZT8iLAogICAgICAgICAgdGV4dDogIiBZb3Ugd2FudCB0byBTZW5kIHRoZSBSZW1pbmRlciIsCiAgICAgICAgICB0eXBlOiAid2FybmluZyIsCiAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uOiB0cnVlLAogICAgICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiAiIzMwODVkNiIsCiAgICAgICAgICBjYW5jZWxCdXR0b25Db2xvcjogIiNkMzMiLAogICAgICAgICAgY29uZmlybUJ1dHRvblRleHQ6ICJZZXMsIFNlbmQhISIKICAgICAgICB9KQogICAgICAgIC50aGVuKHJlc3VsdCA9PiB7CiAgICAgICAgICBpZiAocmVzdWx0LnZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gdHJ1ZTsKICAgICAgICAgICAgLy8gdmFyIHRvZGF5c19kYXRlID0gdGhpcy5kYWlseV9kYXRlOwogICAgICAgICAgICB2YXIgZCA9IG5ldyBEYXRlKHRoaXMudGVtcF9hcHBvaW50bWVudF9kYXRlKTsKICAgICAgICAgICAgdmFyIHByZXZpb3VzRGF0ZSA9CiAgICAgICAgICAgICAgZC5nZXRGdWxsWWVhcigpICsgIi0iICsgKGQuZ2V0TW9udGgoKSArIDEpICsgIi0iICsgZC5nZXREYXRlKCk7CiAgICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLnNlbmRfcmVtaW5kZXIoKSwgewogICAgICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lLAogICAgICAgICAgICAgICAgY29tcGFueV9pZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfaWQsCiAgICAgICAgICAgICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgICAgIHRva2VuOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikudG9rZW5zLAogICAgICAgICAgICAgICAgYXBwb2ludG1lbnRfaWQ6IEFwcG9pbnRtZW50SUQsCiAgICAgICAgICAgICAgICBkYXRlOiBwcmV2aW91c0RhdGUsCiAgICAgICAgICAgICAgICB2aXNpdF9zbG90OiB0aGlzLmRpc3BsYXlfc2VsZWN0ZWRfdGltZQogICAgICAgICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5zdWNjZXNzID09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgdG9hc3RyLnN1Y2Nlc3MoIk5vdGlmaWNhdGlvbiBIYXMgYmVlbiBzZW50IikKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEuc3VjY2VzcyA9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoIkNvdWxkIE5vdCBTZW5kIE5vdGlmaWNhdGlvbiIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcigiSW50ZXJuYWwgU2VydmVyIEVycm9yIik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAogICAgY29uZmlybUFwcG9pbnRtZW50ICgpIHsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgY29uc3QgaXNfaW52YWxpZCA9IG1vbWVudCgpLmRpZmYobW9tZW50KGAke3RoaXMudGVtcF9hcHBvaW50bWVudF90aW1lfSAke3RoaXMudGVtcF9hcHBvaW50bWVudF9kYXRlfWAsIFsnSEg6bW0gTU0tREQtWVlZWSddKSwgIm1pbnV0ZSIpID49IDA7CiAgICAgIC8vIGlmICgodGhpcy50ZW1wX2FwcG9pbnRtZW50X2RhdGUgIT0gJCgiI2RhdGVwaWNrZXItaW5wdXQiKVswXS52YWx1ZSkgfHwgdGhpcy50ZW1wX2FwcG9pbnRtZW50X3RpbWUgIT0gdGhpcy5zZWxlY3RlZF90aW1lKSB7CiAgICAgIGlmIChpc19pbnZhbGlkKSB7CiAgICAgICAgc3dhbAogICAgICAgICAgLmZpcmUoewogICAgICAgICAgICB0eXBlOiAid2FybmluZyIsCiAgICAgICAgICAgIHRleHQ6ICJJdCBsb29rcyBsaWtlIHlvdSBoYXZlIG1hZGUgY2hhbmdlIHRvIHRoZSBhcHBvaW50bWVudCBkYXRlIGFuZCBhcHBvaW50bWVudCB0aW1lLCBzbyBwbGVhc2UgcmVzY2hlZHVsZSB0aGUgYXBwb2ludG1lbnQgZmlyc3QiLAogICAgICAgICAgICBzaG93Q29uZmlybUJ1dHRvbjogdHJ1ZSwKICAgICAgICAgICAgdGltZXI6NTAwMCwKICAgICAgICAgIH0pLnRoZW4ocmVzdWx0ID0+IHsKICAgICAgICAgIH0pOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIHN3YWwKICAgICAgICAgIC5maXJlKHsKICAgICAgICAgICAgdGl0bGU6ICJBcmUgeW91IHN1cmU/IiwKICAgICAgICAgICAgdGV4dDogIiBZb3Ugd2FudCB0byBDb25maXJtIHRoZSBBcHBwb2ludG1lbnQ/IFRoaXMgd2lsbCBzZW5kIGEgbWVzc2FnZSB0byB0aGUgcGF0aWVudCIsCiAgICAgICAgICAgIHR5cGU6ICJ3YXJuaW5nIiwKICAgICAgICAgICAgc2hvd0NhbmNlbEJ1dHRvbjogdHJ1ZSwKICAgICAgICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiAiIzMwODVkNiIsCiAgICAgICAgICAgIGNhbmNlbEJ1dHRvbkNvbG9yOiAiI2QzMyIsCiAgICAgICAgICAgIGNvbmZpcm1CdXR0b25UZXh0OiAiWWVzLCBDb25maXJtISIKICAgICAgICAgIH0pCiAgICAgICAgICAudGhlbihyZXN1bHQgPT4gewogICAgICAgICAgICBpZiAocmVzdWx0LnZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKCh0aGlzLnRlbXBfbmFtZSAhPSB0aGlzLmNhbmRpZGF0ZV9uYW1lKSB8fCAodGhpcy50ZW1wX3Bvc2l0aW9uICE9IHRoaXMuY2FuZGlkYXRlX3Bvc2l0aW9uKSB8fCAodGhpcy50ZW1wX2VtYWlsICE9IHRoaXMuY2FuZGlkYXRlX2VtYWlsKSkgewogICAgICAgICAgICAgICAgLy8gYWxlcnQoIkhpIik7CiAgICAgICAgICAgICAgICBsZXQgYXBwb2ludG1lbnRfcGF5bG9hZCA9IHsKICAgICAgICAgICAgICAgICAgY2FuZGlkYXRlX25hbWU6IHRoaXMuY2FuZGlkYXRlX25hbWUsCiAgICAgICAgICAgICAgICAgIGNhbmRpZGF0ZV9wb3NpdGlvbjogdGhpcy5jYW5kaWRhdGVfcG9zaXRpb24sCiAgICAgICAgICAgICAgICAgIGNhbmRpZGF0ZV9wb3NpdGlvbjogdGhpcy5jYW5kaWRhdGVfZW1haWwsCiAgICAgICAgICAgICAgICAgIFZpc2l0U2xvdDogdGhpcy5zZWxlY3RlZF90aW1lLAogICAgICAgICAgICAgICAgICBQaG9uZU51bWJlcjogdGhpcy52aXNpdG9yX251bWJlciwKICAgICAgICAgICAgICAgICAgVmlzaXREYXRlOiB0aGlzLnNlbGVjdGVkX3NjaGVkdWxlX3Zpc2l0X3Nsb3Quc3BsaXQoIiAiKVswXQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5zY2hlZHVsZV9lZGl0X2RlbGV0ZV91cmwoKSwgewogICAgICAgICAgICAgICAgICAgIGNvbXBhbnlfbmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZSwKICAgICAgICAgICAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICAgICAgICAgICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICAgICAgICAgICAgZGF0ZTogdGhpcy5zZWxlY3RlZF9zY2hlZHVsZV92aXNpdF9zbG90LnNwbGl0KCIgIilbMF0sCiAgICAgICAgICAgICAgICAgICAgaXNfZWRpdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBhcHBvaW50bWVudF9pZDogdGhpcy5zZWxlY3RlZF9zY2hlZHVsZV9pZCwKICAgICAgICAgICAgICAgICAgICBhcHBvaW50bWVudF9pbmZvOiBhcHBvaW50bWVudF9wYXlsb2FkCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgICAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLm1zZyAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEubXNnID09ICJFZGl0IEFwcG9pbnRtZW50IgogICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgdG9hc3RyLnN1Y2Nlc3MoIllvdXIgYXBwb2ludG1lbnQgaGFzIGJlZW4gZWRpdGVkIHN1Y2Nlc3NmdWxseS4iKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEubXNnID09ICJJbnRlcm5hbCBTZXJ2ZXIgRXJyb3IiKSB7CiAgICAgICAgICAgICAgICAgICAgICB0b2FzdHIuZXJyb3IoIkludGVybmFsIFNlcnZlciBFcnJvciIpOwogICAgICAgICAgICAgICAgICAgICAgJCgiI3NjaGVkdWxlX2RldGFpbHMiKS5tb2RhbCgiaGlkZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgLmNhdGNoKGUgPT4gewogICAgICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcigiSW50ZXJuYWwgU2VydmVyIEVycm9yIik7CiAgICAgICAgICAgICAgICAgICAgJCgiI3NjaGVkdWxlX2RldGFpbHMiKS5tb2RhbCgiaGlkZSIpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSB0cnVlOwogICAgICAgICAgICAgIHZhciBkYXRlU2VsZWN0ZWQgPSBtb21lbnQodGhpcy50ZW1wX2FwcG9pbnRtZW50X2RhdGUsIFsnTU0tREQtWVlZWSddKS5mb3JtYXQoJ1lZWVktTU0tREQnKTsKICAgICAgICAgICAgICB2YXIgRGF0ZTEgPSB0aGlzLnByZXZpb3VzX3Zpc2l0X2RhdGU7CiAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRGF0ZSA9IG1vbWVudChEYXRlMSkuZm9ybWF0KCdZWVlZLU1NLUREJyk7CiAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jb25maXJtX2FwcG9pbnRtZW50KCksIHsKICAgICAgICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lLAogICAgICAgICAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICAgICAgICAgICAgcGhvbmVfbnVtYmVyOiB0aGlzLnZpc2l0b3JfbnVtYmVyLAogICAgICAgICAgICAgICAgICBjYW5kaWRhdGVfbmFtZTogdGhpcy5jYW5kaWRhdGVfbmFtZSwKICAgICAgICAgICAgICAgICAgY2FuZGlkYXRlX3Bvc2l0aW9uOiB0aGlzLmNhbmRpZGF0ZV9wb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgdmlzaXRfc2xvdDogdGhpcy5zZWxlY3RlZF90aW1lLAogICAgICAgICAgICAgICAgICBjYW5kaWRhdGVfZW1haWw6IHRoaXMuY2FuZGlkYXRlX2VtYWlsLAogICAgICAgICAgICAgICAgICB2aXNpdF9kYXRlOiBkYXRlU2VsZWN0ZWQsCiAgICAgICAgICAgICAgICAgIHRva2VuOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikudG9rZW5zLAogICAgICAgICAgICAgICAgICBhcHBvaW50bWVudF9pZDogdGhpcy5zZWxlY3RlZF9zY2hlZHVsZV9pZCwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICAgICAgICB0aGlzLmhpZGVfbW9kYWwoInNjaGVkdWxlX2RldGFpbHMiKQogICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5tc2cgPT0gIkFwcG9pbnRtZW50IENvbmZpcm1lZCBTdWNjZXNzZnVsbHkiKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93X3NwaW5uZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0b2FzdHIuc3VjY2VzcygiQXBwb2ludG1lbnQgaGFzIGJlZW4gQ29uZmlybWVkIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVfc2NoZWR1bGVzX2xpc3QoKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEubXNnID09ICJBcHBvaW50bWVudCBDb25maXJtYXRpb24gRmFpbGVkIikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdG9hc3RyLnN1Y2Nlc3MoIkFwcG9pbnRtZW50IENvbmZpcm1hdGlvbiBGYWlsZWQiKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY2hlZHVsZXNfbGlzdCgpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5tc2cgPT0gIkFuIEVycm9yIE9jY3VycmVkIikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKCJTb21ldGhpbmcgV2VudCBXcm9uZyIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlX3NjaGVkdWxlc19saXN0KCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5jYXRjaChlcnJvciA9PiB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd19zcGlubmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIHRvYXN0ci5lcnJvcigiSW50ZXJuYWwgU2VydmVyIEVycm9yIik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSkKICAgICAgfQogICAgfSwKICAgIGNhbmNlbF9yZXNjaGVkdWxlICgpIHsKICAgICAgdGhpcy5pc1Jlc2NoZWR1bGUgPSAhdGhpcy5pc1Jlc2NoZWR1bGU7CiAgICAgIC8vICAkKCIjZGF0ZXBpY2tlci1pbnB1dCIpWzBdLnZhbHVlID0gdGhpcy50ZW1wX2RhdGE7CgogICAgfSwKICAgIGNvbnZlcnRfY2FzaW5nICh0ZXh0KSB7CiAgICAgIGlmICh0ZXh0ID09PSAnbm9uZScpIHsKICAgICAgICB0ZXh0ID0gJ3NjaGVkdWxlZCcKICAgICAgfQogICAgICB0ZXh0ID0gdGV4dC50b1N0cmluZygpOwogICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKC9cd1xTKi9nLAogICAgICAgIGZ1bmN0aW9uICh0eHQpIHsKICAgICAgICAgIHJldHVybiB0eHQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKwogICAgICAgICAgICB0eHQuc3Vic3RyKDEpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfSk7CiAgICAgIHJldHVybiB0eHQ7CiAgICB9LAogICAgaGlkZV9tb2RhbCAoaWQpIHsKICAgICAgJChgIyR7aWR9YCkubW9kYWwoJ2hpZGUnKQogICAgfSwKICAgIHVwZGF0ZV9zY2hlZHVsZXNfbGlzdCAoKSB7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmhyX2dldF9zY2hlZHVsZV9pbmZvX3VybCgpLCB7CiAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUsCiAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICAgIHRva2VuOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikudG9rZW5zLAogICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICBmaXJzdF9kYXk6IHRoaXMubW9udGhfcmFuZ2UoInN0YXJ0X3RpbWUiKSwKICAgICAgICAgIGxhc3RfZGF5OiB0aGlzLm1vbnRoX3JhbmdlKCJlbmRfdGltZSIpCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLiRzZXNzaW9uLmdldCgiYXQiKX1gLAogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgdGhpcy5yZW5kZXJfc2NoZWR1bGUocmVzcG9uc2UuZGF0YS5TY2hlZHVsaW5nX2luZm8pOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGUgPT4gewogICAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICAgICAgfSk7CiAgICB9CiAgfQp9Owo="},null]}