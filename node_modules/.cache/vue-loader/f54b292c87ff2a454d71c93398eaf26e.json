{"remainingRequest":"/home/vimalesh/CENSE/chatbot-portal/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/vimalesh/CENSE/chatbot-portal/src/portal/Chatbot/Dashboard/Newtestbot.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/vimalesh/CENSE/chatbot-portal/src/portal/Chatbot/Dashboard/Newtestbot.vue","mtime":1645594423491},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCmltcG9ydCBheGlvcyBmcm9tICJheGlvcyI7CmltcG9ydCBmaW5nZXJwcmludCBmcm9tICJAL3BvcnRhbC9jb21wb25lbnRzL2ZpbmdlcnByaW50IjsKaW1wb3J0IHsgYnVzIH0gZnJvbSAiQC9wb3J0YWwvbWFpbiI7CmltcG9ydCBhcGlfY2FsbHMgZnJvbSAiQC9wb3J0YWwvYXBpX2NhbGxzIjsKaW1wb3J0IHsgU29ja2V0IH0gZnJvbSAicGhvZW5peC1zb2NrZXQiOwppbXBvcnQgeyBzZXRUaW1lb3V0LCBzZXRJbnRlcnZhbCB9IGZyb20gInRpbWVycyI7CmltcG9ydCBSZWNvcmRlciBmcm9tICJAL3BvcnRhbC9jb21wb25lbnRzL3JlY29yZGVyIjsKaW1wb3J0IFNjcm9sbGJhciBmcm9tICJzbW9vdGgtc2Nyb2xsYmFyIjsKaW1wb3J0IE11bHRpc2VsZWN0IGZyb20gInZ1ZS1tdWx0aXNlbGVjdCI7CmltcG9ydCBkZWJvdW5jZSBmcm9tICJ2dWUtZGVib3VuY2Uvc3JjL2RlYm91bmNlIjsKaW1wb3J0IGNvdW50cnlfY29kZSBmcm9tICIuLi9EYXNoYm9hcmQvY291bnRyeV9jb2RlX2RhdGEuanNvbiI7CmltcG9ydCBDb3VudHJ5Q29kZXMgZnJvbSAiLi4vRGFzaGJvYXJkL0NvdW50cnlDb2Rlcy5qc29uIjsKCmV4cG9ydCBkZWZhdWx0IHsKICBuYW1lOiAiY2xvc2VkLWZvcm0tcmVzcG9uc2UtYm90IiwKICBjb21wb25lbnRzOiB7CiAgICBNdWx0aXNlbGVjdAogIH0sCiAgZGF0YSgpIHsKICAgIHJldHVybiB7CiAgICAgIGNvbXBhbnlpZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfaWQsCiAgICAgIGNvbXBhbnluYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lLAogICAgICBwb3B1cF9tc2c6CiAgICAgICAgIllvdSBjYW4gdHlwZSDigJhSZXN0YXJ04oCdICBhdCA8L2JyPmFueSAgdGltZSB0byBnZXQgYmFjazwvYnI+IHRvIHRoZSBNYWluIE1lbnUiLAogICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiB0cnVlLAogICAgICBxdXNfYW5zOiAiYW5zd2VycyIsCiAgICAgIHRvX3NlbmQ6ICIiLAogICAgICBjZW5zZV9lbnF1aXJ5OiBmYWxzZSwKICAgICAgaXNfdHlwaW5nOiBmYWxzZSwKICAgICAgdXNlcl9uYW1lOiAiIiwKICAgICAgc2hvdzogZmFsc2UsCiAgICAgIGNoYXQ6IFtdLAogICAgICBmaW5nZXJwcmludDogbnVsbCwKICAgICAgYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlOiB0aGlzLiRzZXNzaW9uLmdldCgiUmVzcG9uc2VCb3RUb2tlbiIpCiAgICAgICAgPyB0aGlzLiRzZXNzaW9uLmdldCgiUmVzcG9uc2VCb3RUb2tlbiIpCiAgICAgICAgOiAiIiwKICAgICAgZmlyc3RfY2xpY2s6IGZhbHNlLAogICAgICBsZXZlbDogMCwKICAgICAgcmVjb2duaXRpb246IG51bGwsCiAgICAgIGpzb25fZGF0YTogewogICAgICAgIGNyZWF0ZV9hcHBvaW50bWVudDoKICAgICAgICAgICd7IlVzZXIiOiB7IlBoeXNpY2lhbiI6IHsiSUQiOiAiRFQwMDAwMDAwMDAwMDAwMDAyMzcifSwiVXNlck5hbWUiOiJhYyIsIklEIjoiVVMwMDAwMDAwMDAwMDAwMDAxMzgiLCJBY2NvdW50IjogeyJJRCI6ICJDTzAwMDIzIn0sIlRva2VuIjogIloxclNHR20wWHBNV2p0M2dpQUVyUFBXWjg0VFFOOUZzRk1CTHNVKy9MQXU2eXVhbE1nNkVQMmJzcndaakxQd20zajREcFBjR2M1TGNJcDNOamdmVXNBPT0iLCJTcGVjaWFsdHkiOiB7IklEIjogIlBHMDAwMDAwMDAwMDAwMDAwMTQxIiwgIk5hbWUiOiAiQUMiLCAiQ29kZSI6ICJBQyJ9LCJEb21haW4iOiAiZ29ncmVlbmJpbGxzLmNvbSJ9LCJBcHBvaW50bWVudCI6IHsiRGF0ZSI6ICIwOC8zMC8yMDE4IiwgIklzSlNPTk5vdGUiOiAwLCAiUGF0aWVudCI6IHsiQ2FzZUlEIjogIiJ9fX0nLAogICAgICAgIHZpc2l0c19maW5hbGl6ZWQ6CiAgICAgICAgICAneyJVc2VyIjogeyJQaHlzaWNpYW4iOiB7IklEIjogIkRUMDAwMDAwMDAwMDAwMDExODg2In0sIlVzZXJOYW1lIjogImNoIiwiSUQiOiAiVVMwMDAwMDAwMDAwMDAwMDAxNDMiLCJBY2NvdW50Ijp7IklEIjoiQ08wMDAyMyJ9LCJUb2tlbiI6ImV5SjBlWEFpT2lKS1YxUWlMQ0poYkdjaU9pSklVekkxTmlKOS5leUoxYzJWeUlqb2lZWFprYUhWMElpd2laWGh3SWpveE5USTVORGd5TmpZemZRLnYxYzBIYnVXdVpYWHBKZkRyWFZjMUhQVnVmZmJuR2NMcWtwZzB6bTZBb1EiLCJTcGVjaWFsdHkiOiB7IklEIjogIlBHMDAwMDAwMDAwMDAwMDAwMTQyIiwiQ29kZSI6ICJjaCJ9LCJEb21haW4iOiAiZ3JlZW55b3VyYmlsbHMuY29tIn0sIlNlYXJjaFBhcmFtZXRlcnMiOiB7IlN0YXR1cyI6ICIiLCJPcmRlckJ5IjogIiIsIkZyb21EYXRlIjogIjAxLzAxLzIwMTgiLCJDb3VudCI6ICIxMCIsIlNlYXJjaFRleHQiOiAiIiwiVHlwZU9mVmlzaXQiOiAiQUxMIiwiU29ydE9yZGVyIjogImFwcG9pbnRtZW50IiwiU3RhcnRJbmRleCI6ICIxIiwiRW5kSW5kZXgiOiAiMTAiLCJUb0RhdGUiOiAiMDgvMDYvMjAxOCJ9fScsCiAgICAgICAgYXBwb2ludG1lbnRzX2NvdW50OgogICAgICAgICAgJ3siVXNlciI6IHsiUGh5c2ljaWFuIjogeyJJRCI6ICJEVDAwMDAwMDAwMDAwMDAxMTg4NiJ9LCJVc2VyTmFtZSI6ICJjaCIsIklEIjogIlVTMDAwMDAwMDAwMDAwMDAwMTQzIiwiQWNjb3VudCI6eyJJRCI6IkNPMDAwMjMifSwiVG9rZW4iOiJleUowZVhBaU9pSktWMVFpTENKaGJHY2lPaUpJVXpJMU5pSjkuZXlKMWMyVnlJam9pWVhaa2FIVjBJaXdpWlhod0lqb3hOVEk1TkRneU5qWXpmUS52MWMwSGJ1V3VaWFhwSmZEclhWYzFIUFZ1ZmZibkdjTHFrcGcwem02QW9RIiwiU3BlY2lhbHR5IjogeyJJRCI6ICJQRzAwMDAwMDAwMDAwMDAwMDE0MiIsIkNvZGUiOiAiY2gifSwiRG9tYWluIjogImdyZWVueW91cmJpbGxzLmNvbSJ9LCJTZWFyY2hQYXJhbWV0ZXJzIjogeyJTdGF0dXMiOiAiIiwiT3JkZXJCeSI6ICIiLCJGcm9tRGF0ZSI6ICIwMS8wMS8yMDE4IiwiQ291bnQiOiAiMTAiLCJTZWFyY2hUZXh0IjogIiIsIlR5cGVPZlZpc2l0IjogIkFMTCIsIlNvcnRPcmRlciI6ICJhcHBvaW50bWVudCIsIlN0YXJ0SW5kZXgiOiAiMSIsIkVuZEluZGV4IjogIjEwIiwiVG9EYXRlIjogIjA4LzA2LzIwMTgifX0nLAogICAgICAgIGNyZWF0ZV90aWNrZXQ6CiAgICAgICAgICAneyJBY2NvdW50TmFtZSI6bnVsbCwiQ2FsbGJhY2tQaG9uZSI6IiIsIkNvbXBhbnlJRCI6IkNPMDAwMjMiLCJEZXNjcmlwdGlvbiI6IkRlIiwiRG9tYWluTmFtZSI6bnVsbCwiRW1haWxDQyI6ImFiaGF5LndAY29kZWFycmF5LnRlY2giLCJFbWFpbERlZmF1bHQiOiJtYW5pc2gueUBjb2RlYXJyYXkudGVjaCIsIlByaW9yaXR5IjoiMyIsIlByaW9yaXR5SUQiOjAsIlJhaXNlZEJ5IjoibGF3dXNlciIsIlN0YXR1cyI6MCwiU3RhdHVzQ29kZSI6bnVsbCwiU3RhdHVzVGV4dCI6bnVsbCwiU1R5cGUiOiJXUCIsIlN1YmplY3QiOiJEZSIsIlN1YlR5cGUiOiJTQU1ELVAiLCJUaWNrZXRJRCI6MCwiVGlja2V0TnVtYmVyIjpudWxsLCJUeXBlIjowLCJUeXBlVGV4dCI6IldlYnNpdGUgUHJvYmxlbSIsImxpc3RGaWxlczEiOlsiY2hxMS5wZGYiXX0nLAogICAgICAgIGdldF9yZXBvcnQ6ICd7ImNvbXBhbnlJZCI6ICJDTzAwMDIzIn0nCiAgICAgIH0sCiAgICAgIHBob25lX251bWJlcjogIiIsCiAgICAgIHN0b3A6IHRydWUsCiAgICAgIGRlbW91cmxiaW5kOiBmYWxzZSwKICAgICAgcmV2aWV3c3VybGJpbmQ6IGZhbHNlLAogICAgICByZXZpZXdzdXJsOiAiaHR0cHM6Ly93d3cueW91dHViZS5jb20vZW1iZWQvcGFBZVc4NmVRWjQiLAogICAgICBkZW1vdXJsOiBbCiAgICAgICAgImh0dHBzOi8vd3d3LnlvdXR1YmUuY29tL2VtYmVkL3ZpZGVvc2VyaWVzP0tjckptOVV4VzNzJmluZGV4PTEzJmxpc3Q9UExfalhsaWg4ZGdrVEU4Q3JQcGlXY0E5S3hRZUtIWkFudCZ0PTBzIiwKICAgICAgICAiaHR0cHM6Ly93d3cueW91dHViZS5jb20vZW1iZWQvdmlkZW9zZXJpZXM/cXpTMnFJTkk2SU0mbGlzdD1QTF9qWGxpaDhkZ2tSdTVkZEdYQUdxWjR1TExrb0p6Q2o4JmluZGV4PTIiCiAgICAgIF0sCiAgICAgIGNoYXRfd2lkZ2V0OiB7CiAgICAgICAgbG9nbzogIiIsCiAgICAgICAgdGl0bGU6ICIiLAogICAgICAgIHN0eWxlOiAiIgogICAgICB9LAogICAgICBzZWxlY3RlZF9kYXRlOiAiIiwKICAgICAgc2VsZWN0ZWRfdGltZTogIiIsCiAgICAgIHJlYXNvbl9vZl92aXNpdDogIiIsCiAgICAgIHBhdGllbnRfbmFtZTogIiIsCiAgICAgIHZpc2l0b3JfbnVtYmVyOiAiIiwKICAgICAgZnVsbF90aW1lX3Nsb3RzOiBbXSwKICAgICAgdGltZV9zbG90czogW10sCiAgICAgIFRPREFZX0RBVEU6ICIiLAogICAgICBjaGFubmVsOiBudWxsLAogICAgICBjaGF0X3NvY2tldDogbnVsbCwKICAgICAgdm9pY2Vfc29ja2V0OiBudWxsLAogICAgICBsaXZlX2NoYXRfb246IGZhbHNlLAogICAgICBsaXZlX2NoYXRfdG9rZW46IG51bGwsCiAgICAgIGNoYXRfZ3JvdXBfbmFtZTogbnVsbCwKICAgICAgdG9fc2Nyb2xsOiBmYWxzZSwKICAgICAgZm9ybV9wYXlsb2FkOiBudWxsLAogICAgICByZWZyZXNoX3RpbWU6IDAsCiAgICAgIHBob25lX251bWJlcl92YWxpZGl0eTogL1swLTldezEwLDExfSQvLAogICAgICBlbXB0eV9zdHJpbmdfdmFsaWRpdHk6IC9eJC8sCiAgICAgIC8vaGFyc2gKICAgICAgaXNleGNoYW5nZTogZmFsc2UsCiAgICAgIGN1cnJlbmN5ZXhjaGFuZ2VfbGlzdDogbnVsbCwKICAgICAgc2VsZWN0ZWRfaW5kaWNhdGlvbjogW10sCiAgICAgIHJlczoge30sCiAgICAgIGlzY2xvc2VkYm90b246IGZhbHNlLAogICAgICBpc2Zvcm1vbjogZmFsc2UsCiAgICAgIGZvcm1fbmFtZTogbnVsbCwKICAgICAgbGFzdGNsb3NlZGJvdGlucHV0bm9kZTogbnVsbCwKICAgICAgY2xvc2VkX2Zvcm1fcmVwbHlfZGF0YTogbnVsbCwKICAgICAgc2VsZWN0ZWRub2RlaWQ6bnVsbCwKICAgICAgYm90X25hbWU6IG51bGwsCiAgICAgIGJvdF90eXBlOiBudWxsLAogICAgICBpZmZpcnN0dGltZTogdHJ1ZSwKICAgICAgaXNlbWFpbDogZmFsc2UsCiAgICAgIGlzX3Bob25lX251bWJlcjogZmFsc2UsCiAgICAgIGlzX3RleHRfYXJlYSA6ZmFsc2UsCiAgICAgIGNvbnZlcnNhdGlvbl9pZCA6ICIiLAogICAgICBpc19waG9uZV9udW1iZXJfb3RwIDogZmFsc2UsCiAgICAgIG5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXI6IG51bGwsCiAgICAgIGlzX3Bob25lX251bWJlcl9lcnJfbXNnOiBmYWxzZSwKICAgIH07CiAgfSwKICBjcmVhdGVkKCkgewogICAgdGhpcy5jb252ZXJzYXRpb25faWQgPSB0aGlzLmdlbmVyYXRlVVVJRCgpOwogICAgdGhpcy4kc2Vzc2lvbi5zdGFydCgpOwogICAgdGhpcy4kc2Vzc2lvbi5zZXQoImNvbnZlcnNhdGlvbl9pZCIsIHRoaXMuY29udmVyc2F0aW9uX2lkKTsKICAgIC8vIGNvbnNvbGUubG9nKGNvdW50cnlfY29kZSk7CiAgICAvLyBjb25zb2xlLmxvZyhKU09OLnBhcnNlKGNvdW50cnlfY29kZSkpOwogICAgaWYgKHRoaXMuJHNlc3Npb24uaGFzKCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iKSkgewogICAgICAvLyB0aGlzLmNoYXQgPSB0aGlzLiRzZXNzaW9uLmdldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIik7CiAgICB9CiAgICBpZiAoIXRoaXMuJHNlc3Npb24uaGFzKCJDaGF0Qm90SW1hZ2VQYXJhbWV0ZXJzIikpIHsKICAgICAgYXhpb3MKICAgICAgICAucG9zdChhcGlfY2FsbHMud2lkZ2V0X3NldHRpbmdfdXJsKCksIHsKICAgICAgICAgIGNvbXBhbnluYW1lOiB0aGlzLmNvbXBhbnluYW1lLAogICAgICAgICAgY29tcGFueWlkOiB0aGlzLmNvbXBhbnlpZCwKICAgICAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICBpc1Nob3c6IHRydWUKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuJHNlc3Npb24uZ2V0KCJhdCIpfWAsCiAgICAgICAgICB9LAogICAgICAgIH0pCiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC50aXRsZSA9IHJlc3BvbnNlLmRhdGEuV2lkZ2V0VGl0bGU7CiAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmxvZ28gPSByZXNwb25zZS5kYXRhLkltYWdlVXJsOwogICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoIkNoYXRCb3RJbWFnZVBhcmFtZXRlcnMiLCB0aGlzLmNoYXRfd2lkZ2V0KTsKICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuc3R5bGUgPSAibWFyZ2luLXRvcDogNXB4O2hlaWdodDozMHB4O3dpZHRoOmF1dG8iOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGUgPT4gewogICAgICAgICAgaWYgKHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUgPT0gImdvZ3liIikgewogICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LnN0eWxlID0gIm1hcmdpbi10b3A6IDVweDtoZWlnaHQ6MzBweDt3aWR0aDo2MHB4IjsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5sb2dvID0gIi9pbWcvY2Vuc2VfaW1hZ2UucG5nIjsKICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUgPT0gIk1UIENhcmUiCiAgICAgICAgICApIHsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5sb2dvID0gIi9pbWcvcm9ib21hdGVfbG9nby5wbmciOwogICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LnN0eWxlID0gIm1hcmdpbi10b3A6IDVweDtoZWlnaHQ6NTBweDt3aWR0aDo5NXB4IjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQubG9nbyA9ICIvaW1nL2NlbnNlX2ltYWdlLnBuZyI7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuc3R5bGUgPSAibWFyZ2luLXRvcDogNXB4O2hlaWdodDozMHB4O3dpZHRoOjYwcHgiOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoIkNoYXRCb3RJbWFnZVBhcmFtZXRlcnMiLCB0aGlzLmNoYXRfd2lkZ2V0KTsKICAgICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuY2hhdF93aWRnZXQgPSB0aGlzLiRzZXNzaW9uLmdldCgiQ2hhdEJvdEltYWdlUGFyYW1ldGVycyIpOwogICAgICB0aGlzLmNoYXRfd2lkZ2V0LnN0eWxlID0gIm1hcmdpbi10b3A6IDVweDtoZWlnaHQ6MzBweDt3aWR0aDphdXRvIjsKICAgIH0KICAgIGlmICghdGhpcy4kc2Vzc2lvbi5oYXMoIlJlc3BvbnNlQm90VG9rZW4iKSkgewogICAgICBheGlvcwogICAgICAgIC5wb3N0KGFwaV9jYWxscy5ib3RfcmVzcG9uc2VfdG9rZW4oKSwgewogICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwKICAgICAgICB9KQogICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJSZXNwb25zZUJvdFRva2VuIiwgcmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSA9IHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICB0aGlzLnJlZnJlc2hfY2hhdGJvdCgpOwogICAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5yZWZyZXNoX2NoYXRib3QoKTsKICAgIH0KICAgIC8vaGFyc2gKICAgIGlmICgKICAgICAgdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5ID09CiAgICAgICIuZUp4VGNzc3ZTczFNejZ0SXprak1TMDgxTkRleE5JUUtLVURGTWtwS0NvcXQ5UFhMeTh2MTBsQlU2eVhuNS1vbGx1b2JHUmhhNmhxWTZ4cVlLQmdhV0JrWlc1bWE2aG1ibTVnWW1Tb0JBR2E5SHAwLlhSM1R1dy5YNzdGXzdMRHRPTHAyVnQ5c25GRFNvMzFuVHciCiAgICApIHsKICAgICAgdGhpcy5pc2V4Y2hhbmdlID0gdHJ1ZTsKICAgIH0KICAgIHZhciBkID0gbmV3IERhdGUoKTsKICAgIGF4aW9zCiAgICAgIC5wb3N0KGFwaV9jYWxscy5ib3RfdXNlcl9kYXRhKCksIHsKICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgIHR6OiBJbnRsLkRhdGVUaW1lRm9ybWF0KCkucmVzb2x2ZWRPcHRpb25zKCkudGltZVpvbmUsCiAgICAgICAgZGF0ZXRpbWU6IGQudG9JU09TdHJpbmcoKSwKICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlCiAgICAgIH0pCiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHt9KTsKICAgICAgaWYodGhpcy4kcm91dGUucGFyYW1zLmJvdGRhdGE9PXVuZGVmaW5lZCl7CiAgICAgICAgdGhpcy4kcm91dGVyLnB1c2goewogICAgICAgICAgbmFtZTogJ0Rhc2hib2FyZCcsCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5ib3RfbmFtZT10aGlzLiRyb3V0ZS5wYXJhbXMuYm90ZGF0YS5ib3RfbmFtZTsKICAgICAgICB0aGlzLmJvdF90eXBlPXRoaXMuJHJvdXRlLnBhcmFtcy5ib3RkYXRhLmJvdF90eXBlOwogICAgICAgIC8vIGF4aW9zCiAgICAgICAgLy8gICAucG9zdChhcGlfY2FsbHMuY2xvc2VkX2Zvcm1fcmVzcG9uc2VfYXBpKCksewogICAgICAgIC8vICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgIC8vICAgICB1aWQ6ICJjbG9zZWRfZm9ybV91c2VyIiwKICAgICAgICAvLyAgICAgY2hhdDogbnVsbCwKICAgICAgICAvLyAgICAgbm9kZV9zZWxlY3RlZDogbnVsbCwKICAgICAgICAvLyAgICAgYm90X25hbWU6IHRoaXMuYm90X25hbWUsCiAgICAgICAgLy8gICB9KQogICAgICAgIC8vICAgLnRoZW4ocmVzcG9uc2U9PnsKICAgICAgICAvLyAgICAgaWYocmVzcG9uc2UuZGF0YS5lcnJvcj09dW5kZWZpbmVkKXsKICAgICAgICAvLyAgICAgICB0aGlzLmNsb3NlZF9ib3RfY2hhdChyZXNwb25zZS5kYXRhKTsKICAgICAgICAvLyAgICAgICB0aGlzLmlzY2xvc2VkYm90b249dHJ1ZTsKICAgICAgICAvLyAgICAgfQogICAgICAgIC8vICAgfSk7CiAgICAgIH0KICB9LAogIG1vdW50ZWQoKSB7CiAgICBDb3VudHJ5Q29kZXMuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgIGlmKGEuY29kZSA8IGIuY29kZSkgeyByZXR1cm4gLTE7IH0KICAgICAgaWYoYS5jb2RlID4gYi5jb2RlKSB7IHJldHVybiAxOyB9CiAgICAgIHJldHVybiAwOwogICAgfSk7CgogICAgdGhpcy5zaG93ID0gZmFsc2U7CiAgICBpZiAodGhpcy4kcm91dGUubmFtZSA9PSAiVHJhaW4gdGhlIEJvdCIpIHsKICAgICAgJCgiLmNoYXQtd3JhcCIpLmNzcygicmlnaHQiLCAiYXV0byIpOwogICAgfQogICAgaWYgKHRoaXMuJHJvdXRlLm5hbWUgPT0gIkRpcmVjdCBSZXNwb25zZSBCb3QiKSB7CiAgICAgICQoIi5jaGF0LXdyYXAiKS5jc3MoIm1hcmdpblRvcCIsICI1JSIpOwogICAgfQogICAgJCgnW2RhdGEtdG9nZ2xlPSJwb3BvdmVyIl0nKQogICAgICAucG9wb3Zlcih7CiAgICAgICAgaHRtbDogdHJ1ZSwKICAgICAgICBjb250ZW50OiAkKCIjcG9wb3Zlcl9jb250ZW50IikKICAgICAgfSkKICAgICAgLm9uKCJzaG93LmJzLnBvcG92ZXIiLCBmdW5jdGlvbigpIHsKICAgICAgICAkKCIjcG9wb3Zlcl9jb250ZW50IikuYWRkQ2xhc3MoImQtYmxvY2siKTsKICAgICAgfSkKICAgICAgLm9uKCJoaWRlLmJzLnBvcG92ZXIiLCBmdW5jdGlvbigpIHsKICAgICAgICAkKCIjcG9wb3Zlcl9jb250ZW50IikuYWRkQ2xhc3MoImQtbm9uZSIpOwogICAgICB9KTsKICAgICQoIiNwb3BvdmVyX2NvbnRlbnQiKS5jc3MoInpJbmRleCIsIDk5OTkpOwogICAgYnVzLiRvbigiTG9nb3V0IGhhcyBiZWVuIGNsaWNrZWQiLCBkYXRhID0+IHsKICAgICAgaWYgKGRhdGEgPT0gIlRydWUiKSB7CiAgICAgICAgJCgnW2RhdGEtdG9nZ2xlPSJwb3BvdmVyIl0nKS5wb3BvdmVyKCJoaWRlIik7CiAgICAgIH0KICAgIH0pOwogICAgd2luZG93LlNwZWVjaFJlY29nbml0aW9uID0KICAgICAgd2luZG93LndlYmtpdFNwZWVjaFJlY29nbml0aW9uIHx8IHdpbmRvdy5TcGVlY2hSZWNvZ25pdGlvbjsKICAgIHdpbmRvdy5BdWRpb0NvbnRleHQgPSB3aW5kb3cuQXVkaW9Db250ZXh0IHx8IHdpbmRvdy53ZWJraXRBdWRpb0NvbnRleHQ7CiAgICBuYXZpZ2F0b3IuZ2V0VXNlck1lZGlhID0KICAgICAgbmF2aWdhdG9yLmdldFVzZXJNZWRpYSB8fAogICAgICBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhIHx8CiAgICAgIG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEgfHwKICAgICAgbmF2aWdhdG9yLm1zR2V0VXNlck1lZGlhOwoKCiAgfSwKICB1cGRhdGVkKCkgewogICAgdGhpcy5zdWJtaXRfY3VzdG9tX2Zvcm0oKTsKICAgIGlmKHRoaXMuaXNjbG9zZWRib3RvbiYmdGhpcy5pc2Zvcm1vbil7CiAgICAgIHRoaXMuc3VibWl0X2Nsb3NlZF9mb3JtX2RhdGEoKTsKICAgIH0KICB9LAogIG1ldGhvZHM6IHsKICAgIGdlbmVyYXRlVVVJRCgpIHsgLy8gUHVibGljIERvbWFpbi9NSVQKICAgICAgICAgICAgdmFyIGQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsvL1RpbWVzdGFtcAogICAgICAgICAgICB2YXIgZDIgPSAocGVyZm9ybWFuY2UgJiYgcGVyZm9ybWFuY2Uubm93ICYmIChwZXJmb3JtYW5jZS5ub3coKSoxMDAwKSkgfHwgMDsvL1RpbWUgaW4gbWljcm9zZWNvbmRzIHNpbmNlIHBhZ2UtbG9hZCBvciAwIGlmIHVuc3VwcG9ydGVkCiAgICAgICAgICAgIHJldHVybiAneHh4eHh4eHgteHh4eC00eHh4LXl4eHgteHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgICAgIHZhciByID0gTWF0aC5yYW5kb20oKSAqIDE2Oy8vcmFuZG9tIG51bWJlciBiZXR3ZWVuIDAgYW5kIDE2CiAgICAgICAgICAgICAgICBpZihkID4gMCl7Ly9Vc2UgdGltZXN0YW1wIHVudGlsIGRlcGxldGVkCiAgICAgICAgICAgICAgICAgICAgciA9IChkICsgciklMTYgfCAwOwogICAgICAgICAgICAgICAgICAgIGQgPSBNYXRoLmZsb29yKGQvMTYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsvL1VzZSBtaWNyb3NlY29uZHMgc2luY2UgcGFnZS1sb2FkIGlmIHN1cHBvcnRlZAogICAgICAgICAgICAgICAgICAgIHIgPSAoZDIgKyByKSUxNiB8IDA7CiAgICAgICAgICAgICAgICAgICAgZDIgPSBNYXRoLmZsb29yKGQyLzE2KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAoYyA9PT0gJ3gnID8gciA6IChyICYgMHgzIHwgMHg4KSkudG9TdHJpbmcoMTYpOwogICAgICAgICAgICB9KTsKICAgIH0sCiAgICB2b2ljZV9jb21tdW5pY2F0aW9uKCkgewogICAgICBpZiAoL0Nocm9taXVtL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSkgewogICAgICAgIHRoaXMuY2FsbF9jbG91ZF9hcGkoKTsKICAgICAgfSBlbHNlIGlmICh3aW5kb3cuU3BlZWNoUmVjb2duaXRpb24gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5yZWNvZ25pdGlvbiA9IG5ldyB3aW5kb3cuU3BlZWNoUmVjb2duaXRpb24oKTsKICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjbWljcm9waG9uZSIpLmNsYXNzTGlzdC5hZGQoInZvaWNlLW9uIik7CiAgICAgICAgdGhpcy5yZWNvZ25pdGlvbi5vbnJlc3VsdCA9IGUgPT4gewogICAgICAgICAgY29uc3Qgc3BlZWNoVG9UZXh0ID0gZS5yZXN1bHRzWzBdWzBdLnRyYW5zY3JpcHQ7CiAgICAgICAgfTsKICAgICAgICB0aGlzLnJlY29nbml0aW9uLm9uZW5kID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjbWljcm9waG9uZSIpLmNsYXNzTGlzdC5yZW1vdmUoInZvaWNlLW9uIik7CiAgICAgICAgICAvL0FnYWluIOKAkyBnaXZlIHRoZSB1c2VyIGZlZWRiYWNrIHRoYXQgeW91IGFyZSBub3QgbGlzdGVuaW5nIGFueW1vcmUuIElmIHlvdSB3aXNoIHRvIGFjaGlldmUgY29udGludW91cyByZWNvZ25pdGlvbiDigJMgeW91IGNhbiB3cml0ZSBhIHNjcmlwdCB0byBzdGFydCB0aGUgcmVjb2duaXplciBhZ2FpbiBoZXJlLgogICAgICAgIH07CiAgICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgICB0aGlzLnJlY29nbml0aW9uLm9ucmVzdWx0ID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgZXZlbnQucmVzdWx0cyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgLy9Tb21ldGhpbmcgaXMgd3JvbmfigKYKICAgICAgICAgICAgdGhpcy5yZWNvZ25pdGlvbi5zdG9wKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSBldmVudC5yZXN1bHRJbmRleDsgaSA8IGV2ZW50LnJlc3VsdHMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnJlc3VsdHNbaV0uaXNGaW5hbCkgewogICAgICAgICAgICAgIC8vRmluYWwgcmVzdWx0cwogICAgICAgICAgICAgIHZtLnRvX3NlbmQgPSBldmVudC5yZXN1bHRzW2ldWzBdLnRyYW5zY3JpcHQ7CiAgICAgICAgICAgICAgY29uc29sZS5sb2coImZpbmFsIHJlc3VsdHM6ICIgKyBldmVudC5yZXN1bHRzW2ldWzBdLnRyYW5zY3JpcHQpOyAvL09mIGNvdXJzZSDigJMgaGVyZSBpcyB0aGUgcGxhY2UgdG8gZG8gdXNlZnVsIHRoaW5ncyB3aXRoIHRoZSByZXN1bHRzLgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vaS5lLiBpbnRlcmltLi4uCiAgICAgICAgICAgICAgY29uc29sZS5sb2coImludGVyaW0gcmVzdWx0czogIiArIGV2ZW50LnJlc3VsdHNbaV1bMF0udHJhbnNjcmlwdCk7IC8vWW91IGNhbiB1c2UgdGhlc2UgcmVzdWx0cyB0byBnaXZlIHRoZSB1c2VyIG5lYXIgcmVhbCB0aW1lIGV4cGVyaWVuY2UuCiAgICAgICAgICAgIH0KICAgICAgICAgIH0gLy9lbmQgZm9yIGxvb3AKICAgICAgICB9OwogICAgICAgIHRoaXMucmVjb2duaXRpb24uc3RhcnQoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmNhbGxfY2xvdWRfYXBpKCk7CiAgICAgIH0KICAgIH0sCiAgICBjYWxsX2Nsb3VkX2FwaSgpIHsKICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI21pY3JvcGhvbmUiKS5jbGFzc0xpc3QuYWRkKCJ2b2ljZS1vbiIpOwogICAgICBjb25zdCBhdWRpb0NvbnRleHQgPSBuZXcgKHdpbmRvdy5BdWRpb0NvbnRleHQgfHwKICAgICAgICB3aW5kb3cud2Via2l0QXVkaW9Db250ZXh0KSgpOwogICAgICB2YXIgYnVmZmVyX2xpc3QsIGJ1ZmZlcl9pMzI7CiAgICAgIHZhciByZWNvcmRlciA9IG5ldyBSZWNvcmRlcihhdWRpb0NvbnRleHQsIHsKICAgICAgICAvLyBBbiBhcnJheSBvZiAyNTUgTnVtYmVycwogICAgICAgIC8vIFlvdSBjYW4gdXNlIHRoaXMgdG8gdmlzdWFsaXplIHRoZSBhdWRpbyBzdHJlYW0KICAgICAgICAvLyBJZiB5b3UgdXNlIHJlYWN0LCBjaGVjayBvdXQgcmVhY3Qtd2F2ZS1zdHJlYW0KICAgICAgICBvbkFuYWx5c2VkOiBkYXRhID0+IHt9CiAgICAgIH0pOwoKICAgICAgdmFyIHZvaWNlX2NoYW5uZWwsCiAgICAgICAgd2F2X3BhcmFtZXRlcnMsCiAgICAgICAgcmVjQnVmZmVycyA9IFtdLAogICAgICAgIHJlY0xlbmd0aCwKICAgICAgICBtZXRhX2RhdGE7CiAgICAgIHZhciB2bSA9IHRoaXM7CiAgICAgIGF4aW9zLmdldChhcGlfY2FsbHMudm9pY2VfY2hhbm5lbF9hcGkoKSkudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgdGhpcy52b2ljZV9zb2NrZXQgPSBuZXcgU29ja2V0KHByb2Nlc3MuZW52LlZVRV9BUFBfTElWRV9DSEFUX1dFQlNPQ0tFVF9FTkRQT0lOVCwgewogICAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICAgIGNvbXBhbnk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUsCiAgICAgICAgICAgIHZvaWNlX2NoYW5uZWxfbmFtZTogcmVzcG9uc2UuZGF0YS52b2ljZV9jaGFubmVsX25hbWUsCiAgICAgICAgICAgIHRva2VuOiByZXNwb25zZS5kYXRhLnRva2VuLAogICAgICAgICAgICBpc192b2ljZTogdHJ1ZQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHRoaXMudm9pY2Vfc29ja2V0LmNvbm5lY3QoKTsKCiAgICAgICAgdm9pY2VfY2hhbm5lbCA9IHRoaXMudm9pY2Vfc29ja2V0LmNoYW5uZWwoCiAgICAgICAgICAidm9pY2VfdG9fdGV4dDoiICsgcmVzcG9uc2UuZGF0YS52b2ljZV9jaGFubmVsX25hbWUKICAgICAgICApOwogICAgICAgIHZvaWNlX2NoYW5uZWwuam9pbigpOwogICAgICB9KTsKCiAgICAgIGxldCBibG9iID0gbnVsbDsKCiAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMKICAgICAgICAuZ2V0VXNlck1lZGlhKHsgYXVkaW86IHRydWUgfSkKICAgICAgICAudGhlbihzdHJlYW0gPT4gewogICAgICAgICAgcmVjb3JkZXIuaW5pdChzdHJlYW0pOwogICAgICAgICAgc3RhcnRSZWNvcmRpbmcoKTsKICAgICAgICB9KQogICAgICAgIC5jYXRjaChlcnIgPT4gY29uc29sZS5sb2coIlVoIG9oLi4uIHVuYWJsZSB0byBnZXQgc3RyZWFtLi4uIiwgZXJyKSk7CgogICAgICBmdW5jdGlvbiBzdGFydFJlY29yZGluZygpIHsKICAgICAgICByZWNvcmRlci5zdGFydCgpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgc3RvcFJlY29yZGluZygpOwogICAgICAgIH0sIDQwMDApOwogICAgICB9CgogICAgICBmdW5jdGlvbiBzdG9wUmVjb3JkaW5nKCkgewogICAgICAgIHJlY29yZGVyLnN0b3AoKS50aGVuKCh7IGJsb2IsIGJ1ZmZlciB9KSA9PiB7CiAgICAgICAgICAvLyBidWZmZXJfbGlzdCA9IGJ1ZmZlclswXTsKICAgICAgICAgIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwogICAgICAgICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKGJsb2IpOwogICAgICAgICAgcmVhZGVyLm9ubG9hZGVuZCA9ICgpID0+IHsKICAgICAgICAgICAgYnVmZmVyX2xpc3QgPSByZWFkZXIucmVzdWx0OwogICAgICAgICAgICB2YXIgdGVtcCA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcl9saXN0KTsKICAgICAgICAgICAgd2F2X3BhcmFtZXRlcnMgPSB3YXZfZmlsZV9wcm9jZXNzaW5nX3JlYWRfcGFyYW1ldGVycyh0ZW1wKTsKICAgICAgICAgICAgaW5pdF9lbmNvZGVyKGJ1ZmZlcl9saXN0KTsKICAgICAgICAgIH07CiAgICAgICAgICAvLyBSZWNvcmRlci5kb3dubG9hZChibG9iLCAibXktZmlsZSIpOwogICAgICAgICAgLy8gYnVmZmVyIGlzIGFuIEF1ZGlvQnVmZmVyCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGluaXRfZW5jb2RlcihkYXRhKSB7CiAgICAgICAgdmFyIGFycmF5QnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoZGF0YSk7CgogICAgICAgIHZhciBlbmNEYXRhID0gW107CiAgICAgICAgdmFyIHJlc3VsdCA9IGVuY29kZUZsYWMoYXJyYXlCdWZmZXIsIGVuY0RhdGEpOwogICAgICAgIC8vIGNvbnNvbGUubG9nKCJlbmNvZGVkIGRhdGEgYXJyYXk6ICIsIGVuY0RhdGEpOwoKICAgICAgICBpZiAocmVzdWx0LmVycm9yKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCJDb252ZXJzaW9uIGZhaWxlZCEhIik7CiAgICAgICAgfQoKICAgICAgICB2YXIgbWV0YURhdGEgPSByZXN1bHQubWV0YURhdGE7CgogICAgICAgIGlmICghcmVzdWx0LmVycm9yKSB7CiAgICAgICAgICAvL3VzaW5nIGRhdGEtdXRpbC5qcyB1dGlsaXR5IGZ1bmN0aW9uKHMpCiAgICAgICAgICB2YXIgYmxvYl9kb3dubG9hZCA9IGV4cG9ydEZsYWNGaWxlKGVuY0RhdGEsIG1ldGFEYXRhKTsKICAgICAgICAgIC8vIHZhciBkb3duX2ZpbGUgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2JfZG93bmxvYWQpOwogICAgICAgICAgLy8gbGV0IGZpbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgICAgICAvLyBmaWxlLmhyZWYgPSBkb3duX2ZpbGU7CiAgICAgICAgICAvLyBmaWxlLmRvd25sb2FkID0gIm91dHB1dC5mbGFjIjsKICAgICAgICAgIC8vIGZpbGUuY2xpY2soKQogICAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChibG9iX2Rvd25sb2FkKTsKICAgICAgICAgIHJlYWRlci5vbmxvYWRlbmQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHJlYWRlcl9zdHJpbmcgPSByZWFkZXIucmVzdWx0LnNwbGl0KCJiYXNlNjQsIilbMV07CiAgICAgICAgICAgIHZvaWNlX2NoYW5uZWwucHVzaCgidm9pY2VfcGFja2V0c19zZW50IiwgeyBzdHJlYW06IHJlYWRlcl9zdHJpbmcgfSk7CiAgICAgICAgICAgIHZvaWNlX2NoYW5uZWwub24oInZvaWNlX3RvX3RleHRfcmVwbHkiLCBkYXRhID0+IHsKICAgICAgICAgICAgICBkb2N1bWVudAogICAgICAgICAgICAgICAgLnF1ZXJ5U2VsZWN0b3IoIiNtaWNyb3Bob25lIikKICAgICAgICAgICAgICAgIC5jbGFzc0xpc3QucmVtb3ZlKCJ2b2ljZS1vbiIpOwogICAgICAgICAgICAgIGlmIChkYXRhLnRleHQucmVzdWx0cyAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHZtLnRvX3NlbmQgPSBkYXRhLnRleHQucmVzdWx0c1swXS5hbHRlcm5hdGl2ZXNbMF0udHJhbnNjcmlwdDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdG9hc3RyLmVycm9yKAogICAgICAgICAgICAgICAgICAiV2UgY291bGQgbm90IHJlY29nbml6ZSB5b3VyIHZvaWNlLiBQbGVhc2UgdHJ5IGFnYWluIG9yIHR5cGUgaW4uIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdm0uYnV0dG9uX2ZpbGwoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gZW5jb2RlRmxhYyhiaW5EYXRhLCByZWNCdWZmZXJzKSB7CiAgICAgICAgdmFyIHVpOF9kYXRhID0gbmV3IFVpbnQ4QXJyYXkoYmluRGF0YSk7CiAgICAgICAgdmFyIHNhbXBsZV9yYXRlID0gMCwKICAgICAgICAgIGNoYW5uZWxzID0gMCwKICAgICAgICAgIGJwcyA9IDAsCiAgICAgICAgICB0b3RhbF9zYW1wbGVzID0gMCwKICAgICAgICAgIGJsb2NrX2FsaWduLAogICAgICAgICAgcG9zaXRpb24gPSAwLAogICAgICAgICAgcmVjTGVuZ3RoID0gMCwKICAgICAgICAgIG1ldGFfZGF0YTsKCiAgICAgICAgLyoqCiAgICAgICAgICogIHJlY29yZHMvc2F2ZXMgdGhlIG91dHB1dCBkYXRhIG9mIGxpYmZsYWMtZW5jb2RlIG1ldGhvZAogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHdyaXRlX2NhbGxiYWNrX2ZuKGJ1ZmZlciwgYnl0ZXMsIHNhbXBsZXMsIGN1cnJlbnRfZnJhbWUpIHsKICAgICAgICAgIHJlY0J1ZmZlcnMucHVzaChidWZmZXIpOwogICAgICAgICAgcmVjTGVuZ3RoICs9IGJ5dGVzOwogICAgICAgICAgLy8gcmVjTGVuZ3RoICs9IGJ1ZmZlci5ieXRlTGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbWV0YWRhdGFfY2FsbGJhY2tfZm4oZGF0YSkgewogICAgICAgICAgbWV0YV9kYXRhID0gZGF0YTsKICAgICAgICB9CgogICAgICAgIC8vIGNoZWNrOiBpcyBmaWxlIGEgY29tcGF0aWJsZSB3YXYtZmlsZT8KICAgICAgICBpZiAod2F2X2ZpbGVfcHJvY2Vzc2luZ19jaGVja193YXZfZm9ybWF0KHVpOF9kYXRhKSA9PSBmYWxzZSkgewogICAgICAgICAgcmV0dXJuIHsgZXJyb3I6ICJXcm9uZyBXQVYgZmlsZSBmb3JtYXQiLCBzdGF0dXM6IDAgfTsKICAgICAgICB9CgogICAgICAgIC8vIGdldCBXQVYvUENNIHBhcmFtZXRlcnMgZnJvbSBkYXRhIC8gZmlsZQogICAgICAgIHZhciB3YXZfcGFyYW1ldGVycyA9IHdhdl9maWxlX3Byb2Nlc3NpbmdfcmVhZF9wYXJhbWV0ZXJzKHVpOF9kYXRhKTsKICAgICAgICB2YXIgdG90X3NhbXBsZXMgPSAwOwogICAgICAgIHZhciBjb21wcmVzc2lvbl9sZXZlbCA9IDU7CiAgICAgICAgdmFyIGZsYWNfb2sgPSAxOwogICAgICAgIHZhciBpc192ZXJpZnkgPSB0cnVlOwoKICAgICAgICB2YXIgZmxhY19lbmNvZGVyID0gRmxhYy5jcmVhdGVfbGliZmxhY19lbmNvZGVyKAogICAgICAgICAgd2F2X3BhcmFtZXRlcnMuc2FtcGxlX3JhdGUsCiAgICAgICAgICB3YXZfcGFyYW1ldGVycy5jaGFubmVscywKICAgICAgICAgIHdhdl9wYXJhbWV0ZXJzLmJwcywKICAgICAgICAgIGNvbXByZXNzaW9uX2xldmVsLAogICAgICAgICAgdG90X3NhbXBsZXMsCiAgICAgICAgICBpc192ZXJpZnkKICAgICAgICApOwogICAgICAgIGlmIChmbGFjX2VuY29kZXIgIT0gMCkgewogICAgICAgICAgdmFyIGluaXRfc3RhdHVzID0gRmxhYy5pbml0X2VuY29kZXJfc3RyZWFtKAogICAgICAgICAgICBmbGFjX2VuY29kZXIsCiAgICAgICAgICAgIHdyaXRlX2NhbGxiYWNrX2ZuLAogICAgICAgICAgICBtZXRhZGF0YV9jYWxsYmFja19mbiwKICAgICAgICAgICAgMAogICAgICAgICAgKTsKICAgICAgICAgIGZsYWNfb2sgJj0gaW5pdF9zdGF0dXMgPT0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIG1zZyA9ICJFcnJvciBpbml0aWFsaXppbmcgdGhlIGRlY29kZXIuIjsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IobXNnKTsKICAgICAgICAgIHJldHVybiB7IGVycm9yOiBtc2csIHN0YXR1czogMSB9OwogICAgICAgIH0KCiAgICAgICAgLy8gY29udmVydCB0aGUgUENNLURhdGEgdG8gdGhlIGFwcHJvcHJpYXRlIGZvcm1hdCBmb3IgdGhlIGxpYmZsYWMgbGlicmFyeSBtZXRob2RzICgzMi1iaXQgYXJyYXkgb2Ygc2FtcGxlcykKICAgICAgICAvLyBjcmVhdGVzIGEgbmV3IGFycmF5ICgzMi1iaXQpIGFuZCBzdG9yZXMgdGhlIDE2LWJpdCBkYXRhIG9mIHRoZSB3YXYtZmlsZSBhcyAzMi1iaXQgZGF0YQogICAgICAgIHZhciBidWZmZXJfaTMyID0gd2F2X2ZpbGVfcHJvY2Vzc2luZ19jb252ZXJ0XzE2Yml0ZGF0YV90bzMyYml0ZGF0YSgKICAgICAgICAgIHVpOF9kYXRhLmJ1ZmZlcgogICAgICAgICk7CgogICAgICAgIHZhciBmbGFjX3JldHVybiA9IEZsYWMuRkxBQ19fc3RyZWFtX2VuY29kZXJfcHJvY2Vzc19pbnRlcmxlYXZlZCgKICAgICAgICAgIGZsYWNfZW5jb2RlciwKICAgICAgICAgIGJ1ZmZlcl9pMzIsCiAgICAgICAgICBidWZmZXJfaTMyLmxlbmd0aCAvIHdhdl9wYXJhbWV0ZXJzLmNoYW5uZWxzCiAgICAgICAgKTsKCiAgICAgICAgaWYgKGZsYWNfcmV0dXJuICE9IHRydWUpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgICAiRXJyb3I6IEZMQUNfX3N0cmVhbV9lbmNvZGVyX3Byb2Nlc3NfaW50ZXJsZWF2ZWQgcmV0dXJuZWQgZmFsc2UuICIgKwogICAgICAgICAgICAgIGZsYWNfcmV0dXJuCiAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgZmxhY19vayAmPSBGbGFjLkZMQUNfX3N0cmVhbV9lbmNvZGVyX2ZpbmlzaChmbGFjX2VuY29kZXIpOwoKICAgICAgICBGbGFjLkZMQUNfX3N0cmVhbV9lbmNvZGVyX2RlbGV0ZShmbGFjX2VuY29kZXIpOwoKICAgICAgICByZXR1cm4geyBtZXRhRGF0YTogbWV0YV9kYXRhLCBzdGF0dXM6IGZsYWNfb2sgfTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gd2F2X2ZpbGVfcHJvY2Vzc2luZ19jaGVja193YXZfZm9ybWF0KHVpOF9kYXRhKSB7CiAgICAgICAgLy8gY2hlY2s6IGlzIGZpbGUgYSBjb21wYXRpYmxlIHdhdi1maWxlPwogICAgICAgIGlmICgKICAgICAgICAgIHVpOF9kYXRhLmxlbmd0aCA8IDQ0IHx8CiAgICAgICAgICBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIHVpOF9kYXRhLnN1YmFycmF5KDAsIDQpKSAhPSAiUklGRiIgfHwKICAgICAgICAgIFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgdWk4X2RhdGEuc3ViYXJyYXkoOCwgMTYpKSAhPQogICAgICAgICAgICAiV0FWRWZtdCAiIHx8CiAgICAgICAgICBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIHVpOF9kYXRhLnN1YmFycmF5KDM2LCA0MCkpICE9ICJkYXRhIgogICAgICAgICkgewogICAgICAgICAgY29uc29sZS5sb2coIkVSUk9SOiB3cm9uZyBmb3JtYXQgZm9yIHdhdi1maWxlLiIpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgLyoqCiAgICAgICAqICBjaGVja3MgaWYgdGhlIGdpdmVuIHVpOF9kYXRhICh1aThhcnJheSkgaXMgb2YgYSBmbGFjLWZpbGUKICAgICAgICovCiAgICAgIGZ1bmN0aW9uIGZsYWNfZmlsZV9wcm9jZXNzaW5nX2NoZWNrX2ZsYWNfZm9ybWF0KHVpOF9kYXRhKSB7CiAgICAgICAgLy8gY2hlY2s6IGlzIGZpbGUgYSBjb21wYXRpYmxlIGZsYWMtZmlsZT8KICAgICAgICBpZiAoCiAgICAgICAgICB1aThfZGF0YS5sZW5ndGggPCA0MiB8fAogICAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLCB1aThfZGF0YS5zdWJhcnJheSgwLCA0KSkgIT0gImZMYUMiCiAgICAgICAgKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygiRVJST1I6IHdyb25nIGZvcm1hdCBmb3IgZmxhYy1maWxlLiIpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyh1aThfZGF0YS5idWZmZXIpOwogICAgICAgIC8vY2hlY2sgbGFzdCA3IGJpdHMgb2YgNHRoIGJ5dGUgZm9yIG1ldGEtZGF0YSBCTE9DSyB0eXBlOiBtdXN0IGJlIFNUUkVBTUlORk8gKDApCiAgICAgICAgaWYgKCh2aWV3LmdldFVpbnQ4KDQpICYgMHg3ZikgIT0gMCkgewogICAgICAgICAgY29uc29sZS5sb2coIkVSUk9SOiB3cm9uZyBmb3JtYXQgZm9yIGZsYWMtZmlsZS4iKTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICBmdW5jdGlvbiB3YXZfZmlsZV9wcm9jZXNzaW5nX3JlYWRfcGFyYW1ldGVycyh1aThfZGF0YSkgewogICAgICAgIHZhciBzYW1wbGVfcmF0ZSA9IDAsCiAgICAgICAgICBjaGFubmVscyA9IDAsCiAgICAgICAgICBicHMgPSAwLAogICAgICAgICAgdG90YWxfc2FtcGxlcyA9IDAsCiAgICAgICAgICBibG9ja19hbGlnbjsKCiAgICAgICAgLy8gZ2V0IFdBVi9QQ00gcGFyYW1ldGVycyBmcm9tIGRhdGEgLyBmaWxlCiAgICAgICAgc2FtcGxlX3JhdGUgPQogICAgICAgICAgKCgoKCh1aThfZGF0YVsyN10gPDwgOCkgfCB1aThfZGF0YVsyNl0pIDw8IDgpIHwgdWk4X2RhdGFbMjVdKSA8PCA4KSB8CiAgICAgICAgICB1aThfZGF0YVsyNF07CiAgICAgICAgY2hhbm5lbHMgPSB1aThfZGF0YVsyMl07CiAgICAgICAgYnBzID0gdWk4X2RhdGFbMzRdOwogICAgICAgIGJsb2NrX2FsaWduID0gdWk4X2RhdGFbMzJdOwogICAgICAgIHRvdGFsX3NhbXBsZXMgPQogICAgICAgICAgKCgoKCgodWk4X2RhdGFbNDNdIDw8IDgpIHwgdWk4X2RhdGFbNDJdKSA8PCA4KSB8IHVpOF9kYXRhWzQxXSkgPDwgOCkgfAogICAgICAgICAgICB1aThfZGF0YVs0MF0pIC8KICAgICAgICAgIGJsb2NrX2FsaWduOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgc2FtcGxlX3JhdGU6IHNhbXBsZV9yYXRlLAogICAgICAgICAgY2hhbm5lbHM6IGNoYW5uZWxzLAogICAgICAgICAgYnBzOiBicHMsCiAgICAgICAgICB0b3RhbF9zYW1wbGVzOiB0b3RhbF9zYW1wbGVzLAogICAgICAgICAgYmxvY2tfYWxpZ246IGJsb2NrX2FsaWduCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgLyoqCiAgICAgICAqICBjb252ZXJ0cyB0aGUgUENNIGRhdGEgb2YgdGhlIHdhdiBmaWxlIChlYWNoIHNhbXBsZSBzdG9yZWQgYXMgMTYgYml0IHZhbHVlKSBpbnRvCiAgICAgICAqICBhIGZvcm1hdCBleHBlY3RlZCBieSB0aGUgbGliZmxhYy1lbmNvZGVyIG1ldGhvZCAoZWFjaCBzYW1wbGUgc3RvcmVkIGFzIDMyIGJpdCB2YWx1ZSBpbiBhIDMyLWJpdCBhcnJheSkKICAgICAgICovCiAgICAgIGZ1bmN0aW9uIHdhdl9maWxlX3Byb2Nlc3NpbmdfY29udmVydF8xNmJpdGRhdGFfdG8zMmJpdGRhdGEoYXJyYXlidWZmZXIpIHsKICAgICAgICAvLyBjb252ZXJ0IHRoZSBQQ00tRGF0YSB0byB0aGUgYXBwcm9wcmlhdGUgZm9ybWF0IGZvciB0aGUgbGliZmxhYyBsaWJyYXJ5IG1ldGhvZHMgKDMyLWJpdCBhcnJheSBvZiBzYW1wbGVzKQogICAgICAgIC8vIGNyZWF0ZXMgYSBuZXcgYXJyYXkgKDMyLWJpdCkgYW5kIHN0b3JlcyB0aGUgMTYtYml0IGRhdGEgb2YgdGhlIHdhdi1maWxlIGFzIDMyLWJpdCBkYXRhCiAgICAgICAgdmFyIGFiX2kxNiA9IG5ldyBEYXRhVmlldyhhcnJheWJ1ZmZlciwgNDQpOwogICAgICAgIHZhciBidWZfbGVuZ3RoID0gYWJfaTE2LmJ5dGVMZW5ndGg7CiAgICAgICAgdmFyIGJ1ZjMyX2xlbmd0aCA9IGJ1Zl9sZW5ndGggLyAyOwogICAgICAgIHZhciBidWZmZXJfaTMyID0gbmV3IFVpbnQzMkFycmF5KGJ1ZjMyX2xlbmd0aCk7CiAgICAgICAgdmFyIHZpZXcgPSBuZXcgRGF0YVZpZXcoYnVmZmVyX2kzMi5idWZmZXIpOwogICAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBidWZfbGVuZ3RoOyBqICs9IDIpIHsKICAgICAgICAgIHZpZXcuc2V0SW50MzIoaW5kZXgsIGFiX2kxNi5nZXRJbnQxNihqLCB0cnVlKSwgdHJ1ZSk7CiAgICAgICAgICBpbmRleCArPSA0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gYnVmZmVyX2kzMjsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZXhwb3J0RmxhY0ZpbGUocmVjQnVmZmVycywgbWV0YURhdGEpIHsKICAgICAgICB2YXIgcmVjTGVuZ3RoID0gZ2V0TGVuZ3RoKHJlY0J1ZmZlcnMpOwogICAgICAgIGlmIChtZXRhRGF0YSkgewogICAgICAgICAgYWRkRkxBQ01ldGFEYXRhKHJlY0J1ZmZlcnMsIG1ldGFEYXRhKTsKICAgICAgICB9CiAgICAgICAgLy9jb252ZXJ0IGJ1ZmZlcnMgaW50byBvbmUgc2luZ2xlIGJ1ZmZlcgogICAgICAgIHZhciBzYW1wbGVzID0gbWVyZ2VCdWZmZXJzKHJlY0J1ZmZlcnMsIHJlY0xlbmd0aCk7CiAgICAgICAgdmFyIHRoZV9ibG9iID0gbmV3IEJsb2IoW3NhbXBsZXNdKTsKICAgICAgICByZXR1cm4gdGhlX2Jsb2I7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGdldExlbmd0aChyZWNCdWZmZXJzKSB7CiAgICAgICAgLy9nZXQgbGVuZ3RoCiAgICAgICAgdmFyIHJlY0xlbmd0aCA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IHJlY0J1ZmZlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgIHJlY0xlbmd0aCArPSByZWNCdWZmZXJzW2ldLmJ5dGVMZW5ndGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZWNMZW5ndGg7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFkZEZMQUNNZXRhRGF0YShjaHVua3MsIG1ldGFkYXRhKSB7CiAgICAgICAgdmFyIG9mZnNldCA9IDQ7CiAgICAgICAgdmFyIGRhdGEgPSBjaHVua3NbMF07IC8vMXN0IGRhdGEgY2h1bmsgc2hvdWxkIGNvbnRhaW4gRkxBQyBpZGVudGlmaWVyICJmTGFDIgogICAgICAgIGlmICgKICAgICAgICAgIGRhdGEubGVuZ3RoIDwgNCB8fAogICAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLCBkYXRhLnN1YmFycmF5KDAsIDQpKSAhPSAiZkxhQyIKICAgICAgICApIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgICJVbmtub3duIGRhdGEgZm9ybWF0OiBjYW5ub3QgYWRkIGFkZGl0aW9uYWwgRkxBQyBtZXRhIGRhdGEgdG8gaGVhZGVyIgogICAgICAgICAgKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vZmlyc3QgY2h1bmsgb25seSBjb250YWlucyB0aGUgZmxhYyBpZGVudGlmaWVyIHN0cmluZz8KICAgICAgICBpZiAoZGF0YS5sZW5ndGggPT0gNCkgewogICAgICAgICAgZGF0YSA9IGNodW5rc1sxXTsgLy9nZXQgMm5kIGRhdGEgY2h1bmsgd2hpY2ggc2hvdWxkIGNvbnRhaW4gU1RSRUFNSU5GTyBtZXRhLWRhdGEgYmxvY2sgKGFuZCBwcm9iYWJseSBtb3JlKQogICAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgICB9CgogICAgICAgIHZhciB2aWV3ID0gbmV3IERhdGFWaWV3KGRhdGEuYnVmZmVyKTsKCiAgICAgICAgLy9OT1RFIGJ5IGRlZmF1bHQsIHRoZSBlbmNvZGVyIHdyaXRlcyBhIDJuZCBtZXRhLWRhdGEgYmxvY2sgKHR5cGUgVk9SQklTX0NPTU1FTlQpIHdpdGggZW5jb2Rlci92ZXJzaW9uIGluZm8gLT4gZG8gbm90IHNldCAiaXMgbGFzdCIgdG8gVFJVRSBmb3IgZmlyc3Qgb25lCiAgICAgICAgLy8JLy8gd3JpdGUgImlzIGxhc3QgbWV0YSBkYXRhIGJsb2NrIiAmIHR5cGUgU1RSRUFNSU5GTyB0eXBlICgwKSBhcyBsaXR0bGUgZW5kaWFuIGNvbWJpbmVkIHVpbnQxICYgdWludDcgLT4gdWludDg6CiAgICAgICAgLy8JdmFyIGlzTGFzdCA9IDE7Ly8xIGJpdAogICAgICAgIC8vCXZhciBzdHJlYW1JbmZvVHlwZSA9IDA7Ly83IGJpdAogICAgICAgIC8vCXZpZXcuc2V0VWludDgoMCArIG9mZnNldCwgaXNMYXN0IDw8IDcgfCBzdHJlYW1JbmZvVHlwZSwgdHJ1ZSk7Ly84IGJpdAoKICAgICAgICAvLyBibG9jay1oZWFkZXI6IFNUUkVBTUlORk8gdHlwZSwgYmxvY2sgbGVuZ3RoIC0+IGFscmVhZHkgc2V0CgogICAgICAgIC8vIGJsb2NrLWNvbnRlbnQ6IG1pbl9ibG9ja3NpemUsIG1pbl9ibG9ja3NpemUgLT4gYWxyZWFkeSBzZXQKCiAgICAgICAgLy8gd3JpdGUgbWluX2ZyYW1lc2l6ZSBhcyBsaXR0bGUgZW5kaWFuIHVpbnQyNDoKICAgICAgICB2aWV3LnNldFVpbnQ4KDggKyBvZmZzZXQsIG1ldGFkYXRhLm1pbl9mcmFtZXNpemUgPj4gMTYsIHRydWUpOyAvLzI0IGJpdAogICAgICAgIHZpZXcuc2V0VWludDgoOSArIG9mZnNldCwgbWV0YWRhdGEubWluX2ZyYW1lc2l6ZSA+PiA4LCB0cnVlKTsgLy8yNCBiaXQKICAgICAgICB2aWV3LnNldFVpbnQ4KDEwICsgb2Zmc2V0LCBtZXRhZGF0YS5taW5fZnJhbWVzaXplLCB0cnVlKTsgLy8yNCBiaXQKCiAgICAgICAgLy8gd3JpdGUgbWF4X2ZyYW1lc2l6ZSBhcyBsaXR0bGUgZW5kaWFuIHVpbnQyNDoKICAgICAgICB2aWV3LnNldFVpbnQ4KDExICsgb2Zmc2V0LCBtZXRhZGF0YS5tYXhfZnJhbWVzaXplID4+IDE2LCB0cnVlKTsgLy8yNCBiaXQKICAgICAgICB2aWV3LnNldFVpbnQ4KDEyICsgb2Zmc2V0LCBtZXRhZGF0YS5tYXhfZnJhbWVzaXplID4+IDgsIHRydWUpOyAvLzI0IGJpdAogICAgICAgIHZpZXcuc2V0VWludDgoMTMgKyBvZmZzZXQsIG1ldGFkYXRhLm1heF9mcmFtZXNpemUsIHRydWUpOyAvLzI0IGJpdAoKICAgICAgICAvLyBibG9jay1jb250ZW50OiBzYW1wbGVSYXRlLCBjaGFubmVscywgYml0c1BlclNhbXBsZSAtPiBhbHJlYWR5IHNldAoKICAgICAgICAvLyB3cml0ZSB0b3RhbF9zYW1wbGVzIGFzIGxpdHRsZSBlbmRpYW4gdWludDM2OgogICAgICAgIC8vVE9ETyBzZXQgbGFzdCA0IGJpdHMgdG8gaGFsZiBvZiB0aGUgdmFsdWUgaW4gaW5kZXggMTcKICAgICAgICB2aWV3LnNldFVpbnQ4KDE4ICsgb2Zmc2V0LCBtZXRhZGF0YS50b3RhbF9zYW1wbGVzID4+IDI0LCB0cnVlKTsgLy8zNiBiaXQKICAgICAgICB2aWV3LnNldFVpbnQ4KDE5ICsgb2Zmc2V0LCBtZXRhZGF0YS50b3RhbF9zYW1wbGVzID4+IDE2LCB0cnVlKTsgLy8zNiBiaXQKICAgICAgICB2aWV3LnNldFVpbnQ4KDIwICsgb2Zmc2V0LCBtZXRhZGF0YS50b3RhbF9zYW1wbGVzID4+IDgsIHRydWUpOyAvLzM2IGJpdAogICAgICAgIHZpZXcuc2V0VWludDgoMjEsIG1ldGFkYXRhLnRvdGFsX3NhbXBsZXMsIHRydWUpOyAvLzM2IGJpdAoKICAgICAgICB3cml0ZU1kNSh2aWV3LCAyMiArIG9mZnNldCwgbWV0YWRhdGEubWQ1c3VtKTsgLy8xNiAqIDggYml0CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIG1lcmdlQnVmZmVycyhjaGFubmVsQnVmZmVyLCByZWNvcmRpbmdMZW5ndGgpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gbmV3IFVpbnQ4QXJyYXkocmVjb3JkaW5nTGVuZ3RoKTsKICAgICAgICB2YXIgb2Zmc2V0ID0gMDsKICAgICAgICB2YXIgbG5nID0gY2hhbm5lbEJ1ZmZlci5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsbmc7IGkrKykgewogICAgICAgICAgdmFyIGJ1ZmZlciA9IGNoYW5uZWxCdWZmZXJbaV07CiAgICAgICAgICByZXN1bHQuc2V0KGJ1ZmZlciwgb2Zmc2V0KTsKICAgICAgICAgIG9mZnNldCArPSBidWZmZXIubGVuZ3RoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CgogICAgICBmdW5jdGlvbiB3cml0ZU1kNSh2aWV3LCBvZmZzZXQsIHN0cikgewogICAgICAgIHZhciBpbmRleDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGggLyAyOyArK2kpIHsKICAgICAgICAgIGluZGV4ID0gaSAqIDI7CiAgICAgICAgICB2aWV3LnNldFVpbnQ4KAogICAgICAgICAgICBpICsgb2Zmc2V0LAogICAgICAgICAgICBwYXJzZUludChzdHIuc3Vic3RyaW5nKGluZGV4LCBpbmRleCArIDIpLCAxNikKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgc3RhcnRfdmlkZW9fY2FsbCgpIHt9LAogICAgcmVmcmVzaF9jaGF0Ym90KHR5cGUpIHsKICAgICAgdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkID0gdHJ1ZTsKICAgICAgLy8gZGVidWdnZXI7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgY2hhdDogIiIsCiAgICAgICAgICBkYXRhOiAiIiwKICAgICAgICAgIHVzZXJfaWQ6ICIiLAogICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQKICAgICAgICB9KQogICAgICAgIC50aGVuKHJlc3AgPT4gewogICAgICAgICAgdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkID0gZmFsc2U7CiAgICAgICAgICBpZih0aGlzLmlmZmlyc3R0aW1lKXsKICAgICAgICAgICAgdGhpcy5pZmZpcnN0dGltZT1mYWxzZTsKICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLnR5cGluZy1pbmRpY2F0b3IiKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNsb3NlZF9mb3JtX3Jlc3BvbnNlX2FwaSgpLHsKICAgICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgIHVpZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgIGNoYXQ6IG51bGwsCiAgICAgICAgICAgICAgbm9kZV9zZWxlY3RlZDogbnVsbCwKICAgICAgICAgICAgICBib3RfbmFtZTogdGhpcy5ib3RfbmFtZSwKICAgICAgICAgICAgICBjb252ZXJzYXRpb25faWQgOiB0aGlzLmNvbnZlcnNhdGlvbl9pZCwKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2U9PnsKICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhyZXNwb25zZS5kYXRhLmVycm9yKTsKICAgICAgICAgICAgICBpZihyZXNwb25zZS5kYXRhLmVycm9yPT11bmRlZmluZWQpewogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2dheWEnKTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VkX2JvdF9jaGF0KHJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgICAgICAgdGhpcy5pc2Nsb3NlZGJvdG9uPXRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT0gInN1cHBvcnQiKSB7CiAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2ZWQ6ICJJcyB0aGVyZSBhbnl0aGluZyBlbHNlIEkgY2FuIGhlbHAgeW91IHdpdGg/IiwKICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgKICAgICAgICAgICAgdGhpcy5jb21wYW55aWQgPT0gIkN1c3RvbWVySGFwcGluZXNzOTUxODUiIHx8CiAgICAgICAgICAgIHRoaXMuY29tcGFueWlkID09ICIzeDVpdmU5OTUzNCIgfHwKICAgICAgICAgICAgdGhpcy5jb21wYW55aWQgPT0gIkZvcmVpZ254Y2hhbmdlMTc0OTEiIHx8CiAgICAgICAgICAgIHRoaXMuY29tcGFueWlkID09ICJjbGluaWNhbHRyaWFsczgxMzUyIgogICAgICAgICAgKSB7CiAgICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICAgICAgY2hhdDogIi93ZWxjb21lX21lc3NhZ2UiLAogICAgICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgICAgICB1c2VyX2lkOiAiIiwKICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICBkYXRhOiAiIiwKICAgICAgICAgICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogZmFsc2UKICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICAgICAgICAgIHRoaXMucHVzaF9tc2cocmVzcG9uc2UsIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5wcm9tcHRfdXJsKCksIHsKICAgICAgICAgICAgICB1aWQ6ICJjZW5zZSIsIC8vdGhpcy5maW5nZXJwcmludAogICAgICAgICAgICAgIGNvbXBhbnlpZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfaWQsCiAgICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgICBjaGF0OiAiIgogICAgICAgICAgICB9KQogICAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEgIT0gIk5PIENMT1NFRCBGT1JNIEJPVCIpIHsKICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5leHRyYXMgIT0gbnVsbCAmJgogICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmV4dHJhc1swXS5UeXBlID09ICJUQUJMRSIKICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZV9jaGF0KHJlc3BvbnNlLmRhdGEsICJpc3RhYmxlIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEucmV0dXJuID09ICJQUk9NUFRTIikgewogICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZV9jaGF0KHJlc3BvbnNlLmRhdGEsICJpc3Byb21wdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKICAgICAgICAgICAgLmNhdGNoKGUgPT4ge30pOwogICAgICAgIH0pOwogICAgfSwKICAgIGRvd25sb2FkX3BkZih1cmwsIGZpbGVfbmFtZSkgewogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB2YXIgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgICAgbGluay5ocmVmID0gdXJsOwogICAgICBsaW5rLnNldEF0dHJpYnV0ZSgiZG93bmxvYWQiLCBmaWxlX25hbWUpOwogICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmspOwogICAgICBsaW5rLmNsaWNrKCk7CiAgICB9LAogICAgc2Nyb2xsX2RpdigpIHsKICAgICAgdmFyIGRvYyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5idXktcHJvZHVjdHMiKTsKICAgICAgaWYgKGV2ZW50LmRlbHRhWCA+IGV2ZW50LmRlbHRhWSkgewogICAgICAgIGRvYy5zY3JvbGxMZWZ0ICs9IDEwOwogICAgICB9IGVsc2UgaWYgKGV2ZW50LmRlbHRhWCA8IGV2ZW50LmRlbHRhWSkgewogICAgICAgIGRvYy5zY3JvbGxMZWZ0IC09IDEwOwogICAgICB9CiAgICB9LAogICAgY2FsbF9zdXBwb3J0KHR5cGUpIHsKICAgICAgaWYgKHR5cGUgPT0gIlllcyIpIHsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgIGNoYXQ6ICIvY2FsbF9zdXBwb3J0IiwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkCiAgICAgICAgICB9KQogICAgICAgICAgLnRoZW4ocmVzcCA9PiB7CiAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2ZWQ6IHJlc3AuZGF0YS5yZXNwb25zZXNbMF0udGV4dCwKICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHR5cGUgPT0gIk5vIikgewogICAgICAgIHRoaXMuY2hhdC5wdXNoKHRoaXMuY2hhdFswXSk7CiAgICAgICAgdGhpcy5jaGF0LnB1c2godGhpcy5jaGF0WzFdKTsKICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgLy8gdGhpcy5yZWZyZXNoX2NoYXRib3QoInN1cHBvcnQiKTsKICAgICAgfQogICAgfSwKICAgIHBhcnNlKHN0cmluZykgewogICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoL3t7Lio/fX0vZywgbWF0Y2ggPT4gewogICAgICAgIHZhciB0b2RheSA9IG5ldyBEYXRlKCk7CiAgICAgICAgdmFyIGRkID0gdG9kYXkuZ2V0RGF0ZSgpOwoKICAgICAgICB2YXIgbW0gPSB0b2RheS5nZXRNb250aCgpICsgMTsKICAgICAgICB2YXIgeXl5eSA9IHRvZGF5LmdldEZ1bGxZZWFyKCk7CiAgICAgICAgaWYgKGRkIDwgMTApIHsKICAgICAgICAgIGRkID0gIjAiICsgZGQ7CiAgICAgICAgfQoKICAgICAgICBpZiAobW0gPCAxMCkgewogICAgICAgICAgbW0gPSAiMCIgKyBtbTsKICAgICAgICB9CiAgICAgICAgdG9kYXkgPSBkZCArICItIiArIG1tICsgIi0iICsgeXl5eTsKICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IG1hdGNoLnNsaWNlKDIsIC0yKTsKICAgICAgICB0aGlzLiRkYXRhW2V4cHJlc3Npb25dID0gdG9kYXk7CiAgICAgICAgcmV0dXJuIHRoaXMuJGRhdGFbZXhwcmVzc2lvbl07CiAgICAgIH0pOwogICAgfSwKICAgIGdlbmVyYXRlX3RpbWUoKSB7CiAgICAgIGxldCBkID0gbmV3IERhdGUoKTsKICAgICAgbGV0IGgsIG0sIHR5cGU7CiAgICAgIGlmIChkLmdldEhvdXJzKCkgPiAxMikgewogICAgICAgIGggPSBkLmdldEhvdXJzKCkgJSAxMjsKICAgICAgICB0eXBlID0gIiBwbSI7CiAgICAgIH0gZWxzZSBpZiAoZC5nZXRIb3VycygpIDwgMTIpIHsKICAgICAgICBoID0gZC5nZXRIb3VycygpOwogICAgICAgIHR5cGUgPSAiIGFtIjsKICAgICAgfSBlbHNlIGlmIChkLmdldEhvdXJzKCkgPT0gMTIpIHsKICAgICAgICBoID0gZC5nZXRIb3VycygpOwogICAgICAgIHR5cGUgPSAiIHBtIjsKICAgICAgfQogICAgICBtID0gZC5nZXRNaW51dGVzKCk7CiAgICAgIGlmIChtIDwgMTApIHsKICAgICAgICBtID0gMCArIFN0cmluZyhtKTsKICAgICAgfQogICAgICByZXR1cm4gaCArICI6IiArIG0gKyB0eXBlOwogICAgfSwKICAgIGNhbGxfYXBpKCkgewogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICBpZiAodGhpcy5waG9uZV9udW1iZXJfdmFsaWRpdHkudGVzdCh0aGlzLnBob25lX251bWJlcikpIHsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNhbGxfc3VwcG9ydF91cmwoKSwgewogICAgICAgICAgICBjb21wYW55aWQ6IHRoaXMuY29tcGFueWlkLAogICAgICAgICAgICBjb21wYW55bmFtZTogdGhpcy5jb21wYW55bmFtZSwKICAgICAgICAgICAgcGhvbmVudW1iZXI6IHRoaXMucGhvbmVfbnVtYmVyLAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwKICAgICAgICAgIH0pCiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLm1lc3NhZ2UgPT0gIkNhbGwgaW5jb21pbmchIikgewogICAgICAgICAgICAgIHRvYXN0ci5zdWNjZXNzKCJXZSB3aWxsIGdldCBpbiB0b3VjaCB3aXRoIHlvdSBzb29uLiBUaGFua3MiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdG9hc3RyLmVycm9yKCJQbGVhc2UgRW50ZXIgYSB2YWxpZCBwaG9uZSBudW1iZXIiKTsKICAgICAgfQogICAgfSwKICAgIHNob3dfcG9wdXAoKSB7CiAgICAgIHRoaXMuc2hvdyA9IGZhbHNlOwogICAgICB0aGlzLnN0b3AgPSBmYWxzZTsKICAgIH0sCiAgICBzdWJfbGVhZl9ub2RlX2NhbGwodHlwZSkgewogICAgICB2YXIgZGl2Y2xpY2sgPSBldmVudC50YXJnZXQuaW5uZXJUZXh0OwogICAgICBpZiAoZGl2Y2xpY2sgPT0gIldhdGNoIERlbW8gVmlkZW8iKSB7CiAgICAgICAgdGhpcy5kZW1vdXJsYmluZCA9IHRydWU7CiAgICAgICAgdGhpcy5yZXZpZXdzdXJsYmluZCA9IGZhbHNlOwogICAgICB9IGVsc2UgaWYgKGRpdmNsaWNrID09ICJVc2VyIFJldmlld3MvVGVzdGltb25pYWxzIikgewogICAgICAgIHRoaXMucmV2aWV3c3VybGJpbmQgPSB0cnVlOwogICAgICAgIHRoaXMuZGVtb3VybGJpbmQgPSBmYWxzZTsKICAgICAgfQogICAgICBpZiAoCiAgICAgICAgZGl2Y2xpY2sgPT0gIldhdGNoIERlbW8gVmlkZW8iIHx8CiAgICAgICAgZGl2Y2xpY2sgPT0gIlVzZXIgUmV2aWV3cy9UZXN0aW1vbmlhbHMiCiAgICAgICkgewogICAgICAgIHRoaXMuc2hvdyA9ICF0aGlzLnNob3c7CiAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCk7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgfSwgMTAwMCk7CiAgICAgIH0gZWxzZSBpZiAoZGl2Y2xpY2sgPT0gIkJ1eSBUdXRvcmlhbCIpIHsKICAgICAgICB0aGlzLmNlbnNlX2VucXVpcnkgPSB0cnVlOwogICAgICAgIGF4aW9zCiAgICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgY2hhdDogIi9wZXJzb25hbF9kZXRhaWxzIiwKICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6ICIiCiAgICAgICAgICB9KQogICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgICAgIHJlY2VpdmVkOiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1swXS50ZXh0LAogICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKQogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLnR5cGluZy1pbmRpY2F0b3IiKS5zdHlsZS5kaXNwbGF5ID0KICAgICAgICAgICAgICAgICJub25lIjsKICAgICAgICAgICAgfSwgMTAwMCk7CiAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICB0aWNrZXRfbnVtYmVyKCkgewogICAgICB2YXIgcmFuZG9tX251bSA9IE1hdGguZmxvb3IoMTAwMDAwMCArIE1hdGgucmFuZG9tKCkgKiA5MDAwMDAwKTsKICAgICAgdmFyIGNvbXBhbnkgPSB0aGlzLmNvbXBhbnluYW1lLnNsaWNlKDAsIDEpLnRvVXBwZXJDYXNlKCk7CiAgICAgIHJldHVybiBjb21wYW55ICsgIl8iICsgcmFuZG9tX251bTsKICAgIH0sCiAgICBzZW5kX21lc3NhZ2UodHlwZSwgbWVzc2FnZSwgdG9fYmVfZGlzcGxheWVkKSB7CiAgICAgIC8vaGFyc2gKICAgICAgLy8gZGVidWdnZXI7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGlmICh0aGlzLnNlbGVjdGVkX2luZGljYXRpb25bMF0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdHlwZSA9ICJpc19wcm9tcHQiOwogICAgICAgIHRvX2JlX2Rpc3BsYXllZCA9IHRoaXMudG9fc2VuZDsKICAgICAgICB0aGlzLnRvX3NlbmQgPQogICAgICAgICAgdGhpcy5zZWxlY3RlZF9pbmRpY2F0aW9uWzBdLnZhbHVlLnNwbGl0KCJ7IilbMF0gKwogICAgICAgICAgSlNPTi5zdHJpbmdpZnkodGhpcy5yZXMpOwogICAgICAgIHRoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbiA9IFtdOwogICAgICB9CiAgICAgIGlmKHRoaXMuaXNjbG9zZWRib3RvbiYmdHlwZSE9J2lzX2J1dHRvbicpewogICAgICAgIHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZD10cnVlOwogICAgICAgIHRoaXMuc3VibWl0X2Nsb3NlZF9mb3JtX2RhdGEoKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09ICJpc19idXR0b24iKSB7CiAgICAgICAgJCgiI3Jlc3BvbnNlX2JvdF90ZXh0IikucHJvcCgiZGlzYWJsZWQiLCBmYWxzZSk7CiAgICAgICAgaWYgKAogICAgICAgICAgbWVzc2FnZS52YWx1ZSA9PSAiaXNkaXNhYmxlZCIgJiYKICAgICAgICAgIHRoaXMuY29tcGFueWlkID09ICJjbGluaWNhbHRyaWFsczgxMzUyIiAmJgogICAgICAgICAgbWVzc2FnZS50aXRsZSA9PSAiTm8iCiAgICAgICAgKSB7CiAgICAgICAgfSBlbHNlIGlmKHRoaXMuaXNjbG9zZWRib3Rvbil7CiAgICAgICAgICB0aGlzLnN1Ym1pdF9jbG9zZWRfZm9ybV9kYXRhKHR5cGUsbWVzc2FnZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGxldCBpbmRleCA9IHRvX2JlX2Rpc3BsYXllZDsKICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICAgIHNlbnQ6IG1lc3NhZ2UudGl0bGUsCiAgICAgICAgICAgIHNlbmRpbmc6IHRydWUsCiAgICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgZGVsaXZlcmVkOiB0cnVlLAogICAgICAgICAgICBkcm9wZG93bjogIiIKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJzZW5kZXIiKTsKICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgICBjaGF0OiBtZXNzYWdlLnZhbHVlLAogICAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICAgIGlmICh0aGlzLmNoYXRbaW5kZXhdLnJlbW92YWJsZSA9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNoYXQuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0eXBlID09ICJpc19wcm9tcHQiKSB7CiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLnR5cGluZy1pbmRpY2F0b3IiKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICBzZW50OiB0b19iZV9kaXNwbGF5ZWQsCiAgICAgICAgICBzZW5kaW5nOiB0cnVlLAogICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIGRlbGl2ZXJlZDogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAic2VuZGVyIik7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgLy8gaG9zdDogdGhpcy51c2VyX2RhdGEuaG9zdCwKICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgY2hhdDogdGhpcy50b19zZW5kCiAgICAgICAgICB9KQogICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgICAgICAgICAgdGhpcy5leDEoKTsKICAgICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHRoaXMudG9fc2VuZCA9PSAiUmVzdGFydCIgfHwgdGhpcy50b19zZW5kID09ICJyZXN0YXJ0IikgewogICAgICAgIGF4aW9zCiAgICAgICAgICAucG9zdChhcGlfY2FsbHMucHJvbXB0X3VybCgpLCB7CiAgICAgICAgICAgIHVpZDogImNlbnNlIiwgLy90aGlzLmZpbmdlcnByaW50CiAgICAgICAgICAgIGNvbXBhbnlpZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfaWQsCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIGNoYXQ6ICIiCiAgICAgICAgICB9KQogICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICB0aGlzLmNoYXQucHVzaChyZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgICAgICAgdGhpcy5maXJzdF9jbGljayA9IHRydWU7CiAgICAgICAgICAgIHRoaXMubGV2ZWwgPSByZXNwb25zZS5kYXRhLmxldmVsOwogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaChlID0+IHt9KTsKICAgICAgfSBlbHNlIGlmICgKICAgICAgICB0aGlzLmNlbnNlX2VucXVpcnkgPT0gdHJ1ZSAmJgogICAgICAgIHRoaXMudG9fc2VuZCAhPSAiIiAmJgogICAgICAgIHRoaXMudG9fc2VuZCAhPSBudWxsICYmCiAgICAgICAgIS9eXHMqJC8udGVzdCh0aGlzLnRvX3NlbmQpCiAgICAgICkgewogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgdmFyIHNlbmRfbXNnID0gewogICAgICAgICAgc2VudDogdGhpcy50b19zZW5kLAogICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICBzZW5kaW5nOiB0cnVlLAogICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCkKICAgICAgICB9OwogICAgICAgIHRoaXMuY2hhdC5wdXNoKHNlbmRfbXNnKTsKICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIik7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICBjaGF0OiAiL3BlcnNvbmFsX2RldGFpbHMiLAogICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICB1c2VyX2lkOiAiIiwKICAgICAgICAgICAgQ29tcGFueWlkOiAiQ08wMDAyMyIsCiAgICAgICAgICAgIGRhdGE6ICIiLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogIiIsCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXkKICAgICAgICAgIH0pCiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgICAgcmVjZWl2ZWQ6IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLnRleHQsCiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICAgICAgICB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaChlID0+IHsKICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLnR5cGluZy1pbmRpY2F0b3IiKS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5saXZlX2NoYXRfb24pIHsKICAgICAgICBpZiAodGhpcy51c2VyX25hbWUgPT0gIiIpIHsKICAgICAgICAgIHRoaXMuY2hhbm5lbC5wdXNoKCJuZXdfbmFtZSIsIHsgbmFtZTogdGhpcy50b19zZW5kIH0pOwogICAgICAgICAgdGhpcy51c2VyX25hbWUgPSB0aGlzLnRvX3NlbmQ7CiAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuY2hhbm5lbC5wdXNoKCJuZXdfY2hhdF9tZXNzYWdlIiwgeyBtZXNzYWdlOiB0aGlzLnRvX3NlbmQgfSk7CiAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgfQogICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgIHNlbnQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgIHNlbmRpbmc6IHRydWUsCiAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJzZW5kZXIiKTsKICAgICAgfSBlbHNlIGlmICgKICAgICAgICB0aGlzLnRvX3NlbmQgIT0gIiIgJiYKICAgICAgICB0aGlzLnRvX3NlbmQgIT0gbnVsbCAmJgogICAgICAgIHRoaXMuY2Vuc2VfZW5xdWlyeSAhPSB0cnVlCiAgICAgICkgewogICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgc2VuZGluZzogdHJ1ZSwKICAgICAgICAgIHNlbnQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJzZW5kZXIiKTsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgIGNoYXQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkCiAgICAgICAgICB9KQogICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goZSA9PiB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICAgIH0pOwogICAgICB9CiAgICAgIHRoaXMudG9fc2VuZCA9ICIiOwogICAgICB0aGlzLmJ1dHRvbl9maWxsKCk7CiAgICB9LAogICAgaW5pdGlhdGVfc3VwcG9ydF9jaGF0KCkgewogICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgIHJlY2VpdmVkOiAiU29ycnkgSSBhbSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uIiwKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZQogICAgICB9KTsKICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICByZWNlaXZlZDogIldvdWxkIHlvdSBsaWtlIHRvIHRhbGsgd2l0aCBzdXBwb3J0IHRlYW0/IiwKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICBzaG93X2J1dHRvbnM6IHRydWUsCiAgICAgICAgc3VwcG9ydF9idXR0b25zOiB0cnVlLAogICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpCiAgICAgIH0pOwogICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICB9LAogICAgZGlzY29ubmVjdF9zdXBwb3J0X2NoYXQoKSB7CiAgICAgIHRoaXMuY2hhbm5lbC5wdXNoKCJzdG9wcGVkX2NoYXQiLCB7CiAgICAgICAgbmFtZTogdGhpcy51c2VyX25hbWUsCiAgICAgICAgbWVzc2FnZTogIiBoYXMgZW5kZWQgdGhlIGNvbnZlcnNhdGlvbi4iCiAgICAgIH0pOwogICAgICB0aGlzLmNoYW5uZWwubGVhdmUoKTsKICAgICAgdGhpcy5jaGF0X3NvY2tldC5kaXNjb25uZWN0KCk7CiAgICAgIHRoaXMubGl2ZV9jaGF0X29uID0gZmFsc2U7CiAgICB9LAogICAgY2hhdF9yZXNwb25zZV9lcnJvcigpIHsKICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICByZWNlaXZlZDogIlNvcnJ5IEknbSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uIiwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKQogICAgICB9KTsKICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgIH0sCiAgICBzZW5kX3JlcXVlc3RfanNvbihtZXNzYWdlKSB7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICAgIGNoYXQ6ICIiLAogICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgIGRhdGE6IHRoaXMuanNvbl9kYXRhW21lc3NhZ2UucmVzcG9uc2VzWzBdLmludGVudF0KICAgICAgICB9KQogICAgICAgIC50aGVuKHJlc3AgPT4gewogICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICByZWNlaXZlZDoKICAgICAgICAgICAgICByZXNwLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA9PSAwCiAgICAgICAgICAgICAgICA/ICJTb3JyeSBJJ20gbm90IGdldHRpbmcgeW91ciBxdWVzdGlvbiIKICAgICAgICAgICAgICAgIDogcmVzcC5kYXRhLnJlc3BvbnNlc1swXS50ZXh0LAogICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgaW1hZ2U6CiAgICAgICAgICAgICAgcmVzcC5kYXRhLnJlc3BvbnNlc1swXS5pbWcgPT0gIiIKICAgICAgICAgICAgICAgID8gbnVsbAogICAgICAgICAgICAgICAgOiByZXNwLmRhdGEucmVzcG9uc2VzWzBdLmltZwogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICB9KTsKICAgIH0sCiAgICByZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSwgdHlwZSkgewogICAgICB2YXIgaSA9IDA7CiAgICAgIHZhciBkZWxheSA9CiAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCAhPSB1bmRlZmluZWQgJiYKICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0Lmxlbmd0aCA+IDEwCiAgICAgICAgICA/IDIwMDAKICAgICAgICAgIDogNTAwOwogICAgICB2YXIgdm0gPSB0aGlzOwogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBoYW5kbGVfcmVzcG9uc2UoKTsKICAgICAgfSwgZGVsYXkpOwogICAgICBmdW5jdGlvbiBoYW5kbGVfcmVzcG9uc2UoKSB7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YSA9PSBudWxsIHx8IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZtLmNoYXRfcmVzcG9uc2VfZXJyb3IoKTsKICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnJlcXVlc3RfanNvbiAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ucmVxdWVzdF9qc29uID09IHRydWUKICAgICAgICAgICkgewogICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdm0uY2hhdC5wdXNoKHsKICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgICAgcmVjZWl2ZWQ6IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQsCiAgICAgICAgICAgICAgICB0aW1lOiB2bS5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICAgICAgICBpbWFnZTogcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW1nLAogICAgICAgICAgICAgICAgdmlkZW86IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnZpZGVvCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdm0uJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB2bS5jaGF0KTsKICAgICAgICAgICAgICB2bS51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQgPT0gImdvZ3liNDUwX2NyZWF0ZV90aWNrZXQiKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWU7CiAgICAgICAgICAgICAgaWYgKHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZmlyc3RfbmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBuYW1lID0KICAgICAgICAgICAgICAgICAgdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5maXJzdF9uYW1lICsKICAgICAgICAgICAgICAgICAgIiAiICsKICAgICAgICAgICAgICAgICAgdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5sYXN0X25hbWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh2bS4kc2Vzc2lvbi5oYXMoIlVzZXJGaXJzdE5hbWUiKSkgewogICAgICAgICAgICAgICAgbmFtZSA9CiAgICAgICAgICAgICAgICAgIHZtLiRzZXNzaW9uLmdldCgiVXNlckZpcnN0TmFtZSIpICsKICAgICAgICAgICAgICAgICAgIiAiICsKICAgICAgICAgICAgICAgICAgdm0uJHNlc3Npb24uZ2V0KCJVc2VyTGFzdE5hbWUiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSB7CiAgICAgICAgICAgICAgICB1c2VybmFtZTogbmFtZSwKICAgICAgICAgICAgICAgIGNvbXBhbnluYW1lOiB2bS5jb21wYW55bmFtZSwKICAgICAgICAgICAgICAgIGNvbXBhbnlpZDogdm0uY29tcGFueWlkLAogICAgICAgICAgICAgICAgdXNlcl9yb2xlOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICBlbWFpbDogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgdG9rZW46IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikudG9rZW5zLAogICAgICAgICAgICAgICAgdGlja2V0X2lzc3VlOiAiIiwKICAgICAgICAgICAgICAgIHRpY2tldF9udW1iZXI6IHZtLnRpY2tldF9udW1iZXIoKSwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiIiwKICAgICAgICAgICAgICAgIGZpbGVfY29udGVudDogbnVsbCwKICAgICAgICAgICAgICAgIGZpbGVfbmFtZTogbnVsbCwKICAgICAgICAgICAgICAgIGlzRWRpdDogZmFsc2UKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeShwYXlsb2FkKTsKICAgICAgICAgICAgICBheGlvcwogICAgICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICAgICAgICBsaWNlbnNlX2tleTogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgICAgICAgdG9rZW46IHZtLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgICAgICAgIHRva2VuOiB2bS5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICAgIHJvbGU6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdm0ucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICAgICAgICAgICAgY2hhdDogIiIsCiAgICAgICAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgICAgICAgIGRhdGE6IHBheWxvYWQKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAudGhlbihyZXNwID0+IHsKICAgICAgICAgICAgICAgICAgdm0uY2hhdC5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgcmVjZWl2ZWQ6CiAgICAgICAgICAgICAgICAgICAgICByZXNwLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA9PSAwCiAgICAgICAgICAgICAgICAgICAgICAgID8gIlNvcnJ5IEknbSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uIgogICAgICAgICAgICAgICAgICAgICAgICA6IHJlc3AuZGF0YS5yZXNwb25zZXNbaV0udGV4dCwKICAgICAgICAgICAgICAgICAgICB0aW1lOiB2bS5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICAgICAgICAgICAgaW1hZ2U6IHJlc3AuZGF0YS5yZXNwb25zZXNbaV0uaW1nLAogICAgICAgICAgICAgICAgICAgIHZpZGVvOgogICAgICAgICAgICAgICAgICAgICAgcmVzcC5kYXRhLnJlc3BvbnNlc1tpXS52aWRlbyAhPSBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgID8gcmVzcC5kYXRhLnJlc3BvbnNlc1tpXS52aWRlbwogICAgICAgICAgICAgICAgICAgICAgICA6IG51bGwKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZtLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdm0uY2hhdCk7CiAgICAgICAgICAgICAgICAgIHZtLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQgPT0gImNyZWF0ZV9hcHBvaW50bWVudCIKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgbGV0IHRvZGF5X2RhdGUgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgICAgICAucG9zdChhcGlfY2FsbHMuc2NoZWR1bGVfYXBwb2ludG1lbnRfdXJsKCksIHsKICAgICAgICAgICAgICAgICAgY29tcGFueW5hbWU6IHZtLmNvbXBhbnluYW1lLAogICAgICAgICAgICAgICAgICBjb21wYW55aWQ6IHZtLmNvbXBhbnlpZCwKICAgICAgICAgICAgICAgICAgRGF0ZToKICAgICAgICAgICAgICAgICAgICB0b2RheV9kYXRlLmdldEZ1bGxZZWFyKCkgKwogICAgICAgICAgICAgICAgICAgICItIiArCiAgICAgICAgICAgICAgICAgICAgKHRvZGF5X2RhdGUuZ2V0TW9udGgoKSA8IDkKICAgICAgICAgICAgICAgICAgICAgID8gIjAiICsgKHRvZGF5X2RhdGUuZ2V0TW9udGgoKSArIDEpCiAgICAgICAgICAgICAgICAgICAgICA6IHRvZGF5X2RhdGUuZ2V0TW9udGgoKSArIDEpICsKICAgICAgICAgICAgICAgICAgICAiLSIgKwogICAgICAgICAgICAgICAgICAgIHRvZGF5X2RhdGUuZ2V0RGF0ZSgpIC8vTW9udGggb2JqZWN0IGRvY3VtZW50IGl0CiAgICAgICAgICAgICAgICAgIC8vIERhdGU6IHN0YXJ0X3RpbWUsCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICAgICAgICAvLyB0aGlzLnRpbWVfc2xvdHMgPSB0aGlzLmZ1bGxfdGltZV9zbG90czsKICAgICAgICAgICAgICAgICAgLy8gaWYgKHJlc3BvbnNlLmRhdGEuU2xvdCAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgLy8gICBpZiAocmVzcG9uc2UuZGF0YS5TbG90Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgLy8gICAgIGxldCBpbmRleDsKICAgICAgICAgICAgICAgICAgLy8gICAgIGZvciAodmFyIGkgaW4gcmVzcG9uc2UuZGF0YS5TbG90KSB7CiAgICAgICAgICAgICAgICAgIC8vICAgICAgIGluZGV4ID0gdGhpcy50aW1lX3Nsb3RzLmluZGV4T2YocmVzcG9uc2UuZGF0YS5TbG90W2ldKTsKICAgICAgICAgICAgICAgICAgLy8gICAgICAgaWYgKGluZGV4ICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgdGhpcy50aW1lX3Nsb3RzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgICAgICAgIC8vICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gICAgIH0KICAgICAgICAgICAgICAgICAgLy8gICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAvLyAgIH0KICAgICAgICAgICAgICAgICAgLy8gfQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5jYXRjaChlID0+IHsKICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2bS5zZW5kX3JlcXVlc3RfanNvbihyZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ucmV0dXJuX2ludGVudCAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ucmV0dXJuX2ludGVudCA9PSB0cnVlCiAgICAgICAgICApIHsKICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICAgICAgICBsaWNlbnNlX2tleTogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgICAgIHRva2VuOiB2bS5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICB1c2VybmFtZTogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgIHRva2VuOiB2bS5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICByb2xlOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiB2bS5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgICAgICAgY2hhdDogIi8iICsgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW50ZW50LAogICAgICAgICAgICAgICAgc291cmNlOiAiV2ViIgogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICAgICAgdm0uaGFuZGxlX3Jlc3BvbnNlKHJlc3BvbnNlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgIHZtLmNvbXBhbnlpZCA9PSAiM3g1aXZlOTk1MzQiICYmCiAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmludGVudCAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW50ZW50ID09ICJjb25mdXNpb24iCiAgICAgICAgICApIHsKICAgICAgICAgICAgdm0uY29uZnVzaW9uX21lc3NhZ2UoIi9uZWVkX2hlbHAiKTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uYnV0dG9ucyAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdm0ubG9hZF9idXR0b25zKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLCBpKTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY3VzdG9tICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAvL0NIYW5nZSAgdGhlIGNvbmRpdGlvbiBoZXJlCiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20udHlwZSAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20udHlwZSA9PSAibXVsdGlzZWxlY3RfZHJvcGRvd24iCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHZtLm11bHRpc2VsZWN0X2xvYWQocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0sIGkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmN1c3RvbS50eXBlICE9IHVuZGVmaW5lZCAmJgogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmN1c3RvbS50eXBlID09ICJ0YWJsZSIKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdm0ubG9hZF90YWJsZShyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXSwgaSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vdGhpcyBvbmUgZm9yIGZvcmVpZ254Y2hhbmdlCiAgICAgICAgICBlbHNlIGlmICgKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQudG9Mb3dlckNhc2UoKSA9PQogICAgICAgICAgICAgICJzb3JyeSBpIGFtIG5vdCBnZXR0aW5nIHlvdXIgcXVlc3Rpb24iIHx8CiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dC50b0xvd2VyQ2FzZSgpID09CiAgICAgICAgICAgICAgICAiaXMgdGhlcmUgYW55dGhpbmcgaSBjYW4gaGVscCB5b3Ugd2l0aD8iKQogICAgICAgICAgKSB7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5ID09CiAgICAgICAgICAgICAgICAiLmVKeFRjc3N2U3MxTXo2dEl6a2pNUzA4MU5EZXhOSVFLS1VERk1rcEtDb3F0OVBYTHk4djEwbEJVNnlYbjUtb2xsdW9iR1JoYTZocVk2eHFZS0JnYVdCa1pXNW1hNmhtYm01Z1ltU29CQUdhOUhwMC5YUjNUdXcuWDc3Rl83TER0T0xwMlZ0OXNuRkRTbzMxblR3IiB8fAogICAgICAgICAgICAgIHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXkgPT0KICAgICAgICAgICAgICAgICIuZUp4VGNpNHRMc25QVFMzeVNDd295TXhMTFM2Mk5EVzBNSVdKS3NDRk0wcEtDb3F0OVBYTHk4djFrak9LRV9VU1VfV05EQXd0ZFEzTWRRMk5GQXdOcllESXhGelB4TVRTMHRKSUNRQmpaeHV4LlhTaHE4dy5QZ281Y21Ld01RRm5ZVXNzY3BvandFcURYUXciCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHZtLmluaXRpYXRlX3N1cHBvcnRfY2hhdCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZtLmNoYXQucHVzaCh7CiAgICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgICByZWNlaXZlZDogIlNvcnJ5IEkgYW0gbm90IGdldHRpbmcgeW91ciBxdWVzdGlvbiIsCiAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICAgIHRpbWU6IHZtLmdlbmVyYXRlX3RpbWUoKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZtLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgdGltZToKICAgICAgICAgICAgICAgIGkgPT0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXMubGVuZ3RoIC0gMQogICAgICAgICAgICAgICAgICA/IHZtLmdlbmVyYXRlX3RpbWUoKQogICAgICAgICAgICAgICAgICA6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgICAgbXNnLnJlY2VpdmVkID0gIlNvcnJ5IHdlIGFyZSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uLiI7CiAgICAgICAgICAgICAgbXNnLnJlY2VpdmluZyA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0LmluY2x1ZGVzKCIucGRmIikKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdm0uZGlzcGxheV9wZGZfY2hhdChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0ICE9IHVuZGVmaW5lZCAmJgogICAgICAgICAgICAgICFyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0LmluY2x1ZGVzKAogICAgICAgICAgICAgICAgIkRvd25sb2FkIHlvdXIgbWFuaWZlc3QgaGVyZSIKICAgICAgICAgICAgICApCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIG1zZy5yZWNlaXZlZCA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQ7CiAgICAgICAgICAgICAgbXNnLnJlY2VpdmluZyA9IHRydWU7CiAgICAgICAgICAgICAgbXNnLmltYWdlID0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW1nOwogICAgICAgICAgICAgIG1zZy52aWRlb3MgPQogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udmlkZW8gPT0gbnVsbAogICAgICAgICAgICAgICAgICA/IFtdCiAgICAgICAgICAgICAgICAgIDogcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udmlkZW87CiAgICAgICAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICAgICAgaWYgKGkgPT0gMCkgewogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgIHZtLnRvX3Njcm9sbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikKICAgICAgICAgICAgICAgICAgICAgIC5jaGlsZHJlbigpCiAgICAgICAgICAgICAgICAgICAgICAubGFzdCgpCiAgICAgICAgICAgICAgICAgICAgICAuaGVpZ2h0KCkgLwogICAgICAgICAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIDwKICAgICAgICAgICAgICAgICAgICAwLjUKICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmFuaW1hdGUoCiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbFRvcDogJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbEhlaWdodCIpCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgMTUwMAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgICAgJCgiLnJlY2VpdmVyIikKICAgICAgICAgICAgICAgICAgICAgIC5sYXN0KCkKICAgICAgICAgICAgICAgICAgICAgIC5wYXJlbnQoKQogICAgICAgICAgICAgICAgICAgICAgLmhlaWdodCgpIC8KICAgICAgICAgICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA+CiAgICAgICAgICAgICAgICAgICAgICAwLjUgJiYKICAgICAgICAgICAgICAgICAgICAkKCIucmVjZWl2ZXIiKQogICAgICAgICAgICAgICAgICAgICAgLmxhc3QoKQogICAgICAgICAgICAgICAgICAgICAgLnBhcmVudCgpCiAgICAgICAgICAgICAgICAgICAgICAuaGVpZ2h0KCkgLwogICAgICAgICAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIDwKICAgICAgICAgICAgICAgICAgICAgIDAuNgogICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuYW5pbWF0ZSgKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9wOiAwLjkgKiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAxNTAwCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuYW5pbWF0ZSgKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9wOiAwLjc1ICogJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbEhlaWdodCIpCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgMTUwMAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEwMDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgLQogICAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikgIT0KICAgICAgICAgICAgICAgIDAKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHZtLnRvX3Njcm9sbCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmludGVudCA9PSAiY2hhdF9zdXBwb3J0IikgewogICAgICAgICAgICAgIG1zZy5yZWNlaXZpbmcgPSB0cnVlOwogICAgICAgICAgICAgIG1zZy5yZWNlaXZlZCA9CiAgICAgICAgICAgICAgICAiSSBhbSBjb25uZWN0aW5nIHlvdSB0byBvbmUgb2Ygb3VyIHN1cHBvcnQgYWdlbnRzLiBQbGVhc2Ugd2FpdCBmb3IgYSB3aGlsZS4iOwogICAgICAgICAgICAgIHZtLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICAgICAgdm0uY2hhdC5wdXNoKHsKICAgICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgIHJlY2VpdmVkOiAiV2hhdCdzIHlvdXIgbmFtZT8iLAogICAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgICB0aW1lOiB2bS5nZW5lcmF0ZV90aW1lKCkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2bS51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgICAgIGF4aW9zLmdldChhcGlfY2FsbHMuY2hhdF9ncm91cF9hcGkoKSkudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgICAgICB2bS5jaGF0X2dyb3VwX25hbWUgPSByZXNwb25zZS5kYXRhLmNoYXRfZ3JvdXBfbmFtZTsKICAgICAgICAgICAgICAgIHZtLmxpdmVfY2hhdF90b2tlbiA9IHJlc3BvbnNlLmRhdGEudG9rZW47CiAgICAgICAgICAgICAgICB2bS5saXZlX2NoYXRfb24gPSB0cnVlOwogICAgICAgICAgICAgICAgdm0uY2hhdF9zb2NrZXQgPSBuZXcgU29ja2V0KHByb2Nlc3MuZW52LlZVRV9BUFBfTElWRV9DSEFUX1dFQlNPQ0tFVF9FTkRQT0lOVCwgewogICAgICAgICAgICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgICAgICAgICBjb21wYW55OiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZSwKICAgICAgICAgICAgICAgICAgICBjaGF0X2dyb3VwX25hbWU6IHZtLmNoYXRfZ3JvdXBfbmFtZSwKICAgICAgICAgICAgICAgICAgICB0b2tlbjogdm0ubGl2ZV9jaGF0X3Rva2VuCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdm0uY2hhdF9zb2NrZXQuY29ubmVjdCgpOwogICAgICAgICAgICAgICAgdm0uY2hhbm5lbCA9IHZtLmNoYXRfc29ja2V0LmNoYW5uZWwoCiAgICAgICAgICAgICAgICAgICJjdXN0b21lcnNfZ3JvdXBzOiIgKyB2bS5jaGF0X2dyb3VwX25hbWUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB2bS5jaGFubmVsLmpvaW4oKTsKICAgICAgICAgICAgICAgIHZtLmNoYW5uZWwucHVzaCgiY3VzdG9tZXJfbmVlZHNfc3VwcG9ydF9hZ2VudCIpOwogICAgICAgICAgICAgICAgdm0uY2hhbm5lbC5vbigibmV3X2NoYXRfbWVzc2FnZSIsIHJlcyA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChyZXMuc2VuZGVyICE9ICJjdXN0b21lciIpIHsKICAgICAgICAgICAgICAgICAgICB2bS5jaGF0LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgcmVjZWl2ZWQ6IHJlcy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgICAgdGltZTogdm0uZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2bS51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2bS5jaGFubmVsLm9uKCJzdG9wcGVkX2NoYXQiLCByZXMgPT4gewogICAgICAgICAgICAgICAgICB2bS5jaGF0LnB1c2goewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICByZWNlaXZlZDogIlN1cHBvcnQgYWdlbnQgIiArIHJlcy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB2bS5saXZlX2NoYXRfb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgdm0udXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdm0uY2hhbm5lbC5vbigic3RhcnRlZF90eXBpbmciLCByZXMgPT4gewogICAgICAgICAgICAgICAgICB2bS5pc190eXBpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPQogICAgICAgICAgICAgICAgICAgICJibG9jayI7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHZtLmNoYW5uZWwub24oInN0b3BwZWRfdHlwaW5nIiwgcmVzID0+IHsKICAgICAgICAgICAgICAgICAgdm0uaXNfdHlwaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9CiAgICAgICAgICAgICAgICAgICAgIm5vbmUiOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dC5pbmNsdWRlcygKICAgICAgICAgICAgICAgICJEb3dubG9hZCB5b3VyIG1hbmlmZXN0IGhlcmUiCiAgICAgICAgICAgICAgKSB8fAogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dC5pbmNsdWRlcygvLnBkZi8pKQogICAgICAgICAgICApIHsKICAgICAgICAgICAgICB2bS5kaXNwbGF5X3BkZl9jaGF0KHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5wcm9kdWN0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdm0uZGlzcGxheV9wcm9kdWN0c19jaGF0KHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGkgPCByZXNwb25zZS5kYXRhLnJlc3BvbnNlcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgIGkgKz0gMTsKICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLnR5cGluZy1pbmRpY2F0b3IiKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICAgICAgZGVsYXkgPQogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQgIT0gdW5kZWZpbmVkICYmCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dC5sZW5ndGggPiAxMAogICAgICAgICAgICAgICAgPyAyMDAwCiAgICAgICAgICAgICAgICA6IDUwMDsKICAgICAgICAgICAgaGFuZGxlX3Jlc3BvbnNlKCk7CiAgICAgICAgICB9CiAgICAgICAgfSwgZGVsYXkpOwogICAgICB9CiAgICB9LAogICAgcHVzaF9tc2cocmVzcG9uc2VzLCByZXNwb25zZSkgewogICAgICB2YXIgaW5kZXggPSAwOwogICAgICB2YXIgdm0gPSB0aGlzOwogICAgICB2YXIgZGVsYXkgPSByZXNwb25zZVtpbmRleF0udGV4dC5sZW5ndGggPiAxMCA/IDIwMDAgOiA1MDA7CiAgICAgIHB1c2hfY2hhdChyZXNwb25zZVtpbmRleF0sIGRlbGF5KTsKICAgICAgdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkID0gdHJ1ZTsKICAgICAgZnVuY3Rpb24gcHVzaF9jaGF0KG1zZywgdGltZV9kZWxheSkgewogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgogICAgICAgICAgaWYgKHJlc3BvbnNlcy5kYXRhLnJlc3BvbnNlc1tpbmRleF0uYnV0dG9ucyAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdm0ubG9hZF9idXR0b25zKAogICAgICAgICAgICAgIHJlc3BvbnNlcy5kYXRhLnJlc3BvbnNlc1tpbmRleF0sCiAgICAgICAgICAgICAgImlzX2J1dHRvbiIsCiAgICAgICAgICAgICAgIndlbGNvbWVfbWVzc2FnZSIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZtLmNoYXQucHVzaCh7CiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgIHJlY2VpdmVkOiBtc2cudGV4dCwKICAgICAgICAgICAgICB0aW1lOgogICAgICAgICAgICAgICAgaW5kZXggPT0gcmVzcG9uc2UubGVuZ3RoIC0gMSA/IHZtLmdlbmVyYXRlX3RpbWUoKSA6IHVuZGVmaW5lZAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICAkKCIudGltZSIpCiAgICAgICAgICAgIC5sYXN0KCkKICAgICAgICAgICAgLmNzcygiZGlzcGxheSIsICJub25lIik7CiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgJCgiLnRpbWUiKQogICAgICAgICAgICAgIC5sYXN0KCkKICAgICAgICAgICAgICAuY3NzKCJkaXNwbGF5IiwgImJsb2NrIik7CgogICAgICAgICAgICBpZiAoaW5kZXggPCByZXNwb25zZS5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgaW5kZXggKz0gMTsKICAgICAgICAgICAgICBkZWxheSA9IHJlc3BvbnNlW2luZGV4XS50ZXh0Lmxlbmd0aCA+IDEwID8gMjAwMCA6IDUwMDsKICAgICAgICAgICAgICBwdXNoX2NoYXQocmVzcG9uc2VbaW5kZXhdLCBkZWxheSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJzEnKTsKICAgICAgICAgICAgICB2bS5yZWZyZXNoZWRfb3JfY2xvc2VkID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIDUwMCk7CiAgICAgICAgfSwgdGltZV9kZWxheSk7CiAgICAgIH0KICAgIH0sCiAgICBjb25mdXNpb25fbWVzc2FnZShtc2dfc3RyaW5nKSB7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgY2hhdDogbXNnX3N0cmluZywKICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgdXNlcl9pZDogIiIsCiAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgZGF0YTogIiIsCiAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IGZhbHNlCiAgICAgICAgfSkKICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgICAgICB9KTsKICAgIH0sCiAgICBmaXhfYXBwb2ludG1lbnQoKSB7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICB9LAogICAgZGlzcGxheV9wcm9kdWN0c19jaGF0KG1lc3NhZ2UpIHsKICAgICAgdmFyIG1zZyA9IHsKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKQogICAgICB9OwogICAgICBtc2cuaXNwcm9kdWN0ID0gdHJ1ZTsKICAgICAgbXNnLmVsZW1lbnRzID0gbWVzc2FnZTsKICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgIH0sCiAgICBkaXNwbGF5X3BkZl9jaGF0KG1lc3NhZ2UpIHsKICAgICAgdmFyIG1zZyA9IHsKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKQogICAgICB9OwogICAgICBpZiAobWVzc2FnZS5pbmNsdWRlcygiRG93bmxvYWQgeW91ciBtYW5pZmVzdCBoZXJlICIpKSB7CiAgICAgICAgdmFyIHRlbXAgPSBtZXNzYWdlLnNwbGl0KCJEb3dubG9hZCB5b3VyIG1hbmlmZXN0IGhlcmUgIik7CiAgICAgICAgbXNnLnVybCA9IHRlbXBbMV07CiAgICAgICAgbXNnLnJlY2VpdmluZyA9IGZhbHNlOwogICAgICAgIG1zZy5maWxlX25hbWUgPSBtZXNzYWdlLnNwbGl0KC9eLipbXFxcL10vKVsxXTsKICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgdXJsID0gbWVzc2FnZS5tYXRjaCgKICAgICAgICAgIC8oKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbXC07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOVwuXC1dK3woPzp3d3dcLnxbXC07OiY9XCtcJCxcd10rQClbQS1aYS16MC05XC5cLV0rKSgoPzpcL1tcK34lXC9cLlx3XC1fXSopP1w/Pyg/OltcLVwrPSY7JUBcLlx3X10qKSM/KD86W1wuXCFcL1xcXHddKikpPykvZwogICAgICAgIClbMF07CiAgICAgICAgbXNnLnVybCA9IHVybDsKICAgICAgICBtc2cucmVjZWl2aW5nID0gZmFsc2U7CiAgICAgICAgbXNnLmZpbGVfbmFtZSA9IHVybC5zcGxpdCgvXi4qW1xcXC9dLylbMV07CiAgICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgIH0KICAgIH0sCiAgICBnZW5lcmF0ZV9wYXltZW50KHByaWNlLCBuYW1lKSB7CiAgICAgIHZhciB2bSA9IHRoaXM7CiAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgIGtleTogInJ6cF90ZXN0X1NuRFRhUG5uY2ZsaUR0IiwKICAgICAgICBhbW91bnQ6IHByaWNlICogMTAwLAogICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkLAogICAgICAgIGNvbXBhbnlfbmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZSwKICAgICAgICBuYW1lOiAiQ2Vuc2UgQUkiLAogICAgICAgIGN1cnJlbmN5OiAiSU5SIiwKICAgICAgICBkZXNjcmlwdGlvbjogIkluc3RpbGwgSW50ZWxsaWdlbmNlIiwKICAgICAgICBpbWFnZTogIi9pbWcvY2Vuc2VfaW1hZ2UucG5nIiwgLy8gQ09NUEFOWSBMT0dPCiAgICAgICAgaGFuZGxlcjogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgIHZhciBjb250YWN0ID0gJCgnI2NvbnRhY3RbdHlwZT0idGVsIl0nKS52YWx1ZTsKICAgICAgICAgIHZhciBlbWFpbCA9ICQoJyNlbWFpbFt0eXBlPSJlbWFpbCJdJykudmFsdWU7CiAgICAgICAgICB2bS5wYXltZW50aWQgPSByZXNwb25zZS5yYXpvcnBheV9wYXltZW50X2lkOwoKICAgICAgICAgIGlmICh0cmFuc2Zlcl9hY2NvdW50ICE9IG51bGwpIHsKICAgICAgICAgICAgdm0udHJhbnNmZXJfcGF5bWVudCh0cmFuc2Zlcl9hY2NvdW50LCBwcmljZSAqIDEwMCwgIklOUiIsIG5hbWUpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcHJlZmlsbDogewogICAgICAgICAgbmFtZTogIiIsIC8vIHBhc3MgY3VzdG9tZXIgbmFtZQogICAgICAgICAgZW1haWw6ICIiLCAvLyBjdXN0b21lciBlbWFpbAogICAgICAgICAgY29udGFjdDogIiIgLy9jdXN0b21lciBwaG9uZSBuby4KICAgICAgICB9LAogICAgICAgIG5vdGVzOiB7CiAgICAgICAgICBhZGRyZXNzOiAiYWRkcmVzcyIgLy9jdXN0b21lciBhZGRyZXNzCiAgICAgICAgfSwKICAgICAgICB0aGVtZTogewogICAgICAgICAgY29sb3I6ICIjMjgzNzc3IiAvLyBzY3JlZW4gY29sb3IKICAgICAgICB9CiAgICAgIH07CiAgICAgIHZhciByenAxID0gbmV3IFJhem9ycGF5KG9wdGlvbnMpOwogICAgICByenAxLm9wZW4oKTsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgIH0sCiAgICB0cmFuc2Zlcl9wYXltZW50KGFjY291bnQsIGFtb3VudCwgY3VycmVuY3ksIG5hbWUpIHsKICAgICAgYXhpb3MKICAgICAgICAucG9zdCgiaHR0cHM6Ly9hcGkucmF6b3JwYXkuY29tLzEvdHJhbnNmZXJzIiwgewogICAgICAgICAgYXV0aDogewogICAgICAgICAgICByenBfdGVzdF9TbkRUYVBubmNmbGlEdDogImxseEVLYmdBQkg4THg0WEFwZXg5Y0d6aiIKICAgICAgICAgIH0sCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIGFjY291bnQ6IGFjY291bnQsCiAgICAgICAgICAgIGFtb3VudDogYW1vdW50LAogICAgICAgICAgICBjdXJyZW5jeTogY3VycmVuY3kKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICAgIC8vIGlmKHRoaXMudXNlcl9kYXRhLmFwaV9rZXkhPScnKSB7CiAgICAgICAgICB0aGlzLnNob3BpZnlfb3JkZXJfY3JlYXRlKG5hbWUpOwogICAgICAgICAgLy8gfQogICAgICAgIH0pOwogICAgfSwKICAgIHNob3BpZnlfb3JkZXJfY3JlYXRlKG5hbWUpIHt9LAogICAgY2xpY2tfcHJvbXB0KHR5cGUpIHsKICAgICAgdGhpcy5saXZlX2NoYXRfb24gPSBmYWxzZTsKICAgICAgdmFyIGRpdmNsaWNrcG9wdXAgPSBldmVudC50YXJnZXQuaW5uZXJUZXh0OwogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgIH0sIDUwMCk7CiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgIGlmICh0eXBlICE9ICJjb2xsYXBzaWJsZSIpIHsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLnByb21wdF91cmwoKSwgewogICAgICAgICAgICB1aWQ6ICJjZW5zZSIsCiAgICAgICAgICAgIGNvbXBhbnlpZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfaWQsCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIGNoYXQ6IGV2ZW50LnRhcmdldC5pbm5lclRleHQsCiAgICAgICAgICAgIGxldmVsOiBldmVudC50YXJnZXQuYXR0cmlidXRlcy52YWx1ZS5ub2RlVmFsdWUKICAgICAgICAgIH0pCiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLmNvbGxhcHNpYmxlID09IHRydWUpIHsKICAgICAgICAgICAgICB0aGlzLmNyZWF0ZV9jaGF0KHJlc3BvbnNlLmRhdGEsICJpc3Byb21wdCIpOwogICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9CiAgICAgICAgICAgICAgICAibm9uZSI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5leHRyYXMgIT0gdW5kZWZpbmVkICYmCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5leHRyYXNbMF0uVHlwZSA9PSAiVEFCTEUiCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHRoaXMuY3JlYXRlX2NoYXQocmVzcG9uc2UuZGF0YSwgImlzdGFibGUiKTsKICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPQogICAgICAgICAgICAgICAgIm5vbmUiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhICE9ICJPb3BzISBTb21ldGhpbmcgd2VudCB3cm9uZyEiKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZV9jaGF0KHJlc3BvbnNlLmRhdGEsICJpc3Byb21wdCIpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLnR5cGluZy1pbmRpY2F0b3IiKS5zdHlsZS5kaXNwbGF5ID0KICAgICAgICAgICAgICAgICAgIm5vbmUiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YSA9PSAiT29wcyEgU29tZXRoaW5nIHdlbnQgd3JvbmchIikgewogICAgICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2gocmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLnR5cGluZy1pbmRpY2F0b3IiKS5zdHlsZS5kaXNwbGF5ID0KICAgICAgICAgICAgICAgICAgIm5vbmUiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PSAiY29sbGFwc2libGUiKSB7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5wcm9tcHRfdXJsKCksIHsKICAgICAgICAgICAgdWlkOiAiY2Vuc2UiLAogICAgICAgICAgICBjb21wYW55aWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkLAogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICBjaGF0OiAiIgogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2gocmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIGJ1dHRvbl9maWxsKCkgewogICAgICBpZiAodGhpcy5pc2V4Y2hhbmdlKSB7CiAgICAgICAgaWYgKHRoaXMudG9fc2VuZCA9PSAiIikgewogICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI3NlbmRfYnV0dG9uIikuc3R5bGUuZmlsbCA9ICIjOGE4YThhNjMiOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy50b19zZW5kICE9ICIiKSB7CiAgICAgICAgICBpZiAodGhpcy5saXZlX2NoYXRfb24pIHsKICAgICAgICAgICAgdGhpcy5jaGFubmVsLnB1c2goInN0YXJ0ZWRfdHlwaW5nIik7CiAgICAgICAgICAgIHRoaXMuc3RvcF90eXBpbmcodGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjc2VuZF9idXR0b24iKS5zdHlsZS5maWxsID0gIiNmZGNmMzgiOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICghdGhpcy5pc2V4Y2hhbmdlKSB7CiAgICAgICAgaWYgKHRoaXMudG9fc2VuZCA9PSAiIikgewogICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI3NlbmRfYnV0dG9uIikuc3R5bGUuZmlsbCA9ICIjOGE4YThhNjMiOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy50b19zZW5kICE9ICIiKSB7CiAgICAgICAgICBpZiAodGhpcy5saXZlX2NoYXRfb24pIHsKICAgICAgICAgICAgdGhpcy5jaGFubmVsLnB1c2goInN0YXJ0ZWRfdHlwaW5nIik7CiAgICAgICAgICAgIHRoaXMuc3RvcF90eXBpbmcodGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjc2VuZF9idXR0b24iKS5zdHlsZS5maWxsID0gIiMyNzM2NzkiOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHN0b3BfdHlwaW5nOiBkZWJvdW5jZSh2bSA9PiB7CiAgICAgIHZtLmNoYW5uZWwucHVzaCgic3RvcHBlZF90eXBpbmciKTsKICAgIH0sIDUwMDApLAogICAgc2Nyb2xsX2Rvd24oKSB7CiAgICAgIGlmICgKICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuY2hhdC1ib2R5Iikuc2Nyb2xsSGVpZ2h0IC0KICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5jaGF0LWJvZHkiKS5zY3JvbGxUb3AgLQogICAgICAgICAgJCgiLmNoYXQtaGlzIikKICAgICAgICAgICAgLmxhc3QoKQogICAgICAgICAgICAuaGVpZ2h0KCkgPD0KICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuY2hhdC1ib2R5IikuY2xpZW50SGVpZ2h0CiAgICAgICkgewogICAgICAgIHRoaXMudG9fc2Nyb2xsID0gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy50b19zY3JvbGwgPSB0cnVlOwogICAgICB9CiAgICB9LAogICAgbG9hZF9idXR0b25zKG1lc3NhZ2UsIGluZGV4LCB0eXBlKSB7CiAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgYnV0dG9uc19saXN0OiBbXSwKICAgICAgICBidXR0b25fcHJlZml4OiBtZXNzYWdlLnByZWZpeCwKICAgICAgICBjdXN0b21fYnV0dG9uczogdHJ1ZSwKICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgcmVjZWl2ZWQ6IG1lc3NhZ2UudGV4dCwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICByZW1vdmFibGU6IHR5cGUgPT0gIndlbGNvbWVfbWVzc2FnZSIgPyBmYWxzZSA6IHRydWUKICAgICAgfTsKICAgICAgaWYgKG1lc3NhZ2UuYnV0dG9ucy5sZW5ndGggPT0gMykgewogICAgICAgIGlmICgKICAgICAgICAgIG1lc3NhZ2UuYnV0dG9uc1swXS50aXRsZSA9PSAiRXhjaGFuZ2UgUmF0ZSIgJiYKICAgICAgICAgIG1lc3NhZ2UuYnV0dG9uc1sxXS50aXRsZSA9PSAiVHJhY2sgTXkgUGFyY2VsIiAmJgogICAgICAgICAgbWVzc2FnZS5idXR0b25zWzJdLnRpdGxlID09ICJDYWxsIEhlbHBkZXNrIgogICAgICAgICkgewogICAgICAgICAgbXNnLnJlbW92YWJsZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoCiAgICAgICAgbWVzc2FnZS50ZXh0ID09ICJXb3VsZCB5b3UgbGlrZSB0byBzaGFyZSB5b3VyIG5hbWUgYW5kIG51bWJlcj8iICYmCiAgICAgICAgdGhpcy5pc2V4Y2hhbmdlCiAgICAgICkgewogICAgICAgICQoIiNyZXNwb25zZV9ib3RfdGV4dCIpLnByb3AoImRpc2FibGVkIiwgdHJ1ZSk7CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSBpbiBtZXNzYWdlLmJ1dHRvbnMpIHsKICAgICAgICBpZiAobXNnLmJ1dHRvbl9wcmVmaXggIT0gbnVsbCkgewogICAgICAgICAgbXNnLmJ1dHRvbnNfbGlzdC5wdXNoKHsKICAgICAgICAgICAgdGl0bGU6IG1lc3NhZ2UuYnV0dG9uc1tpXS50aXRsZSwKICAgICAgICAgICAgdmFsdWU6IG1zZy5idXR0b25fcHJlZml4ICsgbWVzc2FnZS5idXR0b25zW2ldLnZhbHVlCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbXNnLmJ1dHRvbnNfbGlzdC5wdXNoKHsKICAgICAgICAgICAgdGl0bGU6IG1lc3NhZ2UuYnV0dG9uc1tpXS50aXRsZSwKICAgICAgICAgICAgdmFsdWU6IG1lc3NhZ2UuYnV0dG9uc1tpXS52YWx1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICgKICAgICAgICAgIG1zZy5idXR0b25zX2xpc3RbaV0udGl0bGUgPT0gIk5vIiAmJgogICAgICAgICAgbWVzc2FnZS50ZXh0ICE9ICJDYW4gSSBoZWxwIHlvdSB3aXRoIGFueXRoaW5nIGVsc2U/IiAmJgogICAgICAgICAgdGhpcy5jb21wYW55aWQgPT0gImNsaW5pY2FsdHJpYWxzODEzNTIiCiAgICAgICAgKSB7CiAgICAgICAgICBtc2cuYnV0dG9uc19saXN0W2ldLnZhbHVlID0gImlzZGlzYWJsZWQiOwogICAgICAgIH0KICAgICAgfQogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgIGlmIChpbmRleCA9PSAiaXNfYnV0dG9uIiB8fCBpbmRleCA9PSAwKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKQogICAgICAgICAgICAgICAgLmNoaWxkcmVuKCkKICAgICAgICAgICAgICAgIC5sYXN0KCkKICAgICAgICAgICAgICAgIC5oZWlnaHQoKSAvCiAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPAogICAgICAgICAgICAgIDAuNQogICAgICAgICAgICApIHsKICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuYW5pbWF0ZSgKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9wOiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAxNTAwCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuYW5pbWF0ZSgKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9wOiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsVG9wIikgKyA1MAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIDE1MDAKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy50b19zY3JvbGwgPSB0cnVlOwogICAgICAgIH0KICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgfSwgMjUwMCk7CiAgICB9LAogICAgbXVsdGlzZWxlY3RfbG9hZChtZXNzYWdlLCBpbmRleCkgewogICAgICB2YXIgbXNnID0gewogICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgIG11bHRpc2VsZWN0X3ZhbHVlczogbWVzc2FnZS5jdXN0b20udmFsdWVzLAogICAgICAgIHBsYWNlaG9sZGVyOiBtZXNzYWdlLmN1c3RvbS5wbGFjZWhvbGRlciwKICAgICAgICBpc19tdWx0aXNlbGVjdDogdHJ1ZSwKICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgcmVjZWl2ZWQ6IG1lc3NhZ2UudGV4dCwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKQogICAgICB9OwogICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgfSwKICAgIGxvYWRfdGFibGUobWVzc2FnZSwgaW5kZXgpIHsKICAgICAgbGV0IG1zZyA9IHsKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICBjb2xfbGlzdDogT2JqZWN0LmtleXMobWVzc2FnZS5jdXN0b20udmFsdWVzWzBdKSwKICAgICAgICB0YWJsZV92YWx1ZTogbWVzc2FnZS5jdXN0b20udmFsdWVzLAogICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICByZWNlaXZlZDogbWVzc2FnZS50ZXh0LAogICAgICAgIGlzX3RhYmxlOiB0cnVlLAogICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpCiAgICAgIH07CgogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgIGlmIChpbmRleCA9PSAwKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKQogICAgICAgICAgICAgICAgLmNoaWxkcmVuKCkKICAgICAgICAgICAgICAgIC5sYXN0KCkKICAgICAgICAgICAgICAgIC5oZWlnaHQoKSAvCiAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPAogICAgICAgICAgICAgIDAuNQogICAgICAgICAgICApIHsKICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuYW5pbWF0ZSgKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9wOiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAxNTAwCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuYW5pbWF0ZSgKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9wOiAwLjcgKiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAxNTAwCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgMTAwMCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5hbmltYXRlKAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc2Nyb2xsVG9wOiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsVG9wIikgKyAxMDAKICAgICAgICAgICAgfSwKICAgICAgICAgICAgMTUwMAogICAgICAgICAgKTsKICAgICAgICAgIHRoaXMudG9fc2Nyb2xsID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0sIDI1MDApOwogICAgfSwKICAgIGNyZWF0ZV9jaGF0KG1lc3NhZ2UsIHR5cGUpIHsKICAgICAgdmFyIGN1cnJlbmN5X2xpc3QgPSBbXTsKICAgICAgaWYgKHR5cGUgPT0gImlzdGFibGUiKSB7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5nZXQoImh0dHBzOi8vYXBpLmV4Y2hhbmdlcmF0ZXNhcGkuaW8vbGF0ZXN0IiwgewogICAgICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgICBiYXNlOiAiQVVEIgogICAgICAgICAgICB9CiAgICAgICAgICB9KQogICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICBmb3IgKHZhciBpIGluIG1lc3NhZ2UuZXh0cmFzWzBdLlRBQkxFKSB7CiAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZXh0cmFzWzBdLlRBQkxFW2ldLlBST1AgPT0gIlRSIikgewogICAgICAgICAgICAgICAgY3VycmVuY3lfbGlzdC5wdXNoKHsKICAgICAgICAgICAgICAgICAgY3VycmVuY3lfdGl0bGU6IG1lc3NhZ2UuZXh0cmFzWzBdLlRBQkxFW2ldLlRELAogICAgICAgICAgICAgICAgICBjdXJyZW5jeV92YWx1ZTogcGFyc2VGbG9hdCgKICAgICAgICAgICAgICAgICAgICBNYXRoLnJvdW5kKAogICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yYXRlc1ttZXNzYWdlLmV4dHJhc1swXS5UQUJMRVtpXVsiVERfMSJdXSAqCiAgICAgICAgICAgICAgICAgICAgICAgIDEwMAogICAgICAgICAgICAgICAgICAgICkgLyAxMDAKICAgICAgICAgICAgICAgICAgKS50b0ZpeGVkKDQpLAogICAgICAgICAgICAgICAgICB0eXBlOiAiVFIiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgbWVzc2FnZS5leHRyYXNbMF0uVEFCTEVbaV0uUFJPUCA9PSAiVEhFQUQiICYmCiAgICAgICAgICAgICAgICAhdGhpcy5pc2V4Y2hhbmdlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICBjdXJyZW5jeV9saXN0LnB1c2goewogICAgICAgICAgICAgICAgICBjb3VudHJ5X25hbWU6IG1lc3NhZ2UuZXh0cmFzWzBdLlRBQkxFW2ldLlRELAogICAgICAgICAgICAgICAgICBjdXJyZW5jeV9uYW1lOiBtZXNzYWdlLmV4dHJhc1swXS5UQUJMRVtpXS5URF8xLAogICAgICAgICAgICAgICAgICB0eXBlOiAiVEhFQUQiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8vCiAgICAgICAgICAgIHRoaXMuY3VycmVuY3lleGNoYW5nZV9saXN0ID0gY3VycmVuY3lfbGlzdDsKICAgICAgICAgICAgLy8vCiAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgICBpc190YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB0YWJsZV90aXRsZTogdGhpcy5wYXJzZShtZXNzYWdlLnRpdGxlKSwKICAgICAgICAgICAgICB0YWJsZV9saXN0OiBjdXJyZW5jeV9saXN0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLnR5cGluZy1pbmRpY2F0b3IiKS5zdHlsZS5kaXNwbGF5ID0KICAgICAgICAgICAgICAgICJub25lIjsKICAgICAgICAgICAgfSwgMTAwMCk7CiAgICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09ICJpc3Byb21wdCIpIHsKICAgICAgICBpZiAobWVzc2FnZS5sZXZlbCA+IDApIHsKICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKG1lc3NhZ2UpOwogICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgICAgICB0aGlzLmxldmVsID0gbWVzc2FnZS5sZXZlbDsKICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5jaGF0LnB1c2gobWVzc2FnZSk7CiAgICAgICAgICB0aGlzLmZpcnN0X2NsaWNrID0gdHJ1ZTsKICAgICAgICAgIHRoaXMubGV2ZWwgPSBtZXNzYWdlLmxldmVsOwogICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmNoYXQucHVzaChtZXNzYWdlKTsKICAgICAgfQogICAgICB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgIH0sCiAgICBzdWJtaXRfY3VzdG9tX2Zvcm0oKSB7CiAgICAgIGlmIChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjZGV0YWlsc19mb3JtIikgIT0gbnVsbCkgewogICAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI2RldGFpbHNfZm9ybSIpOwogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigic3VibWl0IiwgZXZlbnQgPT4gewogICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIC8vIGFjdHVhbCBsb2dpYywgZS5nLiB2YWxpZGF0ZSB0aGUgZm9ybQogICAgICAgICAgdmFyIHF1ZXJ5U3RyaW5nID0gJCgiI2RldGFpbHNfZm9ybSIpLnNlcmlhbGl6ZUFycmF5KCk7CiAgICAgICAgICBpZiAodGhpcy5mb3JtX3BheWxvYWQgPT0gbnVsbCkgewogICAgICAgICAgICB0aGlzLmZvcm1fcGF5bG9hZCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBpIGluIHF1ZXJ5U3RyaW5nKSB7CiAgICAgICAgICAgICAgdGhpcy5mb3JtX3BheWxvYWRbcXVlcnlTdHJpbmdbaV0ubmFtZV0gPSBxdWVyeVN0cmluZ1tpXS52YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBheGlvcwogICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5ib3RfdXNlcl9kYXRhKCksIHsKICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICBkYXRhOiB0aGlzLmZvcm1fcGF5bG9hZCwKICAgICAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUKICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhID09ICJCb3QgVXNlciBEYXRhIFNhdmVkIFN1Y2Nlc3NmdWxseSIpIHsKICAgICAgICAgICAgICAgICAgJCgiI2RldGFpbHNfZm9ybSA6aW5wdXQiKS5wcm9wKCJkaXNhYmxlZCIsIHRydWUpOwogICAgICAgICAgICAgICAgICAkKCIjZGV0YWlsc19mb3JtIDpidXR0b24iKS5wcm9wKCJkaXNhYmxlZCIsIHRydWUpOwogICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICAgICAgICAgICAgY2hhdDogIi9kZXRhaWxzX2Zvcm0iLAogICAgICAgICAgICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgICAgICAgICAgICB1c2VyX2lkOiAiIiwKICAgICAgICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikKICAgICAgICAgICAgICAgICAgICAgICAgLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgICAgICAgRGV0YWlsczogSlNPTi5zdHJpbmdpZnkodGhpcy5mb3JtX3BheWxvYWQpLAogICAgICAgICAgICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLnRoZW4ocmVzcCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3ApOwogICAgICAgICAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmFuaW1hdGUoCiAgICAgICAgICAgICAgICAgICAgICAgIHsgc2Nyb2xsVG9wOiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikgfSwKICAgICAgICAgICAgICAgICAgICAgICAgMTAwMAogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC5jYXRjaChlID0+IHsKICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgdXBkYXRlX3Njcm9sbGJhcih0eXBlLCBpc3Jlc3BvbnNlLCBpc3dlbGNvbWUsIGRlbGF5X3ZhbHVlKSB7CiAgICAgIHZhciBzY3JvbGxfZGVsYXkgPSBpc3dlbGNvbWUgPT0gImlzX3dlbGNvbWUiID8gZGVsYXlfdmFsdWUgOiAyMDAwOwogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICBpZiAoaXNyZXNwb25zZSA9PSAicmVzcG9uc2UiKSB7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgfSwgc2Nyb2xsX2RlbGF5KTsKICAgICAgfSBlbHNlIGlmIChpc3Jlc3BvbnNlID09ICJzZW5kZXIiKSB7CiAgICAgICAgJCgiLmNoYXQtYm9keSIpLmFuaW1hdGUoCiAgICAgICAgICB7CiAgICAgICAgICAgIHNjcm9sbFRvcDogJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbEhlaWdodCIpCiAgICAgICAgICB9LAogICAgICAgICAgNzUwCiAgICAgICAgKTsKICAgICAgfQogICAgICBpZiAoaXNyZXNwb25zZSAhPSAic2VuZGVyIikgewogICAgICAgIGlmICh0eXBlID09ICJ1cHRvX2VuZCIpIHsKICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbFRvcCIpIDwKICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgJCgiLnJlY2VpdmVyIikKICAgICAgICAgICAgICAgICAgLmxhc3QoKQogICAgICAgICAgICAgICAgICAucGFyZW50KCkKICAgICAgICAgICAgICAgICAgLmhlaWdodCgpIC8KICAgICAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpID4KICAgICAgICAgICAgICAgIDAuNQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmFuaW1hdGUoCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBzY3JvbGxUb3A6IDAuNzUgKiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgMTUwMAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHRoaXMudG9fc2Nyb2xsID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgJCgiLnJlY2VpdmVyIikKICAgICAgICAgICAgICAgIC5sYXN0KCkKICAgICAgICAgICAgICAgIC5wYXJlbnQoKQogICAgICAgICAgICAgICAgLmhlaWdodCgpIC8KICAgICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA8CiAgICAgICAgICAgICAgMC41CiAgICAgICAgICAgICkgewogICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5hbmltYXRlKAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBzY3JvbGxUb3A6ICQoIi5jaGF0LWJvZHkiKS5wcm9wKCJzY3JvbGxIZWlnaHQiKQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNjcm9sbF9kZWxheQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIHNjcm9sbF9kZWxheSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuY2hhdC1ib2R5Iikuc2Nyb2xsVG9wID0KICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuY2hhdC1ib2R5Iikuc2Nyb2xsSGVpZ2h0IC0KICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuY2hhdC1ib2R5IikubGFzdENoaWxkLnNjcm9sbEhlaWdodDsKICAgICAgICAgIH0sIDEwMDApOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIEZYUGF5bWVudE1vZGUoKSB7CiAgICAgIHRoaXMudG9fc2VuZCA9ICIvRm9yZWlnbnhjaGFuZ2UxNzQ5MV9wYXltZW50X21vZGUiOwogICAgICB0aGlzLnNlbmRfbWVzc2FnZSgKICAgICAgICAiaXNfcHJvbXB0IiwKICAgICAgICAiL0ZvcmVpZ254Y2hhbmdlMTc0OTFfcGF5bWVudF9tb2RlIiwKICAgICAgICAiUGF5bWVudCIKICAgICAgKTsKICAgIH0sCiAgICBGWFRyYWNraW5nUGFyY2VsKCkgewogICAgICB0aGlzLnRvX3NlbmQgPSAiL0ZvcmVpZ254Y2hhbmdlMTc0OTFfdHJhY2tpbmdfcGFyY2VsIjsKICAgICAgdGhpcy5zZW5kX21lc3NhZ2UoCiAgICAgICAgImlzX3Byb21wdCIsCiAgICAgICAgIi9Gb3JlaWdueGNoYW5nZTE3NDkxX3RyYWNraW5nX3BhcmNlbCIsCiAgICAgICAgIlRyYWNrIE15IFBhcmNlbCIKICAgICAgKTsKICAgIH0sCiAgICAvLyBGb3JlaWduRXhjaGFuZ2VDb252ZXJzaW9uKCkgewogICAgLy8gICB0aGlzLnRvX3NlbmQgPSAiL0ZvcmVpZ254Y2hhbmdlMTc0OTFfZXhjaGFuZ2VfcmF0ZSI7CiAgICAvLyAgIHRoaXMuc2VuZF9tZXNzYWdlKAogICAgLy8gICAgICJpc19wcm9tcHQiLAogICAgLy8gICAgICIvRm9yZWlnbnhjaGFuZ2UxNzQ5MV9leGNoYW5nZV9yYXRlIiwKICAgIC8vICAgICAiRXhjaGFuZ2UgUmF0ZSIKICAgIC8vICAgKTsKICAgIC8vIH0sCiAgICBGb3JlaWduRXhjaGFuZ2VDb252ZXJzaW9uKCkgewogICAgICAvLyB0aGlzLnRvX3NlbmQgPSAiL0ZvcmVpZ254Y2hhbmdlMTc0OTFfZXhjaGFuZ2VfcmF0ZSI7CiAgICAgIHRoaXMudG9fc2VuZCA9ICcvRm9yZWlnbnhjaGFuZ2UxNzQ5MV9leGNoYW5nZV9yYXRleyJCVVlfT1JfU0VMTCI6ICJCVVkifSc7CiAgICAgIHRoaXMuc2VuZF9tZXNzYWdlKAogICAgICAgICJpc19wcm9tcHQiLAogICAgICAgICcvRm9yZWlnbnhjaGFuZ2UxNzQ5MV9leGNoYW5nZV9yYXRleyJCVVlfT1JfU0VMTCI6ICJCVVkifScsCiAgICAgICAgIkV4Y2hhbmdlIFJhdGUiCiAgICAgICk7CiAgICB9LAoKICAgIGV4MSgpIHsKICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyMSIpICE9IG51bGwpIHsKICAgICAgICAgICQoIiNsMSIpLnZhbCgxKTsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jdXJyZW5jeWV4Y2hhbmdlX2xpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgJCgiI2NvdW50cnkiKS5hcHBlbmQoCiAgICAgICAgICAgICAgYDxvcHRpb24gdmFsdWU9IiR7dGhpcy5jdXJyZW5jeWV4Y2hhbmdlX2xpc3RbaV0uY3VycmVuY3lfdmFsdWV9Ij4ke3RoaXMuY3VycmVuY3lleGNoYW5nZV9saXN0W2ldLmN1cnJlbmN5X3RpdGxlfTwvb3B0aW9uPmAKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgICQoIiNyMSIpLnRleHQoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvdW50cnkiKS52YWx1ZSk7CiAgICAgICAgICAvLyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicjEiKS5hZGRFdmVudExpc3RlbmVyKCJrZXl1cCIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gICB2YXIgeCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyMSIpLmlubmVyVGV4dDsKICAgICAgICAgIC8vICAgdmFyIGNvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjb3VudHJ5IikudmFsdWU7CiAgICAgICAgICAvLyAgIHggPSB4IC8gY29uOwogICAgICAgICAgLy8gICB4ID0geC50b0ZpeGVkKDQpOwogICAgICAgICAgLy8gICAkKCIjbDEiKS52YWwoeCk7CiAgICAgICAgICAvLyB9KTsKICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJsMSIpLmFkZEV2ZW50TGlzdGVuZXIoImtleXVwIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB4ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImwxIikudmFsdWU7CiAgICAgICAgICAgIHZhciBjb24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY291bnRyeSIpLnZhbHVlOwogICAgICAgICAgICB4ID0geCAqIGNvbjsKICAgICAgICAgICAgeCA9IHgudG9GaXhlZCg0KTsKICAgICAgICAgICAgJCgiI3IxIikudGV4dCh4KTsKICAgICAgICAgIH0pOwogICAgICAgICAgJChkb2N1bWVudCkub24oImNoYW5nZSIsICIjY291bnRyeSIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY291bnRyeSIpLmFkZEV2ZW50TGlzdGVuZXIoImtleXVwIiwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIHggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibDEiKS52YWx1ZTsKICAgICAgICAgICAgdmFyIGNvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJjb3VudHJ5IikudmFsdWU7CiAgICAgICAgICAgIHggPSB4ICogY29uOwogICAgICAgICAgICB4ID0geC50b0ZpeGVkKDQpOwogICAgICAgICAgICAkKCIjcjEiKS50ZXh0KHgpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9LCAxMDApOwogICAgfSwKICAgIGFkZGRyb3Bkb3dudmFsdWUoKSB7CiAgICAgIGlmICh0aGlzLnNlbGVjdGVkX2luZGljYXRpb25bMF0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy50b19zZW5kID0gIiI7CiAgICAgICAgdGhpcy5yZXMgPSB7fTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGkgPT0gMCkgewogICAgICAgICAgICB0aGlzLnRvX3NlbmQgPSB0aGlzLnNlbGVjdGVkX2luZGljYXRpb25baV0udGl0bGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnRvX3NlbmQgPQogICAgICAgICAgICAgIHRoaXMudG9fc2VuZCArICIsICIgKyB0aGlzLnNlbGVjdGVkX2luZGljYXRpb25baV0udGl0bGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIHRoaXMucmVzW3RoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbltpXS52YWx1ZS5zcGxpdCgnIicpWzFdXSA9PQogICAgICAgICAgICB1bmRlZmluZWQKICAgICAgICAgICkgewogICAgICAgICAgICB0aGlzLnJlc1sKICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkX2luZGljYXRpb25baV0udmFsdWUuc3BsaXQoJyInKVsxXQogICAgICAgICAgICBdID0gdGhpcy5zZWxlY3RlZF9pbmRpY2F0aW9uW2ldLnZhbHVlLnNwbGl0KCciJylbM107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnJlc1t0aGlzLnNlbGVjdGVkX2luZGljYXRpb25baV0udmFsdWUuc3BsaXQoJyInKVsxXV0gPQogICAgICAgICAgICAgIHRoaXMucmVzW3RoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbltpXS52YWx1ZS5zcGxpdCgnIicpWzFdXSArCiAgICAgICAgICAgICAgIiwiICsKICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkX2luZGljYXRpb25baV0udmFsdWUuc3BsaXQoJyInKVszXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5idXR0b25fZmlsbCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudG9fc2VuZCA9ICIiOwogICAgICAgIHRoaXMucmVzID0gW107CiAgICAgIH0KICAgICAgdGhpcy5idXR0b25fZmlsbCgpOwogICAgfSwKICAgIGNsb3NlZF9ib3RfY2hhdChtZXNzYWdlLHR5cGUpewogICAgICAvLyBkZWJ1Z2dlcjsKICAgICAgLy8gY29uc29sZS5sb2cobWVzc2FnZSk7CiAgICAgIHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZD10cnVlOwogICAgICAvLyBsYXN0Y2xvc2VkYm90aW5wdXRub2RlCiAgICAgIGlmKG1lc3NhZ2Uubm9kZXNbbWVzc2FnZS5ub2Rlcy5sZW5ndGgtMV0ubm9kZV90eXBlPT0iaGVhZGVyIiYmbWVzc2FnZS5ub2Rlc1ttZXNzYWdlLm5vZGVzLmxlbmd0aC0xXS5ub2RlX3R5cGUhPW51bGwmJiF0aGlzLmVtcHR5X3N0cmluZ192YWxpZGl0eS50ZXN0KG1lc3NhZ2Uubm9kZXNbbWVzc2FnZS5ub2Rlcy5sZW5ndGgtMV0ubm9kZV90eXBlKSl7CiAgICAgICAgaWYobWVzc2FnZS5ub2Rlc1ttZXNzYWdlLm5vZGVzLmxlbmd0aC0xXS50aXRsZT09IkRpc3BsYXkgTWVzc2FnZSIpewogICAgICAgICAgbWVzc2FnZS5ub2Rlc1ttZXNzYWdlLm5vZGVzLmxlbmd0aC0xXS50aXRsZT1udWxsOwogICAgICAgIH0KICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICByZWNlaXZlZDogbWVzc2FnZS5ub2Rlc1ttZXNzYWdlLm5vZGVzLmxlbmd0aC0xXS50aXRsZSwKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgdGltZTogbnVsbAogICAgICAgIH0pOwogICAgICB9CgogICAgICAgIC8vIGNvbnNvbGUubG9nKG1lc3NhZ2Uubm9kZXMubGVuZ3RoKTsKICAgICAgZm9yKGxldCBpPTA7aTxtZXNzYWdlLm5vZGVzLmxlbmd0aC0xO2krPSAxKXsKICAgICAgICAvLyBjb25zb2xlLmxvZyhtZXNzYWdlLm5vZGVzKTsKICAgICAgICBpZihtZXNzYWdlLm5vZGVzW2ldLm5vZGVfdHlwZT09Im5vZGUiJiZtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQuZWxlbWVudF90eXBlPT0iYnV0dG9uIiYmIW1lc3NhZ2Uubm9kZXNbaV0ucGFydF9vZl9mb3JtKXsKICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICBidXR0b25zX2xpc3Q6IFtdLAogICAgICAgICAgICBidXR0b25fcHJlZml4OiBudWxsLAogICAgICAgICAgICBjdXN0b21fYnV0dG9uczogdHJ1ZSwKICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICB0aW1lOiBudWxsLAogICAgICAgICAgICByZW1vdmFibGU6IHR5cGUgPT0gIndlbGNvbWVfbWVzc2FnZSIgPyBmYWxzZSA6IHRydWUKICAgICAgICAgIH07CiAgICAgICAgICB3aGlsZShtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQhPXVuZGVmaW5lZCl7CiAgICAgICAgICAgIGlmKG1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5lbGVtZW50X3R5cGU9PSJidXR0b24iKXsKICAgICAgICAgICAgICBtc2cuYnV0dG9uc19saXN0LnB1c2goewogICAgICAgICAgICAgICAgdGl0bGU6IG1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5idXR0b24sCiAgICAgICAgICAgICAgICB2YWx1ZTogbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LnBheWxvYWQsCiAgICAgICAgICAgICAgICBpZDogbWVzc2FnZS5ub2Rlc1tpXS5ub2RlX2lkLAogICAgICAgICAgICAgICAgbm9kZTogbWVzc2FnZS5ub2Rlc1tpXQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG1zZy5idXR0b25zX2xpc3QucHVzaCh7CiAgICAgICAgICAgIC8vICAgdGl0bGU6IG1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5idXR0b25zLAogICAgICAgICAgICAvLyAgIHZhbHVlOiBtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQucGF5bG9hZCwKICAgICAgICAgICAgLy8gfSk7CiAgICAgICAgICAgIGkrKzsKICAgICAgICAgIH0KICAgICAgICAgIGktLTsKICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgfSBlbHNlIGlmKG1lc3NhZ2Uubm9kZXNbaV0ubm9kZV90eXBlPT0ibm9kZSImJm1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5lbGVtZW50X3R5cGU9PSJ0ZXh0X2JveCImJiFtZXNzYWdlLm5vZGVzW2ldLnBhcnRfb2ZfZm9ybSl7CiAgICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgIHRpbWU6IG51bGwsCiAgICAgICAgICAgIHJlY2VpdmVkOiBtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQubWVzc2FnZSwKICAgICAgICAgIH0pOwogICAgICAgICAgLy8gdmFyIG1zZyA9IHsKICAgICAgICAgIC8vICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAvLyAgIGJ1dHRvbnNfbGlzdDogW10sCiAgICAgICAgICAvLyAgIGJ1dHRvbl9wcmVmaXg6IG51bGwsCiAgICAgICAgICAvLyAgIGN1c3RvbV9idXR0b25zOiB0cnVlLAogICAgICAgICAgLy8gICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAvLyAgIHJlY2VpdmVkOiAnPGlucHV0IHR5cGU9InRleHQiIHBsYWNlaG9sZGVyPSInK21lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5wbGFjZWhvbGRlcisnIm5hbWU9ImNsb3NlZF9ib3Rfbm9kZV8nK2krJyI+JywKICAgICAgICAgIC8vICAgdGltZTogbnVsbCwKICAgICAgICAgIC8vICAgcmVtb3ZhYmxlOiB0eXBlID09ICJ3ZWxjb21lX21lc3NhZ2UiID8gZmFsc2UgOiB0cnVlCiAgICAgICAgICAvLyB9OwogICAgICAgICAgdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkID0gZmFsc2U7CiAgICAgICAgICAvLyBjb25zb2xlLmxvZygnMicpOwogICAgICAgICAgLy8gdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgICB9IGVsc2UgaWYobWVzc2FnZS5ub2Rlc1tpXS5ub2RlX3R5cGU9PSJub2RlIiYmbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LmVsZW1lbnRfdHlwZT09InRleHRfYXJlYSImJiFtZXNzYWdlLm5vZGVzW2ldLnBhcnRfb2ZfZm9ybSl7CiAgICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgYnV0dG9uc19saXN0OiBbXSwKICAgICAgICAgICAgYnV0dG9uX3ByZWZpeDogbnVsbCwKICAgICAgICAgICAgY3VzdG9tX2J1dHRvbnM6IHRydWUsCiAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgLy8gcmVjZWl2ZWQ6ICc8aW5wdXQgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9IicrbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LnBsYWNlaG9sZGVyKycibmFtZT0iY2xvc2VkX2JvdF9ub2RlXycraSsnIj4nLAogICAgICAgICAgICByZWNlaXZlZDogJzx0ZXh0YXJlYSBjbGFzcz0iZm9ybS1jb250cm9sIiByb3dzPSI0IiBjb2xzPSIxNTAic3R5bGU9InBhZGRpbmctbGVmdDoxMnB4O3Jlc2l6ZTpub25lO292ZXJmbG93LXk6YXV0bzttaW4taGVpZ2h0OjMwcHgiIHBsYWNlaG9sZGVyPSInK21lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5wbGFjZWhvbGRlcisnIm5hbWU9ImNsb3NlZF9ib3Rfbm9kZV8nK2krJyI+PC90ZXh0YXJlYT4nLAogICAgICAgICAgICB0aW1lOiBudWxsLAogICAgICAgICAgICByZW1vdmFibGU6IHR5cGUgPT0gIndlbGNvbWVfbWVzc2FnZSIgPyBmYWxzZSA6IHRydWUKICAgICAgICAgIH07CiAgICAgICAgICB0aGlzLm5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIgPSAiY2xvc2VkX2JvdF9ub2RlXyIraTsKICAgICAgICAgIC8vIG1zZy5idXR0b25zX2xpc3QucHVzaCh7CiAgICAgICAgICAvLyAgICAgdGl0bGU6ICdTdWJtaXQnLAogICAgICAgICAgLy8gICAgIHZhbHVlOiAnU3VibWl0JywKICAgICAgICAgIC8vICAgfSk7CiAgICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgcmVjZWl2ZWQ6IG1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5tZXNzYWdlLAogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgdGltZTogbnVsbAogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgdGhpcy5pc190ZXh0X2FyZWEgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZihtZXNzYWdlLm5vZGVzW2ldLm5vZGVfdHlwZT09Im5vZGUiJiZtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQuZWxlbWVudF90eXBlPT0iZW1haWwiJiYhbWVzc2FnZS5ub2Rlc1tpXS5wYXJ0X29mX2Zvcm0pewogICAgICAgICAgdGhpcy5pc2VtYWlsID0gdHJ1ZTsKICAgICAgICAgIC8vIGlmKG1lc3NhZ2Uubm9kZXNbaV0udmFsaWRhdGlvbl9zdWNjZXNzZnVsID09IGZhbHNlKXsKICAgICAgICAgIC8vIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgIC8vICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgLy8gICByZWNlaXZlZDogbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LmVycm9yX21zZywKICAgICAgICAgIC8vICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAvLyAgIHRpbWU6IG51bGwKICAgICAgICAgIC8vIH0pOwogICAgICAgICAgLy8gdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkID0gZmFsc2U7CiAgICAgICAgICAvLyB9CiAgICAgICAgICAvLyAgaWYoIW1lc3NhZ2Uubm9kZXNbaV0udmFsaWRhdGlvbl9zdWNjZXNzZnVsKXsKICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgICByZWNlaXZlZDogbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50Lm1lc3NhZ2UsCiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgdGltZTogbnVsbAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkID0gZmFsc2U7CiAgICAgICAgICAvLyAgfQogICAgICAgICAgLy8gdmFyIG1zZyA9IHsKICAgICAgICAgIC8vICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAvLyAgIGJ1dHRvbnNfbGlzdDogW10sCiAgICAgICAgICAvLyAgIGJ1dHRvbl9wcmVmaXg6IG51bGwsCiAgICAgICAgICAvLyAgIGN1c3RvbV9idXR0b25zOiB0cnVlLAogICAgICAgICAgLy8gICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAvLyAgIHJlY2VpdmVkOiAnPGlucHV0IHR5cGU9ImVtYWlsIiBwbGFjZWhvbGRlcj0iJyttZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQubWVzc2FnZSsnIm5hbWU9ImNsb3NlZF9ib3Rfbm9kZV8nK2krJyI+JywKICAgICAgICAgIC8vICAgdGltZTogbnVsbCwKICAgICAgICAgIC8vICAgcmVtb3ZhYmxlOiB0eXBlID09ICJ3ZWxjb21lX21lc3NhZ2UiID8gZmFsc2UgOiB0cnVlCiAgICAgICAgICAvLyB9OwogICAgICAgICAgLy8gLy8gbXNnLmJ1dHRvbnNfbGlzdC5wdXNoKHsKICAgICAgICAgIC8vIC8vICAgICB0aXRsZTogJ1N1Ym1pdCcsCiAgICAgICAgICAvLyAvLyAgICAgdmFsdWU6ICdTdWJtaXQnLAogICAgICAgICAgLy8gLy8gICB9KTsKICAgICAgICAgIC8vIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgfSBlbHNlIGlmKG1lc3NhZ2Uubm9kZXNbaV0ubm9kZV90eXBlPT0ibm9kZSImJm1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5lbGVtZW50X3R5cGU9PSJwaG9uZV9udW1iZXIiJiYhbWVzc2FnZS5ub2Rlc1tpXS5wYXJ0X29mX2Zvcm0pewogICAgICAgICAgdGhpcy5pc19waG9uZV9udW1iZXIgPSB0cnVlOwogICAgICAgICAgLy8gaWYobWVzc2FnZS5ub2Rlc1tpXS52YWxpZGF0aW9uX3N1Y2Nlc3NmdWwgPT0gZmFsc2UpewogICAgICAgICAgLy8gdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgLy8gICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAvLyAgIHJlY2VpdmVkOiBtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQuZXJyb3JfbXNnLAogICAgICAgICAgLy8gICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIC8vICAgdGltZTogbnVsbAogICAgICAgICAgLy8gfSk7CiAgICAgICAgICAvLyB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQgPSBmYWxzZTsKICAgICAgICAgIC8vIH0KICAgICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgIHRpbWU6IG51bGwsCiAgICAgICAgICAgIHJlY2VpdmVkOiBtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQubWVzc2FnZSwKICAgICAgICAgIH0pOwoKICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgIHRpbWU6IG51bGwsCiAgICAgICAgICAgIHJlY2VpdmVkOiAnPGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4Ij4gPHNlbGVjdCBuYW1lPSJjb3VudHJ5Y29kZSIgY2xhc3M9ImZvcm0tY29udHJvbCIgc3R5bGU9InBhZGRpbmctbGVmdDo2cHggIWltcG9ydGFudDtwYWRkaW5nLXJpZ2h0OjZweCAhaW1wb3J0YW50OyB3aWR0aDo0MCU7aGVpZ2h0OjUwcHggIWltcG9ydGFudDsiICA+JywKICAgICAgICAgICAgLy8gcmVjZWl2ZWQ6ICcnLAogICAgICAgICAgfQogICAgICAgICAgLy8gdmFyIGRyb3Bkb3duID0gW107CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBDb3VudHJ5Q29kZXM7CiAgICAgICAgICAgIGxldCBvcHRpb247CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIC8vIG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpOwogICAgICAgICAgICAgIC8vIG9wdGlvbi50ZXh0ID0gZGF0YVtpXS5jb3VudHJ5X2NvZGU7CiAgICAgICAgICAgICAgLy8gb3B0aW9uLnZhbHVlID0gZGF0YVtpXS5jYWxsaW5nX2NvZGU7CiAgICAgICAgICAgICAgLy8gLy8gZHJvcGRvd24uYWRkKG9wdGlvbik7CiAgICAgICAgICAgICAgLy8gbXNnLnJlY2VpdmVkPW1zZy5yZWNlaXZlZCArIG9wdGlvbjsKICAgICAgICAgICAgICBtc2cucmVjZWl2ZWQ9IG1zZy5yZWNlaXZlZCsnPG9wdGlvbiB2YWx1ZT0gJytkYXRhW2ldLmRpYWxfY29kZSsnPicrZGF0YVtpXS5jb2RlICsgIigiKyBkYXRhW2ldLmRpYWxfY29kZSArIikiICsgJzwvb3B0aW9uPicKICAgICAgICAgICAgfQogICAgICAgICAgICBtc2cucmVjZWl2ZWQ9bXNnLnJlY2VpdmVkKyc8L3NlbGVjdD4nOwogICAgICAgICAgICBtc2cucmVjZWl2ZWQgPSBtc2cucmVjZWl2ZWQgKyAnPGlucHV0IHR5cGU9InRleHQiIGNsYXNzPSJmb3JtLWNvbnRyb2wiIHN0eWxlPSJwYWRkaW5nLWxlZnQ6MTJweCAhaW1wb3J0YW50OyBoZWlnaHQ6NTBweCAhaW1wb3J0YW50OyIgYXV0b2NvbXBsZXRlPSJvZmYiIG5hbWU9InBob25lbnVtYmVyIiBpZD0gInBob25lbnVtYmVyIiBuYW1lPSJjbG9zZWRfYm90X25vZGVfJytpKyciPiAgPC9kaXY+JwogICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhtc2cpOwogICAgICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgLy8gdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgLy8gcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgLy8gcmVjZWl2ZWQ6IG1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5tZXNzYWdlLAogICAgICAgICAgLy8gY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAvLyB0aW1lOiBudWxsCiAgICAgICAgICAvLyB9KTsKICAgICAgICAgIHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCA9IHRydWU7CiAgICAgICAgICB0aGlzLm5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIgPSAicGhvbmVudW1iZXIiOwogICAgICAgICAgLy8gdmFyIG1zZyA9IHsKICAgICAgICAgIC8vICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAvLyAgIGJ1dHRvbnNfbGlzdDogW10sCiAgICAgICAgICAvLyAgIGJ1dHRvbl9wcmVmaXg6IG51bGwsCiAgICAgICAgICAvLyAgIGN1c3RvbV9idXR0b25zOiB0cnVlLAogICAgICAgICAgLy8gICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAvLyAgIHJlY2VpdmVkOiAnPGlucHV0IHR5cGU9ImVtYWlsIiBwbGFjZWhvbGRlcj0iJyttZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQubWVzc2FnZSsnIm5hbWU9ImNsb3NlZF9ib3Rfbm9kZV8nK2krJyI+JywKICAgICAgICAgIC8vICAgdGltZTogbnVsbCwKICAgICAgICAgIC8vICAgcmVtb3ZhYmxlOiB0eXBlID09ICJ3ZWxjb21lX21lc3NhZ2UiID8gZmFsc2UgOiB0cnVlCiAgICAgICAgICAvLyB9OwogICAgICAgICAgLy8gLy8gbXNnLmJ1dHRvbnNfbGlzdC5wdXNoKHsKICAgICAgICAgIC8vIC8vICAgICB0aXRsZTogJ1N1Ym1pdCcsCiAgICAgICAgICAvLyAvLyAgICAgdmFsdWU6ICdTdWJtaXQnLAogICAgICAgICAgLy8gLy8gICB9KTsKICAgICAgICAgIC8vIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgfSBlbHNlIGlmKG1lc3NhZ2Uubm9kZXNbaV0ubm9kZV90eXBlPT0ibm9kZSImJm1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5lbGVtZW50X3R5cGU9PSJoeXBlcmxpbmsiJiYhbWVzc2FnZS5ub2Rlc1tpXS5wYXJ0X29mX2Zvcm0pewogICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICB0aW1lOiBudWxsLAogICAgICAgICAgICByZWNlaXZlZDogJzxhIGhyZWY9IicrbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50Lmh5cGVybGluaysnIiB0YXJnZXQ9Il9ibGFuayI+JyttZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQuaHlwZXJsaW5rKyc8L2E+JywKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZihtZXNzYWdlLm5vZGVzW2ldLm5vZGVfdHlwZT09Im5vZGUiJiZtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQuZWxlbWVudF90eXBlPT0icmFkaW9fYnV0dG9ucyImJiFtZXNzYWdlLm5vZGVzW2ldLnBhcnRfb2ZfZm9ybSl7CiAgICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgdGltZTogbnVsbCwKICAgICAgICAgICAgcmVjZWl2ZWQ6ICcnLAogICAgICAgICAgfQogICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgICByZWNlaXZlZDogbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50Lm1lc3NhZ2UsCiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgdGltZTogbnVsbAogICAgICAgICAgfSk7CiAgICAgICAgICAvLyBtc2cucmVjZWl2ZWQgPSBtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQubWVzc2FnZTsKICAgICAgICAgIGZvcihsZXQgaj0wO2o8bWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LnJhZGlvX2J1dHRvbnMubGVuZ3RoO2orKyl7CiAgICAgICAgICAgIG1zZy5yZWNlaXZlZD1tc2cucmVjZWl2ZWQrJzxpbnB1dCB0eXBlPSJyYWRpbyIgbmFtZT0iJyttZXNzYWdlLm5vZGVzW2ldLm5vZGVfaWQrJyIgdmFsdWU9IicrbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LnJhZGlvX2J1dHRvbnNbal0udGl0bGUrJyI+JyttZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQucmFkaW9fYnV0dG9uc1tqXS50aXRsZSsnPGJyPic7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgIH0gZWxzZSBpZihtZXNzYWdlLm5vZGVzW2ldLm5vZGVfdHlwZT09Im5vZGUiJiZtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQuZWxlbWVudF90eXBlPT0iY2hlY2tfYm94IiYmIW1lc3NhZ2Uubm9kZXNbaV0ucGFydF9vZl9mb3JtKXsKICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgIHRpbWU6IG51bGwsCiAgICAgICAgICAgIHJlY2VpdmVkOiAnJywKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2ZWQ6IG1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5tZXNzYWdlLAogICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgIHRpbWU6IG51bGwKICAgICAgICAgIH0pOwogICAgICAgICAgZm9yKGxldCBqPTA7ajxtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQudmFsdWVzLmxlbmd0aDtqKyspewogICAgICAgICAgICBtc2cucmVjZWl2ZWQ9bXNnLnJlY2VpdmVkKyc8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9IicrbWVzc2FnZS5ub2Rlc1tpXS5ub2RlX2lkKyciIHZhbHVlPSInK21lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC52YWx1ZXNbal0udGl0bGUrJyI+JyttZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQudmFsdWVzW2pdLnRpdGxlKyc8YnI+JzsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgfSBlbHNlIGlmKG1lc3NhZ2Uubm9kZXNbaV0ubm9kZV90eXBlPT0ibm9kZSImJm1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5lbGVtZW50X3R5cGU9PSJkcm9wZG93biImJiFtZXNzYWdlLm5vZGVzW2ldLnBhcnRfb2ZfZm9ybSl7CiAgICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICB0aW1lOiBudWxsLAogICAgICAgICAgICByZWNlaXZlZDogJzxzZWxlY3QgbmFtZT0iJyttZXNzYWdlLm5vZGVzW2ldLm5vZGVfaWQrJyIgY2xhc3M9ImZvcm0tY29udHJvbCIgPjxvcHRpb24gdmFsdWUgZGlzYWJsZWQ9ImRpc2FibGVkIj4nK21lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5tZXNzYWdlKyc8L29wdGlvbj4nLAogICAgICAgICAgICAvLyByZWNlaXZlZDogJycsCiAgICAgICAgICB9CgogICAgICAgICAgZm9yKGxldCBqPTA7ajxtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQuZHJvcGRvd24ubGVuZ3RoO2orKyl7CiAgICAgICAgICAgIG1zZy5yZWNlaXZlZD1tc2cucmVjZWl2ZWQrJzxvcHRpb24+JyttZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQuZHJvcGRvd25bal0udGl0bGUrJzwvb3B0aW9uPic7CiAgICAgICAgICB9CiAgICAgICAgICBtc2cucmVjZWl2ZWQ9bXNnLnJlY2VpdmVkKyc8L3NlbGVjdD4nOwogICAgICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgICB9IGVsc2UgaWYobWVzc2FnZS5ub2Rlc1tpXS5ub2RlX3R5cGU9PSJub2RlIiYmbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LmVsZW1lbnRfdHlwZT09ImltYWdlIiYmIW1lc3NhZ2Uubm9kZXNbaV0ucGFydF9vZl9mb3JtKXsKICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgdGltZTogbnVsbCwKICAgICAgICAgICAgcmVjZWl2ZWQ6ICc8aW1nIHdpZHRoPSIyMTBweCIgaGVpZ2h0PSIxNDBweCIgc3JjPSInK21lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5pbWFnZSsnIj4nLAogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmKG1lc3NhZ2Uubm9kZXNbaV0ubm9kZV90eXBlPT0ibm9kZSImJm1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5lbGVtZW50X3R5cGU9PSJ2aWRlbyImJiFtZXNzYWdlLm5vZGVzW2ldLnBhcnRfb2ZfZm9ybSl7CiAgICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgIHRpbWU6IG51bGwsCiAgICAgICAgICAgIHJlY2VpdmVkOiAnPGlmcmFtZSB3aWR0aD0iMjEwcHgiIGhlaWdodD0iMTQwcHgiIHNyYz0iJyttZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQudmlkZW8rJyI8L2lmcmFtZT4nLAogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmKG1lc3NhZ2Uubm9kZXNbaV0ubm9kZV90eXBlPT0ibm9kZSImJm1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5lbGVtZW50X3R5cGU9PSJtZXNzYWdlIiYmIW1lc3NhZ2Uubm9kZXNbaV0ucGFydF9vZl9mb3JtKXsKICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgdGltZTogbnVsbCwKICAgICAgICAgICAgcmVjZWl2ZWQ6IG1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5tZXNzYWdlLAogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmKG1lc3NhZ2Uubm9kZXNbaV0ubm9kZV90eXBlPT0ibm9kZSIpewogICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgdGltZTogbnVsbCwKICAgICAgICAgICAgcmVjZWl2ZWQ6ICcnLAogICAgICAgICAgfQogICAgICAgICAgdmFyIGZvcm09Jzxmb3JtIGlkPSInK21lc3NhZ2Uubm9kZXNbaV0uZm9ybV9uYW1lLnJlcGxhY2UoJyAnLCdfJykrJyI+JzsKICAgICAgICAgIHdoaWxlKG1lc3NhZ2Uubm9kZXNbaV0ucGFydF9vZl9mb3JtKXsKICAgICAgICAgICAgLy8gZm9ybT1mb3JtKyc8YnI+JwogICAgICAgICAgICBpZihtZXNzYWdlLm5vZGVzW2ldLm5vZGVfdHlwZT09Im5vZGUiJiZtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQuZWxlbWVudF90eXBlPT0idGV4dF9ib3giKXsKICAgICAgICAgICAgICBmb3JtPWZvcm0rJzxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAiPic7CiAgICAgICAgICAgICAgZm9ybT1mb3JtKyc8cCBzdHlsZT0ibWFyZ2luLWJvdHRvbTowcHg7Zm9udC13ZWlnaHQ6NDUwO2ZvbnQtc2l6ZToxNXB4OyI+JyttZXNzYWdlLm5vZGVzW2ldLmhlYWRlcisnPC9wPic7CiAgICAgICAgICAgICAgZm9ybT1mb3JtKyc8aW5wdXQgbmFtZT0iJyttZXNzYWdlLm5vZGVzW2ldLmhlYWRlcisnIiBjbGFzcz0iZm9ybS1jb250cm9sIiBzdHlsZT0icGFkZGluZy1sZWZ0OjEwcHggIWltcG9ydGFudCIgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9IicrbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LnBsYWNlaG9sZGVyKycibmFtZT0iY2xvc2VkX2JvdF9ub2RlXycraSsnIj4nOwogICAgICAgICAgICAgIGZvcm09Zm9ybSsnPC9kaXY+JzsKCiAgICAgICAgICAgIH0gZWxzZSBpZihtZXNzYWdlLm5vZGVzW2ldLm5vZGVfdHlwZT09Im5vZGUiJiZtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQuZWxlbWVudF90eXBlPT0iZHJvcGRvd24iKXsKICAgICAgICAgICAgICBmb3JtPWZvcm0rJzxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAiPic7CiAgICAgICAgICAgICAgZm9ybT1mb3JtKyc8cCBzdHlsZT0ibWFyZ2luLWJvdHRvbTowcHg7Zm9udC13ZWlnaHQ6NDUwO2ZvbnQtc2l6ZToxNXB4OyI+JyttZXNzYWdlLm5vZGVzW2ldLmhlYWRlcisnPC9wPic7CiAgICAgICAgICAgICAgZm9ybT1mb3JtKyc8c2VsZWN0IG5hbWU9IicrbWVzc2FnZS5ub2Rlc1tpXS5oZWFkZXIrJyIgY2xhc3M9ImZvcm0tY29udHJvbCIgPicKICAgICAgICAgICAgICBmb3IobGV0IGo9MDtqPG1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5kcm9wZG93bi5sZW5ndGg7aisrKXsKICAgICAgICAgICAgICAgIGZvcm09Zm9ybSsnPG9wdGlvbj4nK21lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5kcm9wZG93bltqXS50aXRsZSsnPC9vcHRpb24+JzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9ybT1mb3JtKyc8L3NlbGVjdD4nOwogICAgICAgICAgICAgIGZvcm09Zm9ybSsnPC9kaXY+JzsKICAgICAgICAgICAgfSBlbHNlIGlmKG1lc3NhZ2Uubm9kZXNbaV0ubm9kZV90eXBlPT0ibm9kZSImJm1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5lbGVtZW50X3R5cGU9PSJjaGVja19ib3giKXsKICAgICAgICAgICAgICBmb3JtPWZvcm0rJzxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAiPic7CiAgICAgICAgICAgICAgZm9ybT1mb3JtKyc8cCBzdHlsZT0ibWFyZ2luLWJvdHRvbTowcHg7Zm9udC13ZWlnaHQ6NDUwO2ZvbnQtc2l6ZToxNXB4OyI+JyttZXNzYWdlLm5vZGVzW2ldLmhlYWRlcisnPC9wPic7CiAgICAgICAgICAgICAgZm9yKGxldCBqPTA7ajxtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQudmFsdWVzLmxlbmd0aDtqKyspewogICAgICAgICAgICAgICAgZm9ybT1mb3JtKyc8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5hbWU9IicrbWVzc2FnZS5ub2Rlc1tpXS5oZWFkZXIrJyIgdmFsdWU9IicrbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LnZhbHVlc1tqXS50aXRsZSsnIj4nK21lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC52YWx1ZXNbal0udGl0bGUrJzxicj4nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3JtPWZvcm0rJzwvZGl2Pic7CiAgICAgICAgICAgIH0gZWxzZSBpZihtZXNzYWdlLm5vZGVzW2ldLm5vZGVfdHlwZT09Im5vZGUiJiZtZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQuZWxlbWVudF90eXBlPT0icmFkaW9fYnV0dG9ucyIpewogICAgICAgICAgICAgIGZvcm09Zm9ybSsnPGRpdiBjbGFzcz0iZm9ybS1ncm91cCI+JzsKICAgICAgICAgICAgICBmb3JtPWZvcm0rJzxwIHN0eWxlPSJtYXJnaW4tYm90dG9tOjBweDtmb250LXdlaWdodDo0NTA7Zm9udC1zaXplOjE1cHg7Ij4nK21lc3NhZ2Uubm9kZXNbaV0uaGVhZGVyKyc8L3A+JzsKICAgICAgICAgICAgICBmb3IobGV0IGo9MDtqPG1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5yYWRpb19idXR0b25zLmxlbmd0aDtqKyspewogICAgICAgICAgICAgICAgZm9ybT1mb3JtKyc8aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9IicrbWVzc2FnZS5ub2Rlc1tpXS5oZWFkZXIrJyIgdmFsdWU9IicrbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LnJhZGlvX2J1dHRvbnNbal0udGl0bGUrJyI+JyttZXNzYWdlLm5vZGVzW2ldLnVpX2VsZW1lbnQucmFkaW9fYnV0dG9uc1tqXS50aXRsZSsnPGJyPic7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvcm09Zm9ybSsnPC9kaXY+JzsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBmb3JtPWZvcm0rJzxicj4nCiAgICAgICAgICAgIGkrKwogICAgICAgICAgfQogICAgICAgICAgaS0tOwogICAgICAgICAgZm9ybSA9IGZvcm0rJzxidXR0b24gdHlwZT0ic3VibWl0IiBjbGFzcz0iYnRuIGJ0bi1wcmltYXJ5Ij5TdWJtaXQ8L2J1dHRvbj48L2Zvcm0+JwogICAgICAgICAgdGhpcy5pc2Zvcm1vbj10cnVlOwogICAgICAgICAgdGhpcy5mb3JtX25hbWU9bWVzc2FnZS5ub2Rlc1tpXS5mb3JtX25hbWUucmVwbGFjZSgnICcsJ18nKTsKICAgICAgICAgIG1zZy5yZWNlaXZlZD1mb3JtOwogICAgICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgICAgIHRoaXMuc3VibWl0X2Nsb3NlZF9mb3JtX2RhdGEoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgIHJlY2VpdmVkOiBudWxsLAogICAgICAgIH0pOwogICAgICAgIGlmKG1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5lbGVtZW50X3R5cGUhPSdtZXNzYWdlJyYmbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LmVsZW1lbnRfdHlwZSE9J2ltYWdlJyYmbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LmVsZW1lbnRfdHlwZSE9J3ZpZGVvJyYmbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50LmVsZW1lbnRfdHlwZSE9J2J1dHRvbicmJm1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5lbGVtZW50X3R5cGUhPSdoeXBlcmxpbmsnKXsKICAgICAgICAgIHRoaXMubGFzdGNsb3NlZGJvdGlucHV0bm9kZT10aGlzLmNoYXQubGVuZ3RoLTE7CiAgICAgICAgICB0aGlzLnNlbGVjdGVkbm9kZWlkPW1lc3NhZ2Uubm9kZXNbaV07CiAgICAgICAgfQogICAgICAgIGlmKG1lc3NhZ2Uubm9kZXNbaV0udWlfZWxlbWVudC5lbGVtZW50X3R5cGU9PSdidXR0b24nKXsKICAgICAgICAgIHRoaXMubGFzdGNsb3NlZGJvdGlucHV0bm9kZT10aGlzLmNoYXQubGVuZ3RoLTI7CiAgICAgICAgICB0aGlzLnNlbGVjdGVkbm9kZWlkPW1lc3NhZ2Uubm9kZXNbaV07CiAgICAgICAgfQogICAgICAgIGlmKG1lc3NhZ2Uubm9kZXNbaV0uaXNfbGVhZil7CiAgICAgICAgICB0aGlzLmlzY2xvc2VkYm90b249ZmFsc2U7CiAgICAgICAgICB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQ9ZmFsc2U7CiAgICAgICAgICB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQ9dHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgICB2bS50b19zY3JvbGwgPSB0cnVlOwogICAgICAgIGlmICgKICAgICAgICAgICQoIi5jaGF0LWJvZHkiKQogICAgICAgICAgICAuY2hpbGRyZW4oKQogICAgICAgICAgICAubGFzdCgpCiAgICAgICAgICAgIC5oZWlnaHQoKSAvCiAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA8CiAgICAgICAgICAwLjUKICAgICAgICApIHsKICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5hbmltYXRlKAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc2Nyb2xsVG9wOiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikKICAgICAgICAgICAgfSwKICAgICAgICAgICAgMTUwMAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgJCgiLnJlY2VpdmVyIikKICAgICAgICAgICAgLmxhc3QoKQogICAgICAgICAgICAucGFyZW50KCkKICAgICAgICAgICAgLmhlaWdodCgpIC8KICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpID4KICAgICAgICAgICAgMC41ICYmCiAgICAgICAgICAkKCIucmVjZWl2ZXIiKQogICAgICAgICAgICAubGFzdCgpCiAgICAgICAgICAgIC5wYXJlbnQoKQogICAgICAgICAgICAuaGVpZ2h0KCkgLwogICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPAogICAgICAgICAgICAwLjYKICAgICAgICApIHsKICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5hbmltYXRlKAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc2Nyb2xsVG9wOiAwLjkgKiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikKICAgICAgICAgICAgfSwKICAgICAgICAgICAgMTUwMAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmFuaW1hdGUoCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzY3JvbGxUb3A6IDAuNzUgKiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikKICAgICAgICAgICAgfSwKICAgICAgICAgICAgMTUwMAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYoJCgiLmNoYXQtYm9keSIpLnNjcm9sbFRvcCgpPT0wKXsKICAgICAgICAgIHRoaXMudG9fc2Nyb2xsPWZhbHNlOwogICAgICAgIH0KICAgICAgICAvLyBjb25zb2xlLmxvZygkKCdbbmFtZT0nK3ZtLm5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIrJ10nKSkKICAgICAgICBpZih2bS5uYW1lX2VsZW1lbnRfZm9yX2V2ZW50X2xpc3RlbmVyICE9IG51bGwpewogICAgICAgICAgJCgnW25hbWU9Jyt2bS5uYW1lX2VsZW1lbnRfZm9yX2V2ZW50X2xpc3RlbmVyKyddJylbMF0uYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCB2bS5hcHBlbmRfbWVzc2FnZV90b19jaGF0Ym94KQogICAgICAgIH0KICAgICAgfSwgMTAwMCk7CiAgICB9LAogICAgc3VibWl0X2Nsb3NlZF9mb3JtX2RhdGEodHlwZSxtZXNzYWdlKXsKICAgICAgLy8gZGVidWdnZXI7CiAgICAgIC8vIGNvbnNvbGUubG9nKHR5cGUsICdIZWxsbyBIYXJzaCcpOwogICAgICBpZiAoZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI2NoYXQiKyh0aGlzLmxhc3RjbG9zZWRib3RpbnB1dG5vZGUtMSkpICE9IG51bGwmJnR5cGU9PSdpc19idXR0b24nJiZtZXNzYWdlLnRpdGxlPT0iU3VibWl0Iil7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjY2hhdCIrKHRoaXMubGFzdGNsb3NlZGJvdGlucHV0bm9kZSsxKSk7CiAgICAgICAgdmFyIHF1ZXJ5U3RyaW5nID0gJCgiI2NoYXQiKyh0aGlzLmxhc3RjbG9zZWRib3RpbnB1dG5vZGUtMSkrIiA6aW5wdXQiKS5zZXJpYWxpemVBcnJheSgpOwogICAgICAgIGlmKHRoaXMuY2xvc2VkX2Zvcm1fcmVwbHlfZGF0YT09bnVsbCl7CiAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgICAgdGhpcy5jbG9zZWRfZm9ybV9yZXBseV9kYXRhPXt9OwogICAgICAgICAgZm9yICh2YXIgaSBpbiBxdWVyeVN0cmluZykgewogICAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGFbcXVlcnlTdHJpbmdbaV0ubmFtZV0gPSBxdWVyeVN0cmluZ1tpXS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgaW4gcXVlcnlTdHJpbmcpIHsKICAgICAgICAgICAgdGhpcy5jbG9zZWRfZm9ybV9yZXBseV9kYXRhLnF1ZXJ5U3RyaW5nW2ldLm5hbWUucHVzaChxdWVyeVN0cmluZ1tpXS52YWx1ZSk7OwogICAgICAgICAgfQogICAgICAgICAgYXhpb3MKICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNsb3NlZF9mb3JtX3Jlc3BvbnNlX2FwaSgpLHsKICAgICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgIHVpZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgIGNoYXQ6IHRoaXMuY2xvc2VkX2Zvcm1fcmVwbHlfZGF0YSwKICAgICAgICAgICAgICBub2RlX3NlbGVjdGVkOiB0aGlzLnNlbGVjdGVkbm9kZWlkLAogICAgICAgICAgICAgIGJvdF9uYW1lOiB0aGlzLmJvdF9uYW1lLAogICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9pZCA6IHRoaXMuY29udmVyc2F0aW9uX2lkLAogICAgICAgICAgICB9KQogICAgICAgICAgICAudGhlbihyZXNwb25zZT0+ewogICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGE9bnVsbDsKICAgICAgICAgICAgICB0aGlzLmNsb3NlZF9ib3RfY2hhdChyZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYodHlwZT09J2lzX2J1dHRvbicpewogICAgICAgIHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCA9IHRydWU7CiAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgc2VudDogbWVzc2FnZS50aXRsZSwKICAgICAgICAgIHNlbmRpbmc6IHRydWUsCiAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgZGVsaXZlcmVkOiB0cnVlLAogICAgICAgICAgZHJvcGRvd246ICIiCiAgICAgICAgfSk7CiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLnR5cGluZy1pbmRpY2F0b3IiKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNsb3NlZF9mb3JtX3Jlc3BvbnNlX2FwaSgpLHsKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdWlkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIGNoYXQ6IG1lc3NhZ2UudGl0bGUsCiAgICAgICAgICAgIC8vIG5vZGVfc2VsZWN0ZWQ6IHtub2RlX2lkOiBtZXNzYWdlLmlkfSwKICAgICAgICAgICAgbm9kZV9zZWxlY3RlZDogIG1lc3NhZ2Uubm9kZSwKICAgICAgICAgICAgY29udmVyc2F0aW9uX2lkIDogdGhpcy5jb252ZXJzYXRpb25faWQsCiAgICAgICAgICAgIGJvdF9uYW1lOiB0aGlzLmJvdF9uYW1lLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKHJlc3BvbnNlPT57CiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgdGhpcy5jbG9zZWRfZm9ybV9yZXBseV9kYXRhPW51bGw7CiAgICAgICAgICAgIHRoaXMuY2xvc2VkX2JvdF9jaGF0KHJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZih0eXBlPT11bmRlZmluZWQmJiF0aGlzLmlzZm9ybW9uICYmICF0aGlzLmlzZW1haWwgJiYhdGhpcy5pc19waG9uZV9udW1iZXIgJiYgdGhpcy5pc190ZXh0X2FyZWEpewogICAgICAgIHRoaXMuZGlzYWJsZV9uYW1lX2VsZW1lbnRfZm9yX2V2ZW50X2xpc3RlbmVyKCk7CiAgICAgICAgLy8gJCgnW25hbWU9Jyt0aGlzLm5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIrJ10nKS5hdHRyKCJkaXNhYmxlZCIsICdkaXNhYmxlZCcpCiAgICAgICAgLy8gdGhpcy5uYW1lX2VsZW1lbnRfZm9yX2V2ZW50X2xpc3RlbmVyID0gbnVsbDsKICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNjaGF0IisodGhpcy5sYXN0Y2xvc2VkYm90aW5wdXRub2RlKzEpKTsKICAgICAgICB2YXIgcXVlcnlTdHJpbmcgPSAkKCIjY2hhdCIrKHRoaXMubGFzdGNsb3NlZGJvdGlucHV0bm9kZS0xKSsiIDppbnB1dCIpLnNlcmlhbGl6ZUFycmF5KCk7CiAgICAgICAgaWYodGhpcy5jbG9zZWRfZm9ybV9yZXBseV9kYXRhPT1udWxsKXsKICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGE9e307CiAgICAgICAgICBmb3IgKHZhciBpIGluIHF1ZXJ5U3RyaW5nKSB7CiAgICAgICAgICAgIHRoaXMuY2xvc2VkX2Zvcm1fcmVwbHlfZGF0YVtxdWVyeVN0cmluZ1tpXS5uYW1lXSA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaSBpbiBxdWVyeVN0cmluZykgewogICAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGFbcXVlcnlTdHJpbmdbaV0ubmFtZV0ucHVzaChxdWVyeVN0cmluZ1tpXS52YWx1ZSk7OwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICBzZW50OiB0aGlzLnRvX3NlbmQsCiAgICAgICAgICAgIHNlbmRpbmc6IHRydWUsCiAgICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgZGVsaXZlcmVkOiB0cnVlLAogICAgICAgICAgICBkcm9wZG93bjogIiIKICAgICAgICAgIH0pOwogICAgICAgICAgYXhpb3MKICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNsb3NlZF9mb3JtX3Jlc3BvbnNlX2FwaSgpLHsKICAgICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgIHVpZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgIGNoYXQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgICAgICBub2RlX3NlbGVjdGVkOiB0aGlzLnNlbGVjdGVkbm9kZWlkLAogICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9pZCA6IHRoaXMuY29udmVyc2F0aW9uX2lkLAogICAgICAgICAgICAgIGJvdF9uYW1lOiB0aGlzLmJvdF9uYW1lLAogICAgICAgICAgICB9KQogICAgICAgICAgICAudGhlbihyZXNwb25zZT0+ewogICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGE9bnVsbDsKICAgICAgICAgICAgICB0aGlzLmNsb3NlZF9ib3RfY2hhdChyZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYodHlwZT09dW5kZWZpbmVkJiZ0aGlzLmlzZm9ybW9uICYmICF0aGlzLmlzZW1haWwgJiYhdGhpcy5pc19waG9uZV9udW1iZXIpewogICAgICAgIGlmKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiMiK3RoaXMuZm9ybV9uYW1lKSE9bnVsbCl7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiMiK3RoaXMuZm9ybV9uYW1lKTsKICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigic3VibWl0IiwgZXZlbnQgPT4gewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB2YXIgcXVlcnlTdHJpbmcgPSAkKCIjIit0aGlzLmZvcm1fbmFtZSkuc2VyaWFsaXplQXJyYXkoKTsKICAgICAgICAgICAgaWYgKHRoaXMuY2xvc2VkX2Zvcm1fcmVwbHlfZGF0YSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLnR5cGluZy1pbmRpY2F0b3IiKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGEgPSB7fTsKICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIHF1ZXJ5U3RyaW5nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGFbcXVlcnlTdHJpbmdbaV0ubmFtZV0gPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBxdWVyeVN0cmluZykgewogICAgICAgICAgICAgICAgdGhpcy5jbG9zZWRfZm9ybV9yZXBseV9kYXRhW3F1ZXJ5U3RyaW5nW2ldLm5hbWVdLnB1c2gocXVlcnlTdHJpbmdbaV0udmFsdWUpOzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jbG9zZWRfZm9ybV9yZXNwb25zZV9hcGkoKSx7CiAgICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICAgIHVpZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgICBjaGF0OiB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGEsCiAgICAgICAgICAgICAgICAgIG5vZGVfc2VsZWN0ZWQ6IHRoaXMuc2VsZWN0ZWRub2RlaWQsCiAgICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9pZCA6IHRoaXMuY29udmVyc2F0aW9uX2lkLAogICAgICAgICAgICAgICAgICBib3RfbmFtZTogdGhpcy5ib3RfbmFtZSwKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAudGhlbihyZXNwb25zZT0+ewogICAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICAgICAgICAgICQoIiMiK3RoaXMuZm9ybV9uYW1lKyIgOmlucHV0IikucHJvcCgiZGlzYWJsZWQiLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coIiMiK3RoaXMuZm9ybV9uYW1lKyI6aW5wdXQiKTsKICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZWRfZm9ybV9yZXBseV9kYXRhPW51bGw7CiAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VkX2JvdF9jaGF0KHJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmKHR5cGU9PXVuZGVmaW5lZCYmdGhpcy5pc2VtYWlsKXsKICAgICAgICAvLyBhbGVydCh0aGlzLnRvX3NlbmQpOwogICAgICAgIGlmKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNjaGF0IisodGhpcy5sYXN0Y2xvc2VkYm90aW5wdXRub2RlLTEpKSAhPSBudWxsKXsKICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgIHNlbnQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgIHNlbmRpbmc6IHRydWUsCiAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgZGVsaXZlcmVkOiB0cnVlLAogICAgICAgICAgZHJvcGRvd246ICIiCiAgICAgICAgfSk7CgogICAgICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjY2hhdCIrKHRoaXMubGFzdGNsb3NlZGJvdGlucHV0bm9kZSsxKSk7CiAgICAgICAgICB2YXIgcXVlcnlTdHJpbmcgPSAkKCIjY2hhdCIrKHRoaXMubGFzdGNsb3NlZGJvdGlucHV0bm9kZS0xKSsiIDppbnB1dCIpLnNlcmlhbGl6ZUFycmF5KCk7CiAgICAgICAgICB2YXIgeCA9IHRoaXMubGFzdGNsb3NlZGJvdGlucHV0bm9kZS0xCiAgICAgICAgICAvLyBpZih0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGE9PW51bGwpewogICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGE9e307CiAgICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNsb3NlZF9mb3JtX3Jlc3BvbnNlX2FwaSgpLHsKICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICB1aWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgIGNoYXQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgICAgICAgIG5vZGVfc2VsZWN0ZWQ6IHRoaXMuc2VsZWN0ZWRub2RlaWQsCiAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25faWQgOiB0aGlzLmNvbnZlcnNhdGlvbl9pZCwKICAgICAgICAgICAgICAgIGJvdF9uYW1lOiB0aGlzLmJvdF9uYW1lLAogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2U9PnsKICAgICAgICAgICAgICAgIHZhciBlcnJvcl92YXJpYWJsZSA9IG51bGw7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHJlc3BvbnNlLmRhdGEubm9kZXMubGVuZ3RoIC0gMSA7IGkgKz0gMSl7CiAgICAgICAgICAgICAgICAgICAgIGlmKHJlc3BvbnNlLmRhdGEubm9kZXNbaV0udmFsaWRhdGlvbl9zdWNjZXNzZnVsICE9IHVuZGVmaW5lZCAmJiAgcmVzcG9uc2UuZGF0YS5ub2Rlc1tpXS52YWxpZGF0aW9uX3N1Y2Nlc3NmdWwgPT0gZmFsc2UgKXsKICAgICAgICAgICAgICAgICAgICAgICBlcnJvcl92YXJpYWJsZSA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICByZWNlaXZlZDogcmVzcG9uc2UuZGF0YS5ub2Rlc1tpXS51aV9lbGVtZW50LmVycm9yX21zZywKICAgICAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWU6IG51bGwKICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgIGlmKGVycm9yX3ZhcmlhYmxlID09IG51bGwpewogICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGE9bnVsbDsKICAgICAgICAgICAgICAgICAgdGhpcy5pc2VtYWlsID0gZmFsc2UKICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZWRfYm90X2NoYXQocmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH1lbHNlIGlmKHR5cGU9PXVuZGVmaW5lZCYmdGhpcy5pc19waG9uZV9udW1iZXIpewogICAgICAgIGlmKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNjaGF0IisodGhpcy5sYXN0Y2xvc2VkYm90aW5wdXRub2RlLTEpKSAhPSBudWxsKXsKICAgICAgICAgIGlmKHRoaXMuaXNfcGhvbmVfbnVtYmVyX290cCA9PSB0cnVlKXsKICAgICAgICAgICAgdmFyIGR0cyA9IHRoaXMudG9fc2VuZDsKICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICAgIHNlbnQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgICAgICBzZW5kaW5nOiB0cnVlLAogICAgICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgIGRlbGl2ZXJlZDogdHJ1ZSwKICAgICAgICAgICAgICBkcm9wZG93bjogIiIKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmxhc3RjbG9zZWRib3RpbnB1dG5vZGUpOwogICAgICAgICAgICAgIGlmKHRoaXMuaXNfcGhvbmVfbnVtYmVyX2Vycl9tc2cpewogICAgICAgICAgICAgIHZhciB4ID0gJCgiI2NoYXQiKyh0aGlzLmxhc3RjbG9zZWRib3RpbnB1dG5vZGUtMSkrIiA6aW5wdXQiKS5zZXJpYWxpemVBcnJheSgpOwogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJpZiBsb29wIik7CiAgICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy5sYXN0Y2xvc2VkYm90aW5wdXRub2RlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgY29uc29sZS5sb2coImVsc2UgbG9vcCIpOwogICAgICAgICAgICAgIHZhciB4ID0gJCgiI2NoYXQiKyh0aGlzLmxhc3RjbG9zZWRib3RpbnB1dG5vZGUtMSkrIiA6aW5wdXQiKS5zZXJpYWxpemVBcnJheSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zb2xlLmxvZyh4KTsKICAgICAgICAgICAgICB2YXIgZHRzID0geFswXS52YWx1ZSArIHhbMV0udmFsdWU7CiAgICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICAgIHNlbnQ6IGR0cywKICAgICAgICAgICAgICBzZW5kaW5nOiB0cnVlLAogICAgICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgIGRlbGl2ZXJlZDogdHJ1ZSwKICAgICAgICAgICAgICBkcm9wZG93bjogIiIKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyB0aGlzLmRpc2FibGVfbmFtZV9lbGVtZW50X2Zvcl9ldmVudF9saXN0ZW5lcigpOwogICAgICAgICAgLy8gdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjY2hhdCIrKHRoaXMubGFzdGNsb3NlZGJvdGlucHV0bm9kZSsxKSk7CiAgICAgICAgICAvLyB2YXIgcXVlcnlTdHJpbmcgPSAkKCIjY2hhdCIrKHRoaXMubGFzdGNsb3NlZGJvdGlucHV0bm9kZS0xKSsiIDppbnB1dCIpLnNlcmlhbGl6ZUFycmF5KCk7CiAgICAgICAgICAvLyBpZih0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGE9PW51bGwpewogICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudHlwaW5nLWluZGljYXRvciIpLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGE9e307CiAgICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNsb3NlZF9mb3JtX3Jlc3BvbnNlX2FwaSgpLHsKICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICB1aWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgIGNoYXQ6ZHRzLAogICAgICAgICAgICAgICAgbm9kZV9zZWxlY3RlZDogdGhpcy5zZWxlY3RlZG5vZGVpZCwKICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9pZCA6IHRoaXMuY29udmVyc2F0aW9uX2lkLAogICAgICAgICAgICAgICAgYm90X25hbWU6IHRoaXMuYm90X25hbWUsCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAudGhlbihyZXNwb25zZT0+ewogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2codGhpcy5jaGF0KTsKICAgICAgICAgICAgICAgIHRoaXMudG9fc2VuZCA9ICIiOwogICAgICAgICAgICAgICAgdmFyIGVycm9yX3ZhcmlhYmxlID0gbnVsbDsKICAgICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgICAgIGZvcihsZXQgaT0wOyBpPHJlc3BvbnNlLmRhdGEubm9kZXMubGVuZ3RoIC0gMSA7IGkgKz0gMSl7CiAgICAgICAgICAgICAgICAgICAgIGlmKHJlc3BvbnNlLmRhdGEubm9kZXNbaV0udWlfZWxlbWVudC52YWxpZGF0ZSA9PSAicGhvbmVfbnVtYmVyIiAmJiByZXNwb25zZS5kYXRhLm5vZGVzW2ldLnZhbGlkYXRpb25fc3VjY2Vzc2Z1bCAhPSB1bmRlZmluZWQgJiYgIHJlc3BvbnNlLmRhdGEubm9kZXNbaV0udmFsaWRhdGlvbl9zdWNjZXNzZnVsID09IGZhbHNlICl7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlzX3Bob25lX251bWJlcl9lcnJfbXNnID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VkX2Zvcm1fcmVwbHlfZGF0YT1udWxsOwogICAgICAgICAgICAgICAgICAgICAgIGVycm9yX3ZhcmlhYmxlID0gaTsKICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgICAgICAgICAgIC8vICB0aGlzLnNlbGVjdGVkbm9kZWlkID0gcmVzcG9uc2UuZGF0YS5ub2RlczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlY2VpdmVkOiByZXNwb25zZS5kYXRhLm5vZGVzW2ldLnVpX2VsZW1lbnQuZXJyb3JfbXNnLAogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdGltZTogbnVsbAogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgdGltZTogbnVsbCwKICAgICAgICAgICAgICAgICAgICByZWNlaXZlZDogJzxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleCI+IDxzZWxlY3QgbmFtZT0iY291bnRyeWNvZGUiIGNsYXNzPSJmb3JtLWNvbnRyb2wiIHN0eWxlPSJwYWRkaW5nLWxlZnQ6NnB4ICFpbXBvcnRhbnQ7cGFkZGluZy1yaWdodDo2cHggIWltcG9ydGFudDsgd2lkdGg6NDAlO2hlaWdodDo1MHB4ICFpbXBvcnRhbnQ7IiAgPicsCiAgICAgICAgICAgICAgICAgICAgLy8gcmVjZWl2ZWQ6ICcnLAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJyZWFjaGVkIGhlcmUiKQogICAgICAgICAgICAgICAgICAvLyB2YXIgZHJvcGRvd24gPSBbXTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc2FibGVfbmFtZV9lbGVtZW50X2Zvcl9ldmVudF9saXN0ZW5lcigpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBDb3VudHJ5Q29kZXM7CiAgICAgICAgICAgICAgICAgICAgbGV0IG9wdGlvbjsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpOwogICAgICAgICAgICAgICAgICAgICAgLy8gb3B0aW9uLnRleHQgPSBkYXRhW2ldLmNvdW50cnlfY29kZTsKICAgICAgICAgICAgICAgICAgICAgIC8vIG9wdGlvbi52YWx1ZSA9IGRhdGFbaV0uY2FsbGluZ19jb2RlOwogICAgICAgICAgICAgICAgICAgICAgLy8gLy8gZHJvcGRvd24uYWRkKG9wdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAvLyBtc2cucmVjZWl2ZWQ9bXNnLnJlY2VpdmVkICsgb3B0aW9uOwogICAgICAgICAgICAgICAgICAgICAgbXNnLnJlY2VpdmVkPSBtc2cucmVjZWl2ZWQrJzxvcHRpb24gdmFsdWU9ICcrZGF0YVtpXS5kaWFsX2NvZGUrJz4nK2RhdGFbaV0uY29kZSArICIoIisgZGF0YVtpXS5kaWFsX2NvZGUgKyIpIiArICc8L29wdGlvbj4nCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG1zZy5yZWNlaXZlZD1tc2cucmVjZWl2ZWQrJzwvc2VsZWN0Pic7CiAgICAgICAgICAgICAgICAgICAgbXNnLnJlY2VpdmVkID0gbXNnLnJlY2VpdmVkICsgJzxpbnB1dCB0eXBlPSJ0ZXh0IiBjbGFzcz0iZm9ybS1jb250cm9sIiBzdHlsZT0icGFkZGluZy1sZWZ0OjEycHggIWltcG9ydGFudDsgaGVpZ2h0OjUwcHggIWltcG9ydGFudDsiIGF1dG9jb21wbGV0ZT0ib2ZmIiBuYW1lPSJwaG9uZW51bWJlciIgaWQ9ICJwaG9uZW51bWJlciIgbmFtZT0iY2xvc2VkX2JvdF9ub2RlXycraSsnIj4gIDwvZGl2PicKICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhtc2cpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICAgICAgICAgIC8vIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgICAgICAgLy8gcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgICAgICAvLyByZWNlaXZlZDogbWVzc2FnZS5ub2Rlc1tpXS51aV9lbGVtZW50Lm1lc3NhZ2UsCiAgICAgICAgICAgICAgICAgIC8vIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgICAgICAvLyB0aW1lOiBudWxsCiAgICAgICAgICAgICAgICAgIC8vIH0pOwogICAgICAgICAgICAgICAgICAvLyB0aGlzLmRpc2FibGVfbmFtZV9lbGVtZW50X2Zvcl9ldmVudF9saXN0ZW5lcigpOwoKICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGlmKHRoaXMubmFtZV9lbGVtZW50X2Zvcl9ldmVudF9saXN0ZW5lciE9IG51bGwpewogICAgICAgICAgICAgICAgICAgICQoJ1tuYW1lPScrdGhpcy5uYW1lX2VsZW1lbnRfZm9yX2V2ZW50X2xpc3RlbmVyKyddJykub2ZmKCdrZXl1cCcsIHZtLmFwcGVuZF9tZXNzYWdlX3RvX2NoYXRib3gpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdGhpcy5uYW1lX2VsZW1lbnRfZm9yX2V2ZW50X2xpc3RlbmVyID0gInBob25lbnVtYmVyIjsKICAgICAgICAgICAgICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgICAgICAgICAgICAgdGhpcy5sYXN0Y2xvc2VkYm90aW5wdXRub2RlPXRoaXMuY2hhdC5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMubGFzdGNsb3NlZGJvdGlucHV0bm9kZSk7CiAgICAgICAgICAgICAgICAgIHZhciBsZW4gPSAkKCdbbmFtZT0nK3ZtLm5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIrJ10nKS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIGlmKHZtLm5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIgIT0gbnVsbCl7CiAgICAgICAgICAgICAgICAgICAgLy8gICBjb25zb2xlLmxvZygkKCdbbmFtZT0nK3ZtLm5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIrJ10nKSkKICAgICAgICAgICAgICAgICAgICAvLyAgIGlmKCQoJ1tuYW1lPScrdm0ubmFtZV9lbGVtZW50X2Zvcl9ldmVudF9saXN0ZW5lcisnXScpLmxlbmd0aD4xKXsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgICBjb25zb2xlLmxvZygkKCdbbmFtZT0nK3ZtLm5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIrJ10nKVtsZW5dKQogICAgICAgICAgICAgICAgICAgICAgICAgICQoJ1tuYW1lPScrdm0ubmFtZV9lbGVtZW50X2Zvcl9ldmVudF9saXN0ZW5lcisnXScpW2xlbl0uYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCB2bS5hcHBlbmRfbWVzc2FnZV90b19jaGF0Ym94KQogICAgICAgICAgICAgICAgICAgICAgLy8gfWVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAkKCdbbmFtZT0nK3ZtLm5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIrJ10nKVswXS5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIHZtLmFwcGVuZF9tZXNzYWdlX3RvX2NoYXRib3gpCiAgICAgICAgICAgICAgICAgICAgICAvLyB9CiAgICAgICAgICAgICAgICAgICAgLy8gfQogICAgICAgICAgICAgICAgICB9LCAyMDAwKTsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihyZXNwb25zZS5kYXRhLm5vZGVzW2ldLnVpX2VsZW1lbnQudmFsaWRhdGUgIT0gdW5kZWZpbmVkICYmICByZXNwb25zZS5kYXRhLm5vZGVzW2ldLnVpX2VsZW1lbnQudmFsaWRhdGUgPT0gIm90cCIgJiYgcmVzcG9uc2UuZGF0YS5ub2Rlc1tpXS52YWxpZGF0aW9uX3N1Y2Nlc3NmdWwgPT0gdHJ1ZSApewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGE9bnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZG5vZGVpZCA9IHJlc3BvbnNlLmRhdGEubm9kZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yX3ZhcmlhYmxlID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pc19waG9uZV9udW1iZXJfb3RwID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlY2VpdmVkOiByZXNwb25zZS5kYXRhLm5vZGVzW2ldLnVpX2VsZW1lbnQub3RwX3F1ZXN0aW9uX2xhYmVsLAogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdGltZTogbnVsbAogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihyZXNwb25zZS5kYXRhLm5vZGVzW2ldLnVpX2VsZW1lbnQudmFsaWRhdGUgIT0gdW5kZWZpbmVkICYmIHJlc3BvbnNlLmRhdGEubm9kZXNbaV0udWlfZWxlbWVudC52YWxpZGF0ZSA9PSAib3RwIiAmJiByZXNwb25zZS5kYXRhLm5vZGVzW2ldLnZhbGlkYXRpb25fc3VjY2Vzc2Z1bCA9PSBmYWxzZSAgKXsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZWRfZm9ybV9yZXBseV9kYXRhPW51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRub2RlaWQgPSByZXNwb25zZS5kYXRhLm5vZGVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcl92YXJpYWJsZSA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICByZWNlaXZlZDogcmVzcG9uc2UuZGF0YS5ub2Rlc1tpXS51aV9lbGVtZW50LmluY29ycmVjdF9vdHBfbXNnLAogICAgICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgdGltZTogbnVsbAogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygicmVhY2hlZCBoZXJlMiIpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKGVycm9yX3ZhcmlhYmxlID09IG51bGwpewogICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGE9bnVsbDsKICAgICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlX25hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIoKTsKICAgICAgICAgICAgICAgICAgLy8gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc19waG9uZV9udW1iZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgLy8gfSwgMSk7CiAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VkX2JvdF9jaGF0KHJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgLy8gfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmKHR5cGU9PXVuZGVmaW5lZCYmIXRoaXMuaXNmb3Jtb24gJiYgIXRoaXMuaXNlbWFpbCAmJiF0aGlzLmlzX3Bob25lX251bWJlciAmJiAhdGhpcy5pc190ZXh0X2FyZWEpewogICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICBzZW50OiB0aGlzLnRvX3NlbmQsCiAgICAgICAgICBzZW5kaW5nOiB0cnVlLAogICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIGRlbGl2ZXJlZDogdHJ1ZSwKICAgICAgICAgIGRyb3Bkb3duOiAiIgogICAgICAgIH0pOwogICAgICAgICAgYXhpb3MKICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNsb3NlZF9mb3JtX3Jlc3BvbnNlX2FwaSgpLHsKICAgICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgIHVpZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgIGNoYXQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgICAgICBub2RlX3NlbGVjdGVkOiB0aGlzLnNlbGVjdGVkbm9kZWlkLAogICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9pZCA6IHRoaXMuY29udmVyc2F0aW9uX2lkLAogICAgICAgICAgICAgIGJvdF9uYW1lOiB0aGlzLmJvdF9uYW1lLAogICAgICAgICAgICB9KQogICAgICAgICAgICAudGhlbihyZXNwb25zZT0+ewogICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi50eXBpbmctaW5kaWNhdG9yIikuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgICB0aGlzLmNsb3NlZF9mb3JtX3JlcGx5X2RhdGE9bnVsbDsKICAgICAgICAgICAgICB0aGlzLmNsb3NlZF9ib3RfY2hhdChyZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICBnZXRkYXRhKCl7CiAgICAgIGlmKCF0aGlzLmlzZm9ybW9uICYmICF0aGlzLmlzX3Bob25lX251bWJlcil7CiAgICAgICAgdmFyIHF1ZXJ5U3RyaW5nID0gJCgiI2NoYXQiKyh0aGlzLmxhc3RjbG9zZWRib3RpbnB1dG5vZGUtMSkrIiA6aW5wdXQiKS5zZXJpYWxpemVBcnJheSgpOwogICAgICAgIHRoaXMudG9fc2VuZD0nJzsKICAgICAgICBmb3IobGV0IGk9MDtpPHF1ZXJ5U3RyaW5nLmxlbmd0aDtpKyspewogICAgICAgICAgaWYoaT09MCl7CiAgICAgICAgICAgIHRoaXMudG9fc2VuZD1xdWVyeVN0cmluZ1tpXS52YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudG9fc2VuZD10aGlzLnRvX3NlbmQgKyAiLCIgKyBxdWVyeVN0cmluZ1tpXS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5idXR0b25fZmlsbCgpOwogICAgfSwKICAgIGFwcGVuZF9tZXNzYWdlX3RvX2NoYXRib3goKXsKICAgICAgY29uc29sZS5sb2codGhpcy5uYW1lX2VsZW1lbnRfZm9yX2V2ZW50X2xpc3RlbmVyLCB0aGlzLmlzX3Bob25lX251bWJlcik7CiAgICAgIAogICAgICBjb25zb2xlLmxvZygkKCdbbmFtZT0nK3RoaXMubmFtZV9lbGVtZW50X2Zvcl9ldmVudF9saXN0ZW5lcisnXScpKTsKICAgICAgaWYodGhpcy5pc190ZXh0X2FyZWEpewogICAgICAgIHRoaXMudG9fc2VuZCA9ICQoJ1tuYW1lPScrdGhpcy5uYW1lX2VsZW1lbnRfZm9yX2V2ZW50X2xpc3RlbmVyKyddJylbMF0udmFsdWU7CiAgICAgICAgdGhpcy5idXR0b25fZmlsbCgpOwogICAgICB9CiAgICAgIGlmKHRoaXMuaXNfcGhvbmVfbnVtYmVyKXsKICAgICAgICB2YXIgbGVuID0gJCgnW25hbWU9Jyt0aGlzLm5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIrJ10nKS5sZW5ndGg7CiAgICAgICAgdGhpcy50b19zZW5kID0gJCgnW25hbWU9Jyt0aGlzLm5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIrJ10nKVtsZW4tMV0udmFsdWU7ICAgICAgCiAgICAgICAgfQogICAgfSwKICAgIGRpc2FibGVfbmFtZV9lbGVtZW50X2Zvcl9ldmVudF9saXN0ZW5lcigpewogICAgICAvLyBjb25zb2xlLmxvZygiV2UgYXJlIGhlcmUgZGlzYWJsZWQgZnVuY3Rpb24iKQogICAgICAkKCdbbmFtZT0nK3RoaXMubmFtZV9lbGVtZW50X2Zvcl9ldmVudF9saXN0ZW5lcisnXScpLmF0dHIoImRpc2FibGVkIiwgJ2Rpc2FibGVkJykKICAgICAgICAvLyAkKCdbbmFtZT0nK3RoaXMubmFtZV9lbGVtZW50X2Zvcl9ldmVudF9saXN0ZW5lcisnXScpLnJlbW92ZSgpOwogICAgICB0aGlzLm5hbWVfZWxlbWVudF9mb3JfZXZlbnRfbGlzdGVuZXIgPSBudWxsOwogICAgICBpZih0aGlzLmlzX3Bob25lX251bWJlcil7CiAgICAgICAgJCgnW25hbWU9Y291bnRyeWNvZGVdJykuYXR0cigiZGlzYWJsZWQiLCAnZGlzYWJsZWQnKQogICAgICAgIC8vICQoJ1tuYW1lPWNvdW50cnljb2RlXScpLnJlbW92ZSgpOwogICAgICB9CiAgICB9LAogICAgZ29fdG9fZGVzaWduX2JvdHNfcGFnZSgpewogICAgICB0aGlzLiRyb3V0ZXIucHVzaCgnL2JvdC9kZXNpZ25ib3QnKQogICAgfQoKICAgIC8vc2VsbCBmdW5jdGlvbiBmb3IgZm9yZWlnbiBleGNoYW5nZQogICAgLy8gZXgyKCkgewogICAgLy8gICBzZXRUaW1lb3V0KCgpID0+IHsKICAgIC8vICAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInIyIikgIT0gbnVsbCkgewogICAgLy8gICAgICAgJCgiI2wyIikudmFsKDEpOwogICAgLy8gICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmN1cnJlbmN5ZXhjaGFuZ2VfbGlzdC5sZW5ndGg7IGkrKykgewogICAgLy8gICAgICAgICAkKCIjY291bnRyeTIiKS5hcHBlbmQoCiAgICAvLyAgICAgICAgICAgYDxvcHRpb24gdmFsdWU9IiR7dGhpcy5jdXJyZW5jeWV4Y2hhbmdlX2xpc3RbaV0uY3VycmVuY3lfdmFsdWV9Ij4ke3RoaXMuY3VycmVuY3lleGNoYW5nZV9saXN0W2ldLmN1cnJlbmN5X3RpdGxlfTwvb3B0aW9uPmAKICAgIC8vICAgICAgICAgKTsKICAgIC8vICAgICAgIH0KICAgIC8vICAgICAgICQoIiNyMiIpLnZhbChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY291bnRyeTIiKS52YWx1ZSk7CiAgICAvLyAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicjIiKS5hZGRFdmVudExpc3RlbmVyKCJrZXl1cCIsIGZ1bmN0aW9uKCkgewogICAgLy8gICAgICAgICB2YXIgeCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJyMiIpLnZhbHVlOwogICAgLy8gICAgICAgICB2YXIgY29uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvdW50cnkyIikudmFsdWU7CiAgICAvLyAgICAgICAgIHggPSB4IC8gY29uOwogICAgLy8gICAgICAgICB4ID0geC50b0ZpeGVkKDQpOwogICAgLy8gICAgICAgICAkKCIjbDIiKS52YWwoeCk7CiAgICAvLyAgICAgICB9KTsKICAgIC8vICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJsMiIpLmFkZEV2ZW50TGlzdGVuZXIoImtleXVwIiwgZnVuY3Rpb24oKSB7CiAgICAvLyAgICAgICAgIHZhciB4ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImwyIikudmFsdWU7CiAgICAvLyAgICAgICAgIHZhciBjb24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY291bnRyeTIiKS52YWx1ZTsKICAgIC8vICAgICAgICAgeCA9IHggKiBjb247CiAgICAvLyAgICAgICAgIHggPSB4LnRvRml4ZWQoNCk7CiAgICAvLyAgICAgICAgICQoIiNyMiIpLnZhbCh4KTsKICAgIC8vICAgICAgIH0pOwogICAgLy8gICAgICAgJChkb2N1bWVudCkub24oImNoYW5nZSIsICIjY291bnRyeTIiLCBmdW5jdGlvbigpIHsKICAgIC8vICAgICAgICAgLy8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvdW50cnkyIikuYWRkRXZlbnRMaXN0ZW5lcigia2V5dXAiLCBmdW5jdGlvbigpewogICAgLy8gICAgICAgICB2YXIgeCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJsMiIpLnZhbHVlOwogICAgLy8gICAgICAgICB2YXIgY29uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNvdW50cnkyIikudmFsdWU7CiAgICAvLyAgICAgICAgIHggPSB4ICogY29uOwogICAgLy8gICAgICAgICB4ID0geC50b0ZpeGVkKDQpOwogICAgLy8gICAgICAgICAkKCIjcjIiKS52YWwoeCk7CiAgICAvLyAgICAgICB9KTsKICAgIC8vICAgICB9CiAgICAvLyAgIH0sIDMwMDApOwogICAgLy8gfQogIH0KfTsK"},null]}