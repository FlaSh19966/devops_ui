{"remainingRequest":"/home/vimalesh/CENSE/chatbot-portal/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/vimalesh/CENSE/chatbot-portal/src/portal/Chatbot/Dashboard/Data Inputs/ResponseBot.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/vimalesh/CENSE/chatbot-portal/src/portal/Chatbot/Dashboard/Data Inputs/ResponseBot.vue","mtime":1645594423487},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/CENSE/chatbot-portal/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCmltcG9ydCBheGlvcyBmcm9tICJheGlvcyI7CmltcG9ydCBhcGlfY2FsbHMgZnJvbSAiQC9wb3J0YWwvYXBpX2NhbGxzIjsKaW1wb3J0IGZpbmdlcnByaW50IGZyb20gIkAvcG9ydGFsL2NvbXBvbmVudHMvZmluZ2VycHJpbnQiOwppbXBvcnQgeyBidXMgfSBmcm9tICJAL3BvcnRhbC9tYWluIjsKaW1wb3J0IHsgc2V0VGltZW91dCB9IGZyb20gInRpbWVycyI7CmltcG9ydCBNdWx0aXNlbGVjdCBmcm9tICJ2dWUtbXVsdGlzZWxlY3QiOwppbXBvcnQgVmlkZW9WaWV3ZXIgZnJvbSAiQC9wb3J0YWwvY29tcG9uZW50cy9SZXNwb25zZSBCb3QvVmlkZW9WaWV3ZXIudnVlIjsKaW1wb3J0IGRlYm91bmNlIGZyb20gInZ1ZS1kZWJvdW5jZS9kaXN0L2RlYm91bmNlLm1pbi5qcyI7Ci8vIGltcG9ydCB7IFNvY2tldCB9IGZyb20gInBob2VuaXgtc29ja2V0IjsKaW1wb3J0IHsgU29ja2V0LCBQcmVzZW5jZSB9IGZyb20gInBob2VuaXgiOwppbXBvcnQgU3RhclJhdGluZyBmcm9tICd2dWUtc3Rhci1yYXRpbmcnOwppbXBvcnQgewogIHZvaWNlcmVjb3JkZXIsCiAgc3RhcnRfdm9pY2VfY29tbXVuaWNhdGlvbiwKICBmb3JlaWdueGNoYW5nZV9jdXN0b20sCiAgZ2VuZXJhdGVfdGltZSwKfSBmcm9tICJAL3BvcnRhbC9taXhpbnMiOwppbXBvcnQgbW9tZW50IGZyb20gIm1vbWVudCI7CmltcG9ydCBzd2FsIGZyb20gInN3ZWV0YWxlcnQyIjsKaW1wb3J0IENlbnNlQ2FydCBmcm9tICcuL0NlbnNlQ2FydC52dWUnOwppbXBvcnQgVnVlTnVtZXJpY0lucHV0IGZyb20gJ3Z1ZS1udW1lcmljLWlucHV0JzsKaW1wb3J0IHNvdW5kIGZyb20gIkAvcG9ydGFsL2Fzc2V0cy9hdWRpby9taXhraXQtYWRkLXRvLWNhcnQud2F2IjsKaW1wb3J0ICJAL3BvcnRhbC9hc3NldHMvanMvc2hvcGlmeS5taW4uanMiCmV4cG9ydCBkZWZhdWx0IHsKICBuYW1lOiAicmVzcG9uc2UtYm90IiwKICBjb21wb25lbnRzOiB7CiAgICBNdWx0aXNlbGVjdCwKICAgIFZpZGVvVmlld2VyLAogICAgU3RhclJhdGluZywKICAgIENlbnNlQ2FydCwKICAgIFZ1ZU51bWVyaWNJbnB1dCwKICB9LAogIG1peGluczogWwogICAgdm9pY2VyZWNvcmRlciwKICAgIHN0YXJ0X3ZvaWNlX2NvbW11bmljYXRpb24sCiAgICBmb3JlaWdueGNoYW5nZV9jdXN0b20sCiAgICBnZW5lcmF0ZV90aW1lLAogIF0sCiAgZGF0YSgpIHsKICAgIHJldHVybiB7CiAgICAgIGNvbXBhbnlpZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfaWQsCiAgICAgIGNvbXBhbnluYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lLAogICAgICBwb3B1cF9tc2c6CiAgICAgICAgIllvdSBjYW4gdHlwZSDigJhSZXN0YXJ04oCdICBhdCA8L2JyPmFueSAgdGltZSB0byBnZXQgYmFjazwvYnI+IHRvIHRoZSBNYWluIE1lbnUiLAogICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiB0cnVlLAogICAgICBxdXNfYW5zOiAiYW5zd2VycyIsCiAgICAgIHRvX3NlbmQ6ICIiLAogICAgICBjZW5zZV9lbnF1aXJ5OiBmYWxzZSwKICAgICAgaXNfYWdlbnRfdHlwaW5nOiBmYWxzZSwKICAgICAgdXNlcl9uYW1lOiAiIiwKICAgICAgc2hvdzogZmFsc2UsCiAgICAgIGNoYXQ6IFtdLAogICAgICBmaW5nZXJwcmludDogbnVsbCwKICAgICAgYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlOiB0aGlzLiRzZXNzaW9uLmdldCgiQm90VG9rZW4iKSwKICAgICAgbGV2ZWw6IDAsCiAgICAgIHJlY29nbml0aW9uOiBudWxsLAogICAgICBqc29uX2RhdGE6IHsKICAgICAgICBjcmVhdGVfYXBwb2ludG1lbnQ6CiAgICAgICAgICAneyJVc2VyIjogeyJQaHlzaWNpYW4iOiB7IklEIjogIkRUMDAwMDAwMDAwMDAwMDAwMjM3In0sIlVzZXJOYW1lIjoiYWMiLCJJRCI6IlVTMDAwMDAwMDAwMDAwMDAwMTM4IiwiQWNjb3VudCI6IHsiSUQiOiAiQ08wMDAyMyJ9LCJUb2tlbiI6ICJaMXJTR0dtMFhwTVdqdDNnaUFFclBQV1o4NFRRTjlGc0ZNQkxzVSsvTEF1Nnl1YWxNZzZFUDJic3J3WmpMUHdtM2o0RHBQY0djNUxjSXAzTmpnZlVzQT09IiwiU3BlY2lhbHR5IjogeyJJRCI6ICJQRzAwMDAwMDAwMDAwMDAwMDE0MSIsICJOYW1lIjogIkFDIiwgIkNvZGUiOiAiQUMifSwiRG9tYWluIjogImdvZ3JlZW5iaWxscy5jb20ifSwiQXBwb2ludG1lbnQiOiB7IkRhdGUiOiAiMDgvMzAvMjAxOCIsICJJc0pTT05Ob3RlIjogMCwgIlBhdGllbnQiOiB7IkNhc2VJRCI6ICIifX19JywKICAgICAgICB2aXNpdHNfZmluYWxpemVkOgogICAgICAgICAgJ3siVXNlciI6IHsiUGh5c2ljaWFuIjogeyJJRCI6ICJEVDAwMDAwMDAwMDAwMDAxMTg4NiJ9LCJVc2VyTmFtZSI6ICJjaCIsIklEIjogIlVTMDAwMDAwMDAwMDAwMDAwMTQzIiwiQWNjb3VudCI6eyJJRCI6IkNPMDAwMjMifSwiVG9rZW4iOiJleUowZVhBaU9pSktWMVFpTENKaGJHY2lPaUpJVXpJMU5pSjkuZXlKMWMyVnlJam9pWVhaa2FIVjBJaXdpWlhod0lqb3hOVEk1TkRneU5qWXpmUS52MWMwSGJ1V3VaWFhwSmZEclhWYzFIUFZ1ZmZibkdjTHFrcGcwem02QW9RIiwiU3BlY2lhbHR5IjogeyJJRCI6ICJQRzAwMDAwMDAwMDAwMDAwMDE0MiIsIkNvZGUiOiAiY2gifSwiRG9tYWluIjogImdyZWVueW91cmJpbGxzLmNvbSJ9LCJTZWFyY2hQYXJhbWV0ZXJzIjogeyJTdGF0dXMiOiAiIiwiT3JkZXJCeSI6ICIiLCJGcm9tRGF0ZSI6ICIwMS8wMS8yMDE4IiwiQ291bnQiOiAiMTAiLCJTZWFyY2hUZXh0IjogIiIsIlR5cGVPZlZpc2l0IjogIkFMTCIsIlNvcnRPcmRlciI6ICJhcHBvaW50bWVudCIsIlN0YXJ0SW5kZXgiOiAiMSIsIkVuZEluZGV4IjogIjEwIiwiVG9EYXRlIjogIjA4LzA2LzIwMTgifX0nLAogICAgICAgIGFwcG9pbnRtZW50c19jb3VudDoKICAgICAgICAgICd7IlVzZXIiOiB7IlBoeXNpY2lhbiI6IHsiSUQiOiAiRFQwMDAwMDAwMDAwMDAwMTE4ODYifSwiVXNlck5hbWUiOiAiY2giLCJJRCI6ICJVUzAwMDAwMDAwMDAwMDAwMDE0MyIsIkFjY291bnQiOnsiSUQiOiJDTzAwMDIzIn0sIlRva2VuIjoiZXlKMGVYQWlPaUpLVjFRaUxDSmhiR2NpT2lKSVV6STFOaUo5LmV5SjFjMlZ5SWpvaVlYWmthSFYwSWl3aVpYaHdJam94TlRJNU5EZ3lOall6ZlEudjFjMEhidVd1WlhYcEpmRHJYVmMxSFBWdWZmYm5HY0xxa3BnMHptNkFvUSIsIlNwZWNpYWx0eSI6IHsiSUQiOiAiUEcwMDAwMDAwMDAwMDAwMDAxNDIiLCJDb2RlIjogImNoIn0sIkRvbWFpbiI6ICJncmVlbnlvdXJiaWxscy5jb20ifSwiU2VhcmNoUGFyYW1ldGVycyI6IHsiU3RhdHVzIjogIiIsIk9yZGVyQnkiOiAiIiwiRnJvbURhdGUiOiAiMDEvMDEvMjAxOCIsIkNvdW50IjogIjEwIiwiU2VhcmNoVGV4dCI6ICIiLCJUeXBlT2ZWaXNpdCI6ICJBTEwiLCJTb3J0T3JkZXIiOiAiYXBwb2ludG1lbnQiLCJTdGFydEluZGV4IjogIjEiLCJFbmRJbmRleCI6ICIxMCIsIlRvRGF0ZSI6ICIwOC8wNi8yMDE4In19JywKICAgICAgICBjcmVhdGVfdGlja2V0OgogICAgICAgICAgJ3siQWNjb3VudE5hbWUiOm51bGwsIkNhbGxiYWNrUGhvbmUiOiIiLCJDb21wYW55SUQiOiJDTzAwMDIzIiwiRGVzY3JpcHRpb24iOiJEZSIsIkRvbWFpbk5hbWUiOm51bGwsIkVtYWlsQ0MiOiJhYmhheS53QGNvZGVhcnJheS50ZWNoIiwiRW1haWxEZWZhdWx0IjoibWFuaXNoLnlAY29kZWFycmF5LnRlY2giLCJQcmlvcml0eSI6IjMiLCJQcmlvcml0eUlEIjowLCJSYWlzZWRCeSI6Imxhd3VzZXIiLCJTdGF0dXMiOjAsIlN0YXR1c0NvZGUiOm51bGwsIlN0YXR1c1RleHQiOm51bGwsIlNUeXBlIjoiV1AiLCJTdWJqZWN0IjoiRGUiLCJTdWJUeXBlIjoiU0FNRC1QIiwiVGlja2V0SUQiOjAsIlRpY2tldE51bWJlciI6bnVsbCwiVHlwZSI6MCwiVHlwZVRleHQiOiJXZWJzaXRlIFByb2JsZW0iLCJsaXN0RmlsZXMxIjpbImNocTEucGRmIl19JywKICAgICAgICBnZXRfcmVwb3J0OiAneyJjb21wYW55SWQiOiAiQ08wMDAyMyJ9JywKICAgICAgfSwKICAgICAgc3RvcDogdHJ1ZSwKICAgICAgZGVtb3VybGJpbmQ6IGZhbHNlLAogICAgICByZXZpZXdzdXJsYmluZDogZmFsc2UsCiAgICAgIHJldmlld3N1cmw6ICJodHRwczovL3d3dy55b3V0dWJlLmNvbS9lbWJlZC9wYUFlVzg2ZVFaNCIsCiAgICAgIGRlbW91cmw6IFsKICAgICAgICAiaHR0cHM6Ly93d3cueW91dHViZS5jb20vZW1iZWQvdmlkZW9zZXJpZXM/S2NySm05VXhXM3MmaW5kZXg9MTMmbGlzdD1QTF9qWGxpaDhkZ2tURThDclBwaVdjQTlLeFFlS0haQW50JnQ9MHMiLAogICAgICAgICJodHRwczovL3d3dy55b3V0dWJlLmNvbS9lbWJlZC92aWRlb3Nlcmllcz9xelMycUlOSTZJTSZsaXN0PVBMX2pYbGloOGRna1J1NWRkR1hBR3FaNHVMTGtvSnpDajgmaW5kZXg9MiIsCiAgICAgIF0sCiAgICAgIGNoYXRfd2lkZ2V0OiB7CiAgICAgICAgbG9nbzogIiIsCiAgICAgICAgdGl0bGU6ICIiLAogICAgICAgIHN0eWxlOiAiIiwKICAgICAgICBib3RfdGhlbWU6ICIiLAogICAgICAgIGJ1dHRvbl9ib3JkZXJfdGhlbWU6ICIjMjczNjc5IiwKICAgICAgICB1c2VyX21zZ19mb250X2NvbG9yOiAiIzI3MzY3OSIsCiAgICAgICAgYm90X3Jlc3BvbnNlX2ZvbnRfY29sb3I6ICIjMjczNjc5IiwKICAgICAgICBidXR0b25fdGhlbWU6ICIiLAogICAgICAgIGJ1dHRvbl9hbGlnbm1lbnQ6ICIiLAogICAgICAgIGJvdF9pY29uOiAiIiwKICAgICAgICBib3RfYmFja2dyb3VuZF9pbWFnZTogIiIsCiAgICAgICAgYnV0dG9uX2hvcml6b250YWxfc3BhY2luZzogIjMiLAogICAgICAgIGJ1dHRvbl92ZXJ0aWNhbF9zcGFjaW5nOiAiNSIsCiAgICAgICAgaGVhZGVyX2JhY2tncm91bmQ6ICIiLAogICAgICAgIGJvdF9mb250X3N0eWxlOiAiIiwKICAgICAgICBib3RfZm9udF9jb2xvcl9zZW5kZXI6ICIiLAogICAgICAgIGJvdF9mb250X2NvbG9yX3JlY2VpdmVyOiAiIiwKICAgICAgICBib3RfZm9udF9jb2xvcl9idXR0b25zOiAiIiwKICAgICAgICBpc19wb3dlcmVkX2J5X2NlbnNlOiB0cnVlLAogICAgICB9LAogICAgICBzZWxlY3RlZF9kYXRlOiAiIiwKICAgICAgc2VsZWN0ZWRfdGltZTogIiIsCiAgICAgIHJlYXNvbl9vZl92aXNpdDogIiIsCiAgICAgIHBhdGllbnRfbmFtZTogIiIsCiAgICAgIHZpc2l0b3JfbnVtYmVyOiAiIiwKICAgICAgZnVsbF90aW1lX3Nsb3RzOiBbXSwKICAgICAgdGltZV9zbG90czogW10sCiAgICAgIFRPREFZX0RBVEU6ICIiLAogICAgICBjaGFubmVsOiBudWxsLAogICAgICBjaGF0X3NvY2tldDogbnVsbCwKICAgICAgdm9pY2Vfc29ja2V0OiBudWxsLAogICAgICBsaXZlX2NoYXRfb246IGZhbHNlLAogICAgICBsaXZlX2NoYXRfdG9rZW46IG51bGwsCiAgICAgIGNoYXRfZ3JvdXBfbmFtZTogbnVsbCwKICAgICAgdG9fc2Nyb2xsOiBmYWxzZSwKICAgICAgZm9ybV9wYXlsb2FkOiBudWxsLAogICAgICBwaG9uZV9udW1iZXJfdmFsaWRpdHk6IC9bMC05XXsxMCwxMX0kLywKICAgICAgLy8gdXJsX21hdGNoX3JlZ2V4OiAvXGIoaHR0cHM/fGZ0cCk6XC9cLyhbXFNdKStcLigocGRmfGNzdnx4bHN4KSkoW1x3Pz1dKykvZywKICAgICAgdXJsX21hdGNoX3JlZ2V4OiAvXmh0dHBzPzpcL1wvLipbXFxcL10uK1wuWyhwZGZ8Y3N2fHhsc3gpXXsyLDR9LywKICAgICAgLy8gaGFyc2gKICAgICAgaXNleGNoYW5nZTogZmFsc2UsCiAgICAgIGlzcmV0YWlsaWdlbmNlOiBmYWxzZSwKICAgICAgY3VycmVuY3lleGNoYW5nZV9saXN0OiBudWxsLAogICAgICBzZWxlY3RlZF9pbmRpY2F0aW9uOiBbXSwKICAgICAgd2VsY29tZV9tZXNzYWdlX25vdF95ZXRfcmVjZWl2ZWQ6IHRydWUsCiAgICAgIHJlczoge30sCiAgICAgIGlzX3R5cGluZ19pbmRpY2F0b3Jfb246IGZhbHNlLAogICAgICB0aHVtYnNfdXBfaWNvbjogcmVxdWlyZSgiQC9wb3J0YWwvYXNzZXRzL2ltZy9Hcm91cCA3LnN2ZyIpLAogICAgICB0aHVtYnNfZG93bl9pY29uOiByZXF1aXJlKCJAL3BvcnRhbC9hc3NldHMvaW1nL0dyb3VwIDYuc3ZnIiksCiAgICAgIHNob3BpZnlfdWk6IG51bGwsCiAgICAgIHNob3BpZnlfY3VzdG9tZXJfaWQ6IG51bGwsCiAgICAgIC8vIHJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHM6IHt9LAogICAgICAvLyByZWZ1bmRfc2VsZWN0ZWRfaXRlbXM6IFtdLAogICAgICBzaG9waWZ5X3JldGFpbF9zaG9wX25hbWU6IG51bGwsCiAgICAgIHNob3BfdXJsOiBudWxsLAogICAgICBpc19yZXRhaWxfYm90OiBmYWxzZSwKICAgICAgc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZDogbnVsbCwKICAgICAgc2hvd19zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX2Vycm9yOiBmYWxzZSwKICAgICAgc3VwcG9ydF9jaGFubmVsOiBudWxsLAogICAgICBpc19zdXBwb3J0X2FnZW50X3ByZXNlbnQ6IGZhbHNlLAogICAgICByZXRhaWxfc2hvcF9zdG9yZWZyb250X3Rva2VuOiBudWxsLAogICAgICByZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQ6IGZhbHNlLAogICAgICByZXRhaWxfc2hvcF9jdXJyZW5jeTogbnVsbCwKICAgICAgcHJvZHVjdF9saXN0OiBbXSwKICAgICAgcHJvZHVjdF9vdXRfb2Zfc3RvY2tfbGlzdDogW10sCiAgICAgIGNoZWNrZWRfbGlzdDogW10sCiAgICAgIGN1cnJlbnRfcHJvZHVjdDogIiIsCiAgICAgIGN1c3RvbWVyX2VtYWlsOiAiIiwKICAgICAgaXNfc2VuZGVyX2VtYWlsOiBmYWxzZSwKICAgICAgcmVnX2VtYWlsOiAvXihbMC05YS16QS1aXShbLS5cd10qWzAtOWEtekEtWl0pKkAoWzAtOWEtekEtWl1bLVx3XSpbMC05YS16QS1aXVwuKStbYS16QS1aXXsyLDl9KSQvLAogICAgICBzY3JvbGxQb3NpdGlvbjogMCwKICAgICAgdmlzaWJsZV9jdXN0b21fZ3JlZXRpbmdzX2J1dHRvbTpmYWxzZSwKICAgICAgcmV2aWV3X21lc3NhZ2VfZmlyc3Q6JycsCiAgICAgIHJldmlld19tZXNzYWdlX3NlY29uZDonJywKICAgICAgcmV2aWV3X3Jlc3BvbnNlX21lc3NhZ2U6JycsCiAgICAgIGRpc3BsYXlfcHJvZHVjdHM6ZmFsc2UsCiAgICAgIHJldGFpbF93ZWJfZnJhbWV3b3JrOiAiIiwKICAgICAgaXNfY2Vuc2VfY2FydDogZmFsc2UsCiAgICAgIHNob3dfY3VzdG9tX2NhcnQ6IGZhbHNlLAogICAgICBhZGR0b0NhcnRkYXRhOiBbXSwKICAgICAgdG90YWxfcHJvZHVjdHNfcXR5OiAwLAogICAgICBvdmVyX3F0eV93YXJuaW5nOiBmYWxzZSwKICAgICAgY29udGFjdF9oZWxwX2VtYWlsOiBudWxsLAogICAgICBzaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX2xpc3Q6IG51bGwsCiAgICAgIHNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmRfb3B0aW9uOlsKICAgICAgICAnT3JkZXJlZCBieSBtaXN0YWtlJywKICAgICAgICAnT3JkZXJlZCB3cm9uZyBwcm9kdWN0JywKICAgICAgICAnT3JkZXIgbm90IFJlY2VpdmVkJywKICAgICAgICAnTm8gbG9uZ2VyIG5lZWRlZCcsCiAgICAgICAgJ0JldHRlciBwcmljZSBhdmFpbGFibGUnLAogICAgICAgICdSZWNlaXZlZCBkYW1hZ2VkIHByb2R1Y3RzJywKICAgICAgICAnT3RoZXJzJwogICAgICBdLAogICAgICBvcmRlcl9ub3Rlc19kYXRhOiBbXSwKICAgICAgc2VsZWN0ZWRfb3JkZXJfbmFtZTogIiIsCiAgICAgIGlzX3dvb2NvbW1lcmNlX29yZGVyOiBmYWxzZSwKICAgICAgdmlzaXRvcnNfY3VycmVudF9sb2NhdGlvbjogbnVsbCwKICAgICAgaXNfZGlzcGxheV9iYW5uZXJfb25fbGFuZGluZzogZmFsc2UsCiAgICAgIHZpc2l0b3JzX2N1cnJlbnRfbG9jYXRpb25fdXJsOiBgaHR0cHM6Ly9pcGdlb2xvY2F0aW9uLmFic3RyYWN0YXBpLmNvbS92MS8/YXBpX2tleT0ke3Byb2Nlc3MuZW52LlZVRV9BUFBfQ1VSUkVOVF9MT0NBVElPTl9UT0tFTn1gLAogICAgICBncmVldGluZ19idXR0b25zX3Bvc2l0aW9uOiBudWxsCiAgICB9OwogIH0sCiAgcHJvcHM6IHsKICAgIGlzUHJldmlld0JvdDogQm9vbGVhbiwKICAgIGlzRGlhbG9nQm90OiBCb29sZWFuLAogICAgY3VycmVudF9wcmV2aWV3X2Jhbm5lcl9pZDogU3RyaW5nLAogICAgaXNUZXh0VG9Cb3Q6IHsKICAgICAgdHlwZTogQm9vbGVhbiwKICAgICAgZGVmYXVsdDogdHJ1ZSwKICAgIH0sCiAgICBpc0NhbGxlZEZyb21TZXR1cDogewogICAgICB0eXBlOiBCb29sZWFuLAogICAgICBkZWZhdWx0OiBmYWxzZSwKICAgIH0sCiAgfSwKICBjb21wdXRlZDogewogICAgY3VzdG9tX2dyZWV0aW5nc19idXR0b21fYWxpZ25tZW50KCl7CiAgICAgIGlmKHRoaXMuaXNfcmV0YWlsX2JvdCl7CiAgICAgICAgcmV0dXJuICJjb2wtc20tMTAgcHgtMCI7CiAgICAgIH1lbHNlewogICAgICAgIHJldHVybiAiY29sLXNtLTEyIHB4LTAiOwogICAgICB9CiAgICB9LAogICAgY2FydF9idXR0b25fYWxpZ25tZW50KCl7CiAgICBpZih0aGlzLmlzX3JldGFpbF9ib3QpewogICAgICAgIHJldHVybiAiY29sLXNtLTIgcHgtMCI7CiAgICAgIH1lbHNlewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICB9LAogICAgaW5wdXRfZGlzYWJsZWQoKSB7CiAgICAgIHJldHVybiB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQgfHwgdGhpcy53ZWxjb21lX21lc3NhZ2Vfbm90X3lldF9yZWNlaXZlZDsKICAgIH0sCiAgICBjc3NQcm9wcygpIHsKICAgICAgbGV0IGJvdEF0dHJpYnV0ZXMgPSB7CiAgICAgICAgaGVhZF9jb2xvcjogdGhpcy5jaGF0X3dpZGdldC5oZWFkZXJfYmFja2dyb3VuZCwKICAgICAgfTsKICAgICAgaWYgKHRoaXMuY29tcGFueWlkID09PSAicmV0YWlsaWdlbmNlODQ5MjYiKSB7CiAgICAgICAgYm90QXR0cmlidXRlcy5oZWFkX2NvbG9yID0gdGhpcy5jaGF0X3dpZGdldC5ib3RfdGhlbWU7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc2V4Y2hhbmdlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICItLWJvdC1oZWFkLWNvbG9yIjogIiNmZmYiLAogICAgICAgICAgIi0tYm90LXNlbmRlci1jb2xvciI6ICIjMmIzMTg0IiwKICAgICAgICAgICItLWJvdC1idXR0b24tY29sb3IiOiAiI2ZkY2YzOCIsCiAgICAgICAgICAiLS1ib3QtbGluay1jb2xvciI6ICIjMmIzMTg0IiwKICAgICAgICAgICItLWJvdC1idXR0b24tYm9yZGVyIjogIiMyNzM2NzkiLAogICAgICAgICAgIi0tdXNlcl9tc2dfZm9udF9jb2xvciI6ICIjMjczNjc5IiwKICAgICAgICAgICItLWJvdC1yZXNwb25zZS1mb250LWNvbG9yIjogIiMyNzM2NzkiLAogICAgICAgICAgIi0tYm90LWJ1dHRvbi1iYWNrZ3JvdW5kIjogIiMxZGFhZTEiLAogICAgICAgICAgIi0tYm90LWJ1dHRvbnMtYWxpZ25tZW50IjogImNlbnRlciIsCiAgICAgICAgICAiLS1ib3QtYnV0dG9ucy12ZXJ0aWNhbC1zcGFjaW5nIjogIjUlIiwKICAgICAgICAgICItLWJvdC1idXR0b25zLWhvcml6b250YWwtc3BhY2luZyI6ICIzJSIsCiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgICItLWJvdC1oZWFkLWNvbG9yIjogYm90QXR0cmlidXRlcy5oZWFkX2NvbG9yLAogICAgICAgICItLWJvdC1zZW5kZXItY29sb3IiOiB0aGlzLmNoYXRfd2lkZ2V0LmJvdF90aGVtZSwKICAgICAgICAiLS1ib3QtYnV0dG9uLWNvbG9yIjogdGhpcy5jaGF0X3dpZGdldC5ib3RfdGhlbWUsCiAgICAgICAgIi0tYm90LWxpbmstY29sb3IiOiB0aGlzLmNoYXRfd2lkZ2V0LmJvdF90aGVtZSwKICAgICAgICAiLS1ib3QtYnV0dG9uLWJvcmRlciI6IHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX2JvcmRlcl90aGVtZSwKICAgICAgICAiLS11c2VyX21zZ19mb250X2NvbG9yIjogdGhpcy5jaGF0X3dpZGdldC51c2VyX21zZ19mb250X2NvbG9yLAogICAgICAgICItLWJvdC1yZXNwb25zZS1mb250LWNvbG9yIjp0aGlzLmNoYXRfd2lkZ2V0LmJvdF9yZXNwb25zZV9mb250X2NvbG9yLAogICAgICAgICItLWJvdC1idXR0b24tYmFja2dyb3VuZCI6IHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX3RoZW1lLAogICAgICAgICItLWJvdC1idXR0b25zLWFsaWdubWVudCI6IHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX2FsaWdubWVudC52YWx1ZSwKICAgICAgICAiLS1ib3QtYnV0dG9ucy12ZXJ0aWNhbC1zcGFjaW5nIjogYCR7dGhpcy5jaGF0X3dpZGdldC5idXR0b25fdmVydGljYWxfc3BhY2luZ30lYCwKICAgICAgICAiLS1ib3QtYnV0dG9ucy1ob3Jpem9udGFsLXNwYWNpbmciOiBgJHt0aGlzLmNoYXRfd2lkZ2V0LmJ1dHRvbl9ob3Jpem9udGFsX3NwYWNpbmd9JWAsCiAgICAgICAgIi0tYm90LWZvbnQtc3R5bGUiOiB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9mb250X3N0eWxlLnZhbHVlLAogICAgICAgICItLWJvdC1mb250LWNvbG9yLXNlbmRlciI6IHRoaXMuY2hhdF93aWRnZXQuYm90X2ZvbnRfY29sb3Jfc2VuZGVyLAogICAgICAgICItLWJvdC1mb250LWNvbG9yLXJlY2VpdmVyIjogdGhpcy5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9yZWNlaXZlciwKICAgICAgICAiLS1ib3QtZm9udC1jb2xvci1idXR0b25zIjogdGhpcy5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9idXR0b25zLAogICAgICB9OwogICAgfSwKICAgIGJvdF9pbWdfaWNvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAiYmFja2dyb3VuZC1pbWFnZSI6IGB1cmwoJHt0aGlzLmNoYXRfd2lkZ2V0LmJvdF9pY29ufSlgLAogICAgICB9OwogICAgfSwKICAgIGNoYXRfYm90X2JhY2tncm91bmRfaW1hZ2UoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgImJhY2tncm91bmQtaW1hZ2UiOiBgdXJsKCR7dGhpcy5jaGF0X3dpZGdldC5ib3RfYmFja2dyb3VuZF9pbWFnZX0pYCwKICAgICAgfTsKICAgIH0sCiAgICBzaG9waWZ5X2xvZ2luX2J1dHRvbl90ZXh0KCkgewogICAgICBpZiAodGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQpIHsKICAgICAgICByZXR1cm4gIkdvIjsKICAgICAgfQogICAgICByZXR1cm4gIkxvZ2luIjsKICAgIH0sCiAgICBjYXJ0X2ljb25fc3ZnKCl7CiAgICAgcmV0dXJuIGA8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmVyc2lvbj0iMS4wIiB3aWR0aD0iMTguMDAwMDAwcHQiIGhlaWdodD0iMTguMDAwMDAwcHQiIHZpZXdCb3g9IjAgMCA1MTIuMDAwMDAwIDUxMi4wMDAwMDAiIHByZXNlcnZlQXNwZWN0UmF0aW89InhNaWRZTWlkIG1lZXQiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAuMDAwMDAwLDUxMi4wMDAwMDApIHNjYWxlKDAuMTAwMDAwLC0wLjEwMDAwMCkiIGZpbGw9IiR7dGhpcy5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9idXR0b25zfSIgc3Ryb2tlPSJub25lIj48cGF0aCBkPSJNODEgNTAwMiBjLTEwMCAtNTAgLTEwNiAtMTg2IC0xMiAtMjQ5IDMzIC0yMyAzOSAtMjMgMzE3IC0yMyBsMjg0IDAgNSAtMjIgYzMgLTEzIDE3MiAtNzQ1IDM3NSAtMTYyOCAyNzkgLTEyMDkgMzc2IC0xNjEyIDM5MiAtMTYzNiA0NyAtNjkgLTcyIC02NCAxNTk5IC02NCAxMzY3IDAgMTUxNCAyIDE1NDUgMTYgMzcgMTggNjggNjIgNzkgMTExIDkgNDUgLTI0IDExNyAtNjcgMTQzIC0zMyAyMCAtNDUgMjAgLTE0NzUgMjAgLTEzNjQgMCAtMTQ0MiAxIC0xNDQ3IDE4IC0xMiAzNyAtMTA2IDQ1NCAtMTA2IDQ2OCAwIDEyIDIwNiAxNCAxNTAzIDE0IDE0NzIgMCAxNTAzIDAgMTUzNCAyMCAxOCAxMCAzOSAzMyA0OCA1MCAyNiA1MCA0NjggMjAzMCA0NjEgMjA2OCAtNyA0NCAtMzkgODYgLTgwIDEwNiAtMzEgMTUgLTIwOCAxNiAtMjAxNCAxNiBsLTE5ODAgMCAtMjcgMTE4IGMtNzMgMzE5IC05NCAzOTUgLTExNyA0MTkgLTQ5IDUzIC01MSA1MyAtNDMwIDUzIC0zMTYgMCAtMzU3IC0yIC0zODcgLTE4eiBtNDcwMiAtODY5IGMyIC01IC04MSAtMzgxIC0xODQgLTgzOCAtMTA0IC00NTYgLTE4OCAtODMxIC0xODkgLTgzMyAwIC0xIC02NTYgLTEgLTE0NTcgMCBsLTE0NTggMyAtMTkyIDgzMCBjLTEwNSA0NTcgLTE5MiA4MzMgLTE5MiA4MzggLTEgOSAzNjY3IDkgMzY3MiAweiIvPjxwYXRoIGQ9Ik0yMDM4IDExNjUgYy0xOTAgLTQ4IC0zNTYgLTIxNiAtMzk4IC00MDAgLTE1IC02NCAtMTUgLTE4NiAwIC0yNTAgMzEgLTEzNyAxNTEgLTI5MCAyNzcgLTM1NCAxNzMgLTg3IDM4NyAtNzggNTM4IDIzIDIxOSAxNDYgMzA2IDQwNyAyMTYgNjQ3IC01NSAxNDQgLTE4MSAyNjggLTMyNiAzMjAgLTc4IDI3IC0yMjcgMzQgLTMwNyAxNHogbTIxNyAtMjk1IGM0OCAtMTkgMTA0IC03MSAxMjkgLTEyMSAxMTEgLTIyMyAtMTQ3IC00NDkgLTM1NCAtMzEwIC0xNzYgMTE4IC0xMzAgMzgyIDc4IDQzNyA0NSAxMiAxMDUgOSAxNDcgLTZ6Ii8+PHBhdGggZD0iTTM4MDYgMTE2NCBjLTEzMyAtMzIgLTI3OCAtMTQ2IC0zNDMgLTI3MCAtMTEzIC0yMTMgLTc1IC00NjIgOTcgLTYzNCAyMTMgLTIxMyA1NDIgLTIxNCA3NTQgLTQgMzUgMzUgNzggODggOTUgMTE4IDM4IDY2IDcxIDE5MCA3MSAyNjYgMCA3NiAtMzMgMjAwIC03MSAyNjYgLTE3IDMwIC02MCA4MyAtOTUgMTE4IC0xMzQgMTMzIC0zMjMgMTg1IC01MDggMTQweiBtMTk1IC0yODggYzQ4IC04IDExMiAtNTYgMTQ2IC0xMDggMjUgLTM4IDI4IC01MiAyOCAtMTI4IDAgLTc2IC0zIC05MCAtMjcgLTEyNyAtNTEgLTc4IC0xMTggLTExNSAtMjA5IC0xMTUgLTEwOSAwIC0yMDMgNjkgLTIzMyAxNzMgLTIwIDY1IC0yMCA3MyAwIDEzOCAxNiA1NiA2OSAxMjMgMTE3IDE0NyAzMiAxNyAxMDQgMzMgMTI3IDI5IDggLTIgMzEgLTYgNTEgLTl6Ii8+PC9nPjwvc3ZnPmAKICAgIH0KICAgIAogIH0sCiAgd2F0Y2g6IHsKICAgIHNjcm9sbFBvc2l0aW9uKCl7CiAgICAgIGlmKHRoaXMuc2Nyb2xsUG9zaXRpb24gPiAxNTApewogICAgICAgIHRoaXMudmlzaWJsZV9jdXN0b21fZ3JlZXRpbmdzX2J1dHRvbSA9IHRydWU7CiAgICAgIH1lbHNlIGlmKHRoaXMuc2Nyb2xsUG9zaXRpb24gPCAxNTApewogICAgICAgIHRoaXMudmlzaWJsZV9jdXN0b21fZ3JlZXRpbmdzX2J1dHRvbSA9IGZhbHNlOwogICAgICB9CiAgICB9LAogICAgdG9fc2VuZCgpIHsKICAgICAgdGhpcy5idXR0b25fZmlsbCgpOwogICAgfSwKICAgIGNoYXQoKSB7CiAgICAgIHRoaXMuc2Nyb2xsX2Rvd24oKTsKICAgIH0sCiAgfSwKICBiZWZvcmVDcmVhdGVkKCl7CiAgICBsZXQgcm91dGVfcGFyYW1zID0gdGhpcy4kcm91dGUucGFyYW1zOwogICAgaWYgKHJvdXRlX3BhcmFtcy5yZWxvYWQgPT09IHRydWUpIHsKICAgICAgdGhpcy4kcm91dGVyLmdvKCk7CiAgICB9CiAgfSwKICBiZWZvcmVEZXN0cm95KCl7CiAgICBpZih0aGlzLmxpdmVfY2hhdF9vbikgdGhpcy5kaXNjb25uZWN0X3N1cHBvcnRfY2hhdCgpOwogIH0sCiAgY3JlYXRlZCgpIHsKICAgIHRoaXMubG9hZF93aWRnZXRfc2V0dGluZ3MoKTsKICAgIGxldCBib3RfdGVtcGxhdGVzX2RhdGEgPSB0aGlzLiRzZXNzaW9uLmdldCgiQm90VGVtcGxhdGVzIik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJvdF90ZW1wbGF0ZXNfZGF0YS5sZW5ndGg7IGkrKykgewogICAgICBpZiAoCiAgICAgICAgYm90X3RlbXBsYXRlc19kYXRhW2ldLmRvbWFpbiA9PT0gIlJldGFpbCIgJiYKICAgICAgICBib3RfdGVtcGxhdGVzX2RhdGFbaV0uc3Vic2NyaWJlZCA9PT0gdHJ1ZQogICAgICApIHsKICAgICAgICB0aGlzLmlzX3JldGFpbF9ib3QgPSB0cnVlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy4kc2Vzc2lvbi5oYXMoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIpKSB7CiAgICAgIC8vIHRoaXMuY2hhdCA9IHRoaXMuJHNlc3Npb24uZ2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iKTsKICAgIH0KICAgIC8vIGlmICghdGhpcy4kc2Vzc2lvbi5oYXMoIkNoYXRCb3RJbWFnZVBhcmFtZXRlcnMiKSkgewogICAgLy8gfSBlbHNlIHsKICAgIC8vICAgdGhpcy5jaGF0X3dpZGdldCA9IHRoaXMuJHNlc3Npb24uZ2V0KCJDaGF0Qm90SW1hZ2VQYXJhbWV0ZXJzIik7CiAgICAvLyAgIHRoaXMuY2hhdF93aWRnZXQuc3R5bGUgPSAibWFyZ2luLXRvcDogNXB4O2hlaWdodDozMHB4O3dpZHRoOmF1dG87bWFyZ2luLWxlZnQ6IGF1dG87bWFyZ2luLXJpZ2h0OiAwOyI7CiAgICAvLyB9CiAgICBpZiAoIXRoaXMuaXNQcmV2aWV3Qm90KSB7CiAgICAgIGlmICghdGhpcy4kc2Vzc2lvbi5oYXMoIkJvdFRva2VuIikpIHsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmJvdF9yZXNwb25zZV90b2tlbigpLCB7CiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICB9KQogICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RUb2tlbiIsIHJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgICB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSA9IHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICAgIHRoaXMucmVmcmVzaF9jaGF0Ym90KCk7CiAgICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSA9IHRoaXMuJHNlc3Npb24uZ2V0KCJCb3RUb2tlbiIpOwogICAgICAgIHRoaXMucmVmcmVzaF9jaGF0Ym90KCk7CiAgICAgIH0KICAgIH0KICAgIC8vIGhhcnNoCiAgICBpZiAoCiAgICAgIHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSA9PQogICAgICAiLmVKeFRjc3N2U3MxTXo2dEl6a2pNUzA4MU5EZXhOSVFLS1VERk1rcEtDb3F0OVBYTHk4djEwbEJVNnlYbjUtb2xsdW9iR1JoYTZocVk2eHFZS0JnYVdCa1pXNW1hNmhtYm01Z1ltU29CQUdhOUhwMC5YUjNUdXcuWDc3Rl83TER0T0xwMlZ0OXNuRkRTbzMxblR3IgogICAgKSB7CiAgICAgIHRoaXMuaXNleGNoYW5nZSA9IHRydWU7CiAgICB9IGVsc2UgaWYgKHRoaXMuY29tcGFueWlkID09ICJyZXRhaWxpZ2VuY2U4NDkyNiIpIHsKICAgICAgdGhpcy5pc3JldGFpbGlnZW5jZSA9IHRydWU7CiAgICB9CiAgICB2YXIgZCA9IG5ldyBEYXRlKCk7CiAgICBheGlvcwogICAgICAucG9zdChhcGlfY2FsbHMuYm90X3VzZXJfZGF0YSgpLCB7CiAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICB0ejogSW50bC5EYXRlVGltZUZvcm1hdCgpLnJlc29sdmVkT3B0aW9ucygpLnRpbWVab25lLAogICAgICAgIGRhdGV0aW1lOiBkLnRvSVNPU3RyaW5nKCksCiAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgIH0pCiAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge30pOwoKICAgIGF4aW9zCiAgICAgIC5wb3N0KAogICAgICAgIGFwaV9jYWxscy5wcm9kdWN0X3NldHRpbmdzKCksCiAgICAgICAgewogICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLmNvbXBhbnluYW1lLAogICAgICAgICAgY29tcGFueV9pZDogdGhpcy5jb21wYW55aWQsCiAgICAgICAgICBpc19lbWFpbF92ZXJpZmljYXRpb25fc3RhdHVzOiB0cnVlLAogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgIH0sCiAgICAgICAgfQogICAgICApCiAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgIHRoaXMuYmlnX3NwaW5uZXIgPSBmYWxzZTsKICAgICAgICBpZiAoCiAgICAgICAgICByZXNwb25zZS5kYXRhICE9ICIiICYmCiAgICAgICAgICByZXNwb25zZS5kYXRhICE9IG51bGwgJiYKICAgICAgICAgIHJlc3BvbnNlLmRhdGEgIT0gIkludGVybmFsIHNlcnZlciBFcnJvciIKICAgICAgICApIHsKICAgICAgICAgIHZhciBzdGF0dXMgPSByZXNwb25zZS5kYXRhLnZlcmlmaWNhdGlvbl9zdGF0dXM7CiAgICAgICAgICBpZiAoc3RhdHVzID09ICJTdWNjZXNzIikgewogICAgICAgICAgICB0aGlzLmlzX3NlbmRlcl9lbWFpbCA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmlzX3NlbmRlcl9lbWFpbCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmlzX3NlbmRlcl9lbWFpbCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfSkKICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgdGhpcy5iaWdfc3Bpbm5lciA9IGZhbHNlOwogICAgICAgIGlmICgKICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MTAgfHwKICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0NDAgfHwKICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MDkKICAgICAgICApIHsKICAgICAgICAgIHRoaXMuJHJvb3QuJGVtaXQoIlNlc3Npb25fRXhwaXJlZCIsIGUucmVzcG9uc2UuZGF0YSk7CiAgICAgICAgfQogICAgICB9KTsKICB9LAogIGJlZm9yZURlc3Ryb3koKSB7CiAgICB0aGlzLiRmb3JjZVVwZGF0ZSgpOwogIH0sCiAgbW91bnRlZCgpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGwnLCBmdW5jdGlvbiAoZXYpIHsKICAgICAgaWYgKGV2LnRhcmdldC5pZCA9PT0gJ3BvcnRhbF9jaGF0X2JvZHlfaWQnKXsKICAgICAgICB2bS5zY3JvbGxQb3NpdGlvbiA9IGV2LnRhcmdldFsic2Nyb2xsVG9wIl0KICAgICAgfQogICAgfSwgdHJ1ZSkKICAgIC8vIGxldCByZWNhcHRjaGFTY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKQogICAgLy8gcmVjYXB0Y2hhU2NyaXB0LnNldEF0dHJpYnV0ZSgnc3JjJywgJ2h0dHBzOi8vc2Rrcy5zaG9waWZ5Y2RuLmNvbS9idXktYnV0dG9uL2xhdGVzdC9idXlidXR0b24uanMnKQogICAgLy8gZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChyZWNhcHRjaGFTY3JpcHQpCiAgICAvLyBjb25zdCBwbHVnaW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgIC8vIHBsdWdpbi5zZXRBdHRyaWJ1dGUoCiAgICAvLyAgICJzcmMiLAogICAgLy8gICAiaHR0cHM6Ly9zZGtzLnNob3BpZnljZG4uY29tL2J1eS1idXR0b24vbGF0ZXN0L2J1eWJ1dHRvbi5qcyIKICAgIC8vICk7CiAgICAvLyBwbHVnaW4uYXN5bmMgPSB0cnVlOwogICAgLy8gZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChwbHVnaW4pOwogICAgdGhpcy5zaG93ID0gZmFsc2U7CiAgICBpZiAodGhpcy4kcm91dGUubmFtZSA9PSAiVHJhaW4gdGhlIEJvdCIpIHsKICAgICAgJCgiLmNoYXQtd3JhcCIpLmNzcygicmlnaHQiLCAiYXV0byIpOwogICAgfQogICAgaWYgKHRoaXMuJHJvdXRlLm5hbWUgPT0gIkRpcmVjdCBSZXNwb25zZSBCb3QiKSB7CiAgICAgICQoIi5jaGF0LXdyYXAiKS5jc3MoIm1hcmdpblRvcCIsICI1JSIpOwogICAgfQogICAgd2luZG93LlNwZWVjaFJlY29nbml0aW9uID0KICAgICAgd2luZG93LndlYmtpdFNwZWVjaFJlY29nbml0aW9uIHx8IHdpbmRvdy5TcGVlY2hSZWNvZ25pdGlvbjsKICAgIHdpbmRvdy5BdWRpb0NvbnRleHQgPSB3aW5kb3cuQXVkaW9Db250ZXh0IHx8IHdpbmRvdy53ZWJraXRBdWRpb0NvbnRleHQ7CiAgICBuYXZpZ2F0b3IuZ2V0VXNlck1lZGlhID0KICAgICAgbmF2aWdhdG9yLmdldFVzZXJNZWRpYSB8fAogICAgICBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhIHx8CiAgICAgIG5hdmlnYXRvci5tb3pHZXRVc2VyTWVkaWEgfHwKICAgICAgbmF2aWdhdG9yLm1zR2V0VXNlck1lZGlhOwoKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgc29tZUxpc3RlbmVyKTsKCiAgICBmdW5jdGlvbiBzb21lTGlzdGVuZXIoZXZlbnQpIHsKICAgICAgbGV0IGVsZW1lbnQgPSBldmVudC50YXJnZXQ7CiAgICAgIGlmICgKICAgICAgICAoZWxlbWVudC50YWdOYW1lID09ICJJIiB8fCBlbGVtZW50LnRhZ05hbWUgPT0gIkEiKSAmJgogICAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCJmYS1jbGlwYm9hcmQiKQogICAgICApIHsKICAgICAgICB2YXIgbXNnID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtY29weS1jb250ZW50Iik7CiAgICAgICAgdmFyIHRlbXAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ZXh0YXJlYSIpOwogICAgICAgIHZhciB0ZW1wTXNnID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUobXNnKTsKICAgICAgICB0ZW1wLmFwcGVuZENoaWxkKHRlbXBNc2cpOwoKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRlbXApOwogICAgICAgIHRlbXAuc2VsZWN0KCk7CiAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoImNvcHkiKTsKICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRlbXApOwogICAgICB9CiAgICB9CiAgICB0aGlzLiRyb290LiRlbWl0KCJjaGFuZ2Vfc2lkZWJhcl9tYWluX21lbnUiLCAiU2ltdWxhdGUgSW50ZXJhY3Rpb24iKTsKCiAgICAvL1RvIGhpZGUgY2Vuc2UgY2FydCBpZiBjbGlja2VkIG91dHNpZGUKICAgIGRvY3VtZW50Lm9uY2xpY2sgPSBmdW5jdGlvbihlKXsKICAgICAgaWYoKGUudGFyZ2V0KS5jbG9zZXN0KCIjY2FydC1ib3giKSB8fCAoZS50YXJnZXQpLmNsb3Nlc3QoIiNjdXN0b20tY2FydCIpKXsKICAgICAgfWVsc2V7CiAgICAgICAgdm0uaXNfY2Vuc2VfY2FydCA9IGZhbHNlOwogICAgICB9CiAgICB9OwogIH0sCiAgdXBkYXRlZCgpIHsKICAgIHRoaXMuc3VibWl0X2N1c3RvbV9mb3JtKCk7CiAgfSwKICBtZXRob2RzOiB7CiAgICBsb2FkX3dpZGdldF9zZXR0aW5ncygpewogICAgICBheGlvcwogICAgICAgIC5wb3N0KAogICAgICAgICAgYXBpX2NhbGxzLmdldF93aWRnZXRfc2V0dGluZ3MoKSwKICAgICAgICAgIHsKICAgICAgICAgICAgY29tcGFueW5hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgICAgICAgIGNvbXBhbnlpZDogdGhpcy5jb21wYW55aWQsCiAgICAgICAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIHRva2VuOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikudG9rZW5zLAogICAgICAgICAgICBpc1Nob3c6IHRydWUsCiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuJHNlc3Npb24uZ2V0KCJhdCIpfWAsCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC50aXRsZSA9IHJlc3BvbnNlLmRhdGEuV2lkZ2V0VGl0bGU7CiAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmxvZ28gPSByZXNwb25zZS5kYXRhLkltYWdlVXJsOwogICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fdGhlbWUgPSByZXNwb25zZS5kYXRhLkJ1dHRvblRoZW1lOwogICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fYm9yZGVyX3RoZW1lID0gcmVzcG9uc2UuZGF0YS5CdXR0b25Cb3JkZXJUaGVtZSA9PT0gbnVsbCA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX2JvcmRlcl90aGVtZSA6IHJlc3BvbnNlLmRhdGEuQnV0dG9uQm9yZGVyVGhlbWU7CiAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LnVzZXJfbXNnX2ZvbnRfY29sb3IgPSByZXNwb25zZS5kYXRhLlVzZXJNZXNzYWdlRm9udENvbG9yID09PSBudWxsID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC51c2VyX21zZ19mb250X2NvbG9yIDogcmVzcG9uc2UuZGF0YS5Vc2VyTWVzc2FnZUZvbnRDb2xvcjsKICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X3Jlc3BvbnNlX2ZvbnRfY29sb3IgPSByZXNwb25zZS5kYXRhLkJvdFJlc3BvbnNlRm9udENvbG9yID09PSBudWxsID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfcmVzcG9uc2VfZm9udF9jb2xvciA6IHJlc3BvbnNlLmRhdGEuQm90UmVzcG9uc2VGb250Q29sb3I7ICAgIAogICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfZm9udF9zdHlsZSA9IHJlc3BvbnNlLmRhdGEuQm90Rm9udC5Gb250U3R5bGU7CiAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9mb250X2NvbG9yX3NlbmRlciA9IHJlc3BvbnNlLmRhdGEuQm90Rm9udC5Gb250Q29sb3JTZW5kZXI7CiAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9mb250X2NvbG9yX3JlY2VpdmVyID0gcmVzcG9uc2UuZGF0YS5Cb3RGb250LkZvbnRDb2xvclJlY2VpdmVyOwogICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9idXR0b25zID0gcmVzcG9uc2UuZGF0YS5Cb3RGb250LkZvbnRDb2xvckJ1dHRvbnM7CiAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJvdF90aGVtZSA9IHJlc3BvbnNlLmRhdGEuQm90VGhlbWU7CiAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmlzX3Bvd2VyZWRfYnlfY2Vuc2UgPSByZXNwb25zZS5kYXRhLklzUG93ZXJlZEJ5Q2Vuc2UgPT09IHVuZGVmaW5lZCA/IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuaXNfcG93ZXJlZF9ieV9jZW5zZSA6IHJlc3BvbnNlLmRhdGEuSXNQb3dlcmVkQnlDZW5zZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fYWxpZ25tZW50ID0gcmVzcG9uc2UuZGF0YS5Cb3RTdHlsaW5nOwogICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfaWNvbiA9IHJlc3BvbnNlLmRhdGEuQm90SW1hZ2VVcmw7CiAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJ1dHRvbl92ZXJ0aWNhbF9zcGFjaW5nID0KICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5CdXR0b25TdHlsaW5nLnZlcnRpY2FsOwogICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25faG9yaXpvbnRhbF9zcGFjaW5nID0KICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5CdXR0b25TdHlsaW5nLmhvcml6b250YWw7CiAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9iYWNrZ3JvdW5kX2ltYWdlID0gcmVzcG9uc2UuZGF0YS5CZ0ltYWdlVXJsOwogICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5oZWFkZXJfYmFja2dyb3VuZCA9IHJlc3BvbnNlLmRhdGEuSGVhZGVyVGhlbWU7CiAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBsZXQgaXNfdmlzaWJsZV9ncmVldGluZ3MgPSByZXNwb25zZS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlcy5tYXAoaXRlbSA9PiB7CiAgICAgICAgICAgICAgcmV0dXJuIChpdGVtLnZpc2libGUgIT09IHVuZGVmaW5lZCkgPyBpdGVtLnZpc2libGUgOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihpc192aXNpYmxlX2dyZWV0aW5ncy5pbmNsdWRlcyh0cnVlKSl7CiAgICAgICAgICAgICAgdGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uID0gcmVzcG9uc2UuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXMubGVuZ3RoIC0xOwogICAgICAgICAgICAgIGlmIChCb29sZWFuKHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzW3RoaXMuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbl1bJ2J1dHRvbnMnXSkpewogICAgICAgICAgICAgICAgdmFyIHZpc2libGVfYnV0dG9ucyA9IHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzW3RoaXMuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbl1bJ2J1dHRvbnMnXTsKICAgICAgICAgICAgICAgIHZpc2libGVfYnV0dG9ucyA9IHZpc2libGVfYnV0dG9ucy5maWx0ZXIoKGJ1dHRvbik9PnsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGJ1dHRvblsndmlzaWJsZSddID09PSB0cnVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlc1t0aGlzLmdyZWV0aW5nX2J1dHRvbnNfcG9zaXRpb25dWydidXR0b25zJ10gPSB2aXNpYmxlX2J1dHRvbnM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IHZpc2libGVfZ3JlZXRpbmdzX21hcCA9IGlzX3Zpc2libGVfZ3JlZXRpbmdzLnJlZHVjZSgoYWNjLCBlKSA9PiBhY2Muc2V0KGUsIChhY2MuZ2V0KGUpIHx8IDApICsgMSksIG5ldyBNYXAoKSk7CiAgICAgICAgICAgICAgbGV0IHNwbGljZV9pbmRleCA9IFtdOwogICAgICAgICAgICAgIGlmKCh2aXNpYmxlX2dyZWV0aW5nc19tYXAuZ2V0KHRydWUpICE9PSByZXNwb25zZS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlcy5sZW5ndGgpKXsKICAgICAgICAgICAgICAgIGlmKHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzW3RoaXMuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbl0udmlzaWJsZSA9PT0gZmFsc2UpewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzLmxlbmd0aC0xOyBpID49IDA7IGktLSl7CiAgICAgICAgICAgICAgICAgICAgICBpZihyZXNwb25zZS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlc1tpXS52aXNpYmxlID09PSBmYWxzZSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzWyhpLTEgPCAwKSA/IGkgOiBpLTFdWydidXR0b25zJ10gPSB2aXNpYmxlX2J1dHRvbnM7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbiA9ICh0aGlzLmdyZWV0aW5nX2J1dHRvbnNfcG9zaXRpb24tMSA8IDApID8gdGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uIDogdGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uLTE7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwbGljZV9pbmRleC5wdXNoKGkpCiAgICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzLmxlbmd0aC0xOyBpID49IDA7IGktLSl7CiAgICAgICAgICAgICAgICAgICAgaWYocmVzcG9uc2UuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXNbaV0udmlzaWJsZSA9PT0gZmFsc2UpewogICAgICAgICAgICAgICAgICAgICAgdGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uID0gKHRoaXMuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbi0xIDwgMCkgPyB0aGlzLmdyZWV0aW5nX2J1dHRvbnNfcG9zaXRpb24gOiB0aGlzLmdyZWV0aW5nX2J1dHRvbnNfcG9zaXRpb24tMTsKICAgICAgICAgICAgICAgICAgICAgIHNwbGljZV9pbmRleC5wdXNoKGkpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgc3BsaWNlX2luZGV4Lmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlcy5zcGxpY2Uoc3BsaWNlX2luZGV4W2luZGV4XSwxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5wdXNoX21zZygKICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuQm90R3JlZXRpbmdzLAogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXMKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9ZWxzZSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzX3JldGFpbF9ib3QpIHsKICAgICAgICAgICAgICB0aGlzLmxvYWRfY2hhdGJvdF9pbnRlZ3JhdGlvbl9kZXRhaWxzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLmNoYXRfd2lkZ2V0LmJ1dHRvbl9hbGlnbm1lbnQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJ1dHRvbl9hbGlnbm1lbnQgPSAiZmxleC1lbmQiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuY2hhdF93aWRnZXQuYm90X2ljb24gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9pY29uID0gIi9pbWcvQm90X2ltZy5wbmciOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoIkNoYXRCb3RJbWFnZVBhcmFtZXRlcnMiLCB0aGlzLmNoYXRfd2lkZ2V0KTsKICAgICAgICAgIGxldCBzdHlsaW5nX3ZhbHVlID0gcmVzcG9uc2UuZGF0YS5IZWFkZXJTdHlsaW5nLnZhbHVlOwogICAgICAgICAgbGV0IHRlbXBfc3RyaW5nID0gIiI7CiAgICAgICAgICBpZiAoc3R5bGluZ192YWx1ZSA9PT0gImxlZnQiKSB7CiAgICAgICAgICAgIHRlbXBfc3RyaW5nID0gIm1hcmdpbi1sZWZ0OiAwO21hcmdpbi1yaWdodDogYXV0bzsiOwogICAgICAgICAgfSBlbHNlIGlmIChzdHlsaW5nX3ZhbHVlID09PSAicmlnaHQiKSB7CiAgICAgICAgICAgIHRlbXBfc3RyaW5nID0gIm1hcmdpbi1sZWZ0OiBhdXRvO21hcmdpbi1yaWdodDogMDsiOwogICAgICAgICAgfSBlbHNlIGlmIChzdHlsaW5nX3ZhbHVlID09PSAiY2VudGVyIikgewogICAgICAgICAgICB0ZW1wX3N0cmluZyA9ICJtYXJnaW4tbGVmdDogYXV0bzttYXJnaW4tcmlnaHQ6IGF1dG87IjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRlbXBfc3RyaW5nID0gIm1hcmdpbi1sZWZ0OiBhdXRvO21hcmdpbi1yaWdodDogYXV0bzsiOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5zdHlsZSA9CiAgICAgICAgICAgICJtYXJnaW4tdG9wOiA1cHg7aGVpZ2h0OjMwcHg7d2lkdGg6YXV0bzttYXgtd2lkdGg6MTAwJSAhaW1wb3J0YW50OyIgKwogICAgICAgICAgICB0ZW1wX3N0cmluZzsKICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgaWYgKHRoaXMuaXNfcmV0YWlsX2JvdCkgewogICAgICAgICAgICB0aGlzLmxvYWRfY2hhdGJvdF9pbnRlZ3JhdGlvbl9kZXRhaWxzKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZS5yZXNwb25zZSkgewogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQxMCB8fAogICAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0NDAgfHwKICAgICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA5CiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHRoaXMuJHJvb3QuJGVtaXQoIlNlc3Npb25fRXhwaXJlZCIsIGUucmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lID09ICJnb2d5YiIpIHsKICAgICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LnN0eWxlID0KICAgICAgICAgICAgICAgICJtYXJnaW4tdG9wOiA1cHg7aGVpZ2h0OjMwcHg7d2lkdGg6NjBweDttYXJnaW4tbGVmdDogYXV0bzttYXJnaW4tcmlnaHQ6IGF1dG87IjsKICAgICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmxvZ28gPSAiL2ltZy9jZW5zZV9pbWFnZS5wbmciOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X2ljb24gPSAiL2ltZy9Cb3RfaW1nLnBuZyI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fdmVydGljYWxfc3BhY2luZyA9ICI1IjsKICAgICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJ1dHRvbl9ob3Jpem9udGFsX3NwYWNpbmcgPSAiMyI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfYmFja2dyb3VuZF9pbWFnZSA9ICIiOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuaGVhZGVyX2JhY2tncm91bmQgPSAiI2ZmZmZmZiI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fdGhlbWUgPSAiIzFkYWFlMSI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC51c2VyX21zZ19mb250X2NvbG9yID0gIiMyNzM2NzkiOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X3Jlc3BvbnNlX2ZvbnRfY29sb3IgPSAiIzI3MzY3OSI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfdGhlbWUgPSAiIzI3MzY3OSI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fYm9yZGVyX3RoZW1lID0gIiMyNzM2NzkiOwogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUgPT0gIk1UIENhcmUiCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQubG9nbyA9ICIvaW1nL3JvYm9tYXRlX2xvZ28ucG5nIjsKICAgICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LnN0eWxlID0KICAgICAgICAgICAgICAgICJtYXJnaW4tdG9wOiA1cHg7aGVpZ2h0OjUwcHg7d2lkdGg6OTVweDttYXJnaW4tbGVmdDogYXV0bzttYXJnaW4tcmlnaHQ6IGF1dG87IjsKICAgICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9pY29uID0gIi9pbWcvQm90X2ltZy5wbmciOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX3ZlcnRpY2FsX3NwYWNpbmcgPSAiNSI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25faG9yaXpvbnRhbF9zcGFjaW5nID0gIjMiOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X2JhY2tncm91bmRfaW1hZ2UgPSAiIjsKICAgICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmhlYWRlcl9iYWNrZ3JvdW5kID0gIiNmZmZmZmYiOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX3RoZW1lID0gIiMxZGFhZTEiOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X3RoZW1lID0gIiMyNzM2NzkiOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX2JvcmRlcl90aGVtZSA9ICIjMjczNjc5IjsKICAgICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LnVzZXJfbXNnX2ZvbnRfY29sb3IgPSAiIzI3MzY3OSI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfcmVzcG9uc2VfZm9udF9jb2xvciA9ICIjMjczNjc5IjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmxvZ28gPSAiL2ltZy9jZW5zZV9pbWFnZS5wbmciOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuc3R5bGUgPQogICAgICAgICAgICAgICAgIm1hcmdpbi10b3A6IDVweDtoZWlnaHQ6MzBweDt3aWR0aDo2MHB4O21hcmdpbi1sZWZ0OiBhdXRvO21hcmdpbi1yaWdodDogYXV0bzsiOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X2ljb24gPSAiL2ltZy9Cb3RfaW1nLnBuZyI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fdmVydGljYWxfc3BhY2luZyA9ICI1IjsKICAgICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJ1dHRvbl9ob3Jpem9udGFsX3NwYWNpbmcgPSAiMyI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfYmFja2dyb3VuZF9pbWFnZSA9ICIiOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuaGVhZGVyX2JhY2tncm91bmQgPSAiI2ZmZmZmZiI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fdGhlbWUgPSAiIzFkYWFlMSI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfdGhlbWUgPSAiIzI3MzY3OSI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fYm9yZGVyX3RoZW1lID0gIiMyNzM2NzkiOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQudXNlcl9tc2dfZm9udF9jb2xvciA9ICIjMjczNjc5IjsKICAgICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9yZXNwb25zZV9mb250X2NvbG9yID0gIiMyNzM2NzkiOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X2ZvbnRfc3R5bGUgPSAnUm9ib3RvJzsKICAgICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9mb250X2NvbG9yX3NlbmRlciA9ICcjZmZmZmZmJzsKICAgICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9mb250X2NvbG9yX3JlY2VpdmVyID0gJyMwMDAwMDAnOwogICAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X2ZvbnRfY29sb3JfYnV0dG9ucyA9ICcjZmZmZmZmJzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgiQ2hhdEJvdEltYWdlUGFyYW1ldGVycyIsIHRoaXMuY2hhdF93aWRnZXQpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKICAgIGxvYWRfY2hhdGJvdF9pbnRlZ3JhdGlvbl9kZXRhaWxzKCl7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoCiAgICAgICAgICBhcGlfY2FsbHMuY2hhdGJvdF9pbnRlZ3JhdGlvbl9kZXRhaWxzKCksCiAgICAgICAgICB7CiAgICAgICAgICAgIGlzX2dldDogdHJ1ZSwKICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLmNvbXBhbnluYW1lLAogICAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLmNvbXBhbnlpZCwKICAgICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuJHNlc3Npb24uZ2V0KCJhdCIpfWAsCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuc3RhdHVzID09PSAic3VjY2VzcyIpIHsKICAgICAgICAgICAgdGhpcy5jaGF0Ym90X2ludGVncmF0aW9uX2RldGFpbHNfcmVzcG9uc2UocmVzcG9uc2UpOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICAvLyB0aGlzLnNob3BpZnlfcmV0YWlsX3Nob3BfbmFtZSA9ICJlYXJ0aG9uIjsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQxMCB8fAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDQwIHx8CiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MDkKICAgICAgICAgICkgewogICAgICAgICAgICB0aGlzLiRyb290LiRlbWl0KCJTZXNzaW9uX0V4cGlyZWQiLCBlLnJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICBheGlvcwogICAgICAgICAgICAgICAgLnBvc3QoCiAgICAgICAgICAgICAgICAgIGFwaV9jYWxscy5jaGF0Ym90X2ludGVncmF0aW9uX2RldGFpbHMoKSwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlzX2dldDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgICAgICAgICAgICAgICAgY29tcGFueV9pZDogdGhpcy5jb21wYW55aWQsCiAgICAgICAgICAgICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpCiAgICAgICAgICAgICAgICAgICAgICAubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuc3RhdHVzID09PSAic3VjY2VzcyIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXRib3RfaW50ZWdyYXRpb25fZGV0YWlsc19yZXNwb25zZShyZXNwb25zZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCiAgICBjaGF0Ym90X2ludGVncmF0aW9uX2RldGFpbHNfcmVzcG9uc2UocmVzcG9uc2UpewogICAgICB0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID0gcmVzcG9uc2UuZGF0YS5kYXRhLnJldGFpbF93ZWJfZnJhbWV3b3JrOwogICAgICB2YXIgd2ViZnJhbWV3b3JrID0gcmVzcG9uc2UuZGF0YS5kYXRhW3RoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgKyAnX2RldGFpbHMnXTsKICAgICAgdGhpcy5zaG93X2N1c3RvbV9jYXJ0ID0gdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayAhPSBudWxsID8gdHJ1ZSA6IGZhbHNlOwogICAgICBpZih3ZWJmcmFtZXdvcmsgIT09IG51bGwgJiYKICAgICAgICB3ZWJmcmFtZXdvcmsgIT09IHt9KXsKICAgICAgICB0aGlzLnJldGFpbF9zaG9wX2N1cnJlbmN5ID0gd2ViZnJhbWV3b3JrLmJhc2VfY3VycmVuY3kudmFsdWUgfHwgIlVTRCI7CiAgICAgICAgdGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQgPSB3ZWJmcmFtZXdvcmsub3JkZXJfcmV0cmlldmFsX29ubHlfZW1haWxfcmVxdWlyZWQgfHwgZmFsc2U7CiAgICAgICAgdGhpcy5jb250YWN0X2hlbHBfZW1haWwgPSB3ZWJmcmFtZXdvcmsuY29udGFjdF9oZWxwX2VtYWlsOwogICAgICAgIHRoaXMucmV2aWV3X3Jlc3BvbnNlX21lc3NhZ2UgPSB3ZWJmcmFtZXdvcmsucmV2aWV3X3Jlc3BvbnNlX21lc3NhZ2U7CiAgICAgICAgdGhpcy5yZXZpZXdfbWVzc2FnZV9maXJzdCA9IHdlYmZyYW1ld29yay5yZXZpZXdfbWVzc2FnZV9maXJzdDsKICAgICAgICB0aGlzLnJldmlld19tZXNzYWdlX3NlY29uZCA9IHdlYmZyYW1ld29yay5yZXZpZXdfbWVzc2FnZV9zZWNvbmQ7CiAgICAgICAgdGhpcy5kaXNwbGF5X3Byb2R1Y3RzID0gd2ViZnJhbWV3b3JrLmRpc3BsYXlfcHJvZHVjdHNfb25fbGFuZGluZzsKICAgICAgICB0aGlzLmlzX2Rpc3BsYXlfYmFubmVyX29uX2xhbmRpbmcgPSB3ZWJmcmFtZXdvcmsuaXNfZGlzcGxheV9iYW5uZXJfb25fbGFuZGluZzsKICAgICAgICBpZih0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJzaG9waWZ5Iil7CiAgICAgICAgICB0aGlzLnNob3BpZnlfcmV0YWlsX3Nob3BfbmFtZSA9IHdlYmZyYW1ld29yay5zaG9waWZ5X3Nob3BfbmFtZTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgIHRoaXMuc2hvcF91cmwgPSB3ZWJmcmFtZXdvcmtbdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayArICdfc2hvcF91cmwnXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgaWYoIXRoaXMuaXNQcmV2aWV3Qm90KXsKICAgICAgICAgIHRoaXMuZ2V0X3Zpc2l0b3JzX2N1cnJlbnRfbG9jYXRpb24oKTsKICAgICAgICB9ZWxzZSBpZihCb29sZWFuKHRoaXMuY3VycmVudF9wcmV2aWV3X2Jhbm5lcl9pZCkpewogICAgICAgICAgdGhpcy5wcmV2aWV3X2Jhbm5lcigpOwogICAgICAgIH0KICAgICAgLy8gfSwgMzAwMCk7CiAgICB9LAogICAgY29udGFjdF91c19waG9uZV9udW1iZXIocGhvbmVfbnVtYmVyKXsKICAgICAgaWYoQm9vbGVhbihwaG9uZV9udW1iZXIpKXsKICAgICAgICByZXR1cm4gIiBvciBjYWxsIHVzIGF0OiAiICsgcGhvbmVfbnVtYmVyOwogICAgICB9ZWxzZXsKICAgICAgICByZXR1cm4gJyc7CiAgICAgIH0KICAgIH0sCiAgICB1cGRhdGVfdmFyaWF0aW9uKGNoYXRfaWQsIHByb2R1Y3RfaW5kZXgsIHRpdGxlKXsKICAgICAgZm9yKHZhciBpIGluIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnZhcmlhdGlvbnMpewogICAgICAgIGlmICh0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYXRpb25zW2ldLnZhcmlhbnRfdGl0bGUgPT0gdGl0bGUpewogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0uaW1nX3VybCA9ICh0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYXRpb25zW2ldLmltZ191cmwpOwogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0uaWQgPSB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYXRpb25zW2ldLmlkOwogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0ucGVybWFsaW5rID0gdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9uc1tpXS5wZXJtYWxpbms7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS5wcmljZSA9IHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnZhcmlhdGlvbnNbaV0ucHJpY2U7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS5yZWd1bGFyX3ByaWNlID0gdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9uc1tpXS5yZWd1bGFyX3ByaWNlOwogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0uc3RvY2tfcXVhbnRpdHkgPSB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYXRpb25zW2ldLnN0b2NrX3F1YW50aXR5OwogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0uc3RvY2tfc3RhdHVzID0gdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9uc1tpXS5zdG9ja19zdGF0dXM7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYW50X3RpdGxlID0gdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9uc1tpXS52YXJpYW50X3RpdGxlOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBjb25zdCBmb3VuZCA9IHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnZhcmlhdGlvbnMuc29tZShlbCA9PiBlbC52YXJpYW50X3RpdGxlID09ICJEZWZhdWx0Iik7CiAgICAgIC8vIGlmICghZm91bmQpIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnZhcmlhdGlvbnMucHVzaChkZWZhdWx0X3ZhbHVlcyk7CiAgICB9LAogICAgZ2V0X3Zpc2l0b3JzX2N1cnJlbnRfbG9jYXRpb24oKXsKICAgICAgaWYodGhpcy5pc19kaXNwbGF5X2Jhbm5lcl9vbl9sYW5kaW5nID09PSB0cnVlKXsKICAgICAgICBsZXQgY3V0b2ZmID0gbmV3IERhdGU7CiAgICAgICAgdmFyIGRhdGVfdGltZSA9IG1vbWVudC51dGMoY3V0b2ZmLCBbCiAgICAgICAgICAgICAgIllZWVktTU0tREQgSEg6bW06c3MiLAogICAgICAgICAgICBdKS5mb3JtYXQoIllZWVktTU0tREQgSEg6bW06c3MiKQogICAgICAgIHZhciB2bSA9IHRoaXM7CiAgICAgICAgJC5nZXRKU09OKHZtLnZpc2l0b3JzX2N1cnJlbnRfbG9jYXRpb25fdXJsLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBpZihkYXRhKXsKICAgICAgICAgICAgdm0udmlzaXRvcnNfY3VycmVudF9sb2NhdGlvbiA9IHsKICAgICAgICAgICAgICAiaXBfYWRkcmVzcyIgOiBkYXRhLmlwX2FkZHJlc3MsCiAgICAgICAgICAgICAgImNpdHkiIDogZGF0YS5jaXR5LAogICAgICAgICAgICAgICJjaXR5X2dlb25hbWVfaWQiIDogZGF0YS5jaXR5X2dlb25hbWVfaWQsCiAgICAgICAgICAgICAgInJlZ2lvbiIgOiBkYXRhLnJlZ2lvbiwKICAgICAgICAgICAgICAicmVnaW9uX2lzb19jb2RlIiA6IGRhdGEucmVnaW9uX2lzb19jb2RlLAogICAgICAgICAgICAgICJyZWdpb25fZ2VvbmFtZV9pZCIgOiBkYXRhLnJlZ2lvbl9nZW9uYW1lX2lkLAogICAgICAgICAgICAgICJwb3N0YWxfY29kZSIgOiBkYXRhLnBvc3RhbF9jb2RlLAogICAgICAgICAgICAgICJjb3VudHJ5IiA6IGRhdGEuY291bnRyeSwKICAgICAgICAgICAgICAiY291bnRyeV9jb2RlIiA6IGRhdGEuY291bnRyeV9jb2RlLAogICAgICAgICAgICAgICJjb3VudHJ5X2dlb25hbWVfaWQiIDogZGF0YS5jb3VudHJ5X2dlb25hbWVfaWQsCiAgICAgICAgICAgICAgImNvdW50cnlfaXNfZXUiIDogZGF0YS5jb3VudHJ5X2lzX2V1LAogICAgICAgICAgICAgICJjb250aW5lbnQiIDogZGF0YS5jb250aW5lbnQsCiAgICAgICAgICAgICAgImNvbnRpbmVudF9jb2RlIiA6IGRhdGEuY29udGluZW50X2NvZGUsCiAgICAgICAgICAgICAgImNvbnRpbmVudF9nZW9uYW1lX2lkIiA6IGRhdGEuY29udGluZW50X2dlb25hbWVfaWQsCiAgICAgICAgICAgICAgImxvbmdpdHVkZSIgOiBkYXRhLmxvbmdpdHVkZSwKICAgICAgICAgICAgICAibGF0aXR1ZGUiIDogZGF0YS5sYXRpdHVkZSwKICAgICAgICAgICAgICAic2VjdXJpdHkiIDogZGF0YS5zZWN1cml0eSwKICAgICAgICAgICAgICAiZGF0ZV90aW1lIiA6IGRhdGVfdGltZSwKICAgICAgICAgICAgfQogICAgICAgICAgICB2bS5pc19kaXNwbGF5X2Jhbm5lcigpOwogICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHZtLmlzX2Rpc3BsYXlfcHJvZHVjdHMoKTsKICAgICAgICAgIH0KICAgICAgICB9KS5lcnJvcihmdW5jdGlvbigpIHsgCiAgICAgICAgICB2bS5pc19kaXNwbGF5X3Byb2R1Y3RzKCk7CiAgICAgICAgfSk7CiAgICAgIH1lbHNlewogICAgICAgIHRoaXMuaXNfZGlzcGxheV9wcm9kdWN0cygpOwogICAgICB9CiAgICB9LAogICAgcHJldmlld19iYW5uZXIoKXsKICAgICAgYXhpb3MKICAgICAgICAucG9zdCgKICAgICAgICAgIGFwaV9jYWxscy5iYW5uZXJfdGVtcGxhdGUoKSwKICAgICAgICAgIHsKICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLmNvbXBhbnluYW1lLAogICAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLmNvbXBhbnlpZCwKICAgICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICAgIHN1YnNjcmlwdGlvbjogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnN1YnNjcmlwdGlvbiwKICAgICAgICAgICAgaXNfcHJldmlld19iYW5uZXI6IHRydWUsCiAgICAgICAgICAgIGJhbm5lcl9pZDogdGhpcy5jdXJyZW50X3ByZXZpZXdfYmFubmVyX2lkLAogICAgICAgICAgfSwKICAgICAgICAgIHsKICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLiRzZXNzaW9uLmdldCgiYXQiKX1gLAogICAgICAgICAgICB9LAogICAgICAgICAgfQogICAgICAgICkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT0gMjAwKSB7CiAgICAgICAgICAgIGlmKEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXMubGVuZ3RoID4gMCkpewogICAgICAgICAgICAgIHRoaXMucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQxMCB8fAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDQwIHx8CiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MDkKICAgICAgICAgICkgewogICAgICAgICAgICB0aGlzLiRyb290LiRlbWl0KCJTZXNzaW9uX0V4cGlyZWQiLCBlLnJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKICAgIGlzX2Rpc3BsYXlfYmFubmVyKCl7CiAgICAgIGF4aW9zCiAgICAgICAgLmdldChhcGlfY2FsbHMuYmFubmVyX3RlbXBsYXRlKCksewogICAgICAgICAgcGFyYW1zOiB7ICAgICAgCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgaXNfZGlzcGxheV9iYW5uZXI6IHRydWUsCiAgICAgICAgICAgIHZpc2l0b3JzX2N1cnJlbnRfbG9jYXRpb246IHRoaXMudmlzaXRvcnNfY3VycmVudF9sb2NhdGlvbiwKICAgICAgICAgICAgCiAgICAgICAgICB9LAogICAgICAgIH0pCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09IDIwMCkgewogICAgICAgICAgICBpZihCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA+IDApKXsKICAgICAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhpcy5pc19kaXNwbGF5X3Byb2R1Y3RzKCk7CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgIHRoaXMuaXNfZGlzcGxheV9wcm9kdWN0cygpOwogICAgICAgICAgaWYgKAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDEwIHx8CiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0NDAgfHwKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQwOQogICAgICAgICAgKSB7CiAgICAgICAgICAgIHRoaXMuJHJvb3QuJGVtaXQoIlNlc3Npb25fRXhwaXJlZCIsIGUucmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAogICAgaXNfZGlzcGxheV9wcm9kdWN0cygpewogICAgICBpZih0aGlzLmRpc3BsYXlfcHJvZHVjdHMgPT09IHRydWUpewogICAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmRpc3BsYXlfbGFuZGluZ19wcm9kdWN0cygpLCB7CiAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgfSkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsgCiAgICAgICAgICB2YXIgcHJvZHVjdHNfY291bnQgPSByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1swXS5wcm9kdWN0cy5wcm9kdWN0c19saXN0Lmxlbmd0aDsKICAgICAgICAgIGlmIChwcm9kdWN0c19jb3VudCA+IDApewogICAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuaXNfcmV2aWV3X3JhdGluZygpOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICB0aGlzLmlzX3Jldmlld19yYXRpbmcoKTsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQxMCB8fAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDQwIHx8CiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MDkKICAgICAgICAgICkgewogICAgICAgICAgICB0aGlzLiRyb290LiRlbWl0KCJTZXNzaW9uX0V4cGlyZWQiLCBlLnJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9ZWxzZXsKICAgICAgICB0aGlzLmlzX3Jldmlld19yYXRpbmcoKTsKICAgICAgfQogICAgfSwKICAgIGNoZWNrX3Nob3BpZnlfY3VzdG9tZXJfdG9rZW5fZXhwaXJ5KCkgewogICAgICBsZXQgY3V0b2ZmID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW5fZXhwaXJ5Iik7CiAgICAgIGN1dG9mZiA9IG1vbWVudChjdXRvZmYsIFsiWVlZWS1NTS1ERFRoaDptbTpzc1oiXSk7CiAgICAgIHZhciBjdXJyZW50X3RpbWUgPSBuZXcgRGF0ZShjdXRvZmYpOwogICAgICBpZiAobW9tZW50KCkuaXNCZWZvcmUoY3VycmVudF90aW1lKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSwKICAgIGlzX3Jldmlld19yYXRpbmcoKSB7CiAgICAgIGlmKEJvb2xlYW4odGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiKSkgfHwgQm9vbGVhbih0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpKSkgewogICAgICAgIGxldCBzdHJpbmdpZmllZF9jdXN0b21lcl9wYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgY3VzdG9tZXJJZDogdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiKSwKICAgICAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpCiAgICAgICAgfSk7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICBjaGF0OiBgL3JldHJpZXZlX2N1c3RvbWVyX29yZGVycyR7c3RyaW5naWZpZWRfY3VzdG9tZXJfcGF5bG9hZH1gLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogZmFsc2UsCiAgICAgICAgICB9KQogICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgIGlmKEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tKSl7CiAgICAgICAgICAgICAgaWYoQm9vbGVhbihyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1swXS5jdXN0b20ub3JkZXJzX2xpc3QubGVuZ3RoID4gMCkpewogICAgICAgICAgICAgICAgdGhpcy5jYWxsX3Jldmlld19yYXRpbmcocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tLm9yZGVyc19saXN0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOyAKICAgICAgfQogICAgfSwKICAgIGNhbGxfcmV2aWV3X3JhdGluZyhkYXRhKXsKICAgICAgdmFyIGZ1bGZpbGxlZF9vcmRlcnMgPSBkYXRhLmZpbHRlcihmdWxmaWxsZWRfb3JkZXI9PnsKICAgICAgICByZXR1cm4gZnVsZmlsbGVkX29yZGVyLmZ1bGZpbGxtZW50X3N0YXR1cyA9PT0gImZ1bGZpbGxlZCI7CiAgICAgIH0pOwogICAgICB2YXIgc29ydGVkX2Z1bGZpbGxlZF9vcmRlcnMgPSBmdWxmaWxsZWRfb3JkZXJzLm1hcChpdGVtPT57CiAgICAgICAgcmV0dXJuIGl0ZW0ubGluZV9pdGVtcy5tYXAocHJvZHVjdD0+IHsKICAgICAgICAgIHJldHVybiBwcm9kdWN0OwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgYXhpb3MKICAgICAgICAucG9zdCgKICAgICAgICAgIGFwaV9jYWxscy5wcm9kdWN0X3Jldmlld19yYXRpbmcoKSwKICAgICAgICAgIHsKICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLmNvbXBhbnluYW1lLAogICAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLmNvbXBhbnlpZCwKICAgICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICB3ZWJfZnJhbWV3b3JrOiB0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrLAogICAgICAgICAgICBpc19nZXRfcmV2aWV3ZWRfcHJvZHVjdF9pZDogdHJ1ZSwKICAgICAgICAgICAgcmV2aWV3X3JhdGluZ19jdXN0b21lcl9pZDogdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiKSwKICAgICAgICAgICAgcmV2aWV3X3JhdGluZ19jdXN0b21lcl9lbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iKQogICAgICAgICAgfSwKICAgICAgICAgIHsKICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLiRzZXNzaW9uLmdldCgiYXQiKX1gCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICApCiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgaWYocmVzcG9uc2UuZGF0YS5pc19yZXZpZXcgPT09IHRydWUpewogICAgICAgICAgICB2YXIgcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzID0gW107CiAgICAgICAgICAgIHZhciBub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzID0gW107CiAgICAgICAgICAgIHZhciByZXZpZXdlZF9wcm9kdWN0X2lkX2xpc3QgPSByZXNwb25zZS5kYXRhLnByb2R1Y3RfaWRfbGlzdDsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzb3J0ZWRfZnVsZmlsbGVkX29yZGVycy5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzb3J0ZWRfZnVsZmlsbGVkX29yZGVyc1tpXS5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgaWYgKHJldmlld2VkX3Byb2R1Y3RfaWRfbGlzdC5pbmNsdWRlcyhzb3J0ZWRfZnVsZmlsbGVkX29yZGVyc1tpXVtqXS5wcm9kdWN0X2lkKSl7CiAgICAgICAgICAgICAgICAgIHJldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5wdXNoKHNvcnRlZF9mdWxmaWxsZWRfb3JkZXJzW2ldW2pdKTsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICBub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLnB1c2goc29ydGVkX2Z1bGZpbGxlZF9vcmRlcnNbaV1bal0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZihub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLmxlbmd0aCA+IDAgJiYKICAgICAgICAgICAgICBCb29sZWFuKHRoaXMucmV2aWV3X21lc3NhZ2VfZmlyc3QpID09PSB0cnVlICYmCiAgICAgICAgICAgICAgQm9vbGVhbih0aGlzLnJldmlld19tZXNzYWdlX3NlY29uZCkgPT09IHRydWUgJiYKICAgICAgICAgICAgICBCb29sZWFuKHRoaXMucmV2aWV3X3Jlc3BvbnNlX21lc3NhZ2UpID09PSB0cnVlCiAgICAgICAgICAgICl7CiAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgIC5wb3N0KAogICAgICAgICAgICAgICAgICBhcGlfY2FsbHMucHJvZHVjdF9yZXZpZXdfcmF0aW5nKCksCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgICAgICAgICAgICAgICAgY29tcGFueV9pZDogdGhpcy5jb21wYW55aWQsCiAgICAgICAgICAgICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgICAgIHdlYl9mcmFtZXdvcms6IHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmssCiAgICAgICAgICAgICAgICAgICAgaXNfZ2V0X3Byb2R1Y3RfaW1hZ2U6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgcHJvZHVjdF9pZDogbm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlsc1swXS5wcm9kdWN0X2lkCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICAgICAgICBpZihyZXNwb25zZS5kYXRhLk1TRyA9PT0gJ0ltYWdlIFJlY2VpdmVkIFN1Y2Nlc3NmdWxseScpewogICAgICAgICAgICAgICAgICAgIHZhciBwcm9kdWN0X3Jldmlld19pbWdfdXJsID0gcmVzcG9uc2UuZGF0YS5pbWFnZV9zcmM7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgICAgICAgICAgIGlzX3Jldmlld19yYXRpbmdfcHJvZHVjdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgIG5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHM6IG5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHNbMF0sCiAgICAgICAgICAgICAgICAgICAgICByZXZpZXdfbWVzc2FnZV9maXJzdDogdGhpcy5yZXZpZXdfbWVzc2FnZV9maXJzdCwKICAgICAgICAgICAgICAgICAgICAgIHJldmlld19tZXNzYWdlX3NlY29uZDogdGhpcy5yZXZpZXdfbWVzc2FnZV9zZWNvbmQsCiAgICAgICAgICAgICAgICAgICAgICBwcm9kdWN0X3Jldmlld19pbWdfdXJsOiBwcm9kdWN0X3Jldmlld19pbWdfdXJsLAogICAgICAgICAgICAgICAgICAgICAgcHJvZHVjdF9yYXRpbmc6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICBwcm9kdWN0X3JldmlldzogJycsCiAgICAgICAgICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGUgPT4gewogICAgICAgICAgdG9hc3RyLmVycm9yKCJTb21lIEVycm9yIE9jY3VycmVkLiIpOwogICAgICAgICAgaWYgKAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDEwIHx8CiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0NDAgfHwKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQwOQogICAgICAgICAgKSB7CiAgICAgICAgICAgIHRoaXMuJHJvb3QuJGVtaXQoIlNlc3Npb25fRXhwaXJlZCIsIGUucmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAogICAgc3VibWl0X3Jldmlld19yYXRpbmcoaW5kZXgpewogICAgICBpZiAoQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnByb2R1Y3RfcmF0aW5nKSA9PT0gZmFsc2UpewogICAgICAgIHN3YWwoewogICAgICAgICAgdGV4dDogIlBsZWFzZSBnaXZlIHJhdGluZyIsCiAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgdHlwZTogIndhcm5pbmciLAogICAgICAgICAgcG9zaXRpb246ICJ0b3AtZW5kIiwKICAgICAgICAgIHRpbWVyOiA1MDAwLAogICAgICAgIH0pOwogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIGlmIChCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0ucHJvZHVjdF9yZXZpZXcpID09PSBmYWxzZSl7CiAgICAgICAgc3dhbCh7CiAgICAgICAgICB0ZXh0OiAiUGxlYXNlIHdyaXRlIHJldmlldyIsCiAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgdHlwZTogIndhcm5pbmciLAogICAgICAgICAgcG9zaXRpb246ICJ0b3AtZW5kIiwKICAgICAgICAgIHRpbWVyOiA1MDAwLAogICAgICAgIH0pOwogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJzaG9waWZ5Iil7CiAgICAgICAgdmFyIHByb2R1Y3RfZGV0YWlscyA9IHsKICAgICAgICAgICJwcm9kdWN0X2lkIjp0aGlzLmNoYXRbaW5kZXhdLm5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMucHJvZHVjdF9pZCwKICAgICAgICAgICJuYW1lIjp0aGlzLmNoYXRbaW5kZXhdLm5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMubmFtZSwKICAgICAgICAgICJpbWFnZV9zcmMiOnRoaXMuY2hhdFtpbmRleF0ucHJvZHVjdF9yZXZpZXdfaW1nX3VybCwKICAgICAgICAgICJwcmljZSI6dGhpcy5jaGF0W2luZGV4XS5ub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLnByaWNlLAogICAgICAgICAgInF1YW50aXR5Ijp0aGlzLmNoYXRbaW5kZXhdLm5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMucXVhbnRpdHksCiAgICAgICAgICAidmFyaWFudF9pZCI6dGhpcy5jaGF0W2luZGV4XS5ub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLnZhcmlhbnRfaWQsCiAgICAgICAgfQogICAgICB9ZWxzZSBpZih0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJ3b29jb21tZXJjZSIpewogICAgICAgIHZhciBwcm9kdWN0X2RldGFpbHMgPSB7CiAgICAgICAgICAicHJvZHVjdF9pZCI6dGhpcy5jaGF0W2luZGV4XS5ub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLnByb2R1Y3RfaWQsCiAgICAgICAgICAibmFtZSI6dGhpcy5jaGF0W2luZGV4XS5ub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLm5hbWUsCiAgICAgICAgICAiaW1hZ2Vfc3JjIjp0aGlzLmNoYXRbaW5kZXhdLnByb2R1Y3RfcmV2aWV3X2ltZ191cmwsCiAgICAgICAgICAicHJpY2UiOnRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5wcmljZSwKICAgICAgICAgICJxdWFudGl0eSI6dGhpcy5jaGF0W2luZGV4XS5ub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLnF1YW50aXR5LAogICAgICAgICAgInZhcmlhbnRfaWQiOnRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy52YXJpYXRpb25faWQKICAgICAgICB9CiAgICAgIH1lbHNlIGlmKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iKXsKICAgICAgICB2YXIgcHJvZHVjdF9kZXRhaWxzID0gewogICAgICAgICAgInByb2R1Y3RfaWQiOnRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5wcm9kdWN0X2lkLAogICAgICAgICAgIm5hbWUiOnRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5uYW1lLAogICAgICAgICAgImltYWdlX3NyYyI6dGhpcy5jaGF0W2luZGV4XS5wcm9kdWN0X3Jldmlld19pbWdfdXJsLAogICAgICAgICAgInByaWNlIjp0aGlzLmNoYXRbaW5kZXhdLm5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMucHJpY2UsCiAgICAgICAgICAicXVhbnRpdHkiOnRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5xdHlfc2hpcHBlZCwKICAgICAgICAgICJ2YXJpYW50X2lkIjp0aGlzLmNoYXRbaW5kZXhdLm5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMuc2t1CiAgICAgICAgfQogICAgICB9CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoCiAgICAgICAgICBhcGlfY2FsbHMucHJvZHVjdF9yZXZpZXdfcmF0aW5nKCksCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbXBhbnlfbmFtZTogdGhpcy5jb21wYW55bmFtZSwKICAgICAgICAgICAgY29tcGFueV9pZDogdGhpcy5jb21wYW55aWQsCiAgICAgICAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgaXNfc2F2ZV9yZXZpZXdfcmF0aW5nOiB0cnVlLAogICAgICAgICAgICByZXZpZXdfcmF0aW5nX2N1c3RvbWVyX2lkOiB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl9pZCIpLAogICAgICAgICAgICByZXZpZXdfcmF0aW5nX2N1c3RvbWVyX2VtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpLAogICAgICAgICAgICBwcm9kdWN0X3JhdGluZzogdGhpcy5jaGF0W2luZGV4XS5wcm9kdWN0X3JhdGluZywKICAgICAgICAgICAgcHJvZHVjdF9yZXZpZXc6IHRoaXMuY2hhdFtpbmRleF0ucHJvZHVjdF9yZXZpZXcsCiAgICAgICAgICAgIHByb2R1Y3RfZGV0YWlsczogcHJvZHVjdF9kZXRhaWxzCiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuJHNlc3Npb24uZ2V0KCJhdCIpfWAKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICkKICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEgIT0gIiIgJiYKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YSAhPSBudWxsICYmCiAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEgIT0gIkludGVybmFsIHNlcnZlciBFcnJvciIKICAgICAgICAgICkgewogICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmlzX3Jldmlld19yYXRpbmdfcHJvZHVjdCA9IGZhbHNlOwogICAgICAgICAgICAvLyB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gdGhpcy5yZXZpZXdfcmVzcG9uc2VfbWVzc2FnZTsKICAgICAgICAgICAgLy8gdGhpcy5jaGF0W2luZGV4XS50aW1lID0gdGhpcy5nZW5lcmF0ZV90aW1lKCk7CiAgICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgICAgcmVjZWl2ZWQ6IHRoaXMucmV2aWV3X3Jlc3BvbnNlX21lc3NhZ2UsCiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICAgIGlmKHJlc3BvbnNlLmRhdGEuTVNHID09PSAnUmV2aWV3IFNhdmVkIFN1Y2Nlc3NmdWxseScpewogICAgICAgICAgICAgIHN3YWwoewogICAgICAgICAgICAgICAgdGV4dDogdGhpcy5yZXZpZXdfcmVzcG9uc2VfbWVzc2FnZSwKICAgICAgICAgICAgICAgIHRvYXN0OiB0cnVlLAogICAgICAgICAgICAgICAgc2hvd0NhbmNlbEJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgICAgICBzaG93Q29uZmlybUJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgICAgICB0eXBlOiAic3VjY2VzcyIsCiAgICAgICAgICAgICAgICBwb3NpdGlvbjogInRvcC1lbmQiLAogICAgICAgICAgICAgICAgdGltZXI6IDUwMDAsCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH1lbHNlIGlmKHJlc3BvbnNlLmRhdGEuTVNHID09PSAiUmV2aWV3IE5vdCBTYXZlZCBTdWNjZXNzZnVsbHkiKXsKICAgICAgICAgICAgICBzd2FsKHsKICAgICAgICAgICAgICAgIHRleHQ6ICJTb21lIEVycm9yIE9jY3VycmVkLiIsCiAgICAgICAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgICAgICAgdHlwZTogImVycm9yIiwKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAidG9wLWVuZCIsCiAgICAgICAgICAgICAgICB0aW1lcjogNTAwMCwKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdG9hc3RyLmVycm9yKCJJbnRlcm5hbCBTZXJ2ZXIgRXJyb3IiKTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaChlID0+IHsKICAgICAgICAgIHRvYXN0ci5lcnJvcigiU29tZSBFcnJvciBPY2N1cnJlZC4iKTsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQxMCB8fAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDQwIHx8CiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MDkKICAgICAgICAgICkgewogICAgICAgICAgICB0aGlzLiRyb290LiRlbWl0KCJTZXNzaW9uX0V4cGlyZWQiLCBlLnJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKICAgIGNsb3NlY2FydChjbG9zZV9jYXJ0KSB7CiAgICAgIHRoaXMuaXNfY2Vuc2VfY2FydCA9IGNsb3NlX2NhcnQ7CiAgICB9LAogICAgY2FydF9jb21tdW5pY2F0aW9uKGNhcnRfZGF0YSl7CiAgICAgIHRoaXMuYWRkdG9DYXJ0ZGF0YSA9IFtdOwogICAgICB0aGlzLnRvdGFsX3Byb2R1Y3RzX3F0eSA9IDA7CiAgICAgIGZvciAodmFyIGkgaW4gY2FydF9kYXRhKXsKICAgICAgICB0aGlzLmFkZHRvQ2FydGRhdGEucHVzaChjYXJ0X2RhdGFbaV0pOwogICAgICB9CiAgICAgIGZvciAodmFyIGogaW4gdGhpcy5hZGR0b0NhcnRkYXRhKXsKICAgICAgICAgdGhpcy50b3RhbF9wcm9kdWN0c19xdHkgPSB0aGlzLnRvdGFsX3Byb2R1Y3RzX3F0eSArIHRoaXMuYWRkdG9DYXJ0ZGF0YVtqXS5vcmRlcl9xdHk7CiAgICAgIH0KICAgIH0sCiAgICB1cGRhdGVfcXVhbnRpdHkoZnVuYywgY2hhdF9pZCwgaW5kZXgsIHByb2R1Y3QpIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgdGhpcy5vdmVyX3F0eV93YXJuaW5nID0gZmFsc2U7CiAgICAgIHZhciBidXkgPSBwYXJzZUludCh0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0uYnV5X3F0eSk7CiAgICAgIHZhciBvcmRlciA9IHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5vcmRlcl9xdHk7CiAgICAgIHZhciBzdG9jayA9IHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5zdG9ja19xdWFudGl0eTsKICAgICAgaWYgKHRoaXMuYWRkdG9DYXJ0ZGF0YS5sZW5ndGggIT09IDAgJiYgc3RvY2sgIT0gbnVsbCApewogICAgICAgIGZvciAodmFyIGkgaW4gdGhpcy5hZGR0b0NhcnRkYXRhKXsKICAgICAgICAgIGlmICh0aGlzLmFkZHRvQ2FydGRhdGFbaV0uaWQgPT0gcHJvZHVjdC5pZCApewogICAgICAgICAgICBsZXQgY2FydF9vcmRlcl9xdHkgPSB0aGlzLmFkZHRvQ2FydGRhdGFbaV0ub3JkZXJfcXR5OwogICAgICAgICAgICBzdG9jayA9IHN0b2NrIC0gY2FydF9vcmRlcl9xdHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciB0b3RhbCA9IGJ1eSArIG9yZGVyOwogICAgICBpZiAoZnVuYyA9PT0gIisiKSB7CiAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLm9yZGVyX3F0eSA9IDE7CiAgICAgICAgaWYoKHRvdGFsIDw9IHN0b2NrKSB8fCBzdG9jayA9PSBudWxsICYmICFpc05hTih0b3RhbCkpewogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkgKz0gMTsKICAgICAgICAgIHZtLiRzZXQoCiAgICAgICAgICAgIHZtLmNoYXQsIGNoYXRfaWQsCiAgICAgICAgICAgIHZtLmNoYXRbY2hhdF9pZF0KICAgICAgICAgICk7CiAgICAgICAgfWVsc2UgewogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLm9yZGVyX3F0eSA9IDI7CiAgICAgICAgICBpZiAoc3RvY2sgPT09IDAgKXsKICAgICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkgPSAxOwogICAgICAgICAgfWVsc2V7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0uYnV5X3F0eSA9IHN0b2NrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZnVuYyA9PT0gIi0iKSB7CiAgICAgICAgaWYgKGJ1eSA+IDEgJiYgIWlzTmFOKHRvdGFsKSl7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0ub3JkZXJfcXR5ID0gMTsKICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5idXlfcXR5IC09IDE7CiAgICAgICAgICB2bS4kc2V0KAogICAgICAgICAgICB2bS5jaGF0LCBjaGF0X2lkLAogICAgICAgICAgICB2bS5jaGF0W2NoYXRfaWRdCiAgICAgICAgICApOwogICAgICAgIH1lbHNlewogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkgPSAxOwogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLm9yZGVyX3F0eSA9IDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmdW5jID09PSAibWFudWFsIikgewogICAgICAgIHZhciBxdWFudGl0eSA9IE1hdGguYWJzKHBhcnNlSW50KHByb2R1Y3QuYnV5X3F0eSkpOwogICAgICAgIGlmICghaXNOYU4ocXVhbnRpdHkpKXsKICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5vcmRlcl9xdHkgPSAxOwogICAgICAgICAgaWYgKHF1YW50aXR5KXsKICAgICAgICAgICAgaWYgKChxdWFudGl0eSA8PSBzdG9jaykgfHwgc3RvY2sgPT0gbnVsbCl7CiAgICAgICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkgPSBxdWFudGl0eTsKICAgICAgICAgICAgfWVsc2UgewogICAgICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5vcmRlcl9xdHkgPSAyOwogICAgICAgICAgICAgIGlmIChzdG9jayA9PT0gMCApewogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkgPSAxOwogICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkgPSBzdG9jazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdm0uJHNldCgKICAgICAgICAgICAgICB2bS5jaGF0LCBjaGF0X2lkLAogICAgICAgICAgICAgIHZtLmNoYXRbY2hhdF9pZF0KICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9ZWxzZSBpZiAoaXNOYU4odG90YWwpKSB7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0uYnV5X3F0eSA9IDE7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0ub3JkZXJfcXR5ID0gMQogICAgICAgICAgdm0uJHNldCgKICAgICAgICAgICAgdm0uY2hhdCwgY2hhdF9pZCwKICAgICAgICAgICAgdm0uY2hhdFtjaGF0X2lkXQogICAgICAgICAgKTsgICAgICAgICAKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBhZGRwcm9kdWN0KHByb2R1Y3QpewogICAgICB0aGlzLnRvdGFsX3Byb2R1Y3RzX3F0eSA9IDA7CiAgICAgIHRoaXMub3Zlcl9xdHlfd2FybmluZyA9IGZhbHNlOwogICAgICB2YXIgYXVkaW8gPSBuZXcgQXVkaW8oc291bmQpOwogICAgICBhdWRpby5wbGF5KCk7CiAgICAgIHZhciBjYXJ0ID0gJCgnI2NlbnNlLWNhcnQtYnRuJyk7CiAgICAgIHZhciBjYXJ0X3F0eSA9ICQoJyNjYXJ0LXF0eS1udW0nKTsKICAgICAgdmFyIGNhcnRfaW1nID0gJCgnI2NhcnQtaW1nJyk7CiAgICAgIGlmICh0aGlzLmFkZHRvQ2FydGRhdGEubGVuZ3RoICE9IDAgJiYgcHJvZHVjdC5idXlfcXR5ICE9PSAnJyl7CiAgICAgICAgdmFyIGNoZWNrID0gZmFsc2U7CiAgICAgICAgZm9yICh2YXIgaSBpbiB0aGlzLmFkZHRvQ2FydGRhdGEpIHsKICAgICAgICAgIGlmICh0aGlzLmFkZHRvQ2FydGRhdGFbaV0uaWQgPT0gcHJvZHVjdC5pZCl7CiAgICAgICAgICAgIGNoZWNrID0gdHJ1ZQogICAgICAgICAgICB2YXIgYnV5ID0gcHJvZHVjdC5idXlfcXR5ICsgdGhpcy5hZGR0b0NhcnRkYXRhW2ldLm9yZGVyX3F0eTsKICAgICAgICAgICAgaWYgKChwcm9kdWN0LnN0b2NrX3F1YW50aXR5ID4gdGhpcy5hZGR0b0NhcnRkYXRhW2ldLm9yZGVyX3F0eSkgJiYgCiAgICAgICAgICAgIChidXkgPD0gcHJvZHVjdC5zdG9ja19xdWFudGl0eSkpewogICAgICAgICAgICAgIHRoaXMuYWRkdG9DYXJ0ZGF0YVtpXS5vcmRlcl9xdHkgPSBidXk7CiAgICAgICAgICAgICAgcHJvZHVjdC5vcmRlcl9xdHkgPSAxOwogICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIGNhcnRfcXR5LmFkZENsYXNzKCdjYXJ0LXF0eScpOwogICAgICAgICAgICAgICAgY2FydF9pbWcuYWRkQ2xhc3MoJ2NhcnQtaW1nJyk7CiAgICAgICAgICAgICAgICBjYXJ0LmFkZENsYXNzKCdzaGFrZScpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICBjYXJ0X3F0eS5yZW1vdmVDbGFzcygnY2FydC1xdHknKTsKICAgICAgICAgICAgICAgICAgY2FydF9pbWcucmVtb3ZlQ2xhc3MoJ2NhcnQtaW1nJyk7CiAgICAgICAgICAgICAgICAgIGNhcnQucmVtb3ZlQ2xhc3MoJ3NoYWtlJyk7CiAgICAgICAgICAgICAgICB9LDUwMCkKICAgICAgICAgICAgICB9LDApCiAgICAgICAgICAgIH1lbHNlIGlmKHByb2R1Y3Quc3RvY2tfcXVhbnRpdHkgPT0gbnVsbCl7CiAgICAgICAgICAgICAgdGhpcy5hZGR0b0NhcnRkYXRhW2ldLm9yZGVyX3F0eSA9IGJ1eTsKICAgICAgICAgICAgICBwcm9kdWN0Lm9yZGVyX3F0eSA9IDE7CiAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgY2FydF9xdHkuYWRkQ2xhc3MoJ2NhcnQtcXR5Jyk7CiAgICAgICAgICAgICAgICBjYXJ0X2ltZy5hZGRDbGFzcygnY2FydC1pbWcnKTsKICAgICAgICAgICAgICAgIGNhcnQuYWRkQ2xhc3MoJ3NoYWtlJyk7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgIGNhcnRfcXR5LnJlbW92ZUNsYXNzKCdjYXJ0LXF0eScpOwogICAgICAgICAgICAgICAgICBjYXJ0X2ltZy5yZW1vdmVDbGFzcygnY2FydC1pbWcnKTsKICAgICAgICAgICAgICAgICAgY2FydC5yZW1vdmVDbGFzcygnc2hha2UnKTsKICAgICAgICAgICAgICAgIH0sNTAwKQogICAgICAgICAgICAgIH0sMCkKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgcHJvZHVjdC5vcmRlcl9xdHkgPSAyOwogICAgICAgICAgICAgIGxldCByZXMgPSBwcm9kdWN0LnN0b2NrX3F1YW50aXR5IC0gdGhpcy5hZGR0b0NhcnRkYXRhW2ldLm9yZGVyX3F0eTsKICAgICAgICAgICAgICBwcm9kdWN0LmJ1eV9xdHkgPSByZXMgPT09IDAgPyAxIDogcmVzOwogICAgICAgICAgICAgIHRoaXMub3Zlcl9xdHlfd2FybmluZyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYoY2hlY2sgIT0gdHJ1ZSAmJiAoKHByb2R1Y3QuYnV5X3F0eSA8PSBwcm9kdWN0LnN0b2NrX3F1YW50aXR5KSB8fCBwcm9kdWN0LnN0b2NrX3F1YW50aXR5ID09IG51bGwpKXsKICAgICAgICAgIHRoaXMuYWRkdG9DYXJ0ZGF0YS5wdXNoKHsKICAgICAgICAgICAgaWQ6IHByb2R1Y3QuaWQsCiAgICAgICAgICAgIGltZ191cmw6IHByb2R1Y3QuaW1nX3VybCwKICAgICAgICAgICAgcHJpY2U6IHByb2R1Y3QucHJpY2UsCiAgICAgICAgICAgIHN0b2NrX3F1YW50aXR5OiBwcm9kdWN0LnN0b2NrX3F1YW50aXR5LAogICAgICAgICAgICBvcmRlcl9xdHk6IHByb2R1Y3QuYnV5X3F0eSwKICAgICAgICAgICAgYnV5X3F0eTogMSwKICAgICAgICAgICAgdmFyaWFudF90aXRsZTogcHJvZHVjdC52YXJpYW50X3RpdGxlLAogICAgICAgICAgICBzdG9ja19zdGF0dXM6IHByb2R1Y3Quc3RvY2tfc3RhdHVzLAogICAgICAgICAgICB0aXRsZTogcHJvZHVjdC50aXRsZQogICAgICAgICAgfSk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBjYXJ0X3F0eS5hZGRDbGFzcygnY2FydC1xdHknKTsKICAgICAgICAgICAgICBjYXJ0X2ltZy5hZGRDbGFzcygnY2FydC1pbWcnKTsKICAgICAgICAgICAgICBjYXJ0LmFkZENsYXNzKCdzaGFrZScpOwogICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIGNhcnRfcXR5LnJlbW92ZUNsYXNzKCdjYXJ0LXF0eScpOwogICAgICAgICAgICAgICAgY2FydF9pbWcucmVtb3ZlQ2xhc3MoJ2NhcnQtaW1nJyk7CiAgICAgICAgICAgICAgICBjYXJ0LnJlbW92ZUNsYXNzKCdzaGFrZScpOwogICAgICAgICAgICAgIH0sNTAwKQogICAgICAgICAgICB9LDApCiAgICAgICAgfWVsc2UgaWYoY2hlY2sgIT0gdHJ1ZSAmJiAocHJvZHVjdC5idXlfcXR5ID4gcHJvZHVjdC5zdG9ja19xdWFudGl0eSkpewogICAgICAgICAgdGhpcy5vdmVyX3F0eV93YXJuaW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH1lbHNlIGlmKChwcm9kdWN0LmJ1eV9xdHkgPD0gcHJvZHVjdC5zdG9ja19xdWFudGl0eSkmJiBwcm9kdWN0LmJ1eV9xdHkgIT09ICcnIHx8IHByb2R1Y3Quc3RvY2tfcXVhbnRpdHkgPT0gbnVsbCl7CiAgICAgIHRoaXMuYWRkdG9DYXJ0ZGF0YS5wdXNoKHsKICAgICAgICAgICAgaWQ6IHByb2R1Y3QuaWQsCiAgICAgICAgICAgIGltZ191cmw6IHByb2R1Y3QuaW1nX3VybCwKICAgICAgICAgICAgcHJpY2U6IHByb2R1Y3QucHJpY2UsCiAgICAgICAgICAgIHN0b2NrX3F1YW50aXR5OiBwcm9kdWN0LnN0b2NrX3F1YW50aXR5LAogICAgICAgICAgICBvcmRlcl9xdHk6IHByb2R1Y3QuYnV5X3F0eSwKICAgICAgICAgICAgYnV5X3F0eTogMSwKICAgICAgICAgICAgdmFyaWFudF90aXRsZTogcHJvZHVjdC52YXJpYW50X3RpdGxlLAogICAgICAgICAgICBzdG9ja19zdGF0dXM6IHByb2R1Y3Quc3RvY2tfc3RhdHVzLAogICAgICAgICAgICB0aXRsZTogcHJvZHVjdC50aXRsZQogICAgICAgICAgfSk7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIGNhcnRfcXR5LmFkZENsYXNzKCdjYXJ0LXF0eScpOwogICAgICAgIGNhcnRfaW1nLmFkZENsYXNzKCdjYXJ0LWltZycpOwogICAgICAgIGNhcnQuYWRkQ2xhc3MoJ3NoYWtlJyk7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgY2FydF9xdHkucmVtb3ZlQ2xhc3MoJ2NhcnQtcXR5Jyk7CiAgICAgICAgICBjYXJ0X2ltZy5yZW1vdmVDbGFzcygnY2FydC1pbWcnKTsKICAgICAgICAgIGNhcnQucmVtb3ZlQ2xhc3MoJ3NoYWtlJyk7CiAgICAgICAgfSw1MDApCiAgICAgIH0sMCkKICAgICAgfWVsc2V7CiAgICAgICAgdGhpcy5vdmVyX3F0eV93YXJuaW5nID0gdHJ1ZTsKICAgICAgfQogICAgICBmb3IgKHZhciBqIGluIHRoaXMuYWRkdG9DYXJ0ZGF0YSl7CiAgICAgICAgIHRoaXMudG90YWxfcHJvZHVjdHNfcXR5ID0gdGhpcy50b3RhbF9wcm9kdWN0c19xdHkgKyB0aGlzLmFkZHRvQ2FydGRhdGFbal0ub3JkZXJfcXR5OwogICAgICB9CiAgICB9LAogICAgc2VsZWN0ZWRfcHJvZHVjdCh2YWx1ZSkgewogICAgICBpZiAoZXZlbnQudGFyZ2V0LmNoZWNrZWQpIHsKICAgICAgICBpZiAodmFsdWUgPT0gImFsbCIpIHsKICAgICAgICAgIHRoaXMuY2hlY2tlZF9saXN0ID0gW107CiAgICAgICAgICBmb3IgKHZhciBpIGluIHRoaXMucHJvZHVjdF9vdXRfb2Zfc3RvY2tfbGlzdCkgewogICAgICAgICAgICB0aGlzLmNoZWNrZWRfbGlzdC5wdXNoKHRoaXMucHJvZHVjdF9vdXRfb2Zfc3RvY2tfbGlzdFtpXSk7CiAgICAgICAgICB9CiAgICAgICAgICAkKCJpbnB1dDpjaGVja2JveCIpLnByb3AoImNoZWNrZWQiLCBmYWxzZSk7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY2hlY2tlZF9saXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICQoCiAgICAgICAgICAgICAgIiNwcm9kdWN0X2NoZWNrYm94XyIgKwogICAgICAgICAgICAgICAgdGhpcy5wcm9kdWN0X291dF9vZl9zdG9ja19saXN0W2ldLnByb2R1Y3RfaWQKICAgICAgICAgICAgKS5wcm9wKCJjaGVja2VkIiwgdHJ1ZSk7CiAgICAgICAgICAgICQoIiNzZWxlY3RhbGwiKS5wcm9wKCJjaGVja2VkIiwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuY2hlY2tlZF9saXN0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICghZXZlbnQudGFyZ2V0LmNoZWNrZWQpIHsKICAgICAgICBpZiAodmFsdWUgIT0gImFsbCIpIHsKICAgICAgICAgIHZhciBzZWxlY3RhbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjc2VsZWN0YWxsIik7CiAgICAgICAgICBpZiAoc2VsZWN0YWxsLmNoZWNrZWQpIHsKICAgICAgICAgICAgc2VsZWN0YWxsLmNoZWNrZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0ZW1wID0gdGhpcy5jaGVja2VkX2xpc3QuZmlsdGVyKChwcm9kdWN0X2lkKSA9PiB7CiAgICAgICAgICAgIHJldHVybiBwcm9kdWN0X2lkICE9IHZhbHVlOwogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLmNoZWNrZWRfbGlzdCA9IHRlbXA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICQoImlucHV0OmNoZWNrYm94IikucHJvcCgiY2hlY2tlZCIsIGZhbHNlKTsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jaGVja2VkX2xpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgJCgKICAgICAgICAgICAgICAiI3Byb2R1Y3RfY2hlY2tib3hfIiArCiAgICAgICAgICAgICAgICB0aGlzLnByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3RbaV0ucHJvZHVjdF9pZAogICAgICAgICAgICApLnByb3AoImNoZWNrZWQiLCBmYWxzZSk7CiAgICAgICAgICAgICQoIiNzZWxlY3RhbGwiKS5wcm9wKCJjaGVja2VkIiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5jaGVja2VkX2xpc3QgPSBbXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBjaGVja19jdXJyZW50X3Byb2R1Y3RfYWN0aXZlKGluZGV4KSB7CiAgICAgIC8vIGNvbnNvbGUudGFibGUoaW5kZXgsIHRoaXMudGVtcGxhdGVsaXN0W2luZGV4XSwgdGhpcy5jdXJyZW50X3RlbXBsYXRlKTsKICAgICAgaWYgKEJvb2xlYW4odGhpcy5wcm9kdWN0X291dF9vZl9zdG9ja19saXN0W2luZGV4XSkgPT09IHRydWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5wcm9kdWN0X291dF9vZl9zdG9ja19saXN0W2luZGV4XS5wcm9kdWN0X2lkID09PQogICAgICAgICAgdGhpcy5jdXJyZW50X3Byb2R1Y3QucHJvZHVjdF9pZAogICAgICAgICAgPyAiY3VycmVudC1hY3RpdmUtdGVtcGxhdGUiCiAgICAgICAgICA6IG51bGw7CiAgICAgIH0KICAgIH0sCiAgICBzaG93X3Byb2R1Y3QoaW5kZXgpIHsKICAgICAgdGhpcy5jdXJyZW50X3Byb2R1Y3QgPSB0aGlzLnByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3RbaW5kZXhdOwogICAgfSwKICAgIGFkZF90b19vdXRfb2Zfc3RvY2tfbGlzdChpdGVtcykgewogICAgICB0aGlzLnByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3QgPSBpdGVtczsKICAgICAgdGhpcy5jaGVja2VkX2xpc3QgPSBbXTsKICAgICAgJCgiaW5wdXQ6Y2hlY2tib3giKS5wcm9wKCJjaGVja2VkIiwgZmFsc2UpOwogICAgfSwKICAgIHN1Ym1pdF9vdXRfb2Zfc3RvY2tfcHJvZHVjdHMoKSB7CiAgICAgIGlmICh0aGlzLmNoZWNrZWRfbGlzdC5sZW5ndGggPT0gMCkgewogICAgICAgIHN3YWwoewogICAgICAgICAgdGV4dDogIlBsZWFzZSBzZWxlY3Qgc29tZSBwcm9kdWN0cyIsCiAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgIHBvc2l0aW9uOiAidG9wLWVuZCIsCiAgICAgICAgICB0eXBlOiAid2FybmluZyIsCiAgICAgICAgICBzaG93Q29uZmlybUJ1dHRvbjogZmFsc2UsCiAgICAgICAgICB0aW1lcjogMjUwMCwKICAgICAgICB9KTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgdGhpcy5jdXN0b21lcl9lbWFpbCA9PSAiIiB8fAogICAgICAgICF0aGlzLnJlZ19lbWFpbC50ZXN0KHRoaXMuY3VzdG9tZXJfZW1haWwpCiAgICAgICkgewogICAgICAgIHN3YWwoewogICAgICAgICAgdGV4dDogIlBsZWFzZSBlbnRlciBhIHZhbGlkIGVtYWlsIGFkZHJlc3MiLAogICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICBwb3NpdGlvbjogInRvcC1lbmQiLAogICAgICAgICAgdHlwZTogIndhcm5pbmciLAogICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgdGltZXI6IDI1MDAsCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHN3YWwoewogICAgICAgIHRleHQ6ICJQbGVhc2Ugd2FpdCB3aGlsZSB3ZSBhcmUgc3VibWl0dGluZyB5b3VyIGRldGFpbHMuLi4iLAogICAgICAgIHR5cGU6ICJpbmZvIiwKICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICBzaG93Q29uZmlybUJ1dHRvbjogZmFsc2UsCiAgICAgIH0pOwogICAgICB0aGlzLnNwaW5uZXJPbiA9IHRydWU7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoCiAgICAgICAgICBhcGlfY2FsbHMub3V0b2ZzdG9ja2VtYWlsbm90aWZpY2F0aW9uKCksCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIGVtYWlsOiB0aGlzLmN1c3RvbWVyX2VtYWlsLAogICAgICAgICAgICBwcm9kdWN0X2xpc3Q6IHRoaXMuY2hlY2tlZF9saXN0LAogICAgICAgICAgICB0b2tlbjp0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgdXNlcm5hbWU6dGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgfSwKICAgICAgICAgIHsKICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLiRzZXNzaW9uLmdldCgiYXQiKX1gLAogICAgICAgICAgICB9LAogICAgICAgICAgfQogICAgICAgICkKICAgICAgICAudGhlbigoeyBkYXRhIH0pID0+IHsKICAgICAgICAgIGlmIChkYXRhLm1lc3NhZ2UgPT0gIlF1ZXJ5IEV4ZWN1dGVkIFN1Y2Nlc3NmdWxseSIpIHsKICAgICAgICAgICAgc3dhbCh7CiAgICAgICAgICAgICAgdHlwZTogInN1Y2Nlc3MiLAogICAgICAgICAgICAgIHRleHQ6CiAgICAgICAgICAgICAgICAiWW91J2xsIGJlIG5vdGlmaWVkIHRocm91Z2ggZW1haWwgd2hlbiB0aGUgcHJvZHVjdHMgZ2V0IGJhY2sgaW4gc3RvY2siLAogICAgICAgICAgICAgIHRpbWVyOiAyNTAwLAogICAgICAgICAgICB9KS50aGVuKChyZXN1bHQpID0+IHsKICAgICAgICAgICAgICB0aGlzLmN1c3RvbWVyX2VtYWlsID0gIiI7CiAgICAgICAgICAgICAgdGhpcy5jaGVja2VkX2xpc3QgPSBbXTsKICAgICAgICAgICAgICAkKCJpbnB1dDpjaGVja2JveCIpLnByb3AoImNoZWNrZWQiLCBmYWxzZSk7CiAgICAgICAgICAgICAgJCgiI25vdGlmeWVtYWlsIikubW9kYWwoImhpZGUiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgIHRoaXMuc3Bpbm5lck9uID0gZmFsc2U7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MTAgfHwKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQ0MCB8fAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA5CiAgICAgICAgICApIHsKICAgICAgICAgICAgdGhpcy4kcm9vdC4kZW1pdCgiU2Vzc2lvbl9FeHBpcmVkIiwgZS5yZXNwb25zZS5kYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCiAgICByZWZyZXNoX2NoYXRib3QodHlwZSkgewogICAgICB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQgPSB0cnVlOwogICAgICBheGlvcwogICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgIGNoYXQ6ICIiLAogICAgICAgICAgZGF0YTogIiIsCiAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICB9KQogICAgICAgIC50aGVuKChyZXNwKSA9PiB7CiAgICAgICAgICB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQgPSBmYWxzZTsKICAgICAgICAgIGxldCB3ZWxjb21lX21zZ19jb21wYW5pZXMgPSBbCiAgICAgICAgICAgICJDdXN0b21lckhhcHBpbmVzczk1MTg1IiwKICAgICAgICAgICAgIjN4NWl2ZTk5NTM0IiwKICAgICAgICAgICAgIkZvcmVpZ254Y2hhbmdlMTc0OTEiLAogICAgICAgICAgICAiMzYwX3RlY2hub2xvZ3kiLAogICAgICAgICAgXTsKICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAvLyBpZiAodGhpcy5zaG9waWZ5X3VpID09IG51bGwgJiYgdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIpIHsKICAgICAgICAgICAgLy8gICB0aGlzLmluaXRpYWxpemVfc2hvcGlmeV91aSgpOwogICAgICAgICAgICAvLyB9CiAgICAgICAgICB9LCAxMDApOwogICAgICAgICAgaWYgKHR5cGUgPT0gInN1cHBvcnQiKSB7CiAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2ZWQ6ICJJcyB0aGVyZSBhbnl0aGluZyBlbHNlIEkgY2FuIGhlbHAgeW91IHdpdGg/IiwKICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod2VsY29tZV9tc2dfY29tcGFuaWVzLmluY2x1ZGVzKHRoaXMuY29tcGFueWlkKSkgewogICAgICAgICAgICBheGlvcwogICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgICAgIGNoYXQ6ICIvd2VsY29tZV9tZXNzYWdlIiwKICAgICAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgICAgIGRhdGE6ICIiLAogICAgICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiBmYWxzZSwKICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5wdXNoX21zZyhyZXNwb25zZSwgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXMpOwogICAgICAgICAgICAgICAgLy8gdGhpcy5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLndlbGNvbWVfbWVzc2FnZV9ub3RfeWV0X3JlY2VpdmVkID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAogICAgZG93bmxvYWRfZmlsZSh1cmwsIGZpbGVfbmFtZSkgewogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB2YXIgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgICAgbGluay5ocmVmID0gdXJsOwogICAgICBsaW5rLnNldEF0dHJpYnV0ZSgiZG93bmxvYWQiLCBmaWxlX25hbWUpOwogICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmspOwogICAgICBsaW5rLmNsaWNrKCk7CiAgICB9LAogICAgc2Nyb2xsX2RpdigpIHsKICAgICAgdmFyIGRvYyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5idXktcHJvZHVjdHMiKTsKICAgICAgaWYgKGV2ZW50LmRlbHRhWCA+IGV2ZW50LmRlbHRhWSkgewogICAgICAgIGRvYy5zY3JvbGxMZWZ0ICs9IDEwOwogICAgICB9IGVsc2UgaWYgKGV2ZW50LmRlbHRhWCA8IGV2ZW50LmRlbHRhWSkgewogICAgICAgIGRvYy5zY3JvbGxMZWZ0IC09IDEwOwogICAgICB9CiAgICB9LAogICAgc2Nyb2xsX2RpdjEoaXRlbSkgewogICAgICB2YXIgZG9jID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgI2J1eV9wcm9kdWN0X2lkXyR7aXRlbX1gKTsKICAgICAgaWYgKGV2ZW50LmRlbHRhWCA+IGV2ZW50LmRlbHRhWSkgewogICAgICAgIGRvYy5zY3JvbGxMZWZ0ICs9IDEwOwogICAgICB9IGVsc2UgaWYgKGV2ZW50LmRlbHRhWCA8IGV2ZW50LmRlbHRhWSkgewogICAgICAgIGRvYy5zY3JvbGxMZWZ0IC09IDEwOwogICAgICB9CiAgICB9LAogICAgc2Nyb2xsX2Rpdl9yaWdodChpdGVtKSB7CiAgICAgIHZhciBkb2MgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjYnV5X3Byb2R1Y3RfaWRfJHtpdGVtfWApOwogICAgICAgIGRvYy5zY3JvbGxMZWZ0ICs9IDEwMDsKICAgIH0sCiAgICBzY3JvbGxfZGl2X2xlZnQoaXRlbSkgewogICAgICB2YXIgZG9jID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgI2J1eV9wcm9kdWN0X2lkXyR7aXRlbX1gKTsKICAgICAgICBkb2Muc2Nyb2xsTGVmdCAtPSAxMDA7CiAgICB9LAogICAgY2FsbF9zdXBwb3J0KHR5cGUpIHsKICAgICAgaWYgKHR5cGUgPT0gIlllcyIpIHsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgIGNoYXQ6ICIvY2FsbF9zdXBwb3J0IiwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKChyZXNwKSA9PiB7CiAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2ZWQ6IHJlc3AuZGF0YS5yZXNwb25zZXNbMF0udGV4dCwKICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09ICJObyIpIHsKICAgICAgICB0aGlzLmNoYXQucHVzaCh0aGlzLmNoYXRbMF0pOwogICAgICAgIHRoaXMuY2hhdC5wdXNoKHRoaXMuY2hhdFsxXSk7CiAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgIC8vIHRoaXMucmVmcmVzaF9jaGF0Ym90KCJzdXBwb3J0Iik7CiAgICAgIH0KICAgIH0sCiAgICBwYXJzZShzdHJpbmcpIHsKICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKC97ey4qP319L2csIChtYXRjaCkgPT4gewogICAgICAgIHZhciB0b2RheSA9IG5ldyBEYXRlKCk7CiAgICAgICAgdmFyIGRkID0gdG9kYXkuZ2V0RGF0ZSgpOwoKICAgICAgICB2YXIgbW0gPSB0b2RheS5nZXRNb250aCgpICsgMTsKICAgICAgICB2YXIgeXl5eSA9IHRvZGF5LmdldEZ1bGxZZWFyKCk7CiAgICAgICAgaWYgKGRkIDwgMTApIHsKICAgICAgICAgIGRkID0gIjAiICsgZGQ7CiAgICAgICAgfQoKICAgICAgICBpZiAobW0gPCAxMCkgewogICAgICAgICAgbW0gPSAiMCIgKyBtbTsKICAgICAgICB9CiAgICAgICAgdG9kYXkgPSBkZCArICItIiArIG1tICsgIi0iICsgeXl5eTsKICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IG1hdGNoLnNsaWNlKDIsIC0yKTsKICAgICAgICB0aGlzLiRkYXRhW2V4cHJlc3Npb25dID0gdG9kYXk7CiAgICAgICAgcmV0dXJuIHRoaXMuJGRhdGFbZXhwcmVzc2lvbl07CiAgICAgIH0pOwogICAgfSwKICAgIHNob3dfcG9wdXAoKSB7CiAgICAgIHRoaXMuc2hvdyA9IGZhbHNlOwogICAgICB0aGlzLnN0b3AgPSBmYWxzZTsKICAgIH0sCiAgICBzdWJfbGVhZl9ub2RlX2NhbGwoZGl2Y2xpY2spIHsKICAgICAgLy8gdmFyIGRpdmNsaWNrID0gZXZlbnQudGFyZ2V0LmlubmVyVGV4dAogICAgICBpZiAoZGl2Y2xpY2sgPT0gIldhdGNoIERlbW8gVmlkZW8iKSB7CiAgICAgICAgdGhpcy5kZW1vdXJsYmluZCA9IHRydWU7CiAgICAgICAgdGhpcy5yZXZpZXdzdXJsYmluZCA9IGZhbHNlOwogICAgICB9IGVsc2UgaWYgKGRpdmNsaWNrID09ICJVc2VyIFJldmlld3MvVGVzdGltb25pYWxzIikgewogICAgICAgIHRoaXMucmV2aWV3c3VybGJpbmQgPSB0cnVlOwogICAgICAgIHRoaXMuZGVtb3VybGJpbmQgPSBmYWxzZTsKICAgICAgfQogICAgICBpZiAoCiAgICAgICAgZGl2Y2xpY2sgPT0gIldhdGNoIERlbW8gVmlkZW8iIHx8CiAgICAgICAgZGl2Y2xpY2sgPT0gIlVzZXIgUmV2aWV3cy9UZXN0aW1vbmlhbHMiCiAgICAgICkgewogICAgICAgIHRoaXMuc2hvdyA9ICF0aGlzLnNob3c7CiAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCk7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICB9LCAxMDAwKTsKICAgICAgfSBlbHNlIGlmIChkaXZjbGljayA9PSAiQnV5IFR1dG9yaWFsIikgewogICAgICAgIHRoaXMuY2Vuc2VfZW5xdWlyeSA9IHRydWU7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICBjaGF0OiAiL3BlcnNvbmFsX2RldGFpbHMiLAogICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogIiIsCiAgICAgICAgICB9KQogICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgICAgcmVjZWl2ZWQ6IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLnRleHQsCiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICAgIH0sIDEwMDApOwogICAgICAgICAgICAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgdGlja2V0X251bWJlcigpIHsKICAgICAgbGV0IHJhbmRvbV9udW0gPSBNYXRoLmZsb29yKDEwMDAwMDAgKyBNYXRoLnJhbmRvbSgpICogOTAwMDAwMCk7CiAgICAgIGxldCBjb21wYW55ID0gdGhpcy5jb21wYW55bmFtZS5zbGljZSgwLCAxKS50b1VwcGVyQ2FzZSgpOwogICAgICByZXR1cm4gYCR7Y29tcGFueX1fJHtyYW5kb21fbnVtfWA7CiAgICB9LAogICAgc2VuZF9tZXNzYWdlKHR5cGUsIG1lc3NhZ2UsIHRvX2JlX2Rpc3BsYXllZCkgewogICAgICAvLyBoYXJzaAogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICBpZiAodGhpcy5zZWxlY3RlZF9pbmRpY2F0aW9uWzBdICE9IHVuZGVmaW5lZCkgewogICAgICAgIGlmICh0eXBlID09ICJpc19idXR0b24iKSB7CiAgICAgICAgICB0aGlzLnRvX3NlbmQgPSBtZXNzYWdlLnZhbHVlICsgSlNPTi5zdHJpbmdpZnkodGhpcy5yZXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0eXBlID0gImlzX3Byb21wdCI7CiAgICAgICAgICB0b19iZV9kaXNwbGF5ZWQgPSB0aGlzLnRvX3NlbmQ7CiAgICAgICAgICB0aGlzLnRvX3NlbmQgPQogICAgICAgICAgICB0aGlzLnNlbGVjdGVkX2luZGljYXRpb25bMF0udmFsdWUuc3BsaXQoInsiKVswXSArCiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHRoaXMucmVzKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHR5cGUgPT0gImlzX2J1dHRvbiIpIHsKICAgICAgICAkKCIjcmVzcG9uc2VfYm90X3RleHQiKS5wcm9wKCJkaXNhYmxlZCIsIGZhbHNlKTsKICAgICAgICBpZiAoCiAgICAgICAgICBtZXNzYWdlLnZhbHVlID09ICJpc2Rpc2FibGVkIiAmJgogICAgICAgICAgdGhpcy5jb21wYW55aWQgPT0gImNsaW5pY2FsdHJpYWxzODEzNTIiICYmCiAgICAgICAgICBtZXNzYWdlLnRpdGxlID09ICJObyIKICAgICAgICApIHsKICAgICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UudmFsdWUgPT09ICIvbGl2ZV9jaGF0IikgewogICAgICAgICAgdGhpcy5zdGFydF9saXZlX2NoYXQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgICAgIGZ1bmN0aW9uIHNlbmRfbXNnKHRvU2VuZCwgY3VzdG9tRGlzcGxheU1zZykgewogICAgICAgICAgICB2bS5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKICAgICAgICAgICAgdm0uY2hhdC5wdXNoKHsKICAgICAgICAgICAgICBzZW50OiBjdXN0b21EaXNwbGF5TXNnCiAgICAgICAgICAgICAgICA/IGAke21lc3NhZ2UudGl0bGV9ICR7Y3VzdG9tRGlzcGxheU1zZ31gCiAgICAgICAgICAgICAgICA6IG1lc3NhZ2UudGl0bGUsCiAgICAgICAgICAgICAgc2VuZGluZzogdHJ1ZSwKICAgICAgICAgICAgICB0aW1lOiB2bS5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgZGVsaXZlcmVkOiB0cnVlLAogICAgICAgICAgICAgIGRyb3Bkb3duOiAiIiwKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZtLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInNlbmRlciIpOwogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgdm0uY2hhdFt0b19iZV9kaXNwbGF5ZWRdICYmCiAgICAgICAgICAgICAgdm0uY2hhdFt0b19iZV9kaXNwbGF5ZWRdLnJlbW92YWJsZSA9PSB0cnVlCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGRvY3VtZW50CiAgICAgICAgICAgICAgICAucXVlcnlTZWxlY3RvcigiI2NoYXQiICsgdG9fYmVfZGlzcGxheWVkKQogICAgICAgICAgICAgICAgLmNsYXNzTGlzdC5hZGQoIi0tZGVsZXRlIik7CiAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB2bS5jaGF0LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgICAgfSwgODUwKTsKICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVzcG9uc2VfYm90X3RleHQiKS5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICB2bS5jaGF0W3RvX2JlX2Rpc3BsYXllZCAtIDFdICYmCiAgICAgICAgICAgICAgdm0uY2hhdFt0b19iZV9kaXNwbGF5ZWQgLSAxXS5pc19tdWx0aXNlbGVjdCAmJgogICAgICAgICAgICAgIChtZXNzYWdlLnRpdGxlID09ICJBcHByb3ZlIiB8fAogICAgICAgICAgICAgICAgbWVzc2FnZS50aXRsZSA9PSAiUmVqZWN0IiB8fAogICAgICAgICAgICAgICAgbWVzc2FnZS50aXRsZSA9PSAiQ29tbWVudCBhbmQgUmV0dXJuIikKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdm0uY2hhdFt0b19iZV9kaXNwbGF5ZWQgLSAxXS5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICAgICAgICBjaGF0OiB0b1NlbmQsCiAgICAgICAgICAgICAgICB0b2tlbjogdm0uYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgICAgdXNlcm5hbWU6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICAgICAgbGljZW5zZV9rZXk6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICByb2xlOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiB2bS5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICB2bS5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZtLnNlbGVjdGVkX2luZGljYXRpb24gPSBbXTsKICAgICAgICAgICAgdm0udG9fc2VuZCA9ICIiOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0aGlzLmNvbXBhbnlpZCA9PSAiMzYwX3RlY2hub2xvZ3kiKSB7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICB0aGlzLmNoYXRbdG9fYmVfZGlzcGxheWVkIC0gMV0gJiYKICAgICAgICAgICAgICB0aGlzLmNoYXRbdG9fYmVfZGlzcGxheWVkIC0gMV0udmFsdWVfbWFwcGluZwogICAgICAgICAgICApIHsKICAgICAgICAgICAgICBsZXQgdmFsdWVNYXBwaW5nRGF0YSA9IEpTT04ucGFyc2UoCiAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh0aGlzLmNoYXRbdG9fYmVfZGlzcGxheWVkIC0gMV0udmFsdWVfbWFwcGluZykKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHRoaXMuYWRkZHJvcGRvd252YWx1ZSh2YWx1ZU1hcHBpbmdEYXRhKS50aGVuKCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMudG9fc2VuZCA9IG1lc3NhZ2UudmFsdWUgKyBKU09OLnN0cmluZ2lmeSh0aGlzLnJlcyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGF0W3RvX2JlX2Rpc3BsYXllZCAtIDFdLnZhbHVlX21hcHBpbmcpIHsKICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlTWFwcGluZ0RhdGEubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgc2VuZF9tc2cobWVzc2FnZS52YWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2VuZF9tc2coCiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRvX3NlbmQsCiAgICAgICAgICAgICAgICAgICAgICBgZm9yICR7dGhpcy5zZWxlY3RlZF9pbmRpY2F0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoKG9iaikgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmoudGl0bGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIC50b1N0cmluZygpfWAKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZS52YWx1ZS5zcGxpdCgieyIpLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBsZXQgY3VzdG9tRGlzcGxheU1zZyA9IE9iamVjdC52YWx1ZXMoCiAgICAgICAgICAgICAgICBKU09OLnBhcnNlKGB7JHttZXNzYWdlLnZhbHVlLnNwbGl0KCJ7IilbMV19YCkKICAgICAgICAgICAgICApWzBdOwogICAgICAgICAgICAgIHNlbmRfbXNnKG1lc3NhZ2UudmFsdWUsIGBmb3IgJHtjdXN0b21EaXNwbGF5TXNnfWApOwogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgIHRoaXMuY2hhdFt0b19iZV9kaXNwbGF5ZWQgLSAxXSAmJgogICAgICAgICAgICAgIHRoaXMuY2hhdFt0b19iZV9kaXNwbGF5ZWQgLSAxXS5zaG93X3RleHRfYXJlYQogICAgICAgICAgICApIHsKICAgICAgICAgICAgICBzZW5kX21zZyhtZXNzYWdlLnZhbHVlKTsKICAgICAgICAgICAgICB0aGlzLmNoYXRbdG9fYmVfZGlzcGxheWVkIC0gMV0uZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNlbmRfbXNnKG1lc3NhZ2UudmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZW5kX21zZyhtZXNzYWdlLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PSAiaXNfcHJvbXB0IikgewogICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgc2VudDogdG9fYmVfZGlzcGxheWVkLAogICAgICAgICAgc2VuZGluZzogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICBkZWxpdmVyZWQ6IHRydWUsCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJzZW5kZXIiKTsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICAvLyBob3N0OiB0aGlzLnVzZXJfZGF0YS5ob3N0LAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICBjaGF0OiB0aGlzLnRvX3NlbmQsCiAgICAgICAgICB9KQogICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgIHRoaXMucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpOwogICAgICAgICAgICB0aGlzLmV4MSgpOwogICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy50b19zZW5kID09ICJSZXN0YXJ0IiB8fCB0aGlzLnRvX3NlbmQgPT0gInJlc3RhcnQiKSB7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5wcm9tcHRfdXJsKCksIHsKICAgICAgICAgICAgdWlkOiAiY2Vuc2UiLCAvLyB0aGlzLmZpbmdlcnByaW50CiAgICAgICAgICAgIGNvbXBhbnlpZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfaWQsCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIGNoYXQ6ICIiLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICB0aGlzLmNoYXQucHVzaChyZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgICAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgICAgICAgdGhpcy5sZXZlbCA9IHJlc3BvbnNlLmRhdGEubGV2ZWw7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKChlKSA9PiB7fSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5jZW5zZV9lbnF1aXJ5ID09IHRydWUgJiYgQm9vbGVhbih0aGlzLnRvX3NlbmQpKSB7CiAgICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKICAgICAgICB2YXIgc2VuZF9tc2cgPSB7CiAgICAgICAgICBzZW50OiB0aGlzLnRvX3NlbmQsCiAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIHNlbmRpbmc6IHRydWUsCiAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICB9OwogICAgICAgIHRoaXMuY2hhdC5wdXNoKHNlbmRfbXNnKTsKICAgICAgICAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIik7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICBjaGF0OiAiL3BlcnNvbmFsX2RldGFpbHMiLAogICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICBDb21wYW55aWQ6ICJDTzAwMDIzIiwKICAgICAgICAgICAgZGF0YTogIiIsCiAgICAgICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiAiIiwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgIH0pCiAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgICByZWNlaXZlZDogcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbMF0udGV4dCwKICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICAgIC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICAgICAgICB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHRoaXMubGl2ZV9jaGF0X29uKSB7CiAgICAgICAgLy8gTElWRSBDSEFUIE9OIENVU1RPTUVSIE1FU1NBR0VTCiAgICAgICAgaWYgKEJvb2xlYW4odGhpcy51c2VyX25hbWUpID09PSBmYWxzZSkgewogICAgICAgICAgdGhpcy5jaGFubmVsLnB1c2goIm5ld19uYW1lIiwgeyBuYW1lOiB0aGlzLnRvX3NlbmQgfSk7CiAgICAgICAgICB0aGlzLnVzZXJfbmFtZSA9IHRoaXMudG9fc2VuZDsKICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5jaGFubmVsLnB1c2goIm5ld19uYW1lIiwgeyBuYW1lOiB0aGlzLnVzZXJfbmFtZSB9KTsKICAgICAgICAgIHRoaXMuY2hhbm5lbC5wdXNoKCJuZXdfY2hhdF9tZXNzYWdlIiwgeyBtZXNzYWdlOiB0aGlzLnRvX3NlbmQgfSk7CiAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgfQogICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgIHNlbnQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgIHNlbmRpbmc6IHRydWUsCiAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgIH0pOwogICAgICAgIC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAic2VuZGVyIik7CiAgICAgIH0gZWxzZSBpZiAoQm9vbGVhbih0aGlzLnRvX3NlbmQpICYmIHRoaXMuY2Vuc2VfZW5xdWlyeSAhPSB0cnVlKSB7CiAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICBzZW5kaW5nOiB0cnVlLAogICAgICAgICAgc2VudDogdGhpcy50b19zZW5kLAogICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgfSk7CiAgICAgICAgLy8gdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJzZW5kZXIiKTsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgIGNoYXQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdGhpcy50b19zZW5kID0gIiI7CiAgICB9LAogICAgaW5pdGlhdGVfc3VwcG9ydF9jaGF0KCkgewogICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgIHJlY2VpdmVkOiAiU29ycnkgSSBhbSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uIiwKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgfSk7CiAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgcmVjZWl2ZWQ6ICJXb3VsZCB5b3UgbGlrZSB0byB0YWxrIHdpdGggc3VwcG9ydCB0ZWFtPyIsCiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgc2hvd19idXR0b25zOiB0cnVlLAogICAgICAgIHN1cHBvcnRfYnV0dG9uczogdHJ1ZSwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgfSk7CiAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgIH0sCiAgICBkaXNjb25uZWN0X3N1cHBvcnRfY2hhdCgpIHsKICAgICAgdGhpcy5jaGFubmVsLnB1c2goInN0b3BwZWRfY2hhdCIsIHsKICAgICAgICBuYW1lOiB0aGlzLnVzZXJfbmFtZSwKICAgICAgICBtZXNzYWdlOiAiIGhhcyBlbmRlZCB0aGUgY29udmVyc2F0aW9uLiIsCiAgICAgIH0pOwogICAgICB0aGlzLmNoYW5uZWwubGVhdmUoKTsKICAgICAgdGhpcy5saXZlX2NoYXRfdG9rZW4gPSBudWxsOwogICAgICB0aGlzLmNoYXRfZ3JvdXBfbmFtZSA9IG51bGw7CiAgICAgIHRoaXMudXNlcl9uYW1lID0gIiI7CiAgICAgIHRoaXMuY2hhdF9zb2NrZXQuZGlzY29ubmVjdCgpOwogICAgICB0aGlzLmxpdmVfY2hhdF9vbiA9IGZhbHNlOwogICAgfSwKICAgIGdlbmVyYXRlX3BheW1lbnQocHJpY2UsIG5hbWUpIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAga2V5OiAicnpwX3Rlc3RfU25EVGFQbm5jZmxpRHQiLAogICAgICAgIGFtb3VudDogcHJpY2UgKiAxMDAsCiAgICAgICAgY29tcGFueV9pZDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfaWQsCiAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lLAogICAgICAgIG5hbWU6ICJDZW5zZSBBSSIsCiAgICAgICAgY3VycmVuY3k6ICJJTlIiLAogICAgICAgIGRlc2NyaXB0aW9uOiAiSW5zdGlsbCBJbnRlbGxpZ2VuY2UiLAogICAgICAgIGltYWdlOiAiL2ltZy9jZW5zZV9pbWFnZS5wbmciLCAvLyBDT01QQU5ZIExPR08KICAgICAgICBoYW5kbGVyOiBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgIHZhciBjb250YWN0ID0gJCgnI2NvbnRhY3RbdHlwZT0idGVsIl0nKS52YWx1ZTsKICAgICAgICAgIHZhciBlbWFpbCA9ICQoJyNlbWFpbFt0eXBlPSJlbWFpbCJdJykudmFsdWU7CiAgICAgICAgICB2bS5wYXltZW50aWQgPSByZXNwb25zZS5yYXpvcnBheV9wYXltZW50X2lkOwoKICAgICAgICAgIGlmICh0cmFuc2Zlcl9hY2NvdW50ICE9IG51bGwpIHsKICAgICAgICAgICAgdm0udHJhbnNmZXJfcGF5bWVudCh0cmFuc2Zlcl9hY2NvdW50LCBwcmljZSAqIDEwMCwgIklOUiIsIG5hbWUpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcHJlZmlsbDogewogICAgICAgICAgbmFtZTogIiIsIC8vIHBhc3MgY3VzdG9tZXIgbmFtZQogICAgICAgICAgZW1haWw6ICIiLCAvLyBjdXN0b21lciBlbWFpbAogICAgICAgICAgY29udGFjdDogIiIsIC8vIGN1c3RvbWVyIHBob25lIG5vLgogICAgICAgIH0sCiAgICAgICAgbm90ZXM6IHsKICAgICAgICAgIGFkZHJlc3M6ICJhZGRyZXNzIiwgLy8gY3VzdG9tZXIgYWRkcmVzcwogICAgICAgIH0sCiAgICAgICAgdGhlbWU6IHsKICAgICAgICAgIGNvbG9yOiAiIzI4Mzc3NyIsIC8vIHNjcmVlbiBjb2xvcgogICAgICAgIH0sCiAgICAgIH07CiAgICAgIHZhciByenAxID0gbmV3IFJhem9ycGF5KG9wdGlvbnMpOwogICAgICByenAxLm9wZW4oKTsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgIH0sCiAgICBjaGF0X3Jlc3BvbnNlX2Vycm9yKCkgewogICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgIHJlY2VpdmVkOiAiU29ycnkgSSdtIG5vdCBnZXR0aW5nIHlvdXIgcXVlc3Rpb24iLAogICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICB9KTsKICAgICAgLy8gdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgIH0sCiAgICBzZW5kX3JlcXVlc3RfanNvbihtZXNzYWdlKSB7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICAgIGNoYXQ6ICIiLAogICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgIGRhdGE6IHRoaXMuanNvbl9kYXRhW21lc3NhZ2UucmVzcG9uc2VzWzBdLmludGVudF0sCiAgICAgICAgfSkKICAgICAgICAudGhlbigocmVzcCkgPT4gewogICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICByZWNlaXZlZDoKICAgICAgICAgICAgICByZXNwLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA9PSAwCiAgICAgICAgICAgICAgICA/ICJTb3JyeSBJJ20gbm90IGdldHRpbmcgeW91ciBxdWVzdGlvbiIKICAgICAgICAgICAgICAgIDogcmVzcC5kYXRhLnJlc3BvbnNlc1swXS50ZXh0LAogICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgaW1hZ2U6CiAgICAgICAgICAgICAgcmVzcC5kYXRhLnJlc3BvbnNlc1swXS5pbWcgPT0gIiIKICAgICAgICAgICAgICAgID8gbnVsbAogICAgICAgICAgICAgICAgOiByZXNwLmRhdGEucmVzcG9uc2VzWzBdLmltZywKICAgICAgICAgIH0pOwogICAgICAgICAgLy8gdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgfSk7CiAgICB9LAogICAgcmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UsIHR5cGUpIHsKICAgICAgdmFyIGkgPSAwOwogICAgICB2YXIgZGVsYXkgPSA1MDsKICAgICAgLy8gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCAhPSB1bmRlZmluZWQgPyA1MDAKICAgICAgLy8gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dC5sZW5ndGggPiAxMAogICAgICAvLyAgID8gNTAwCiAgICAgIC8vICAgOiA1MDA7CiAgICAgIHZhciB2bSA9IHRoaXM7CiAgICAgIHZtLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBoYW5kbGVfcmVzcG9uc2UoKTsKICAgICAgfSwgZGVsYXkpOwogICAgICBmdW5jdGlvbiBoYW5kbGVfcmVzcG9uc2UoKSB7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICB2bS5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YSA9PSBudWxsIHx8IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZtLmNoYXRfcmVzcG9uc2VfZXJyb3IoKTsKICAgICAgICAgIH0gZWxzZSBpZiAoQm9vbGVhbihyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5yZXF1ZXN0X2pzb24pID09IHRydWUpIHsKICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQgIT0gbnVsbCkgewogICAgICAgICAgICAgIHZtLmNoYXQucHVzaCh7CiAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgIHJlY2VpdmVkOiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0LAogICAgICAgICAgICAgICAgdGltZTogdm0uZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICAgICAgaW1hZ2U6IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmltZywKICAgICAgICAgICAgICAgIHZpZGVvOiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS52aWRlbywKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAvLyB2bS4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHZtLmNoYXQpOwogICAgICAgICAgICAgIHZtLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmludGVudCA9PSAiZ29neWI0NTBfY3JlYXRlX3RpY2tldCIpIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGAke3ZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZmlyc3RfbmFtZX0gJHsKICAgICAgICAgICAgICAgIHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGFzdF9uYW1lCiAgICAgICAgICAgICAgfWA7CiAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSB7CiAgICAgICAgICAgICAgICB1c2VybmFtZTogbmFtZSwKICAgICAgICAgICAgICAgIGNvbXBhbnluYW1lOiB2bS5jb21wYW55bmFtZSwKICAgICAgICAgICAgICAgIGNvbXBhbnlpZDogdm0uY29tcGFueWlkLAogICAgICAgICAgICAgICAgdXNlcl9yb2xlOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICBlbWFpbDogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgdG9rZW46IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikudG9rZW5zLAogICAgICAgICAgICAgICAgdGlja2V0X2lzc3VlOiAiIiwKICAgICAgICAgICAgICAgIHRpY2tldF9udW1iZXI6IHZtLnRpY2tldF9udW1iZXIoKSwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiIiwKICAgICAgICAgICAgICAgIGZpbGVfY29udGVudDogbnVsbCwKICAgICAgICAgICAgICAgIGZpbGVfbmFtZTogbnVsbCwKICAgICAgICAgICAgICAgIGlzRWRpdDogZmFsc2UsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBwYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkocGF5bG9hZCk7CiAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgICAgICAgbGljZW5zZV9rZXk6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICAgIHRva2VuOiB2bS5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgICB0b2tlbjogdm0uYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgICAgICByb2xlOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHZtLnJlZnJlc2hlZF9vcl9jbG9zZWQsCiAgICAgICAgICAgICAgICAgIGNoYXQ6ICIiLAogICAgICAgICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICAgICAgICBkYXRhOiBwYXlsb2FkLAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC50aGVuKChyZXNwKSA9PiB7CiAgICAgICAgICAgICAgICAgIHZtLmNoYXQucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHJlY2VpdmVkOgogICAgICAgICAgICAgICAgICAgICAgcmVzcC5kYXRhLnJlc3BvbnNlcy5sZW5ndGggPT0gMAogICAgICAgICAgICAgICAgICAgICAgICA/ICJTb3JyeSBJJ20gbm90IGdldHRpbmcgeW91ciBxdWVzdGlvbiIKICAgICAgICAgICAgICAgICAgICAgICAgOiByZXNwLmRhdGEucmVzcG9uc2VzW2ldLnRleHQsCiAgICAgICAgICAgICAgICAgICAgdGltZTogdm0uZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICAgICAgICAgIGltYWdlOiByZXNwLmRhdGEucmVzcG9uc2VzW2ldLmltZywKICAgICAgICAgICAgICAgICAgICB2aWRlbzogcmVzcC5kYXRhLnJlc3BvbnNlc1tpXS52aWRlbyB8fCBudWxsLAogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgLy8gdm0uJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB2bS5jaGF0KTsKICAgICAgICAgICAgICAgICAgdm0ubmV3X3VwZGF0ZV9yZXNwb25zZShpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmludGVudCA9PSAiY3JlYXRlX2FwcG9pbnRtZW50IgogICAgICAgICAgICApIHsKICAgICAgICAgICAgICBsZXQgdG9kYXlfZGF0ZSA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5zY2hlZHVsZV9hcHBvaW50bWVudF91cmwoKSwgewogICAgICAgICAgICAgICAgICBjb21wYW55bmFtZTogdm0uY29tcGFueW5hbWUsCiAgICAgICAgICAgICAgICAgIGNvbXBhbnlpZDogdm0uY29tcGFueWlkLAogICAgICAgICAgICAgICAgICBEYXRlOgogICAgICAgICAgICAgICAgICAgIHRvZGF5X2RhdGUuZ2V0RnVsbFllYXIoKSArCiAgICAgICAgICAgICAgICAgICAgIi0iICsKICAgICAgICAgICAgICAgICAgICAodG9kYXlfZGF0ZS5nZXRNb250aCgpIDwgOQogICAgICAgICAgICAgICAgICAgICAgPyAiMCIgKyAodG9kYXlfZGF0ZS5nZXRNb250aCgpICsgMSkKICAgICAgICAgICAgICAgICAgICAgIDogdG9kYXlfZGF0ZS5nZXRNb250aCgpICsgMSkgKwogICAgICAgICAgICAgICAgICAgICItIiArCiAgICAgICAgICAgICAgICAgICAgdG9kYXlfZGF0ZS5nZXREYXRlKCksIC8vIE1vbnRoIG9iamVjdCBkb2N1bWVudCBpdAogICAgICAgICAgICAgICAgICAvLyBEYXRlOiBzdGFydF90aW1lLAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhyZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgICAgICAgLy8gdGhpcy50aW1lX3Nsb3RzID0gdGhpcy5mdWxsX3RpbWVfc2xvdHM7CiAgICAgICAgICAgICAgICAgIC8vIGlmIChyZXNwb25zZS5kYXRhLlNsb3QgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgIC8vICAgaWYgKHJlc3BvbnNlLmRhdGEuU2xvdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgIC8vICAgICBsZXQgaW5kZXg7CiAgICAgICAgICAgICAgICAgIC8vICAgICBmb3IgKHZhciBpIGluIHJlc3BvbnNlLmRhdGEuU2xvdCkgewogICAgICAgICAgICAgICAgICAvLyAgICAgICBpbmRleCA9IHRoaXMudGltZV9zbG90cy5pbmRleE9mKHJlc3BvbnNlLmRhdGEuU2xvdFtpXSk7CiAgICAgICAgICAgICAgICAgIC8vICAgICAgIGlmIChpbmRleCAhPSAtMSkgewogICAgICAgICAgICAgICAgICAvLyAgICAgICAgIHRoaXMudGltZV9zbG90cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICAgICAgICAvLyAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vICAgICB9CiAgICAgICAgICAgICAgICAgIC8vICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8gICB9CiAgICAgICAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2bS5zZW5kX3JlcXVlc3RfanNvbihyZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSAKICAgICAgICAgIGVsc2UgaWYgKAogICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQgPT0gInJlX29yZGVyX3Byb2R1Y3RzX2FjdGlvbiIKICAgICAgICAgICkgewogICAgICAgICAgICAvLyB2bS5zZW5kX3Nob3BpZnlfY3VzdG9tZXJfaWQoKTsKICAgICAgICAgICAgbGV0IG1zZyA9IHsKICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICB0aW1lOgogICAgICAgICAgICAgICAgaSA9PSByZXNwb25zZS5kYXRhLnJlc3BvbnNlcy5sZW5ndGggLSAxCiAgICAgICAgICAgICAgICAgID8gdm0uZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgICAgICAgICAgIDogbnVsbCwKICAgICAgICAgICAgYXNrX2ZlZWRiYWNrOiBCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmFza19mZWVkYmFjayksCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG1zZy5yZWNlaXZpbmcgPSB0cnVlOwogICAgICAgICAgICBtc2cuZmV0Y2hfc2hvcGlmeV9kZXRhaWxzID0gdHJ1ZTsKICAgICAgICAgICAgbXNnLmlzX3JlZnVuZCA9IGZhbHNlOwogICAgICAgICAgICBtc2cucmV0dXJuX3Nob3BpZnlfZW1haWwgPSB0cnVlOwogICAgICAgICAgICBtc2cucmVjZWl2ZWQgPSAgIlBsZWFzZSBsb2dpbiB3aXRoIHlvdXIgY3JlZGVudGlhbHMgZm9yIGJldHRlciBleHBlcmllbmNlIDopIjsKICAgICAgICAgICAgbXNnLm1ldGFkYXRhID0gewogICAgICAgICAgICAgICBlbnRpdHk6IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmVudGl0eSwKICAgICAgICAgICAgICB0ZXh0OiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0IAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgdm0uY2hhdC5wdXNoKG1zZykKICAgICAgICAgICAgLy8gdm0uc2VuZF9zaG9waWZ5X2N1c3RvbWVyX2lkKG51bGwsZmFsc2UscmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0pOwogICAgICAgICAgfSAKICAgICAgICAgICBlbHNlIGlmICgKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW50ZW50ID09ICJzdXBwb3J0X3N1YnNjcmlwdGlvbl9kYXRhIgogICAgICAgICAgKSB7CiAgICAgICAgICAgIC8vIHZtLnNlbmRfc2hvcGlmeV9jdXN0b21lcl9pZCgpOwogICAgICAgICAgICB2bS5zdXBwb3J0X3N1YnNjcmlwdGlvbl9kYXRhKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmludGVudCA9PSAicHJvZHVjdF9ieV9kYXRlIikgewogICAgICAgICAgICAgIHZtLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICAgICAgICAgIGxldCBjdXRvZmYgPSBuZXcgRGF0ZTsKICAgICAgICAgICAgICB2YXIgY3VycmVudF9kYXRlX3RpbWUgPSBtb21lbnQoY3V0b2ZmKS5mb3JtYXQoIllZWVktTU0tREQgSEg6bW06c3MiKQogICAgICAgICAgICAgIAogICAgICAgICAgICAgIGxldCBmb3JtX3BheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgICAgICB1c3JfbXNnOiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS51c3JfbXNnLAogICAgICAgICAgICAgICAgY3VycmVudF91c2VyX2RhdGU6IGN1cnJlbnRfZGF0ZV90aW1lCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgICAgICAgbGljZW5zZV9rZXk6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICAgIHRva2VuOiB2bS5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgICB0b2tlbjogdm0uYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgICAgICByb2xlOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHZtLnJlZnJlc2hlZF9vcl9jbG9zZWQsCiAgICAgICAgICAgICAgICAgIGNoYXQ6IGAvcHJvZHVjdF9ieV9kYXRlJHtmb3JtX3BheWxvYWR9YCwKICAgICAgICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICAgICAgdm0ucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICBCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnJldHVybl9pbnRlbnQpID09IHRydWUKICAgICAgICAgICkgewogICAgICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICAgICAgICBheGlvcwogICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgdG9rZW46IHZtLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgdG9rZW46IHZtLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICAgIHJvbGU6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHZtLnJlZnJlc2hlZF9vcl9jbG9zZWQsCiAgICAgICAgICAgICAgICBjaGF0OiAiLyIgKyByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQsCiAgICAgICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICB2bS5oYW5kbGVfcmVzcG9uc2UocmVzcG9uc2UpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgdm0uY29tcGFueWlkID09ICIzeDVpdmU5OTUzNCIgJiYKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW50ZW50ICE9IHVuZGVmaW5lZCAmJgogICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQgPT0gImNvbmZ1c2lvbiIKICAgICAgICAgICkgewogICAgICAgICAgICB2bS5jb25mdXNpb25fbWVzc2FnZSgiL25lZWRfaGVscCIpOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5idXR0b25zICE9IHVuZGVmaW5lZCAmJgogICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5idXR0b25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdm0ubG9hZF9idXR0b25zKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLCBpLCB0eXBlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoQm9vbGVhbihyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20pICYmIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmN1c3RvbS50eXBlKSB7CiAgICAgICAgICAgIC8vIENIYW5nZSAgdGhlIGNvbmRpdGlvbiBoZXJlCiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20udHlwZSAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20udHlwZSA9PSAibXVsdGlzZWxlY3RfZHJvcGRvd24iCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHZtLm11bHRpc2VsZWN0X2xvYWQocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0sIGkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmN1c3RvbS50eXBlICE9IHVuZGVmaW5lZCAmJgogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmN1c3RvbS50eXBlID09ICJ0YWJsZSIKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdm0ubG9hZF90YWJsZShyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXSwgaSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY3VzdG9tLnR5cGUgIT0gdW5kZWZpbmVkICYmCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY3VzdG9tLnR5cGUgPT0gInJldGFpbCIKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdm0uZGlzcGxheV9wcm9kdWN0c19jaGF0KHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLCBpLCB0eXBlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20uc2hvd190ZXh0X2FyZWEpIHsKICAgICAgICAgICAgICB2bS5sb2FkX3RleHRfYXJlYShyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXSwgaSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY3VzdG9tLmJ1dHRvbnMgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgdm0ubG9hZF9idXR0b25zKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmN1c3RvbSwgaSwgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgIEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ubWVzc2FnaW5nX3BsYXRmb3JtcykgJiYKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ubWVzc2FnaW5nX3BsYXRmb3Jtcy5sZW5ndGggPiAwCiAgICAgICAgICApIHsKICAgICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgICAvLyBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICB0aW1lOgogICAgICAgICAgICAgICAgaSA9PSByZXNwb25zZS5kYXRhLnJlc3BvbnNlcy5sZW5ndGggLSAxCiAgICAgICAgICAgICAgICAgID8gdm0uZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgICAgICAgICAgIDogbnVsbCwKICAgICAgICAgICAgICBhc2tfZmVlZGJhY2s6IEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uYXNrX2ZlZWRiYWNrKSwKICAgICAgICAgICAgICBzaG93X21lc3NhZ2luZ19wbGF0Zm9ybXM6IHRydWUsCiAgICAgICAgICAgICAgLy8gcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgIC8vIHJlY2VpdmVkOiJQbGVhc2UgZmVlbCBmcmVlIHRvIHJlYWNob3V0IHRvIHVzIGF0IDogIiArIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmNvbnRhY3RfdXNfZW1haWwgICsgdm0uY29udGFjdF91c19waG9uZV9udW1iZXIocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY29udGFjdF91c19waG9uZV9udW1iZXIpICsiIG9yIGRyb3AgdXMgYSBtZXNzYWdlIiwKICAgICAgICAgICAgICBtZXNzYWdpbmdfcGxhdGZvcm1zX2RhdGE6CiAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5tZXNzYWdpbmdfcGxhdGZvcm1zLAogICAgICAgICAgICB9OwogICAgICAgICAgICB2bS5jaGF0LnB1c2gobXNnKTsKICAgICAgICAgIH0gZWxzZSBpZiAoQm9vbGVhbihyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pc19wcmV2aWV3X2Jhbm5lcikpIHsKICAgICAgICAgICAgdm0uZGlzcGxheV9iYW5uZXIocmVzcG9uc2UuZGF0YS5yZXNwb25zZXMsIGkpOwogICAgICAgICAgfSBlbHNlIGlmIChCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmlzX2Rpc3BsYXlfYmFubmVyKSkgewogICAgICAgICAgICB2bS5kaXNwbGF5X2Jhbm5lcihyZXNwb25zZS5kYXRhLnJlc3BvbnNlcywgaSk7CiAgICAgICAgICB9ZWxzZSB7CiAgICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgdGltZToKICAgICAgICAgICAgICAgIGkgPT0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXMubGVuZ3RoIC0gMQogICAgICAgICAgICAgICAgICA/IHZtLmdlbmVyYXRlX3RpbWUoKQogICAgICAgICAgICAgICAgICA6IG51bGwsCiAgICAgICAgICAgICAgYXNrX2ZlZWRiYWNrOiBCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmFza19mZWVkYmFjayksCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlcy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICAgIG1zZy5yZWNlaXZlZCA9ICJTb3JyeSB3ZSBhcmUgbm90IGdldHRpbmcgeW91ciBxdWVzdGlvbi4iOwogICAgICAgICAgICAgIG1zZy5yZWNlaXZpbmcgPSB0cnVlOwogICAgICAgICAgICB9ZWxzZSBpZihyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZW1wbGF0ZSA9PT0gInV0dGVyX2RlZmF1bHQiKXsKICAgICAgICAgICAgICAgIG1zZy5yZWNlaXZpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgbXNnLnJlY2VpdmVkID0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ubWVzc2FnZS5zcGxpdCgne2VtYWlsfScpLmpvaW4odm0uY29udGFjdF9oZWxwX2VtYWlsKTsKICAgICAgICAgICAgICAgIHZtLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgICB9ZWxzZSBpZiAoCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICB2bS51cmxfbWF0Y2hfcmVnZXgudGVzdChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0KQogICAgICAgICAgICApIHsKICAgICAgICAgICAgICB2bS5kaXNwbGF5X2ZpbGVfY2hhdChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5nZXRfY29tcGFueV9kZXRhaWxzID09PSAiVHJ1ZSIgJiYgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW50ZW50ID09PSAiY2Vuc2Vfc3VwcG9ydF90aWNrZXQiKXsKCiAgICAgICAgICAgICAgIGxldCBjX2lkID0gdm0ucmV0dXJuX2RvY3VtZW50X2Nvb2tpZXMoJ2NvbXBhbnlfaWQnKTsKICAgICAgICAgICAgICAgbGV0IGNfbmFtZSA9IHZtLnJldHVybl9kb2N1bWVudF9jb29raWVzKCdjb21wYW55X25hbWUnKTsKICAgICAgICAgICAgICAgbGV0IGNfZW1haWwgPSB2bS5yZXR1cm5fZG9jdW1lbnRfY29va2llcygnY29tcGFueV9lbWFpbCcpOwogICAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICAgICAgICBsaWNlbnNlX2tleTogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgICAgIHRva2VuOiB2bS5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICB1c2VybmFtZTogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgIHRva2VuOiB2bS5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICByb2xlOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiB2bS5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgICAgICAgY2hhdDpKU09OLnN0cmluZ2lmeSh7Y29tcGFueV9pZCA6IGNfaWQsCiAgICAgICAgICAgICAgICAgICAgICBjb21wYW55X25hbWUgOiBjX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICBlbWFpbCA6IGNfZW1haWwsCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICAgIHZtLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSAgCiAgICAgICAgICAgIGVsc2UgaWYgKAogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQgIT0gdW5kZWZpbmVkICYmCiAgICAgICAgICAgICAgIXJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQuaW5jbHVkZXMoCiAgICAgICAgICAgICAgICAiRG93bmxvYWQgeW91ciBtYW5pZmVzdCBoZXJlIgogICAgICAgICAgICAgICkKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgbXNnLnJlY2VpdmVkID0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dDsKICAgICAgICAgICAgICBtc2cucmVjZWl2aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICBtc2cuaW1hZ2UgPSByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbWc7CiAgICAgICAgICAgICAgbXNnLmltYWdlID0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW1hZ2U7CiAgICAgICAgICAgICAgbXNnLnZpZGVvcyA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnZpZGVvIHx8IGZhbHNlOwogICAgICAgICAgICAgIG1zZy5vcmRlcl9zdGF0dXMgPSByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5vcmRlcl9zdGF0dXM7CiAgICAgICAgICAgICAgbXNnLmlzX29yZGVyX3N0YXR1cyA9CiAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pc19vcmRlcl9zdGF0dXMgfHwgZmFsc2U7CiAgICAgICAgICAgICAgbXNnLm9mZmVycyA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLm9mZmVycyB8fCBmYWxzZTsKICAgICAgICAgICAgICBtc2cuZmV0Y2hfc2hvcGlmeV9kZXRhaWxzID0KICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmZldGNoX3Nob3BpZnlfZGV0YWlscyB8fCBmYWxzZTsKICAgICAgICAgICAgICBtc2cub3JkZXJfaXRlbXMgPSByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5vcmRlcl9pdGVtczsKICAgICAgICAgICAgICBtc2cuc2hvcGlmeV9mZXRjaF9jdXN0b21lcl9pZF9mb3Jfb2ZmZXJzID0KICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldCiAgICAgICAgICAgICAgICAgIC5zaG9waWZ5X2ZldGNoX2N1c3RvbWVyX2lkX2Zvcl9vZmZlcnMgfHwgZmFsc2U7CiAgICAgICAgICAgICAgLy8gaWYgKG1zZy5zaG9waWZ5X2ZldGNoX2N1c3RvbWVyX2lkX2Zvcl9vZmZlcnMgPT09IHRydWUpIHsKICAgICAgICAgICAgICAvLyAgIHZtLnNob3BpZnlfY2hlY2tfY3VzdG9tZXJfbG9nZ2VkX2luKCk7CiAgICAgICAgICAgICAgLy8gICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAvLyB9CiAgICAgICAgICAgICAgaWYobXNnLm9mZmVycy5sZW5ndGggPCAxKXsKICAgICAgICAgICAgICAgIG1zZy5vZmZlcnMgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1zZy5yZWNlaXZlZCA9ICJTb3JyeSB3ZSBkbyBub3QgaGF2ZSBhbnkgb2ZmZXJzIGN1cnJlbnRseSwgcGxlYXNlIGNoZWNrIGJhY2sgbGF0ZXIuIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2bS5jaGF0LnB1c2gobXNnKTsKICAgICAgICAgICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmludGVudCA9PSAiY2hhdF9zdXBwb3J0IikgewogICAgICAgICAgICAgIHZtLnN0YXJ0X2xpdmVfY2hhdCgpOwogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQgIT0gdW5kZWZpbmVkICYmCiAgICAgICAgICAgICAgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQuaW5jbHVkZXMoCiAgICAgICAgICAgICAgICAiRG93bmxvYWQgeW91ciBtYW5pZmVzdCBoZXJlIgogICAgICAgICAgICAgICkgfHwKICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQuaW5jbHVkZXMoLy5wZGYvKSkKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdm0uZGlzcGxheV9maWxlX2NoYXQocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgIEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ucHJvZHVjdHMpICYmCiAgICAgICAgICAgICAgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnByb2R1Y3RzLmxlbmd0aCA+IDAgfHwKICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnByb2R1Y3RzKS5sZW5ndGgpCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHZtLmRpc3BsYXlfcHJvZHVjdHNfY2hhdChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXSwgaSwgdHlwZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaXNfcmVmdW5kID09ICJUcnVlIikgewogICAgICAgICAgICAgIHZtLmxvYWRfcmVmdW5kcyhyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uc2hvcGlmeV9mZXRjaF9jdXN0b21lcl9pZCA9PT0gdHJ1ZQogICAgICAgICAgICApIHsKICAgICAgICAgICAgICB2bS5zaG9waWZ5X2NoZWNrX2N1c3RvbWVyX2xvZ2dlZF9pbigpOwogICAgICAgICAgICB9ZWxzZSBpZihyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbWFnZSAhPSB1bmRlZmluZWQpewogICAgICAgICAgICAgIG1zZy5pbWFnZSA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmltYWdlOwogICAgICAgICAgICAgIG1zZy5yZWNlaXZpbmcgPSB0cnVlOwogICAgICAgICAgICAgIHZtLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgICAgIHZtLm5ld191cGRhdGVfcmVzcG9uc2UoaSk7CiAgICAgICAgICAgIH1lbHNlIGlmKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnZpZGVvICE9IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgbXNnLnZpZGVvcyA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnZpZGVvIHx8IGZhbHNlOzsKICAgICAgICAgICAgICBtc2cucmVjZWl2aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICB2bS5jaGF0LnB1c2gobXNnKTsKICAgICAgICAgICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaSA8IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgaSArPSAxOwogICAgICAgICAgICB2bS5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKICAgICAgICAgICAgLy8gZGVsYXkgPQogICAgICAgICAgICAvLyAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQgIT0gdW5kZWZpbmVkICYmCiAgICAgICAgICAgIC8vICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dC5sZW5ndGggPiAxMAogICAgICAgICAgICAvLyAgICAgPyAyMDAwCiAgICAgICAgICAgIC8vICAgICA6IDUwMDsKICAgICAgICAgICAgZGVsYXkgPSA1MDA7CiAgICAgICAgICAgIGhhbmRsZV9yZXNwb25zZSgpOwogICAgICAgICAgfQogICAgICAgIH0sIGRlbGF5KTsKICAgICAgfQogICAgfSwKICAgIGRpc3BsYXlfYmFubmVyKHJlc3BvbnNlLCBpKXsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgdmFyIHBvc2l0aW9uXzEgPSByZXNwb25zZVtpXS5iYW5uZXJfY29udGVudF9wb3NpdGlvblswXVsnaWQnXTsKICAgICAgdmFyIHBvc2l0aW9uXzIgPSByZXNwb25zZVtpXS5iYW5uZXJfY29udGVudF9wb3NpdGlvblsxXVsnaWQnXTsKICAgICAgdmFyIHBvc2l0aW9uXzMgPSByZXNwb25zZVtpXS5iYW5uZXJfY29udGVudF9wb3NpdGlvblsyXVsnaWQnXTsKICAgICAgdmFyIGlzX2RhdGFfcG9zaXRpb25fMSA9IHJlc3BvbnNlW2ldW3Bvc2l0aW9uXzFdOwogICAgICB2YXIgaXNfZGF0YV9wb3NpdGlvbl8yID0gcmVzcG9uc2VbaV1bcG9zaXRpb25fMl07CiAgICAgIHZhciBpc19kYXRhX3Bvc2l0aW9uXzMgPSByZXNwb25zZVtpXVtwb3NpdGlvbl8zXTsKICAgICAgaWYoQm9vbGVhbihpc19kYXRhX3Bvc2l0aW9uXzEpKXsKICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICB0aW1lOgogICAgICAgICAgICAoaSA9PSByZXNwb25zZS5sZW5ndGggLSAxKSAmJiAhKEJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8yKSB8fCAoQm9vbGVhbihpc19kYXRhX3Bvc2l0aW9uXzMpKSkKICAgICAgICAgICAgICA/IHZtLmdlbmVyYXRlX3RpbWUoKQogICAgICAgICAgICAgIDogbnVsbCwKICAgICAgICAgIGFza19mZWVkYmFjazogQm9vbGVhbihyZXNwb25zZVtpXS5hc2tfZmVlZGJhY2spLAogICAgICAgICAgYmFubmVyX2ltZ19saW5rOiByZXNwb25zZVtpXS5iYW5uZXJfaW1nX2xpbmssCiAgICAgICAgfTsKICAgICAgICBtc2cuc2hvd19ib3RfaW1nID0gdHJ1ZTsKICAgICAgICBtc2dbJ3Nob3dfJysgcG9zaXRpb25fMV0gPSB0cnVlOwogICAgICAgIG1zZ1twb3NpdGlvbl8xXSA9IGlzX2RhdGFfcG9zaXRpb25fMTsKICAgICAgICB2bS5jaGF0LnB1c2gobXNnKTsKICAgICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwogICAgICAgIGlmKEJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8yKSl7CiAgICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgdGltZToKICAgICAgICAgICAgICAoaSA9PSByZXNwb25zZS5sZW5ndGggLSAxKSAmJiAhKEJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8zKSkKICAgICAgICAgICAgICAgID8gdm0uZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgICAgICAgICA6IG51bGwsCiAgICAgICAgICAgIGFza19mZWVkYmFjazogQm9vbGVhbihyZXNwb25zZVtpXS5hc2tfZmVlZGJhY2spLAogICAgICAgICAgICBiYW5uZXJfaW1nX2xpbms6IHJlc3BvbnNlW2ldLmJhbm5lcl9pbWdfbGluaywKICAgICAgICAgIH07CiAgICAgICAgICBtc2cuc2hvd19ib3RfaW1nID0gZmFsc2U7CiAgICAgICAgICBtc2dbJ3Nob3dfJysgcG9zaXRpb25fMl0gPSB0cnVlOwogICAgICAgICAgbXNnW3Bvc2l0aW9uXzJdID0gaXNfZGF0YV9wb3NpdGlvbl8yOwogICAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwogICAgICAgIH0KICAgICAgICBpZihCb29sZWFuKGlzX2RhdGFfcG9zaXRpb25fMykpewogICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgIHRpbWU6CiAgICAgICAgICAgICAgaSA9PSByZXNwb25zZS5sZW5ndGggLSAxCiAgICAgICAgICAgICAgICA/IHZtLmdlbmVyYXRlX3RpbWUoKQogICAgICAgICAgICAgICAgOiBudWxsLAogICAgICAgICAgICBhc2tfZmVlZGJhY2s6IEJvb2xlYW4ocmVzcG9uc2VbaV0uYXNrX2ZlZWRiYWNrKSwKICAgICAgICAgICAgYmFubmVyX2ltZ19saW5rOiByZXNwb25zZVtpXS5iYW5uZXJfaW1nX2xpbmssCiAgICAgICAgICB9OwogICAgICAgICAgbXNnLnNob3dfYm90X2ltZyA9IGZhbHNlOwogICAgICAgICAgbXNnWydzaG93XycrIHBvc2l0aW9uXzNdID0gdHJ1ZTsKICAgICAgICAgIG1zZ1twb3NpdGlvbl8zXSA9IGlzX2RhdGFfcG9zaXRpb25fMzsKICAgICAgICAgIHZtLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgdm0ubmV3X3VwZGF0ZV9yZXNwb25zZShpKTsKICAgICAgICB9CiAgICAgIH1lbHNlIGlmKEJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8yKSl7CiAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgdGltZToKICAgICAgICAgICAgKGkgPT0gcmVzcG9uc2UubGVuZ3RoIC0gMSkgJiYgIShCb29sZWFuKGlzX2RhdGFfcG9zaXRpb25fMykpCiAgICAgICAgICAgICAgPyB2bS5nZW5lcmF0ZV90aW1lKCkKICAgICAgICAgICAgICA6IG51bGwsCiAgICAgICAgICBhc2tfZmVlZGJhY2s6IEJvb2xlYW4ocmVzcG9uc2VbaV0uYXNrX2ZlZWRiYWNrKSwKICAgICAgICAgIGJhbm5lcl9pbWdfbGluazogcmVzcG9uc2VbaV0uYmFubmVyX2ltZ19saW5rLAogICAgICAgIH07CiAgICAgICAgbXNnLnNob3dfYm90X2ltZyA9IHRydWU7CiAgICAgICAgbXNnWydzaG93XycrIHBvc2l0aW9uXzJdID0gdHJ1ZTsKICAgICAgICBtc2dbcG9zaXRpb25fMl0gPSBpc19kYXRhX3Bvc2l0aW9uXzI7CiAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgdm0ubmV3X3VwZGF0ZV9yZXNwb25zZShpKTsKICAgICAgICBpZihCb29sZWFuKGlzX2RhdGFfcG9zaXRpb25fMykpewogICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgIHRpbWU6CiAgICAgICAgICAgICAgaSA9PSByZXNwb25zZS5sZW5ndGggLSAxCiAgICAgICAgICAgICAgICA/IHZtLmdlbmVyYXRlX3RpbWUoKQogICAgICAgICAgICAgICAgOiBudWxsLAogICAgICAgICAgICBhc2tfZmVlZGJhY2s6IEJvb2xlYW4ocmVzcG9uc2VbaV0uYXNrX2ZlZWRiYWNrKSwKICAgICAgICAgICAgYmFubmVyX2ltZ19saW5rOiByZXNwb25zZVtpXS5iYW5uZXJfaW1nX2xpbmssCiAgICAgICAgICB9OwogICAgICAgICAgbXNnLnNob3dfYm90X2ltZyA9IGZhbHNlOwogICAgICAgICAgbXNnWydzaG93XycrIHBvc2l0aW9uXzNdID0gdHJ1ZTsKICAgICAgICAgIG1zZ1twb3NpdGlvbl8zXSA9IGlzX2RhdGFfcG9zaXRpb25fMzsKICAgICAgICAgIHZtLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgdm0ubmV3X3VwZGF0ZV9yZXNwb25zZShpKTsKICAgICAgICB9CiAgICAgIH1lbHNlIGlmKEJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8zKSl7CiAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgdGltZToKICAgICAgICAgICAgaSA9PSByZXNwb25zZS5sZW5ndGggLSAxCiAgICAgICAgICAgICAgPyB2bS5nZW5lcmF0ZV90aW1lKCkKICAgICAgICAgICAgICA6IG51bGwsCiAgICAgICAgICBhc2tfZmVlZGJhY2s6IEJvb2xlYW4ocmVzcG9uc2VbaV0uYXNrX2ZlZWRiYWNrKSwKICAgICAgICAgIGJhbm5lcl9pbWdfbGluazogcmVzcG9uc2VbaV0uYmFubmVyX2ltZ19saW5rLAogICAgICAgIH07CiAgICAgICAgbXNnLnNob3dfYm90X2ltZyA9IHRydWU7CiAgICAgICAgbXNnWydzaG93XycrIHBvc2l0aW9uXzNdID0gdHJ1ZTsKICAgICAgICBtc2dbcG9zaXRpb25fM10gPSBpc19kYXRhX3Bvc2l0aW9uXzM7CiAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgdm0ubmV3X3VwZGF0ZV9yZXNwb25zZShpKTsKICAgICAgfQogICAgfSwKICAgIHB1c2hfbXNnKHJlc3BvbnNlcywgcmVzcG9uc2UpIHsKICAgICAgdmFyIGluZGV4ID0gMDsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgdmFyIGRlbGF5ID0gNTA7CiAgICAgIC8vIHB1c2hfY2hhdChyZXNwb25zZVtpbmRleF0sIGRlbGF5KTsKICAgICAgLy8gZnVuY3Rpb24gcHVzaF9jaGF0KG1zZywgdGltZV9kZWxheSkgewogICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCByZXNwb25zZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAvLyB3aGlsZSAoaSA8IHJlc3BvbnNlLmxlbmd0aCkgewogICAgICAgICAgLy8gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIHZhciBtc2cgPSByZXNwb25zZVtpXTsKICAgICAgICAgICAgdm0uaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgICAgICAgIC8vIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgIHZtLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICAgICAgICBpZiAocmVzcG9uc2VzLmRhdGEucmVzcG9uc2VzW2ldLmJ1dHRvbnMgIT0gdW5kZWZpbmVkICYmIEJvb2xlYW4ocmVzcG9uc2VzLmRhdGEucmVzcG9uc2VzW2ldLmJ1dHRvbnMubGVuZ3RoID4gMCkpIHsKICAgICAgICAgICAgICAgIHZtLmxvYWRfYnV0dG9ucygKICAgICAgICAgICAgICAgICAgcmVzcG9uc2VzLmRhdGEucmVzcG9uc2VzW2ldLAogICAgICAgICAgICAgICAgICAiaXNfYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgMzAwMCwKICAgICAgICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2bS5jaGF0LnB1c2goewogICAgICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICByZWNlaXZlZDogbXNnLnRleHQsCiAgICAgICAgICAgICAgICAgICAgb2ZmZXJzOiBtc2cub2ZmZXJzIHx8IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIHRpbWU6CiAgICAgICAgICAgICAgICAgICAgICBpID09IHJlc3BvbnNlLmxlbmd0aCAtIDEgPyB2bS5nZW5lcmF0ZV90aW1lKCkgOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uID09IGkpIHsKICAgICAgICAgICAgICAgICAgaWYgKHZtLmlzX3JldGFpbF9ib3QpIHZtLmxvYWRfY2hhdGJvdF9pbnRlZ3JhdGlvbl9kZXRhaWxzKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBpICAqIDEwNTApOwogICAgICAgICAgICAgICQoIi50aW1lIikubGFzdCgpLmNzcygiZGlzcGxheSIsICJub25lIik7CiAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAkKCIudGltZSIpLmxhc3QoKS5jc3MoImRpc3BsYXkiLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgIGlmIChpIDwgcmVzcG9uc2UubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgICAgICAvLyBpICs9IDE7CiAgICAgICAgICAgICAgICAgIC8vIGRlbGF5ID0gNTAwOwogICAgICAgICAgICAgICAgICAvLyBwdXNoX2NoYXQocmVzcG9uc2VbaW5kZXhdLCBkZWxheSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2bS53ZWxjb21lX21lc3NhZ2Vfbm90X3lldF9yZWNlaXZlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sIDUwMCk7CiAgICAgICAgICAgICAgLy8gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgLy8gfSwgMTAwMCk7CiAgICAgICAgICAgICAgLy8gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAvLyBpICs9MTsKICAgICAgICAgICAgLy8gfQogICAgICAgICAgICAgIC8vIH0sIDQwMCk7CiAgICAgICAgICAgIC8vIH0sIHRpbWVfZGVsYXkpOwogICAgICAgICAgICAvLyB9LCBpKiA1MDApOwogICAgICAgICAgfQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgdm0uZGVtb19yZXRhaWxfcXVlc3Rpb24oKTsKICAgICAgICB9LCBkZWxheSk7CiAgICAgIC8vIH0KICAgIH0sICAKICAgIGNvbmZ1c2lvbl9tZXNzYWdlKG1zZ19zdHJpbmcpIHsKICAgICAgYXhpb3MKICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICBjaGF0OiBtc2dfc3RyaW5nLAogICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgZGF0YTogIiIsCiAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IGZhbHNlLAogICAgICAgIH0pCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgICAgICB9KTsKICAgIH0sCiAgICBkaXNwbGF5X3Byb2R1Y3RzX2NoYXQobWVzc2FnZSwgaW5kZXgsIHR5cGUpIHsKICAgICAgdmFyIG1zZyA9IHsKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgfTsKICAgICAgaWYgKG1lc3NhZ2UucHJvZHVjdHMuaXNfcHJvZHVjdHNfbGlzdCkgewogICAgICAgIG1zZy5pc19wcm9kdWN0c19saXN0ID0gbWVzc2FnZS5wcm9kdWN0cy5pc19wcm9kdWN0c19saXN0OwogICAgICAgIG1zZy5wcm9kdWN0c19saXN0ID0gbWVzc2FnZS5wcm9kdWN0cy5wcm9kdWN0c19saXN0OwogICAgICAgIGlmIChtZXNzYWdlLnByb2R1Y3RzLnByb2R1Y3RzX2xpc3QubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICBtc2cucmVjZWl2ZWQgPSAiU29ycnksIHdlIGNvdWxkIG5vdCBmaW5kIHdoYXQgeW91IHNlYXJjaGVkIGZvciI7CiAgICAgICAgICBtc2cucmVjZWl2aW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgLy8gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBpZihCb29sZWFuKG1lc3NhZ2UucHJvZHVjdHMudGV4dCkgPT09IHRydWUpewogICAgICAgICAgICBtc2cucmVjZWl2ZWQgPSBtZXNzYWdlLnByb2R1Y3RzLnRleHQ7CiAgICAgICAgICAgIG1zZy5yZWNlaXZpbmcgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5wcm9kdWN0X291dF9vZl9zdG9ja19saXN0ID0gW107CgogICAgICAgICAgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gJ3Nob3BpZnknKSB7CiAgICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0LmZvckVhY2goKHByb2R1Y3QpID0+IHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9kdWN0LnZhcmlhdGlvbnMubGVuZ3RoOyBpKyspewogICAgICAgICAgICAgIHRoaXMucHJvZHVjdF9saXN0LnB1c2goewogICAgICAgICAgICAgICAgcHJvZHVjdF9pZDogcHJvZHVjdC52YXJpYXRpb25zW2ldLmlkLAogICAgICAgICAgICAgICAgcHJvZHVjdF90aXRsZTogcHJvZHVjdC50aXRsZSwKICAgICAgICAgICAgICAgIHZhcmlhbnRfdGl0bGU6IHByb2R1Y3QudmFyaWF0aW9uc1tpXS52YXJpYW50X3RpdGxlLAogICAgICAgICAgICAgICAgdmFyaWFudF9pZDogcHJvZHVjdC52YXJpYXRpb25zW2ldLmlkLAogICAgICAgICAgICAgICAgc3RvY2tfc3RhdHVzOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0uc3RvY2tfc3RhdHVzIHx8ICJpbnN0b2NrIiwKICAgICAgICAgICAgICAgIGJhY2tfaW5fc3RvY2s6IGZhbHNlLAogICAgICAgICAgICAgICAgcHJvZHVjdEltYWdlOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0uaW1nX3VybCA9PSBudWxsID8gcHJvZHVjdC5pbWdfdXJsIDogcHJvZHVjdC52YXJpYXRpb25zW2ldLmltZ191cmwsCiAgICAgICAgICAgICAgICBvbmxpbmVTdG9yZVVSTDogcHJvZHVjdC52YXJpYXRpb25zW2ldLnBlcm1hbGluawogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9ZWxzZSBpZih0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICd3b29jb21tZXJjZScpewogICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdC5mb3JFYWNoKChwcm9kdWN0KSA9PiB7CiAgICAgICAgICAgIGlmIChwcm9kdWN0LnZhcmlhdGlvbnMgJiYgcHJvZHVjdC52YXJpYXRpb25zLmxlbmd0aCA+IDApewogICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvZHVjdC52YXJpYXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMucHJvZHVjdF9saXN0LnB1c2goewogICAgICAgICAgICAgICAgICAgIHByb2R1Y3RfaWQ6IHByb2R1Y3QuaWQsCiAgICAgICAgICAgICAgICAgICAgcHJvZHVjdF90aXRsZTogcHJvZHVjdC50aXRsZSwKICAgICAgICAgICAgICAgICAgICB2YXJpYW50X3RpdGxlOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0udmFyaWFudF90aXRsZSwKICAgICAgICAgICAgICAgICAgICB2YXJpYW50X2lkOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0uaWQsCiAgICAgICAgICAgICAgICAgICAgc3RvY2tfc3RhdHVzOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0uc3RvY2tfc3RhdHVzIHx8ICJpbnN0b2NrIiwKICAgICAgICAgICAgICAgICAgICBiYWNrX2luX3N0b2NrOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBwcm9kdWN0SW1hZ2U6IHByb2R1Y3QudmFyaWF0aW9uc1tpXS5pbWdfdXJsID09IG51bGwgPyBwcm9kdWN0LmltZ191cmwgOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0uaW1nX3VybCwKICAgICAgICAgICAgICAgICAgICBvbmxpbmVTdG9yZVVSTDogcHJvZHVjdC5wZXJtYWxpbmsKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgIHRoaXMucHJvZHVjdF9saXN0LnB1c2goewogICAgICAgICAgICAgICAgcHJvZHVjdF9pZDogcHJvZHVjdC5pZCwKICAgICAgICAgICAgICAgIHByb2R1Y3RfdGl0bGU6IHByb2R1Y3QudGl0bGUsCiAgICAgICAgICAgICAgICB2YXJpYW50X3RpdGxlOiBudWxsLAogICAgICAgICAgICAgICAgdmFyaWFudF9pZDogbnVsbCwKICAgICAgICAgICAgICAgIHN0b2NrX3N0YXR1czogcHJvZHVjdC5zdG9ja19zdGF0dXMgfHwgImluc3RvY2siLAogICAgICAgICAgICAgICAgYmFja19pbl9zdG9jazogZmFsc2UsCiAgICAgICAgICAgICAgICBwcm9kdWN0SW1hZ2U6IHByb2R1Y3QuaW1nX3VybCwKICAgICAgICAgICAgICAgIG9ubGluZVN0b3JlVVJMOiBwcm9kdWN0LnBlcm1hbGluawogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9ZWxzZSBpZih0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICdtYWdlbnRvJyl7CiAgICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0LmZvckVhY2goKHByb2R1Y3QpID0+IHsKICAgICAgICAgICAgICBpZiAocHJvZHVjdC52YXJpYXRpb25zICYmIHByb2R1Y3QudmFyaWF0aW9ucy5sZW5ndGggPiAwKXsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvZHVjdC52YXJpYXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMucHJvZHVjdF9saXN0LnB1c2goewogICAgICAgICAgICAgICAgICAgIHByb2R1Y3RfaWQ6IHByb2R1Y3QuaWQsCiAgICAgICAgICAgICAgICAgICAgcHJvZHVjdF90aXRsZTogcHJvZHVjdC50aXRsZSwKICAgICAgICAgICAgICAgICAgICB2YXJpYW50X3RpdGxlOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0udmFyaWFudF90aXRsZSwKICAgICAgICAgICAgICAgICAgICB2YXJpYW50X2lkOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0uaWQsCiAgICAgICAgICAgICAgICAgICAgc3RvY2tfc3RhdHVzOiBwcm9kdWN0LnN0b2NrX3N0YXR1cyB8fCAiaW5zdG9jayIsCiAgICAgICAgICAgICAgICAgICAgYmFja19pbl9zdG9jazogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgcHJvZHVjdEltYWdlOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0uaW1nX3VybCA9PSBudWxsID8gcHJvZHVjdC5pbWdfdXJsIDogcHJvZHVjdC52YXJpYXRpb25zW2ldLmltZ191cmwsCiAgICAgICAgICAgICAgICAgICAgb25saW5lU3RvcmVVUkw6IHByb2R1Y3QudmFyaWF0aW9uc1tpXS5wZXJtYWxpbmsKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHRoaXMucHJvZHVjdF9saXN0LnB1c2goewogICAgICAgICAgICAgICAgICBwcm9kdWN0X2lkOiBwcm9kdWN0LmlkLAogICAgICAgICAgICAgICAgICBwcm9kdWN0X3RpdGxlOiBwcm9kdWN0LnRpdGxlLAogICAgICAgICAgICAgICAgICB2YXJpYW50X3RpdGxlOiBudWxsLAogICAgICAgICAgICAgICAgICB2YXJpYW50X2lkOiBudWxsLAogICAgICAgICAgICAgICAgICBzdG9ja19zdGF0dXM6IHByb2R1Y3Quc3RvY2tfc3RhdHVzIHx8ICJpbnN0b2NrIiwKICAgICAgICAgICAgICAgICAgYmFja19pbl9zdG9jazogZmFsc2UsCiAgICAgICAgICAgICAgICAgIHByb2R1Y3RJbWFnZTogcHJvZHVjdC5pbWdfdXJsLAogICAgICAgICAgICAgICAgICBvbmxpbmVTdG9yZVVSTDogcHJvZHVjdC5wZXJtYWxpbmsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgaW4gbXNnLnByb2R1Y3RzX2xpc3QpewogICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS5vcmRlcl9xdHkgPSAxOwogICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS5idXlfcXR5ID0gMTsKICAgICAgICAgICAgaWYgKG1zZy5wcm9kdWN0c19saXN0W2ldLnZhcmlhdGlvbnMgJiYgbXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9ucy5sZW5ndGggPiAwKXsKICAgICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS5pZCA9IG1zZy5wcm9kdWN0c19saXN0W2ldLnZhcmlhdGlvbnNbMF0uaWQ7CiAgICAgICAgICAgICAgbXNnLnByb2R1Y3RzX2xpc3RbaV0uaW1nX3VybCA9IChtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYXRpb25zWzBdLmltZ191cmwgPT09IG51bGwpID8gbXNnLnByb2R1Y3RzX2xpc3RbaV0uaW1nX3VybCA6IG1zZy5wcm9kdWN0c19saXN0W2ldLnZhcmlhdGlvbnNbMF0uaW1nX3VybDsKICAgICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS5wZXJtYWxpbmsgPSBtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYXRpb25zWzBdLnBlcm1hbGluazsKICAgICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYW50X3RpdGxlID0gbXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9uc1swXS52YXJpYW50X3RpdGxlOwogICAgICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0W2ldLnN0b2NrX3F1YW50aXR5ID0gbXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9uc1swXS5zdG9ja19xdWFudGl0eTsKICAgICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS5zdG9ja19zdGF0dXMgPSBtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYXRpb25zWzBdLnN0b2NrX3N0YXR1czsKICAgICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS5wcmljZSA9IG1zZy5wcm9kdWN0c19saXN0W2ldLnZhcmlhdGlvbnNbMF0ucHJpY2U7CiAgICAgICAgICAgICAgbXNnLnByb2R1Y3RzX2xpc3RbaV0ucmVndWxhcl9wcmljZSA9IG1zZy5wcm9kdWN0c19saXN0W2ldLnZhcmlhdGlvbnNbMF0ucmVndWxhcl9wcmljZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbXNnLm5ld19wcm9kdWN0cyA9IHRydWU7CiAgICAgICAgICB0aGlzLnNob3dfY3VzdG9tX2NhcnQgPSB0cnVlOwogICAgICAgICAgdmFyIG5ld2xpc3QgPSB0aGlzLnByb2R1Y3RfbGlzdC5maWx0ZXIoCiAgICAgICAgICAgIChwcm9kdWN0KSA9PiBwcm9kdWN0WyJzdG9ja19zdGF0dXMiXSA9PT0gIm91dG9mc3RvY2siCiAgICAgICAgICApOwoKICAgICAgICAgIG1zZy5wcm9kdWN0X291dF9vZl9zdG9ja19saXN0ID0gbmV3bGlzdDsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgbXNnLnByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3QubGVuZ3RoID4gMCAmJiAhdGhpcy5kaXNwbGF5X3Byb2R1Y3RzCiAgICAgICAgICApIHsKICAgICAgICAgICAgICBtc2cucHJvZHVjdF9vdXRfb2Zfc3RvY2sgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5kaXNwbGF5X3Byb2R1Y3RzID0gZmFsc2U7CiAgICAgICAgLy8gfSwgMjAwMCk7CiAgICAgICAgaWYgKHR5cGUgPT09ICJkaXNwbGF5X3N1Y2Nlc3NfdG9hc3RyIikgewogICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIHN3YWwoewogICAgICAgICAgICAgIHRleHQ6CiAgICAgICAgICAgICAgICAiVGVzdGluZyBDb21wbGV0ZWQgU3VjY2Vzc2Z1bGx5ISBQbGVhc2UgUHJvY2VlZCB0byB0aGUgbmV4dCBzdGVwLiIsCiAgICAgICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICAgICAgc2hvd0NhbmNlbEJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgICAgIHR5cGU6ICJzdWNjZXNzIiwKICAgICAgICAgICAgICB0aW1lcjogNTAwMCwKICAgICAgICAgICAgICB0aW1lclByb2dyZXNzQmFyOiB0cnVlLAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIDEyMDApOwogICAgICAgIH0KICAgICAgLy8gfSwgMzApOwogICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UucHJvZHVjdHMubGVuZ3RoKSB7CiAgICAgICAgbXNnLmlzcHJvZHVjdCA9IHRydWU7CiAgICAgICAgbXNnLmVsZW1lbnRzID0gbWVzc2FnZTsKICAgICAgfQogICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgdGhpcy5uZXdfdXBkYXRlX3Jlc3BvbnNlKGluZGV4KTsKICAgICAgdGhpcy5wcm9kdWN0X2xpc3QgPSBbXTsKICAgIH0sCiAgICBkaXNwbGF5X2ZpbGVfY2hhdChtZXNzYWdlKSB7CiAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgIH07CiAgICAgIGxldCB0ZW1wID0gbWVzc2FnZS5zcGxpdCgiRG93bmxvYWQgeW91ciBtYW5pZmVzdCBoZXJlICIpOwogICAgICBsZXQgdXJsID0gbWVzc2FnZS5tYXRjaCh0aGlzLnVybF9tYXRjaF9yZWdleClbMF07CiAgICAgIG1zZy51cmwgPSBtZXNzYWdlLmluY2x1ZGVzKCJEb3dubG9hZCB5b3VyIG1hbmlmZXN0IGhlcmUgIikKICAgICAgICA/IHRlbXBbMV0KICAgICAgICA6IHVybDsKICAgICAgbXNnLnJlY2VpdmluZyA9IGZhbHNlOwogICAgICBtc2cuZmlsZV9uYW1lID0gdXJsCiAgICAgICAgLnNwbGl0KC9eLipbXFxcL10vKVsxXQogICAgICAgIC5zcGxpdCgiLyIpCiAgICAgICAgLnBvcCgpCiAgICAgICAgLnNwbGl0KCI/IilbMF07CiAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgIC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICB9LAogICAgZ2VuZXJhdGVfb3JkZXJfZGV0YWlscyhvcmRlcikge30sCiAgICBhc3luYyBhZGRkcm9wZG93bnZhbHVlKHZhbHVlKSB7CiAgICAgIHRoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbiA9IHZhbHVlOwogICAgICBpZiAodmFsdWUubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMudG9fc2VuZCA9ICIiOwogICAgICAgIHRoaXMucmVzID0ge307CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnNlbGVjdGVkX2luZGljYXRpb24ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGxldCBwYXJzZWRKc29uID0gSlNPTi5wYXJzZSgKICAgICAgICAgICAgYHske3RoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbltpXS52YWx1ZS5zcGxpdCgieyIpWzFdfWAKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoaSA9PSAwKSB7CiAgICAgICAgICAgIHRoaXMudG9fc2VuZCA9IHRoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbltpXS50aXRsZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudG9fc2VuZCA9CiAgICAgICAgICAgICAgdGhpcy50b19zZW5kICsgIiwgIiArIHRoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbltpXS50aXRsZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLnJlc1tPYmplY3Qua2V5cyhwYXJzZWRKc29uKVswXS50b1N0cmluZygpXSA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5yZXNbT2JqZWN0LmtleXMocGFyc2VkSnNvbilbMF0udG9TdHJpbmcoKV0gPSBPYmplY3QudmFsdWVzKAogICAgICAgICAgICAgIHBhcnNlZEpzb24KICAgICAgICAgICAgKVswXS50b1N0cmluZygpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5yZXNbT2JqZWN0LmtleXMocGFyc2VkSnNvbilbMF0udG9TdHJpbmcoKV0gPQogICAgICAgICAgICAgIHRoaXMucmVzW09iamVjdC5rZXlzKHBhcnNlZEpzb24pWzBdLnRvU3RyaW5nKCldICsKICAgICAgICAgICAgICAiLCIgKwogICAgICAgICAgICAgIE9iamVjdC52YWx1ZXMocGFyc2VkSnNvbilbMF0udG9TdHJpbmcoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5idXR0b25fZmlsbCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudG9fc2VuZCA9ICIiOwogICAgICAgIHRoaXMucmVzID0ge307CiAgICAgIH0KICAgICAgdGhpcy5idXR0b25fZmlsbCgpOwogICAgfSwKICAgIGJ1dHRvbl9maWxsKCkgewogICAgICBpZiAodGhpcy50b19zZW5kID09ICIiKSB7CiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI3NlbmRfYnV0dG9uIikuY2xhc3NMaXN0LnJlbW92ZSgiZmlsbGVkIik7CiAgICAgIH0gZWxzZSBpZiAodGhpcy50b19zZW5kICE9ICIiKSB7CiAgICAgICAgaWYgKHRoaXMubGl2ZV9jaGF0X29uKSB7CiAgICAgICAgICB0aGlzLmNoYW5uZWwucHVzaCgic3RhcnRlZF90eXBpbmciKTsKICAgICAgICAgIHRoaXMuc3RvcF90eXBpbmcodGhpcyk7CiAgICAgICAgfQogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNzZW5kX2J1dHRvbiIpLmNsYXNzTGlzdC5hZGQoImZpbGxlZCIpOwogICAgICB9CiAgICB9LAogICAgc3RvcF90eXBpbmc6IGRlYm91bmNlKGZ1bmN0aW9uICh2bSkgewogICAgICB2bS5jaGFubmVsLnB1c2goInN0b3BwZWRfdHlwaW5nIik7CiAgICB9LCAxMDAwKSwKICAgIHNjcm9sbF9kb3duKCkgewogICAgICBpZiAoCiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmNoYXQtYm9keSIpLnNjcm9sbEhlaWdodCAtCiAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuY2hhdC1ib2R5Iikuc2Nyb2xsVG9wIDw9CiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmNoYXQtYm9keSIpLmNsaWVudEhlaWdodAogICAgICApIHsKICAgICAgICB0aGlzLnRvX3Njcm9sbCA9IGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudG9fc2Nyb2xsID0gdHJ1ZTsKICAgICAgfQogICAgfSwKICAgIGxvYWRfYnV0dG9ucyhtZXNzYWdlLCBpbmRleCwgdHlwZSAsIGdyZWV0aW5nX2J1dHRvbikgewogICAgICBpZiAodHlwZSA9PT0gImRpc3BsYXlfc3VjY2Vzc190b2FzdHIiKSB7CiAgICAgICAgc3dhbCh7CiAgICAgICAgICB0ZXh0OiAiU29tZSBlcnJvciBvY2N1cnJlZCB3aGlsZSB0ZXN0aW5nLiIsCiAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgdHlwZTogImVycm9yIiwKICAgICAgICAgIHRpbWVyOiA1MDAwLAogICAgICAgIH0pOwogICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgYXNrX2ZlZWRiYWNrOiBmYWxzZSwKICAgICAgICAgIHJlY2VpdmVkOgogICAgICAgICAgICAiU29tZSBlcnJvciBvY2N1cnJlZCB3aGlsZSB0ZXN0aW5nLiBQbGVhc2UgdHJ5IGJ5IHJlZnJlc2hpbmcgdGhlIGJyb3dzZXIhIElmIHRoZSBpc3N1ZSBwZXJzaXN0cywgcGxlYXNlIGNvbnRhY3Qgc3lzdGVtIGFkbWluLiIsCiAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgfTsKICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgbXNnID0gewogICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgIGJ1dHRvbnNfbGlzdDogW10sCiAgICAgICAgYnV0dG9uX3ByZWZpeDogbWVzc2FnZS5wcmVmaXgsCiAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgIHJlY2VpdmVkOiBtZXNzYWdlLnRleHQsCiAgICAgICAgdGltZTogbnVsbCwKICAgICAgfTsKICAgICAgaWYoQm9vbGVhbihncmVldGluZ19idXR0b24pKXsKICAgICAgIG1zZy5ncmVldGluZ19idXR0b24gPSBmYWxzZQogICAgICB9ZWxzZXsKICAgICAgICBtc2cuY3VzdG9tX2J1dHRvbnMgPSBmYWxzZQogICAgICB9CiAgICAgIGlmIChtZXNzYWdlLmJ1dHRvbnMubGVuZ3RoID09IDMpIHsKICAgICAgICBpZiAoCiAgICAgICAgICBtZXNzYWdlLmJ1dHRvbnNbMF0udGl0bGUgPT0gIkV4Y2hhbmdlIFJhdGUiICYmCiAgICAgICAgICBtZXNzYWdlLmJ1dHRvbnNbMV0udGl0bGUgPT0gIlRyYWNrIE15IFBhcmNlbCIgJiYKICAgICAgICAgIG1lc3NhZ2UuYnV0dG9uc1syXS50aXRsZSA9PSAiQ2FsbCBIZWxwZGVzayIKICAgICAgICApIHsKICAgICAgICAgIG1zZy5yZW1vdmFibGUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKAogICAgICAgIG1lc3NhZ2UudGV4dCA9PSAiV291bGQgeW91IGxpa2UgdG8gc2hhcmUgeW91ciBuYW1lIGFuZCBudW1iZXI/IiAmJgogICAgICAgIHRoaXMuaXNleGNoYW5nZQogICAgICApIHsKICAgICAgICAkKCIjcmVzcG9uc2VfYm90X3RleHQiKS5wcm9wKCJkaXNhYmxlZCIsIHRydWUpOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgaW4gbWVzc2FnZS5idXR0b25zKSB7CiAgICAgICAgaWYgKG1zZy5idXR0b25fcHJlZml4ICE9IG51bGwpIHsKICAgICAgICAgIG1zZy5idXR0b25zX2xpc3QucHVzaCh7CiAgICAgICAgICAgIHRpdGxlOiBtZXNzYWdlLmJ1dHRvbnNbaV0udGl0bGUsCiAgICAgICAgICAgIHZhbHVlOiBtc2cuYnV0dG9uX3ByZWZpeCArIG1lc3NhZ2UuYnV0dG9uc1tpXS52YWx1ZSwKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtc2cuYnV0dG9uc19saXN0LnB1c2goewogICAgICAgICAgICB0aXRsZTogbWVzc2FnZS5idXR0b25zW2ldLnRpdGxlLAogICAgICAgICAgICB2YWx1ZTogbWVzc2FnZS5idXR0b25zW2ldLnZhbHVlLAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICgKICAgICAgICAgIG1zZy5idXR0b25zX2xpc3RbaV0udGl0bGUgPT0gIk5vIiAmJgogICAgICAgICAgbWVzc2FnZS50ZXh0ICE9ICJDYW4gSSBoZWxwIHlvdSB3aXRoIGFueXRoaW5nIGVsc2U/IiAmJgogICAgICAgICAgdGhpcy5jb21wYW55aWQgPT0gImNsaW5pY2FsdHJpYWxzODEzNTIiCiAgICAgICAgKSB7CiAgICAgICAgICBtc2cuYnV0dG9uc19saXN0W2ldLnZhbHVlID0gImlzZGlzYWJsZWQiOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB2YXIgY2hhdEluZGV4ID0gdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgICBpZiAoaW5kZXggPT0gImlzX2J1dHRvbiIgfHwgaW5kZXggPT0gMCkgewogICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuY2hpbGRyZW4oKS5sYXN0KCkuaGVpZ2h0KCkgLwogICAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIDwKICAgICAgICAgICAgICAwLjUKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMSwgMTUwMCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoNTAsIDE1MDAsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5zY3JvbGxfZG93bigpOwogICAgICAgIH0KICAgICAgICBpZihCb29sZWFuKGdyZWV0aW5nX2J1dHRvbikpewogICAgICAgICAgdGhpcy5jaGF0W2NoYXRJbmRleCAtIDFdLmdyZWV0aW5nX2J1dHRvbiA9IHRydWU7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdEluZGV4IC0gMV0uY3VzdG9tX2J1dHRvbnMgPSB0cnVlOwogICAgICAgIH0KICAgICAgICAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHRoaXMuY2hhdFtjaGF0SW5kZXggLSAxXS50aW1lID0gdGhpcy5nZW5lcmF0ZV90aW1lKCk7CiAgICAgICAgfSwgNTAwKTsKICAgICAgLy8gfSwgNTAwKTsKICAgIH0sCiAgICBtdWx0aXNlbGVjdF9sb2FkKG1lc3NhZ2UsIGluZGV4KSB7CiAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgbXVsdGlzZWxlY3RfdmFsdWVzOiBtZXNzYWdlLmN1c3RvbS52YWx1ZXMsCiAgICAgICAgcGxhY2Vob2xkZXI6IG1lc3NhZ2UuY3VzdG9tLnBsYWNlaG9sZGVyLAogICAgICAgIGlzX211bHRpc2VsZWN0OiB0cnVlLAogICAgICAgIHZhbHVlX21hcHBpbmc6IFtdLAogICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICByZWNlaXZlZDogbWVzc2FnZS50ZXh0LAogICAgICAgIGRpc2FibGVkOiBmYWxzZSwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgfTsKICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgIH0sCiAgICBsb2FkX3RhYmxlKG1lc3NhZ2UsIGluZGV4KSB7CiAgICAgIGxldCBtc2cgPSB7CiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgY29sX2xpc3Q6IE9iamVjdC5rZXlzKG1lc3NhZ2UuY3VzdG9tLnZhbHVlc1swXSksCiAgICAgICAgdGFibGVfdmFsdWU6IG1lc3NhZ2UuY3VzdG9tLnZhbHVlcywKICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgcmVjZWl2ZWQ6IG1lc3NhZ2UudGV4dCwKICAgICAgICBpc190YWJsZTogdHJ1ZSwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgfTsKCiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgaWYgKGluZGV4ID09IDApIHsKICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmNoaWxkcmVuKCkubGFzdCgpLmhlaWdodCgpIC8KICAgICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA8CiAgICAgICAgICAgICAgMC41CiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDEsIDE1MDApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDAuNywgMTUwMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIDEwMDApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxMDAsIDE1MDAsIHRydWUpOwogICAgICAgICAgdGhpcy5zY3JvbGxfZG93bigpOwogICAgICAgIH0KICAgICAgfSwgMjUwMCk7CiAgICB9LAogICAgbG9hZF90ZXh0X2FyZWEobWVzc2FnZSwgaW5kZXgpIHsKICAgICAgbGV0IG1zZyA9IHsKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgcmVjZWl2ZWQ6IG1lc3NhZ2UudGV4dCwKICAgICAgICBzaG93X3RleHRfYXJlYTogdHJ1ZSwKICAgICAgICBkaXNhYmxlZDogZmFsc2UsCiAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgIH07CgogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgIGlmIChpbmRleCA9PSAwKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5jaGlsZHJlbigpLmxhc3QoKS5oZWlnaHQoKSAvCiAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPAogICAgICAgICAgICAgIDAuNQogICAgICAgICAgICApIHsKICAgICAgICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxLCAxNTAwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgwLjcsIDE1MDApOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMTAwLCAxNTAwLCB0cnVlKTsKCiAgICAgICAgICB0aGlzLnNjcm9sbF9kb3duKCk7CiAgICAgICAgfQogICAgICB9LCAyNTAwKTsKICAgIH0sCiAgICBzdGFydF9saXZlX2NoYXQoKSB7CiAgICAgIC8vIHZhciBtc2cgPSB7fTsKICAgICAgLy8gbXNnLnJlY2VpdmluZyA9IHRydWU7CiAgICAgIC8vIG1zZy5yZWNlaXZlZCA9CiAgICAgIC8vICAgIkkgYW0gY29ubmVjdGluZyB5b3UgdG8gb25lIG9mIG91ciBzdXBwb3J0IGFnZW50cy4gUGxlYXNlIHdhaXQgZm9yIGEgd2hpbGUuIjsKICAgICAgLy8gbXNnLmNvbnZlcnNhdGlvbl9vbmx5ID0gdHJ1ZTsKICAgICAgLy8gbXNnLnRpbWUgPSB0aGlzLmdlbmVyYXRlX3RpbWUoKTsKICAgICAgLy8gdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAvLyB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAvLyB0aGlzLmNoYXQucHVzaCh7CiAgICAgIC8vICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAvLyAgIHJlY2VpdmVkOiAiV2hhdCdzIHlvdXIgbmFtZT8iLAogICAgICAvLyAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAvLyAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAvLyB9KTsKICAgICAgLy8gdGhpcy5uZXdfdXBkYXRlX3Jlc3BvbnNlKDApOwogICAgICAvLyB0aGlzLnNjcm9sbF9kb3duKCk7CiAgICAgIHRoaXMuY2hhdF9zb2NrZXQgPSBuZXcgU29ja2V0KAogICAgICAgIHByb2Nlc3MuZW52LlZVRV9BUFBfTElWRV9DSEFUX1dFQlNPQ0tFVF9FTkRQT0lOVCwKICAgICAgICB7CiAgICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgfSwKICAgICAgICB9CiAgICAgICk7CiAgICAgIHRoaXMuY2hhdF9zb2NrZXQuY29ubmVjdCgpOwogICAgICB0aGlzLnN1cHBvcnRfY2hhbm5lbCA9IHRoaXMuY2hhdF9zb2NrZXQuY2hhbm5lbCgKICAgICAgICAiY29tcGFuaWVzOiIgKyB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9uYW1lCiAgICAgICk7CiAgICAgIHRoaXMuc3VwcG9ydF9jaGFubmVsLmpvaW4oKTsKICAgICAgY29uc3Qgdm0gPSB0aGlzOwogICAgICB0aGlzLnN1cHBvcnRfY2hhbm5lbC5wdXNoKCJjdXN0b21lcl93YW50c19wcmVzZW5jZSIpOwogICAgICB0aGlzLnN1cHBvcnRfY2hhbm5lbC5vbigiY3VzdG9tZXJfZ2V0c19wcmVzZW5jZSIsIChyZXMpID0+IHsKICAgICAgICBjb25zb2xlLmxvZygiY3VzdG9tZXJfZ2V0c19wcmVzZW5jZSByZXMiLCByZXMpOwogICAgICAgIGlmIChCb29sZWFuKHJlc1t2bS5jb21wYW55bmFtZV0pID09PSB0cnVlKSB7CiAgICAgICAgICB2YXIgY29tcGFueV9wcmVzZW5jZSA9IHJlc1t2bS5jb21wYW55bmFtZV1bIm1ldGFzIl07CiAgICAgICAgICAvLyBjb25zb2xlLmxvZyhjb21wYW55X3ByZXNlbmNlKTsKICAgICAgICAgIGxldCBzZWxmX3VzZXJfaW5kZXggPSBjb21wYW55X3ByZXNlbmNlCiAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gZS51c2VyX2luZm8udXNlcm5hbWU7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5pbmRleE9mKHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwpOwogICAgICAgICAgaWYgKHNlbGZfdXNlcl9pbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgY29tcGFueV9wcmVzZW5jZS5zcGxpY2Uoc2VsZl91c2VyX2luZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBwcmVzZW50X3JvbGVfbGlzdCA9IFtdOwogICAgICAgICAgY29tcGFueV9wcmVzZW5jZS5maWx0ZXIoKGVhY2gpID0+CiAgICAgICAgICAgIHByZXNlbnRfcm9sZV9saXN0LnB1c2goZWFjaC51c2VyX2luZm8ucm9sZSkKICAgICAgICAgICk7CiAgICAgICAgICBsZXQgdW5pcXVlX3JvbGVfbGlzdCA9IHByZXNlbnRfcm9sZV9saXN0LmZpbHRlcigKICAgICAgICAgICAgKHgsIGksIGEpID0+IGEuaW5kZXhPZih4KSA9PSBpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKAogICAgICAgICAgICB1bmlxdWVfcm9sZV9saXN0LmluY2x1ZGVzKCJBZG1pbiIpIHx8CiAgICAgICAgICAgIHVuaXF1ZV9yb2xlX2xpc3QuaW5jbHVkZXMoInN1cHBvcnQgYWdlbnQiKQogICAgICAgICAgKSB7CiAgICAgICAgICAgIHZtLmlzX3N1cHBvcnRfYWdlbnRfcHJlc2VudCA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2bS5pc19zdXBwb3J0X2FnZW50X3ByZXNlbnQgPSBmYWxzZTsKICAgICAgICAgICAgY29uc29sZS5sb2coImNvbWluZyBoZXJlIG5vdCBhIHN1cHBvcnQgYSBhZ2VudCIpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2bS5pc19zdXBwb3J0X2FnZW50X3ByZXNlbnQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdm0uY29ubmVjdF9zdXBwb3J0X2FnZW50KCk7CiAgICAgICAgLy8gY29uc29sZS5sb2cocmVzKQogICAgICB9KTsKCiAgICAgIC8vIHByZXNlbmNlLm9uU3luYygocmVzKSA9PiB7CiAgICAgIC8vIGNvbnNvbGUubG9nKHJlcykKICAgICAgLy8gfSkKICAgICAgLy8gYXhpb3MuZ2V0KGFwaV9jYWxscy5jaGF0X2dyb3VwX2FwaSgpKS50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAvLyAgIHRoaXMuY2hhdF9ncm91cF9uYW1lID0gcmVzcG9uc2UuZGF0YS5jaGF0X2dyb3VwX25hbWU7CiAgICAgIC8vICAgdGhpcy5saXZlX2NoYXRfdG9rZW4gPSByZXNwb25zZS5kYXRhLnRva2VuOwogICAgICAvLyAgIHRoaXMubGl2ZV9jaGF0X29uID0gdHJ1ZTsKICAgICAgLy8gICB0aGlzLmNoYXRfc29ja2V0ID0gbmV3IFNvY2tldCgKICAgICAgLy8gICAgIHByb2Nlc3MuZW52LlZVRV9BUFBfTElWRV9DSEFUX1dFQlNPQ0tFVF9FTkRQT0lOVCwKICAgICAgLy8gICAgIHsKICAgICAgLy8gICAgICAgcGFyYW1zOiB7CiAgICAgIC8vICAgICAgICAgY29tcGFueTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZSwKICAgICAgLy8gICAgICAgICBjaGF0X2dyb3VwX25hbWU6IHRoaXMuY2hhdF9ncm91cF9uYW1lLAogICAgICAvLyAgICAgICAgIHRva2VuOiB0aGlzLmxpdmVfY2hhdF90b2tlbiwKICAgICAgLy8gICAgICAgfSwKICAgICAgLy8gICAgIH0KICAgICAgLy8gICApOwogICAgICAvLyAgIHRoaXMuY2hhdF9zb2NrZXQuY29ubmVjdCgpOwogICAgICAvLyAgIHRoaXMuY2hhbm5lbCA9IHRoaXMuY2hhdF9zb2NrZXQuY2hhbm5lbCgKICAgICAgLy8gICAgICJjdXN0b21lcnNfZ3JvdXBzOiIgKyB0aGlzLmNoYXRfZ3JvdXBfbmFtZQogICAgICAvLyAgICk7CiAgICAgIC8vICAgdGhpcy5jaGFubmVsLmpvaW4oKTsKICAgICAgLy8gICB0aGlzLmNoYW5uZWwucHVzaCgiY3VzdG9tZXJfbmVlZHNfc3VwcG9ydF9hZ2VudCIpOwogICAgICAvLyAgIHRoaXMuY2hhbm5lbC5vbigibmV3X2NoYXRfbWVzc2FnZSIsIChyZXMpID0+IHsKICAgICAgLy8gICAgIGlmIChyZXMuc2VuZGVyICE9ICJjdXN0b21lciIpIHsKICAgICAgLy8gICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAvLyAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgLy8gICAgICAgICByZWNlaXZlZDogcmVzLm1lc3NhZ2UsCiAgICAgIC8vICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgIC8vICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgIC8vICAgICAgIH0pOwogICAgICAvLyAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgLy8gICAgICAgICB0aGlzLnNjcm9sbF9kb3duKCk7CiAgICAgIC8vICAgICAgICAgaWYgKAogICAgICAvLyAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmNoaWxkcmVuKCkubGFzdCgpLmhlaWdodCgpIC8KICAgICAgLy8gICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIDwKICAgICAgLy8gICAgICAgICAgIDAuNQogICAgICAvLyAgICAgICAgICkgewogICAgICAvLyAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMSwgMTUwMCk7CiAgICAgIC8vICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgLy8gICAgICAgICAgICQoIi5yZWNlaXZlciIpLmxhc3QoKS5wYXJlbnQoKS5oZWlnaHQoKSAvCiAgICAgIC8vICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA+CiAgICAgIC8vICAgICAgICAgICAgIDAuNSAmJgogICAgICAvLyAgICAgICAgICAgJCgiLnJlY2VpdmVyIikubGFzdCgpLnBhcmVudCgpLmhlaWdodCgpIC8KICAgICAgLy8gICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIDwKICAgICAgLy8gICAgICAgICAgICAgMC42CiAgICAgIC8vICAgICAgICAgKSB7CiAgICAgIC8vICAgICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgwLjksIDE1MDApOwogICAgICAvLyAgICAgICAgIH0gZWxzZSB7CiAgICAgIC8vICAgICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgwLjc1LCAxNTAwKTsKICAgICAgLy8gICAgICAgICB9CiAgICAgIC8vICAgICAgIH0sIDEwMDApOwogICAgICAvLyAgICAgICBpZiAoCiAgICAgIC8vICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIC0gJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbEhlaWdodCIpICE9CiAgICAgIC8vICAgICAgICAgMAogICAgICAvLyAgICAgICApIHsKICAgICAgLy8gICAgICAgICB0aGlzLnNjcm9sbF9kb3duKCk7CiAgICAgIC8vICAgICAgIH0KICAgICAgLy8gICAgIH0KICAgICAgLy8gICB9KTsKICAgICAgLy8gICB0aGlzLmNoYW5uZWwub24oInN0b3BwZWRfY2hhdCIsIChyZXMpID0+IHsKICAgICAgLy8gICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgLy8gICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgIC8vICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgLy8gICAgICAgcmVjZWl2ZWQ6ICJTdXBwb3J0IGFnZW50ICIgKyByZXMubWVzc2FnZSwKICAgICAgLy8gICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgIC8vICAgICB9KTsKICAgICAgLy8gICAgIHRoaXMubGl2ZV9jaGF0X29uID0gZmFsc2U7CiAgICAgIC8vICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgIC8vICAgfSk7CiAgICAgIC8vICAgdGhpcy5jaGFubmVsLm9uKCJzdGFydGVkX3R5cGluZyIsIChyZXMpID0+IHsKICAgICAgLy8gICAgIHRoaXMuaXNfYWdlbnRfdHlwaW5nID0gdHJ1ZTsKICAgICAgLy8gICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgIC8vICAgfSk7CiAgICAgIC8vICAgdGhpcy5jaGFubmVsLm9uKCJzdG9wcGVkX3R5cGluZyIsIChyZXMpID0+IHsKICAgICAgLy8gICAgIHRoaXMuaXNfYWdlbnRfdHlwaW5nID0gZmFsc2U7CiAgICAgIC8vICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgLy8gICB9KTsKICAgICAgLy8gfSk7CiAgICB9LAogICAgY29ubmVjdF9zdXBwb3J0X2FnZW50KCkgewogICAgICB2YXIgdm0gPSB0aGlzOwogICAgICB0aGlzLnN1cHBvcnRfY2hhbm5lbC5sZWF2ZSgpOwogICAgICB0aGlzLmNoYXRfc29ja2V0LmRpc2Nvbm5lY3QoKTsKICAgICAgdGhpcy5jaGF0X3NvY2tldCA9IG51bGw7CiAgICAgIGlmICh0aGlzLmlzX3N1cHBvcnRfYWdlbnRfcHJlc2VudCA9PT0gdHJ1ZSkgewogICAgICAgIHZhciBtc2cgPSB7fTsKICAgICAgICBtc2cucmVjZWl2aW5nID0gdHJ1ZTsKICAgICAgICBtc2cucmVjZWl2ZWQgPQogICAgICAgICAgIkkgYW0gY29ubmVjdGluZyB5b3UgdG8gb25lIG9mIG91ciBzdXBwb3J0IGFnZW50cy4gUGxlYXNlIHdhaXQgZm9yIGEgd2hpbGUuIjsKICAgICAgICBtc2cuY29udmVyc2F0aW9uX29ubHkgPSB0cnVlOwogICAgICAgIG1zZy50aW1lID0gdGhpcy5nZW5lcmF0ZV90aW1lKCk7CiAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgcmVjZWl2ZWQ6ICJXaGF0J3MgeW91ciBuYW1lPyIsCiAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgIH0pOwogICAgICAgIHRoaXMubmV3X3VwZGF0ZV9yZXNwb25zZSgwKTsKICAgICAgICB0aGlzLnNjcm9sbF9kb3duKCk7CiAgICAgICAgYXhpb3MuZ2V0KGFwaV9jYWxscy5jaGF0X2dyb3VwX2FwaSgpKS50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgdGhpcy5jaGF0X2dyb3VwX25hbWUgPSByZXNwb25zZS5kYXRhLmNoYXRfZ3JvdXBfbmFtZTsKICAgICAgICAgIHRoaXMubGl2ZV9jaGF0X3Rva2VuID0gcmVzcG9uc2UuZGF0YS50b2tlbjsKICAgICAgICAgIHRoaXMubGl2ZV9jaGF0X29uID0gdHJ1ZTsKICAgICAgICAgIHRoaXMuY2hhdF9zb2NrZXQgPSBuZXcgU29ja2V0KAogICAgICAgICAgICBwcm9jZXNzLmVudi5WVUVfQVBQX0xJVkVfQ0hBVF9XRUJTT0NLRVRfRU5EUE9JTlQsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgICAgIGNvbXBhbnk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUsCiAgICAgICAgICAgICAgICBjaGF0X2dyb3VwX25hbWU6IHRoaXMuY2hhdF9ncm91cF9uYW1lLAogICAgICAgICAgICAgICAgdG9rZW46IHRoaXMubGl2ZV9jaGF0X3Rva2VuLAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICAgICk7CiAgICAgICAgICB0aGlzLmNoYXRfc29ja2V0LmNvbm5lY3QoKTsKICAgICAgICAgIHRoaXMuY2hhbm5lbCA9IHRoaXMuY2hhdF9zb2NrZXQuY2hhbm5lbCgKICAgICAgICAgICAgImN1c3RvbWVyc19ncm91cHM6IiArIHRoaXMuY2hhdF9ncm91cF9uYW1lCiAgICAgICAgICApOwogICAgICAgICAgdGhpcy5jaGFubmVsLmpvaW4oKTsKICAgICAgICAgIHRoaXMuY2hhbm5lbC5wdXNoKCJjdXN0b21lcl9uZWVkc19zdXBwb3J0X2FnZW50Iik7CiAgICAgICAgICAKICAgICAgICAgIHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdm0uY2hhbm5lbC5wdXNoKCJjdXN0b21lcl9ncm91cF9wcmVzZW5jZSIpOwogICAgICAgICAgfSwgMjAwMCk7CiAgICAgICAgICBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZtLmNoYW5uZWwucHVzaCgiY3VzdG9tZXJfZ3JvdXBfc2VsZl9wcmVzZW5jZSIpOwogICAgICAgICAgfSwgMjAwMCk7CiAgICAgICAgICB0aGlzLmNoYW5uZWwub24oImN1c3RvbWVyX2dyb3VwX3NlbGZfcHJlc2VuY2UiLCAocmVzKSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJDVVNUT01FUiBHUk9VUCBQUkVTRU5DRSIsIHJlcyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMuY2hhbm5lbC5vbigibmV3X2NoYXRfbWVzc2FnZSIsIChyZXMpID0+IHsKCiAgICAgICAgICAgIGlmIChyZXMuc2VuZGVyICE9ICJjdXN0b21lciIpIHsKICAgICAgICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgICByZWNlaXZlZDogcmVzLm1lc3NhZ2UsCiAgICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxfZG93bigpOwogICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuY2hpbGRyZW4oKS5sYXN0KCkuaGVpZ2h0KCkgLwogICAgICAgICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA8CiAgICAgICAgICAgICAgICAgIDAuNQogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDEsIDE1MDApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgICAgICAgJCgiLnJlY2VpdmVyIikubGFzdCgpLnBhcmVudCgpLmhlaWdodCgpIC8KICAgICAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPgogICAgICAgICAgICAgICAgICAgIDAuNSAmJgogICAgICAgICAgICAgICAgICAkKCIucmVjZWl2ZXIiKS5sYXN0KCkucGFyZW50KCkuaGVpZ2h0KCkgLwogICAgICAgICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA8CiAgICAgICAgICAgICAgICAgICAgMC42CiAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMC45LCAxNTAwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDAuNzUsIDE1MDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sIDEwMDApOwogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSAtCiAgICAgICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5wcm9wKCJzY3JvbGxIZWlnaHQiKSAhPQogICAgICAgICAgICAgICAgMAogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxfZG93bigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLmNoYW5uZWwub24oInN0b3BwZWRfY2hhdCIsIChyZXMpID0+IHsKICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgICByZWNlaXZlZDogIlN1cHBvcnQgYWdlbnQgIiArIHJlcy5tZXNzYWdlLAogICAgICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5saXZlX2NoYXRfb24gPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jaGFubmVsLmxlYXZlKCk7CiAgICAgICAgICAgIHRoaXMubGl2ZV9jaGF0X3Rva2VuID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5jaGF0X2dyb3VwX25hbWUgPSBudWxsOwogICAgICAgICAgICB0aGlzLnVzZXJfbmFtZSA9ICIiOwogICAgICAgICAgICB0aGlzLmNoYXRfc29ja2V0LmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLmNoYW5uZWwub24oInN0YXJ0ZWRfdHlwaW5nIiwgKHJlcykgPT4gewogICAgICAgICAgICB0aGlzLmlzX2FnZW50X3R5cGluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMuY2hhbm5lbC5vbigic3RvcHBlZF90eXBpbmciLCAocmVzKSA9PiB7CiAgICAgICAgICAgIHRoaXMuaXNfYWdlbnRfdHlwaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zdXBwb3J0X3N1YnNjcmlwdGlvbl9kYXRhKCk7CiAgICAgIH0KICAgIH0sCiAgICBzdWJtaXRfY3VzdG9tX2Zvcm0oKSB7CiAgICAgIGlmIChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjZGV0YWlsc19mb3JtIikgIT0gbnVsbCkgewogICAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI2RldGFpbHNfZm9ybSIpOwogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigic3VibWl0IiwgKGV2ZW50KSA9PiB7CiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgLy8gYWN0dWFsIGxvZ2ljLCBlLmcuIHZhbGlkYXRlIHRoZSBmb3JtCiAgICAgICAgICB2YXIgcXVlcnlTdHJpbmcgPSAkKCIjZGV0YWlsc19mb3JtIikuc2VyaWFsaXplQXJyYXkoKTsKICAgICAgICAgIGlmICh0aGlzLmZvcm1fcGF5bG9hZCA9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuZm9ybV9wYXlsb2FkID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gcXVlcnlTdHJpbmcpIHsKICAgICAgICAgICAgICB0aGlzLmZvcm1fcGF5bG9hZFtxdWVyeVN0cmluZ1tpXS5uYW1lXSA9IHF1ZXJ5U3RyaW5nW2ldLnZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmJvdF91c2VyX2RhdGEoKSwgewogICAgICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMuZm9ybV9wYXlsb2FkLAogICAgICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEgPT0gIkJvdCBVc2VyIERhdGEgU2F2ZWQgU3VjY2Vzc2Z1bGx5IikgewogICAgICAgICAgICAgICAgICAkKCIjZGV0YWlsc19mb3JtIDppbnB1dCIpLnByb3AoImRpc2FibGVkIiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICQoIiNkZXRhaWxzX2Zvcm0gOmJ1dHRvbiIpLnByb3AoImRpc2FibGVkIiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICAgICAgICAgICAgICBjaGF0OiAiL2RldGFpbHNfZm9ybSIsCiAgICAgICAgICAgICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikKICAgICAgICAgICAgICAgICAgICAgICAgLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgICAgICAgRGV0YWlsczogSlNPTi5zdHJpbmdpZnkodGhpcy5mb3JtX3BheWxvYWQpLAogICAgICAgICAgICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXNwKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3ApOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMSwgMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgdXBkYXRlX3Njcm9sbGJhcih0eXBlLCBtc2dUeXBlLCBpc3dlbGNvbWUsIGRlbGF5X3ZhbHVlKSB7CiAgICAgIHZhciBzY3JvbGxfZGVsYXkgPSBpc3dlbGNvbWUgPT0gImlzX3dlbGNvbWUiID8gZGVsYXlfdmFsdWUgOiAyMDAwOwogICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICBpZiAobXNnVHlwZSA9PSAicmVzcG9uc2UiKSB7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICB9LCBzY3JvbGxfZGVsYXkpOwogICAgICB9IGVsc2UgaWYgKG1zZ1R5cGUgPT0gInNlbmRlciIpIHsKICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxLCA3NTApOwogICAgICB9CiAgICAgIGlmIChtc2dUeXBlID09ICJyZXNwb25zZSIpIHsKICAgICAgICBpZiAodHlwZSA9PSAidXB0b19lbmQiKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5wcm9wKCJzY3JvbGxUb3AiKSA8CiAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbEhlaWdodCIpCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICQoIi5yZWNlaXZlciIpLmxhc3QoKS5wYXJlbnQoKS5oZWlnaHQoKSAvCiAgICAgICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA+CiAgICAgICAgICAgICAgICAwLjUKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDAuNzUsIDE1MDApOwogICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxfZG93bigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgICAkKCIucmVjZWl2ZXIiKS5sYXN0KCkucGFyZW50KCkuaGVpZ2h0KCkgLwogICAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIDwKICAgICAgICAgICAgICAwLjUKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMSwgc2Nyb2xsX2RlbGF5KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgc2Nyb2xsX2RlbGF5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5jaGF0LWJvZHkiKS5zY3JvbGxUb3AgPQogICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5jaGF0LWJvZHkiKS5zY3JvbGxIZWlnaHQgLQogICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5jaGF0LWJvZHkiKS5sYXN0Q2hpbGQuc2Nyb2xsSGVpZ2h0OwogICAgICAgICAgfSwgMTAwMCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgbmV3X3VwZGF0ZV9yZXNwb25zZShpbmRleCkgewogICAgICBpZiAoaW5kZXggPT0gMCkgewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgdGhpcy5zY3JvbGxfZG93bigpOwogICAgICAgICAgaWYgKAogICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuY2hpbGRyZW4oKS5sYXN0KCkuaGVpZ2h0KCkgLwogICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA8CiAgICAgICAgICAgIDAuNQogICAgICAgICAgKSB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDEsIDE1MDApOwogICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgJCgiLnJlY2VpdmVyIikubGFzdCgpLnBhcmVudCgpLmhlaWdodCgpIC8gJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpID4KICAgICAgICAgICAgICAwLjUgJiYKICAgICAgICAgICAgJCgiLnJlY2VpdmVyIikubGFzdCgpLnBhcmVudCgpLmhlaWdodCgpIC8gJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIDwKICAgICAgICAgICAgICAwLjYKICAgICAgICAgICkgewogICAgICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxLCAxNTAwKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDEsIDE1MDApOwogICAgICAgICAgfQogICAgICAgIH0sIDEwMDApOwogICAgICB9CiAgICAgIGlmICgKICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgLSAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikgIT0KICAgICAgICAwCiAgICAgICkgewogICAgICAgIHRoaXMuc2Nyb2xsX2Rvd24oKTsKICAgICAgfQogICAgICBpZiAoCiAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIC0gJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbEhlaWdodCIpID09PQogICAgICAgIDAKICAgICAgKSB7CiAgICAgICAgdGhpcy50b19zY3JvbGwgPSBmYWxzZTsKICAgICAgfQogICAgfSwKICAgIGFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbChzY2FsZSwgZGVsYXksIG9mZnNldCkgewogICAgICBpZiAoQm9vbGVhbihvZmZzZXQpKSB7CiAgICAgICAgJCgiLmNoYXQtYm9keSIpLmFuaW1hdGUoCiAgICAgICAgICB7CiAgICAgICAgICAgIHNjcm9sbFRvcDogJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbFRvcCIpICsgc2NhbGUsCiAgICAgICAgICB9LAogICAgICAgICAgZGVsYXkKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgICQoIi5jaGF0LWJvZHkiKS5hbmltYXRlKAogICAgICAgICAgewogICAgICAgICAgICBzY3JvbGxUb3A6IHNjYWxlICogJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbEhlaWdodCIpLAogICAgICAgICAgfSwKICAgICAgICAgIGRlbGF5CiAgICAgICAgKTsKICAgICAgfQogICAgfSwKICAgIGFkZF9ib3RfdW5hbnN3ZXJlZF9xdWVzdGlvbihpbmRleCwgbWV0aG9kKSB7CiAgICAgIGF4aW9zCiAgICAgICAgLnB1dCgKICAgICAgICAgIGFwaV9jYWxscy5nZXRfdW5hbnN3ZXJlZF91cmwoKSwKICAgICAgICAgIHsKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICBib3RfYW5zd2VyOiB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkLAogICAgICAgICAgICB1c2VyX3F1ZXJ5OiB0aGlzLmNoYXRbaW5kZXggLSAxXS5zZW50LAogICAgICAgICAgICBmZWVkYmFjazogbWV0aG9kID8gImxpa2UiIDogImRpc2xpa2UiLAogICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBjb21wYW55aWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkLAogICAgICAgICAgICBjb21wYW55bmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZSwKICAgICAgICAgIH0sCiAgICAgICAgICB7CiAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgICAgfSwKICAgICAgICAgIH0KICAgICAgICApCiAgICAgICAgLnRoZW4oKCkgPT4gewogICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5hc2tfZmVlZGJhY2sgPSBmYWxzZTsKICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoKSA9PiB7fSk7CiAgICB9LAogICAgbG9hZF9yZWZ1bmRzKCkgewogICAgICBsZXQgbXNnID0gewogICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgIGlzX3JlZnVuZDogdHJ1ZSwKICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgcmVjZWl2ZWQ6IHRoaXMucmV0YWlsX29yZGVyX3JldHJlaXZhbF9vbmx5X2VtYWlsX3JlcXVpcmVkCiAgICAgICAgICA/ICJQbGVhc2UgZW50ZXIgZW1haWwgdG8gZmV0Y2ggeW91ciBvcmRlcnMuIgogICAgICAgICAgOiAiUGxlYXNlIGxvZ2luIHRvIGZldGNoIHlvdXIgcmVjZW50IG9yZGVycyIsCiAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgIH07CgogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBsZXQgbGF0ZXN0Q2hhdEluZGV4ID0gdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgICBsYXRlc3RDaGF0SW5kZXggLT0gMTsKICAgICAgICB0aGlzLmNoYXRbbGF0ZXN0Q2hhdEluZGV4XS5mZXRjaF9zaG9waWZ5X2RldGFpbHMgPSB0cnVlOwogICAgICAgIHRoaXMuc2Nyb2xsX2Rvd24oKTsKICAgICAgfSwgMTAwMCk7CiAgICB9LAogICAgdmlld19vcmRlcl9kZXRhaWxzKGNoYXRJbmRleCwgb3JkZXJJbmRleCwgb3JkZXJMaW5lSXRlbXMsIG9yZGVyUmVmdW5kcykgewogICAgICB0aGlzLmNoYXRbY2hhdEluZGV4XS5yZWZ1bmRfc2VsZWN0ZWRfaXRlbXMgPSBbXTsKICAgICAgdGhpcy5jaGF0W2NoYXRJbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZF9saXN0ID0gbnVsbDsKICAgICAgdGhpcy5jaGF0W2NoYXRJbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZCA9IG51bGw7CiAgICAgIHRoaXMuY2hhdFtjaGF0SW5kZXhdLnJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMgPSBPYmplY3QoCiAgICAgICAgdGhpcy5jaGF0W2NoYXRJbmRleF0ucmVmdW5kX29yZGVyc19saXN0W29yZGVySW5kZXhdCiAgICAgICk7CiAgICAgIHRoaXMuY2hhdFtjaGF0SW5kZXhdLnJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMubGluZV9pdGVtcyA9IG9yZGVyTGluZUl0ZW1zLm1hcCgKICAgICAgICAobGluZUl0ZW0pID0+IHsKICAgICAgICAgIGxldCBsaW5lSXRlbU5vZGUgPSBsaW5lSXRlbTsKICAgICAgICAgIGxpbmVJdGVtTm9kZS5zZWxlY3RlZF9xdWFudGl0eSA9IHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iID8gbGluZUl0ZW0ucXR5X29yZGVyZWQgOiBsaW5lSXRlbS5xdWFudGl0eTsKICAgICAgICAgIGxpbmVJdGVtTm9kZS5hbHJlYWR5X3JlZnVuZGVkX3F0eSA9IHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iID8gbGluZUl0ZW0ucXR5X3JlZnVuZGVkIDogMDsKICAgICAgICAgIGxpbmVJdGVtTm9kZS5xdHlfYXZhaWxhYmxlX2Zvcl9yZWZ1bmQgPSB0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJtYWdlbnRvIiA/IGxpbmVJdGVtLnF0eV9vcmRlcmVkIDogbGluZUl0ZW0ucXVhbnRpdHk7CiAgICAgICAgICBsaW5lSXRlbU5vZGUucHJvZHVjdF9pZCA9IGxpbmVJdGVtLnByb2R1Y3RfaWQ7CiAgICAgICAgICBsaW5lSXRlbU5vZGUudmFyaWFudF9pZCA9IHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iID8gbGluZUl0ZW0uc2t1IDogbGluZUl0ZW0udmFyaWFudF9pZDsKICAgICAgICAgIHJldHVybiBsaW5lSXRlbU5vZGU7CiAgICAgICAgfQogICAgICApOwogICAgICBpZiAoQm9vbGVhbihvcmRlclJlZnVuZHMpID09PSB0cnVlKXsKICAgICAgICBvcmRlclJlZnVuZHMgPSBvcmRlclJlZnVuZHMubWFwKGxpbmVJdGVtPT57IHJldHVybiBsaW5lSXRlbS5yZWZ1bmRfbGluZV9pdGVtc1swXX0pOwogICAgICAgIHZhciBBbHJlYWR5UmVmdW5kZWRRdHkgPSBbXTsKICAgICAgICBvcmRlclJlZnVuZHMucmVkdWNlKGZ1bmN0aW9uKHJlcywgdmFsdWUpIHsKICAgICAgICAgIGlmICghcmVzW3ZhbHVlLmxpbmVfaXRlbV9pZF0pIHsKICAgICAgICAgICAgcmVzW3ZhbHVlLmxpbmVfaXRlbV9pZF0gPSB7IGxpbmVfaXRlbV9pZDogdmFsdWUubGluZV9pdGVtX2lkLCBxdWFudGl0eTogMCB9OwogICAgICAgICAgICBBbHJlYWR5UmVmdW5kZWRRdHkucHVzaChyZXNbdmFsdWUubGluZV9pdGVtX2lkXSkKICAgICAgICAgIH0KICAgICAgICAgIHJlc1t2YWx1ZS5saW5lX2l0ZW1faWRdLnF1YW50aXR5ICs9IHZhbHVlLnF1YW50aXR5OwogICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICB9LCB7fSk7CiAgICAgICAgbGV0IHRlbXAgPSB0aGlzLmNoYXRbY2hhdEluZGV4XS5yZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzLmxpbmVfaXRlbXM7CiAgICAgICAgdGhpcy5jaGF0W2NoYXRJbmRleF0ucmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlscy5saW5lX2l0ZW1zID0gdGVtcC5tYXAobGluZUl0ZW09PnsKICAgICAgICAgICAgbGV0IGxpbmVJdGVtTm9kZSA9IGxpbmVJdGVtOwogICAgICAgICAgICBmb3IodmFyIGkgaW4gQWxyZWFkeVJlZnVuZGVkUXR5KXsKICAgICAgICAgICAgICAgIGlmIChsaW5lSXRlbS5pZCA9PSBBbHJlYWR5UmVmdW5kZWRRdHlbaV0ubGluZV9pdGVtX2lkKXsKICAgICAgICAgICAgICAgICAgICBsaW5lSXRlbU5vZGUuYWxyZWFkeV9yZWZ1bmRlZF9xdHkgPSBBbHJlYWR5UmVmdW5kZWRRdHlbaV1bJ3F1YW50aXR5J107CiAgICAgICAgICAgICAgICAgICAgbGluZUl0ZW1Ob2RlLnF0eV9hdmFpbGFibGVfZm9yX3JlZnVuZCA9IChsaW5lSXRlbS5xdWFudGl0eSktKEFscmVhZHlSZWZ1bmRlZFF0eVtpXVsncXVhbnRpdHknXSk7CiAgICAgICAgICAgICAgICAgICAgbGluZUl0ZW1Ob2RlLnNlbGVjdGVkX3F1YW50aXR5ID0gKGxpbmVJdGVtLnF1YW50aXR5KS0oQWxyZWFkeVJlZnVuZGVkUXR5W2ldWydxdWFudGl0eSddKTsKICAgICAgICAgICAgICAgICAgICBsaW5lSXRlbU5vZGUucHJvZHVjdF9pZCA9IGxpbmVJdGVtLnByb2R1Y3RfaWQ7CiAgICAgICAgICAgICAgICAgICAgbGluZUl0ZW1Ob2RlLnZhcmlhbnRfaWQgPSB0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJtYWdlbnRvIiA/IGxpbmVJdGVtLnNrdSA6IGxpbmVJdGVtLnZhcmlhbnRfaWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgcmV0dXJuIGxpbmVJdGVtTm9kZTsKICAgICAgICB9KTsKICAgICAgfQogICAgICB0aGlzLiRzZXQoCiAgICAgICAgICAgIHRoaXMuY2hhdCwgY2hhdEluZGV4LAogICAgICAgICAgICB0aGlzLmNoYXRbY2hhdEluZGV4XQogICAgICAgICAgKTsKICAgIH0sCiAgICByZWZyZXNoX29yX3JlbW92ZV9vcmRlcl9kZXRhaWxzKGNoYXRJbmRleCwgdmFsKSB7CiAgICAgIGlmICh2YWwgPT0gInJlbW92ZSIpIHsKICAgICAgICB0aGlzLmNoYXRbY2hhdEluZGV4XS5yZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzID0ge307CiAgICAgIH0KICAgICAgdGhpcy4kc2V0KAogICAgICAgICAgICB0aGlzLmNoYXQsIGNoYXRJbmRleCwKICAgICAgICAgICAgdGhpcy5jaGF0W2NoYXRJbmRleF0KICAgICAgICAgICk7CiAgICB9LAogICAgbG9hZF9jdXN0b21lcl9vcmRlcnMob3JkZXJzRGF0YSwgaW5kZXgsIG9yZGVyX3R5cGUpIHsKICAgICAgLy8gdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9IGBPcmRlciAke29yZGVyTmFtZX1gOwogICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICBpZiAob3JkZXJfdHlwZSA9PT0gInJlZnVuZCIpIHsKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gIkZldGNoaW5nIHlvdXIgb3JkZXJzIC4uLiI7CiAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QgPSBvcmRlcnNEYXRhLm1hcCgob3JkZXIpID0+IHsKICAgICAgICAgIGxldCBvcmRlck9iamVjdCA9IG9yZGVyOwogICAgICAgICAgb3JkZXJPYmplY3QuY3JlYXRlZF9hdCA9IG1vbWVudChvcmRlck9iamVjdC5jcmVhdGVkX2F0LCBbCiAgICAgICAgICAgICJZWVlZLU1NLUREVGg6bTpzWiIsCiAgICAgICAgICBdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIik7CiAgICAgICAgICBvcmRlck9iamVjdC5uYW1lID0gdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIgPyBvcmRlck9iamVjdC5uYW1lIDogb3JkZXJPYmplY3QuaWQ7CiAgICAgICAgICBvcmRlck9iamVjdC5wcm9jZXNzZWRBdCA9IG1vbWVudChvcmRlck9iamVjdC5jcmVhdGVkX2F0LCBbCiAgICAgICAgICAgICJZWVlZLU1NLUREVGhoOm1tOnNzWiIsCiAgICAgICAgICBdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIik7CiAgICAgICAgICAgIC8vIGN1cl9ub2RlLmZ1bGZpbGxtZW50U3RhdHVzID0gY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzOwogICAgICAgICAgb3JkZXJPYmplY3QuZnVsZmlsbG1lbnRfc3RhdHVzID0KICAgICAgICAgICAgQm9vbGVhbihvcmRlck9iamVjdC5mdWxmaWxsbWVudF9zdGF0dXMpID09PSB0cnVlCiAgICAgICAgICAgICAgPyBvcmRlck9iamVjdC5mdWxmaWxsbWVudF9zdGF0dXMKICAgICAgICAgICAgICA6ICJVbmZ1bGZpbGxlZCI7CiAgICAgICAgICAvLyBTZXQgb25seSBmaXJzdCBjaGFyYWN0ZXIgdG8gdXBwZXJjYXNlIHdoaWxlIHJlbWFpbmluZyBjaGFyYWN0ZXJzIHNldCB0byBsb3dlcmNhc2UKICAgICAgICAgIG9yZGVyT2JqZWN0LmZ1bGZpbGxtZW50X3N0YXR1cyA9CiAgICAgICAgICBvcmRlck9iamVjdC5mdWxmaWxsbWVudF9zdGF0dXMuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKwogICAgICAgICAgb3JkZXJPYmplY3QuZnVsZmlsbG1lbnRfc3RhdHVzLnNsaWNlKDEpLnRvTG93ZXJDYXNlKCk7CgogICAgICAgICAgaWYodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayAhPSAic2hvcGlmeSIpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcmRlck9iamVjdC5vcmRlcl9ub3Rlcy5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgb3JkZXJPYmplY3Qub3JkZXJfbm90ZXNbaV0uZGF0ZV9jcmVhdGVkID0gbW9tZW50KG9yZGVyT2JqZWN0Lm9yZGVyX25vdGVzW2ldLmRhdGVfY3JlYXRlZCwgWwogICAgICAgICAgICAiWVlZWS1NTS1ERFRoaDptbTpzc1oiLAogICAgICAgICAgICBdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIEhIOm1tIGEiKQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gb3JkZXJPYmplY3Q7CiAgICAgICAgfSk7CiAgICAgICAgaWYgKHRoaXMuY2hhdFtpbmRleF0ucmVmdW5kX29yZGVyc19saXN0Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJUaGVyZSBhcmUgbm8gb3JkZXJzIHRvIGJlIGRpc3BsYXllZCI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPQogICAgICAgICAgICAiU2VsZWN0IHRoZSBvcmRlciB0aGF0IHlvdSB3aXNoIHRvIHJldHVybiI7CiAgICAgICAgfQogICAgICAgIC8vIHRoaXMucmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlscyA9IHt9OwogICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlscyA9IHt9OwogICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVmdW5kX3NlbGVjdGVkX2l0ZW1zID0gW107CiAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX2xpc3QgPSBudWxsOwogICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZCA9IG51bGw7CiAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5jb252ZXJzYXRpb25fb25seSA9IGZhbHNlOwogICAgICAgIHRoaXMuY2hhdFtpbmRleF0uY29udmVyc2F0aW9uX29ubHkgPSB0cnVlOwogICAgICB9IGVsc2UgaWYgKG9yZGVyX3R5cGUgPT09ICJhbGxfb3JkZXJzIikgewogICAgICAgIGxldCBvcmRlcnNfZGF0YSA9IG9yZGVyc0RhdGEsCiAgICAgICAgICBjb21wbGV0ZV9vcmRlcnNfZGF0YSA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3JkZXJzX2RhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBjdXJfbm9kZSA9IG9yZGVyc19kYXRhW2ldOwogICAgICAgICAgY3VyX25vZGUucHJvY2Vzc2VkQXQgPSBtb21lbnQoY3VyX25vZGUuY3JlYXRlZF9hdCwgWwogICAgICAgICAgICAiWVlZWS1NTS1ERFRoaDptbTpzc1oiLAogICAgICAgICAgXSkuZm9ybWF0KCJEbyBNTU0gWVlZWSIpOwogICAgICAgICAgLy8gY3VyX25vZGUuZnVsZmlsbG1lbnRTdGF0dXMgPSBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXM7CiAgICAgICAgICBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMgPQogICAgICAgICAgICBCb29sZWFuKGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cykgPT09IHRydWUKICAgICAgICAgICAgICA/IGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cwogICAgICAgICAgICAgIDogIlVuZnVsZmlsbGVkIjsKICAgICAgICAgIC8vIC8vIFNldCBvbmx5IGZpcnN0IGNoYXJhY3RlciB0byB1cHBlcmNhc2Ugd2hpbGUgcmVtYWluaW5nIGNoYXJhY3RlcnMgc2V0IHRvIGxvd2VyY2FzZQogICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzID0KICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsKICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzLnNsaWNlKDEpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBpZih0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrICE9ICJzaG9waWZ5IikgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1cl9ub2RlLm9yZGVyX25vdGVzLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICBjdXJfbm9kZS5vcmRlcl9ub3Rlc1tpXS5kYXRlX2NyZWF0ZWQgPSBtb21lbnQoY3VyX25vZGUub3JkZXJfbm90ZXNbaV0uZGF0ZV9jcmVhdGVkLCBbCiAgICAgICAgICAgICJZWVlZLU1NLUREVGhoOm1tOnNzWiIsCiAgICAgICAgICAgIF0pLmZvcm1hdCgiRG8gTU1NIFlZWVkgSEg6bW0gYSIpCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvbXBsZXRlX29yZGVyc19kYXRhLnB1c2goewogICAgICAgICAgICBuYW1lOiB0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJzaG9waWZ5IiA/IGN1cl9ub2RlLm5hbWUgOiBjdXJfbm9kZS5pZCwKICAgICAgICAgICAgcHJvY2Vzc2VkX2RhdGU6IGN1cl9ub2RlLnByb2Nlc3NlZEF0LAogICAgICAgICAgICBmdWxmaWxsbWVudF9zdGF0dXM6IGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cywKICAgICAgICAgICAgc3RhdHVzX3VybDogY3VyX25vZGUub3JkZXJfc3RhdHVzX3VybCwKICAgICAgICAgICAgb3JkZXJfbm90ZXM6IHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gInNob3BpZnkiID8gbnVsbCA6IGN1cl9ub2RlLm9yZGVyX25vdGVzLAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvd19hbGxfb3JkZXJzX2xpc3QgPSB0cnVlOwogICAgICAgIHRoaXMuY2hhdFtpbmRleF0uYWxsX29yZGVyc19saXN0ID0gY29tcGxldGVfb3JkZXJzX2RhdGE7CiAgICAgICAgaWYgKHRoaXMuY2hhdFtpbmRleF0uYWxsX29yZGVyc19saXN0Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJUaGVyZSBhcmUgbm8gb3JkZXJzIHRvIGJlIGRpc3BsYXllZCI7CiAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3dfYWxsX29yZGVyc19saXN0ID0gZmFsc2U7CiAgICAgICAgfWVsc2UgewogICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9CiAgICAgICAgICAiUGxlYXNlIEZpbmQgQmVsb3cgWW91ciBMYXRlc3QgT3JkZXJzOiI7CiAgICAgICAgfQogICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZW50X29yZGVyc19saXN0ID0gY29tcGxldGVfb3JkZXJzX2RhdGE7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmNvbnZlcnNhdGlvbl9vbmx5ID0gdHJ1ZTsKICAgICAgICB9LCA1MDApOwogICAgICB9CiAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgfSwKICAgIHN1Ym1pdF9yZWZ1bmRfcmVxdWVzdChyZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzLCBpbmRleCkgewogICAgICBpZiAoCiAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX2xpc3QgPT09IG51bGwKICAgICAgKSB7CiAgICAgICAgdGhpcy5zaG93X3Nob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmRfZXJyb3IgPSB0cnVlOwogICAgICAgIHJldHVybgogICAgICB9IAogICAgICBpZiggICAgICAgIAogICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZF9saXN0ID09PSAnT3RoZXJzJwogICAgICApewogICAgICAgIGlmICh0aGlzLmNoYXRbaW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmQgPT09IG51bGwgfHwKICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZCA9PT0gIiIpCiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc2hvd19zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX2Vycm9yID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICB9CiAgICAgIH1lbHNlewogICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZCA9IHRoaXMuY2hhdFtpbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZF9saXN0OwogICAgICB9IAogICAgICAvLyBlbHNlIHsKICAgICAgICB0aGlzLnNob3dfc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZF9lcnJvciA9IGZhbHNlOwogICAgICAgIGxldCBpdGVtc190b19yZWZ1bmQgPSByZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzLmxpbmVfaXRlbXMuZmlsdGVyKChsaW5lSXRlbSkgPT4gewogICAgICAgICAgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gJ21hZ2VudG8nKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9zZWxlY3RlZF9pdGVtcy5pbmNsdWRlcyhsaW5lSXRlbS5wcm9kdWN0X2lkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9zZWxlY3RlZF9pdGVtcy5pbmNsdWRlcyhsaW5lSXRlbS5pZCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPGl0ZW1zX3RvX3JlZnVuZC5sZW5ndGg7IGkrKyl7CiAgICAgICAgICBpZihpdGVtc190b19yZWZ1bmRbaV0uc2VsZWN0ZWRfcXVhbnRpdHkgPT09IG51bGwgfHwKICAgICAgICAgICAgQm9vbGVhbihpdGVtc190b19yZWZ1bmRbaV0uc2VsZWN0ZWRfcXVhbnRpdHkpID09PSBmYWxzZSl7CiAgICAgICAgICAgICBzd2FsKHsKICAgICAgICAgICAgICB0ZXh0OiAiUGxlYXNlIGVudGVyIHRoZSBwcm9kdWN0IHF1YW50aXR5IGluIG51bWVyaWMgb25seSIsCiAgICAgICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICAgICAgcG9zaXRpb246ICJ0b3AtZW5kIiwKICAgICAgICAgICAgICB0eXBlOiAid2FybmluZyIsCiAgICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgICAgIHRpbWVyOiA1MDAwLAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZXQgcmVmdW5kX3BheWxvYWRfc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgb3JkZXJJZDogcmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlscy5pZCwKICAgICAgICAgIG9yZGVyX25hbWU6IHJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMubmFtZSwKICAgICAgICAgIGN1c3RvbWVyX2lkOiB0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQsCiAgICAgICAgICBmdWxmaWxsbWVudF9zdGF0dXM6IHJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMuZnVsZmlsbG1lbnRfc3RhdHVzLAogICAgICAgICAgcGF5bWVudF9zdGF0dXM6IHJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMucGF5bWVudF9zdGF0dXMsCiAgICAgICAgICBjdXJyZW5jeTogdGhpcy5yZXRhaWxfc2hvcF9jdXJyZW5jeSwKICAgICAgICAgIGxpbmVJdGVtczogaXRlbXNfdG9fcmVmdW5kLm1hcCgoaXRlbSkgPT4gewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGxpbmVfaXRlbV9pZDogdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAnbWFnZW50bycgPyBpdGVtLnByb2R1Y3RfaWQgOiBpdGVtLmlkLAogICAgICAgICAgICAgIHF1YW50aXR5OiBpdGVtLnNlbGVjdGVkX3F1YW50aXR5LAogICAgICAgICAgICAgIHByb2R1Y3RfaWQ6IGl0ZW0ucHJvZHVjdF9pZCwKICAgICAgICAgICAgICB2YXJpYW50X2lkOiBpdGVtLnZhcmlhbnRfaWQsCiAgICAgICAgICAgIH07CiAgICAgICAgICB9KSwKICAgICAgICAgIHJlZnVuZFJlYXNvbjogdGhpcy5jaGF0W2luZGV4XS5zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kLAogICAgICAgIH0pOwogICAgICAgIGxldCByZWZ1bmRfaW50ZW50ID0gYC9wcm9jZXNzX3JlZnVuZF9yZXF1ZXN0JHtyZWZ1bmRfcGF5bG9hZF9zdHJpbmd9YDsKICAgICAgICBsZXQgcmVmdW5kX29iamVjdCA9IHsKICAgICAgICAgIHRpdGxlOiAiUHJvY2VlZCIsCiAgICAgICAgICB2YWx1ZTogcmVmdW5kX2ludGVudCwKICAgICAgICB9OwogICAgICAgIC8vIGNvbnNvbGUubG9nKHJlZnVuZF9pbnRlbnQpOwogICAgICAgIHRoaXMuc2VuZF9tZXNzYWdlKCJpc19idXR0b24iLCByZWZ1bmRfb2JqZWN0KTsKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMgPSB7fTsKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9zZWxlY3RlZF9pdGVtcyA9IFtdOwogICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZF9saXN0ID0gbnVsbDsKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmQgPSBudWxsOwogICAgICAgIHRoaXMuY2hhdC5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAvLyB9CiAgICB9LAogICAgc2hvcGlmeV9mb3JtX2ZvY3VzKGluZGV4KSB7CiAgICAgIGlmICgKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID09PQogICAgICAgICJXZSBhcmUgc29ycnksIHlvdXIgY3JlZGVudGlhbHMgYXJlIGludmFsaWQuIFBsZWFzZSB0cnkgYWdhaW4gOikiCiAgICAgICkgewogICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPSAiUGxlYXNlIGxvZ2luIHdpdGggeW91ciBjcmVkZW50aWFscyBmb3IgYmV0dGVyIGV4cGVyaWVuY2UgOikiOwogICAgICB9CiAgICB9LAogICAgc2hvcGlmeV9jcmVhdGVfY3VzdG9tZXJfdG9rZW4oaW5kZXgsIGlzUmVmdW5kKSB7CiAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgIGlzUmVmdW5kID0gaXNSZWZ1bmQgfHwgZmFsc2U7CiAgICAgIGlmICh0aGlzLmNoYXRbaW5kZXhdLnJldHVybl9zaG9waWZ5X2VtYWlsID09PSB0cnVlICYmICFpc1JlZnVuZCkgewogICAgICAgIHRoaXMuc2VuZF9zaG9waWZ5X2N1c3RvbWVyX2lkKGluZGV4LCB0cnVlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbGV0IHNob3BfZW5kcG9pbnQgPSB0aGlzLnNob3BpZnlfcmV0YWlsX3Nob3BfbmFtZSArICIubXlzaG9waWZ5LmNvbSI7CiAgICAgIGxldCBxdWVyeVN0cmluZyA9ICQoIiNzaG9waWZ5X2xvZ2luX2Zvcm0iKS5zZXJpYWxpemVBcnJheSgpOwogICAgICBsZXQgZm9ybV9wYXlsb2FkID0ge307CiAgICAgIGZvcm1fcGF5bG9hZFsKICAgICAgICAic2hvcGlmeV9pc19vbmx5X2VtYWlsIgogICAgICBdID0gdGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQ7CiAgICAgIGZvcm1fcGF5bG9hZFsnZW1haWwnXSA9IHRoaXMuY2hhdFtpbmRleF0uY3VzdG9tZXJfZW1haWxfaWQ7CiAgICAgIGZvcm1fcGF5bG9hZFsncGFzc3dvcmQnXSA9IHRoaXMuY2hhdFtpbmRleF0uY3VzdG9tZXJfcGFzc3dvcmQ7CiAgICAgIC8vIGZvciAodmFyIGkgaW4gcXVlcnlTdHJpbmcpIHsKICAgICAgLy8gICBmb3JtX3BheWxvYWRbcXVlcnlTdHJpbmdbaV0ubmFtZV0gPSB0aGlzLmNoYXRbaW5kZXhdLmN1c3RvbWVyX2VtYWlsX2lkOwogICAgICAvLyB9CiAgICAgIGZvcm1fcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KGZvcm1fcGF5bG9hZCk7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgY2hhdDogYC9zaG9waWZ5X2NyZWF0ZV9jdXN0b21lcl90b2tlbiR7Zm9ybV9wYXlsb2FkfWAsCiAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICB9KQogICAgICAgIC50aGVuKCh7IGRhdGEgfSkgPT4gewogICAgICAgICAgLy8gY29uc29sZS5sb2coZGF0YSk7CiAgICAgICAgICAvLyBpZiAoQm9vbGVhbihkYXRhLnJlc3BvbnNlc1swXS5EYXRhLmFjY2Vzc1Rva2VuKSkgewogICAgICAgICAgLy8gICBsZXQgY3VzdG9tZXJUb2tlbiA9IGRhdGEucmVzcG9uc2VzWzBdLkRhdGEuYWNjZXNzVG9rZW47CiAgICAgICAgICAvLyAgIGxldCB0b2tlbkV4cGlyeSA9IGRhdGEucmVzcG9uc2VzWzBdLkRhdGEuZXhwaXJlc0F0OwogICAgICAgICAgLy8gICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIsIGN1c3RvbWVyVG9rZW4pOwogICAgICAgICAgLy8gICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbl9leHBpcnkiLCB0b2tlbkV4cGlyeSk7CiAgICAgICAgICAvLyAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMoY3VzdG9tZXJUb2tlbiwgaW5kZXgsIGlzUmVmdW5kKTsKICAgICAgICAgIC8vIH0gZWxzZSB7CiAgICAgICAgICAvLyAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPQogICAgICAgICAgLy8gICAgICJXZSBhcmUgc29ycnksIHlvdXIgY3JlZGVudGlhbHMgYXJlIGludmFsaWQuIFBsZWFzZSB0cnkgYWdhaW4gOikiOwogICAgICAgICAgLy8gfQogICAgICAgICAgaWYgKGRhdGEucmVzcG9uc2VzWzBdLnRva2VuX3R5cGUgPT09ICJjdXN0b21lcl90b2tlbiIpIHsKICAgICAgICAgICAgaWYgKEJvb2xlYW4oZGF0YS5yZXNwb25zZXNbMF0uRGF0YSkpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIpewogICAgICAgICAgICAgICAgbGV0IGN1c3RvbWVyVG9rZW4gPSBkYXRhLnJlc3BvbnNlc1swXS5EYXRhLmFjY2Vzc1Rva2VuOwogICAgICAgICAgICAgICAgbGV0IHRva2VuRXhwaXJ5ID0gZGF0YS5yZXNwb25zZXNbMF0uRGF0YS5leHBpcmVzQXQ7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIsIGN1c3RvbWVyVG9rZW4pOwogICAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW5fZXhwaXJ5IiwgdG9rZW5FeHBpcnkpOwogICAgICAgICAgICAgICAgdGhpcy5zaG9waWZ5X2ZldGNoX29yZGVycygKICAgICAgICAgICAgICAgICAgY3VzdG9tZXJUb2tlbiwKICAgICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAgIGlzUmVmdW5kLAogICAgICAgICAgICAgICAgICAic2hvcGlmeV9jdXN0b21lcl90b2tlbiIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIndvb2NvbW1lcmNlIil7CiAgICAgICAgICAgICAgICBsZXQgY3VzdG9tZXJUb2tlbiA9IGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbWVyX2RhdGEuY3VzdG9tZXJfZW1haWw7CiAgICAgICAgICAgICAgICBsZXQgdG9rZW5FeHBpcnkgPSBkYXRhLnJlc3BvbnNlc1swXS5EYXRhLmV4cGlyZXNBdDsKICAgICAgICAgICAgICAgIGxldCBjdXN0b21lcklkID0gZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfZGF0YS5jdXN0b21lcl9pZDsKICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IGN1c3RvbWVySWQ7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIsIGN1c3RvbWVyVG9rZW4pOwogICAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW5fZXhwaXJ5IiwgdG9rZW5FeHBpcnkpOwogICAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiLCBjdXN0b21lcklkKTsKICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMoCiAgICAgICAgICAgICAgICAgIGN1c3RvbWVyVG9rZW4sCiAgICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgICBpc1JlZnVuZCwKICAgICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0gZWxzZSBpZih0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJtYWdlbnRvIil7CiAgICAgICAgICAgICAgICBsZXQgY3VzdG9tZXJUb2tlbiA9IGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbWVyX2RhdGEuY3VzdG9tZXJfZW1haWw7CiAgICAgICAgICAgICAgICBsZXQgdG9rZW5FeHBpcnkgPSBkYXRhLnJlc3BvbnNlc1swXS5EYXRhLmV4cGlyZXNBdDsKICAgICAgICAgICAgICAgIGxldCBjdXN0b21lcklkID0gZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfZGF0YS5jdXN0b21lcl9pZDsKICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IGN1c3RvbWVySWQ7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIsIGN1c3RvbWVyVG9rZW4pOwogICAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW5fZXhwaXJ5IiwgdG9rZW5FeHBpcnkpOwogICAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiLCBjdXN0b21lcklkKTsKICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMoCiAgICAgICAgICAgICAgICAgIGN1c3RvbWVyVG9rZW4sCiAgICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgICBpc1JlZnVuZCwKICAgICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0KICAgICAgICAgICAgICAgICJXZSBhcmUgc29ycnksIHlvdXIgY3JlZGVudGlhbHMgYXJlIGludmFsaWQuIFBsZWFzZSB0cnkgYWdhaW4gOikiOwogICAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOyAgCiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YS5yZXNwb25zZXNbMF0udG9rZW5fdHlwZSA9PT0gImN1c3RvbWVyX2lkIikgewogICAgICAgICAgICAvLyBpZiAoQm9vbGVhbihkYXRhLnJlc3BvbnNlc1swXS5jdXN0b21lcl9pZCkpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIpewogICAgICAgICAgICAgICAgbGV0IGN1c3RvbWVySWQgPSBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b21lcl9pZDsKICAgICAgICAgICAgICAgIGxldCBjdXN0b21lckVtYWlsID0gZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfZW1haWw7CiAgICAgICAgICAgICAgICB0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQgPSBjdXN0b21lcklkOwogICAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiLCBjdXN0b21lcklkKTsKICAgICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIiwgY3VzdG9tZXJFbWFpbCk7CiAgICAgICAgICAgICAgICB0aGlzLnNob3BpZnlfZmV0Y2hfb3JkZXJzKAogICAgICAgICAgICAgICAgICBjdXN0b21lcklkLAogICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgaXNSZWZ1bmQsCiAgICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAid29vY29tbWVyY2UiKXsKICAgICAgICAgICAgICAgIGxldCBjdXN0b21lcklkID0gZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfaWQ7CiAgICAgICAgICAgICAgICBsZXQgY3VzdG9tZXJFbWFpbCA9IGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbWVyX2VtYWlsOwogICAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiLCBjdXN0b21lcklkKTsKICAgICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIiwgY3VzdG9tZXJFbWFpbCk7CiAgICAgICAgICAgICAgICB0aGlzLnNob3BpZnlfZmV0Y2hfb3JkZXJzKAogICAgICAgICAgICAgICAgICBjdXN0b21lcklkLAogICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgaXNSZWZ1bmQsCiAgICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAibWFnZW50byIpewogICAgICAgICAgICAgICAgbGV0IGN1c3RvbWVySWQgPSBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b21lcl9pZDsKICAgICAgICAgICAgICAgIGxldCBjdXN0b21lckVtYWlsID0gZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfZW1haWw7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl9pZCIsIGN1c3RvbWVySWQpOwogICAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iLCBjdXN0b21lckVtYWlsKTsKICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMoCiAgICAgICAgICAgICAgICAgIGN1c3RvbWVySWQsCiAgICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgICBpc1JlZnVuZCwKICAgICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfaWQiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gfSAKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9CiAgICAgICAgICAgICAgICAiV2UgYXJlIHNvcnJ5LCBjb3VsZCBub3QgZmluZCBhbnkgcmVjb3JkcyB3aXRoIHRoaXMgZW1haWwuIFBsZWFzZSB0cnkgYWdhaW4gOikiOwogICAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0KICAgICAgICAgICAgICAiV2UgYXJlIHNvcnJ5LCB5b3VyIGNyZWRlbnRpYWxzIGFyZSBpbnZhbGlkLiBQbGVhc2UgdHJ5IGFnYWluIDopIjsKICAgICAgICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICAvLyB0aGlzLmNoYXQuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9KTsKICAgIH0sCiAgICBzaG9waWZ5X2ZldGNoX2N1c3RvbWVyX2lkKGN1c3RvbWVyQWNjZXNzVG9rZW4sIGluZGV4LCB0b2tlbl90eXBlKSB7CiAgICAgIGxldCBzaG9wX2VuZHBvaW50ID0gdGhpcy5zaG9waWZ5X3JldGFpbF9zaG9wX25hbWUgKyAiLm15c2hvcGlmeS5jb20iOwogICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICBpZiAoIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QpKSB7CiAgICAgICAgaWYgKHRva2VuX3R5cGUgPT09ICJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIikgewogICAgICAgICAgbGV0IHN0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgIGN1c3RvbWVyX2FjY2Vzc190b2tlbjogY3VzdG9tZXJBY2Nlc3NUb2tlbiwgLy9zaG9waWZ5IGFjY2VzcyB0b2tlbiA9PSBlbWFpbCBmb3Igd29vY29tbWVyY2UKICAgICAgICAgIH0pOwogICAgICAgICAgYXhpb3MKICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgICBjaGF0OiBgL3Nob3BpZnlfZ2V0X2N1c3RvbWVyX2lkX2FuZF9vcmRlcnMke3N0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWR9YCwKICAgICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgICB9KQogICAgICAgICAgICAudGhlbigoeyBkYXRhIH0pID0+IHsKICAgICAgICAgICAgICBpZiAoQm9vbGVhbihkYXRhLnJlc3BvbnNlc1swXS5jdXN0b20pKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRfY3VzdG9tZXJfb3JkZXJzKAogICAgICAgICAgICAgICAgICBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b20ub3JkZXJzX2xpc3QsCiAgICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgICAicmVmdW5kIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIC8vIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbS5jdXN0b21lcl9pZDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9CiAgICAgICAgICAgICAgICAgICJTb21lIEVycm9yIE9jY3VycmVkLiBQbGVhc2UgVHJ5IEFnYWluIjsKICAgICAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyAgIGxldCBjdXN0b21lcklkID0gYXRvYihkYXRhLmRhdGEuY3VzdG9tZXIuaWQpOwogICAgICAgICAgICAgIC8vICAgdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkID0gY3VzdG9tZXJJZC5zbGljZSgKICAgICAgICAgICAgICAvLyAgICAgY3VzdG9tZXJJZC5sYXN0SW5kZXhPZigiLyIpICsgMQogICAgICAgICAgICAgIC8vICAgKTsKICAgICAgICAgICAgICAvLyAgIGxldCBzdHJpbmdpZmllZF9jdXN0b21lcl9wYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgIC8vICAgICBjdXN0b21lcklkOiB0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQsCiAgICAgICAgICAgICAgLy8gICB9KTsKICAgICAgICAgICAgICAvLyAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPSAiRmV0Y2hpbmcgeW91ciBvcmRlciBkZXRhaWxzIC4uLiI7CiAgICAgICAgICAgICAgLy8gICBheGlvcwogICAgICAgICAgICAgIC8vICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICAgICAgLy8gICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgICAvLyAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgLy8gICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAvLyAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICAgIC8vICAgICAgIGNoYXQ6IGAvcmV0cmlldmVfY3VzdG9tZXJfb3JkZXJzJHtzdHJpbmdpZmllZF9jdXN0b21lcl9wYXlsb2FkfWAsCiAgICAgICAgICAgICAgLy8gICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgIC8vICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgICAgIC8vICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICAgICAgICAvLyAgICAgfSkKICAgICAgICAgICAgICAvLyAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgLy8gICAgICAgdGhpcy5sb2FkX2N1c3RvbWVyX29yZGVycygKICAgICAgICAgICAgICAvLyAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbS5vcmRlcnNfbGlzdCwKICAgICAgICAgICAgICAvLyAgICAgICAgIGluZGV4CiAgICAgICAgICAgICAgLy8gICAgICAgKTsKICAgICAgICAgICAgICAvLyAgICAgfSkKICAgICAgICAgICAgICAvLyAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICAgICAgLy8gICAgICAgY29uc29sZS5sb2coZSk7CiAgICAgICAgICAgICAgLy8gICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgICAgIC8vICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmICh0b2tlbl90eXBlID09ICJzaG9waWZ5X2N1c3RvbWVyX2lkIikgewogICAgICAgICAgbGV0IHN0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgIGN1c3RvbWVySWQ6IHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCwKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJGZXRjaGluZyB5b3VyIG9yZGVyIGRldGFpbHMgLi4uIjsKICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgICAgY2hhdDogYC9yZXRyaWV2ZV9jdXN0b21lcl9vcmRlcnMke3N0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWR9YCwKICAgICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgICB9KQogICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICB0aGlzLmxvYWRfY3VzdG9tZXJfb3JkZXJzKAogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tLm9yZGVyc19saXN0LAogICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAicmVmdW5kIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgc2hvcGlmeV9mZXRjaF9vcmRlcnMoY3VzdG9tZXJBY2Nlc3NUb2tlbiwgaW5kZXgsIGlzUmVmdW5kLCB0b2tlbl90eXBlKSB7CiAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgIGlzUmVmdW5kID0gaXNSZWZ1bmQgfHwgZmFsc2U7CiAgICAgIHRoaXMuY2hhdFtpbmRleF0uY29udmVyc2F0aW9uX29ubHkgPSBmYWxzZTsKICAgICAgbGV0IHNob3BfZW5kcG9pbnQgPSB0aGlzLnNob3BpZnlfcmV0YWlsX3Nob3BfbmFtZSArICIubXlzaG9waWZ5LmNvbSI7CiAgICAgIGlmICh0b2tlbl90eXBlID09PSAic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpIHsKICAgICAgICBsZXQgc3RyaW5naWZpZWRfY3VzdG9tZXJfcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIGN1c3RvbWVyX2FjY2Vzc190b2tlbjogY3VzdG9tZXJBY2Nlc3NUb2tlbiwgLy93b29jb21tZXJjZSBjdXN0b21lciBlbWFpbAogICAgICAgIH0pOwogICAgICAgIGF4aW9zCiAgICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgY2hhdDogYC9zaG9waWZ5X2dldF9jdXN0b21lcl9vcmRlcnMke3N0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWR9YCwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKCh7IGRhdGEgfSkgPT4gewogICAgICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBsZXQgY3VzdG9tZXJJZCA9IGF0b2IoZGF0YS5yZXNwb25zZXNbMF0uZGF0YS5jdXN0b21lci5pZCk7CiAgICAgICAgICAgICAgdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkID0gY3VzdG9tZXJJZC5zbGljZSgKICAgICAgICAgICAgICAgIGN1c3RvbWVySWQubGFzdEluZGV4T2YoIi8iKSArIDEKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIiwgdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJzaG9waWZ5Iil7CiAgICAgICAgICAgICAgbGV0IG9yZGVyc0RhdGEgPSBkYXRhLnJlc3BvbnNlc1swXS5kYXRhLmN1c3RvbWVyLm9yZGVycy5lZGdlczsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluZGV4ID09ICJudW1iZXIiICYmIG9yZGVyc0RhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgLy8gb3JkZXJzRGF0YSA9IG9yZGVyc0RhdGFbMF0ubm9kZTsKICAgICAgICAgICAgICAgIC8vIGxldCBvcmRlck5hbWUgPSBvcmRlcnNEYXRhLm5hbWU7CiAgICAgICAgICAgICAgICAvLyBsZXQgb3JkZXJTdGF0dXNVcmwgPSBvcmRlcnNEYXRhLnN0YXR1c1VybDsKICAgICAgICAgICAgICAgIC8vIGxldCBvcmRlclByb2Nlc3NpbmdEYXRlID0gbW9tZW50KG9yZGVyc0RhdGEucHJvY2Vzc2VkQXQsIFsKICAgICAgICAgICAgICAgIC8vICAgIllZWVktTU0tRERUaGg6bW06c3NaIiwKICAgICAgICAgICAgICAgIC8vIF0pLmZvcm1hdCgiRG8gTU1NIFlZWVkiKTsKICAgICAgICAgICAgICAgIGlmIChpc1JlZnVuZCkgewogICAgICAgICAgICAgICAgICB0aGlzLnNob3BpZnlfZmV0Y2hfY3VzdG9tZXJfaWQoCiAgICAgICAgICAgICAgICAgICAgY3VzdG9tZXJBY2Nlc3NUb2tlbiwKICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAic2hvcGlmeV9jdXN0b21lcl90b2tlbiIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAvLyAgIGxldCBvcmRlckZ1bGZpbGxtZW50U3RhdHVzID0gb3JkZXJzRGF0YS5mdWxmaWxsbWVudFN0YXR1cy5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAvLyAgICAgIl8iLAogICAgICAgICAgICAgICAgICAvLyAgICAgIiAiCiAgICAgICAgICAgICAgICAgIC8vICAgKTsKICAgICAgICAgICAgICAgICAgLy8gICBsZXQgc3VjY2Vzc2Z1bE9yZGVyRnVsZmlsbG1lbnRzID0KICAgICAgICAgICAgICAgICAgLy8gICAgIG9yZGVyc0RhdGEuc3VjY2Vzc2Z1bEZ1bGZpbGxtZW50czsKICAgICAgICAgICAgICAgICAgLy8gICAvLyBTZXQgb25seSBmaXJzdCBjaGFyYWN0ZXIgdG8gdXBwZXJjYXNlIHdoaWxlIHJlbWFpbmluZyBjaGFyYWN0ZXJzIHNldCB0byBsb3dlcmNhc2UKICAgICAgICAgICAgICAgICAgLy8gICBvcmRlckZ1bGZpbGxtZW50U3RhdHVzID0KICAgICAgICAgICAgICAgICAgLy8gICAgIG9yZGVyRnVsZmlsbG1lbnRTdGF0dXMuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKwogICAgICAgICAgICAgICAgICAvLyAgICAgb3JkZXJGdWxmaWxsbWVudFN0YXR1cy5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgICAgLy8gICBsZXQgb3JkZXJEZXRhaWxzTXNnID0gYEhlcmUncyB0aGUgc3RhdHVzIG9mIHlvdXIgcmVjZW50IG9yZGVyOjxicj4KICAgICAgICAgICAgICAgICAgLy8gT3JkZXIgLSA8YSBocmVmPSIke29yZGVyU3RhdHVzVXJsfSIgdGFyZ2V0PSJfYmxhbmsiPiMke29yZGVyTmFtZX08L2E+PGJyPgogICAgICAgICAgICAgICAgICAvLyBPcmRlciBQcm9jZXNzZWQgT246ICR7b3JkZXJQcm9jZXNzaW5nRGF0ZX08YnI+CiAgICAgICAgICAgICAgICAgIC8vIEZ1bGZpbGxtZW50IFN0YXR1czogJHtvcmRlckZ1bGZpbGxtZW50U3RhdHVzfTxicj5gOwogICAgICAgICAgICAgICAgICAvLyAgIGlmIChvcmRlckZ1bGZpbGxtZW50U3RhdHVzID09ICJGVUxGSUxMRUQiKSB7CiAgICAgICAgICAgICAgICAgIC8vICAgICBzdWNjZXNzZnVsT3JkZXJGdWxmaWxsbWVudHMgPSBzdWNjZXNzZnVsT3JkZXJGdWxmaWxsbWVudHNbMF07CiAgICAgICAgICAgICAgICAgIC8vICAgICBvcmRlckRldGFpbHNNc2cgKz0gYFlvdSBjYW4gdHJhY2sgeW91ciBvcmRlciBoZXJlPGEgaHJlZj0iJHtzdWNjZXNzZnVsT3JkZXJGdWxmaWxsbWVudHMudHJhY2tpbmdJbmZvLnVybH0iIGRhdGEtY29weS1jb250ZW50PSIke3N1Y2Nlc3NmdWxPcmRlckZ1bGZpbGxtZW50cy50cmFja2luZ0luZm8ubnVtYmVyfSI+CiAgICAgICAgICAgICAgICAgIC8vICAgJHtzdWNjZXNzZnVsT3JkZXJGdWxmaWxsbWVudHMudHJhY2tpbmdJbmZvLm51bWJlcn08L2E+PGkgY2xhc3M9ImZhIGZhLWNsaXBib2FyZCBtbC0yIiBhcmlhLWhpZGRlbj0idHJ1ZSIgZGF0YS1jb3B5LWNvbnRlbnQ9IiR7c3VjY2Vzc2Z1bE9yZGVyRnVsZmlsbG1lbnRzLnRyYWNraW5nSW5mby5udW1iZXJ9Ij48L2k+PGJyPmA7CiAgICAgICAgICAgICAgICAgIC8vICAgfQogICAgICAgICAgICAgICAgICAvLyAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPSBvcmRlckRldGFpbHNNc2c7CiAgICAgICAgICAgICAgICAgIGxldCBvcmRlcnNfZGF0YSA9IGRhdGEucmVzcG9uc2VzWzBdLmRhdGEuY3VzdG9tZXIub3JkZXJzLmVkZ2VzLAogICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlX29yZGVyc19kYXRhID0gW107CiAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3JkZXJzX2RhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY3VyX25vZGUgPSBvcmRlcnNfZGF0YVtpXS5ub2RlOwogICAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLnByb2Nlc3NlZEF0ID0gbW9tZW50KGN1cl9ub2RlLnByb2Nlc3NlZEF0LCBbCiAgICAgICAgICAgICAgICAgICAgICAiWVlZWS1NTS1ERFRoaDptbTpzc1oiLAogICAgICAgICAgICAgICAgICAgIF0pLmZvcm1hdCgiRG8gTU1NIFlZWVkiKTsKICAgICAgICAgICAgICAgICAgICBjdXJfbm9kZS5mdWxmaWxsbWVudFN0YXR1cyA9IGN1cl9ub2RlLmZ1bGZpbGxtZW50U3RhdHVzLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAgICAgICAiXyIsCiAgICAgICAgICAgICAgICAgICAgICAiICIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIC8vIFNldCBvbmx5IGZpcnN0IGNoYXJhY3RlciB0byB1cHBlcmNhc2Ugd2hpbGUgcmVtYWluaW5nIGNoYXJhY3RlcnMgc2V0IHRvIGxvd2VyY2FzZQogICAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50U3RhdHVzID0KICAgICAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50U3RhdHVzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsKICAgICAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50U3RhdHVzLnNsaWNlKDEpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgY29tcGxldGVfb3JkZXJzX2RhdGEucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBjdXJfbm9kZS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkX2RhdGU6IGN1cl9ub2RlLnByb2Nlc3NlZEF0LAogICAgICAgICAgICAgICAgICAgICAgZnVsZmlsbG1lbnRfc3RhdHVzOiBjdXJfbm9kZS5mdWxmaWxsbWVudFN0YXR1cywKICAgICAgICAgICAgICAgICAgICAgIHN0YXR1c191cmw6IGN1cl9ub2RlLnN0YXR1c1VybCwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3dfYWxsX29yZGVyc19saXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5hbGxfb3JkZXJzX2xpc3QgPSBjb21wbGV0ZV9vcmRlcnNfZGF0YTsKICAgICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9CiAgICAgICAgICAgICAgICAgICAgIlBsZWFzZSBGaW5kIEJlbG93IFlvdXIgTGF0ZXN0IE9yZGVyczoiOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VudF9vcmRlcnNfbGlzdCA9CiAgICAgICAgICAgICAgICAgICAgZGF0YS5yZXNwb25zZXNbMF0uZGF0YS5jdXN0b21lci5vcmRlcnMuZWRnZXM7CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uY29udmVyc2F0aW9uX29ubHkgPSB0cnVlOwogICAgICAgICAgICAgIH0sIDUwMCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAid29vY29tbWVyY2UiKXsKICAgICAgICAgICAgICBpZiAoaXNSZWZ1bmQpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkX2N1c3RvbWVyX29yZGVycygKICAgICAgICAgICAgICAgICAgICBkYXRhLnJlc3BvbnNlc1swXS5kYXRhLmN1c3RvbWVyLm9yZGVycywKICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICBpc1JlZnVuZCA/ICJyZWZ1bmQiIDogImFsbF9vcmRlcnMiCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICAgICAgbGV0IG9yZGVyc19kYXRhID0gZGF0YS5yZXNwb25zZXNbMF0uZGF0YS5jdXN0b21lci5vcmRlcnMsCiAgICAgICAgICAgICAgICBjb21wbGV0ZV9vcmRlcnNfZGF0YSA9IFtdOwogICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3JkZXJzX2RhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjdXJfbm9kZSA9IG9yZGVyc19kYXRhW2ldOwogICAgICAgICAgICAgICAgY3VyX25vZGUucHJvY2Vzc2VkQXQgPSBtb21lbnQoY3VyX25vZGUuY3JlYXRlZF9hdCwgWwogICAgICAgICAgICAgICAgICAiWVlZWS1NTS1ERFRoaDptbTpzc1oiLAogICAgICAgICAgICAgICAgXSkuZm9ybWF0KCJEbyBNTU0gWVlZWSIpOwogICAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzID0KICAgICAgICAgICAgICAgIEJvb2xlYW4oY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzKSA9PT0gdHJ1ZQogICAgICAgICAgICAgICAgICA/IGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cwogICAgICAgICAgICAgICAgICA6ICJVbmZ1bGZpbGxlZCI7CiAgICAgICAgICAgICAgICAvLyBTZXQgb25seSBmaXJzdCBjaGFyYWN0ZXIgdG8gdXBwZXJjYXNlIHdoaWxlIHJlbWFpbmluZyBjaGFyYWN0ZXJzIHNldCB0byBsb3dlcmNhc2UKICAgICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cyA9CiAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArCiAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cy5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjdXJfbm9kZS5vcmRlcl9ub3Rlcy5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLm9yZGVyX25vdGVzW2ldLmRhdGVfY3JlYXRlZCA9IG1vbWVudChjdXJfbm9kZS5vcmRlcl9ub3Rlc1tpXS5kYXRlX2NyZWF0ZWQsIFsKICAgICAgICAgICAgICAgICJZWVlZLU1NLUREVGhoOm1tOnNzWiIsCiAgICAgICAgICAgICAgICBdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIEhIOm1tIGEiKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29tcGxldGVfb3JkZXJzX2RhdGEucHVzaCh7CiAgICAgICAgICAgICAgICAgIG5hbWU6IGN1cl9ub2RlLmlkLAogICAgICAgICAgICAgICAgICBwcm9jZXNzZWRfZGF0ZTogY3VyX25vZGUucHJvY2Vzc2VkQXQsCiAgICAgICAgICAgICAgICAgIGZ1bGZpbGxtZW50X3N0YXR1czogY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzLAogICAgICAgICAgICAgICAgICBzdGF0dXNfdXJsOiBjdXJfbm9kZS5vcmRlcl9zdGF0dXNfdXJsLAogICAgICAgICAgICAgICAgICBvcmRlcl9ub3RlczogY3VyX25vZGUub3JkZXJfbm90ZXMKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3dfYWxsX29yZGVyc19saXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmFsbF9vcmRlcnNfbGlzdCA9IGNvbXBsZXRlX29yZGVyc19kYXRhOwogICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPQogICAgICAgICAgICAgICAgIlBsZWFzZSBGaW5kIEJlbG93IFlvdXIgTGF0ZXN0IE9yZGVyczoiOwogICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvd19hbGxfb3JkZXJzX2xpc3QgPSB0cnVlOwogICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZW50X29yZGVyc19saXN0ID0gY29tcGxldGVfb3JkZXJzX2RhdGE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmNvbnZlcnNhdGlvbl9vbmx5ID0gdHJ1ZTsKICAgICAgICAgICAgICB9LCA1MDApOwogICAgICAgICAgICB9IGVsc2UgaWYodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAibWFnZW50byIpewogICAgICAgICAgICAgIGlmIChpc1JlZnVuZCkgewogICAgICAgICAgICAgICAgICB0aGlzLmxvYWRfY3VzdG9tZXJfb3JkZXJzKAogICAgICAgICAgICAgICAgICAgIGRhdGEucmVzcG9uc2VzWzBdLmRhdGEuY3VzdG9tZXIub3JkZXJzLAogICAgICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgICAgIGlzUmVmdW5kID8gInJlZnVuZCIgOiAiYWxsX29yZGVycyIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICAgICAgICBsZXQgb3JkZXJzX2RhdGEgPSBkYXRhLnJlc3BvbnNlc1swXS5kYXRhLmN1c3RvbWVyLm9yZGVycywKICAgICAgICAgICAgICAgIGNvbXBsZXRlX29yZGVyc19kYXRhID0gW107CiAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcmRlcnNfZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGN1cl9ub2RlID0gb3JkZXJzX2RhdGFbaV07CiAgICAgICAgICAgICAgICBjdXJfbm9kZS5wcm9jZXNzZWRBdCA9IG1vbWVudChjdXJfbm9kZS5jcmVhdGVkX2F0LCBbCiAgICAgICAgICAgICAgICAgICJZWVlZLU1NLUREVGhoOm1tOnNzWiIsCiAgICAgICAgICAgICAgICBdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIik7CiAgICAgICAgICAgICAgICBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMgPQogICAgICAgICAgICAgICAgQm9vbGVhbihjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMpID09PSB0cnVlCiAgICAgICAgICAgICAgICAgID8gY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzCiAgICAgICAgICAgICAgICAgIDogIlVuZnVsZmlsbGVkIjsKICAgICAgICAgICAgICAgIC8vIFNldCBvbmx5IGZpcnN0IGNoYXJhY3RlciB0byB1cHBlcmNhc2Ugd2hpbGUgcmVtYWluaW5nIGNoYXJhY3RlcnMgc2V0IHRvIGxvd2VyY2FzZQogICAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzID0KICAgICAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsKICAgICAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzLnNsaWNlKDEpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1cl9ub2RlLm9yZGVyX25vdGVzLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgY3VyX25vZGUub3JkZXJfbm90ZXNbaV0uZGF0ZV9jcmVhdGVkID0gbW9tZW50KGN1cl9ub2RlLm9yZGVyX25vdGVzW2ldLmRhdGVfY3JlYXRlZCwgWwogICAgICAgICAgICAgICAgIllZWVktTU0tRERUaGg6bW06c3NaIiwKICAgICAgICAgICAgICAgIF0pLmZvcm1hdCgiRG8gTU1NIFlZWVkgSEg6bW0gYSIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb21wbGV0ZV9vcmRlcnNfZGF0YS5wdXNoKHsKICAgICAgICAgICAgICAgICAgbmFtZTogY3VyX25vZGUuaWQsCiAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZF9kYXRlOiBjdXJfbm9kZS5wcm9jZXNzZWRBdCwKICAgICAgICAgICAgICAgICAgZnVsZmlsbG1lbnRfc3RhdHVzOiBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMsCiAgICAgICAgICAgICAgICAgIHN0YXR1c191cmw6IGN1cl9ub2RlLm9yZGVyX3N0YXR1c191cmwsCiAgICAgICAgICAgICAgICAgIG9yZGVyX25vdGVzOiBjdXJfbm9kZS5vcmRlcl9ub3RlcwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvd19hbGxfb3JkZXJzX2xpc3QgPSB0cnVlOwogICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uYWxsX29yZGVyc19saXN0ID0gY29tcGxldGVfb3JkZXJzX2RhdGE7CiAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9CiAgICAgICAgICAgICAgICAiUGxlYXNlIEZpbmQgQmVsb3cgWW91ciBMYXRlc3QgT3JkZXJzOiI7CiAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5zaG93X2FsbF9vcmRlcnNfbGlzdCA9IHRydWU7CiAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlbnRfb3JkZXJzX2xpc3QgPSBjb21wbGV0ZV9vcmRlcnNfZGF0YTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uY29udmVyc2F0aW9uX29ubHkgPSB0cnVlOwogICAgICAgICAgICAgIH0sIDUwMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHRva2VuX3R5cGUgPT09ICJzaG9waWZ5X2N1c3RvbWVyX2lkIikgewogICAgICAgIGlmKEJvb2xlYW4odGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkKSA9PT0gZmFsc2UpewogICAgICAgICAgdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNob3BpZnlfY3VzdG9tZXJfZW1haWwgPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpOwogICAgICAgIGxldCBzdHJpbmdpZmllZF9jdXN0b21lcl9wYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgY3VzdG9tZXJJZDogdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkLAogICAgICAgICAgZW1haWw6IHNob3BpZnlfY3VzdG9tZXJfZW1haWwKICAgICAgICB9KTsKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gIkZldGNoaW5nIHlvdXIgb3JkZXIgZGV0YWlscyAuLi4iOwogICAgICAgIGF4aW9zCiAgICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgY2hhdDogYC9yZXRyaWV2ZV9jdXN0b21lcl9vcmRlcnMke3N0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWR9YCwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tLm9yZGVyc19saXN0Lmxlbmd0aCA9PSAwICYmIHRoaXMucmV0YWlsX29yZGVyX3JldHJlaXZhbF9vbmx5X2VtYWlsX3JlcXVpcmVkKXsKICAgICAgICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmNvbnZlcnNhdGlvbl9vbmx5ID0gdHJ1ZTsKICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gIlRoZXJlIGFyZSBubyBvcmRlcnMgdG8gYmUgZGlzcGxheWVkIGZvciB0aGUgZ2l2ZW4gRW1haWwgb3IgUGhvbmUgbnVtYmVyIjsKICAgICAgICAgICAgICB0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQgPSBudWxsOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICB0aGlzLmxvYWRfY3VzdG9tZXJfb3JkZXJzKAogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbS5vcmRlcnNfbGlzdCwKICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICBpc1JlZnVuZCA/ICJyZWZ1bmQiIDogImFsbF9vcmRlcnMiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIHNob3BpZnlfaXNfdG9rZW5fdmFsaWQoaW5kZXgsIGlzUmVmdW5kKSB7CiAgICAgIGlzUmVmdW5kID0gaXNSZWZ1bmQgfHwgZmFsc2U7CiAgICAgIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJzaG9waWZ5Iil7CiAgICAgICAgaWYgKAogICAgICAgICh0aGlzLmNoYXRbaW5kZXhdLmZldGNoX3Nob3BpZnlfZGV0YWlscyAmJgogICAgICAgICAgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5pc19yZWZ1bmQpICYmCiAgICAgICAgICAhQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJlY2VudF9vcmRlcnNfbGlzdCkpIHx8CiAgICAgICAgKHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzICYmCiAgICAgICAgICBCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSAmJgogICAgICAgICAgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QpKSB8fAogICAgICAgICh0aGlzLmNoYXRbaW5kZXhdLmZldGNoX3Nob3BpZnlfZGV0YWlscyAmJgogICAgICAgICAgQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJldHVybl9zaG9waWZ5X2VtYWlsKSkKICAgICAgICApIHsKICAgICAgICAgIGlmICh0aGlzLnJldGFpbF9vcmRlcl9yZXRyZWl2YWxfb25seV9lbWFpbF9yZXF1aXJlZCkgewogICAgICAgICAgICBpZiAoQm9vbGVhbih0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQpKSB7CiAgICAgICAgICAgICAgbGV0IGN1c3RvbWVyVG9rZW4gPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpOwogICAgICAgICAgICAgIGlmICh0aGlzLmNoYXRbaW5kZXhdLmlzX3JlZnVuZCkgewogICAgICAgICAgICAgICAgdGhpcy5zaG9waWZ5X2ZldGNoX2N1c3RvbWVyX2lkKAogICAgICAgICAgICAgICAgICBjdXN0b21lclRva2VuLAogICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfaWQiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmNoYXRbaW5kZXhdLnJldHVybl9zaG9waWZ5X2VtYWlsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlbmRfc2hvcGlmeV9jdXN0b21lcl9pZChpbmRleCwgZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMoCiAgICAgICAgICAgICAgICAgIGN1c3RvbWVyVG9rZW4sCiAgICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgICBpc1JlZnVuZCwKICAgICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfaWQiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZXQgc2hvcGlmeV9zdG9yZV9jaWQgPSB0aGlzLmdldF9zaG9waWZ5X3N0b3JlX3dpbmRvd19jdXN0b21lcl9pZCgpOwogICAgICAgICAgICBpZiAoQm9vbGVhbihzaG9waWZ5X3N0b3JlX2NpZCkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIGxldCBjdXRvZmYgPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbl9leHBpcnkiKTsKICAgICAgICAgICAgICAvLyBjdXRvZmYgPSBtb21lbnQoY3V0b2ZmLCBbIllZWVktTU0tRERUaGg6bW06c3NaIl0pOwogICAgICAgICAgICAgIC8vIGlmIChtb21lbnQoKS5pc0JlZm9yZShjdXRvZmYpKSB7CgoKICAgICAgICAgICAgICAgIC8vIGxldCBzaG9waWZ5X3N0b3JlX2NpZCA9IHRoaXMuZ2V0X3Nob3BpZnlfc3RvcmVfd2luZG93X2N1c3RvbWVyX2lkKCk7CiAgICAgICAgICAgICAgICAvLyBsZXQgc2hvcGlmeV9zdG9yZV9jaWQgPSA1MzAyMDAxODkzNDQ3OyAvL2hhcmRjb2RlZDogcmVtb3ZlIGFmdGVyIHRlc3RpbmcKICAgICAgICAgICAgICAgIGlmKHNob3BpZnlfc3RvcmVfY2lkID09PSBudWxsIHx8IHNob3BpZnlfc3RvcmVfY2lkID09IHVuZGVmaW5lZCB8fCBzaG9waWZ5X3N0b3JlX2NpZCA9PSAiIil7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IHNob3BpZnlfc3RvcmVfY2lkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGV0IGN1c3RvbWVyVG9rZW4gPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9jdXN0b21lcl9pZCgKICAgICAgICAgICAgICAgICAgICBjdXN0b21lclRva2VuLAogICAgICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jaGF0W2luZGV4XS5yZXR1cm5fc2hvcGlmeV9lbWFpbCkgewogICAgICAgICAgICAgICAgICB0aGlzLnNlbmRfc2hvcGlmeV9jdXN0b21lcl9pZChpbmRleCwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMoCiAgICAgICAgICAgICAgICAgICAgY3VzdG9tZXJUb2tlbiwKICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICBpc1JlZnVuZCwKICAgICAgICAgICAgICAgICAgICAic2hvcGlmeV9jdXN0b21lcl9pZCIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIC8vIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgLy8gfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIndvb2NvbW1lcmNlIil7CiAgICAgICAgaWYgKAogICAgICAgICh0aGlzLmNoYXRbaW5kZXhdLmZldGNoX3Nob3BpZnlfZGV0YWlscyAmJgogICAgICAgICAgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5pc19yZWZ1bmQpICYmCiAgICAgICAgICAhQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJlY2VudF9vcmRlcnNfbGlzdCkpIHx8CiAgICAgICAgKHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzICYmCiAgICAgICAgICBCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSAmJgogICAgICAgICAgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QpKSB8fAogICAgICAgICh0aGlzLmNoYXRbaW5kZXhdLmZldGNoX3Nob3BpZnlfZGV0YWlscyAmJgogICAgICAgICAgQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJldHVybl9zaG9waWZ5X2VtYWlsKSkKICAgICAgICApIHsKICAgICAgICBpZiAodGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQpIHsKICAgICAgICAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IHRoaXMuJHNlc3Npb24uZ2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CiAgICAgICAgICBpZiAoQm9vbGVhbih0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQpKSB7CiAgICAgICAgICAgICAgbGV0IGN1c3RvbWVyVG9rZW4gPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl9pZCIpOwogICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMoCiAgICAgICAgICAgICAgICAgICAgICBjdXN0b21lclRva2VuLAogICAgICAgICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICBpc1JlZnVuZCwKICAgICAgICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWUgCiAgICAgICAgICB9ZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9ZWxzZSB7CiAgICAgICAgICBsZXQgd29vY29tbWVyY2Vfc3RvcmVfbG9naW5fZGV0YWlsID0gdGhpcy5nZXRfd29vY29tbWVyY2Vfc3RvcmVfd2luZG93X2N1c3RvbWVyX2VtYWlsKCk7CiAgICAgICAgICAgIGlmIChCb29sZWFuKHdvb2NvbW1lcmNlX3N0b3JlX2xvZ2luX2RldGFpbCkgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl9pZCIsIHdvb2NvbW1lcmNlX3N0b3JlX2xvZ2luX2RldGFpbFswXSk7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIsIHdvb2NvbW1lcmNlX3N0b3JlX2xvZ2luX2RldGFpbFsxXSkKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXRbaW5kZXhdLmlzX3JlZnVuZCkgewogICAgICAgICAgICAgICAgICB0aGlzLnNob3BpZnlfZmV0Y2hfY3VzdG9tZXJfaWQod29vY29tbWVyY2Vfc3RvcmVfbG9naW5fZGV0YWlsWzBdLCBpbmRleCwgInNob3BpZnlfY3VzdG9tZXJfaWQiKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMod29vY29tbWVyY2Vfc3RvcmVfbG9naW5fZGV0YWlsWzBdLCBpbmRleCwgaXNSZWZ1bmQsICJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgLy8gaWYgKCF0aGlzLiRzZXNzaW9uLmhhcygic2hvcGlmeV9jdXN0b21lcl90b2tlbl9leHBpcnkiKSkgewogICAgICAgICAgLy8gICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIC8vICAgfSBlbHNlIHsKICAgICAgICAgIC8vICAgICBsZXQgY3V0b2ZmID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW5fZXhwaXJ5Iik7CiAgICAgICAgICAvLyAgICAgY3V0b2ZmID0gbW9tZW50KGN1dG9mZiwgWyJZWVlZLU1NLUREVGhoOm1tOnNzWiJdKTsKICAgICAgICAgIC8vICAgICBsZXQgY3VycmVudF90aW1lID0gbmV3IERhdGUoY3V0b2ZmKTsKICAgICAgICAgIC8vICAgICBpZiAobW9tZW50KCkuaXNCZWZvcmUoY3VycmVudF90aW1lKSkgewogICAgICAgICAgLy8gICAgICAgbGV0IGN1c3RvbWVyVG9rZW4gPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIpOwogICAgICAgICAgLy8gICAgICAgdGhpcy5zaG9waWZ5X2ZldGNoX29yZGVycygKICAgICAgICAgIC8vICAgICAgICAgICBjdXN0b21lclRva2VuLAogICAgICAgICAgLy8gICAgICAgICAgIGluZGV4LAogICAgICAgICAgLy8gICAgICAgICAgIGlzUmVmdW5kLAogICAgICAgICAgLy8gICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIgogICAgICAgICAgLy8gICAgICAgICApOwogICAgICAgICAgLy8gICAgICAgcmV0dXJuIHRydWU7ICAgICAgICAgICAgCiAgICAgICAgICAvLyAgICAgfWVsc2UgewogICAgICAgICAgLy8gICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgLy8gICAgIH0KICAgICAgICAgIC8vICAgfQogICAgICAgIH0KICAgICAgICB9ZWxzZSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZih0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJtYWdlbnRvIil7CiAgICAgICAgaWYgKAogICAgICAgICh0aGlzLmNoYXRbaW5kZXhdLmZldGNoX3Nob3BpZnlfZGV0YWlscyAmJgogICAgICAgICAgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5pc19yZWZ1bmQpICYmCiAgICAgICAgICAhQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJlY2VudF9vcmRlcnNfbGlzdCkpIHx8CiAgICAgICAgKHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzICYmCiAgICAgICAgICBCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSAmJgogICAgICAgICAgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QpKSB8fAogICAgICAgICh0aGlzLmNoYXRbaW5kZXhdLmZldGNoX3Nob3BpZnlfZGV0YWlscyAmJgogICAgICAgICAgQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJldHVybl9zaG9waWZ5X2VtYWlsKSkKICAgICAgICApIHsKICAgICAgICBpZiAodGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQpIHsKICAgICAgICAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IHRoaXMuJHNlc3Npb24uZ2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CiAgICAgICAgICBpZiAoQm9vbGVhbih0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQpKSB7CiAgICAgICAgICAgICAgbGV0IGN1c3RvbWVyVG9rZW4gPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl9pZCIpOwogICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMoCiAgICAgICAgICAgICAgICAgICAgICBjdXN0b21lclRva2VuLAogICAgICAgICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICBpc1JlZnVuZCwKICAgICAgICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWUgCiAgICAgICAgICB9ZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9ZWxzZSB7CiAgICAgICAgICBsZXQgbWFnZW50b19zdG9yZV9sb2dpbl9kZXRhaWwgPSB0aGlzLmdldF9tYWdlbnRvX3N0b3JlX3dpbmRvd19jdXN0b21lcl9lbWFpbCgpOwogICAgICAgICAgICBpZiAoQm9vbGVhbihtYWdlbnRvX3N0b3JlX2xvZ2luX2RldGFpbCkgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl9pZCIsIG1hZ2VudG9fc3RvcmVfbG9naW5fZGV0YWlsWzBdKTsKICAgICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIiwgbWFnZW50b19zdG9yZV9sb2dpbl9kZXRhaWxbMV0pCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGF0W2luZGV4XS5pc19yZWZ1bmQpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zaG9waWZ5X2ZldGNoX2N1c3RvbWVyX2lkKG1hZ2VudG9fc3RvcmVfbG9naW5fZGV0YWlsWzBdLCBpbmRleCwgInNob3BpZnlfY3VzdG9tZXJfaWQiKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9mZXRjaF9vcmRlcnMobWFnZW50b19zdG9yZV9sb2dpbl9kZXRhaWxbMF0sIGluZGV4LCBpc1JlZnVuZCwgInNob3BpZnlfY3VzdG9tZXJfaWQiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAvLyBpZiAoIXRoaXMuJHNlc3Npb24uaGFzKCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuX2V4cGlyeSIpKSB7CiAgICAgICAgICAvLyAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgLy8gICB9IGVsc2UgewogICAgICAgICAgLy8gICAgIGxldCBjdXRvZmYgPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbl9leHBpcnkiKTsKICAgICAgICAgIC8vICAgICBjdXRvZmYgPSBtb21lbnQoY3V0b2ZmLCBbIllZWVktTU0tRERUaGg6bW06c3NaIl0pOwogICAgICAgICAgLy8gICAgIGxldCBjdXJyZW50X3RpbWUgPSBuZXcgRGF0ZShjdXRvZmYpOwogICAgICAgICAgLy8gICAgIGlmIChtb21lbnQoKS5pc0JlZm9yZShjdXJyZW50X3RpbWUpKSB7CiAgICAgICAgICAvLyAgICAgICBsZXQgY3VzdG9tZXJUb2tlbiA9IHRoaXMuJHNlc3Npb24uZ2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIik7CiAgICAgICAgICAvLyAgICAgICB0aGlzLnNob3BpZnlfZmV0Y2hfb3JkZXJzKAogICAgICAgICAgLy8gICAgICAgICAgIGN1c3RvbWVyVG9rZW4sCiAgICAgICAgICAvLyAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAvLyAgICAgICAgICAgaXNSZWZ1bmQsCiAgICAgICAgICAvLyAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iCiAgICAgICAgICAvLyAgICAgICAgICk7CiAgICAgICAgICAvLyAgICAgICByZXR1cm4gdHJ1ZTsgICAgICAgICAgICAKICAgICAgICAgIC8vICAgICB9ZWxzZSB7CiAgICAgICAgICAvLyAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAvLyAgICAgfQogICAgICAgICAgLy8gICB9CiAgICAgICAgfQogICAgICAgIH1lbHNlIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGluaXRpYWxpemVfc2hvcGlmeV91aSgpIHsKICAgICAgaWYgKAogICAgICAgIHdpbmRvdy5TaG9waWZ5IHx8CiAgICAgICAgdGhpcy5pc19yZXRhaWxfYm90IHx8CiAgICAgICAgdGhpcy5jb21wYW55aWQgPT0gImNlbnNlcmV0YWlsNDkxNDAiCiAgICAgICkgewogICAgICAgIHZhciBjbGllbnQgPSBTaG9waWZ5QnV5LmJ1aWxkQ2xpZW50KHsKICAgICAgICAgIGRvbWFpbjogd2luZG93LlNob3BpZnkKICAgICAgICAgICAgPyB3aW5kb3cuU2hvcGlmeS5zaG9wCiAgICAgICAgICAgIDogdGhpcy5zaG9waWZ5X3JldGFpbF9zaG9wX25hbWUgKyAiLm15c2hvcGlmeS5jb20iLAogICAgICAgICAgc3RvcmVmcm9udEFjY2Vzc1Rva2VuOiB0aGlzLnJldGFpbF9zaG9wX3N0b3JlZnJvbnRfdG9rZW4sCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5zaG9waWZ5X3VpID0gU2hvcGlmeUJ1eS5VSS5pbml0KGNsaWVudCk7CiAgICAgICAgLy8gaWYgKHRoaXMuJHNlc3Npb24uZ2V0KCJJc1BvcnRhbE1haW50YWluZW5jZSIpID09PSBmYWxzZSkgewogICAgICAgIHRoaXMuc2hvcGlmeV91aS5jcmVhdGVDb21wb25lbnQoImNhcnQiLCB7CiAgICAgICAgICBub2RlOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY2FydERpdiIpLAogICAgICAgICAgdG9nZ2xlczogW3sgbm9kZTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInRvZ2dsZSIpIH1dLAogICAgICAgICAgbW9uZXlGb3JtYXQ6IHRoaXMucmV0YWlsX3Nob3BfY3VycmVuY3kgKyAiIHt7bW9uZXlfd2l0aF9jdXJyZW5jeX19IiwKICAgICAgICAgIG9wdGlvbnM6IHsKICAgICAgICAgICAgdG9nZ2xlOiB7CiAgICAgICAgICAgICAgc3RpY2t5OiBmYWxzZSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcG9wdXA6IGZhbHNlLAogICAgICAgICAgfSwKICAgICAgICB9KTsKICAgICAgICAvLyB9CiAgICAgIH0KICAgIH0sCiAgICBpbml0aWFsaXplX3Nob3BpZnlfYnV0dG9ucyhwcm9kdWN0X2lkLCBpbmRleCwgdmFyaWFudF9pZCkgewogICAgICB0cnkgewogICAgICAgICAgdGhpcy5zaG9waWZ5X3VpCiAgICAgICAgICAuY3JlYXRlQ29tcG9uZW50KCJwcm9kdWN0IiwgewogICAgICAgICAgICBpZDogcHJvZHVjdF9pZCwKICAgICAgICAgICAgdmFyaWFudElkOiB2YXJpYW50X2lkLAogICAgICAgICAgICBtb25leUZvcm1hdDogdGhpcy5yZXRhaWxfc2hvcF9jdXJyZW5jeSArICIge3ttb25leV93aXRoX2N1cnJlbmN5fX0iLAogICAgICAgICAgICBvcHRpb25zOiB7CiAgICAgICAgICAgICAgcHJvZHVjdDogewogICAgICAgICAgICAgICAgY29udGVudHM6IHsKICAgICAgICAgICAgICAgICAgb3B0aW9uczogdHJ1ZSwKICAgICAgICAgICAgICAgICAgcXVhbnRpdHk6IHRydWUsCiAgICAgICAgICAgICAgICAgIHF1YW50aXR5SW5jcmVtZW50OiB0cnVlLAogICAgICAgICAgICAgICAgICBxdWFudGl0eURlY3JlbWVudDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgdmFyaWFudFRpdGxlOiB0cnVlLAogICAgICAgICAgICAgICAgICAvLyBidXR0b25XaXRoUXVhbnRpdHk6IGZhbHNlLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHN0eWxlczogewogICAgICAgICAgICAgICAgICBxdWFudGl0eTogewogICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICAgICAgICAianVzdGlmeS1jb250ZW50IjogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG5vZGU6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBwcm9kdWN0XyR7cHJvZHVjdF9pZH1fJHtpbmRleH1gKSwKICAgICAgICAgIH0pCiAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgdGhpcy5jaGVja19ub19wcm9kdWN0cygpOwogICAgICAgICAgICBmb3IgKHZhciBpIGluIHRoaXMucHJvZHVjdF9saXN0KSB7CiAgICAgICAgICAgICAgaWYgKHByb2R1Y3RfaWQgPT0gdGhpcy5wcm9kdWN0X2xpc3RbaV0ucHJvZHVjdF9pZCkgewogICAgICAgICAgICAgICAgdGhpcy5wcm9kdWN0X2xpc3RbaV0uYXZhaWxhYmxlRm9yU2FsZSA9CiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnZpZXdEYXRhLmF2YWlsYWJsZUZvclNhbGU7CiAgICAgICAgICAgICAgICB0aGlzLnByb2R1Y3RfbGlzdFtpXS5wcm9kdWN0SW1hZ2UgPSByZXNwb25zZS5jYWNoZWRJbWFnZS5zcmM7CiAgICAgICAgICAgICAgICB0aGlzLnByb2R1Y3RfbGlzdFtpXS5vbmxpbmVTdG9yZVVSTCA9IHJlc3BvbnNlLm9ubGluZVN0b3JlVVJMOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgIGFza19mZWVkYmFjazogZmFsc2UsCiAgICAgICAgICByZWNlaXZlZDoKICAgICAgICAgICAgIlNvbWUgZXJyb3Igb2NjdXJyZWQgd2hpbGUgdGVzdGluZy4gUGxlYXNlIHRyeSBieSByZWZyZXNoaW5nIHRoZSBicm93c2VyISBJZiB0aGUgaXNzdWUgcGVyc2lzdHMsIHBsZWFzZSBjb250YWN0IHN5c3RlbSBhZG1pbi4iLAogICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgIH07CiAgICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgfQogICAgfSwKICAgIGRlbW9fcmV0YWlsX3F1ZXN0aW9uKCkgewogICAgICBpZiAodGhpcy5pc19yZXRhaWxfYm90ICYmIHRoaXMuaXNDYWxsZWRGcm9tU2V0dXApIHsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoCiAgICAgICAgICAgIGFwaV9jYWxscy50ZW1wbGF0ZV9zeW5vbnltcygpLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29tcGFueV9pZDogdGhpcy5jb21wYW55aWQsCiAgICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLmNvbXBhbnluYW1lLAogICAgICAgICAgICAgIGlzX2dldF9wcm9kdWN0X2xpc3Q6IHRydWUsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgICAudGhlbigoeyBkYXRhIH0pID0+IHsKICAgICAgICAgICAgdGhpcy5zcGlubmVyT24gPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGRhdGEuc3RhdHVzID09PSAiU3VjY2VzcyIpIHsKICAgICAgICAgICAgICBsZXQgcHJvZHVjdF9uYW1lc19saXN0ID0gZGF0YS5wcm9kdWN0X25hbWVzX2xpc3Q7CiAgICAgICAgICAgICAgbGV0IGl0ZW0gPQogICAgICAgICAgICAgICAgcHJvZHVjdF9uYW1lc19saXN0WwogICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBwcm9kdWN0X25hbWVzX2xpc3QubGVuZ3RoKQogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICB0aGlzLnRvX3NlbmQgPSBgUGxlYXNlIHNob3cgbWUgJHtpdGVtfWA7CiAgICAgICAgICAgICAgc3dhbCh7CiAgICAgICAgICAgICAgICB0ZXh0OgogICAgICAgICAgICAgICAgICAiVGVzdGluZyBvZiBCb3QgaW4gUHJvZ3Jlc3MsIFNlYXJjaGluZyBmb3IgYSBwcm9kdWN0IGZyb20geW91ciBTdG9yZSEiLAogICAgICAgICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgICAgIHR5cGU6ICJpbmZvIiwKICAgICAgICAgICAgICAgIHRpbWVyOiA1MDAwLAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgLy8gJCgiI3NlbmRfYnRuIikuY2xpY2soKQogICAgICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgc2VuZGluZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgc2VudDogdGhpcy50b19zZW5kLAogICAgICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgLy8gdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInNlbmRlciIpOwogICAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICAgICAgICAgIGNoYXQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikKICAgICAgICAgICAgICAgICAgICAgIC5saWNlbnNlX2tleSwKICAgICAgICAgICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQsCiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICAgICAgICAgIC8vIHJlc3BvbnNlLmRhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgLy8gICByZXNwb25zZXM6IFsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICAgICAgIGJ1dHRvbnM6IFsKICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgIHsgdGl0bGU6ICJDYWxsIFN1cHBvcnQiLCB2YWx1ZTogIi9jYWxsX3N1cHBvcnQiIH0sCiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICB7IHRpdGxlOiAiTGl2ZSBDaGF0IiwgdmFsdWU6ICIvbGl2ZV9jaGF0IiB9LAogICAgICAgICAgICAgICAgICAgIC8vICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgaW50ZW50OiAiY29uZnVzaW9uIiwKICAgICAgICAgICAgICAgICAgICAvLyAgICAgICB0ZXh0OiAiU29ycnkgSSBhbSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uIiwKICAgICAgICAgICAgICAgICAgICAvLyAgICAgfSwKICAgICAgICAgICAgICAgICAgICAvLyAgIF0sCiAgICAgICAgICAgICAgICAgICAgLy8gfTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSwgImRpc3BsYXlfc3VjY2Vzc190b2FzdHIiKTsKICAgICAgICAgICAgICAgICAgICAvLyBzd2FsKHsKICAgICAgICAgICAgICAgICAgICAvLyAgIHRleHQ6ICJUZXN0aW5nIENvbXBsZXRlZCBTdWNjZXNzZnVsbHkhIFBsZWFzZSBQcm9jZWVkIHRvIHRoZSBuZXh0IHN0ZXAuIiwKICAgICAgICAgICAgICAgICAgICAvLyAgIHRvYXN0OiB0cnVlLAogICAgICAgICAgICAgICAgICAgIC8vICAgc2hvd0NhbmNlbEJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgLy8gICBzaG93Q29uZmlybUJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgLy8gICB0eXBlOiAic3VjY2VzcyIsCiAgICAgICAgICAgICAgICAgICAgLy8gICB0aW1lcjogNTAwMCwKICAgICAgICAgICAgICAgICAgICAvLyAgIHRpbWVyUHJvZ3Jlc3NCYXI6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgLy8gfSkKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLnRvX3NlbmQgPSAiIjsKICAgICAgICAgICAgICB9LCAzMjAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICB0aGlzLnNwaW5uZXJPbiA9IGZhbHNlOwogICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhlKTsKICAgICAgICAgICAgLy8gc3dhbCh7CiAgICAgICAgICAgIC8vICAgdGV4dDogIlRlc3RpbmcgRmluaXNoZWQuU29tZSBFcnJvciBPY2N1cnJlZCwgUGxlYXNlIFRyeSBBZ2FpbiIsCiAgICAgICAgICAgIC8vICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICAgIC8vICAgc2hvd0NhbmNlbEJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgIC8vICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgICAvLyAgIHR5cGU6ICJlcnJvciIsCiAgICAgICAgICAgIC8vICAgdGltZXI6IDIwMDAsCiAgICAgICAgICAgIC8vICAgdGltZXJQcm9ncmVzc0JhcjogdHJ1ZSwKICAgICAgICAgICAgLy8gfSkKICAgICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgICBhc2tfZmVlZGJhY2s6IGZhbHNlLAogICAgICAgICAgICAgIHJlY2VpdmVkOgogICAgICAgICAgICAgICAgIlNvbWUgZXJyb3Igb2NjdXJyZWQgd2hpbGUgdGVzdGluZy4gUGxlYXNlIHRyeSBieSByZWZyZXNoaW5nIHRoZSBicm93c2VyISBJZiB0aGUgaXNzdWUgcGVyc2lzdHMsIHBsZWFzZSBjb250YWN0IHN5c3RlbSBhZG1pbi4iLAogICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgc2hvcGlmeV9jaGVja19jdXN0b21lcl9sb2dnZWRfaW4oKSB7CiAgICAgIGxldCBjdXN0b21lcl9kYXRhID0gewogICAgICAgIGlzX2N1c3RvbWVyX2xvZ2dlZF9pbjogZmFsc2UsCiAgICAgICAgY3VzdG9tZXJfaWQ6IG51bGwsCiAgICAgIH07CgogICAgICBpZiAoQm9vbGVhbih0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQpKSB7CiAgICAgICAgY3VzdG9tZXJfZGF0YS5pc19jdXN0b21lcl9sb2dnZWRfaW4gPSB0cnVlOwogICAgICAgIGN1c3RvbWVyX2RhdGEuY3VzdG9tZXJfaWQgPSB0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQ7CiAgICAgIH0KICAgICAgbGV0IHN0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgY3VzdG9tZXJfZGF0YSwKICAgICAgfSk7CiAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgY2hhdDogYC9zaG9waWZ5X3JldHJlaXZlX2N1c3RvbWVyX3NwZWNpZmljX29mZmVycyR7c3RyaW5naWZpZWRfY3VzdG9tZXJfcGF5bG9hZH1gLAogICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQsCiAgICAgICAgfSkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgIHRoaXMucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UsIG51bGwpOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICB9KTsKICAgIH0sCiAgICBzZW5kX3Nob3BpZnlfY3VzdG9tZXJfaWQoaW5kZXgsIGlzX2xvZ2luLCBtZXRhZGF0YSkgewogICAgICAvLyBkZWJ1Z2dlcjsKICAgICAgLy8gY29uc29sZS5sb2coInNlbmRfc2hvcGlmeV9jdXN0b21lcl9jbGciKTsKICAgICAgLy8gaXNfbG9naW4gPSBmYWxzZTsKICAgICAgaWYgKGlzX2xvZ2luID09PSB0cnVlKSB7CiAgICAgICAgbGV0IHF1ZXJ5U3RyaW5nID0gJCgiI3Nob3BpZnlfbG9naW5fZm9ybSIpLnNlcmlhbGl6ZUFycmF5KCk7CiAgICAgICAgbGV0IGZvcm1fcGF5bG9hZCA9IHt9OwogICAgICAgIGZvcm1fcGF5bG9hZFsKICAgICAgICAgICJzaG9waWZ5X2lzX29ubHlfZW1haWwiCiAgICAgICAgXSA9IHRoaXMucmV0YWlsX29yZGVyX3JldHJlaXZhbF9vbmx5X2VtYWlsX3JlcXVpcmVkOwogICAgICAgIGZvcm1fcGF5bG9hZFsKICAgICAgICAgICJ0ZXh0IgogICAgICAgIF0gPSB0aGlzLmNoYXRbaW5kZXhdLm1ldGFkYXRhLnRleHQ7CiAgICAgICAgZm9ybV9wYXlsb2FkWwogICAgICAgICAgImVudGl0eSIKICAgICAgICBdID0gdGhpcy5jaGF0W2luZGV4XS5tZXRhZGF0YS5lbnRpdHk7CiAgICAgICAgZm9yICh2YXIgaSBpbiBxdWVyeVN0cmluZykgewogICAgICAgICAgZm9ybV9wYXlsb2FkW3F1ZXJ5U3RyaW5nW2ldLm5hbWVdID0gdGhpcy5jaGF0W2luZGV4XS5jdXN0b21lcl9lbWFpbF9pZDsKICAgICAgICB9CiAgICAgICAgZm9ybV9wYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkoZm9ybV9wYXlsb2FkKTsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgIGNoYXQ6IGAvcmVfb3JkZXJfcHJvZHVjdHNfYWN0aW9uJHtmb3JtX3BheWxvYWR9YCwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gIiI7CiAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY2hhdC5zcGxpY2UoaW5kZXgsMSk7CiAgICAgICAgICAgIHRoaXMucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpCiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKChlcnIpID0+IHsKICAgICAgICAgICAgY29uc29sZS5sb2coIkVycm9yIDo+PiAiLCBlcnIpOwogICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gbGV0IGZvcm1fcGF5bG9hZCA9IHsKICAgICAgICAvLyAgIGVtYWlsOidhc2hpc2guaUBjb2RlYXJyYXkudGVjaCcsCiAgICAgICAgLy8gICBwYXNzd29yZDogIiIsCiAgICAgICAgLy8gICBzaG9waWZ5X2lzX29ubHlfZW1haWw6IGZhbHNlLAogICAgICAgIC8vICAgdGV4dDogdGhpcy5jaGF0W2luZGV4XS5tZXRhZGF0YS50ZXh0LAogICAgICAgIC8vICAgZW50aXR5IDogdGhpcy5jaGF0W2luZGV4XS5tZXRhZGF0YS5lbnRpdHkKICAgICAgICAvLyB9OwogICAgICAgIC8vIGZvcm1fcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KGZvcm1fcGF5bG9hZCk7CiAgICAgICAgLy8gYXhpb3MKICAgICAgICAvLyAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAvLyAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAvLyAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgIC8vICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgIC8vICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgIC8vICAgICBjaGF0OiBgL3JlX29yZGVyX3Byb2R1Y3RzX2FjdGlvbiR7Zm9ybV9wYXlsb2FkfWAsCiAgICAgICAgLy8gICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAvLyAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgLy8gICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICAvLyAgIH0pCiAgICAgICAgLy8gICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAvLyAgICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YSk7CiAgICAgICAgLy8gICAgIGNvbnNvbGUubG9nKHRoaXMpOwogICAgICAgIC8vICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKQogICAgICAgIC8vICAgfSkKICAgICAgICAvLyAgIC5jYXRjaCgoZXJyKSA9PiB7CiAgICAgICAgLy8gICAgIGNvbnNvbGUubG9nKCJFcnJvciA6Pj4gIiwgZXJyKTsKICAgICAgICAvLyAgIH0pOwogICAgICB9CiAgICB9LAogICAgb3Blbl9tZXNzYWdpbmdfZnJhbWV3b3JrX2ludGVncmF0aW9uKHVybCkgewogICAgICB2YXIgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgICAgbGluay5ocmVmID0gdXJsOwogICAgICAvLyBsaW5rLnNldEF0dHJpYnV0ZSgiZG93bmxvYWQiLCBmaWxlX25hbWUpOwogICAgICBsaW5rLnNldEF0dHJpYnV0ZSgidGFyZ2V0IiwgIl9ibGFuayIpOwogICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmspOwogICAgICBsaW5rLmNsaWNrKCk7CiAgICAgIGxpbmsucmVtb3ZlKCk7CiAgICB9LAogICAgc3VwcG9ydF9zdWJzY3JpcHRpb25fZGF0YSgpIHsKICAgICAgYXhpb3MKICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgY2hhdDogIi9zdXBwb3J0X3N1YnNjcmlwdGlvbl9kYXRhIiwKICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgfSkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgIHRoaXMucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpOwogICAgICAgIH0pOwogICAgfSwKICAgIGNoZWNrX25vX3Byb2R1Y3RzKCkgewogICAgICBsZXQgcHJvZHVjdHNfZGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb2R1Y3RzX2xpc3RfZGl2Jyk7CiAgICAgIGxldCBkaXNwbGF5X25vbmVfY291bnQgPSAwOwogICAgICBmb3IgKGxldCBpID0gMDsgaTxwcm9kdWN0c19kaXYuY2hpbGRyZW4ubGVuZ3RoOyBpKyspewogICAgICAgIGlmKHByb2R1Y3RzX2Rpdi5jaGlsZHJlbltpXS5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIpewogICAgICAgICAgZGlzcGxheV9ub25lX2NvdW50ICs9MTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYoZGlzcGxheV9ub25lX2NvdW50ID09PSBwcm9kdWN0c19kaXYuY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICByZWNlaXZlZCA6ICJTb3JyeSwgd2UgY291bGQgbm90IGZpbmQgYW55IHByb2R1Y3RzLiBQbGVhc2UgdHJ5IHJlcGhyYXNpbmcgdG8gc2VhcmNoIGEgZGlmZmVyZW50IHByb2R1Y3QhIiwKICAgICAgICAgIHJlY2VpdmluZyA6IHRydWUKICAgICAgICB9OwogICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgIH0KICAgIH0sCiAgICBnZXRfbWFnZW50b19zdG9yZV93aW5kb3dfY3VzdG9tZXJfZW1haWwoKXsKICAgICAgdHJ5IHsKICAgICAgICBsZXQgY3VyciA9IEpTT04ucGFyc2UodGhpcy51c2VyX2RhdGEubWFnZW50b19jdXN0b21lcl9kYXRhKTsKICAgICAgICBpZiAoQm9vbGVhbihjdXJyLmlkKSA9PSB0cnVlICYmIEJvb2xlYW4oY3Vyci5lbWFpbCkgPT0gdHJ1ZSkgewogICAgICAgICAgdmFyIGN1c3RvbWVyID0gW2N1cnIuaWQsIGN1cnIuZW1haWxdCiAgICAgICAgICByZXR1cm4gY3VzdG9tZXI7CiAgICAgICAgfQogICAgICB9IGNhdGNoKGUpIHsgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCiAgICBnZXRfd29vY29tbWVyY2Vfc3RvcmVfd2luZG93X2N1c3RvbWVyX2VtYWlsKCl7CiAgICAgIHRyeSB7CiAgICAgICAgbGV0IGN1cnIgPSB0aGlzLnVzZXJfZGF0YS53b29fY3VycmVudF91c2VyOwogICAgICAgIGlmIChjdXJyLklEICE9PSAwICYmIGN1cnIuYWxsY2Fwcy5jdXN0b21lciA9PSB0cnVlKSB7CiAgICAgICAgICB2YXIgY3VzdG9tZXIgPSBbY3Vyci5kYXRhLklELCBjdXJyLmRhdGEudXNlcl9lbWFpbF0KICAgICAgICAgIHJldHVybiBjdXN0b21lcjsKICAgICAgICB9CiAgICAgIH0gY2F0Y2goZSkgeyB9CiAgICAgIHJldHVybiBudWxsOwogICAgfSwKICAgIGdldF9zaG9waWZ5X3N0b3JlX3dpbmRvd19jdXN0b21lcl9pZCgpewogICAgICB0cnkgewogICAgICBsZXQgY3VyciA9IHdpbmRvdy5TaG9waWZ5QW5hbHl0aWNzLm1ldGEucGFnZS5jdXN0b21lcklkOwogICAgICBpZiAoY3VyciAhPT0gdW5kZWZpbmVkICYmIGN1cnIgIT09IG51bGwgJiYgY3VyciAhPT0gIiIpIHsKICAgICAgICByZXR1cm4gY3VycjsKICAgICAgfQogICAgICB9IGNhdGNoKGUpIHsgfQogICAgICB0cnkgewogICAgICAgIGxldCBjdXJyID0gd2luZG93Lm1ldGEucGFnZS5jdXN0b21lcklkOwogICAgICAgIGlmIChjdXJyICE9PSB1bmRlZmluZWQgJiYgY3VyciAhPT0gbnVsbCAmJiBjdXJyICE9PSAiIikgewogICAgICAgICAgcmV0dXJuIGN1cnI7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7IH0gICAgCiAgICAgIHRyeSB7CiAgICAgICAgbGV0IGN1cnIgPSBfc3QuY2lkOwogICAgICAgIGlmIChjdXJyICE9PSB1bmRlZmluZWQgJiYgY3VyciAhPT0gbnVsbCAmJiBjdXJyICE9PSAiIikgewogICAgICAgICAgcmV0dXJuIGN1cnI7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7IH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAogICAgbm9fb3JkZXJzX3RvX2JlX3Nob3duKGluZGV4KXsKICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJJdCBzZWVtcyB5b3UgaGF2ZSBubyBvcmRlcnMgcmlnaHQgbm93ISIKICAgIH0sCiAgICBjaGFuZ2VfY2hhdF90ZXh0X3RvX2xvZ2luX3JlZGlyZWN0KGluZGV4KXsKICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICc8cCBzdHlsZT0id2lkdGg6YXV0bzttYXJnaW4tYm90dG9tOjA7Ij4gUGxlYXNlIGxvZ2luIG9uIHRoZSBzdG9yZSBieSBjbGlja2luZyA8YSB0aXRsZT0iVGhpcyBmZWF0dXJlIGlzIG9ubHkgYXZhaWxhYmxlIG9uIHRoZSBzdG9yZSB3ZWJzaXRlLiJjbGFzcz0iYm90LXJlc3BvbnNlLXN0eWxlIiBzdHlsZT0iY3Vyc29yOiBub3QtYWxsb3dlZDsiIGhyZWY9ImphdmFzY3JpcHQ6IHZvaWQoMCkiPiBoZXJlIDwvYT48L3A+JzsKICAgIH0sCiAgICByZXR1cm5fZG9jdW1lbnRfY29va2llcyhuYW1lKSB7CiAgICAgIC8vIGNvbnN0IHZhbHVlID0gYDsgJHtkb2N1bWVudC5jb29raWV9YDsKICAgICAgLy8gY29uc3QgcGFydHMgPSB2YWx1ZS5zcGxpdChgOyAke25hbWV9PWApOwogICAgICAvLyBpZiAocGFydHMubGVuZ3RoID09PSAyKSByZXR1cm4gcGFydHMucG9wKCkuc3BsaXQoJzsnKS5zaGlmdCgpOwogICAgICBsZXQgY29va2llID0ge307CiAgICAgIGRvY3VtZW50LmNvb2tpZS5zcGxpdCgnOycpLmZvckVhY2goZnVuY3Rpb24oZWwpIHsKICAgICAgbGV0IFtrLHZdID0gZWwuc3BsaXQoJz0nKTsKICAgICAgY29va2llW2sudHJpbSgpXSA9IHY7CiAgICB9KQogICAgcmV0dXJuIGNvb2tpZVtuYW1lXTsKICAgIH0sCiAgICBhdmFpbGFibGVfcXR5KHN0b2NrX3F0eSwgaWQpewogICAgICBpZiAodGhpcy5hZGR0b0NhcnRkYXRhLmxlbmd0aCAhPSAwKXsKICAgICAgICBmb3IgKHZhciBpIGluIHRoaXMuYWRkdG9DYXJ0ZGF0YSkgewogICAgICAgICAgaWYgKHRoaXMuYWRkdG9DYXJ0ZGF0YVtpXS5pZCA9PT0gaWQpewogICAgICAgICAgICBsZXQgcmVzID0gc3RvY2tfcXR5IC0gdGhpcy5hZGR0b0NhcnRkYXRhW2ldLm9yZGVyX3F0eTsKICAgICAgICAgICAgcmV0dXJuIChyZXMgPT0gMCkgPyAicmVhY2hlZCIgOiByZXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdG9ja19xdHkKICAgICAgfSBlbHNlewogICAgICAgIHJldHVybiBzdG9ja19xdHk7CiAgICAgIH0KICAgIH0KICB9LAp9Owo="},null]}