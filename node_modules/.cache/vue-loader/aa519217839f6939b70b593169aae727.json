{"remainingRequest":"/home/vimalesh/Learning/devops_ui/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/vimalesh/Learning/devops_ui/src/portal/Chatbot/Dashboard/Data Inputs/ResponseBot.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/vimalesh/Learning/devops_ui/src/portal/Chatbot/Dashboard/Data Inputs/ResponseBot.vue","mtime":1663910265466},{"path":"/home/vimalesh/Learning/devops_ui/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/Learning/devops_ui/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/Learning/devops_ui/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/vimalesh/Learning/devops_ui/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/vimalesh/Learning/devops_ui/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCmltcG9ydCBheGlvcyBmcm9tICJheGlvcyI7CmltcG9ydCBhcGlfY2FsbHMgZnJvbSAiQC9wb3J0YWwvYXBpX2NhbGxzIjsKaW1wb3J0IGZpbmdlcnByaW50IGZyb20gIkAvcG9ydGFsL2NvbXBvbmVudHMvZmluZ2VycHJpbnQiOwppbXBvcnQgeyBidXMgfSBmcm9tICJAL3BvcnRhbC9tYWluIjsKaW1wb3J0IHsgc2V0VGltZW91dCB9IGZyb20gInRpbWVycyI7CmltcG9ydCBNdWx0aXNlbGVjdCBmcm9tICJ2dWUtbXVsdGlzZWxlY3QiOwppbXBvcnQgVmlkZW9WaWV3ZXIgZnJvbSAiQC9wb3J0YWwvY29tcG9uZW50cy9SZXNwb25zZSBCb3QvVmlkZW9WaWV3ZXIudnVlIjsKaW1wb3J0IGRlYm91bmNlIGZyb20gInZ1ZS1kZWJvdW5jZS9kaXN0L2RlYm91bmNlLm1pbi5qcyI7Ci8vIGltcG9ydCB7IFNvY2tldCB9IGZyb20gInBob2VuaXgtc29ja2V0IjsKaW1wb3J0IHsgU29ja2V0LCBQcmVzZW5jZSB9IGZyb20gInBob2VuaXgiOwppbXBvcnQgU3RhclJhdGluZyBmcm9tICJ2dWUtc3Rhci1yYXRpbmciOwppbXBvcnQgewogIHZvaWNlcmVjb3JkZXIsCiAgc3RhcnRfdm9pY2VfY29tbXVuaWNhdGlvbiwKICBmb3JlaWdueGNoYW5nZV9jdXN0b20sCiAgZ2VuZXJhdGVfdGltZSwKfSBmcm9tICJAL3BvcnRhbC9taXhpbnMiOwppbXBvcnQgbW9tZW50IGZyb20gIm1vbWVudCI7CmltcG9ydCBzd2FsIGZyb20gInN3ZWV0YWxlcnQyIjsKaW1wb3J0IENlbnNlQ2FydCBmcm9tICIuL0NlbnNlQ2FydC52dWUiOwppbXBvcnQgVnVlTnVtZXJpY0lucHV0IGZyb20gInZ1ZS1udW1lcmljLWlucHV0IjsKaW1wb3J0IHNvdW5kIGZyb20gIkAvcG9ydGFsL2Fzc2V0cy9hdWRpby9taXhraXQtYWRkLXRvLWNhcnQud2F2IjsKaW1wb3J0ICJAL3BvcnRhbC9hc3NldHMvanMvc2hvcGlmeS5taW4uanMiOwpleHBvcnQgZGVmYXVsdCB7CiAgbmFtZTogInJlc3BvbnNlLWJvdCIsCiAgY29tcG9uZW50czogewogICAgTXVsdGlzZWxlY3QsCiAgICBWaWRlb1ZpZXdlciwKICAgIFN0YXJSYXRpbmcsCiAgICBDZW5zZUNhcnQsCiAgICBWdWVOdW1lcmljSW5wdXQsCiAgfSwKICBtaXhpbnM6IFsKICAgIHZvaWNlcmVjb3JkZXIsCiAgICBzdGFydF92b2ljZV9jb21tdW5pY2F0aW9uLAogICAgZm9yZWlnbnhjaGFuZ2VfY3VzdG9tLAogICAgZ2VuZXJhdGVfdGltZSwKICBdLAogIGRhdGEoKSB7CiAgICByZXR1cm4gewogICAgICBjb21wYW55aWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkLAogICAgICBjb21wYW55bmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfbmFtZSwKICAgICAgcG9wdXBfbXNnOgogICAgICAgICJZb3UgY2FuIHR5cGUgJ1Jlc3RhcnQn4oCdICBhdCA8L2JyPmFueSAgdGltZSB0byBnZXQgYmFjazwvYnI+IHRvIHRoZSBNYWluIE1lbnUiLAogICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiB0cnVlLAogICAgICBxdXNfYW5zOiAiYW5zd2VycyIsCiAgICAgIHRvX3NlbmQ6ICIiLAogICAgICBjZW5zZV9lbnF1aXJ5OiBmYWxzZSwKICAgICAgaXNfYWdlbnRfdHlwaW5nOiBmYWxzZSwKICAgICAgdXNlcl9uYW1lOiAiIiwKICAgICAgc2hvdzogZmFsc2UsCiAgICAgIGNoYXQ6IFtdLAogICAgICBmaW5nZXJwcmludDogbnVsbCwKICAgICAgYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlOiB0aGlzLiRzZXNzaW9uLmdldCgiQm90VG9rZW4iKSwKICAgICAgbGV2ZWw6IDAsCiAgICAgIHJlY29nbml0aW9uOiBudWxsLAogICAgICBqc29uX2RhdGE6IHsKICAgICAgICBjcmVhdGVfYXBwb2ludG1lbnQ6CiAgICAgICAgICAneyJVc2VyIjogeyJQaHlzaWNpYW4iOiB7IklEIjogIkRUMDAwMDAwMDAwMDAwMDAwMjM3In0sIlVzZXJOYW1lIjoiYWMiLCJJRCI6IlVTMDAwMDAwMDAwMDAwMDAwMTM4IiwiQWNjb3VudCI6IHsiSUQiOiAiQ08wMDAyMyJ9LCJUb2tlbiI6ICJaMXJTR0dtMFhwTVdqdDNnaUFFclBQV1o4NFRRTjlGc0ZNQkxzVSsvTEF1Nnl1YWxNZzZFUDJic3J3WmpMUHdtM2o0RHBQY0djNUxjSXAzTmpnZlVzQT09IiwiU3BlY2lhbHR5IjogeyJJRCI6ICJQRzAwMDAwMDAwMDAwMDAwMDE0MSIsICJOYW1lIjogIkFDIiwgIkNvZGUiOiAiQUMifSwiRG9tYWluIjogImdvZ3JlZW5iaWxscy5jb20ifSwiQXBwb2ludG1lbnQiOiB7IkRhdGUiOiAiMDgvMzAvMjAxOCIsICJJc0pTT05Ob3RlIjogMCwgIlBhdGllbnQiOiB7IkNhc2VJRCI6ICIifX19JywKICAgICAgICB2aXNpdHNfZmluYWxpemVkOgogICAgICAgICAgJ3siVXNlciI6IHsiUGh5c2ljaWFuIjogeyJJRCI6ICJEVDAwMDAwMDAwMDAwMDAxMTg4NiJ9LCJVc2VyTmFtZSI6ICJjaCIsIklEIjogIlVTMDAwMDAwMDAwMDAwMDAwMTQzIiwiQWNjb3VudCI6eyJJRCI6IkNPMDAwMjMifSwiVG9rZW4iOiJleUowZVhBaU9pSktWMVFpTENKaGJHY2lPaUpJVXpJMU5pSjkuZXlKMWMyVnlJam9pWVhaa2FIVjBJaXdpWlhod0lqb3hOVEk1TkRneU5qWXpmUS52MWMwSGJ1V3VaWFhwSmZEclhWYzFIUFZ1ZmZibkdjTHFrcGcwem02QW9RIiwiU3BlY2lhbHR5IjogeyJJRCI6ICJQRzAwMDAwMDAwMDAwMDAwMDE0MiIsIkNvZGUiOiAiY2gifSwiRG9tYWluIjogImdyZWVueW91cmJpbGxzLmNvbSJ9LCJTZWFyY2hQYXJhbWV0ZXJzIjogeyJTdGF0dXMiOiAiIiwiT3JkZXJCeSI6ICIiLCJGcm9tRGF0ZSI6ICIwMS8wMS8yMDE4IiwiQ291bnQiOiAiMTAiLCJTZWFyY2hUZXh0IjogIiIsIlR5cGVPZlZpc2l0IjogIkFMTCIsIlNvcnRPcmRlciI6ICJhcHBvaW50bWVudCIsIlN0YXJ0SW5kZXgiOiAiMSIsIkVuZEluZGV4IjogIjEwIiwiVG9EYXRlIjogIjA4LzA2LzIwMTgifX0nLAogICAgICAgIGFwcG9pbnRtZW50c19jb3VudDoKICAgICAgICAgICd7IlVzZXIiOiB7IlBoeXNpY2lhbiI6IHsiSUQiOiAiRFQwMDAwMDAwMDAwMDAwMTE4ODYifSwiVXNlck5hbWUiOiAiY2giLCJJRCI6ICJVUzAwMDAwMDAwMDAwMDAwMDE0MyIsIkFjY291bnQiOnsiSUQiOiJDTzAwMDIzIn0sIlRva2VuIjoiZXlKMGVYQWlPaUpLVjFRaUxDSmhiR2NpT2lKSVV6STFOaUo5LmV5SjFjMlZ5SWpvaVlYWmthSFYwSWl3aVpYaHdJam94TlRJNU5EZ3lOall6ZlEudjFjMEhidVd1WlhYcEpmRHJYVmMxSFBWdWZmYm5HY0xxa3BnMHptNkFvUSIsIlNwZWNpYWx0eSI6IHsiSUQiOiAiUEcwMDAwMDAwMDAwMDAwMDAxNDIiLCJDb2RlIjogImNoIn0sIkRvbWFpbiI6ICJncmVlbnlvdXJiaWxscy5jb20ifSwiU2VhcmNoUGFyYW1ldGVycyI6IHsiU3RhdHVzIjogIiIsIk9yZGVyQnkiOiAiIiwiRnJvbURhdGUiOiAiMDEvMDEvMjAxOCIsIkNvdW50IjogIjEwIiwiU2VhcmNoVGV4dCI6ICIiLCJUeXBlT2ZWaXNpdCI6ICJBTEwiLCJTb3J0T3JkZXIiOiAiYXBwb2ludG1lbnQiLCJTdGFydEluZGV4IjogIjEiLCJFbmRJbmRleCI6ICIxMCIsIlRvRGF0ZSI6ICIwOC8wNi8yMDE4In19JywKICAgICAgICBjcmVhdGVfdGlja2V0OgogICAgICAgICAgJ3siQWNjb3VudE5hbWUiOm51bGwsIkNhbGxiYWNrUGhvbmUiOiIiLCJDb21wYW55SUQiOiJDTzAwMDIzIiwiRGVzY3JpcHRpb24iOiJEZSIsIkRvbWFpbk5hbWUiOm51bGwsIkVtYWlsQ0MiOiJhYmhheS53QGNvZGVhcnJheS50ZWNoIiwiRW1haWxEZWZhdWx0IjoibWFuaXNoLnlAY29kZWFycmF5LnRlY2giLCJQcmlvcml0eSI6IjMiLCJQcmlvcml0eUlEIjowLCJSYWlzZWRCeSI6Imxhd3VzZXIiLCJTdGF0dXMiOjAsIlN0YXR1c0NvZGUiOm51bGwsIlN0YXR1c1RleHQiOm51bGwsIlNUeXBlIjoiV1AiLCJTdWJqZWN0IjoiRGUiLCJTdWJUeXBlIjoiU0FNRC1QIiwiVGlja2V0SUQiOjAsIlRpY2tldE51bWJlciI6bnVsbCwiVHlwZSI6MCwiVHlwZVRleHQiOiJXZWJzaXRlIFByb2JsZW0iLCJsaXN0RmlsZXMxIjpbImNocTEucGRmIl19JywKICAgICAgICBnZXRfcmVwb3J0OiAneyJjb21wYW55SWQiOiAiQ08wMDAyMyJ9JywKICAgICAgfSwKICAgICAgc3RvcDogdHJ1ZSwKICAgICAgZGVtb3VybGJpbmQ6IGZhbHNlLAogICAgICByZXZpZXdzdXJsYmluZDogZmFsc2UsCiAgICAgIHJldmlld3N1cmw6ICJodHRwczovL3d3dy55b3V0dWJlLmNvbS9lbWJlZC9wYUFlVzg2ZVFaNCIsCiAgICAgIGRlbW91cmw6IFsKICAgICAgICAiaHR0cHM6Ly93d3cueW91dHViZS5jb20vZW1iZWQvdmlkZW9zZXJpZXM/S2NySm05VXhXM3MmaW5kZXg9MTMmbGlzdD1QTF9qWGxpaDhkZ2tURThDclBwaVdjQTlLeFFlS0haQW50JnQ9MHMiLAogICAgICAgICJodHRwczovL3d3dy55b3V0dWJlLmNvbS9lbWJlZC92aWRlb3Nlcmllcz9xelMycUlOSTZJTSZsaXN0PVBMX2pYbGloOGRna1J1NWRkR1hBR3FaNHVMTGtvSnpDajgmaW5kZXg9MiIsCiAgICAgIF0sCiAgICAgIGNoYXRfd2lkZ2V0OiB7CiAgICAgICAgbG9nbzogIiIsCiAgICAgICAgdGl0bGU6ICIiLAogICAgICAgIHN0eWxlOiAiIiwKICAgICAgICBib3RfdGhlbWU6ICIiLAogICAgICAgIGJ1dHRvbl9ib3JkZXJfdGhlbWU6ICIjMjczNjc5IiwKICAgICAgICB1c2VyX3Jlc3BvbnNlX2JnX2NvbG9yOiAiIzI3MzY3OSIsCiAgICAgICAgYm90X3Jlc3BvbnNlX2JnX2NvbG9yOiAiI2ZmZmZmZiIsCiAgICAgICAgZGVsaXZlcnlfbm90ZV9jb2xvcjogIiMyNzM2NzkiLAogICAgICAgIGJ1dHRvbl90aGVtZTogIiIsCiAgICAgICAgYnV0dG9uX2FsaWdubWVudDogIiIsCiAgICAgICAgYm90X2ljb246ICIiLAogICAgICAgIGJvdF9iYWNrZ3JvdW5kX2ltYWdlOiAiIiwKICAgICAgICBidXR0b25faG9yaXpvbnRhbF9zcGFjaW5nOiAiMyIsCiAgICAgICAgYnV0dG9uX3ZlcnRpY2FsX3NwYWNpbmc6ICI1IiwKICAgICAgICBoZWFkZXJfYmFja2dyb3VuZDogIiIsCiAgICAgICAgYm90X2ZvbnRfc3R5bGU6ICIiLAogICAgICAgIGJvdF9mb250X2NvbG9yX3NlbmRlcjogIiIsCiAgICAgICAgYm90X2ZvbnRfY29sb3JfcmVjZWl2ZXI6ICIiLAogICAgICAgIGJvdF9mb250X2NvbG9yX2J1dHRvbnM6ICIiLAogICAgICAgIGlzX3Bvd2VyZWRfYnlfY2Vuc2U6IHRydWUsCiAgICAgIH0sCiAgICAgIHNlbGVjdGVkX2RhdGU6ICIiLAogICAgICBzZWxlY3RlZF90aW1lOiAiIiwKICAgICAgcmVhc29uX29mX3Zpc2l0OiAiIiwKICAgICAgcGF0aWVudF9uYW1lOiAiIiwKICAgICAgdmlzaXRvcl9udW1iZXI6ICIiLAogICAgICBmdWxsX3RpbWVfc2xvdHM6IFtdLAogICAgICB0aW1lX3Nsb3RzOiBbXSwKICAgICAgVE9EQVlfREFURTogIiIsCiAgICAgIGNoYW5uZWw6IG51bGwsCiAgICAgIGNoYXRfc29ja2V0OiBudWxsLAogICAgICB2b2ljZV9zb2NrZXQ6IG51bGwsCiAgICAgIGxpdmVfY2hhdF9vbjogZmFsc2UsCiAgICAgIGxpdmVfY2hhdF90b2tlbjogbnVsbCwKICAgICAgY2hhdF9ncm91cF9uYW1lOiBudWxsLAogICAgICB0b19zY3JvbGw6IGZhbHNlLAogICAgICBmb3JtX3BheWxvYWQ6IG51bGwsCiAgICAgIHBob25lX251bWJlcl92YWxpZGl0eTogL1swLTldezEwLDExfSQvLAogICAgICB1cmxfbWF0Y2hfcmVnZXg6IC9eaHR0cHM/OlwvXC8uKltcXFwvXS4rXC5bKHBkZnxjc3Z8eGxzeCldezIsNH0vLAogICAgICBjdXJyZW5jeWV4Y2hhbmdlX2xpc3Q6IG51bGwsCiAgICAgIHNlbGVjdGVkX2luZGljYXRpb246IFtdLAogICAgICB3ZWxjb21lX21lc3NhZ2Vfbm90X3lldF9yZWNlaXZlZDogdHJ1ZSwKICAgICAgcmVzOiB7fSwKICAgICAgaXNfdHlwaW5nX2luZGljYXRvcl9vbjogZmFsc2UsCiAgICAgIHRodW1ic191cF9pY29uOiByZXF1aXJlKCJAL3BvcnRhbC9hc3NldHMvaW1nL0dyb3VwIDcuc3ZnIiksCiAgICAgIHRodW1ic19kb3duX2ljb246IHJlcXVpcmUoIkAvcG9ydGFsL2Fzc2V0cy9pbWcvR3JvdXAgNi5zdmciKSwKICAgICAgc2hvcGlmeV91aTogbnVsbCwKICAgICAgc2hvcGlmeV9jdXN0b21lcl9pZDogbnVsbCwKICAgICAgLy8gcmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlsczoge30sCiAgICAgIC8vIHJlZnVuZF9zZWxlY3RlZF9pdGVtczogW10sCiAgICAgIHNob3BpZnlfcmV0YWlsX3Nob3BfbmFtZTogbnVsbCwKICAgICAgc2hvcF91cmw6IG51bGwsCiAgICAgIGlzX3JldGFpbF9ib3Q6IGZhbHNlLAogICAgICBzaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kOiBudWxsLAogICAgICBzaG93X3Nob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmRfZXJyb3I6IGZhbHNlLAogICAgICBzdXBwb3J0X2NoYW5uZWw6IG51bGwsCiAgICAgIGlzX3N1cHBvcnRfYWdlbnRfcHJlc2VudDogZmFsc2UsCiAgICAgIHN1cHBvcnRfYWdlbnRfaW5mbzogbnVsbCwKICAgICAgcmV0YWlsX29yZGVyX3JldHJlaXZhbF9vbmx5X2VtYWlsX3JlcXVpcmVkOiBmYWxzZSwKICAgICAgcmV0YWlsX3Nob3BfY3VycmVuY3k6IG51bGwsCiAgICAgIHByb2R1Y3RfbGlzdDogW10sCiAgICAgIHByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3Q6IFtdLAogICAgICBjaGVja2VkX2xpc3Q6IFtdLAogICAgICBjdXJyZW50X3Byb2R1Y3Q6ICIiLAogICAgICBjdXN0b21lcl9lbWFpbDogIiIsCiAgICAgIHJlZ19lbWFpbDoKICAgICAgICAvXihbMC05YS16QS1aXShbLS5cd10qWzAtOWEtekEtWl0pKkAoWzAtOWEtekEtWl1bLVx3XSpbMC05YS16QS1aXVwuKStbYS16QS1aXXsyLDl9KSQvLAogICAgICBzY3JvbGxQb3NpdGlvbjogMCwKICAgICAgdmlzaWJsZV9jdXN0b21fZ3JlZXRpbmdzX2J1dHRvbTogZmFsc2UsCiAgICAgIHJldmlld19tZXNzYWdlX2ZpcnN0OiAiIiwKICAgICAgcmV2aWV3X21lc3NhZ2Vfc2Vjb25kOiAiIiwKICAgICAgcmV2aWV3X3Jlc3BvbnNlX21lc3NhZ2U6ICIiLAogICAgICBkaXNwbGF5X3Byb2R1Y3RzX29uX2xhbmRpbmc6IGZhbHNlLAogICAgICByZXRhaWxfd2ViX2ZyYW1ld29yazogIiIsCiAgICAgIGlzX2NlbnNlX2NhcnQ6IGZhbHNlLAogICAgICBzaG93X2N1c3RvbV9jYXJ0OiBmYWxzZSwKICAgICAgYWRkdG9DYXJ0ZGF0YTogW10sCiAgICAgIHRvdGFsX3Byb2R1Y3RzX3F0eTogMCwKICAgICAgb3Zlcl9xdHlfd2FybmluZzogZmFsc2UsCiAgICAgIGNvbnRhY3RfaGVscF9lbWFpbDogbnVsbCwKICAgICAgc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZF9saXN0OiBudWxsLAogICAgICBzaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX29wdGlvbjogWwogICAgICAgICJPcmRlcmVkIGJ5IG1pc3Rha2UiLAogICAgICAgICJPcmRlcmVkIHdyb25nIHByb2R1Y3QiLAogICAgICAgICJPcmRlciBub3QgUmVjZWl2ZWQiLAogICAgICAgICJObyBsb25nZXIgbmVlZGVkIiwKICAgICAgICAiQmV0dGVyIHByaWNlIGF2YWlsYWJsZSIsCiAgICAgICAgIlJlY2VpdmVkIGRhbWFnZWQgcHJvZHVjdHMiLAogICAgICAgICJPdGhlcnMiLAogICAgICBdLAogICAgICBvcmRlcl9ub3Rlc19kYXRhOiBbXSwKICAgICAgc2VsZWN0ZWRfb3JkZXJfbmFtZTogIiIsCiAgICAgIGlzX3dvb2NvbW1lcmNlX29yZGVyOiBmYWxzZSwKICAgICAgdmlzaXRvcnNfY3VycmVudF9sb2NhdGlvbjogbnVsbCwKICAgICAgaXNfZGlzcGxheV9iYW5uZXJfb25fbGFuZGluZzogZmFsc2UsCiAgICAgIHZpc2l0b3JzX2N1cnJlbnRfbG9jYXRpb25fdXJsOiBgaHR0cHM6Ly9pcGdlb2xvY2F0aW9uLmFic3RyYWN0YXBpLmNvbS92MS8/YXBpX2tleT0ke3Byb2Nlc3MuZW52LlZVRV9BUFBfQ1VSUkVOVF9MT0NBVElPTl9UT0tFTn1gLAogICAgICBncmVldGluZ19idXR0b25zX3Bvc2l0aW9uOiBudWxsLAogICAgICAvLyBjdXN0b21fcHJvZHVjdF9idXR0b25fa2V5OiBbeyduYW1lJzogJ2N1c3RvbWl6ZSBpdCcsICdmdW5jdGlvbic6J3JvdXRlJywgJ29uX2tleSc6ICdwcm9kdWN0X3R5cGUnLCAnb25fdmFsdWUnOidjdXN0b20nfV0sCiAgICAgIGN1c3RvbV9wcm9kdWN0X2J1dHRvbl9rZXk6IFtdLAogICAgfTsKICB9LAogIHByb3BzOiB7CiAgICBpc1ByZXZpZXdCb3Q6IEJvb2xlYW4sCiAgICBpc0RpYWxvZ0JvdDogQm9vbGVhbiwKICAgIGN1cnJlbnRfcHJldmlld19iYW5uZXJfaWQ6IFN0cmluZywKICAgIGlzVGV4dFRvQm90OiB7CiAgICAgIHR5cGU6IEJvb2xlYW4sCiAgICAgIGRlZmF1bHQ6IHRydWUsCiAgICB9LAogICAgaXNDYWxsZWRGcm9tU2V0dXA6IHsKICAgICAgdHlwZTogQm9vbGVhbiwKICAgICAgZGVmYXVsdDogZmFsc2UsCiAgICB9LAogIH0sCiAgY29tcHV0ZWQ6IHsKICAgIGNhcnRfYnV0dG9uX2FsaWdubWVudCgpIHsKICAgICAgaWYgKHRoaXMuaXNfcmV0YWlsX2JvdCkgewogICAgICAgIHJldHVybiAiY29sLXNtLTIgcHgtMCI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH0sCiAgICBpbnB1dF9kaXNhYmxlZCgpIHsKICAgICAgcmV0dXJuIHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCB8fCB0aGlzLndlbGNvbWVfbWVzc2FnZV9ub3RfeWV0X3JlY2VpdmVkOwogICAgfSwKICAgIGNzc1Byb3BzKCkgewogICAgICBsZXQgYm90QXR0cmlidXRlcyA9IHsKICAgICAgICBoZWFkX2NvbG9yOiB0aGlzLmNoYXRfd2lkZ2V0LmhlYWRlcl9iYWNrZ3JvdW5kLAogICAgICB9OwogICAgICByZXR1cm4gewogICAgICAgICItLWJvdC1oZWFkLWNvbG9yIjogYm90QXR0cmlidXRlcy5oZWFkX2NvbG9yLAogICAgICAgICItLWJvdC1zZW5kZXItY29sb3IiOiB0aGlzLmNoYXRfd2lkZ2V0LmJvdF90aGVtZSwKICAgICAgICAiLS1ib3QtYnV0dG9uLWNvbG9yIjogdGhpcy5jaGF0X3dpZGdldC5ib3RfdGhlbWUsCiAgICAgICAgIi0tYm90LWxpbmstY29sb3IiOiB0aGlzLmNoYXRfd2lkZ2V0LmJvdF90aGVtZSwKICAgICAgICAiLS1ib3QtYnV0dG9uLWJvcmRlciI6IHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX2JvcmRlcl90aGVtZSwKICAgICAgICAiLS11c2VyLXJlc3BvbnNlLWJnLWNvbG9yIjogdGhpcy5jaGF0X3dpZGdldC51c2VyX3Jlc3BvbnNlX2JnX2NvbG9yLAogICAgICAgICItLWJvdC1yZXNwb25zZS1iZy1jb2xvciI6IHRoaXMuY2hhdF93aWRnZXQuYm90X3Jlc3BvbnNlX2JnX2NvbG9yLAogICAgICAgICItLWRlbGl2ZXJ5LW5vdGUtY29sb3IiOiB0aGlzLmNoYXRfd2lkZ2V0LmRlbGl2ZXJ5X25vdGVfY29sb3IsCiAgICAgICAgIi0tYm90LWJ1dHRvbi1iYWNrZ3JvdW5kIjogdGhpcy5jaGF0X3dpZGdldC5idXR0b25fdGhlbWUsCiAgICAgICAgIi0tYm90LWJ1dHRvbnMtYWxpZ25tZW50IjogdGhpcy5jaGF0X3dpZGdldC5idXR0b25fYWxpZ25tZW50LnZhbHVlLAogICAgICAgICItLWJvdC1idXR0b25zLXZlcnRpY2FsLXNwYWNpbmciOiBgJHt0aGlzLmNoYXRfd2lkZ2V0LmJ1dHRvbl92ZXJ0aWNhbF9zcGFjaW5nfSVgLAogICAgICAgICItLWJvdC1idXR0b25zLWhvcml6b250YWwtc3BhY2luZyI6IGAke3RoaXMuY2hhdF93aWRnZXQuYnV0dG9uX2hvcml6b250YWxfc3BhY2luZ30lYCwKICAgICAgICAiLS1ib3QtZm9udC1zdHlsZSI6IHRoaXMuY2hhdF93aWRnZXQuYm90X2ZvbnRfc3R5bGUudmFsdWUsCiAgICAgICAgIi0tYm90LWZvbnQtY29sb3Itc2VuZGVyIjogdGhpcy5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9zZW5kZXIsCiAgICAgICAgIi0tYm90LWZvbnQtY29sb3ItcmVjZWl2ZXIiOiB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9mb250X2NvbG9yX3JlY2VpdmVyLAogICAgICAgICItLWJvdC1mb250LWNvbG9yLWJ1dHRvbnMiOiB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9mb250X2NvbG9yX2J1dHRvbnMsCiAgICAgIH07CiAgICB9LAogICAgYm90X2ltZ19pY29uKCkgewogICAgICByZXR1cm4gewogICAgICAgICJiYWNrZ3JvdW5kLWltYWdlIjogYHVybCgke3RoaXMuY2hhdF93aWRnZXQuYm90X2ljb259KWAsCiAgICAgIH07CiAgICB9LAogICAgY2hhdF9ib3RfYmFja2dyb3VuZF9pbWFnZSgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAiYmFja2dyb3VuZC1pbWFnZSI6IGB1cmwoJHt0aGlzLmNoYXRfd2lkZ2V0LmJvdF9iYWNrZ3JvdW5kX2ltYWdlfSlgLAogICAgICB9OwogICAgfSwKICAgIHNob3BpZnlfbG9naW5fYnV0dG9uX3RleHQoKSB7CiAgICAgIGlmICh0aGlzLnJldGFpbF9vcmRlcl9yZXRyZWl2YWxfb25seV9lbWFpbF9yZXF1aXJlZCkgewogICAgICAgIHJldHVybiAiR28iOwogICAgICB9CiAgICAgIHJldHVybiAiTG9naW4iOwogICAgfSwKICAgIGNhcnRfaWNvbl9zdmcoKSB7CiAgICAgIHJldHVybiBgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMCIgd2lkdGg9IjE4LjAwMDAwMHB0IiBoZWlnaHQ9IjE4LjAwMDAwMHB0IiB2aWV3Qm94PSIwIDAgNTEyLjAwMDAwMCA1MTIuMDAwMDAwIiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJ4TWlkWU1pZCBtZWV0Ij48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjAwMDAwMCw1MTIuMDAwMDAwKSBzY2FsZSgwLjEwMDAwMCwtMC4xMDAwMDApIiBmaWxsPSIke3RoaXMuY2hhdF93aWRnZXQuYm90X2ZvbnRfY29sb3JfYnV0dG9uc30iIHN0cm9rZT0ibm9uZSI+PHBhdGggZD0iTTgxIDUwMDIgYy0xMDAgLTUwIC0xMDYgLTE4NiAtMTIgLTI0OSAzMyAtMjMgMzkgLTIzIDMxNyAtMjMgbDI4NCAwIDUgLTIyIGMzIC0xMyAxNzIgLTc0NSAzNzUgLTE2MjggMjc5IC0xMjA5IDM3NiAtMTYxMiAzOTIgLTE2MzYgNDcgLTY5IC03MiAtNjQgMTU5OSAtNjQgMTM2NyAwIDE1MTQgMiAxNTQ1IDE2IDM3IDE4IDY4IDYyIDc5IDExMSA5IDQ1IC0yNCAxMTcgLTY3IDE0MyAtMzMgMjAgLTQ1IDIwIC0xNDc1IDIwIC0xMzY0IDAgLTE0NDIgMSAtMTQ0NyAxOCAtMTIgMzcgLTEwNiA0NTQgLTEwNiA0NjggMCAxMiAyMDYgMTQgMTUwMyAxNCAxNDcyIDAgMTUwMyAwIDE1MzQgMjAgMTggMTAgMzkgMzMgNDggNTAgMjYgNTAgNDY4IDIwMzAgNDYxIDIwNjggLTcgNDQgLTM5IDg2IC04MCAxMDYgLTMxIDE1IC0yMDggMTYgLTIwMTQgMTYgbC0xOTgwIDAgLTI3IDExOCBjLTczIDMxOSAtOTQgMzk1IC0xMTcgNDE5IC00OSA1MyAtNTEgNTMgLTQzMCA1MyAtMzE2IDAgLTM1NyAtMiAtMzg3IC0xOHogbTQ3MDIgLTg2OSBjMiAtNSAtODEgLTM4MSAtMTg0IC04MzggLTEwNCAtNDU2IC0xODggLTgzMSAtMTg5IC04MzMgMCAtMSAtNjU2IC0xIC0xNDU3IDAgbC0xNDU4IDMgLTE5MiA4MzAgYy0xMDUgNDU3IC0xOTIgODMzIC0xOTIgODM4IC0xIDkgMzY2NyA5IDM2NzIgMHoiLz48cGF0aCBkPSJNMjAzOCAxMTY1IGMtMTkwIC00OCAtMzU2IC0yMTYgLTM5OCAtNDAwIC0xNSAtNjQgLTE1IC0xODYgMCAtMjUwIDMxIC0xMzcgMTUxIC0yOTAgMjc3IC0zNTQgMTczIC04NyAzODcgLTc4IDUzOCAyMyAyMTkgMTQ2IDMwNiA0MDcgMjE2IDY0NyAtNTUgMTQ0IC0xODEgMjY4IC0zMjYgMzIwIC03OCAyNyAtMjI3IDM0IC0zMDcgMTR6IG0yMTcgLTI5NSBjNDggLTE5IDEwNCAtNzEgMTI5IC0xMjEgMTExIC0yMjMgLTE0NyAtNDQ5IC0zNTQgLTMxMCAtMTc2IDExOCAtMTMwIDM4MiA3OCA0MzcgNDUgMTIgMTA1IDkgMTQ3IC02eiIvPjxwYXRoIGQ9Ik0zODA2IDExNjQgYy0xMzMgLTMyIC0yNzggLTE0NiAtMzQzIC0yNzAgLTExMyAtMjEzIC03NSAtNDYyIDk3IC02MzQgMjEzIC0yMTMgNTQyIC0yMTQgNzU0IC00IDM1IDM1IDc4IDg4IDk1IDExOCAzOCA2NiA3MSAxOTAgNzEgMjY2IDAgNzYgLTMzIDIwMCAtNzEgMjY2IC0xNyAzMCAtNjAgODMgLTk1IDExOCAtMTM0IDEzMyAtMzIzIDE4NSAtNTA4IDE0MHogbTE5NSAtMjg4IGM0OCAtOCAxMTIgLTU2IDE0NiAtMTA4IDI1IC0zOCAyOCAtNTIgMjggLTEyOCAwIC03NiAtMyAtOTAgLTI3IC0xMjcgLTUxIC03OCAtMTE4IC0xMTUgLTIwOSAtMTE1IC0xMDkgMCAtMjAzIDY5IC0yMzMgMTczIC0yMCA2NSAtMjAgNzMgMCAxMzggMTYgNTYgNjkgMTIzIDExNyAxNDcgMzIgMTcgMTA0IDMzIDEyNyAyOSA4IC0yIDMxIC02IDUxIC05eiIvPjwvZz48L3N2Zz5gOwogICAgfSwKICB9LAogIHdhdGNoOiB7CiAgICBzY3JvbGxQb3NpdGlvbigpIHsKICAgICAgaWYgKHRoaXMuc2Nyb2xsUG9zaXRpb24gPiAxNTApIHsKICAgICAgICB0aGlzLnZpc2libGVfY3VzdG9tX2dyZWV0aW5nc19idXR0b20gPSB0cnVlOwogICAgICB9IGVsc2UgaWYgKHRoaXMuc2Nyb2xsUG9zaXRpb24gPCAxNTApIHsKICAgICAgICB0aGlzLnZpc2libGVfY3VzdG9tX2dyZWV0aW5nc19idXR0b20gPSBmYWxzZTsKICAgICAgfQogICAgfSwKICAgIHRvX3NlbmQoKSB7CiAgICAgIHRoaXMuYnV0dG9uX2ZpbGwoKTsKICAgIH0sCiAgICBjaGF0KCkgewogICAgICB0aGlzLnNjcm9sbF9kb3duKCk7CiAgICB9LAogIH0sCiAgYmVmb3JlQ3JlYXRlZCgpIHsKICAgIGxldCByb3V0ZV9wYXJhbXMgPSB0aGlzLiRyb3V0ZS5wYXJhbXM7CiAgICBpZiAocm91dGVfcGFyYW1zLnJlbG9hZCA9PT0gdHJ1ZSkgewogICAgICB0aGlzLiRyb3V0ZXIuZ28oKTsKICAgIH0KICB9LAogIGJlZm9yZURlc3Ryb3koKSB7CiAgICBpZiAodGhpcy5saXZlX2NoYXRfb24pIHRoaXMuZGlzY29ubmVjdF9zdXBwb3J0X2NoYXQoKTsKICB9LAogIGNyZWF0ZWQoKSB7CiAgICB0aGlzLmxvYWRfd2lkZ2V0X3NldHRpbmdzKCk7CiAgICBsZXQgYm90X3RlbXBsYXRlc19kYXRhID0gdGhpcy4kc2Vzc2lvbi5nZXQoIkJvdFRlbXBsYXRlcyIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBib3RfdGVtcGxhdGVzX2RhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKAogICAgICAgIGJvdF90ZW1wbGF0ZXNfZGF0YVtpXS5kb21haW4gPT09ICJSZXRhaWwiICYmCiAgICAgICAgYm90X3RlbXBsYXRlc19kYXRhW2ldLnN1YnNjcmliZWQgPT09IHRydWUKICAgICAgKSB7CiAgICAgICAgdGhpcy5pc19yZXRhaWxfYm90ID0gdHJ1ZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgaWYgKHRoaXMuJHNlc3Npb24uaGFzKCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iKSkgewogICAgICAvLyB0aGlzLmNoYXQgPSB0aGlzLiRzZXNzaW9uLmdldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIik7CiAgICB9CiAgICAvLyBpZiAoIXRoaXMuJHNlc3Npb24uaGFzKCJDaGF0Qm90SW1hZ2VQYXJhbWV0ZXJzIikpIHsKICAgIC8vIH0gZWxzZSB7CiAgICAvLyAgIHRoaXMuY2hhdF93aWRnZXQgPSB0aGlzLiRzZXNzaW9uLmdldCgiQ2hhdEJvdEltYWdlUGFyYW1ldGVycyIpOwogICAgLy8gICB0aGlzLmNoYXRfd2lkZ2V0LnN0eWxlID0gIm1hcmdpbi10b3A6IDVweDtoZWlnaHQ6MzBweDt3aWR0aDphdXRvO21hcmdpbi1sZWZ0OiBhdXRvO21hcmdpbi1yaWdodDogMDsiOwogICAgLy8gfQogICAgaWYgKCF0aGlzLmlzUHJldmlld0JvdCkgewogICAgICBpZiAoIXRoaXMuJHNlc3Npb24uaGFzKCJCb3RUb2tlbiIpKSB7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5ib3RfcmVzcG9uc2VfdG9rZW4oKSwgewogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICBpZiAodGhpcy5hcGlfc3RhdHVzX2NvZGUuU1RBVFVTX1NVQ0NFU1NfQ09SRS5NU0dfQ09ERSA9PT0gcmVzcG9uc2UuZGF0YS5tZXNzYWdlLk1TR19DT0RFKXsKICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgiQm90VG9rZW4iLCByZXNwb25zZS5kYXRhLmRhdGEpOwogICAgICAgICAgICAgIHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlID0gcmVzcG9uc2UuZGF0YS5kYXRhOwogICAgICAgICAgICAgIHRoaXMucmVmcmVzaF9jaGF0Ym90KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlID0gdGhpcy4kc2Vzc2lvbi5nZXQoIkJvdFRva2VuIik7CiAgICAgICAgdGhpcy5yZWZyZXNoX2NoYXRib3QoKTsKICAgICAgfQogICAgfQogICAgdmFyIGQgPSBuZXcgRGF0ZSgpOwogICAgYXhpb3MKICAgICAgLnBvc3QoYXBpX2NhbGxzLmJvdF91c2VyX2RhdGEoKSwgewogICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgdHo6IEludGwuRGF0ZVRpbWVGb3JtYXQoKS5yZXNvbHZlZE9wdGlvbnMoKS50aW1lWm9uZSwKICAgICAgICBkYXRldGltZTogZC50b0lTT1N0cmluZygpLAogICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICB9KQogICAgICAudGhlbigocmVzcG9uc2UpID0+IHt9KTsKICB9LAogIGJlZm9yZURlc3Ryb3koKSB7CiAgICB0aGlzLiRmb3JjZVVwZGF0ZSgpOwogIH0sCiAgbW91bnRlZCgpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKAogICAgICAic2Nyb2xsIiwKICAgICAgZnVuY3Rpb24gKGV2KSB7CiAgICAgICAgaWYgKGV2LnRhcmdldC5pZCA9PT0gInBvcnRhbF9jaGF0X2JvZHlfaWQiKSB7CiAgICAgICAgICB2bS5zY3JvbGxQb3NpdGlvbiA9IGV2LnRhcmdldFsic2Nyb2xsVG9wIl07CiAgICAgICAgfQogICAgICB9LAogICAgICB0cnVlCiAgICApOwogICAgLy8gbGV0IHJlY2FwdGNoYVNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpCiAgICAvLyByZWNhcHRjaGFTY3JpcHQuc2V0QXR0cmlidXRlKCdzcmMnLCAnaHR0cHM6Ly9zZGtzLnNob3BpZnljZG4uY29tL2J1eS1idXR0b24vbGF0ZXN0L2J1eWJ1dHRvbi5qcycpCiAgICAvLyBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHJlY2FwdGNoYVNjcmlwdCkKICAgIC8vIGNvbnN0IHBsdWdpbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgLy8gcGx1Z2luLnNldEF0dHJpYnV0ZSgKICAgIC8vICAgInNyYyIsCiAgICAvLyAgICJodHRwczovL3Nka3Muc2hvcGlmeWNkbi5jb20vYnV5LWJ1dHRvbi9sYXRlc3QvYnV5YnV0dG9uLmpzIgogICAgLy8gKTsKICAgIC8vIHBsdWdpbi5hc3luYyA9IHRydWU7CiAgICAvLyBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHBsdWdpbik7CiAgICB0aGlzLnNob3cgPSBmYWxzZTsKICAgIGlmICh0aGlzLiRyb3V0ZS5uYW1lID09ICJUcmFpbiB0aGUgQm90IikgewogICAgICAkKCIuY2hhdC13cmFwIikuY3NzKCJyaWdodCIsICJhdXRvIik7CiAgICB9CiAgICBpZiAodGhpcy4kcm91dGUubmFtZSA9PSAiRGlyZWN0IFJlc3BvbnNlIEJvdCIpIHsKICAgICAgJCgiLmNoYXQtd3JhcCIpLmNzcygibWFyZ2luVG9wIiwgIjUlIik7CiAgICB9CiAgICB3aW5kb3cuU3BlZWNoUmVjb2duaXRpb24gPQogICAgICB3aW5kb3cud2Via2l0U3BlZWNoUmVjb2duaXRpb24gfHwgd2luZG93LlNwZWVjaFJlY29nbml0aW9uOwogICAgd2luZG93LkF1ZGlvQ29udGV4dCA9IHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dDsKICAgIG5hdmlnYXRvci5nZXRVc2VyTWVkaWEgPQogICAgICBuYXZpZ2F0b3IuZ2V0VXNlck1lZGlhIHx8CiAgICAgIG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEgfHwKICAgICAgbmF2aWdhdG9yLm1vekdldFVzZXJNZWRpYSB8fAogICAgICBuYXZpZ2F0b3IubXNHZXRVc2VyTWVkaWE7CgogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBzb21lTGlzdGVuZXIpOwoKICAgIGZ1bmN0aW9uIHNvbWVMaXN0ZW5lcihldmVudCkgewogICAgICBsZXQgZWxlbWVudCA9IGV2ZW50LnRhcmdldDsKICAgICAgaWYgKAogICAgICAgIChlbGVtZW50LnRhZ05hbWUgPT0gIkkiIHx8IGVsZW1lbnQudGFnTmFtZSA9PSAiQSIpICYmCiAgICAgICAgZWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoImZhLWNsaXBib2FyZCIpCiAgICAgICkgewogICAgICAgIHZhciBtc2cgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgiZGF0YS1jb3B5LWNvbnRlbnQiKTsKICAgICAgICB2YXIgdGVtcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRleHRhcmVhIik7CiAgICAgICAgdmFyIHRlbXBNc2cgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShtc2cpOwogICAgICAgIHRlbXAuYXBwZW5kQ2hpbGQodGVtcE1zZyk7CgogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGVtcCk7CiAgICAgICAgdGVtcC5zZWxlY3QoKTsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiY29weSIpOwogICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGVtcCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuJHJvb3QuJGVtaXQoImNoYW5nZV9zaWRlYmFyX21haW5fbWVudSIsICJTaW11bGF0ZSBJbnRlcmFjdGlvbiIpOwoKICAgIC8vVG8gaGlkZSBjZW5zZSBjYXJ0IGlmIGNsaWNrZWQgb3V0c2lkZQogICAgZG9jdW1lbnQub25jbGljayA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIGlmIChlLnRhcmdldC5jbG9zZXN0KCIjY2FydC1ib3giKSB8fCBlLnRhcmdldC5jbG9zZXN0KCIjY3VzdG9tLWNhcnQiKSkgewogICAgICB9IGVsc2UgewogICAgICAgIHZtLmlzX2NlbnNlX2NhcnQgPSBmYWxzZTsKICAgICAgfQogICAgfTsKICB9LAogIG1ldGhvZHM6IHsKICAgIGxvYWRfd2lkZ2V0X3NldHRpbmdzKCkgewogICAgICBheGlvcwogICAgICAgIC5wb3N0KAogICAgICAgICAgYXBpX2NhbGxzLmdldF93aWRnZXRfc2V0dGluZ3MoKSwKICAgICAgICAgIHsKICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLmNvbXBhbnluYW1lLAogICAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLmNvbXBhbnlpZCwKICAgICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICAgIGlzU2hvdzogdHJ1ZSwKICAgICAgICAgIH0sCiAgICAgICAgICB7CiAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgICAgfSwKICAgICAgICAgIH0KICAgICAgICApCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICBpZih0aGlzLmFwaV9zdGF0dXNfY29kZS5EQVRBX0FWQUlMQUJMRS5NU0dfQ09ERSA9PT0gcmVzcG9uc2UuZGF0YS5tZXNzYWdlLk1TR19DT0RFKSB7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQudGl0bGUgPSByZXNwb25zZS5kYXRhLmRhdGEuV2lkZ2V0VGl0bGU7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQubG9nbyA9IHJlc3BvbnNlLmRhdGEuZGF0YS5JbWFnZVVybDsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fdGhlbWUgPSByZXNwb25zZS5kYXRhLmRhdGEuQnV0dG9uVGhlbWU7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX2JvcmRlcl90aGVtZSA9CiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5kYXRhLkJ1dHRvbkJvcmRlclRoZW1lID09PSBudWxsCiAgICAgICAgICAgICAgICA/IHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX2JvcmRlcl90aGVtZQogICAgICAgICAgICAgICAgOiByZXNwb25zZS5kYXRhLmRhdGEuQnV0dG9uQm9yZGVyVGhlbWU7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQudXNlcl9yZXNwb25zZV9iZ19jb2xvciA9CiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5kYXRhLlVzZXJSZXNwb25zZUJnQ29sb3IgPT09IG51bGwKICAgICAgICAgICAgICAgID8gdGhpcy5jaGF0X3dpZGdldC51c2VyX3Jlc3BvbnNlX2JnX2NvbG9yCiAgICAgICAgICAgICAgICA6IHJlc3BvbnNlLmRhdGEuZGF0YS5Vc2VyUmVzcG9uc2VCZ0NvbG9yOwogICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9yZXNwb25zZV9iZ19jb2xvciA9CiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5kYXRhLkJvdFJlc3BvbnNlQmdDb2xvciA9PT0gbnVsbAogICAgICAgICAgICAgICAgPyB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9yZXNwb25zZV9iZ19jb2xvcgogICAgICAgICAgICAgICAgOiByZXNwb25zZS5kYXRhLkJvdFJlc3BvbnNlQmdDb2xvcjsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5kZWxpdmVyeV9ub3RlX2NvbG9yID0KICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmRhdGEuRGVsaXZlcnlOb3RlQ29sb3IgPT09IG51bGwKICAgICAgICAgICAgICAgID8gdGhpcy5jaGF0X3dpZGdldC5kZWxpdmVyeV9ub3RlX2NvbG9yCiAgICAgICAgICAgICAgICA6IHJlc3BvbnNlLmRhdGEuZGF0YS5EZWxpdmVyeU5vdGVDb2xvcjsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfZm9udF9zdHlsZSA9IHJlc3BvbnNlLmRhdGEuZGF0YS5Cb3RGb250LkZvbnRTdHlsZTsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9zZW5kZXIgPQogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZGF0YS5Cb3RGb250LkZvbnRDb2xvclNlbmRlcjsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9yZWNlaXZlciA9CiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5kYXRhLkJvdEZvbnQuRm9udENvbG9yUmVjZWl2ZXI7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X2ZvbnRfY29sb3JfYnV0dG9ucyA9CiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5kYXRhLkJvdEZvbnQuRm9udENvbG9yQnV0dG9uczsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfdGhlbWUgPSByZXNwb25zZS5kYXRhLkJvdFRoZW1lOwogICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmlzX3Bvd2VyZWRfYnlfY2Vuc2UgPQogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZGF0YS5Jc1Bvd2VyZWRCeUNlbnNlID09PSB1bmRlZmluZWQKICAgICAgICAgICAgICAgID8gdGhpcy5jaGF0X3dpZGdldC5pc19wb3dlcmVkX2J5X2NlbnNlCiAgICAgICAgICAgICAgICA6IHJlc3BvbnNlLmRhdGEuZGF0YS5Jc1Bvd2VyZWRCeUNlbnNlOwogICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJ1dHRvbl9hbGlnbm1lbnQgPSByZXNwb25zZS5kYXRhLmRhdGEuQm90U3R5bGluZzsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfaWNvbiA9IHJlc3BvbnNlLmRhdGEuZGF0YS5Cb3RJbWFnZVVybDsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fdmVydGljYWxfc3BhY2luZyA9CiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5kYXRhLkJ1dHRvblN0eWxpbmcudmVydGljYWw7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX2hvcml6b250YWxfc3BhY2luZyA9CiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5kYXRhLkJ1dHRvblN0eWxpbmcuaG9yaXpvbnRhbDsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfYmFja2dyb3VuZF9pbWFnZSA9IHJlc3BvbnNlLmRhdGEuZGF0YS5CZ0ltYWdlVXJsOwogICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmhlYWRlcl9iYWNrZ3JvdW5kID0gcmVzcG9uc2UuZGF0YS5kYXRhLkhlYWRlclRoZW1lOwogICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgbGV0IGlzX3Zpc2libGVfZ3JlZXRpbmdzID0KICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXMubWFwKChpdGVtKSA9PiB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBpdGVtLnZpc2libGUgIT09IHVuZGVmaW5lZCA/IGl0ZW0udmlzaWJsZSA6IHRydWU7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAoaXNfdmlzaWJsZV9ncmVldGluZ3MuaW5jbHVkZXModHJ1ZSkpIHsKICAgICAgICAgICAgICAgIHRoaXMuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbiA9CiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgQm9vbGVhbigKICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzWwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgXVsiYnV0dG9ucyJdCiAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICB2YXIgdmlzaWJsZV9idXR0b25zID0KICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzWwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgXVsiYnV0dG9ucyJdOwogICAgICAgICAgICAgICAgICB2aXNpYmxlX2J1dHRvbnMgPSB2aXNpYmxlX2J1dHRvbnMuZmlsdGVyKChidXR0b24pID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYnV0dG9uWyJ2aXNpYmxlIl0gPT09IHRydWU7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzWwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbgogICAgICAgICAgICAgICAgICBdWyJidXR0b25zIl0gPSB2aXNpYmxlX2J1dHRvbnM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCB2aXNpYmxlX2dyZWV0aW5nc19tYXAgPSBpc192aXNpYmxlX2dyZWV0aW5ncy5yZWR1Y2UoCiAgICAgICAgICAgICAgICAgIChhY2MsIGUpID0+IGFjYy5zZXQoZSwgKGFjYy5nZXQoZSkgfHwgMCkgKyAxKSwKICAgICAgICAgICAgICAgICAgbmV3IE1hcCgpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgbGV0IHNwbGljZV9pbmRleCA9IFtdOwogICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICB2aXNpYmxlX2dyZWV0aW5nc19tYXAuZ2V0KHRydWUpICE9PQogICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzLmxlbmd0aAogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzWwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgXS52aXNpYmxlID09PSBmYWxzZQogICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgZm9yICgKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGkgPQogICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgaSA+PSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpLS0KICAgICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlc1tpXS52aXNpYmxlID09PQogICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXNbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpIC0gMSA8IDAgPyBpIDogaSAtIDEKICAgICAgICAgICAgICAgICAgICAgICAgICBdWyJidXR0b25zIl0gPSB2aXNpYmxlX2J1dHRvbnM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ3JlZXRpbmdfYnV0dG9uc19wb3NpdGlvbiAtIDEgPCAwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gdGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uIC0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICBzcGxpY2VfaW5kZXgucHVzaChpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoCiAgICAgICAgICAgICAgICAgICAgICBsZXQgaSA9CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICAgIGkgPj0gMDsKICAgICAgICAgICAgICAgICAgICAgIGktLQogICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLmRhdGEuQm90R3JlZXRpbmdzLmRhdGEucmVzcG9uc2VzW2ldLnZpc2libGUgPT09CiAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uID0KICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdyZWV0aW5nX2J1dHRvbnNfcG9zaXRpb24gLSAxIDwgMAogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyB0aGlzLmdyZWV0aW5nX2J1dHRvbnNfcG9zaXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdGhpcy5ncmVldGluZ19idXR0b25zX3Bvc2l0aW9uIC0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgc3BsaWNlX2luZGV4LnB1c2goaSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBzcGxpY2VfaW5kZXgubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5kYXRhLkJvdEdyZWV0aW5ncy5kYXRhLnJlc3BvbnNlcy5zcGxpY2UoCiAgICAgICAgICAgICAgICAgICAgICBzcGxpY2VfaW5kZXhbaW5kZXhdLAogICAgICAgICAgICAgICAgICAgICAgMQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMucHVzaF9tc2coCiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZGF0YS5Cb3RHcmVldGluZ3MsCiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEuZGF0YS5Cb3RHcmVldGluZ3MuZGF0YS5yZXNwb25zZXMKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICh0aGlzLmlzX3JldGFpbF9ib3QpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9hZF9jaGF0Ym90X2ludGVncmF0aW9uX2RldGFpbHMoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX2FsaWdubWVudCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fYWxpZ25tZW50ID0gImZsZXgtZW5kIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5jaGF0X3dpZGdldC5ib3RfaWNvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfaWNvbiA9ICIvaW1nL0JvdF9pbWcucG5nIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgiQ2hhdEJvdEltYWdlUGFyYW1ldGVycyIsIHRoaXMuY2hhdF93aWRnZXQpOwogICAgICAgICAgICBsZXQgc3R5bGluZ192YWx1ZSA9IHJlc3BvbnNlLmRhdGEuZGF0YS5IZWFkZXJTdHlsaW5nLnZhbHVlOwogICAgICAgICAgICBsZXQgdGVtcF9zdHJpbmcgPSAiIjsKICAgICAgICAgICAgaWYgKHN0eWxpbmdfdmFsdWUgPT09ICJsZWZ0IikgewogICAgICAgICAgICAgIHRlbXBfc3RyaW5nID0gIm1hcmdpbi1sZWZ0OiAwO21hcmdpbi1yaWdodDogYXV0bzsiOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0eWxpbmdfdmFsdWUgPT09ICJyaWdodCIpIHsKICAgICAgICAgICAgICB0ZW1wX3N0cmluZyA9ICJtYXJnaW4tbGVmdDogYXV0bzttYXJnaW4tcmlnaHQ6IDA7IjsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdHlsaW5nX3ZhbHVlID09PSAiY2VudGVyIikgewogICAgICAgICAgICAgIHRlbXBfc3RyaW5nID0gIm1hcmdpbi1sZWZ0OiBhdXRvO21hcmdpbi1yaWdodDogYXV0bzsiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRlbXBfc3RyaW5nID0gIm1hcmdpbi1sZWZ0OiBhdXRvO21hcmdpbi1yaWdodDogYXV0bzsiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuc3R5bGUgPQogICAgICAgICAgICAgICJtYXJnaW4tdG9wOiA1cHg7aGVpZ2h0OjMwcHg7d2lkdGg6YXV0bzttYXgtd2lkdGg6MTAwJSAhaW1wb3J0YW50OyIgKwogICAgICAgICAgICAgIHRlbXBfc3RyaW5nOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICBpZiAodGhpcy5pc19yZXRhaWxfYm90KSB7CiAgICAgICAgICAgIHRoaXMubG9hZF9jaGF0Ym90X2ludGVncmF0aW9uX2RldGFpbHMoKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnNvbGUubG9nKGUucmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICBpZiAoZS5yZXNwb25zZSkgewogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQxMCB8fAogICAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0NDAgfHwKICAgICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA5CiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHRoaXMuJHJvb3QuJGVtaXQoIlNlc3Npb25fRXhwaXJlZCIsIGUucmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQubG9nbyA9ICIvaW1nL2NlbnNlX2ltYWdlLnBuZyI7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuc3R5bGUgPQogICAgICAgICAgICAgICJtYXJnaW4tdG9wOiA1cHg7aGVpZ2h0OjMwcHg7d2lkdGg6NjBweDttYXJnaW4tbGVmdDogYXV0bzttYXJnaW4tcmlnaHQ6IGF1dG87IjsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfaWNvbiA9ICIvaW1nL0JvdF9pbWcucG5nIjsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fdmVydGljYWxfc3BhY2luZyA9ICI1IjsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25faG9yaXpvbnRhbF9zcGFjaW5nID0gIjMiOwogICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJvdF9iYWNrZ3JvdW5kX2ltYWdlID0gIiI7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuaGVhZGVyX2JhY2tncm91bmQgPSAiI2ZmZmZmZiI7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYnV0dG9uX3RoZW1lID0gIiMxZGFhZTEiOwogICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmJvdF90aGVtZSA9ICIjMjczNjc5IjsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5idXR0b25fYm9yZGVyX3RoZW1lID0gIiMyNzM2NzkiOwogICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LnVzZXJfcmVzcG9uc2VfYmdfY29sb3IgPSAiIzI3MzY3OSI7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X3Jlc3BvbnNlX2JnX2NvbG9yID0gIiNmZmZmZmYiOwogICAgICAgICAgICB0aGlzLmNoYXRfd2lkZ2V0LmRlbGl2ZXJ5X25vdGVfY29sb3IgPSAiIzI3MzY3OSI7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X2ZvbnRfc3R5bGUgPSAiUm9ib3RvIjsKICAgICAgICAgICAgdGhpcy5jaGF0X3dpZGdldC5ib3RfZm9udF9jb2xvcl9zZW5kZXIgPSAiI2ZmZmZmZiI7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X2ZvbnRfY29sb3JfcmVjZWl2ZXIgPSAiIzAwMDAwMCI7CiAgICAgICAgICAgIHRoaXMuY2hhdF93aWRnZXQuYm90X2ZvbnRfY29sb3JfYnV0dG9ucyA9ICIjZmZmZmZmIjsKICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoIkNoYXRCb3RJbWFnZVBhcmFtZXRlcnMiLCB0aGlzLmNoYXRfd2lkZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCiAgICBsb2FkX2NoYXRib3RfaW50ZWdyYXRpb25fZGV0YWlscygpIHsKICAgICAgYXhpb3MKICAgICAgICAucG9zdCgKICAgICAgICAgIGFwaV9jYWxscy5jaGF0Ym90X2ludGVncmF0aW9uX2RldGFpbHMoKSwKICAgICAgICAgIHsKICAgICAgICAgICAgaXNfZ2V0OiB0cnVlLAogICAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICAgICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnRva2VucywKICAgICAgICAgIH0sCiAgICAgICAgICB7CiAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgICAgfSwKICAgICAgICAgIH0KICAgICAgICApCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5tZXNzYWdlLk1TR19DT0RFID09PSB0aGlzLmFwaV9zdGF0dXNfY29kZS5EQVRBX0FWQUlMQUJMRS5NU0dfQ09ERSkgewogICAgICAgICAgICB0aGlzLmNoYXRib3RfaW50ZWdyYXRpb25fZGV0YWlsc19yZXNwb25zZShyZXNwb25zZSk7CiAgICAgICAgICB9IAogICAgICAgICAgZWxzZSBpZiAodGhpcy5hcGlfc3RhdHVzX2NvZGUuRU1QVFlfREFUQS5NU0dfQ09ERSA9PSByZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHX0NPREUpIHsKCiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgU3dhbCh7CiAgICAgICAgICAgICAgdGl0bGU6IHJlc3BvbnNlLmRhdGEubWVzc2FnZS5NU0dfQ09ERSwKICAgICAgICAgICAgICB0ZXh0OiByZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHLAogICAgICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgICAgICBwb3NpdGlvbjogInRvcC1lbmQiLAogICAgICAgICAgICAgIHR5cGU6ICJlcnJvciIKICAgICAgICAgICAgfSkKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgLy8gdGhpcy5zaG9waWZ5X3JldGFpbF9zaG9wX25hbWUgPSAiZWFydGhvbiI7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MTAgfHwKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQ0MCB8fAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA5CiAgICAgICAgICApIHsKICAgICAgICAgICAgdGhpcy4kcm9vdC4kZW1pdCgiU2Vzc2lvbl9FeHBpcmVkIiwgZS5yZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgIC5wb3N0KAogICAgICAgICAgICAgICAgICBhcGlfY2FsbHMuY2hhdGJvdF9pbnRlZ3JhdGlvbl9kZXRhaWxzKCksCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpc19nZXQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLmNvbXBhbnluYW1lLAogICAgICAgICAgICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICAgICAgICAgICAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgICAgICAgICAgbGljZW5zZV9rZXk6CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICAgICAgdG9rZW46IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS50b2tlbnMsCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEubWVzc2FnZS5NU0dfQ09ERSA9PT0gdGhpcy5hcGlfc3RhdHVzX2NvZGUuREFUQV9BVkFJTEFCTEUuTVNHX0NPREUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXRib3RfaW50ZWdyYXRpb25fZGV0YWlsc19yZXNwb25zZShyZXNwb25zZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5hcGlfc3RhdHVzX2NvZGUuRU1QVFlfREFUQS5NU0dfQ09ERSA9PSByZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHX0NPREUpIHsKCiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgU3dhbCh7CiAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogcmVzcG9uc2UuZGF0YS5tZXNzYWdlLk1TR19DT0RFLAogICAgICAgICAgICAgICAgICAgICAgdGV4dDogcmVzcG9uc2UuZGF0YS5tZXNzYWdlLk1TRywKICAgICAgICAgICAgICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogInRvcC1lbmQiLAogICAgICAgICAgICAgICAgICAgICAgdHlwZTogImVycm9yIgogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCiAgICBjaGF0Ym90X2ludGVncmF0aW9uX2RldGFpbHNfcmVzcG9uc2UocmVzcG9uc2UpIHsKICAgICAgdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9IHJlc3BvbnNlLmRhdGEuZGF0YS5yZXRhaWxfd2ViX2ZyYW1ld29yazsKICAgICAgdmFyIHdlYmZyYW1ld29yayA9CiAgICAgICAgcmVzcG9uc2UuZGF0YS5kYXRhW3RoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgKyAiX2RldGFpbHMiXTsKICAgICAgdGhpcy5zaG93X2N1c3RvbV9jYXJ0ID0gdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayAhPSBudWxsID8gdHJ1ZSA6IGZhbHNlOwogICAgICBpZiAod2ViZnJhbWV3b3JrICE9PSBudWxsICYmIHdlYmZyYW1ld29yayAhPT0ge30pIHsKICAgICAgICB0aGlzLnJldGFpbF9zaG9wX2N1cnJlbmN5ID0gd2ViZnJhbWV3b3JrLmJhc2VfY3VycmVuY3kudmFsdWUgfHwgIlVTRCI7CiAgICAgICAgdGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQgPQogICAgICAgICAgd2ViZnJhbWV3b3JrLm9yZGVyX3JldHJpZXZhbF9vbmx5X2VtYWlsX3JlcXVpcmVkIHx8IGZhbHNlOwogICAgICAgIHRoaXMuY29udGFjdF9oZWxwX2VtYWlsID0gd2ViZnJhbWV3b3JrLmNvbnRhY3RfaGVscF9lbWFpbDsKICAgICAgICB0aGlzLnJldmlld19yZXNwb25zZV9tZXNzYWdlID0gd2ViZnJhbWV3b3JrLnJldmlld19yZXNwb25zZV9tZXNzYWdlOwogICAgICAgIHRoaXMucmV2aWV3X21lc3NhZ2VfZmlyc3QgPSB3ZWJmcmFtZXdvcmsucmV2aWV3X21lc3NhZ2VfZmlyc3Q7CiAgICAgICAgdGhpcy5yZXZpZXdfbWVzc2FnZV9zZWNvbmQgPSB3ZWJmcmFtZXdvcmsucmV2aWV3X21lc3NhZ2Vfc2Vjb25kOwogICAgICAgIHRoaXMuZGlzcGxheV9wcm9kdWN0c19vbl9sYW5kaW5nID0KICAgICAgICAgIHdlYmZyYW1ld29yay5kaXNwbGF5X3Byb2R1Y3RzX29uX2xhbmRpbmc7CiAgICAgICAgdGhpcy5pc19kaXNwbGF5X2Jhbm5lcl9vbl9sYW5kaW5nID0KICAgICAgICAgIHdlYmZyYW1ld29yay5pc19kaXNwbGF5X2Jhbm5lcl9vbl9sYW5kaW5nOwogICAgICAgIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJzaG9waWZ5IikgewogICAgICAgICAgdGhpcy5zaG9waWZ5X3JldGFpbF9zaG9wX25hbWUgPSB3ZWJmcmFtZXdvcmsuc2hvcGlmeV9zaG9wX25hbWU7CiAgICAgICAgICB0aGlzLmN1c3RvbV9wcm9kdWN0X2J1dHRvbl9rZXkgPQogICAgICAgICAgICB3ZWJmcmFtZXdvcmsuY3VzdG9tX3Byb2R1Y3RfYnV0dG9uX2tleSA9PSB1bmRlZmluZWQgfHwgbnVsbAogICAgICAgICAgICAgID8gW10KICAgICAgICAgICAgICA6IHdlYmZyYW1ld29yay5jdXN0b21fcHJvZHVjdF9idXR0b25fa2V5OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnNob3BfdXJsID0gd2ViZnJhbWV3b3JrW3RoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgKyAiX3Nob3BfdXJsIl07CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIHNldFRpbWVvdXQoKCkgPT4gewogICAgICBpZiAoIXRoaXMuaXNQcmV2aWV3Qm90KSB7CiAgICAgICAgdGhpcy5nZXRfdmlzaXRvcnNfY3VycmVudF9sb2NhdGlvbigpOwogICAgICB9IGVsc2UgaWYgKEJvb2xlYW4odGhpcy5jdXJyZW50X3ByZXZpZXdfYmFubmVyX2lkKSkgewogICAgICAgIHRoaXMucHJldmlld19iYW5uZXIoKTsKICAgICAgfQogICAgICAvLyB9LCAzMDAwKTsKICAgIH0sCiAgICB1cGRhdGVfdmFyaWF0aW9uKGNoYXRfaWQsIHByb2R1Y3RfaW5kZXgsIHRpdGxlKSB7CiAgICAgIGZvciAodmFyIGkgaW4gdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0KICAgICAgICAudmFyaWF0aW9ucykgewogICAgICAgIGlmICgKICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnZhcmlhdGlvbnNbaV0KICAgICAgICAgICAgLnZhcmlhbnRfdGl0bGUgPT0gdGl0bGUKICAgICAgICApIHsKICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLmltZ191cmwgPQogICAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYXRpb25zWwogICAgICAgICAgICAgIGkKICAgICAgICAgICAgXS5pbWdfdXJsOwogICAgICAgICAgaWYodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAnYmlnY29tbWVyY2UnKSB7CiAgICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnNrdSA9CiAgICAgICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9uc1tpXS5za3U7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS5pZCA9CiAgICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnZhcmlhdGlvbnNbaV0uaWQ7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS5wZXJtYWxpbmsgPQogICAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYXRpb25zWwogICAgICAgICAgICAgIGkKICAgICAgICAgICAgXS5wZXJtYWxpbms7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS5wcmljZSA9CiAgICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnZhcmlhdGlvbnNbaV0ucHJpY2U7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS5yZWd1bGFyX3ByaWNlID0KICAgICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9uc1sKICAgICAgICAgICAgICBpCiAgICAgICAgICAgIF0ucmVndWxhcl9wcmljZTsKICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W3Byb2R1Y3RfaW5kZXhdLnN0b2NrX3F1YW50aXR5ID0KICAgICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9uc1sKICAgICAgICAgICAgICBpCiAgICAgICAgICAgIF0uc3RvY2tfcXVhbnRpdHk7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS5zdG9ja19zdGF0dXMgPQogICAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYXRpb25zWwogICAgICAgICAgICAgIGkKICAgICAgICAgICAgXS5zdG9ja19zdGF0dXM7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYW50X3RpdGxlID0KICAgICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbcHJvZHVjdF9pbmRleF0udmFyaWF0aW9uc1sKICAgICAgICAgICAgICBpCiAgICAgICAgICAgIF0udmFyaWFudF90aXRsZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gY29uc3QgZm91bmQgPSB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYXRpb25zLnNvbWUoZWwgPT4gZWwudmFyaWFudF90aXRsZSA9PSAiRGVmYXVsdCIpOwogICAgICAvLyBpZiAoIWZvdW5kKSB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtwcm9kdWN0X2luZGV4XS52YXJpYXRpb25zLnB1c2goZGVmYXVsdF92YWx1ZXMpOwogICAgfSwKICAgIGN1c3RvbV9ncmVldGluZ3NfYnV0dG9tX2FsaWdubWVudChzaG93X2N1c3RvbV9jYXJ0KSB7CiAgICAgIGlmIChzaG93X2N1c3RvbV9jYXJ0KSB7CiAgICAgICAgcmV0dXJuICJjb2wtc20tMTAgcHgtMCI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICJjb2wtc20tMTIgcHgtMCI7CiAgICAgIH0KICAgIH0sCiAgICBnZXRfdmlzaXRvcnNfY3VycmVudF9sb2NhdGlvbigpIHsKICAgICAgaWYgKHRoaXMuaXNfZGlzcGxheV9iYW5uZXJfb25fbGFuZGluZyA9PT0gdHJ1ZSkgewogICAgICAgIGxldCBjdXRvZmYgPSBuZXcgRGF0ZSgpOwogICAgICAgIHZhciBkYXRlX3RpbWUgPSBtb21lbnQKICAgICAgICAgIC51dGMoY3V0b2ZmLCBbIllZWVktTU0tREQgSEg6bW06c3MiXSkKICAgICAgICAgIC5mb3JtYXQoIllZWVktTU0tREQgSEg6bW06c3MiKTsKICAgICAgICB2YXIgdm0gPSB0aGlzOwogICAgICAgICQuZ2V0SlNPTih2bS52aXNpdG9yc19jdXJyZW50X2xvY2F0aW9uX3VybCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgIHZtLnZpc2l0b3JzX2N1cnJlbnRfbG9jYXRpb24gPSB7CiAgICAgICAgICAgICAgaXBfYWRkcmVzczogZGF0YS5pcF9hZGRyZXNzLAogICAgICAgICAgICAgIGNpdHk6IGRhdGEuY2l0eSwKICAgICAgICAgICAgICBjaXR5X2dlb25hbWVfaWQ6IGRhdGEuY2l0eV9nZW9uYW1lX2lkLAogICAgICAgICAgICAgIHJlZ2lvbjogZGF0YS5yZWdpb24sCiAgICAgICAgICAgICAgcmVnaW9uX2lzb19jb2RlOiBkYXRhLnJlZ2lvbl9pc29fY29kZSwKICAgICAgICAgICAgICByZWdpb25fZ2VvbmFtZV9pZDogZGF0YS5yZWdpb25fZ2VvbmFtZV9pZCwKICAgICAgICAgICAgICBwb3N0YWxfY29kZTogZGF0YS5wb3N0YWxfY29kZSwKICAgICAgICAgICAgICBjb3VudHJ5OiBkYXRhLmNvdW50cnksCiAgICAgICAgICAgICAgY291bnRyeV9jb2RlOiBkYXRhLmNvdW50cnlfY29kZSwKICAgICAgICAgICAgICBjb3VudHJ5X2dlb25hbWVfaWQ6IGRhdGEuY291bnRyeV9nZW9uYW1lX2lkLAogICAgICAgICAgICAgIGNvdW50cnlfaXNfZXU6IGRhdGEuY291bnRyeV9pc19ldSwKICAgICAgICAgICAgICBjb250aW5lbnQ6IGRhdGEuY29udGluZW50LAogICAgICAgICAgICAgIGNvbnRpbmVudF9jb2RlOiBkYXRhLmNvbnRpbmVudF9jb2RlLAogICAgICAgICAgICAgIGNvbnRpbmVudF9nZW9uYW1lX2lkOiBkYXRhLmNvbnRpbmVudF9nZW9uYW1lX2lkLAogICAgICAgICAgICAgIGxvbmdpdHVkZTogZGF0YS5sb25naXR1ZGUsCiAgICAgICAgICAgICAgbGF0aXR1ZGU6IGRhdGEubGF0aXR1ZGUsCiAgICAgICAgICAgICAgc2VjdXJpdHk6IGRhdGEuc2VjdXJpdHksCiAgICAgICAgICAgICAgZGF0ZV90aW1lOiBkYXRlX3RpbWUsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZtLmlzX2Rpc3BsYXlfYmFubmVyKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2bS5pc19kaXNwbGF5X3Byb2R1Y3RzKCk7CiAgICAgICAgICB9CiAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24gKCkgewogICAgICAgICAgdm0uaXNfZGlzcGxheV9wcm9kdWN0cygpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuaXNfZGlzcGxheV9wcm9kdWN0cygpOwogICAgICB9CiAgICB9LAogICAgcHJldmlld19iYW5uZXIoKSB7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoCiAgICAgICAgICBhcGlfY2FsbHMuYmFubmVyX3RlbXBsYXRlKCksCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbXBhbnlfbmFtZTogdGhpcy5jb21wYW55bmFtZSwKICAgICAgICAgICAgY29tcGFueV9pZDogdGhpcy5jb21wYW55aWQsCiAgICAgICAgICAgIGVtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIHRva2VuOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikudG9rZW5zLAogICAgICAgICAgICBzdWJzY3JpcHRpb246IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5zdWJzY3JpcHRpb24sCiAgICAgICAgICAgIGlzX3ByZXZpZXdfYmFubmVyOiB0cnVlLAogICAgICAgICAgICBiYW5uZXJfaWQ6IHRoaXMuY3VycmVudF9wcmV2aWV3X2Jhbm5lcl9pZCwKICAgICAgICAgIH0sCiAgICAgICAgICB7CiAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgICAgfSwKICAgICAgICAgIH0KICAgICAgICApCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5tZXNzYWdlLk1TR19DT0RFID09PSB0aGlzLmFwaV9zdGF0dXNfY29kZS5EQVRBX0FWQUlMQUJMRV9NT0RFTFMuTVNHX0NPREUpIHsKICAgICAgICAgICAgaWYgKEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5kYXRhLnJlc3BvbnNlcy5sZW5ndGggPiAwKSkgewogICAgICAgICAgICAgIHRoaXMucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgaWYgKAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDEwIHx8CiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0NDAgfHwKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQwOQogICAgICAgICAgKSB7CiAgICAgICAgICAgIHRoaXMuJHJvb3QuJGVtaXQoIlNlc3Npb25fRXhwaXJlZCIsIGUucmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAogICAgaXNfZGlzcGxheV9iYW5uZXIoKSB7CiAgICAgIGF4aW9zCiAgICAgICAgLmdldChhcGlfY2FsbHMuYmFubmVyX3RlbXBsYXRlKCksIHsKICAgICAgICAgIHBhcmFtczogewogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIGlzX2Rpc3BsYXlfYmFubmVyOiB0cnVlLAogICAgICAgICAgICB2aXNpdG9yc19jdXJyZW50X2xvY2F0aW9uOiB0aGlzLnZpc2l0b3JzX2N1cnJlbnRfbG9jYXRpb24sCiAgICAgICAgICB9LAogICAgICAgIH0pCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5tZXNzYWdlLk1TR19DT0RFID09PSB0aGlzLmFwaV9zdGF0dXNfY29kZS5EQVRBX0FWQUlMQUJMRV9NT0RFTFMuTVNHX0NPREUpIHsKICAgICAgICAgICAgaWYgKEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5kYXRhLnJlc3BvbnNlcy5sZW5ndGggPiAwKSkgewogICAgICAgICAgICAgIHRoaXMucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuaXNfZGlzcGxheV9wcm9kdWN0cygpOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICB0aGlzLmlzX2Rpc3BsYXlfcHJvZHVjdHMoKTsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQxMCB8fAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDQwIHx8CiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MDkKICAgICAgICAgICkgewogICAgICAgICAgICB0aGlzLiRyb290LiRlbWl0KCJTZXNzaW9uX0V4cGlyZWQiLCBlLnJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKICAgIGlzX2Rpc3BsYXlfcHJvZHVjdHMoKSB7CiAgICAgIGlmICh0aGlzLmRpc3BsYXlfcHJvZHVjdHNfb25fbGFuZGluZyA9PT0gdHJ1ZSkgewogICAgICAgIGF4aW9zCiAgICAgICAgICAucG9zdChhcGlfY2FsbHMuZGlzcGxheV9sYW5kaW5nX3Byb2R1Y3RzKCksIHsKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICBpZihyZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHX0NPREUgPT09IHRoaXMuYXBpX3N0YXR1c19jb2RlLkRBVEFfQVZBSUxBQkxFX01PREVMUy5NU0dfQ09ERSkgewogICAgICAgICAgICAgIHZhciBwcm9kdWN0c19jb3VudCA9CiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5kYXRhLnJlc3BvbnNlc1swXS5wcm9kdWN0cy5wcm9kdWN0c19saXN0Lmxlbmd0aDsKICAgICAgICAgICAgICBpZiAocHJvZHVjdHNfY291bnQgPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmlzX3Jldmlld19yYXRpbmcoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBTd2FsKHsKICAgICAgICAgICAgICAgIHRpdGxlOiByZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHX0NPREUsCiAgICAgICAgICAgICAgICB0ZXh0OiByZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHLAogICAgICAgICAgICAgICAgc2hvd0NhbmNlbEJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgICAgICBzaG93Q29uZmlybUJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgICAgICB0eXBlOiAiZXJyb3IiCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgdGhpcy5pc19yZXZpZXdfcmF0aW5nKCk7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDEwIHx8CiAgICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQ0MCB8fAogICAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MDkKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdGhpcy4kcm9vdC4kZW1pdCgiU2Vzc2lvbl9FeHBpcmVkIiwgZS5yZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5pc19yZXZpZXdfcmF0aW5nKCk7CiAgICAgIH0KICAgIH0sCiAgICBpc19yZXZpZXdfcmF0aW5nKCkgewogICAgICBpZiAoCiAgICAgICAgQm9vbGVhbih0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl9pZCIpKSB8fAogICAgICAgIEJvb2xlYW4odGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iKSkKICAgICAgKSB7CiAgICAgICAgbGV0IHN0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBjdXN0b21lcklkOiB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl9pZCIpLAogICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIiksCiAgICAgICAgfSk7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICBjaGF0OiBgL3JldHJpZXZlX2N1c3RvbWVyX29yZGVycyR7c3RyaW5naWZpZWRfY3VzdG9tZXJfcGF5bG9hZH1gLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogZmFsc2UsCiAgICAgICAgICB9KQogICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgIGlmIChCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbSkpIHsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICBCb29sZWFuKAogICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1swXS5jdXN0b20ub3JkZXJzX2xpc3QubGVuZ3RoID4gMAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdGhpcy5jYWxsX3Jldmlld19yYXRpbmcoCiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbS5vcmRlcnNfbGlzdAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgY2FsbF9yZXZpZXdfcmF0aW5nKGRhdGEpIHsKICAgICAgdmFyIGZ1bGZpbGxlZF9vcmRlcnMgPSBkYXRhLmZpbHRlcigoZnVsZmlsbGVkX29yZGVyKSA9PiB7CiAgICAgICAgcmV0dXJuIGZ1bGZpbGxlZF9vcmRlci5mdWxmaWxsbWVudF9zdGF0dXMgPT09ICJmdWxmaWxsZWQiOwogICAgICB9KTsKICAgICAgdmFyIHNvcnRlZF9mdWxmaWxsZWRfb3JkZXJzID0gZnVsZmlsbGVkX29yZGVycy5tYXAoKGl0ZW0pID0+IHsKICAgICAgICByZXR1cm4gaXRlbS5saW5lX2l0ZW1zLm1hcCgocHJvZHVjdCkgPT4gewogICAgICAgICAgcmV0dXJuIHByb2R1Y3Q7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICBheGlvcwogICAgICAgIC5wb3N0KAogICAgICAgICAgYXBpX2NhbGxzLnByb2R1Y3RfcmV2aWV3X3JhdGluZygpLAogICAgICAgICAgewogICAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICAgICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIHdlYl9mcmFtZXdvcms6IHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmssCiAgICAgICAgICAgIGlzX2dldF9yZXZpZXdlZF9wcm9kdWN0X2lkOiB0cnVlLAogICAgICAgICAgICByZXZpZXdfcmF0aW5nX2N1c3RvbWVyX2lkOiB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl9pZCIpLAogICAgICAgICAgICByZXZpZXdfcmF0aW5nX2N1c3RvbWVyX2VtYWlsOiB0aGlzLiRzZXNzaW9uLmdldCgKICAgICAgICAgICAgICAic2hvcGlmeV9jdXN0b21lcl90b2tlbiIKICAgICAgICAgICAgKSwKICAgICAgICAgIH0sCiAgICAgICAgICB7CiAgICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgICAgfSwKICAgICAgICAgIH0KICAgICAgICApCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICBpZiAodGhpcy5hcGlfc3RhdHVzX2NvZGUuREFUQV9BVkFJTEFCTEUuTVNHX0NPREUgPT09IHJlc3BvbnNlLmRhdGEubWVzc2FnZS5NU0dfQ09ERSkgewogICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5kYXRhLmlzX3JldmlldyA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIHZhciByZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMgPSBbXTsKICAgICAgICAgICAgICB2YXIgbm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscyA9IFtdOwogICAgICAgICAgICAgIHZhciByZXZpZXdlZF9wcm9kdWN0X2lkX2xpc3QgPSByZXNwb25zZS5kYXRhLmRhdGEucHJvZHVjdF9pZF9saXN0OwogICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc29ydGVkX2Z1bGZpbGxlZF9vcmRlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgc29ydGVkX2Z1bGZpbGxlZF9vcmRlcnNbaV0ubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgIHJldmlld2VkX3Byb2R1Y3RfaWRfbGlzdC5pbmNsdWRlcygKICAgICAgICAgICAgICAgICAgICAgIHNvcnRlZF9mdWxmaWxsZWRfb3JkZXJzW2ldW2pdLnByb2R1Y3RfaWQKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIHJldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5wdXNoKHNvcnRlZF9mdWxmaWxsZWRfb3JkZXJzW2ldW2pdKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLnB1c2goCiAgICAgICAgICAgICAgICAgICAgICBzb3J0ZWRfZnVsZmlsbGVkX29yZGVyc1tpXVtqXQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgbm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5sZW5ndGggPiAwICYmCiAgICAgICAgICAgICAgICBCb29sZWFuKHRoaXMucmV2aWV3X21lc3NhZ2VfZmlyc3QpID09PSB0cnVlICYmCiAgICAgICAgICAgICAgICBCb29sZWFuKHRoaXMucmV2aWV3X21lc3NhZ2Vfc2Vjb25kKSA9PT0gdHJ1ZSAmJgogICAgICAgICAgICAgICAgQm9vbGVhbih0aGlzLnJldmlld19yZXNwb25zZV9tZXNzYWdlKSA9PT0gdHJ1ZQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgICAgLnBvc3QoCiAgICAgICAgICAgICAgICAgICAgYXBpX2NhbGxzLnByb2R1Y3RfcmV2aWV3X3JhdGluZygpLAogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbXBhbnlfbmFtZTogdGhpcy5jb21wYW55bmFtZSwKICAgICAgICAgICAgICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICAgICAgICAgICAgICAgICAgZW1haWw6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgICAgICAgd2ViX2ZyYW1ld29yazogdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yaywKICAgICAgICAgICAgICAgICAgICAgIGlzX2dldF9wcm9kdWN0X2ltYWdlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgcHJvZHVjdF9pZDogbm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlsc1swXS5wcm9kdWN0X2lkLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHX0NPREUgPT09IHRoaXMuYXBpX3N0YXR1c19jb2RlLklNQUdFX1JFQ0VJVkVEX1NVQ0NFU1NGVUxMWS5NU0dfQ09ERSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHByb2R1Y3RfcmV2aWV3X2ltZ191cmwgPSByZXNwb25zZS5kYXRhLmRhdGEuaW1hZ2Vfc3JjOwogICAgICAgICAgICAgICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgaXNfcmV2aWV3X3JhdGluZ19wcm9kdWN0OiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzOgogICAgICAgICAgICAgICAgICAgICAgICAgIG5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHNbMF0sCiAgICAgICAgICAgICAgICAgICAgICAgIHJldmlld19tZXNzYWdlX2ZpcnN0OiB0aGlzLnJldmlld19tZXNzYWdlX2ZpcnN0LAogICAgICAgICAgICAgICAgICAgICAgICByZXZpZXdfbWVzc2FnZV9zZWNvbmQ6IHRoaXMucmV2aWV3X21lc3NhZ2Vfc2Vjb25kLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9kdWN0X3Jldmlld19pbWdfdXJsOiBwcm9kdWN0X3Jldmlld19pbWdfdXJsLAogICAgICAgICAgICAgICAgICAgICAgICBwcm9kdWN0X3JhdGluZzogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgcHJvZHVjdF9yZXZpZXc6ICIiLAogICAgICAgICAgICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihyZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHX0NPREUgPT09IHRoaXMuYXBpX3N0YXR1c19jb2RlLklNQUdFX05PVF9GT1VORC5NU0dfQ09ERSkgewogICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YS5tZXNzYWdlLk1TRyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIFN3YWwoewogICAgICAgICAgICAgICAgdGl0bGU6IHJlc3BvbnNlLmRhdGEubWVzc2FnZS5NU0dfQ09ERSwKICAgICAgICAgICAgICAgIHRleHQ6IHJlc3BvbnNlLmRhdGEubWVzc2FnZS5NU0csCiAgICAgICAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgICAgIHR5cGU6ICJlcnJvciIKICAgICAgICAgICAgICB9KQogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICB0b2FzdHIuZXJyb3IoIlNvbWUgRXJyb3IgT2NjdXJyZWQuIik7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MTAgfHwKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQ0MCB8fAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA5CiAgICAgICAgICApIHsKICAgICAgICAgICAgdGhpcy4kcm9vdC4kZW1pdCgiU2Vzc2lvbl9FeHBpcmVkIiwgZS5yZXNwb25zZS5kYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCiAgICBzdWJtaXRfcmV2aWV3X3JhdGluZyhpbmRleCkgewogICAgICBpZiAoQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnByb2R1Y3RfcmF0aW5nKSA9PT0gZmFsc2UpIHsKICAgICAgICBzd2FsKHsKICAgICAgICAgIHRleHQ6ICJQbGVhc2UgZ2l2ZSByYXRpbmciLAogICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uOiBmYWxzZSwKICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICAgIHR5cGU6ICJ3YXJuaW5nIiwKICAgICAgICAgIHBvc2l0aW9uOiAidG9wLWVuZCIsCiAgICAgICAgICB0aW1lcjogNTAwMCwKICAgICAgICB9KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKEJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5wcm9kdWN0X3JldmlldykgPT09IGZhbHNlKSB7CiAgICAgICAgc3dhbCh7CiAgICAgICAgICB0ZXh0OiAiUGxlYXNlIHdyaXRlIHJldmlldyIsCiAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgdHlwZTogIndhcm5pbmciLAogICAgICAgICAgcG9zaXRpb246ICJ0b3AtZW5kIiwKICAgICAgICAgIHRpbWVyOiA1MDAwLAogICAgICAgIH0pOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgcHJvZHVjdF9kZXRhaWxzID0gewogICAgICAgIHByb2R1Y3RfaWQ6IHRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5wcm9kdWN0X2lkLAogICAgICAgIG5hbWU6IHRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5uYW1lLAogICAgICAgIGltYWdlX3NyYzogdGhpcy5jaGF0W2luZGV4XS5wcm9kdWN0X3Jldmlld19pbWdfdXJsLAogICAgICAgIHByaWNlOiB0aGlzLmNoYXRbaW5kZXhdLm5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMucHJpY2UsCiAgICAgICAgcXVhbnRpdHk6IHRoaXMuY2hhdFtpbmRleF0ubm90X3Jldmlld2VkX3Byb2R1Y3RfZGV0YWlscy5xdWFudGl0eSwKICAgICAgICB2YXJpYW50X2lkOiB0aGlzLmNoYXRbaW5kZXhdLm5vdF9yZXZpZXdlZF9wcm9kdWN0X2RldGFpbHMudmFyaWFudF9pZCwKICAgICAgfTsKICAgICAgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iKSB7CiAgICAgICAgcHJvZHVjdF9kZXRhaWxzLnZhcmlhbnRfaWQgPQogICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5ub3RfcmV2aWV3ZWRfcHJvZHVjdF9kZXRhaWxzLnNrdTsKICAgICAgfQogICAgICBheGlvcwogICAgICAgIC5wb3N0KAogICAgICAgICAgYXBpX2NhbGxzLnByb2R1Y3RfcmV2aWV3X3JhdGluZygpLAogICAgICAgICAgewogICAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICAgICAgICBlbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIGlzX3NhdmVfcmV2aWV3X3JhdGluZzogdHJ1ZSwKICAgICAgICAgICAgcmV2aWV3X3JhdGluZ19jdXN0b21lcl9pZDogdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiKSwKICAgICAgICAgICAgcmV2aWV3X3JhdGluZ19jdXN0b21lcl9lbWFpbDogdGhpcy4kc2Vzc2lvbi5nZXQoCiAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iCiAgICAgICAgICAgICksCiAgICAgICAgICAgIHByb2R1Y3RfcmF0aW5nOiB0aGlzLmNoYXRbaW5kZXhdLnByb2R1Y3RfcmF0aW5nLAogICAgICAgICAgICBwcm9kdWN0X3JldmlldzogdGhpcy5jaGF0W2luZGV4XS5wcm9kdWN0X3JldmlldywKICAgICAgICAgICAgcHJvZHVjdF9kZXRhaWxzOiBwcm9kdWN0X2RldGFpbHMsCiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuJHNlc3Npb24uZ2V0KCJhdCIpfWAsCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5tZXNzYWdlLk1TR19DT0RFID09PSB0aGlzLmFwaV9zdGF0dXNfY29kZS5SRVZJRVdfU0FWRURfU1VDQ0VTU0ZVTExZLk1TR19DT0RFKSB7CiAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5pc19yZXZpZXdfcmF0aW5nX3Byb2R1Y3QgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgICAgICAgcmVjZWl2ZWQ6IHRoaXMucmV2aWV3X3Jlc3BvbnNlX21lc3NhZ2UsCiAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICAgICAgc3dhbCh7CiAgICAgICAgICAgICAgICB0ZXh0OiB0aGlzLnJldmlld19yZXNwb25zZV9tZXNzYWdlLAogICAgICAgICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgICAgIHR5cGU6ICJzdWNjZXNzIiwKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAidG9wLWVuZCIsCiAgICAgICAgICAgICAgICB0aW1lcjogNTAwMCwKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHX0NPREUgPT09IHRoaXMuYXBpX3N0YXR1c19jb2RlLlJFVklFV19OT1RfU0FWRUQuTVNHX0NPREUpIHsKICAgICAgICAgICAgICBzd2FsKHsKICAgICAgICAgICAgICAgIHRleHQ6ICJTb21lIEVycm9yIE9jY3VycmVkLiIsCiAgICAgICAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgICAgICAgdHlwZTogImVycm9yIiwKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAidG9wLWVuZCIsCiAgICAgICAgICAgICAgICB0aW1lcjogNTAwMCwKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBTd2FsKHsKICAgICAgICAgICAgICAgIHRpdGxlOiByZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHX0NPREUsCiAgICAgICAgICAgICAgICB0ZXh0OiByZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHLAogICAgICAgICAgICAgICAgc2hvd0NhbmNlbEJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgICAgICBzaG93Q29uZmlybUJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgICAgICB0eXBlOiAiZXJyb3IiCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MTAgfHwKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQ0MCB8fAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA5CiAgICAgICAgICApIHsKICAgICAgICAgICAgdGhpcy4kcm9vdC4kZW1pdCgiU2Vzc2lvbl9FeHBpcmVkIiwgZS5yZXNwb25zZS5kYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCiAgICBjbG9zZWNhcnQoY2xvc2VfY2FydCkgewogICAgICB0aGlzLmlzX2NlbnNlX2NhcnQgPSBjbG9zZV9jYXJ0OwogICAgfSwKICAgIGNhcnRfY29tbXVuaWNhdGlvbihjYXJ0X2RhdGEpIHsKICAgICAgdGhpcy5hZGR0b0NhcnRkYXRhID0gW107CiAgICAgIHRoaXMudG90YWxfcHJvZHVjdHNfcXR5ID0gMDsKICAgICAgZm9yICh2YXIgaSBpbiBjYXJ0X2RhdGEpIHsKICAgICAgICB0aGlzLmFkZHRvQ2FydGRhdGEucHVzaChjYXJ0X2RhdGFbaV0pOwogICAgICB9CiAgICAgIGZvciAodmFyIGogaW4gdGhpcy5hZGR0b0NhcnRkYXRhKSB7CiAgICAgICAgdGhpcy50b3RhbF9wcm9kdWN0c19xdHkgPQogICAgICAgICAgdGhpcy50b3RhbF9wcm9kdWN0c19xdHkgKyB0aGlzLmFkZHRvQ2FydGRhdGFbal0ub3JkZXJfcXR5OwogICAgICB9CiAgICB9LAogICAgdXBkYXRlX3F1YW50aXR5KGZ1bmMsIGNoYXRfaWQsIGluZGV4LCBwcm9kdWN0KSB7CiAgICAgIHZhciB2bSA9IHRoaXM7CiAgICAgIHRoaXMub3Zlcl9xdHlfd2FybmluZyA9IGZhbHNlOwogICAgICB2YXIgYnV5ID0gcGFyc2VJbnQodGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkpOwogICAgICB2YXIgb3JkZXIgPSB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0ub3JkZXJfcXR5OwogICAgICB2YXIgc3RvY2sgPSB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0uc3RvY2tfcXVhbnRpdHk7CiAgICAgIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09PSAiYmlnY29tbWVyY2UiKSB7CiAgICAgICAgaWYgKAogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLnN0b2NrX3N0YXR1cyA9PT0gImluc3RvY2siICYmCiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0uc3RvY2tfcXVhbnRpdHkgPT09IDAKICAgICAgICApIHsKICAgICAgICAgIHN0b2NrID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHRoaXMuYWRkdG9DYXJ0ZGF0YS5sZW5ndGggIT09IDAgJiYgc3RvY2sgIT0gbnVsbCkgewogICAgICAgIGZvciAodmFyIGkgaW4gdGhpcy5hZGR0b0NhcnRkYXRhKSB7CiAgICAgICAgICBpZiAodGhpcy5hZGR0b0NhcnRkYXRhW2ldLmlkID09IHByb2R1Y3QuaWQpIHsKICAgICAgICAgICAgbGV0IGNhcnRfb3JkZXJfcXR5ID0gdGhpcy5hZGR0b0NhcnRkYXRhW2ldLm9yZGVyX3F0eTsKICAgICAgICAgICAgc3RvY2sgPSBzdG9jayAtIGNhcnRfb3JkZXJfcXR5OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgdG90YWwgPSBidXkgKyBvcmRlcjsKICAgICAgaWYgKGZ1bmMgPT09ICIrIikgewogICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5vcmRlcl9xdHkgPSAxOwogICAgICAgIGlmICh0b3RhbCA8PSBzdG9jayB8fCAoc3RvY2sgPT0gbnVsbCAmJiAhaXNOYU4odG90YWwpKSkgewogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkgKz0gMTsKICAgICAgICAgIHZtLiRzZXQodm0uY2hhdCwgY2hhdF9pZCwgdm0uY2hhdFtjaGF0X2lkXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5vcmRlcl9xdHkgPSAyOwogICAgICAgICAgaWYgKHN0b2NrID09PSAwKSB7CiAgICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5idXlfcXR5ID0gMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5idXlfcXR5ID0gc3RvY2s7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmdW5jID09PSAiLSIpIHsKICAgICAgICBpZiAoYnV5ID4gMSAmJiAhaXNOYU4odG90YWwpKSB7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0ub3JkZXJfcXR5ID0gMTsKICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5idXlfcXR5IC09IDE7CiAgICAgICAgICB2bS4kc2V0KHZtLmNoYXQsIGNoYXRfaWQsIHZtLmNoYXRbY2hhdF9pZF0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0uYnV5X3F0eSA9IDE7CiAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0ub3JkZXJfcXR5ID0gMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGZ1bmMgPT09ICJtYW51YWwiKSB7CiAgICAgICAgdmFyIHF1YW50aXR5ID0gTWF0aC5hYnMocGFyc2VJbnQocHJvZHVjdC5idXlfcXR5KSk7CiAgICAgICAgaWYgKCFpc05hTihxdWFudGl0eSkpIHsKICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5vcmRlcl9xdHkgPSAxOwogICAgICAgICAgaWYgKHF1YW50aXR5KSB7CiAgICAgICAgICAgIGlmIChxdWFudGl0eSA8PSBzdG9jayB8fCBzdG9jayA9PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkgPSBxdWFudGl0eTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmNoYXRbY2hhdF9pZF0ucHJvZHVjdHNfbGlzdFtpbmRleF0ub3JkZXJfcXR5ID0gMjsKICAgICAgICAgICAgICBpZiAoc3RvY2sgPT09IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuY2hhdFtjaGF0X2lkXS5wcm9kdWN0c19saXN0W2luZGV4XS5idXlfcXR5ID0gMTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkgPSBzdG9jazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdm0uJHNldCh2bS5jaGF0LCBjaGF0X2lkLCB2bS5jaGF0W2NoYXRfaWRdKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGlzTmFOKHRvdGFsKSkgewogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLmJ1eV9xdHkgPSAxOwogICAgICAgICAgdGhpcy5jaGF0W2NoYXRfaWRdLnByb2R1Y3RzX2xpc3RbaW5kZXhdLm9yZGVyX3F0eSA9IDE7CiAgICAgICAgICB2bS4kc2V0KHZtLmNoYXQsIGNoYXRfaWQsIHZtLmNoYXRbY2hhdF9pZF0pOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGFkZHByb2R1Y3QocHJvZHVjdCkgewogICAgICB0aGlzLnRvdGFsX3Byb2R1Y3RzX3F0eSA9IDA7CiAgICAgIHRoaXMub3Zlcl9xdHlfd2FybmluZyA9IGZhbHNlOwogICAgICB2YXIgYXVkaW8gPSBuZXcgQXVkaW8oc291bmQpOwogICAgICBhdWRpby5wbGF5KCk7CiAgICAgIHZhciBjYXJ0ID0gJCgiI2NlbnNlLWNhcnQtYnRuIik7CiAgICAgIHZhciBjYXJ0X3F0eSA9ICQoIiNjYXJ0LXF0eS1udW0iKTsKICAgICAgdmFyIGNhcnRfaW1nID0gJCgiI2NhcnQtaW1nIik7CiAgICAgIGlmICh0aGlzLmFkZHRvQ2FydGRhdGEubGVuZ3RoICE9IDAgJiYgcHJvZHVjdC5idXlfcXR5ICE9PSAiIikgewogICAgICAgIHZhciBjaGVjayA9IGZhbHNlOwogICAgICAgIGZvciAodmFyIGkgaW4gdGhpcy5hZGR0b0NhcnRkYXRhKSB7CiAgICAgICAgICBpZiAodGhpcy5hZGR0b0NhcnRkYXRhW2ldLmlkID09IHByb2R1Y3QuaWQpIHsKICAgICAgICAgICAgY2hlY2sgPSB0cnVlOwogICAgICAgICAgICB2YXIgYnV5ID0gcHJvZHVjdC5idXlfcXR5ICsgdGhpcy5hZGR0b0NhcnRkYXRhW2ldLm9yZGVyX3F0eTsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIHByb2R1Y3Quc3RvY2tfcXVhbnRpdHkgPiB0aGlzLmFkZHRvQ2FydGRhdGFbaV0ub3JkZXJfcXR5ICYmCiAgICAgICAgICAgICAgYnV5IDw9IHByb2R1Y3Quc3RvY2tfcXVhbnRpdHkKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdGhpcy5hZGR0b0NhcnRkYXRhW2ldLm9yZGVyX3F0eSA9IGJ1eTsKICAgICAgICAgICAgICBwcm9kdWN0Lm9yZGVyX3F0eSA9IDE7CiAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjYXJ0X3F0eS5hZGRDbGFzcygiY2FydC1xdHkiKTsKICAgICAgICAgICAgICAgIGNhcnRfaW1nLmFkZENsYXNzKCJjYXJ0LWltZyIpOwogICAgICAgICAgICAgICAgY2FydC5hZGRDbGFzcygic2hha2UiKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICBjYXJ0X3F0eS5yZW1vdmVDbGFzcygiY2FydC1xdHkiKTsKICAgICAgICAgICAgICAgICAgY2FydF9pbWcucmVtb3ZlQ2xhc3MoImNhcnQtaW1nIik7CiAgICAgICAgICAgICAgICAgIGNhcnQucmVtb3ZlQ2xhc3MoInNoYWtlIik7CiAgICAgICAgICAgICAgICB9LCA1MDApOwogICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgIHByb2R1Y3Quc3RvY2tfcXVhbnRpdHkgPT0gbnVsbCB8fAogICAgICAgICAgICAgIChwcm9kdWN0LnN0b2NrX3F1YW50aXR5ID09IDAgJiYKICAgICAgICAgICAgICAgIHByb2R1Y3Quc3RvY2tfc3RhdHVzID09PSAiaW5zdG9jayIpCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHRoaXMuYWRkdG9DYXJ0ZGF0YVtpXS5vcmRlcl9xdHkgPSBidXk7CiAgICAgICAgICAgICAgcHJvZHVjdC5vcmRlcl9xdHkgPSAxOwogICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgY2FydF9xdHkuYWRkQ2xhc3MoImNhcnQtcXR5Iik7CiAgICAgICAgICAgICAgICBjYXJ0X2ltZy5hZGRDbGFzcygiY2FydC1pbWciKTsKICAgICAgICAgICAgICAgIGNhcnQuYWRkQ2xhc3MoInNoYWtlIik7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgY2FydF9xdHkucmVtb3ZlQ2xhc3MoImNhcnQtcXR5Iik7CiAgICAgICAgICAgICAgICAgIGNhcnRfaW1nLnJlbW92ZUNsYXNzKCJjYXJ0LWltZyIpOwogICAgICAgICAgICAgICAgICBjYXJ0LnJlbW92ZUNsYXNzKCJzaGFrZSIpOwogICAgICAgICAgICAgICAgfSwgNTAwKTsKICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwcm9kdWN0Lm9yZGVyX3F0eSA9IDI7CiAgICAgICAgICAgICAgbGV0IHJlcyA9CiAgICAgICAgICAgICAgICBwcm9kdWN0LnN0b2NrX3F1YW50aXR5IC0gdGhpcy5hZGR0b0NhcnRkYXRhW2ldLm9yZGVyX3F0eTsKICAgICAgICAgICAgICBwcm9kdWN0LmJ1eV9xdHkgPSByZXMgPT09IDAgPyAxIDogcmVzOwogICAgICAgICAgICAgIHRoaXMub3Zlcl9xdHlfd2FybmluZyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKAogICAgICAgICAgY2hlY2sgIT0gdHJ1ZSAmJgogICAgICAgICAgKHByb2R1Y3QuYnV5X3F0eSA8PSBwcm9kdWN0LnN0b2NrX3F1YW50aXR5IHx8CiAgICAgICAgICAgIHByb2R1Y3Quc3RvY2tfcXVhbnRpdHkgPT0gbnVsbCB8fAogICAgICAgICAgICAocHJvZHVjdC5zdG9ja19xdWFudGl0eSA9PSAwICYmIHByb2R1Y3Quc3RvY2tfc3RhdHVzID09PSAiaW5zdG9jayIpKQogICAgICAgICkgewogICAgICAgICAgdGhpcy5hZGR0b0NhcnRkYXRhLnB1c2goewogICAgICAgICAgICBpZDogcHJvZHVjdC5pZCwKICAgICAgICAgICAgaW1nX3VybDogcHJvZHVjdC5pbWdfdXJsLAogICAgICAgICAgICBwcmljZTogcHJvZHVjdC5wcmljZSwKICAgICAgICAgICAgc3RvY2tfcXVhbnRpdHk6IHByb2R1Y3Quc3RvY2tfcXVhbnRpdHksCiAgICAgICAgICAgIG9yZGVyX3F0eTogcHJvZHVjdC5idXlfcXR5LAogICAgICAgICAgICBza3U6IHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gJ2JpZ2NvbW1lcmNlJyA/IHByb2R1Y3Quc2t1IDogJycsCiAgICAgICAgICAgIGJ1eV9xdHk6IDEsCiAgICAgICAgICAgIHZhcmlhbnRfdGl0bGU6IHByb2R1Y3QudmFyaWFudF90aXRsZSwKICAgICAgICAgICAgc3RvY2tfc3RhdHVzOiBwcm9kdWN0LnN0b2NrX3N0YXR1cywKICAgICAgICAgICAgdGl0bGU6IHByb2R1Y3QudGl0bGUsCiAgICAgICAgICB9KTsKICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjYXJ0X3F0eS5hZGRDbGFzcygiY2FydC1xdHkiKTsKICAgICAgICAgICAgY2FydF9pbWcuYWRkQ2xhc3MoImNhcnQtaW1nIik7CiAgICAgICAgICAgIGNhcnQuYWRkQ2xhc3MoInNoYWtlIik7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGNhcnRfcXR5LnJlbW92ZUNsYXNzKCJjYXJ0LXF0eSIpOwogICAgICAgICAgICAgIGNhcnRfaW1nLnJlbW92ZUNsYXNzKCJjYXJ0LWltZyIpOwogICAgICAgICAgICAgIGNhcnQucmVtb3ZlQ2xhc3MoInNoYWtlIik7CiAgICAgICAgICAgIH0sIDUwMCk7CiAgICAgICAgICB9LCAwKTsKICAgICAgICB9IGVsc2UgaWYgKGNoZWNrICE9IHRydWUgJiYgcHJvZHVjdC5idXlfcXR5ID4gcHJvZHVjdC5zdG9ja19xdWFudGl0eSkgewogICAgICAgICAgdGhpcy5vdmVyX3F0eV93YXJuaW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgKHByb2R1Y3QuYnV5X3F0eSA8PSBwcm9kdWN0LnN0b2NrX3F1YW50aXR5ICYmIHByb2R1Y3QuYnV5X3F0eSAhPT0gIiIpIHx8CiAgICAgICAgcHJvZHVjdC5zdG9ja19xdWFudGl0eSA9PSBudWxsIHx8CiAgICAgICAgKHByb2R1Y3Quc3RvY2tfcXVhbnRpdHkgPT0gMCAmJiBwcm9kdWN0LnN0b2NrX3N0YXR1cyA9PT0gImluc3RvY2siKQogICAgICApIHsKICAgICAgICB0aGlzLmFkZHRvQ2FydGRhdGEucHVzaCh7CiAgICAgICAgICBpZDogcHJvZHVjdC5pZCwKICAgICAgICAgIGltZ191cmw6IHByb2R1Y3QuaW1nX3VybCwKICAgICAgICAgIHByaWNlOiBwcm9kdWN0LnByaWNlLAogICAgICAgICAgc3RvY2tfcXVhbnRpdHk6IHByb2R1Y3Quc3RvY2tfcXVhbnRpdHksCiAgICAgICAgICBvcmRlcl9xdHk6IHByb2R1Y3QuYnV5X3F0eSwKICAgICAgICAgIHNrdTogdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAnYmlnY29tbWVyY2UnID8gcHJvZHVjdC5za3UgOiAnJywKICAgICAgICAgIGJ1eV9xdHk6IDEsCiAgICAgICAgICB2YXJpYW50X3RpdGxlOiBwcm9kdWN0LnZhcmlhbnRfdGl0bGUsCiAgICAgICAgICBzdG9ja19zdGF0dXM6IHByb2R1Y3Quc3RvY2tfc3RhdHVzLAogICAgICAgICAgdGl0bGU6IHByb2R1Y3QudGl0bGUsCiAgICAgICAgfSk7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjYXJ0X3F0eS5hZGRDbGFzcygiY2FydC1xdHkiKTsKICAgICAgICAgIGNhcnRfaW1nLmFkZENsYXNzKCJjYXJ0LWltZyIpOwogICAgICAgICAgY2FydC5hZGRDbGFzcygic2hha2UiKTsKICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjYXJ0X3F0eS5yZW1vdmVDbGFzcygiY2FydC1xdHkiKTsKICAgICAgICAgICAgY2FydF9pbWcucmVtb3ZlQ2xhc3MoImNhcnQtaW1nIik7CiAgICAgICAgICAgIGNhcnQucmVtb3ZlQ2xhc3MoInNoYWtlIik7CiAgICAgICAgICB9LCA1MDApOwogICAgICAgIH0sIDApOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3Zlcl9xdHlfd2FybmluZyA9IHRydWU7CiAgICAgIH0KICAgICAgZm9yICh2YXIgaiBpbiB0aGlzLmFkZHRvQ2FydGRhdGEpIHsKICAgICAgICB0aGlzLnRvdGFsX3Byb2R1Y3RzX3F0eSA9CiAgICAgICAgICB0aGlzLnRvdGFsX3Byb2R1Y3RzX3F0eSArIHRoaXMuYWRkdG9DYXJ0ZGF0YVtqXS5vcmRlcl9xdHk7CiAgICAgIH0KICAgIH0sCiAgICBzZWxlY3RlZF9wcm9kdWN0KHZhbHVlKSB7CiAgICAgIGlmIChldmVudC50YXJnZXQuY2hlY2tlZCkgewogICAgICAgIGlmICh2YWx1ZSA9PSAiYWxsIikgewogICAgICAgICAgdGhpcy5jaGVja2VkX2xpc3QgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGkgaW4gdGhpcy5wcm9kdWN0X291dF9vZl9zdG9ja19saXN0KSB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tlZF9saXN0LnB1c2godGhpcy5wcm9kdWN0X291dF9vZl9zdG9ja19saXN0W2ldKTsKICAgICAgICAgIH0KICAgICAgICAgICQoImlucHV0OmNoZWNrYm94IikucHJvcCgiY2hlY2tlZCIsIGZhbHNlKTsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jaGVja2VkX2xpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgJCgKICAgICAgICAgICAgICAiI3Byb2R1Y3RfY2hlY2tib3hfIiArCiAgICAgICAgICAgICAgICB0aGlzLnByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3RbaV0ucHJvZHVjdF9pZAogICAgICAgICAgICApLnByb3AoImNoZWNrZWQiLCB0cnVlKTsKICAgICAgICAgICAgJCgiI3NlbGVjdGFsbCIpLnByb3AoImNoZWNrZWQiLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5jaGVja2VkX2xpc3QucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKCFldmVudC50YXJnZXQuY2hlY2tlZCkgewogICAgICAgIGlmICh2YWx1ZSAhPSAiYWxsIikgewogICAgICAgICAgdmFyIHNlbGVjdGFsbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNzZWxlY3RhbGwiKTsKICAgICAgICAgIGlmIChzZWxlY3RhbGwuY2hlY2tlZCkgewogICAgICAgICAgICBzZWxlY3RhbGwuY2hlY2tlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRlbXAgPSB0aGlzLmNoZWNrZWRfbGlzdC5maWx0ZXIoKHByb2R1Y3RfaWQpID0+IHsKICAgICAgICAgICAgcmV0dXJuIHByb2R1Y3RfaWQgIT0gdmFsdWU7CiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMuY2hlY2tlZF9saXN0ID0gdGVtcDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgJCgiaW5wdXQ6Y2hlY2tib3giKS5wcm9wKCJjaGVja2VkIiwgZmFsc2UpOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNoZWNrZWRfbGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAkKAogICAgICAgICAgICAgICIjcHJvZHVjdF9jaGVja2JveF8iICsKICAgICAgICAgICAgICAgIHRoaXMucHJvZHVjdF9vdXRfb2Zfc3RvY2tfbGlzdFtpXS5wcm9kdWN0X2lkCiAgICAgICAgICAgICkucHJvcCgiY2hlY2tlZCIsIGZhbHNlKTsKICAgICAgICAgICAgJCgiI3NlbGVjdGFsbCIpLnByb3AoImNoZWNrZWQiLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmNoZWNrZWRfbGlzdCA9IFtdOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGNoZWNrX2N1cnJlbnRfcHJvZHVjdF9hY3RpdmUoaW5kZXgpIHsKICAgICAgaWYgKEJvb2xlYW4odGhpcy5wcm9kdWN0X291dF9vZl9zdG9ja19saXN0W2luZGV4XSkgPT09IHRydWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5wcm9kdWN0X291dF9vZl9zdG9ja19saXN0W2luZGV4XS5wcm9kdWN0X2lkID09PQogICAgICAgICAgdGhpcy5jdXJyZW50X3Byb2R1Y3QucHJvZHVjdF9pZAogICAgICAgICAgPyAiY3VycmVudC1hY3RpdmUtdGVtcGxhdGUiCiAgICAgICAgICA6IG51bGw7CiAgICAgIH0KICAgIH0sCiAgICBzaG93X3Byb2R1Y3QoaW5kZXgpIHsKICAgICAgdGhpcy5jdXJyZW50X3Byb2R1Y3QgPSB0aGlzLnByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3RbaW5kZXhdOwogICAgfSwKICAgIGFkZF90b19vdXRfb2Zfc3RvY2tfbGlzdChpdGVtcykgewogICAgICB0aGlzLnByb2R1Y3Rfb3V0X29mX3N0b2NrX2xpc3QgPSBpdGVtczsKICAgICAgdGhpcy5jaGVja2VkX2xpc3QgPSBbXTsKICAgICAgJCgiaW5wdXQ6Y2hlY2tib3giKS5wcm9wKCJjaGVja2VkIiwgZmFsc2UpOwogICAgfSwKICAgIHN1Ym1pdF9vdXRfb2Zfc3RvY2tfcHJvZHVjdHMoKSB7CiAgICAgIGlmICh0aGlzLmNoZWNrZWRfbGlzdC5sZW5ndGggPT0gMCkgewogICAgICAgIHN3YWwoewogICAgICAgICAgdGV4dDogIlBsZWFzZSBzZWxlY3Qgc29tZSBwcm9kdWN0cyIsCiAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgIHBvc2l0aW9uOiAidG9wLWVuZCIsCiAgICAgICAgICB0eXBlOiAid2FybmluZyIsCiAgICAgICAgICBzaG93Q29uZmlybUJ1dHRvbjogZmFsc2UsCiAgICAgICAgICB0aW1lcjogMjUwMCwKICAgICAgICB9KTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgdGhpcy5jdXN0b21lcl9lbWFpbCA9PSAiIiB8fAogICAgICAgICF0aGlzLnJlZ19lbWFpbC50ZXN0KHRoaXMuY3VzdG9tZXJfZW1haWwpCiAgICAgICkgewogICAgICAgIHN3YWwoewogICAgICAgICAgdGV4dDogIlBsZWFzZSBlbnRlciBhIHZhbGlkIGVtYWlsIGFkZHJlc3MiLAogICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICBwb3NpdGlvbjogInRvcC1lbmQiLAogICAgICAgICAgdHlwZTogIndhcm5pbmciLAogICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgdGltZXI6IDI1MDAsCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHN3YWwoewogICAgICAgIHRleHQ6ICJQbGVhc2Ugd2FpdCB3aGlsZSB3ZSBhcmUgc3VibWl0dGluZyB5b3VyIGRldGFpbHMuLi4iLAogICAgICAgIHR5cGU6ICJpbmZvIiwKICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICBzaG93Q29uZmlybUJ1dHRvbjogZmFsc2UsCiAgICAgIH0pOwogICAgICAkKCIjbm90aWZ5ZW1haWwiKS5tb2RhbCgiaGlkZSIpOwogICAgICB0aGlzLnNwaW5uZXJPbiA9IHRydWU7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoCiAgICAgICAgICBhcGlfY2FsbHMub3V0b2ZzdG9ja2VtYWlsbm90aWZpY2F0aW9uKCksCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuY29tcGFueWlkLAogICAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuY29tcGFueW5hbWUsCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIGVtYWlsOiB0aGlzLmN1c3RvbWVyX2VtYWlsLAogICAgICAgICAgICBwcm9kdWN0X2xpc3Q6IHRoaXMuY2hlY2tlZF9saXN0LAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuJHNlc3Npb24uZ2V0KCJhdCIpfWAsCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgdGhpcy5zcGlubmVyT24gPSBmYWxzZTsKICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHX0NPREUgPT09IHRoaXMuYXBpX3N0YXR1c19jb2RlLlNVQ0NFU1NGVUxfREJfUVVFUllfTU9ERUxTLk1TR19DT0RFKSB7CiAgICAgICAgICAgIHN3YWwoewogICAgICAgICAgICAgIHR5cGU6ICJzdWNjZXNzIiwKICAgICAgICAgICAgICB0ZXh0OiAiWW91J2xsIGJlIG5vdGlmaWVkIHRocm91Z2ggZW1haWwgd2hlbiB0aGUgcHJvZHVjdHMgZ2V0IGJhY2sgaW4gc3RvY2siLAogICAgICAgICAgICAgIHRpbWVyOiAyNTAwLAogICAgICAgICAgICB9KS50aGVuKChyZXN1bHQpID0+IHsKICAgICAgICAgICAgICB0aGlzLmN1c3RvbWVyX2VtYWlsID0gIiI7CiAgICAgICAgICAgICAgdGhpcy5jaGVja2VkX2xpc3QgPSBbXTsKICAgICAgICAgICAgICAkKCJpbnB1dDpjaGVja2JveCIpLnByb3AoImNoZWNrZWQiLCBmYWxzZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YS5tZXNzYWdlLk1TRyk7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgIHRoaXMuc3Bpbm5lck9uID0gZmFsc2U7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIGUucmVzcG9uc2Uuc3RhdHVzID09PSA0MTAgfHwKICAgICAgICAgICAgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQ0MCB8fAogICAgICAgICAgICBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA5CiAgICAgICAgICApIHsKICAgICAgICAgICAgdGhpcy4kcm9vdC4kZW1pdCgiU2Vzc2lvbl9FeHBpcmVkIiwgZS5yZXNwb25zZS5kYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCiAgICByZWZyZXNoX2NoYXRib3QodHlwZSkgewogICAgICB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQgPSB0cnVlOwogICAgICBheGlvcwogICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgIGNoYXQ6ICIiLAogICAgICAgICAgZGF0YTogIiIsCiAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICB9KQogICAgICAgIC50aGVuKChyZXNwKSA9PiB7CiAgICAgICAgICB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQgPSBmYWxzZTsKICAgICAgICAgIGxldCB3ZWxjb21lX21zZ19jb21wYW5pZXMgPSBbCiAgICAgICAgICAgICJDdXN0b21lckhhcHBpbmVzczk1MTg1IiwKICAgICAgICAgICAgIjN4NWl2ZTk5NTM0IiwKICAgICAgICAgICAgIkZvcmVpZ254Y2hhbmdlMTc0OTEiLAogICAgICAgICAgICAiMzYwX3RlY2hub2xvZ3kiLAogICAgICAgICAgXTsKICAgICAgICAgIGlmICh0eXBlID09ICJzdXBwb3J0IikgewogICAgICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgIHJlY2VpdmVkOiAiSXMgdGhlcmUgYW55dGhpbmcgZWxzZSBJIGNhbiBoZWxwIHlvdSB3aXRoPyIsCiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdlbGNvbWVfbXNnX2NvbXBhbmllcy5pbmNsdWRlcyh0aGlzLmNvbXBhbnlpZCkpIHsKICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICAgICAgICBjaGF0OiAiL3dlbGNvbWVfbWVzc2FnZSIsCiAgICAgICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICBkYXRhOiAiIiwKICAgICAgICAgICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogZmFsc2UsCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMucHVzaF9tc2cocmVzcG9uc2UsIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMud2VsY29tZV9tZXNzYWdlX25vdF95ZXRfcmVjZWl2ZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCiAgICBkb3dubG9hZF9maWxlKHVybCwgZmlsZV9uYW1lKSB7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIHZhciBsaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgICBsaW5rLmhyZWYgPSB1cmw7CiAgICAgIGxpbmsuc2V0QXR0cmlidXRlKCJkb3dubG9hZCIsIGZpbGVfbmFtZSk7CiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobGluayk7CiAgICAgIGxpbmsuY2xpY2soKTsKICAgIH0sCiAgICBzY3JvbGxfZGl2KCkgewogICAgICB2YXIgZG9jID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmJ1eS1wcm9kdWN0cyIpOwogICAgICBpZiAoZXZlbnQuZGVsdGFYID4gZXZlbnQuZGVsdGFZKSB7CiAgICAgICAgZG9jLnNjcm9sbExlZnQgKz0gMTA7CiAgICAgIH0gZWxzZSBpZiAoZXZlbnQuZGVsdGFYIDwgZXZlbnQuZGVsdGFZKSB7CiAgICAgICAgZG9jLnNjcm9sbExlZnQgLT0gMTA7CiAgICAgIH0KICAgIH0sCiAgICBzY3JvbGxfZGl2MShpdGVtKSB7CiAgICAgIHZhciBkb2MgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjYnV5X3Byb2R1Y3RfaWRfJHtpdGVtfWApOwogICAgICBpZiAoZXZlbnQuZGVsdGFYID4gZXZlbnQuZGVsdGFZKSB7CiAgICAgICAgZG9jLnNjcm9sbExlZnQgKz0gMTA7CiAgICAgIH0gZWxzZSBpZiAoZXZlbnQuZGVsdGFYIDwgZXZlbnQuZGVsdGFZKSB7CiAgICAgICAgZG9jLnNjcm9sbExlZnQgLT0gMTA7CiAgICAgIH0KICAgIH0sCiAgICBzY3JvbGxfZGl2X3JpZ2h0KGl0ZW0pIHsKICAgICAgdmFyIGRvYyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYCNidXlfcHJvZHVjdF9pZF8ke2l0ZW19YCk7CiAgICAgIGRvYy5zY3JvbGxMZWZ0ICs9IDEwMDsKICAgIH0sCiAgICBzY3JvbGxfZGl2X2xlZnQoaXRlbSkgewogICAgICB2YXIgZG9jID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgI2J1eV9wcm9kdWN0X2lkXyR7aXRlbX1gKTsKICAgICAgZG9jLnNjcm9sbExlZnQgLT0gMTAwOwogICAgfSwKICAgIGNhbGxfc3VwcG9ydCh0eXBlKSB7CiAgICAgIGlmICh0eXBlID09ICJZZXMiKSB7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICBjaGF0OiAiL2NhbGxfc3VwcG9ydCIsCiAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICAgIH0pCiAgICAgICAgICAudGhlbigocmVzcCkgPT4gewogICAgICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgIHJlY2VpdmVkOiByZXNwLmRhdGEucmVzcG9uc2VzWzBdLnRleHQsCiAgICAgICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PSAiTm8iKSB7CiAgICAgICAgdGhpcy5jaGF0LnB1c2godGhpcy5jaGF0WzBdKTsKICAgICAgICB0aGlzLmNoYXQucHVzaCh0aGlzLmNoYXRbMV0pOwogICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICAvLyB0aGlzLnJlZnJlc2hfY2hhdGJvdCgic3VwcG9ydCIpOwogICAgICB9CiAgICB9LAogICAgcGFyc2Uoc3RyaW5nKSB7CiAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZSgve3suKj99fS9nLCAobWF0Y2gpID0+IHsKICAgICAgICB2YXIgdG9kYXkgPSBuZXcgRGF0ZSgpOwogICAgICAgIHZhciBkZCA9IHRvZGF5LmdldERhdGUoKTsKCiAgICAgICAgdmFyIG1tID0gdG9kYXkuZ2V0TW9udGgoKSArIDE7CiAgICAgICAgdmFyIHl5eXkgPSB0b2RheS5nZXRGdWxsWWVhcigpOwogICAgICAgIGlmIChkZCA8IDEwKSB7CiAgICAgICAgICBkZCA9ICIwIiArIGRkOwogICAgICAgIH0KCiAgICAgICAgaWYgKG1tIDwgMTApIHsKICAgICAgICAgIG1tID0gIjAiICsgbW07CiAgICAgICAgfQogICAgICAgIHRvZGF5ID0gZGQgKyAiLSIgKyBtbSArICItIiArIHl5eXk7CiAgICAgICAgdmFyIGV4cHJlc3Npb24gPSBtYXRjaC5zbGljZSgyLCAtMik7CiAgICAgICAgdGhpcy4kZGF0YVtleHByZXNzaW9uXSA9IHRvZGF5OwogICAgICAgIHJldHVybiB0aGlzLiRkYXRhW2V4cHJlc3Npb25dOwogICAgICB9KTsKICAgIH0sCiAgICBzaG93X3BvcHVwKCkgewogICAgICB0aGlzLnNob3cgPSBmYWxzZTsKICAgICAgdGhpcy5zdG9wID0gZmFsc2U7CiAgICB9LAogICAgc3ViX2xlYWZfbm9kZV9jYWxsKGRpdmNsaWNrKSB7CiAgICAgIC8vIHZhciBkaXZjbGljayA9IGV2ZW50LnRhcmdldC5pbm5lclRleHQKICAgICAgaWYgKGRpdmNsaWNrID09ICJXYXRjaCBEZW1vIFZpZGVvIikgewogICAgICAgIHRoaXMuZGVtb3VybGJpbmQgPSB0cnVlOwogICAgICAgIHRoaXMucmV2aWV3c3VybGJpbmQgPSBmYWxzZTsKICAgICAgfSBlbHNlIGlmIChkaXZjbGljayA9PSAiVXNlciBSZXZpZXdzL1Rlc3RpbW9uaWFscyIpIHsKICAgICAgICB0aGlzLnJldmlld3N1cmxiaW5kID0gdHJ1ZTsKICAgICAgICB0aGlzLmRlbW91cmxiaW5kID0gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKAogICAgICAgIGRpdmNsaWNrID09ICJXYXRjaCBEZW1vIFZpZGVvIiB8fAogICAgICAgIGRpdmNsaWNrID09ICJVc2VyIFJldmlld3MvVGVzdGltb25pYWxzIgogICAgICApIHsKICAgICAgICB0aGlzLnNob3cgPSAhdGhpcy5zaG93OwogICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgfSwgMTAwMCk7CiAgICAgIH0gZWxzZSBpZiAoZGl2Y2xpY2sgPT0gIkJ1eSBUdXRvcmlhbCIpIHsKICAgICAgICB0aGlzLmNlbnNlX2VucXVpcnkgPSB0cnVlOwogICAgICAgIGF4aW9zCiAgICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgY2hhdDogIi9wZXJzb25hbF9kZXRhaWxzIiwKICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6ICIiLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgICAgIHJlY2VpdmVkOiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1swXS50ZXh0LAogICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICAgICAgLy8gdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIHRpY2tldF9udW1iZXIoKSB7CiAgICAgIGxldCByYW5kb21fbnVtID0gTWF0aC5mbG9vcigxMDAwMDAwICsgTWF0aC5yYW5kb20oKSAqIDkwMDAwMDApOwogICAgICBsZXQgY29tcGFueSA9IHRoaXMuY29tcGFueW5hbWUuc2xpY2UoMCwgMSkudG9VcHBlckNhc2UoKTsKICAgICAgcmV0dXJuIGAke2NvbXBhbnl9XyR7cmFuZG9tX251bX1gOwogICAgfSwKICAgIHJlbW92ZV9jdXN0b21fYnV0dG9uKGluZGV4KXsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgaWYgKAogICAgICAgIHZtLmNoYXRbaW5kZXhdICYmCiAgICAgICAgdm0uY2hhdFtpbmRleF0ucmVtb3ZhYmxlID09IHRydWUKICAgICAgKSB7CiAgICAgICAgZG9jdW1lbnQKICAgICAgICAgIC5xdWVyeVNlbGVjdG9yKCIjY2hhdCIgKyBpbmRleCkKICAgICAgICAgIC5jbGFzc0xpc3QuYWRkKCItLWRlbGV0ZSIpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgdm0uY2hhdC5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0sIDg1MCk7CiAgICAgIH0KICAgIH0sCiAgICBjdXN0b21fYnV0dG9uX2NsaWNrKGJ1dHRvbiwgaW5kZXgpewogICAgICBpZihCb29sZWFuKGJ1dHRvbi50eXBlKSAmJiBCb29sZWFuKGJ1dHRvbi50eXBlID09PSAnd2ViX3VybCcpKXsKICAgICAgICB0aGlzLnJlbW92ZV9jdXN0b21fYnV0dG9uKGluZGV4KTsKICAgICAgICB3aW5kb3cub3BlbihidXR0b24udmFsdWUsICJfYmxhbmsiKTsKICAgICAgfWVsc2V7CiAgICAgICAgdGhpcy5zZW5kX21lc3NhZ2UoJ2lzX2J1dHRvbicsIGJ1dHRvbiwgaW5kZXgpOwogICAgICB9CiAgICB9LAogICAgc2VuZF9tZXNzYWdlKHR5cGUsIG1lc3NhZ2UsIHRvX2JlX2Rpc3BsYXllZCkgewogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICBpZiAodGhpcy5zZWxlY3RlZF9pbmRpY2F0aW9uWzBdICE9IHVuZGVmaW5lZCkgewogICAgICAgIGlmICh0eXBlID09ICJpc19idXR0b24iKSB7CiAgICAgICAgICB0aGlzLnRvX3NlbmQgPSBtZXNzYWdlLnZhbHVlICsgSlNPTi5zdHJpbmdpZnkodGhpcy5yZXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0eXBlID0gImlzX3Byb21wdCI7CiAgICAgICAgICB0b19iZV9kaXNwbGF5ZWQgPSB0aGlzLnRvX3NlbmQ7CiAgICAgICAgICB0aGlzLnRvX3NlbmQgPQogICAgICAgICAgICB0aGlzLnNlbGVjdGVkX2luZGljYXRpb25bMF0udmFsdWUuc3BsaXQoInsiKVswXSArCiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHRoaXMucmVzKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHR5cGUgPT0gImlzX2J1dHRvbiIpIHsKICAgICAgICBpZiAoCiAgICAgICAgICBtZXNzYWdlLnZhbHVlID09ICJpc2Rpc2FibGVkIiAmJgogICAgICAgICAgdGhpcy5jb21wYW55aWQgPT0gImNsaW5pY2FsdHJpYWxzODEzNTIiICYmCiAgICAgICAgICBtZXNzYWdlLnRpdGxlID09ICJObyIKICAgICAgICApIHsKICAgICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UudmFsdWUgPT09ICIvbGl2ZV9jaGF0IikgewogICAgICAgICAgdGhpcy5zdGFydF9saXZlX2NoYXQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgICAgIGZ1bmN0aW9uIHNlbmRfbXNnKHRvU2VuZCwgY3VzdG9tRGlzcGxheU1zZykgewogICAgICAgICAgICB2bS5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKICAgICAgICAgICAgdm0udXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAic2VuZGVyIik7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgIHZtLmNoYXQucHVzaCh7CiAgICAgICAgICAgICAgICBzZW50OiBjdXN0b21EaXNwbGF5TXNnCiAgICAgICAgICAgICAgICAgID8gYCR7bWVzc2FnZS50aXRsZX0gJHtjdXN0b21EaXNwbGF5TXNnfWAKICAgICAgICAgICAgICAgICAgOiBtZXNzYWdlLnRpdGxlLAogICAgICAgICAgICAgICAgc2VuZGluZzogdHJ1ZSwKICAgICAgICAgICAgICAgIHRpbWU6IHZtLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgICAgZGVsaXZlcmVkOiB0cnVlLAogICAgICAgICAgICAgICAgZHJvcGRvd246ICIiLAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCA4NTApOwogICAgICAgICAgICB2bS5yZW1vdmVfY3VzdG9tX2J1dHRvbih0b19iZV9kaXNwbGF5ZWQpOwogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgdm0uY2hhdFt0b19iZV9kaXNwbGF5ZWQgLSAxXSAmJgogICAgICAgICAgICAgIHZtLmNoYXRbdG9fYmVfZGlzcGxheWVkIC0gMV0uaXNfbXVsdGlzZWxlY3QgJiYKICAgICAgICAgICAgICAobWVzc2FnZS50aXRsZSA9PSAiQXBwcm92ZSIgfHwKICAgICAgICAgICAgICAgIG1lc3NhZ2UudGl0bGUgPT0gIlJlamVjdCIgfHwKICAgICAgICAgICAgICAgIG1lc3NhZ2UudGl0bGUgPT0gIkNvbW1lbnQgYW5kIFJldHVybiIpCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHZtLmNoYXRbdG9fYmVfZGlzcGxheWVkIC0gMV0uZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICAgICAgY2hhdDogdG9TZW5kLAogICAgICAgICAgICAgICAgdG9rZW46IHZtLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgcm9sZTogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdm0ucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICAgICAgdm0ucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2bS5zZWxlY3RlZF9pbmRpY2F0aW9uID0gW107CiAgICAgICAgICAgIHZtLnRvX3NlbmQgPSAiIjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodGhpcy5jb21wYW55aWQgPT0gIjM2MF90ZWNobm9sb2d5IikgewogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgdGhpcy5jaGF0W3RvX2JlX2Rpc3BsYXllZCAtIDFdICYmCiAgICAgICAgICAgICAgdGhpcy5jaGF0W3RvX2JlX2Rpc3BsYXllZCAtIDFdLnZhbHVlX21hcHBpbmcKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgbGV0IHZhbHVlTWFwcGluZ0RhdGEgPSBKU09OLnBhcnNlKAogICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkodGhpcy5jaGF0W3RvX2JlX2Rpc3BsYXllZCAtIDFdLnZhbHVlX21hcHBpbmcpCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB0aGlzLmFkZGRyb3Bkb3dudmFsdWUodmFsdWVNYXBwaW5nRGF0YSkudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLnRvX3NlbmQgPSBtZXNzYWdlLnZhbHVlICsgSlNPTi5zdHJpbmdpZnkodGhpcy5yZXMpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hhdFt0b19iZV9kaXNwbGF5ZWQgLSAxXS52YWx1ZV9tYXBwaW5nKSB7CiAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZU1hcHBpbmdEYXRhLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHNlbmRfbXNnKG1lc3NhZ2UudmFsdWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHNlbmRfbXNnKAogICAgICAgICAgICAgICAgICAgICAgdGhpcy50b19zZW5kLAogICAgICAgICAgICAgICAgICAgICAgYGZvciAke3RoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAubWFwKChvYmopID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JqLnRpdGxlOwogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAudG9TdHJpbmcoKX1gCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UudmFsdWUuc3BsaXQoInsiKS5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgbGV0IGN1c3RvbURpc3BsYXlNc2cgPSBPYmplY3QudmFsdWVzKAogICAgICAgICAgICAgICAgSlNPTi5wYXJzZShgeyR7bWVzc2FnZS52YWx1ZS5zcGxpdCgieyIpWzFdfWApCiAgICAgICAgICAgICAgKVswXTsKICAgICAgICAgICAgICBzZW5kX21zZyhtZXNzYWdlLnZhbHVlLCBgZm9yICR7Y3VzdG9tRGlzcGxheU1zZ31gKTsKICAgICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgICB0aGlzLmNoYXRbdG9fYmVfZGlzcGxheWVkIC0gMV0gJiYKICAgICAgICAgICAgICB0aGlzLmNoYXRbdG9fYmVfZGlzcGxheWVkIC0gMV0uc2hvd190ZXh0X2FyZWEKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgc2VuZF9tc2cobWVzc2FnZS52YWx1ZSk7CiAgICAgICAgICAgICAgdGhpcy5jaGF0W3RvX2JlX2Rpc3BsYXllZCAtIDFdLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZW5kX21zZyhtZXNzYWdlLnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VuZF9tc2cobWVzc2FnZS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHR5cGUgPT0gImlzX3Byb21wdCIpIHsKICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgIHNlbnQ6IHRvX2JlX2Rpc3BsYXllZCwKICAgICAgICAgIHNlbmRpbmc6IHRydWUsCiAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgZGVsaXZlcmVkOiB0cnVlLAogICAgICAgIH0pOwogICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAic2VuZGVyIik7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgLy8gaG9zdDogdGhpcy51c2VyX2RhdGEuaG9zdCwKICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgY2hhdDogdGhpcy50b19zZW5kLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgICAgICAgICAgdGhpcy5leDEoKTsKICAgICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHRoaXMudG9fc2VuZCA9PSAiUmVzdGFydCIgfHwgdGhpcy50b19zZW5kID09ICJyZXN0YXJ0IikgewogICAgICAgIGF4aW9zCiAgICAgICAgICAucG9zdChhcGlfY2FsbHMucHJvbXB0X3VybCgpLCB7CiAgICAgICAgICAgIHVpZDogImNlbnNlIiwgLy8gdGhpcy5maW5nZXJwcmludAogICAgICAgICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgY2hhdDogIiIsCiAgICAgICAgICB9KQogICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICAgIC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICAgICAgICB0aGlzLmxldmVsID0gcmVzcG9uc2UuZGF0YS5sZXZlbDsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goKGUpID0+IHt9KTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmNlbnNlX2VucXVpcnkgPT0gdHJ1ZSAmJiBCb29sZWFuKHRoaXMudG9fc2VuZCkpIHsKICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICAgIHZhciBzZW5kX21zZyA9IHsKICAgICAgICAgIHNlbnQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgc2VuZGluZzogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgIH07CiAgICAgICAgdGhpcy5jaGF0LnB1c2goc2VuZF9tc2cpOwogICAgICAgIC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiKTsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIGNoYXQ6ICIvcGVyc29uYWxfZGV0YWlscyIsCiAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgIGNvbXBhbnlfaWQ6ICJDTzAwMDIzIiwKICAgICAgICAgICAgZGF0YTogIiIsCiAgICAgICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgICByZWZyZXNoZWRfb3JfY2xvc2VkOiAiIiwKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgIH0pCiAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgICByZWNlaXZlZDogcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbMF0udGV4dCwKICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICAgIC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICAgICAgICB0aGlzLnJlZnJlc2hlZF9vcl9jbG9zZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHRoaXMubGl2ZV9jaGF0X29uKSB7CiAgICAgICAgLy8gTElWRSBDSEFUIE9OIENVU1RPTUVSIE1FU1NBR0VTCiAgICAgICAgaWYgKEJvb2xlYW4odGhpcy50b19zZW5kKSkgewogICAgICAgICAgaWYgKEJvb2xlYW4odGhpcy51c2VyX25hbWUpID09PSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLmNoYW5uZWwucHVzaCgibmV3X25hbWUiLCB7IG5hbWU6IHRoaXMudG9fc2VuZCB9KTsKICAgICAgICAgICAgdGhpcy51c2VyX25hbWUgPSB0aGlzLnRvX3NlbmQ7CiAgICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuY2hhbm5lbC5wdXNoKCJuZXdfbmFtZSIsIHsgbmFtZTogdGhpcy51c2VyX25hbWUgfSk7CiAgICAgICAgICAgIHRoaXMuY2hhbm5lbC5wdXNoKCJuZXdfY2hhdF9tZXNzYWdlIiwgeyBtZXNzYWdlOiB0aGlzLnRvX3NlbmQgfSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgc2VudDogdGhpcy50b19zZW5kLAogICAgICAgICAgICBzZW5kaW5nOiB0cnVlLAogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICB9KTsKICAgICAgICAgIC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJzZW5kZXIiKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoQm9vbGVhbih0aGlzLnRvX3NlbmQpICYmIHRoaXMuY2Vuc2VfZW5xdWlyeSAhPSB0cnVlKSB7CiAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICBzZW5kaW5nOiB0cnVlLAogICAgICAgICAgc2VudDogdGhpcy50b19zZW5kLAogICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgfSk7CiAgICAgICAgLy8gdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJzZW5kZXIiKTsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgIGNoYXQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdGhpcy50b19zZW5kID0gIiI7CiAgICB9LAogICAgaW5pdGlhdGVfc3VwcG9ydF9jaGF0KCkgewogICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgIHJlY2VpdmVkOiAiU29ycnkgSSBhbSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uIiwKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgfSk7CiAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgcmVjZWl2ZWQ6ICJXb3VsZCB5b3UgbGlrZSB0byB0YWxrIHdpdGggc3VwcG9ydCB0ZWFtPyIsCiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgc2hvd19idXR0b25zOiB0cnVlLAogICAgICAgIHN1cHBvcnRfYnV0dG9uczogdHJ1ZSwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgfSk7CiAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgIH0sCiAgICBkaXNjb25uZWN0X3N1cHBvcnRfY2hhdCgpIHsKICAgICAgdGhpcy5jaGFubmVsLnB1c2goInN0b3BwZWRfY2hhdCIsIHsKICAgICAgICBuYW1lOiB0aGlzLnVzZXJfbmFtZSwKICAgICAgICBtZXNzYWdlOiAiIGhhcyBlbmRlZCB0aGUgY29udmVyc2F0aW9uLiIsCiAgICAgIH0pOwogICAgICB0aGlzLmNoYW5uZWwubGVhdmUoKTsKICAgICAgdGhpcy5saXZlX2NoYXRfdG9rZW4gPSBudWxsOwogICAgICB0aGlzLmNoYXRfZ3JvdXBfbmFtZSA9IG51bGw7CiAgICAgIHRoaXMuc3VwcG9ydF9hZ2VudF9pbmZvID0gbnVsbDsKICAgICAgdGhpcy51c2VyX25hbWUgPSAiIjsKICAgICAgdGhpcy5jaGF0X3NvY2tldC5kaXNjb25uZWN0KCk7CiAgICAgIHRoaXMubGl2ZV9jaGF0X29uID0gZmFsc2U7CiAgICB9LAogICAgZ2VuZXJhdGVfcGF5bWVudChwcmljZSwgbmFtZSkgewogICAgICB2YXIgdm0gPSB0aGlzOwogICAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICBrZXk6ICJyenBfdGVzdF9TbkRUYVBubmNmbGlEdCIsCiAgICAgICAgYW1vdW50OiBwcmljZSAqIDEwMCwKICAgICAgICBjb21wYW55X2lkOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuY29tcGFueV9pZCwKICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUsCiAgICAgICAgbmFtZTogIkNlbnNlIEFJIiwKICAgICAgICBjdXJyZW5jeTogIklOUiIsCiAgICAgICAgZGVzY3JpcHRpb246ICJJbnN0aWxsIEludGVsbGlnZW5jZSIsCiAgICAgICAgaW1hZ2U6ICIvaW1nL2NlbnNlX2ltYWdlLnBuZyIsIC8vIENPTVBBTlkgTE9HTwogICAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgdmFyIGNvbnRhY3QgPSAkKCcjY29udGFjdFt0eXBlPSJ0ZWwiXScpLnZhbHVlOwogICAgICAgICAgdmFyIGVtYWlsID0gJCgnI2VtYWlsW3R5cGU9ImVtYWlsIl0nKS52YWx1ZTsKICAgICAgICAgIHZtLnBheW1lbnRpZCA9IHJlc3BvbnNlLnJhem9ycGF5X3BheW1lbnRfaWQ7CgogICAgICAgICAgaWYgKHRyYW5zZmVyX2FjY291bnQgIT0gbnVsbCkgewogICAgICAgICAgICB2bS50cmFuc2Zlcl9wYXltZW50KHRyYW5zZmVyX2FjY291bnQsIHByaWNlICogMTAwLCAiSU5SIiwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBwcmVmaWxsOiB7CiAgICAgICAgICBuYW1lOiAiIiwgLy8gcGFzcyBjdXN0b21lciBuYW1lCiAgICAgICAgICBlbWFpbDogIiIsIC8vIGN1c3RvbWVyIGVtYWlsCiAgICAgICAgICBjb250YWN0OiAiIiwgLy8gY3VzdG9tZXIgcGhvbmUgbm8uCiAgICAgICAgfSwKICAgICAgICBub3RlczogewogICAgICAgICAgYWRkcmVzczogImFkZHJlc3MiLCAvLyBjdXN0b21lciBhZGRyZXNzCiAgICAgICAgfSwKICAgICAgICB0aGVtZTogewogICAgICAgICAgY29sb3I6ICIjMjgzNzc3IiwgLy8gc2NyZWVuIGNvbG9yCiAgICAgICAgfSwKICAgICAgfTsKICAgICAgdmFyIHJ6cDEgPSBuZXcgUmF6b3JwYXkob3B0aW9ucyk7CiAgICAgIHJ6cDEub3BlbigpOwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgfSwKICAgIGNoYXRfcmVzcG9uc2VfZXJyb3IoKSB7CiAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgcmVjZWl2ZWQ6ICJTb3JyeSBJJ20gbm90IGdldHRpbmcgeW91ciBxdWVzdGlvbiIsCiAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgIH0pOwogICAgICAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgfSwKICAgIHNlbmRfcmVxdWVzdF9qc29uKG1lc3NhZ2UpIHsKICAgICAgYXhpb3MKICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgY2hhdDogIiIsCiAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgZGF0YTogdGhpcy5qc29uX2RhdGFbbWVzc2FnZS5yZXNwb25zZXNbMF0uaW50ZW50XSwKICAgICAgICB9KQogICAgICAgIC50aGVuKChyZXNwKSA9PiB7CiAgICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgIHJlY2VpdmVkOgogICAgICAgICAgICAgIHJlc3AuZGF0YS5yZXNwb25zZXMubGVuZ3RoID09IDAKICAgICAgICAgICAgICAgID8gIlNvcnJ5IEknbSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uIgogICAgICAgICAgICAgICAgOiByZXNwLmRhdGEucmVzcG9uc2VzWzBdLnRleHQsCiAgICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICBpbWFnZToKICAgICAgICAgICAgICByZXNwLmRhdGEucmVzcG9uc2VzWzBdLmltZyA9PSAiIgogICAgICAgICAgICAgICAgPyBudWxsCiAgICAgICAgICAgICAgICA6IHJlc3AuZGF0YS5yZXNwb25zZXNbMF0uaW1nLAogICAgICAgICAgfSk7CiAgICAgICAgICAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICB9KTsKICAgIH0sCiAgICByZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSwgdHlwZSkgewogICAgICB2YXIgaSA9IDA7CiAgICAgIHZhciBkZWxheSA9IDUwOwogICAgICB2YXIgdm0gPSB0aGlzOwogICAgICB2bS5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgaGFuZGxlX3Jlc3BvbnNlKCk7CiAgICAgIH0sIGRlbGF5KTsKICAgICAgZnVuY3Rpb24gaGFuZGxlX3Jlc3BvbnNlKCkgewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgdm0uaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEgPT0gbnVsbCB8fCByZXNwb25zZS5kYXRhLnJlc3BvbnNlcy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICB2bS5jaGF0X3Jlc3BvbnNlX2Vycm9yKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ucmVxdWVzdF9qc29uKSA9PSB0cnVlKSB7CiAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0ICE9IG51bGwpIHsKICAgICAgICAgICAgICB2bS5jaGF0LnB1c2goewogICAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgICByZWNlaXZlZDogcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCwKICAgICAgICAgICAgICAgIHRpbWU6IHZtLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgICAgIGltYWdlOiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbWcsCiAgICAgICAgICAgICAgICB2aWRlbzogcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udmlkZW8sCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgLy8gdm0uJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB2bS5jaGF0KTsKICAgICAgICAgICAgICB2bS51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQgPT0gImdvZ3liNDUwX2NyZWF0ZV90aWNrZXQiKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBgJHt2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmZpcnN0X25hbWV9ICR7CiAgICAgICAgICAgICAgICB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxhc3RfbmFtZQogICAgICAgICAgICAgIH1gOwogICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gewogICAgICAgICAgICAgICAgdXNlcm5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICBjb21wYW55X25hbWU6IHZtLmNvbXBhbnluYW1lLAogICAgICAgICAgICAgICAgY29tcGFueV9pZDogdm0uY29tcGFueWlkLAogICAgICAgICAgICAgICAgdXNlcl9yb2xlOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICBlbWFpbDogdm0uJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgdG9rZW46IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikudG9rZW5zLAogICAgICAgICAgICAgICAgdGlja2V0X2lzc3VlOiAiIiwKICAgICAgICAgICAgICAgIHRpY2tldF9udW1iZXI6IHZtLnRpY2tldF9udW1iZXIoKSwKICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiIiwKICAgICAgICAgICAgICAgIGZpbGVfY29udGVudDogbnVsbCwKICAgICAgICAgICAgICAgIGZpbGVfbmFtZTogbnVsbCwKICAgICAgICAgICAgICAgIGlzRWRpdDogZmFsc2UsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBwYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkocGF5bG9hZCk7CiAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgICAgICAgbGljZW5zZV9rZXk6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICAgIHRva2VuOiB2bS5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgICB0b2tlbjogdm0uYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgICAgICByb2xlOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHZtLnJlZnJlc2hlZF9vcl9jbG9zZWQsCiAgICAgICAgICAgICAgICAgIGNoYXQ6ICIiLAogICAgICAgICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICAgICAgICBkYXRhOiBwYXlsb2FkLAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC50aGVuKChyZXNwKSA9PiB7CiAgICAgICAgICAgICAgICAgIHZtLmNoYXQucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHJlY2VpdmVkOgogICAgICAgICAgICAgICAgICAgICAgcmVzcC5kYXRhLnJlc3BvbnNlcy5sZW5ndGggPT0gMAogICAgICAgICAgICAgICAgICAgICAgICA/ICJTb3JyeSBJJ20gbm90IGdldHRpbmcgeW91ciBxdWVzdGlvbiIKICAgICAgICAgICAgICAgICAgICAgICAgOiByZXNwLmRhdGEucmVzcG9uc2VzW2ldLnRleHQsCiAgICAgICAgICAgICAgICAgICAgdGltZTogdm0uZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgICAgICAgICAgIGltYWdlOiByZXNwLmRhdGEucmVzcG9uc2VzW2ldLmltZywKICAgICAgICAgICAgICAgICAgICB2aWRlbzogcmVzcC5kYXRhLnJlc3BvbnNlc1tpXS52aWRlbyB8fCBudWxsLAogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgLy8gdm0uJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB2bS5jaGF0KTsKICAgICAgICAgICAgICAgICAgdm0ubmV3X3VwZGF0ZV9yZXNwb25zZShpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmludGVudCA9PSAiY3JlYXRlX2FwcG9pbnRtZW50IgogICAgICAgICAgICApIHsKICAgICAgICAgICAgICBsZXQgdG9kYXlfZGF0ZSA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5zY2hlZHVsZV9hcHBvaW50bWVudF91cmwoKSwgewogICAgICAgICAgICAgICAgICBjb21wYW55X25hbWU6IHZtLmNvbXBhbnluYW1lLAogICAgICAgICAgICAgICAgICBjb21wYW55X2lkOiB2bS5jb21wYW55aWQsCiAgICAgICAgICAgICAgICAgIERhdGU6CiAgICAgICAgICAgICAgICAgICAgdG9kYXlfZGF0ZS5nZXRGdWxsWWVhcigpICsKICAgICAgICAgICAgICAgICAgICAiLSIgKwogICAgICAgICAgICAgICAgICAgICh0b2RheV9kYXRlLmdldE1vbnRoKCkgPCA5CiAgICAgICAgICAgICAgICAgICAgICA/ICIwIiArICh0b2RheV9kYXRlLmdldE1vbnRoKCkgKyAxKQogICAgICAgICAgICAgICAgICAgICAgOiB0b2RheV9kYXRlLmdldE1vbnRoKCkgKyAxKSArCiAgICAgICAgICAgICAgICAgICAgIi0iICsKICAgICAgICAgICAgICAgICAgICB0b2RheV9kYXRlLmdldERhdGUoKSwgLy8gTW9udGggb2JqZWN0IGRvY3VtZW50IGl0CiAgICAgICAgICAgICAgICAgIC8vIERhdGU6IHN0YXJ0X3RpbWUsCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKHJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgICAgICAgICAvLyB0aGlzLnRpbWVfc2xvdHMgPSB0aGlzLmZ1bGxfdGltZV9zbG90czsKICAgICAgICAgICAgICAgICAgLy8gaWYgKHJlc3BvbnNlLmRhdGEuU2xvdCAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgLy8gICBpZiAocmVzcG9uc2UuZGF0YS5TbG90Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgLy8gICAgIGxldCBpbmRleDsKICAgICAgICAgICAgICAgICAgLy8gICAgIGZvciAodmFyIGkgaW4gcmVzcG9uc2UuZGF0YS5TbG90KSB7CiAgICAgICAgICAgICAgICAgIC8vICAgICAgIGluZGV4ID0gdGhpcy50aW1lX3Nsb3RzLmluZGV4T2YocmVzcG9uc2UuZGF0YS5TbG90W2ldKTsKICAgICAgICAgICAgICAgICAgLy8gICAgICAgaWYgKGluZGV4ICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgdGhpcy50aW1lX3Nsb3RzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgICAgICAgIC8vICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gICAgIH0KICAgICAgICAgICAgICAgICAgLy8gICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAvLyAgIH0KICAgICAgICAgICAgICAgICAgLy8gfQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZtLnNlbmRfcmVxdWVzdF9qc29uKHJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQgPT0gInJlX29yZGVyX3Byb2R1Y3RzX2FjdGlvbiIKICAgICAgICAgICkgewogICAgICAgICAgICAvLyB2bS5zZW5kX3JldGFpbF9jdXN0b21lcl9pZCgpOwogICAgICAgICAgICBsZXQgbXNnID0gewogICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICAgIHRpbWU6CiAgICAgICAgICAgICAgICBpID09IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzLmxlbmd0aCAtIDEKICAgICAgICAgICAgICAgICAgPyB2bS5nZW5lcmF0ZV90aW1lKCkKICAgICAgICAgICAgICAgICAgOiBudWxsLAogICAgICAgICAgICAgIGFza19mZWVkYmFjazogQm9vbGVhbihyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5hc2tfZmVlZGJhY2spLAogICAgICAgICAgICB9OwogICAgICAgICAgICBtc2cucmVjZWl2aW5nID0gdHJ1ZTsKICAgICAgICAgICAgbXNnLmZldGNoX3Nob3BpZnlfZGV0YWlscyA9IHRydWU7CiAgICAgICAgICAgIG1zZy5pc19yZWZ1bmQgPSBmYWxzZTsKICAgICAgICAgICAgbXNnLnJldHVybl9zaG9waWZ5X2VtYWlsID0gdHJ1ZTsKICAgICAgICAgICAgbXNnLnJlY2VpdmVkID0KICAgICAgICAgICAgICAiUGxlYXNlIGxvZ2luIHdpdGggeW91ciBjcmVkZW50aWFscyBmb3IgYmV0dGVyIGV4cGVyaWVuY2UgOikiOwogICAgICAgICAgICBtc2cubWV0YWRhdGEgPSB7CiAgICAgICAgICAgICAgZW50aXR5OiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5lbnRpdHksCiAgICAgICAgICAgICAgdGV4dDogcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICAgIC8vIHZtLnNlbmRfcmV0YWlsX2N1c3RvbWVyX2lkKG51bGwsZmFsc2UscmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0pOwogICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW50ZW50ID09ICJzdXBwb3J0X3N1YnNjcmlwdGlvbl9kYXRhIgogICAgICAgICAgKSB7CiAgICAgICAgICAgIC8vIHZtLnNlbmRfcmV0YWlsX2N1c3RvbWVyX2lkKCk7CiAgICAgICAgICAgIHZtLnN1cHBvcnRfc3Vic2NyaXB0aW9uX2RhdGEoKTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW50ZW50ID09ICJwcm9kdWN0X2J5X2RhdGUiKSB7CiAgICAgICAgICAgIHZtLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICAgICAgICBsZXQgY3V0b2ZmID0gbmV3IERhdGUoKTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRfZGF0ZV90aW1lID0gbW9tZW50KGN1dG9mZikuZm9ybWF0KAogICAgICAgICAgICAgICJZWVlZLU1NLUREIEhIOm1tOnNzIgogICAgICAgICAgICApOwoKICAgICAgICAgICAgbGV0IGZvcm1fcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICB1c3JfbXNnOiByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS51c3JfbXNnLAogICAgICAgICAgICAgIGN1cnJlbnRfdXNlcl9kYXRlOiBjdXJyZW50X2RhdGVfdGltZSwKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBheGlvcwogICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgdG9rZW46IHZtLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgdG9rZW46IHZtLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICAgIHJvbGU6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHZtLnJlZnJlc2hlZF9vcl9jbG9zZWQsCiAgICAgICAgICAgICAgICBjaGF0OiBgL3Byb2R1Y3RfYnlfZGF0ZSR7Zm9ybV9wYXlsb2FkfWAsCiAgICAgICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICB2bS5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICBCb29sZWFuKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnJldHVybl9pbnRlbnQpID09IHRydWUKICAgICAgICAgICkgewogICAgICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICAgICAgICBheGlvcwogICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgdG9rZW46IHZtLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgdG9rZW46IHZtLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICAgIHJvbGU6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHZtLnJlZnJlc2hlZF9vcl9jbG9zZWQsCiAgICAgICAgICAgICAgICBjaGF0OiAiLyIgKyByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQsCiAgICAgICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICB2bS5oYW5kbGVfcmVzcG9uc2UocmVzcG9uc2UpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgdm0uY29tcGFueWlkID09ICIzeDVpdmU5OTUzNCIgJiYKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW50ZW50ICE9IHVuZGVmaW5lZCAmJgogICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbnRlbnQgPT0gImNvbmZ1c2lvbiIKICAgICAgICAgICkgewogICAgICAgICAgICB2bS5jb25mdXNpb25fbWVzc2FnZSgiL25lZWRfaGVscCIpOwogICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uYnV0dG9ucyAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uYnV0dG9ucy5sZW5ndGggPiAwCiAgICAgICAgICApIHsKICAgICAgICAgICAgdm0ubG9hZF9idXR0b25zKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLCBpLCB0eXBlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgIEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY3VzdG9tKSAmJgogICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20udHlwZQogICAgICAgICAgKSB7CiAgICAgICAgICAgIC8vIENIYW5nZSAgdGhlIGNvbmRpdGlvbiBoZXJlCiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20udHlwZSAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20udHlwZSA9PSAibXVsdGlzZWxlY3RfZHJvcGRvd24iCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHZtLm11bHRpc2VsZWN0X2xvYWQocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0sIGkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmN1c3RvbS50eXBlICE9IHVuZGVmaW5lZCAmJgogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmN1c3RvbS50eXBlID09ICJ0YWJsZSIKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdm0ubG9hZF90YWJsZShyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXSwgaSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY3VzdG9tLnR5cGUgIT0gdW5kZWZpbmVkICYmCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY3VzdG9tLnR5cGUgPT0gInJldGFpbCIKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdm0uZGlzcGxheV9wcm9kdWN0c19jaGF0KHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLCBpLCB0eXBlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5jdXN0b20uc2hvd190ZXh0X2FyZWEpIHsKICAgICAgICAgICAgICB2bS5sb2FkX3RleHRfYXJlYShyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXSwgaSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY3VzdG9tLmJ1dHRvbnMgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgdm0ubG9hZF9idXR0b25zKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmN1c3RvbSwgaSwgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgIEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ubWVzc2FnaW5nX3BsYXRmb3JtcykgJiYKICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ubWVzc2FnaW5nX3BsYXRmb3Jtcy5sZW5ndGggPiAwCiAgICAgICAgICApIHsKICAgICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgICAvLyBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICB0aW1lOgogICAgICAgICAgICAgICAgaSA9PSByZXNwb25zZS5kYXRhLnJlc3BvbnNlcy5sZW5ndGggLSAxCiAgICAgICAgICAgICAgICAgID8gdm0uZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgICAgICAgICAgIDogbnVsbCwKICAgICAgICAgICAgICBhc2tfZmVlZGJhY2s6IEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uYXNrX2ZlZWRiYWNrKSwKICAgICAgICAgICAgICBzaG93X21lc3NhZ2luZ19wbGF0Zm9ybXM6IHRydWUsCiAgICAgICAgICAgICAgbWVzc2FnaW5nX3BsYXRmb3Jtc19kYXRhOgogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ubWVzc2FnaW5nX3BsYXRmb3JtcywKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICB9IGVsc2UgaWYgKEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaXNfcHJldmlld19iYW5uZXIpKSB7CiAgICAgICAgICAgIHZtLmRpc3BsYXlfYmFubmVyKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzLCBpKTsKICAgICAgICAgIH0gZWxzZSBpZiAoQm9vbGVhbihyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pc19kaXNwbGF5X2Jhbm5lcikpIHsKICAgICAgICAgICAgdm0uZGlzcGxheV9iYW5uZXIocmVzcG9uc2UuZGF0YS5yZXNwb25zZXMsIGkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICB0aW1lOgogICAgICAgICAgICAgICAgaSA9PSByZXNwb25zZS5kYXRhLnJlc3BvbnNlcy5sZW5ndGggLSAxCiAgICAgICAgICAgICAgICAgID8gdm0uZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgICAgICAgICAgIDogbnVsbCwKICAgICAgICAgICAgICBhc2tfZmVlZGJhY2s6IEJvb2xlYW4ocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uYXNrX2ZlZWRiYWNrKSwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgICAgbXNnLnJlY2VpdmVkID0gIlNvcnJ5IHdlIGFyZSBub3QgZ2V0dGluZyB5b3VyIHF1ZXN0aW9uLiI7CiAgICAgICAgICAgICAgbXNnLnJlY2VpdmluZyA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGVtcGxhdGUgPT09ICJ1dHRlcl9kZWZhdWx0IgogICAgICAgICAgICApIHsKICAgICAgICAgICAgICBtc2cucmVjZWl2aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICBtc2cucmVjZWl2ZWQgPSByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5tZXNzYWdlCiAgICAgICAgICAgICAgICAuc3BsaXQoIntlbWFpbH0iKQogICAgICAgICAgICAgICAgLmpvaW4odm0uY29udGFjdF9oZWxwX2VtYWlsKTsKICAgICAgICAgICAgICB2bS5jaGF0LnB1c2gobXNnKTsKICAgICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0ICE9IHVuZGVmaW5lZCAmJgogICAgICAgICAgICAgIHZtLnVybF9tYXRjaF9yZWdleC50ZXN0KHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQpCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHZtLmRpc3BsYXlfZmlsZV9jaGF0KHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnRleHQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmdldF9jb21wYW55X2RldGFpbHMgPT09ICJUcnVlIiAmJgogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmludGVudCA9PT0gImNlbnNlX3N1cHBvcnRfdGlja2V0IgogICAgICAgICAgICApIHsKICAgICAgICAgICAgICBsZXQgY19pZCA9IHZtLnJldHVybl9kb2N1bWVudF9jb29raWVzKCJjb21wYW55X2lkIik7CiAgICAgICAgICAgICAgbGV0IGNfbmFtZSA9IHZtLnJldHVybl9kb2N1bWVudF9jb29raWVzKCJjb21wYW55X25hbWUiKTsKICAgICAgICAgICAgICBsZXQgY19lbWFpbCA9IHZtLnJldHVybl9kb2N1bWVudF9jb29raWVzKCJjb21wYW55X2VtYWlsIik7CiAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgICAgICAgbGljZW5zZV9rZXk6IHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICAgIHRva2VuOiB2bS5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgICAgICB0b2tlbjogdm0uYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgICAgICByb2xlOiB2bS4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHZtLnJlZnJlc2hlZF9vcl9jbG9zZWQsCiAgICAgICAgICAgICAgICAgIGNoYXQ6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICAgICAgICBjb21wYW55X2lkOiBjX2lkLAogICAgICAgICAgICAgICAgICAgIGNvbXBhbnlfbmFtZTogY19uYW1lLAogICAgICAgICAgICAgICAgICAgIGVtYWlsOiBjX2VtYWlsLAogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICAgICAgdm0ucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICAhcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dC5pbmNsdWRlcygKICAgICAgICAgICAgICAgICJEb3dubG9hZCB5b3VyIG1hbmlmZXN0IGhlcmUiCiAgICAgICAgICAgICAgKQogICAgICAgICAgICApIHsKICAgICAgICAgICAgICBtc2cucmVjZWl2ZWQgPSByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0OwogICAgICAgICAgICAgIG1zZy5yZWNlaXZpbmcgPSB0cnVlOwogICAgICAgICAgICAgIG1zZy5pbWFnZSA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmltZzsKICAgICAgICAgICAgICBtc2cuaW1hZ2UgPSByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbWFnZTsKICAgICAgICAgICAgICBtc2cudmlkZW9zID0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udmlkZW8gfHwgZmFsc2U7CiAgICAgICAgICAgICAgbXNnLm9yZGVyX3N0YXR1cyA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLm9yZGVyX3N0YXR1czsKICAgICAgICAgICAgICBtc2cuaXNfb3JkZXJfc3RhdHVzID0KICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmlzX29yZGVyX3N0YXR1cyB8fCBmYWxzZTsKICAgICAgICAgICAgICBtc2cub2ZmZXJzID0gcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ub2ZmZXJzIHx8IGZhbHNlOwogICAgICAgICAgICAgIG1zZy5mZXRjaF9zaG9waWZ5X2RldGFpbHMgPQogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzIHx8IGZhbHNlOwogICAgICAgICAgICAgIG1zZy5vcmRlcl9pdGVtcyA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLm9yZGVyX2l0ZW1zOwogICAgICAgICAgICAgIG1zZy5zaG9waWZ5X2ZldGNoX2N1c3RvbWVyX2lkX2Zvcl9vZmZlcnMgPQogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0KICAgICAgICAgICAgICAgICAgLnNob3BpZnlfZmV0Y2hfY3VzdG9tZXJfaWRfZm9yX29mZmVycyB8fCBmYWxzZTsKICAgICAgICAgICAgICBpZiAobXNnLm9mZmVycy5sZW5ndGggPCAxKSB7CiAgICAgICAgICAgICAgICBtc2cub2ZmZXJzID0gZmFsc2U7CiAgICAgICAgICAgICAgICBtc2cucmVjZWl2ZWQgPQogICAgICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS50ZXh0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBTb3JyeSB3ZSBkbyBub3QgaGF2IGFueSBvZmZlcnMgY3VycmVudGx5LCBwbGVhc2UgY2hlY2sgYmFjayBsYXRlci4iOwogICAgICAgICAgICAgIHZtLmNoYXQucHVzaChtc2cpOwogICAgICAgICAgICAgIHZtLm5ld191cGRhdGVfcmVzcG9uc2UoaSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uaW50ZW50ID09ICJjaGF0X3N1cHBvcnQiKSB7CiAgICAgICAgICAgICAgdm0uc3RhcnRfbGl2ZV9jaGF0KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dCAhPSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dC5pbmNsdWRlcygKICAgICAgICAgICAgICAgICJEb3dubG9hZCB5b3VyIG1hbmlmZXN0IGhlcmUiCiAgICAgICAgICAgICAgKSB8fAogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0udGV4dC5pbmNsdWRlcygvLnBkZi8pKQogICAgICAgICAgICApIHsKICAgICAgICAgICAgICB2bS5kaXNwbGF5X2ZpbGVfY2hhdChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgQm9vbGVhbihyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5wcm9kdWN0cykgJiYKICAgICAgICAgICAgICAocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ucHJvZHVjdHMubGVuZ3RoID4gMCB8fAogICAgICAgICAgICAgICAgT2JqZWN0LmtleXMocmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0ucHJvZHVjdHMpLmxlbmd0aCkKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdm0uZGlzcGxheV9wcm9kdWN0c19jaGF0KHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLCBpLCB0eXBlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pc19yZWZ1bmQgPT0gIlRydWUiKSB7CiAgICAgICAgICAgICAgdm0ubG9hZF9yZWZ1bmRzKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldKTsKICAgICAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgICAgICByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5zaG9waWZ5X2ZldGNoX2N1c3RvbWVyX2lkID09PSB0cnVlCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHZtLnJldGFpbF9jaGVja19jdXN0b21lcl9sb2dnZWRfaW4oKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbWFnZSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBtc2cuaW1hZ2UgPSByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS5pbWFnZTsKICAgICAgICAgICAgICBtc2cucmVjZWl2aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICB2bS5jaGF0LnB1c2gobXNnKTsKICAgICAgICAgICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLnZpZGVvICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIG1zZy52aWRlb3MgPSByZXNwb25zZS5kYXRhLnJlc3BvbnNlc1tpXS52aWRlbyB8fCBmYWxzZTsKICAgICAgICAgICAgICBtc2cucmVjZWl2aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICB2bS5jaGF0LnB1c2gobXNnKTsKICAgICAgICAgICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmNhcmQgIT0gdW5kZWZpbmVkICYmCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbaV0uY2FyZC5sZW5ndGggIT09IDAKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgbXNnLmNhcm91c2VsX2NhcmRfbGlzdCA9IHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzW2ldLmNhcmQ7CiAgICAgICAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICAgICAgdm0ubmV3X3VwZGF0ZV9yZXNwb25zZShpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGkgPCByZXNwb25zZS5kYXRhLnJlc3BvbnNlcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgIGkgKz0gMTsKICAgICAgICAgICAgdm0uaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgICAgICAgIGRlbGF5ID0gNTAwOwogICAgICAgICAgICBoYW5kbGVfcmVzcG9uc2UoKTsKICAgICAgICAgIH0KICAgICAgICB9LCBkZWxheSk7CiAgICAgIH0KICAgIH0sCiAgICBkaXNwbGF5X2Jhbm5lcihyZXNwb25zZSwgaSkgewogICAgICB2YXIgdm0gPSB0aGlzOwogICAgICB2YXIgcG9zaXRpb25fMSA9IHJlc3BvbnNlW2ldLmJhbm5lcl9jb250ZW50X3Bvc2l0aW9uWzBdWyJpZCJdOwogICAgICB2YXIgcG9zaXRpb25fMiA9IHJlc3BvbnNlW2ldLmJhbm5lcl9jb250ZW50X3Bvc2l0aW9uWzFdWyJpZCJdOwogICAgICB2YXIgcG9zaXRpb25fMyA9IHJlc3BvbnNlW2ldLmJhbm5lcl9jb250ZW50X3Bvc2l0aW9uWzJdWyJpZCJdOwogICAgICB2YXIgaXNfZGF0YV9wb3NpdGlvbl8xID0gcmVzcG9uc2VbaV1bcG9zaXRpb25fMV07CiAgICAgIHZhciBpc19kYXRhX3Bvc2l0aW9uXzIgPSByZXNwb25zZVtpXVtwb3NpdGlvbl8yXTsKICAgICAgdmFyIGlzX2RhdGFfcG9zaXRpb25fMyA9IHJlc3BvbnNlW2ldW3Bvc2l0aW9uXzNdOwogICAgICBpZiAoQm9vbGVhbihpc19kYXRhX3Bvc2l0aW9uXzEpKSB7CiAgICAgICAgdmFyIG1zZyA9IHsKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgdGltZToKICAgICAgICAgICAgaSA9PSByZXNwb25zZS5sZW5ndGggLSAxICYmCiAgICAgICAgICAgICEoQm9vbGVhbihpc19kYXRhX3Bvc2l0aW9uXzIpIHx8IEJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8zKSkKICAgICAgICAgICAgICA/IHZtLmdlbmVyYXRlX3RpbWUoKQogICAgICAgICAgICAgIDogbnVsbCwKICAgICAgICAgIGFza19mZWVkYmFjazogQm9vbGVhbihyZXNwb25zZVtpXS5hc2tfZmVlZGJhY2spLAogICAgICAgICAgYmFubmVyX2ltZ19saW5rOiByZXNwb25zZVtpXS5iYW5uZXJfaW1nX2xpbmssCiAgICAgICAgfTsKICAgICAgICBtc2cuc2hvd19ib3RfaW1nID0gdHJ1ZTsKICAgICAgICBtc2dbInNob3dfIiArIHBvc2l0aW9uXzFdID0gdHJ1ZTsKICAgICAgICBtc2dbcG9zaXRpb25fMV0gPSBpc19kYXRhX3Bvc2l0aW9uXzE7CiAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgdm0ubmV3X3VwZGF0ZV9yZXNwb25zZShpKTsKICAgICAgICBpZiAoQm9vbGVhbihpc19kYXRhX3Bvc2l0aW9uXzIpKSB7CiAgICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgdGltZToKICAgICAgICAgICAgICBpID09IHJlc3BvbnNlLmxlbmd0aCAtIDEgJiYgIUJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8zKQogICAgICAgICAgICAgICAgPyB2bS5nZW5lcmF0ZV90aW1lKCkKICAgICAgICAgICAgICAgIDogbnVsbCwKICAgICAgICAgICAgYXNrX2ZlZWRiYWNrOiBCb29sZWFuKHJlc3BvbnNlW2ldLmFza19mZWVkYmFjayksCiAgICAgICAgICAgIGJhbm5lcl9pbWdfbGluazogcmVzcG9uc2VbaV0uYmFubmVyX2ltZ19saW5rLAogICAgICAgICAgfTsKICAgICAgICAgIG1zZy5zaG93X2JvdF9pbWcgPSBmYWxzZTsKICAgICAgICAgIG1zZ1sic2hvd18iICsgcG9zaXRpb25fMl0gPSB0cnVlOwogICAgICAgICAgbXNnW3Bvc2l0aW9uXzJdID0gaXNfZGF0YV9wb3NpdGlvbl8yOwogICAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwogICAgICAgIH0KICAgICAgICBpZiAoQm9vbGVhbihpc19kYXRhX3Bvc2l0aW9uXzMpKSB7CiAgICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgdGltZTogaSA9PSByZXNwb25zZS5sZW5ndGggLSAxID8gdm0uZ2VuZXJhdGVfdGltZSgpIDogbnVsbCwKICAgICAgICAgICAgYXNrX2ZlZWRiYWNrOiBCb29sZWFuKHJlc3BvbnNlW2ldLmFza19mZWVkYmFjayksCiAgICAgICAgICAgIGJhbm5lcl9pbWdfbGluazogcmVzcG9uc2VbaV0uYmFubmVyX2ltZ19saW5rLAogICAgICAgICAgfTsKICAgICAgICAgIG1zZy5zaG93X2JvdF9pbWcgPSBmYWxzZTsKICAgICAgICAgIG1zZ1sic2hvd18iICsgcG9zaXRpb25fM10gPSB0cnVlOwogICAgICAgICAgbXNnW3Bvc2l0aW9uXzNdID0gaXNfZGF0YV9wb3NpdGlvbl8zOwogICAgICAgICAgdm0uY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChCb29sZWFuKGlzX2RhdGFfcG9zaXRpb25fMikpIHsKICAgICAgICB2YXIgbXNnID0gewogICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICB0aW1lOgogICAgICAgICAgICBpID09IHJlc3BvbnNlLmxlbmd0aCAtIDEgJiYgIUJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8zKQogICAgICAgICAgICAgID8gdm0uZ2VuZXJhdGVfdGltZSgpCiAgICAgICAgICAgICAgOiBudWxsLAogICAgICAgICAgYXNrX2ZlZWRiYWNrOiBCb29sZWFuKHJlc3BvbnNlW2ldLmFza19mZWVkYmFjayksCiAgICAgICAgICBiYW5uZXJfaW1nX2xpbms6IHJlc3BvbnNlW2ldLmJhbm5lcl9pbWdfbGluaywKICAgICAgICB9OwogICAgICAgIG1zZy5zaG93X2JvdF9pbWcgPSB0cnVlOwogICAgICAgIG1zZ1sic2hvd18iICsgcG9zaXRpb25fMl0gPSB0cnVlOwogICAgICAgIG1zZ1twb3NpdGlvbl8yXSA9IGlzX2RhdGFfcG9zaXRpb25fMjsKICAgICAgICB2bS5jaGF0LnB1c2gobXNnKTsKICAgICAgICB2bS5uZXdfdXBkYXRlX3Jlc3BvbnNlKGkpOwogICAgICAgIGlmIChCb29sZWFuKGlzX2RhdGFfcG9zaXRpb25fMykpIHsKICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgICB0aW1lOiBpID09IHJlc3BvbnNlLmxlbmd0aCAtIDEgPyB2bS5nZW5lcmF0ZV90aW1lKCkgOiBudWxsLAogICAgICAgICAgICBhc2tfZmVlZGJhY2s6IEJvb2xlYW4ocmVzcG9uc2VbaV0uYXNrX2ZlZWRiYWNrKSwKICAgICAgICAgICAgYmFubmVyX2ltZ19saW5rOiByZXNwb25zZVtpXS5iYW5uZXJfaW1nX2xpbmssCiAgICAgICAgICB9OwogICAgICAgICAgbXNnLnNob3dfYm90X2ltZyA9IGZhbHNlOwogICAgICAgICAgbXNnWyJzaG93XyIgKyBwb3NpdGlvbl8zXSA9IHRydWU7CiAgICAgICAgICBtc2dbcG9zaXRpb25fM10gPSBpc19kYXRhX3Bvc2l0aW9uXzM7CiAgICAgICAgICB2bS5jaGF0LnB1c2gobXNnKTsKICAgICAgICAgIHZtLm5ld191cGRhdGVfcmVzcG9uc2UoaSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKEJvb2xlYW4oaXNfZGF0YV9wb3NpdGlvbl8zKSkgewogICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIHRpbWU6IGkgPT0gcmVzcG9uc2UubGVuZ3RoIC0gMSA/IHZtLmdlbmVyYXRlX3RpbWUoKSA6IG51bGwsCiAgICAgICAgICBhc2tfZmVlZGJhY2s6IEJvb2xlYW4ocmVzcG9uc2VbaV0uYXNrX2ZlZWRiYWNrKSwKICAgICAgICAgIGJhbm5lcl9pbWdfbGluazogcmVzcG9uc2VbaV0uYmFubmVyX2ltZ19saW5rLAogICAgICAgIH07CiAgICAgICAgbXNnLnNob3dfYm90X2ltZyA9IHRydWU7CiAgICAgICAgbXNnWyJzaG93XyIgKyBwb3NpdGlvbl8zXSA9IHRydWU7CiAgICAgICAgbXNnW3Bvc2l0aW9uXzNdID0gaXNfZGF0YV9wb3NpdGlvbl8zOwogICAgICAgIHZtLmNoYXQucHVzaChtc2cpOwogICAgICAgIHZtLm5ld191cGRhdGVfcmVzcG9uc2UoaSk7CiAgICAgIH0KICAgIH0sCiAgICBwdXNoX21zZyhyZXNwb25zZXMsIHJlc3BvbnNlKSB7CiAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgIHZhciB2bSA9IHRoaXM7CiAgICAgIHZhciBkZWxheSA9IDUwOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3BvbnNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICB2YXIgbXNnID0gcmVzcG9uc2VbaV07CiAgICAgICAgICB2bS5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKICAgICAgICAgIHZtLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgcmVzcG9uc2VzLmRhdGEucmVzcG9uc2VzW2ldLmJ1dHRvbnMgIT0gdW5kZWZpbmVkICYmCiAgICAgICAgICAgIEJvb2xlYW4ocmVzcG9uc2VzLmRhdGEucmVzcG9uc2VzW2ldLmJ1dHRvbnMubGVuZ3RoID4gMCkKICAgICAgICAgICkgewogICAgICAgICAgICB2bS5sb2FkX2J1dHRvbnMoCiAgICAgICAgICAgICAgcmVzcG9uc2VzLmRhdGEucmVzcG9uc2VzW2ldLAogICAgICAgICAgICAgICJpc19idXR0b24iLAogICAgICAgICAgICAgICJ3ZWxjb21lX21lc3NhZ2UiLAogICAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZtLmNoYXQucHVzaCh7CiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgIHJlY2VpdmVkOiBtc2cudGV4dCwKICAgICAgICAgICAgICBvZmZlcnM6IG1zZy5vZmZlcnMgfHwgZmFsc2UsCiAgICAgICAgICAgICAgdGltZTogaSA9PSByZXNwb25zZS5sZW5ndGggLSAxID8gdm0uZ2VuZXJhdGVfdGltZSgpIDogdW5kZWZpbmVkLAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLmdyZWV0aW5nX2J1dHRvbnNfcG9zaXRpb24gPT0gaSkgewogICAgICAgICAgICBpZiAodm0uaXNfcmV0YWlsX2JvdCkgdm0ubG9hZF9jaGF0Ym90X2ludGVncmF0aW9uX2RldGFpbHMoKTsKICAgICAgICAgIH0KICAgICAgICB9LCBpICogMTA1MCk7CiAgICAgICAgJCgiLnRpbWUiKS5sYXN0KCkuY3NzKCJkaXNwbGF5IiwgIm5vbmUiKTsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICQoIi50aW1lIikubGFzdCgpLmNzcygiZGlzcGxheSIsICJibG9jayIpOwogICAgICAgICAgaWYgKGkgPCByZXNwb25zZS5sZW5ndGggLSAxKSB7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2bS53ZWxjb21lX21lc3NhZ2Vfbm90X3lldF9yZWNlaXZlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0sIDUwMCk7CiAgICAgIH0KICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgdm0uZGVtb19yZXRhaWxfcXVlc3Rpb24oKTsKICAgICAgfSwgZGVsYXkpOwogICAgfSwKICAgIGNvbmZ1c2lvbl9tZXNzYWdlKG1zZ19zdHJpbmcpIHsKICAgICAgYXhpb3MKICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICBjaGF0OiBtc2dfc3RyaW5nLAogICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgZGF0YTogIiIsCiAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IGZhbHNlLAogICAgICAgIH0pCiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKTsKICAgICAgICB9KTsKICAgIH0sCiAgICBkaXNwbGF5X3Byb2R1Y3RzX2NoYXQobWVzc2FnZSwgaW5kZXgsIHR5cGUpIHsKICAgICAgdmFyIG1zZyA9IHsKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgfTsKICAgICAgaWYgKG1lc3NhZ2UucHJvZHVjdHMuaXNfcHJvZHVjdHNfbGlzdCkgewogICAgICAgIG1zZy5pc19wcm9kdWN0c19saXN0ID0gbWVzc2FnZS5wcm9kdWN0cy5pc19wcm9kdWN0c19saXN0OwogICAgICAgIG1zZy5wcm9kdWN0c19saXN0ID0gbWVzc2FnZS5wcm9kdWN0cy5wcm9kdWN0c19saXN0OwogICAgICAgIGlmIChtZXNzYWdlLnByb2R1Y3RzLnByb2R1Y3RzX2xpc3QubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICBtc2cucmVjZWl2ZWQgPSAiU29ycnksIHdlIGNvdWxkIG5vdCBmaW5kIHdoYXQgeW91IHNlYXJjaGVkIGZvciI7CiAgICAgICAgICBtc2cucmVjZWl2aW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKEJvb2xlYW4obWVzc2FnZS5wcm9kdWN0cy50ZXh0KSA9PT0gdHJ1ZSkgewogICAgICAgICAgbXNnLnJlY2VpdmVkID0gbWVzc2FnZS5wcm9kdWN0cy50ZXh0OwogICAgICAgICAgbXNnLnJlY2VpdmluZyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHRoaXMucHJvZHVjdF9vdXRfb2Zfc3RvY2tfbGlzdCA9IFtdOwoKICAgICAgICBpZiAodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIpIHsKICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0LmZvckVhY2goKHByb2R1Y3QpID0+IHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9kdWN0LnZhcmlhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB0aGlzLnByb2R1Y3RfbGlzdC5wdXNoKHsKICAgICAgICAgICAgICAgIHByb2R1Y3RfaWQ6IHByb2R1Y3QudmFyaWF0aW9uc1tpXS5pZCwKICAgICAgICAgICAgICAgIHByb2R1Y3RfdGl0bGU6IHByb2R1Y3QudGl0bGUsCiAgICAgICAgICAgICAgICB2YXJpYW50X3RpdGxlOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0udmFyaWFudF90aXRsZSwKICAgICAgICAgICAgICAgIHZhcmlhbnRfaWQ6IHByb2R1Y3QudmFyaWF0aW9uc1tpXS5pZCwKICAgICAgICAgICAgICAgIHN0b2NrX3N0YXR1czogcHJvZHVjdC52YXJpYXRpb25zW2ldLnN0b2NrX3N0YXR1cyB8fCAiaW5zdG9jayIsCiAgICAgICAgICAgICAgICBiYWNrX2luX3N0b2NrOiBmYWxzZSwKICAgICAgICAgICAgICAgIHByb2R1Y3RJbWFnZToKICAgICAgICAgICAgICAgICAgcHJvZHVjdC52YXJpYXRpb25zW2ldLmltZ191cmwgPT0gbnVsbAogICAgICAgICAgICAgICAgICAgID8gcHJvZHVjdC5pbWdfdXJsCiAgICAgICAgICAgICAgICAgICAgOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0uaW1nX3VybCwKICAgICAgICAgICAgICAgIG9ubGluZVN0b3JlVVJMOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0ucGVybWFsaW5rLAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIndvb2NvbW1lcmNlIikgewogICAgICAgICAgbXNnLnByb2R1Y3RzX2xpc3QuZm9yRWFjaCgocHJvZHVjdCkgPT4gewogICAgICAgICAgICBpZiAocHJvZHVjdC52YXJpYXRpb25zICYmIHByb2R1Y3QudmFyaWF0aW9ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9kdWN0LnZhcmlhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMucHJvZHVjdF9saXN0LnB1c2goewogICAgICAgICAgICAgICAgICBwcm9kdWN0X2lkOiBwcm9kdWN0LmlkLAogICAgICAgICAgICAgICAgICBwcm9kdWN0X3RpdGxlOiBwcm9kdWN0LnRpdGxlLAogICAgICAgICAgICAgICAgICB2YXJpYW50X3RpdGxlOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0udmFyaWFudF90aXRsZSwKICAgICAgICAgICAgICAgICAgdmFyaWFudF9pZDogcHJvZHVjdC52YXJpYXRpb25zW2ldLmlkLAogICAgICAgICAgICAgICAgICBzdG9ja19zdGF0dXM6IHByb2R1Y3QudmFyaWF0aW9uc1tpXS5zdG9ja19zdGF0dXMgfHwgImluc3RvY2siLAogICAgICAgICAgICAgICAgICBiYWNrX2luX3N0b2NrOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgcHJvZHVjdEltYWdlOgogICAgICAgICAgICAgICAgICAgIHByb2R1Y3QudmFyaWF0aW9uc1tpXS5pbWdfdXJsID09IG51bGwKICAgICAgICAgICAgICAgICAgICAgID8gcHJvZHVjdC5pbWdfdXJsCiAgICAgICAgICAgICAgICAgICAgICA6IHByb2R1Y3QudmFyaWF0aW9uc1tpXS5pbWdfdXJsLAogICAgICAgICAgICAgICAgICBvbmxpbmVTdG9yZVVSTDogcHJvZHVjdC5wZXJtYWxpbmssCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5wcm9kdWN0X2xpc3QucHVzaCh7CiAgICAgICAgICAgICAgICBwcm9kdWN0X2lkOiBwcm9kdWN0LmlkLAogICAgICAgICAgICAgICAgcHJvZHVjdF90aXRsZTogcHJvZHVjdC50aXRsZSwKICAgICAgICAgICAgICAgIHZhcmlhbnRfdGl0bGU6IG51bGwsCiAgICAgICAgICAgICAgICB2YXJpYW50X2lkOiBudWxsLAogICAgICAgICAgICAgICAgc3RvY2tfc3RhdHVzOiBwcm9kdWN0LnN0b2NrX3N0YXR1cyB8fCAiaW5zdG9jayIsCiAgICAgICAgICAgICAgICBiYWNrX2luX3N0b2NrOiBmYWxzZSwKICAgICAgICAgICAgICAgIHByb2R1Y3RJbWFnZTogcHJvZHVjdC5pbWdfdXJsLAogICAgICAgICAgICAgICAgb25saW5lU3RvcmVVUkw6IHByb2R1Y3QucGVybWFsaW5rLAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iKSB7CiAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdC5mb3JFYWNoKChwcm9kdWN0KSA9PiB7CiAgICAgICAgICAgIGlmIChwcm9kdWN0LnZhcmlhdGlvbnMgJiYgcHJvZHVjdC52YXJpYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb2R1Y3QudmFyaWF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5wcm9kdWN0X2xpc3QucHVzaCh7CiAgICAgICAgICAgICAgICAgIHByb2R1Y3RfaWQ6IHByb2R1Y3QuaWQsCiAgICAgICAgICAgICAgICAgIHByb2R1Y3RfdGl0bGU6IHByb2R1Y3QudGl0bGUsCiAgICAgICAgICAgICAgICAgIHZhcmlhbnRfdGl0bGU6IHByb2R1Y3QudmFyaWF0aW9uc1tpXS52YXJpYW50X3RpdGxlLAogICAgICAgICAgICAgICAgICB2YXJpYW50X2lkOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0uaWQsCiAgICAgICAgICAgICAgICAgIHN0b2NrX3N0YXR1czogcHJvZHVjdC5zdG9ja19zdGF0dXMgfHwgImluc3RvY2siLAogICAgICAgICAgICAgICAgICBiYWNrX2luX3N0b2NrOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgcHJvZHVjdEltYWdlOgogICAgICAgICAgICAgICAgICAgIHByb2R1Y3QudmFyaWF0aW9uc1tpXS5pbWdfdXJsID09IG51bGwKICAgICAgICAgICAgICAgICAgICAgID8gcHJvZHVjdC5pbWdfdXJsCiAgICAgICAgICAgICAgICAgICAgICA6IHByb2R1Y3QudmFyaWF0aW9uc1tpXS5pbWdfdXJsLAogICAgICAgICAgICAgICAgICBvbmxpbmVTdG9yZVVSTDogcHJvZHVjdC52YXJpYXRpb25zW2ldLnBlcm1hbGluaywKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLnByb2R1Y3RfbGlzdC5wdXNoKHsKICAgICAgICAgICAgICAgIHByb2R1Y3RfaWQ6IHByb2R1Y3QuaWQsCiAgICAgICAgICAgICAgICBwcm9kdWN0X3RpdGxlOiBwcm9kdWN0LnRpdGxlLAogICAgICAgICAgICAgICAgdmFyaWFudF90aXRsZTogbnVsbCwKICAgICAgICAgICAgICAgIHZhcmlhbnRfaWQ6IG51bGwsCiAgICAgICAgICAgICAgICBzdG9ja19zdGF0dXM6IHByb2R1Y3Quc3RvY2tfc3RhdHVzIHx8ICJpbnN0b2NrIiwKICAgICAgICAgICAgICAgIGJhY2tfaW5fc3RvY2s6IGZhbHNlLAogICAgICAgICAgICAgICAgcHJvZHVjdEltYWdlOiBwcm9kdWN0LmltZ191cmwsCiAgICAgICAgICAgICAgICBvbmxpbmVTdG9yZVVSTDogcHJvZHVjdC5wZXJtYWxpbmssCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAiYmlnY29tbWVyY2UiKSB7CiAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdC5mb3JFYWNoKChwcm9kdWN0KSA9PiB7CiAgICAgICAgICAgIGlmIChwcm9kdWN0LnZhcmlhdGlvbnMgJiYgcHJvZHVjdC52YXJpYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb2R1Y3QudmFyaWF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5wcm9kdWN0X2xpc3QucHVzaCh7CiAgICAgICAgICAgICAgICAgIHByb2R1Y3RfaWQ6IHByb2R1Y3QuaWQsCiAgICAgICAgICAgICAgICAgIHByb2R1Y3RfdGl0bGU6IHByb2R1Y3QudGl0bGUsCiAgICAgICAgICAgICAgICAgIHZhcmlhbnRfdGl0bGU6IHByb2R1Y3QudmFyaWF0aW9uc1tpXS52YXJpYW50X3RpdGxlLAogICAgICAgICAgICAgICAgICB2YXJpYW50X2lkOiBwcm9kdWN0LnZhcmlhdGlvbnNbaV0uaWQsCiAgICAgICAgICAgICAgICAgIHN0b2NrX3N0YXR1czogcHJvZHVjdC5zdG9ja19zdGF0dXMgfHwgImluc3RvY2siLAogICAgICAgICAgICAgICAgICBiYWNrX2luX3N0b2NrOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgcHJvZHVjdEltYWdlOgogICAgICAgICAgICAgICAgICAgIHByb2R1Y3QudmFyaWF0aW9uc1tpXS5pbWdfdXJsID09IG51bGwKICAgICAgICAgICAgICAgICAgICAgID8gcHJvZHVjdC5pbWdfdXJsCiAgICAgICAgICAgICAgICAgICAgICA6IHByb2R1Y3QudmFyaWF0aW9uc1tpXS5pbWdfdXJsLAogICAgICAgICAgICAgICAgICBvbmxpbmVTdG9yZVVSTDogcHJvZHVjdC52YXJpYXRpb25zW2ldLnBlcm1hbGluaywKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLnByb2R1Y3RfbGlzdC5wdXNoKHsKICAgICAgICAgICAgICAgIHByb2R1Y3RfaWQ6IHByb2R1Y3QuaWQsCiAgICAgICAgICAgICAgICBwcm9kdWN0X3RpdGxlOiBwcm9kdWN0LnRpdGxlLAogICAgICAgICAgICAgICAgdmFyaWFudF90aXRsZTogbnVsbCwKICAgICAgICAgICAgICAgIHZhcmlhbnRfaWQ6IG51bGwsCiAgICAgICAgICAgICAgICBzdG9ja19zdGF0dXM6IHByb2R1Y3Quc3RvY2tfc3RhdHVzIHx8ICJpbnN0b2NrIiwKICAgICAgICAgICAgICAgIGJhY2tfaW5fc3RvY2s6IGZhbHNlLAogICAgICAgICAgICAgICAgcHJvZHVjdEltYWdlOiBwcm9kdWN0LmltZ191cmwsCiAgICAgICAgICAgICAgICBvbmxpbmVTdG9yZVVSTDogcHJvZHVjdC5wZXJtYWxpbmssCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpIGluIG1zZy5wcm9kdWN0c19saXN0KSB7CiAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS5idXlfcXR5ID0gMTsKICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0W2ldLm9yZGVyX3F0eSA9IDE7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0W2ldLnZhcmlhdGlvbnMgJiYKICAgICAgICAgICAgbXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9ucy5sZW5ndGggPiAwCiAgICAgICAgICApIHsKICAgICAgICAgICAgbXNnLnByb2R1Y3RzX2xpc3RbaV0uaWQgPSBtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYXRpb25zWzBdLmlkOwogICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS5pbWdfdXJsID0KICAgICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYXRpb25zWzBdLmltZ191cmwgPT09IG51bGwKICAgICAgICAgICAgICAgID8gbXNnLnByb2R1Y3RzX2xpc3RbaV0uaW1nX3VybAogICAgICAgICAgICAgICAgOiBtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYXRpb25zWzBdLmltZ191cmw7CiAgICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0W2ldLnBlcm1hbGluayA9CiAgICAgICAgICAgICAgbXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9uc1swXS5wZXJtYWxpbms7CiAgICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0W2ldLnZhcmlhbnRfdGl0bGUgPQogICAgICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0W2ldLnZhcmlhdGlvbnNbMF0udmFyaWFudF90aXRsZTsKICAgICAgICAgICAgbXNnLnByb2R1Y3RzX2xpc3RbaV0uc3RvY2tfcXVhbnRpdHkgPQogICAgICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0W2ldLnZhcmlhdGlvbnNbMF0uc3RvY2tfcXVhbnRpdHk7CiAgICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0W2ldLnN0b2NrX3N0YXR1cyA9CiAgICAgICAgICAgICAgbXNnLnByb2R1Y3RzX2xpc3RbaV0udmFyaWF0aW9uc1swXS5zdG9ja19zdGF0dXM7CiAgICAgICAgICAgIG1zZy5wcm9kdWN0c19saXN0W2ldLnByaWNlID0KICAgICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYXRpb25zWzBdLnByaWNlOwogICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS5yZWd1bGFyX3ByaWNlID0KICAgICAgICAgICAgICBtc2cucHJvZHVjdHNfbGlzdFtpXS52YXJpYXRpb25zWzBdLnJlZ3VsYXJfcHJpY2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIG1zZy5uZXdfcHJvZHVjdHMgPSB0cnVlOwogICAgICAgIHRoaXMuc2hvd19jdXN0b21fY2FydCA9IHRydWU7CiAgICAgICAgdmFyIG5ld2xpc3QgPSB0aGlzLnByb2R1Y3RfbGlzdC5maWx0ZXIoCiAgICAgICAgICAocHJvZHVjdCkgPT4gcHJvZHVjdFsic3RvY2tfc3RhdHVzIl0gPT09ICJvdXRvZnN0b2NrIgogICAgICAgICk7CgogICAgICAgIG1zZy5wcm9kdWN0X291dF9vZl9zdG9ja19saXN0ID0gbmV3bGlzdDsKICAgICAgICBpZiAoCiAgICAgICAgICBtc2cucHJvZHVjdF9vdXRfb2Zfc3RvY2tfbGlzdC5sZW5ndGggPiAwICYmCiAgICAgICAgICAhdGhpcy5kaXNwbGF5X3Byb2R1Y3RzX29uX2xhbmRpbmcKICAgICAgICApIHsKICAgICAgICAgIG1zZy5wcm9kdWN0X291dF9vZl9zdG9jayA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuZGlzcGxheV9wcm9kdWN0c19vbl9sYW5kaW5nID0gZmFsc2U7CiAgICAgICAgaWYgKHR5cGUgPT09ICJkaXNwbGF5X3N1Y2Nlc3NfdG9hc3RyIikgewogICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIHN3YWwoewogICAgICAgICAgICAgIHRleHQ6ICJUZXN0aW5nIENvbXBsZXRlZCBTdWNjZXNzZnVsbHkhIFBsZWFzZSBQcm9jZWVkIHRvIHRoZSBuZXh0IHN0ZXAuIiwKICAgICAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgICBzaG93Q29uZmlybUJ1dHRvbjogZmFsc2UsCiAgICAgICAgICAgICAgdHlwZTogInN1Y2Nlc3MiLAogICAgICAgICAgICAgIHRpbWVyOiA1MDAwLAogICAgICAgICAgICAgIHRpbWVyUHJvZ3Jlc3NCYXI6IHRydWUsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgMTIwMCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UucHJvZHVjdHMubGVuZ3RoKSB7CiAgICAgICAgbXNnLmlzcHJvZHVjdCA9IHRydWU7CiAgICAgICAgbXNnLmVsZW1lbnRzID0gbWVzc2FnZTsKICAgICAgfQogICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAvLyB0aGlzLiRzZXNzaW9uLnNldCgiQm90UmVzcG9uc2VfQ29udmVyc2F0aW9uIiwgdGhpcy5jaGF0KTsKICAgICAgdGhpcy5uZXdfdXBkYXRlX3Jlc3BvbnNlKGluZGV4KTsKICAgICAgdGhpcy5wcm9kdWN0X2xpc3QgPSBbXTsKICAgIH0sCiAgICBkaXNwbGF5X2ZpbGVfY2hhdChtZXNzYWdlKSB7CiAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgIH07CiAgICAgIGxldCB0ZW1wID0gbWVzc2FnZS5zcGxpdCgiRG93bmxvYWQgeW91ciBtYW5pZmVzdCBoZXJlICIpOwogICAgICBsZXQgdXJsID0gbWVzc2FnZS5tYXRjaCh0aGlzLnVybF9tYXRjaF9yZWdleClbMF07CiAgICAgIG1zZy51cmwgPSBtZXNzYWdlLmluY2x1ZGVzKCJEb3dubG9hZCB5b3VyIG1hbmlmZXN0IGhlcmUgIikKICAgICAgICA/IHRlbXBbMV0KICAgICAgICA6IHVybDsKICAgICAgbXNnLnJlY2VpdmluZyA9IGZhbHNlOwogICAgICBtc2cuZmlsZV9uYW1lID0gdXJsCiAgICAgICAgLnNwbGl0KC9eLipbXFxcL10vKVsxXQogICAgICAgIC5zcGxpdCgiLyIpCiAgICAgICAgLnBvcCgpCiAgICAgICAgLnNwbGl0KCI/IilbMF07CiAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgIC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICB9LAogICAgZ2VuZXJhdGVfb3JkZXJfZGV0YWlscyhvcmRlcikge30sCiAgICBhc3luYyBhZGRkcm9wZG93bnZhbHVlKHZhbHVlKSB7CiAgICAgIHRoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbiA9IHZhbHVlOwogICAgICBpZiAodmFsdWUubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMudG9fc2VuZCA9ICIiOwogICAgICAgIHRoaXMucmVzID0ge307CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnNlbGVjdGVkX2luZGljYXRpb24ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGxldCBwYXJzZWRKc29uID0gSlNPTi5wYXJzZSgKICAgICAgICAgICAgYHske3RoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbltpXS52YWx1ZS5zcGxpdCgieyIpWzFdfWAKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoaSA9PSAwKSB7CiAgICAgICAgICAgIHRoaXMudG9fc2VuZCA9IHRoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbltpXS50aXRsZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudG9fc2VuZCA9CiAgICAgICAgICAgICAgdGhpcy50b19zZW5kICsgIiwgIiArIHRoaXMuc2VsZWN0ZWRfaW5kaWNhdGlvbltpXS50aXRsZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLnJlc1tPYmplY3Qua2V5cyhwYXJzZWRKc29uKVswXS50b1N0cmluZygpXSA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5yZXNbT2JqZWN0LmtleXMocGFyc2VkSnNvbilbMF0udG9TdHJpbmcoKV0gPQogICAgICAgICAgICAgIE9iamVjdC52YWx1ZXMocGFyc2VkSnNvbilbMF0udG9TdHJpbmcoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMucmVzW09iamVjdC5rZXlzKHBhcnNlZEpzb24pWzBdLnRvU3RyaW5nKCldID0KICAgICAgICAgICAgICB0aGlzLnJlc1tPYmplY3Qua2V5cyhwYXJzZWRKc29uKVswXS50b1N0cmluZygpXSArCiAgICAgICAgICAgICAgIiwiICsKICAgICAgICAgICAgICBPYmplY3QudmFsdWVzKHBhcnNlZEpzb24pWzBdLnRvU3RyaW5nKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuYnV0dG9uX2ZpbGwoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRvX3NlbmQgPSAiIjsKICAgICAgICB0aGlzLnJlcyA9IHt9OwogICAgICB9CiAgICAgIHRoaXMuYnV0dG9uX2ZpbGwoKTsKICAgIH0sCiAgICBidXR0b25fZmlsbCgpIHsKICAgICAgaWYgKHRoaXMudG9fc2VuZCA9PSAiIikgewogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNzZW5kX2J1dHRvbiIpLmNsYXNzTGlzdC5yZW1vdmUoImZpbGxlZCIpOwogICAgICB9IGVsc2UgaWYgKHRoaXMudG9fc2VuZCAhPSAiIikgewogICAgICAgIGlmICh0aGlzLmxpdmVfY2hhdF9vbikgewogICAgICAgICAgdGhpcy5jaGFubmVsLnB1c2goInN0YXJ0ZWRfdHlwaW5nIik7CiAgICAgICAgICB0aGlzLnN0b3BfdHlwaW5nKHRoaXMpOwogICAgICAgIH0KICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjc2VuZF9idXR0b24iKS5jbGFzc0xpc3QuYWRkKCJmaWxsZWQiKTsKICAgICAgfQogICAgfSwKICAgIHN0b3BfdHlwaW5nOiBkZWJvdW5jZShmdW5jdGlvbiAodm0pIHsKICAgICAgdm0uY2hhbm5lbC5wdXNoKCJzdG9wcGVkX3R5cGluZyIpOwogICAgfSwgMTAwMCksCiAgICBzY3JvbGxfZG93bigpIHsKICAgICAgaWYgKAogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5jaGF0LWJvZHkiKS5zY3JvbGxIZWlnaHQgLQogICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmNoYXQtYm9keSIpLnNjcm9sbFRvcCA8PQogICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5jaGF0LWJvZHkiKS5jbGllbnRIZWlnaHQKICAgICAgKSB7CiAgICAgICAgdGhpcy50b19zY3JvbGwgPSBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRvX3Njcm9sbCA9IHRydWU7CiAgICAgIH0KICAgIH0sCiAgICBsb2FkX2J1dHRvbnMobWVzc2FnZSwgaW5kZXgsIHR5cGUsIGdyZWV0aW5nX2J1dHRvbikgewogICAgICBpZiAodHlwZSA9PT0gImRpc3BsYXlfc3VjY2Vzc190b2FzdHIiKSB7CiAgICAgICAgc3dhbCh7CiAgICAgICAgICB0ZXh0OiAiU29tZSBlcnJvciBvY2N1cnJlZCB3aGlsZSB0ZXN0aW5nLiIsCiAgICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgdHlwZTogImVycm9yIiwKICAgICAgICAgIHRpbWVyOiA1MDAwLAogICAgICAgIH0pOwogICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgYXNrX2ZlZWRiYWNrOiBmYWxzZSwKICAgICAgICAgIHJlY2VpdmVkOgogICAgICAgICAgICAiU29tZSBlcnJvciBvY2N1cnJlZCB3aGlsZSB0ZXN0aW5nLiBQbGVhc2UgdHJ5IGJ5IHJlZnJlc2hpbmcgdGhlIGJyb3dzZXIhIElmIHRoZSBpc3N1ZSBwZXJzaXN0cywgcGxlYXNlIGNvbnRhY3Qgc3lzdGVtIGFkbWluLiIsCiAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgfTsKICAgICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgbXNnID0gewogICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgIGJ1dHRvbnNfbGlzdDogW10sCiAgICAgICAgYnV0dG9uX3ByZWZpeDogbWVzc2FnZS5wcmVmaXgsCiAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgIHJlY2VpdmVkOiBtZXNzYWdlLnRleHQsCiAgICAgICAgdGltZTogbnVsbCwKICAgICAgICByZW1vdmFibGU6IHR5cGUgPT0gIndlbGNvbWVfbWVzc2FnZSIgPyBmYWxzZSA6IHRydWUsCiAgICAgIH07CiAgICAgIGlmIChCb29sZWFuKGdyZWV0aW5nX2J1dHRvbikpIHsKICAgICAgICBtc2cuZ3JlZXRpbmdfYnV0dG9uID0gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbXNnLmN1c3RvbV9idXR0b25zID0gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKG1lc3NhZ2UuYnV0dG9ucy5sZW5ndGggPT0gMykgewogICAgICAgIGlmICgKICAgICAgICAgIG1lc3NhZ2UuYnV0dG9uc1swXS50aXRsZSA9PSAiRXhjaGFuZ2UgUmF0ZSIgJiYKICAgICAgICAgIG1lc3NhZ2UuYnV0dG9uc1sxXS50aXRsZSA9PSAiVHJhY2sgTXkgUGFyY2VsIiAmJgogICAgICAgICAgbWVzc2FnZS5idXR0b25zWzJdLnRpdGxlID09ICJDYWxsIEhlbHBkZXNrIgogICAgICAgICkgewogICAgICAgICAgbXNnLnJlbW92YWJsZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKHZhciBpIGluIG1lc3NhZ2UuYnV0dG9ucykgewogICAgICAgIGlmIChtc2cuYnV0dG9uX3ByZWZpeCAhPSBudWxsKSB7CiAgICAgICAgICBtc2cuYnV0dG9uc19saXN0LnB1c2goewogICAgICAgICAgICB0aXRsZTogbWVzc2FnZS5idXR0b25zW2ldLnRpdGxlLAogICAgICAgICAgICB2YWx1ZTogbXNnLmJ1dHRvbl9wcmVmaXggKyBtZXNzYWdlLmJ1dHRvbnNbaV0udmFsdWUsCiAgICAgICAgICAgIHR5cGU6IEJvb2xlYW4obWVzc2FnZS5idXR0b25zW2ldLnR5cGUpID8gbWVzc2FnZS5idXR0b25zW2ldLnR5cGUgOiAnJywKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtc2cuYnV0dG9uc19saXN0LnB1c2goewogICAgICAgICAgICB0aXRsZTogbWVzc2FnZS5idXR0b25zW2ldLnRpdGxlLAogICAgICAgICAgICB2YWx1ZTogbWVzc2FnZS5idXR0b25zW2ldLnZhbHVlLAogICAgICAgICAgICB0eXBlOiBtZXNzYWdlLmJ1dHRvbnNbaV0udHlwZSwKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoCiAgICAgICAgICBtc2cuYnV0dG9uc19saXN0W2ldLnRpdGxlID09ICJObyIgJiYKICAgICAgICAgIG1lc3NhZ2UudGV4dCAhPSAiQ2FuIEkgaGVscCB5b3Ugd2l0aCBhbnl0aGluZyBlbHNlPyIgJiYKICAgICAgICAgIHRoaXMuY29tcGFueWlkID09ICJjbGluaWNhbHRyaWFsczgxMzUyIgogICAgICAgICkgewogICAgICAgICAgbXNnLmJ1dHRvbnNfbGlzdFtpXS52YWx1ZSA9ICJpc2Rpc2FibGVkIjsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIGNoYXRJbmRleCA9IHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgIGlmIChpbmRleCA9PSAiaXNfYnV0dG9uIiB8fCBpbmRleCA9PSAwKSB7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5jaGlsZHJlbigpLmxhc3QoKS5oZWlnaHQoKSAvCiAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIDwKICAgICAgICAgICAgMC41CiAgICAgICAgICApIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMSwgMTUwMCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCg1MCwgMTUwMCwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwgMTAwMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zY3JvbGxfZG93bigpOwogICAgICB9CiAgICAgIGlmIChCb29sZWFuKGdyZWV0aW5nX2J1dHRvbikpIHsKICAgICAgICB0aGlzLmNoYXRbY2hhdEluZGV4IC0gMV0uZ3JlZXRpbmdfYnV0dG9uID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmNoYXRbY2hhdEluZGV4IC0gMV0uY3VzdG9tX2J1dHRvbnMgPSB0cnVlOwogICAgICB9CiAgICAgIC8vIHRoaXMuJHNlc3Npb24uc2V0KCJCb3RSZXNwb25zZV9Db252ZXJzYXRpb24iLCB0aGlzLmNoYXQpOwogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB0aGlzLmNoYXRbY2hhdEluZGV4IC0gMV0udGltZSA9IHRoaXMuZ2VuZXJhdGVfdGltZSgpOwogICAgICB9LCA1MDApOwogICAgfSwKICAgIG11bHRpc2VsZWN0X2xvYWQobWVzc2FnZSwgaW5kZXgpIHsKICAgICAgdmFyIG1zZyA9IHsKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICBtdWx0aXNlbGVjdF92YWx1ZXM6IG1lc3NhZ2UuY3VzdG9tLnZhbHVlcywKICAgICAgICBwbGFjZWhvbGRlcjogbWVzc2FnZS5jdXN0b20ucGxhY2Vob2xkZXIsCiAgICAgICAgaXNfbXVsdGlzZWxlY3Q6IHRydWUsCiAgICAgICAgdmFsdWVfbWFwcGluZzogW10sCiAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgIHJlY2VpdmVkOiBtZXNzYWdlLnRleHQsCiAgICAgICAgZGlzYWJsZWQ6IGZhbHNlLAogICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICB9OwogICAgICB0aGlzLmNoYXQucHVzaChtc2cpOwogICAgfSwKICAgIGxvYWRfdGFibGUobWVzc2FnZSwgaW5kZXgpIHsKICAgICAgbGV0IG1zZyA9IHsKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICBjb2xfbGlzdDogT2JqZWN0LmtleXMobWVzc2FnZS5jdXN0b20udmFsdWVzWzBdKSwKICAgICAgICB0YWJsZV92YWx1ZTogbWVzc2FnZS5jdXN0b20udmFsdWVzLAogICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICByZWNlaXZlZDogbWVzc2FnZS50ZXh0LAogICAgICAgIGlzX3RhYmxlOiB0cnVlLAogICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICB9OwoKICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgICBpZiAoaW5kZXggPT0gMCkgewogICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuY2hpbGRyZW4oKS5sYXN0KCkuaGVpZ2h0KCkgLwogICAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIDwKICAgICAgICAgICAgICAwLjUKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMSwgMTUwMCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMC43LCAxNTAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgMTAwMCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDEwMCwgMTUwMCwgdHJ1ZSk7CiAgICAgICAgICB0aGlzLnNjcm9sbF9kb3duKCk7CiAgICAgICAgfQogICAgICB9LCAyNTAwKTsKICAgIH0sCiAgICBsb2FkX3RleHRfYXJlYShtZXNzYWdlLCBpbmRleCkgewogICAgICBsZXQgbXNnID0gewogICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICByZWNlaXZlZDogbWVzc2FnZS50ZXh0LAogICAgICAgIHNob3dfdGV4dF9hcmVhOiB0cnVlLAogICAgICAgIGRpc2FibGVkOiBmYWxzZSwKICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgfTsKCiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgaWYgKGluZGV4ID09IDApIHsKICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmNoaWxkcmVuKCkubGFzdCgpLmhlaWdodCgpIC8KICAgICAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSA8CiAgICAgICAgICAgICAgMC41CiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDEsIDE1MDApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDAuNywgMTUwMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIDEwMDApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxMDAsIDE1MDAsIHRydWUpOwoKICAgICAgICAgIHRoaXMuc2Nyb2xsX2Rvd24oKTsKICAgICAgICB9CiAgICAgIH0sIDI1MDApOwogICAgfSwKICAgIHN0YXJ0X2xpdmVfY2hhdCgpIHsKICAgICAgLy8gdGhpcy5jaGF0X3NvY2tldCA9IG5ldyBTb2NrZXQoCiAgICAgIC8vICAgcHJvY2Vzcy5lbnYuVlVFX0FQUF9MSVZFX0NIQVRfV0VCU09DS0VUX0VORFBPSU5ULAogICAgICAvLyAgIHsKICAgICAgLy8gICAgIHBhcmFtczogewogICAgICAvLyAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAvLyAgICAgICB0b2tlbjogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnRva2VucywKICAgICAgLy8gICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUKICAgICAgLy8gICAgIH0sCiAgICAgIC8vICAgfQogICAgICAvLyApOwogICAgICBheGlvcy5nZXQoYXBpX2NhbGxzLmNoYXRfZ3JvdXBfYXBpKCkpLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgIHRoaXMuY2hhdF9ncm91cF9uYW1lID0gcmVzcG9uc2UuZGF0YS5jaGF0X2dyb3VwX25hbWU7CiAgICAgIHRoaXMubGl2ZV9jaGF0X3Rva2VuID0gcmVzcG9uc2UuZGF0YS50b2tlbjsKICAgICAgdGhpcy5jaGF0X3NvY2tldCA9IG5ldyBTb2NrZXQoCiAgICAgICAgcHJvY2Vzcy5lbnYuVlVFX0FQUF9MSVZFX0NIQVRfV0VCU09DS0VUX0VORFBPSU5ULAogICAgICAgIHsKICAgICAgICAgIHBhcmFtczogewogICAgICAgICAgICBjb21wYW55OiB0aGlzLmNvbXBhbnlfbmFtZSwKICAgICAgICAgICAgdG9rZW46IHRoaXMubGl2ZV9jaGF0X3Rva2VuCiAgICAgICAgICB9LAogICAgICAgIH0KICAgICAgKTsKICAgICAgdGhpcy5jaGF0X3NvY2tldC5jb25uZWN0KCk7CiAgICAgIHRoaXMuc3VwcG9ydF9jaGFubmVsID0gdGhpcy5jaGF0X3NvY2tldC5jaGFubmVsKAogICAgICAgICJjb21wYW5pZXM6IiArIHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkCiAgICAgICk7CiAgICAgIHRoaXMuc3VwcG9ydF9jaGFubmVsLmpvaW4oKTsKICAgICAgY29uc3Qgdm0gPSB0aGlzOwogICAgICB0aGlzLnN1cHBvcnRfY2hhbm5lbC5wdXNoKCJjdXN0b21lcl93YW50c19wcmVzZW5jZSIpOwogICAgICB0aGlzLnN1cHBvcnRfY2hhbm5lbC5vbigiY3VzdG9tZXJfZ2V0c19wcmVzZW5jZSIsIChyZXMpID0+IHsKICAgICAgICBpZiAoQm9vbGVhbihyZXNbdm0uY29tcGFueWlkXSkgPT09IHRydWUpIHsKICAgICAgICAgIHZhciBjb21wYW55X3ByZXNlbmNlID0gcmVzW3ZtLmNvbXBhbnlpZF1bIm1ldGFzIl07CiAgICAgICAgICAvLyBjb25zb2xlLmxvZyhjb21wYW55X3ByZXNlbmNlKTsKICAgICAgICAgIGxldCBzZWxmX3VzZXJfaW5kZXggPSBjb21wYW55X3ByZXNlbmNlCiAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gZS51c2VyX2luZm8udXNlcm5hbWU7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5pbmRleE9mKHZtLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwpOwogICAgICAgICAgaWYgKHNlbGZfdXNlcl9pbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgY29tcGFueV9wcmVzZW5jZS5zcGxpY2Uoc2VsZl91c2VyX2luZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBwcmVzZW50X3JvbGVfbGlzdCA9IFtdOwogICAgICAgICAgY29tcGFueV9wcmVzZW5jZS5maWx0ZXIoKGVhY2gpID0+CiAgICAgICAgICAgIHByZXNlbnRfcm9sZV9saXN0LnB1c2goZWFjaC51c2VyX2luZm8ucm9sZSkKICAgICAgICAgICk7CiAgICAgICAgICBsZXQgdW5pcXVlX3JvbGVfbGlzdCA9IHByZXNlbnRfcm9sZV9saXN0LmZpbHRlcigKICAgICAgICAgICAgKHgsIGksIGEpID0+IGEuaW5kZXhPZih4KSA9PSBpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHVuaXF1ZV9yb2xlX2xpc3QuaW5jbHVkZXMoInN1cHBvcnQgYWdlbnQiKSkgewogICAgICAgICAgICB2bS5pc19zdXBwb3J0X2FnZW50X3ByZXNlbnQgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdm0uaXNfc3VwcG9ydF9hZ2VudF9wcmVzZW50ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZtLmlzX3N1cHBvcnRfYWdlbnRfcHJlc2VudCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICB2bS5jb25uZWN0X3N1cHBvcnRfYWdlbnQoKTsKICAgICAgICAvLyBjb25zb2xlLmxvZyhyZXMpCiAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgICBjb25uZWN0X3N1cHBvcnRfYWdlbnQoKSB7CiAgICAgIHZhciB2bSA9IHRoaXM7CiAgICAgIHRoaXMuc3VwcG9ydF9jaGFubmVsLmxlYXZlKCk7CiAgICAgIHRoaXMuY2hhdF9zb2NrZXQuZGlzY29ubmVjdCgpOwogICAgICB0aGlzLmNoYXRfc29ja2V0ID0gbnVsbDsKICAgICAgaWYgKHRoaXMuaXNfc3VwcG9ydF9hZ2VudF9wcmVzZW50ID09PSB0cnVlKSB7CiAgICAgICAgdmFyIG1zZyA9IHt9OwogICAgICAgIG1zZy5yZWNlaXZpbmcgPSB0cnVlOwogICAgICAgIG1zZy5yZWNlaXZlZCA9CiAgICAgICAgICAiSSBhbSBjb25uZWN0aW5nIHlvdSB0byBvbmUgb2Ygb3VyIHN1cHBvcnQgYWdlbnRzLiBQbGVhc2Ugd2FpdCBmb3IgYSB3aGlsZS4iOwogICAgICAgIG1zZy5jb252ZXJzYXRpb25fb25seSA9IHRydWU7CiAgICAgICAgbXNnLnRpbWUgPSB0aGlzLmdlbmVyYXRlX3RpbWUoKTsKICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgdGhpcy5jaGF0LnB1c2gobXNnKTsKICAgICAgICB0aGlzLmNoYXQucHVzaCh7CiAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICByZWNlaXZlZDogIldoYXQncyB5b3VyIG5hbWU/IiwKICAgICAgICAgIGNvbnZlcnNhdGlvbl9vbmx5OiB0cnVlLAogICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5uZXdfdXBkYXRlX3Jlc3BvbnNlKDApOwogICAgICAgIHRoaXMuc2Nyb2xsX2Rvd24oKTsKICAgICAgICBheGlvcy5nZXQoYXBpX2NhbGxzLmNoYXRfZ3JvdXBfYXBpKCkpLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICB0aGlzLmNoYXRfZ3JvdXBfbmFtZSA9IHJlc3BvbnNlLmRhdGEuY2hhdF9ncm91cF9uYW1lOwogICAgICAgICAgdGhpcy5saXZlX2NoYXRfdG9rZW4gPSByZXNwb25zZS5kYXRhLnRva2VuOwogICAgICAgICAgdGhpcy5saXZlX2NoYXRfb24gPSB0cnVlOwogICAgICAgICAgdGhpcy5jaGF0X3NvY2tldCA9IG5ldyBTb2NrZXQoCiAgICAgICAgICAgIHByb2Nlc3MuZW52LlZVRV9BUFBfTElWRV9DSEFUX1dFQlNPQ0tFVF9FTkRQT0lOVCwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHBhcmFtczogewogICAgICAgICAgICAgICAgY29tcGFueTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmNvbXBhbnlfaWQsCiAgICAgICAgICAgICAgICBjaGF0X2dyb3VwX25hbWU6IHRoaXMuY2hhdF9ncm91cF9uYW1lLAogICAgICAgICAgICAgICAgdG9rZW46IHRoaXMubGl2ZV9jaGF0X3Rva2VuLAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICAgICk7CiAgICAgICAgICB0aGlzLmNoYXRfc29ja2V0LmNvbm5lY3QoKTsKICAgICAgICAgIHRoaXMuY2hhbm5lbCA9IHRoaXMuY2hhdF9zb2NrZXQuY2hhbm5lbCgKICAgICAgICAgICAgImN1c3RvbWVyc19ncm91cHM6IiArIHRoaXMuY2hhdF9ncm91cF9uYW1lCiAgICAgICAgICApOwogICAgICAgICAgdGhpcy5jaGFubmVsLmpvaW4oKTsKICAgICAgICAgIHRoaXMuY2hhbm5lbC5wdXNoKCJjdXN0b21lcl9uZWVkc19zdXBwb3J0X2FnZW50Iik7CgogICAgICAgICAgc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2bS5jaGFubmVsLnB1c2goImN1c3RvbWVyX25lZWRzX3N1cHBvcnRfYWdlbnQiKTsKICAgICAgICAgIH0sIDIwMDApOwogICAgICAgICAgc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2bS5jaGFubmVsLnB1c2goImN1c3RvbWVyX2dyb3VwX3NlbGZfcHJlc2VuY2UiKTsKICAgICAgICAgIH0sIDIwMDApOwogICAgICAgICAgdGhpcy5jaGFubmVsLm9uKCJjdXN0b21lcl9ncm91cF9zZWxmX3ByZXNlbmNlIiwgKHJlcykgPT4gewogICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiQ1VTVE9NRVIgR1JPVVAgUFJFU0VOQ0UiLCByZXMpOwogICAgICAgICAgICB2YXIgbWV0YSA9IHJlcy5tZXRhczsKICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBtZXRhKSB7CiAgICAgICAgICAgICAgaWYgKCFtZXRhW2ldLnVzZXJfaW5mby5pc19jdXN0b21lcikgewogICAgICAgICAgICAgICAgdGhpcy5zdXBwb3J0X2FnZW50X2luZm8gPSBtZXRhW2ldLnVzZXJfaW5mbzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5jaGFubmVsLm9uKCJuZXdfY2hhdF9tZXNzYWdlIiwgKHJlcykgPT4gewogICAgICAgICAgICBpZiAocmVzLnNlbmRlciAhPSAiY3VzdG9tZXIiKSB7CiAgICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgICAgICAgICAgcmVjZWl2ZWQ6IHJlcy5tZXNzYWdlLAogICAgICAgICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsX2Rvd24oKTsKICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmNoaWxkcmVuKCkubGFzdCgpLmhlaWdodCgpIC8KICAgICAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPAogICAgICAgICAgICAgICAgICAwLjUKICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxLCAxNTAwKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgICQoIi5yZWNlaXZlciIpLmxhc3QoKS5wYXJlbnQoKS5oZWlnaHQoKSAvCiAgICAgICAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpID4KICAgICAgICAgICAgICAgICAgICAwLjUgJiYKICAgICAgICAgICAgICAgICAgJCgiLnJlY2VpdmVyIikubGFzdCgpLnBhcmVudCgpLmhlaWdodCgpIC8KICAgICAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPAogICAgICAgICAgICAgICAgICAgIDAuNgogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDAuOSwgMTUwMCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgwLjc1LCAxNTAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgLQogICAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikgIT0KICAgICAgICAgICAgICAgIDAKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsX2Rvd24oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5jaGFubmVsLm9uKCJzdG9wcGVkX2NoYXQiLCAocmVzKSA9PiB7CiAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKHsKICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgICAgcmVjZWl2ZWQ6ICJTdXBwb3J0IGFnZW50ICIgKyByZXMubWVzc2FnZSwKICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMubGl2ZV9jaGF0X29uID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc3VwcG9ydF9hZ2VudF9pbmZvID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5jaGFubmVsLmxlYXZlKCk7CiAgICAgICAgICAgIHRoaXMubGl2ZV9jaGF0X3Rva2VuID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5jaGF0X2dyb3VwX25hbWUgPSBudWxsOwogICAgICAgICAgICB0aGlzLnVzZXJfbmFtZSA9ICIiOwogICAgICAgICAgICB0aGlzLmNoYXRfc29ja2V0LmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLmNoYW5uZWwub24oInN0YXJ0ZWRfdHlwaW5nIiwgKHJlcykgPT4gewogICAgICAgICAgICB0aGlzLmlzX2FnZW50X3R5cGluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMuY2hhbm5lbC5vbigic3RvcHBlZF90eXBpbmciLCAocmVzKSA9PiB7CiAgICAgICAgICAgIHRoaXMuaXNfYWdlbnRfdHlwaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zdXBwb3J0X3N1YnNjcmlwdGlvbl9kYXRhKCk7CiAgICAgIH0KICAgIH0sCiAgICB1cGRhdGVfc2Nyb2xsYmFyKHR5cGUsIG1zZ1R5cGUsIGlzd2VsY29tZSwgZGVsYXlfdmFsdWUpIHsKICAgICAgdmFyIHNjcm9sbF9kZWxheSA9IGlzd2VsY29tZSA9PSAiaXNfd2VsY29tZSIgPyBkZWxheV92YWx1ZSA6IDIwMDA7CiAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgIGlmIChtc2dUeXBlID09ICJyZXNwb25zZSIpIHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgIH0sIHNjcm9sbF9kZWxheSk7CiAgICAgIH0gZWxzZSBpZiAobXNnVHlwZSA9PSAic2VuZGVyIikgewogICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDEsIDc1MCk7CiAgICAgIH0KICAgICAgaWYgKG1zZ1R5cGUgPT0gInJlc3BvbnNlIikgewogICAgICAgIGlmICh0eXBlID09ICJ1cHRvX2VuZCIpIHsKICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLnByb3AoInNjcm9sbFRvcCIpIDwKICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgJCgiLnJlY2VpdmVyIikubGFzdCgpLnBhcmVudCgpLmhlaWdodCgpIC8KICAgICAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpID4KICAgICAgICAgICAgICAgIDAuNQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMC43NSwgMTUwMCk7CiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbF9kb3duKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICQoIi5yZWNlaXZlciIpLmxhc3QoKS5wYXJlbnQoKS5oZWlnaHQoKSAvCiAgICAgICAgICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPAogICAgICAgICAgICAgIDAuNQogICAgICAgICAgICApIHsKICAgICAgICAgICAgICB0aGlzLmFuaW1hdGVfY2hhdF9ib2R5X3Njcm9sbCgxLCBzY3JvbGxfZGVsYXkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCBzY3JvbGxfZGVsYXkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmNoYXQtYm9keSIpLnNjcm9sbFRvcCA9CiAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmNoYXQtYm9keSIpLnNjcm9sbEhlaWdodCAtCiAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmNoYXQtYm9keSIpLmxhc3RDaGlsZC5zY3JvbGxIZWlnaHQ7CiAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBuZXdfdXBkYXRlX3Jlc3BvbnNlKGluZGV4KSB7CiAgICAgIGlmIChpbmRleCA9PSAwKSB7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICB0aGlzLnNjcm9sbF9kb3duKCk7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgICQoIi5jaGF0LWJvZHkiKS5jaGlsZHJlbigpLmxhc3QoKS5oZWlnaHQoKSAvCiAgICAgICAgICAgICAgJCgiLmNoYXQtYm9keSIpLmhlaWdodCgpIDwKICAgICAgICAgICAgMC41CiAgICAgICAgICApIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMSwgMTUwMCk7CiAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAkKCIucmVjZWl2ZXIiKS5sYXN0KCkucGFyZW50KCkuaGVpZ2h0KCkgLyAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPgogICAgICAgICAgICAgIDAuNSAmJgogICAgICAgICAgICAkKCIucmVjZWl2ZXIiKS5sYXN0KCkucGFyZW50KCkuaGVpZ2h0KCkgLyAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgPAogICAgICAgICAgICAgIDAuNgogICAgICAgICAgKSB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKDEsIDE1MDApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRlX2NoYXRfYm9keV9zY3JvbGwoMSwgMTUwMCk7CiAgICAgICAgICB9CiAgICAgICAgfSwgMTAwMCk7CiAgICAgIH0KICAgICAgaWYgKAogICAgICAgICQoIi5jaGF0LWJvZHkiKS5oZWlnaHQoKSAtICQoIi5jaGF0LWJvZHkiKS5wcm9wKCJzY3JvbGxIZWlnaHQiKSAhPQogICAgICAgIDAKICAgICAgKSB7CiAgICAgICAgdGhpcy5zY3JvbGxfZG93bigpOwogICAgICB9CiAgICAgIGlmICgKICAgICAgICAkKCIuY2hhdC1ib2R5IikuaGVpZ2h0KCkgLSAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IikgPT09CiAgICAgICAgMAogICAgICApIHsKICAgICAgICB0aGlzLnRvX3Njcm9sbCA9IGZhbHNlOwogICAgICB9CiAgICB9LAogICAgYW5pbWF0ZV9jaGF0X2JvZHlfc2Nyb2xsKHNjYWxlLCBkZWxheSwgb2Zmc2V0KSB7CiAgICAgIGlmIChCb29sZWFuKG9mZnNldCkpIHsKICAgICAgICAkKCIuY2hhdC1ib2R5IikuYW5pbWF0ZSgKICAgICAgICAgIHsKICAgICAgICAgICAgc2Nyb2xsVG9wOiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsVG9wIikgKyBzY2FsZSwKICAgICAgICAgIH0sCiAgICAgICAgICBkZWxheQogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgJCgiLmNoYXQtYm9keSIpLmFuaW1hdGUoCiAgICAgICAgICB7CiAgICAgICAgICAgIHNjcm9sbFRvcDogc2NhbGUgKiAkKCIuY2hhdC1ib2R5IikucHJvcCgic2Nyb2xsSGVpZ2h0IiksCiAgICAgICAgICB9LAogICAgICAgICAgZGVsYXkKICAgICAgICApOwogICAgICB9CiAgICB9LAogICAgYWRkX2JvdF91bmFuc3dlcmVkX3F1ZXN0aW9uKGluZGV4LCBtZXRob2QpIHsKICAgICAgYXhpb3MKICAgICAgICAucHV0KAogICAgICAgICAgYXBpX2NhbGxzLmdldF91bmFuc3dlcmVkX3VybCgpLAogICAgICAgICAgewogICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgIGJvdF9hbnN3ZXI6IHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQsCiAgICAgICAgICAgIHVzZXJfcXVlcnk6IHRoaXMuY2hhdFtpbmRleCAtIDFdLnNlbnQsCiAgICAgICAgICAgIGZlZWRiYWNrOiBtZXRob2QgPyAibGlrZSIgOiAiZGlzbGlrZSIsCiAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgIGNvbXBhbnlfaWQ6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X2lkLAogICAgICAgICAgICBjb21wYW55X25hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5jb21wYW55X25hbWUsCiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuJHNlc3Npb24uZ2V0KCJhdCIpfWAsCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICAgIC50aGVuKCgpID0+IHsKICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uYXNrX2ZlZWRiYWNrID0gZmFsc2U7CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKCkgPT4ge30pOwogICAgfSwKICAgIGxvYWRfcmVmdW5kcygpIHsKICAgICAgbGV0IG1zZyA9IHsKICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICBpc19yZWZ1bmQ6IHRydWUsCiAgICAgICAgcmVjZWl2aW5nOiB0cnVlLAogICAgICAgIHJlY2VpdmVkOiB0aGlzLnJldGFpbF9vcmRlcl9yZXRyZWl2YWxfb25seV9lbWFpbF9yZXF1aXJlZAogICAgICAgICAgPyAiUGxlYXNlIGVudGVyIGVtYWlsIHRvIGZldGNoIHlvdXIgb3JkZXJzLiIKICAgICAgICAgIDogIlBsZWFzZSBsb2dpbiB0byBmZXRjaCB5b3VyIHJlY2VudCBvcmRlcnMiLAogICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICB9OwoKICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgbGV0IGxhdGVzdENoYXRJbmRleCA9IHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgbGF0ZXN0Q2hhdEluZGV4IC09IDE7CiAgICAgICAgdGhpcy5jaGF0W2xhdGVzdENoYXRJbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzID0gdHJ1ZTsKICAgICAgICB0aGlzLnNjcm9sbF9kb3duKCk7CiAgICAgIH0sIDEwMDApOwogICAgfSwKICAgIHZpZXdfb3JkZXJfZGV0YWlscyhjaGF0SW5kZXgsIG9yZGVySW5kZXgsIG9yZGVyTGluZUl0ZW1zLCBvcmRlclJlZnVuZHMpIHsKICAgICAgdGhpcy5jaGF0W2NoYXRJbmRleF0ucmVmdW5kX3NlbGVjdGVkX2l0ZW1zID0gW107CiAgICAgIHRoaXMuY2hhdFtjaGF0SW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmRfbGlzdCA9IG51bGw7CiAgICAgIHRoaXMuY2hhdFtjaGF0SW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmQgPSBudWxsOwogICAgICB0aGlzLmNoYXRbY2hhdEluZGV4XS5yZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzID0gT2JqZWN0KAogICAgICAgIHRoaXMuY2hhdFtjaGF0SW5kZXhdLnJlZnVuZF9vcmRlcnNfbGlzdFtvcmRlckluZGV4XQogICAgICApOwogICAgICB0aGlzLmNoYXRbY2hhdEluZGV4XS5yZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzLmxpbmVfaXRlbXMgPQogICAgICAgIG9yZGVyTGluZUl0ZW1zLm1hcCgobGluZUl0ZW0pID0+IHsKICAgICAgICAgIGxldCBsaW5lSXRlbU5vZGUgPSBsaW5lSXRlbTsKICAgICAgICAgIGxpbmVJdGVtTm9kZS5zZWxlY3RlZF9xdWFudGl0eSA9CiAgICAgICAgICAgIHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iCiAgICAgICAgICAgICAgPyBsaW5lSXRlbS5xdHlfb3JkZXJlZAogICAgICAgICAgICAgIDogbGluZUl0ZW0ucXVhbnRpdHk7CiAgICAgICAgICBsaW5lSXRlbU5vZGUuYWxyZWFkeV9yZWZ1bmRlZF9xdHkgPQogICAgICAgICAgICB0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJtYWdlbnRvIiA/IGxpbmVJdGVtLnF0eV9yZWZ1bmRlZCA6IDA7CiAgICAgICAgICBsaW5lSXRlbU5vZGUucXR5X2F2YWlsYWJsZV9mb3JfcmVmdW5kID0KICAgICAgICAgICAgdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAibWFnZW50byIKICAgICAgICAgICAgICA/IGxpbmVJdGVtLnF0eV9vcmRlcmVkCiAgICAgICAgICAgICAgOiBsaW5lSXRlbS5xdWFudGl0eTsKICAgICAgICAgIGxpbmVJdGVtTm9kZS5wcm9kdWN0X2lkID0gbGluZUl0ZW0ucHJvZHVjdF9pZDsKICAgICAgICAgIGxpbmVJdGVtTm9kZS52YXJpYW50X2lkID0KICAgICAgICAgICAgdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAibWFnZW50byIKICAgICAgICAgICAgICA/IGxpbmVJdGVtLnNrdQogICAgICAgICAgICAgIDogbGluZUl0ZW0udmFyaWFudF9pZDsKICAgICAgICAgIHJldHVybiBsaW5lSXRlbU5vZGU7CiAgICAgICAgfSk7CiAgICAgIGlmIChCb29sZWFuKG9yZGVyUmVmdW5kcykgPT09IHRydWUpIHsKICAgICAgICBvcmRlclJlZnVuZHMgPSBvcmRlclJlZnVuZHMubWFwKChsaW5lSXRlbSkgPT4gewogICAgICAgICAgcmV0dXJuIGxpbmVJdGVtLnJlZnVuZF9saW5lX2l0ZW1zWzBdOwogICAgICAgIH0pOwogICAgICAgIHZhciBBbHJlYWR5UmVmdW5kZWRRdHkgPSBbXTsKICAgICAgICBvcmRlclJlZnVuZHMucmVkdWNlKGZ1bmN0aW9uIChyZXMsIHZhbHVlKSB7CiAgICAgICAgICBpZiAoIXJlc1t2YWx1ZS5saW5lX2l0ZW1faWRdKSB7CiAgICAgICAgICAgIHJlc1t2YWx1ZS5saW5lX2l0ZW1faWRdID0gewogICAgICAgICAgICAgIGxpbmVfaXRlbV9pZDogdmFsdWUubGluZV9pdGVtX2lkLAogICAgICAgICAgICAgIHF1YW50aXR5OiAwLAogICAgICAgICAgICB9OwogICAgICAgICAgICBBbHJlYWR5UmVmdW5kZWRRdHkucHVzaChyZXNbdmFsdWUubGluZV9pdGVtX2lkXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXNbdmFsdWUubGluZV9pdGVtX2lkXS5xdWFudGl0eSArPSB2YWx1ZS5xdWFudGl0eTsKICAgICAgICAgIHJldHVybiByZXM7CiAgICAgICAgfSwge30pOwogICAgICAgIGxldCB0ZW1wID0gdGhpcy5jaGF0W2NoYXRJbmRleF0ucmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlscy5saW5lX2l0ZW1zOwogICAgICAgIHRoaXMuY2hhdFtjaGF0SW5kZXhdLnJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMubGluZV9pdGVtcyA9IHRlbXAubWFwKAogICAgICAgICAgKGxpbmVJdGVtKSA9PiB7CiAgICAgICAgICAgIGxldCBsaW5lSXRlbU5vZGUgPSBsaW5lSXRlbTsKICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBBbHJlYWR5UmVmdW5kZWRRdHkpIHsKICAgICAgICAgICAgICBpZiAobGluZUl0ZW0uaWQgPT0gQWxyZWFkeVJlZnVuZGVkUXR5W2ldLmxpbmVfaXRlbV9pZCkgewogICAgICAgICAgICAgICAgbGluZUl0ZW1Ob2RlLmFscmVhZHlfcmVmdW5kZWRfcXR5ID0KICAgICAgICAgICAgICAgICAgQWxyZWFkeVJlZnVuZGVkUXR5W2ldWyJxdWFudGl0eSJdOwogICAgICAgICAgICAgICAgbGluZUl0ZW1Ob2RlLnF0eV9hdmFpbGFibGVfZm9yX3JlZnVuZCA9CiAgICAgICAgICAgICAgICAgIGxpbmVJdGVtLnF1YW50aXR5IC0gQWxyZWFkeVJlZnVuZGVkUXR5W2ldWyJxdWFudGl0eSJdOwogICAgICAgICAgICAgICAgbGluZUl0ZW1Ob2RlLnNlbGVjdGVkX3F1YW50aXR5ID0KICAgICAgICAgICAgICAgICAgbGluZUl0ZW0ucXVhbnRpdHkgLSBBbHJlYWR5UmVmdW5kZWRRdHlbaV1bInF1YW50aXR5Il07CiAgICAgICAgICAgICAgICBsaW5lSXRlbU5vZGUucHJvZHVjdF9pZCA9IGxpbmVJdGVtLnByb2R1Y3RfaWQ7CiAgICAgICAgICAgICAgICBsaW5lSXRlbU5vZGUudmFyaWFudF9pZCA9CiAgICAgICAgICAgICAgICAgIHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iCiAgICAgICAgICAgICAgICAgICAgPyBsaW5lSXRlbS5za3UKICAgICAgICAgICAgICAgICAgICA6IGxpbmVJdGVtLnZhcmlhbnRfaWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsaW5lSXRlbU5vZGU7CiAgICAgICAgICB9CiAgICAgICAgKTsKICAgICAgfQogICAgICB0aGlzLiRzZXQodGhpcy5jaGF0LCBjaGF0SW5kZXgsIHRoaXMuY2hhdFtjaGF0SW5kZXhdKTsKICAgIH0sCiAgICByZWZyZXNoX29yX3JlbW92ZV9vcmRlcl9kZXRhaWxzKGNoYXRJbmRleCwgdmFsKSB7CiAgICAgIGlmICh2YWwgPT0gInJlbW92ZSIpIHsKICAgICAgICB0aGlzLmNoYXRbY2hhdEluZGV4XS5yZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzID0ge307CiAgICAgIH0KICAgICAgdGhpcy4kc2V0KHRoaXMuY2hhdCwgY2hhdEluZGV4LCB0aGlzLmNoYXRbY2hhdEluZGV4XSk7CiAgICB9LAogICAgbG9hZF9jdXN0b21lcl9vcmRlcnMob3JkZXJzRGF0YSwgaW5kZXgsIG9yZGVyX3R5cGUpIHsKICAgICAgLy8gdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9IGBPcmRlciAke29yZGVyTmFtZX1gOwogICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICBpZiAob3JkZXJfdHlwZSA9PT0gInJlZnVuZCIpIHsKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gIkZldGNoaW5nIHlvdXIgb3JkZXJzIC4uLiI7CiAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QgPSBvcmRlcnNEYXRhLm1hcCgob3JkZXIpID0+IHsKICAgICAgICAgIGxldCBvcmRlck9iamVjdCA9IG9yZGVyOwogICAgICAgICAgb3JkZXJPYmplY3QuY3JlYXRlZF9hdCA9CiAgICAgICAgICAgIHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT09ICJiaWdjb21tZXJjZSIKICAgICAgICAgICAgICA/IG1vbWVudChvcmRlck9iamVjdC5jcmVhdGVkX2F0KS5mb3JtYXQoIkRvIE1NTSBZWVlZIikKICAgICAgICAgICAgICA6IG1vbWVudChvcmRlck9iamVjdC5jcmVhdGVkX2F0LCBbIllZWVktTU0tRERUaDptOnNaIl0pLmZvcm1hdCgKICAgICAgICAgICAgICAgICAgIkRvIE1NTSBZWVlZIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgIG9yZGVyT2JqZWN0Lm5hbWUgPQogICAgICAgICAgICB0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJzaG9waWZ5IgogICAgICAgICAgICAgID8gb3JkZXJPYmplY3QubmFtZQogICAgICAgICAgICAgIDogb3JkZXJPYmplY3QuaWQ7CiAgICAgICAgICBvcmRlck9iamVjdC5wcm9jZXNzZWRBdCA9IG1vbWVudChvcmRlck9iamVjdC5jcmVhdGVkX2F0LCBbCiAgICAgICAgICAgICJZWVlZLU1NLUREVGhoOm1tOnNzWiIsCiAgICAgICAgICBdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIik7CiAgICAgICAgICAvLyBjdXJfbm9kZS5mdWxmaWxsbWVudFN0YXR1cyA9IGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1czsKICAgICAgICAgIG9yZGVyT2JqZWN0LmZ1bGZpbGxtZW50X3N0YXR1cyA9CiAgICAgICAgICAgIEJvb2xlYW4ob3JkZXJPYmplY3QuZnVsZmlsbG1lbnRfc3RhdHVzKSA9PT0gdHJ1ZQogICAgICAgICAgICAgID8gb3JkZXJPYmplY3QuZnVsZmlsbG1lbnRfc3RhdHVzCiAgICAgICAgICAgICAgOiAiVW5mdWxmaWxsZWQiOwogICAgICAgICAgLy8gU2V0IG9ubHkgZmlyc3QgY2hhcmFjdGVyIHRvIHVwcGVyY2FzZSB3aGlsZSByZW1haW5pbmcgY2hhcmFjdGVycyBzZXQgdG8gbG93ZXJjYXNlCiAgICAgICAgICBvcmRlck9iamVjdC5mdWxmaWxsbWVudF9zdGF0dXMgPQogICAgICAgICAgb3JkZXJPYmplY3QuZnVsZmlsbG1lbnRfc3RhdHVzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsKICAgICAgICAgIG9yZGVyT2JqZWN0LmZ1bGZpbGxtZW50X3N0YXR1cy5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgaWYodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayAhPSAic2hvcGlmeSIpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcmRlck9iamVjdC5vcmRlcl9ub3Rlcy5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgaWYob3JkZXJPYmplY3Qub3JkZXJfbm90ZXNbaV0uZGF0ZV9jcmVhdGVkICE9IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgb3JkZXJPYmplY3Qub3JkZXJfbm90ZXNbaV0uZGF0ZV9jcmVhdGVkID0gdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PT0gImJpZ2NvbW1lcmNlIj8gbW9tZW50KG9yZGVyT2JqZWN0Lm9yZGVyX25vdGVzW2ldLmRhdGVfY3JlYXRlZCkuZm9ybWF0KCJZWVlZLU1NLUREVGhoOm1tOnNzWiIpCiAgICAgICAgICAgICAgOiBtb21lbnQob3JkZXJPYmplY3Qub3JkZXJfbm90ZXNbaV0uZGF0ZV9jcmVhdGVkLCBbIllZWVktTU0tRERUaGg6bW06c3NaIixdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIEhIOm1tIGEiKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG9yZGVyT2JqZWN0OwogICAgICAgIH0pOwogICAgICAgIGlmICh0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9vcmRlcnNfbGlzdC5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPSAiVGhlcmUgYXJlIG5vIG9yZGVycyB0byBiZSBkaXNwbGF5ZWQiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0KICAgICAgICAgICAgIlNlbGVjdCB0aGUgb3JkZXIgdGhhdCB5b3Ugd2lzaCB0byByZXR1cm4iOwogICAgICAgIH0KICAgICAgICAvLyB0aGlzLnJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMgPSB7fTsKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMgPSB7fTsKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9zZWxlY3RlZF9pdGVtcyA9IFtdOwogICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZF9saXN0ID0gbnVsbDsKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmQgPSBudWxsOwogICAgICAgIHRoaXMuY2hhdFtpbmRleF0uY29udmVyc2F0aW9uX29ubHkgPSBmYWxzZTsKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmNvbnZlcnNhdGlvbl9vbmx5ID0gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChvcmRlcl90eXBlID09PSAiYWxsX29yZGVycyIpIHsKICAgICAgICBsZXQgb3JkZXJzX2RhdGEgPSBvcmRlcnNEYXRhLAogICAgICAgICAgY29tcGxldGVfb3JkZXJzX2RhdGEgPSBbXTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9yZGVyc19kYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgY3VyX25vZGUgPSBvcmRlcnNfZGF0YVtpXTsKICAgICAgICAgIGN1cl9ub2RlLnByb2Nlc3NlZEF0ID0KICAgICAgICAgICAgdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PT0gImJpZ2NvbW1lcmNlIgogICAgICAgICAgICAgID8gbW9tZW50KG9yZGVyc19kYXRhW2ldLmNyZWF0ZWRfYXQpLmZvcm1hdCgiRG8gTU1NIFlZWVkiKQogICAgICAgICAgICAgIDogbW9tZW50KG9yZGVyc19kYXRhW2ldLmNyZWF0ZWRfYXQsIFsiWVlZWS1NTS1ERFRoOm06c1oiXSkuZm9ybWF0KAogICAgICAgICAgICAgICAgICAiRG8gTU1NIFlZWVkiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgLy8gY3VyX25vZGUuZnVsZmlsbG1lbnRTdGF0dXMgPSBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXM7CiAgICAgICAgICBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMgPQogICAgICAgICAgICBCb29sZWFuKGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cykgPT09IHRydWUKICAgICAgICAgICAgICA/IGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cwogICAgICAgICAgICAgIDogIlVuZnVsZmlsbGVkIjsKICAgICAgICAgIC8vIC8vIFNldCBvbmx5IGZpcnN0IGNoYXJhY3RlciB0byB1cHBlcmNhc2Ugd2hpbGUgcmVtYWluaW5nIGNoYXJhY3RlcnMgc2V0IHRvIGxvd2VyY2FzZQogICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzID0KICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsKICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzLnNsaWNlKDEpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBpZih0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrICE9ICJzaG9waWZ5IikgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1cl9ub2RlLm9yZGVyX25vdGVzLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICBpZihjdXJfbm9kZS5vcmRlcl9ub3Rlc1tpXS5kYXRlX2NyZWF0ZWQgIT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgIG9yZGVyT2JqZWN0Lm9yZGVyX25vdGVzW2ldLmRhdGVfY3JlYXRlZCA9IHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT09ICJiaWdjb21tZXJjZSI/IG1vbWVudChvcmRlck9iamVjdC5vcmRlcl9ub3Rlc1tpXS5kYXRlX2NyZWF0ZWQpLmZvcm1hdCgiWVlZWS1NTS1ERFRoaDptbTpzc1oiKQogICAgICAgICAgICAgICAgOiBtb21lbnQob3JkZXJPYmplY3Qub3JkZXJfbm90ZXNbaV0uZGF0ZV9jcmVhdGVkLCBbIllZWVktTU0tRERUaGg6bW06c3NaIixdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIEhIOm1tIGEiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gIAogICAgICAgICAgfQogICAgICAgICAgY29tcGxldGVfb3JkZXJzX2RhdGEucHVzaCh7CiAgICAgICAgICAgIG5hbWU6CiAgICAgICAgICAgICAgdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIKICAgICAgICAgICAgICAgID8gY3VyX25vZGUubmFtZQogICAgICAgICAgICAgICAgOiBjdXJfbm9kZS5pZCwKICAgICAgICAgICAgcHJvY2Vzc2VkX2RhdGU6IGN1cl9ub2RlLnByb2Nlc3NlZEF0LAogICAgICAgICAgICBmdWxmaWxsbWVudF9zdGF0dXM6IGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cywKICAgICAgICAgICAgc3RhdHVzX3VybDogY3VyX25vZGUub3JkZXJfc3RhdHVzX3VybCwKICAgICAgICAgICAgb3JkZXJfbm90ZXM6CiAgICAgICAgICAgICAgdGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIKICAgICAgICAgICAgICAgID8gbnVsbAogICAgICAgICAgICAgICAgOiBjdXJfbm9kZS5vcmRlcl9ub3RlcywKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3dfYWxsX29yZGVyc19saXN0ID0gdHJ1ZTsKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmFsbF9vcmRlcnNfbGlzdCA9IGNvbXBsZXRlX29yZGVyc19kYXRhOwogICAgICAgIGlmICh0aGlzLmNoYXRbaW5kZXhdLmFsbF9vcmRlcnNfbGlzdC5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPSAiVGhlcmUgYXJlIG5vIG9yZGVycyB0byBiZSBkaXNwbGF5ZWQiOwogICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5zaG93X2FsbF9vcmRlcnNfbGlzdCA9IGZhbHNlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gIlBsZWFzZSBGaW5kIEJlbG93IFlvdXIgTGF0ZXN0IE9yZGVyczoiOwogICAgICAgIH0KICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VudF9vcmRlcnNfbGlzdCA9IGNvbXBsZXRlX29yZGVyc19kYXRhOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5jb252ZXJzYXRpb25fb25seSA9IHRydWU7CiAgICAgICAgfSwgNTAwKTsKICAgICAgfQogICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgIH0sCiAgICBzdWJtaXRfcmVmdW5kX3JlcXVlc3QocmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlscywgaW5kZXgpIHsKICAgICAgaWYgKHRoaXMuY2hhdFtpbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZF9saXN0ID09PSBudWxsKSB7CiAgICAgICAgdGhpcy5zaG93X3Nob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmRfZXJyb3IgPSB0cnVlOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAodGhpcy5jaGF0W2luZGV4XS5zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX2xpc3QgPT09ICJPdGhlcnMiKSB7CiAgICAgICAgaWYgKAogICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kID09PSBudWxsIHx8CiAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmQgPT09ICIiCiAgICAgICAgKSB7CiAgICAgICAgICB0aGlzLnNob3dfc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZF9lcnJvciA9IHRydWU7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZCA9CiAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmRfbGlzdDsKICAgICAgfQogICAgICAvLyBlbHNlIHsKICAgICAgdGhpcy5zaG93X3Nob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmRfZXJyb3IgPSBmYWxzZTsKICAgICAgbGV0IGl0ZW1zX3RvX3JlZnVuZCA9IHJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMubGluZV9pdGVtcy5maWx0ZXIoCiAgICAgICAgKGxpbmVJdGVtKSA9PiB7CiAgICAgICAgICBpZiAodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAibWFnZW50byIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hhdFtpbmRleF0ucmVmdW5kX3NlbGVjdGVkX2l0ZW1zLmluY2x1ZGVzKAogICAgICAgICAgICAgIGxpbmVJdGVtLnByb2R1Y3RfaWQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9zZWxlY3RlZF9pdGVtcy5pbmNsdWRlcyhsaW5lSXRlbS5pZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICApOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZW1zX3RvX3JlZnVuZC5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICgKICAgICAgICAgIGl0ZW1zX3RvX3JlZnVuZFtpXS5zZWxlY3RlZF9xdWFudGl0eSA9PT0gbnVsbCB8fAogICAgICAgICAgQm9vbGVhbihpdGVtc190b19yZWZ1bmRbaV0uc2VsZWN0ZWRfcXVhbnRpdHkpID09PSBmYWxzZQogICAgICAgICkgewogICAgICAgICAgc3dhbCh7CiAgICAgICAgICAgIHRleHQ6ICJQbGVhc2UgZW50ZXIgdGhlIHByb2R1Y3QgcXVhbnRpdHkgaW4gbnVtZXJpYyBvbmx5IiwKICAgICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICAgIHBvc2l0aW9uOiAidG9wLWVuZCIsCiAgICAgICAgICAgIHR5cGU6ICJ3YXJuaW5nIiwKICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IGZhbHNlLAogICAgICAgICAgICB0aW1lcjogNTAwMCwKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogICAgICBsZXQgcmVmdW5kX3BheWxvYWRfc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoewogICAgICAgIG9yZGVySWQ6IHJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMuaWQsCiAgICAgICAgb3JkZXJfbmFtZTogcmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlscy5uYW1lLAogICAgICAgIGN1c3RvbWVyX2lkOiB0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQsCiAgICAgICAgZnVsZmlsbG1lbnRfc3RhdHVzOiByZWZ1bmRfb3JkZXJfdmlld19kZXRhaWxzLmZ1bGZpbGxtZW50X3N0YXR1cywKICAgICAgICBwYXltZW50X3N0YXR1czogcmVmdW5kX29yZGVyX3ZpZXdfZGV0YWlscy5wYXltZW50X3N0YXR1cywKICAgICAgICBjdXJyZW5jeTogdGhpcy5yZXRhaWxfc2hvcF9jdXJyZW5jeSwKICAgICAgICBsaW5lSXRlbXM6IGl0ZW1zX3RvX3JlZnVuZC5tYXAoKGl0ZW0pID0+IHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGxpbmVfaXRlbV9pZDoKICAgICAgICAgICAgICB0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJtYWdlbnRvIgogICAgICAgICAgICAgICAgPyBpdGVtLnByb2R1Y3RfaWQKICAgICAgICAgICAgICAgIDogaXRlbS5pZCwKICAgICAgICAgICAgcXVhbnRpdHk6IGl0ZW0uc2VsZWN0ZWRfcXVhbnRpdHksCiAgICAgICAgICAgIHByb2R1Y3RfaWQ6IGl0ZW0ucHJvZHVjdF9pZCwKICAgICAgICAgICAgdmFyaWFudF9pZDogaXRlbS52YXJpYW50X2lkLAogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICByZWZ1bmRSZWFzb246IHRoaXMuY2hhdFtpbmRleF0uc2hvcGlmeV9yZWFzb25fZm9yX3JlZnVuZCwKICAgICAgfSk7CiAgICAgIGxldCByZWZ1bmRfaW50ZW50ID0gYC9wcm9jZXNzX3JlZnVuZF9yZXF1ZXN0JHtyZWZ1bmRfcGF5bG9hZF9zdHJpbmd9YDsKICAgICAgbGV0IHJlZnVuZF9vYmplY3QgPSB7CiAgICAgICAgdHlwZTogInBvc3RiYWNrIiwKICAgICAgICB0aXRsZTogIlByb2NlZWQiLAogICAgICAgIHZhbHVlOiByZWZ1bmRfaW50ZW50LAogICAgICB9OwogICAgICAvLyBjb25zb2xlLmxvZyhyZWZ1bmRfaW50ZW50KTsKICAgICAgdGhpcy5jdXN0b21fYnV0dG9uX2NsaWNrKHJlZnVuZF9vYmplY3QpOwogICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9vcmRlcl92aWV3X2RldGFpbHMgPSB7fTsKICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfc2VsZWN0ZWRfaXRlbXMgPSBbXTsKICAgICAgdGhpcy5jaGF0W2luZGV4XS5zaG9waWZ5X3JlYXNvbl9mb3JfcmVmdW5kX2xpc3QgPSBudWxsOwogICAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3BpZnlfcmVhc29uX2Zvcl9yZWZ1bmQgPSBudWxsOwogICAgICB0aGlzLmNoYXQuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgLy8gfQogICAgfSwKICAgIHJldGFpbF9mb3JtX2ZvY3VzKGluZGV4KSB7CiAgICAgIGlmICgKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID09PQogICAgICAgICJXZSBhcmUgc29ycnksIHlvdXIgY3JlZGVudGlhbHMgYXJlIGludmFsaWQuIFBsZWFzZSB0cnkgYWdhaW4gOikiCiAgICAgICkgewogICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPQogICAgICAgICAgIlBsZWFzZSBsb2dpbiB3aXRoIHlvdXIgY3JlZGVudGlhbHMgZm9yIGJldHRlciBleHBlcmllbmNlIDopIjsKICAgICAgfQogICAgfSwKICAgIHJldGFpbF9jcmVhdGVfY3VzdG9tZXJfdG9rZW4oaW5kZXgsIGlzUmVmdW5kKSB7CiAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IHRydWU7CiAgICAgIGlzUmVmdW5kID0gaXNSZWZ1bmQgfHwgZmFsc2U7CiAgICAgIGlmICh0aGlzLmNoYXRbaW5kZXhdLnJldHVybl9zaG9waWZ5X2VtYWlsID09PSB0cnVlICYmICFpc1JlZnVuZCkgewogICAgICAgIHRoaXMuc2VuZF9yZXRhaWxfY3VzdG9tZXJfaWQoaW5kZXgsIHRydWUpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBsZXQgc2hvcF9lbmRwb2ludCA9IHRoaXMuc2hvcGlmeV9yZXRhaWxfc2hvcF9uYW1lICsgIi5teXNob3BpZnkuY29tIjsKICAgICAgbGV0IHF1ZXJ5U3RyaW5nID0gJCgiI3Nob3BpZnlfbG9naW5fZm9ybSIpLnNlcmlhbGl6ZUFycmF5KCk7CiAgICAgIGxldCBmb3JtX3BheWxvYWQgPSB7fTsKICAgICAgZm9ybV9wYXlsb2FkWyJzaG9waWZ5X2lzX29ubHlfZW1haWwiXSA9CiAgICAgICAgdGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQ7CiAgICAgIGZvcm1fcGF5bG9hZFsiZW1haWwiXSA9IHRoaXMuY2hhdFtpbmRleF0uY3VzdG9tZXJfZW1haWxfaWQ7CiAgICAgIGZvcm1fcGF5bG9hZFsicGFzc3dvcmQiXSA9IHRoaXMuY2hhdFtpbmRleF0uY3VzdG9tZXJfcGFzc3dvcmQ7CiAgICAgIGZvcm1fcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KGZvcm1fcGF5bG9hZCk7CiAgICAgIGF4aW9zCiAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgY2hhdDogYC9zaG9waWZ5X2NyZWF0ZV9jdXN0b21lcl90b2tlbiR7Zm9ybV9wYXlsb2FkfWAsCiAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICB9KQogICAgICAgIC50aGVuKCh7IGRhdGEgfSkgPT4gewogICAgICAgICAgaWYgKGRhdGEucmVzcG9uc2VzWzBdLnRva2VuX3R5cGUgPT09ICJjdXN0b21lcl90b2tlbiIpIHsKICAgICAgICAgICAgaWYgKEJvb2xlYW4oZGF0YS5yZXNwb25zZXNbMF0uRGF0YSkpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAic2hvcGlmeSIpIHsKICAgICAgICAgICAgICAgIGxldCBjdXN0b21lclRva2VuID0gZGF0YS5yZXNwb25zZXNbMF0uRGF0YS5hY2Nlc3NUb2tlbjsKICAgICAgICAgICAgICAgIGxldCB0b2tlbkV4cGlyeSA9IGRhdGEucmVzcG9uc2VzWzBdLkRhdGEuZXhwaXJlc0F0OwogICAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iLCBjdXN0b21lclRva2VuKTsKICAgICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuX2V4cGlyeSIsIHRva2VuRXhwaXJ5KTsKICAgICAgICAgICAgICAgIHRoaXMucmV0YWlsX2ZldGNoX29yZGVycygKICAgICAgICAgICAgICAgICAgY3VzdG9tZXJUb2tlbiwKICAgICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAgIGlzUmVmdW5kLAogICAgICAgICAgICAgICAgICAic2hvcGlmeV9jdXN0b21lcl90b2tlbiIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJ3b29jb21tZXJjZSIpIHsKICAgICAgICAgICAgICAgIGxldCBjdXN0b21lclRva2VuID0KICAgICAgICAgICAgICAgICAgZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfZGF0YS5jdXN0b21lcl9lbWFpbDsKICAgICAgICAgICAgICAgIGxldCB0b2tlbkV4cGlyeSA9IGRhdGEucmVzcG9uc2VzWzBdLkRhdGEuZXhwaXJlc0F0OwogICAgICAgICAgICAgICAgbGV0IGN1c3RvbWVySWQgPSBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b21lcl9kYXRhLmN1c3RvbWVyX2lkOwogICAgICAgICAgICAgICAgdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkID0gY3VzdG9tZXJJZDsKICAgICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIiwgY3VzdG9tZXJUb2tlbik7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbl9leHBpcnkiLCB0b2tlbkV4cGlyeSk7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl9pZCIsIGN1c3RvbWVySWQpOwogICAgICAgICAgICAgICAgdGhpcy5yZXRhaWxfZmV0Y2hfb3JkZXJzKAogICAgICAgICAgICAgICAgICBjdXN0b21lclRva2VuLAogICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgaXNSZWZ1bmQsCiAgICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iKSB7CiAgICAgICAgICAgICAgICBsZXQgY3VzdG9tZXJUb2tlbiA9CiAgICAgICAgICAgICAgICAgIGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbWVyX2RhdGEuY3VzdG9tZXJfZW1haWw7CiAgICAgICAgICAgICAgICBsZXQgdG9rZW5FeHBpcnkgPSBkYXRhLnJlc3BvbnNlc1swXS5EYXRhLmV4cGlyZXNBdDsKICAgICAgICAgICAgICAgIGxldCBjdXN0b21lcklkID0gZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfZGF0YS5jdXN0b21lcl9pZDsKICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IGN1c3RvbWVySWQ7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIsIGN1c3RvbWVyVG9rZW4pOwogICAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW5fZXhwaXJ5IiwgdG9rZW5FeHBpcnkpOwogICAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiLCBjdXN0b21lcklkKTsKICAgICAgICAgICAgICAgIHRoaXMucmV0YWlsX2ZldGNoX29yZGVycygKICAgICAgICAgICAgICAgICAgY3VzdG9tZXJUb2tlbiwKICAgICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAgIGlzUmVmdW5kLAogICAgICAgICAgICAgICAgICAic2hvcGlmeV9jdXN0b21lcl90b2tlbiIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJiaWdjb21tZXJjZSIpIHsKICAgICAgICAgICAgICAgIGxldCBjdXN0b21lclRva2VuID0KICAgICAgICAgICAgICAgICAgZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfZGF0YS5jdXN0b21lcl9lbWFpbDsKICAgICAgICAgICAgICAgIGxldCB0b2tlbkV4cGlyeSA9IGRhdGEucmVzcG9uc2VzWzBdLkRhdGEuZXhwaXJlc0F0OwogICAgICAgICAgICAgICAgbGV0IGN1c3RvbWVySWQgPSBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b21lcl9kYXRhLmN1c3RvbWVyX2lkOwogICAgICAgICAgICAgICAgdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkID0gY3VzdG9tZXJJZDsKICAgICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIiwgY3VzdG9tZXJUb2tlbik7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbl9leHBpcnkiLCB0b2tlbkV4cGlyeSk7CiAgICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl9pZCIsIGN1c3RvbWVySWQpOwogICAgICAgICAgICAgICAgdGhpcy5yZXRhaWxfZmV0Y2hfb3JkZXJzKAogICAgICAgICAgICAgICAgICBjdXN0b21lclRva2VuLAogICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgaXNSZWZ1bmQsCiAgICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9CiAgICAgICAgICAgICAgICAiV2UgYXJlIHNvcnJ5LCB5b3VyIGNyZWRlbnRpYWxzIGFyZSBpbnZhbGlkLiBQbGVhc2UgdHJ5IGFnYWluIDopIjsKICAgICAgICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChkYXRhLnJlc3BvbnNlc1swXS50b2tlbl90eXBlID09PSAiY3VzdG9tZXJfaWQiKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJzaG9waWZ5IikgewogICAgICAgICAgICAgIGxldCBjdXN0b21lcklkID0gZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfaWQ7CiAgICAgICAgICAgICAgbGV0IGN1c3RvbWVyRW1haWwgPSBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b21lcl9lbWFpbDsKICAgICAgICAgICAgICB0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQgPSBjdXN0b21lcklkOwogICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIiwgY3VzdG9tZXJJZCk7CiAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iLCBjdXN0b21lckVtYWlsKTsKICAgICAgICAgICAgICB0aGlzLnJldGFpbF9mZXRjaF9vcmRlcnMoCiAgICAgICAgICAgICAgICBjdXN0b21lcklkLAogICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICBpc1JlZnVuZCwKICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAid29vY29tbWVyY2UiKSB7CiAgICAgICAgICAgICAgbGV0IGN1c3RvbWVySWQgPSBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b21lcl9pZDsKICAgICAgICAgICAgICBsZXQgY3VzdG9tZXJFbWFpbCA9IGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbWVyX2VtYWlsOwogICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIiwgY3VzdG9tZXJJZCk7CiAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iLCBjdXN0b21lckVtYWlsKTsKICAgICAgICAgICAgICB0aGlzLnJldGFpbF9mZXRjaF9vcmRlcnMoCiAgICAgICAgICAgICAgICBjdXN0b21lcklkLAogICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICBpc1JlZnVuZCwKICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5yZXRhaWxfd2ViX2ZyYW1ld29yayA9PSAibWFnZW50byIpIHsKICAgICAgICAgICAgICBsZXQgY3VzdG9tZXJJZCA9IGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbWVyX2lkOwogICAgICAgICAgICAgIGxldCBjdXN0b21lckVtYWlsID0gZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfZW1haWw7CiAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiLCBjdXN0b21lcklkKTsKICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIsIGN1c3RvbWVyRW1haWwpOwogICAgICAgICAgICAgIHRoaXMucmV0YWlsX2ZldGNoX29yZGVycygKICAgICAgICAgICAgICAgIGN1c3RvbWVySWQsCiAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgIGlzUmVmdW5kLAogICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfaWQiCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJiaWdjb21tZXJjZSIpIHsKICAgICAgICAgICAgICBsZXQgY3VzdG9tZXJJZCA9IGRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbWVyX2lkOwogICAgICAgICAgICAgIGxldCBjdXN0b21lckVtYWlsID0gZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tZXJfZW1haWw7CiAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiLCBjdXN0b21lcklkKTsKICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgic2hvcGlmeV9jdXN0b21lcl90b2tlbiIsIGN1c3RvbWVyRW1haWwpOwogICAgICAgICAgICAgIHRoaXMucmV0YWlsX2ZldGNoX29yZGVycygKICAgICAgICAgICAgICAgIGN1c3RvbWVySWQsCiAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgIGlzUmVmdW5kLAogICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfaWQiCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPQogICAgICAgICAgICAgICAgIldlIGFyZSBzb3JyeSwgY291bGQgbm90IGZpbmQgYW55IHJlY29yZHMgd2l0aCB0aGlzIGVtYWlsLiBQbGVhc2UgdHJ5IGFnYWluIDopIjsKICAgICAgICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9CiAgICAgICAgICAgICAgIldlIGFyZSBzb3JyeSwgeW91ciBjcmVkZW50aWFscyBhcmUgaW52YWxpZC4gUGxlYXNlIHRyeSBhZ2FpbiA6KSI7CiAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgLy8gdGhpcy5jaGF0LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfSk7CiAgICB9LAogICAgcmV0YWlsX2ZldGNoX2N1c3RvbWVyX2lkKGN1c3RvbWVyQWNjZXNzVG9rZW4sIGluZGV4LCB0b2tlbl90eXBlKSB7CiAgICAgIGxldCBzaG9wX2VuZHBvaW50ID0gdGhpcy5zaG9waWZ5X3JldGFpbF9zaG9wX25hbWUgKyAiLm15c2hvcGlmeS5jb20iOwogICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSB0cnVlOwogICAgICBpZiAoIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QpKSB7CiAgICAgICAgaWYgKHRva2VuX3R5cGUgPT09ICJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIikgewogICAgICAgICAgbGV0IHN0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgIGN1c3RvbWVyX2FjY2Vzc190b2tlbjogY3VzdG9tZXJBY2Nlc3NUb2tlbiwgLy9zaG9waWZ5IGFjY2VzcyB0b2tlbiA9PSBlbWFpbCBmb3Igd29vY29tbWVyY2UKICAgICAgICAgIH0pOwogICAgICAgICAgYXhpb3MKICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICAgIHVzZXJuYW1lOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikuZW1haWwsCiAgICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgICBjaGF0OiBgL3Nob3BpZnlfZ2V0X2N1c3RvbWVyX2lkX2FuZF9vcmRlcnMke3N0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWR9YCwKICAgICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgICB9KQogICAgICAgICAgICAudGhlbigoeyBkYXRhIH0pID0+IHsKICAgICAgICAgICAgICBpZiAoQm9vbGVhbihkYXRhLnJlc3BvbnNlc1swXS5jdXN0b20pKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRfY3VzdG9tZXJfb3JkZXJzKAogICAgICAgICAgICAgICAgICBkYXRhLnJlc3BvbnNlc1swXS5jdXN0b20ub3JkZXJzX2xpc3QsCiAgICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgICAicmVmdW5kIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9CiAgICAgICAgICAgICAgICAgICJTb21lIEVycm9yIE9jY3VycmVkLiBQbGVhc2UgVHJ5IEFnYWluIjsKICAgICAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmICh0b2tlbl90eXBlID09ICJzaG9waWZ5X2N1c3RvbWVyX2lkIikgewogICAgICAgICAgbGV0IHN0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgIGN1c3RvbWVySWQ6IHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCwKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICJGZXRjaGluZyB5b3VyIG9yZGVyIGRldGFpbHMgLi4uIjsKICAgICAgICAgIGF4aW9zCiAgICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICAgICAgY2hhdDogYC9yZXRyaWV2ZV9jdXN0b21lcl9vcmRlcnMke3N0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWR9YCwKICAgICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgICB9KQogICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICB0aGlzLmxvYWRfY3VzdG9tZXJfb3JkZXJzKAogICAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tLm9yZGVyc19saXN0LAogICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAicmVmdW5kIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4gewogICAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICAgIHRoaXMudXBkYXRlX3Njcm9sbGJhcigidXB0b19lbmQiLCAicmVzcG9uc2UiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcmV0YWlsX2ZldGNoX29yZGVycyhjdXN0b21lckFjY2Vzc1Rva2VuLCBpbmRleCwgaXNSZWZ1bmQsIHRva2VuX3R5cGUpIHsKICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKICAgICAgaXNSZWZ1bmQgPSBpc1JlZnVuZCB8fCBmYWxzZTsKICAgICAgdGhpcy5jaGF0W2luZGV4XS5jb252ZXJzYXRpb25fb25seSA9IGZhbHNlOwogICAgICBsZXQgc2hvcF9lbmRwb2ludCA9IHRoaXMuc2hvcGlmeV9yZXRhaWxfc2hvcF9uYW1lICsgIi5teXNob3BpZnkuY29tIjsKICAgICAgaWYgKHRva2VuX3R5cGUgPT09ICJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIikgewogICAgICAgIGxldCBzdHJpbmdpZmllZF9jdXN0b21lcl9wYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgY3VzdG9tZXJfYWNjZXNzX3Rva2VuOiBjdXN0b21lckFjY2Vzc1Rva2VuLAogICAgICAgIH0pOwogICAgICAgIGF4aW9zCiAgICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgY2hhdDogYC9zaG9waWZ5X2dldF9jdXN0b21lcl9vcmRlcnMke3N0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWR9YCwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKCh7IGRhdGEgfSkgPT4gewogICAgICAgICAgICB0aGlzLmlzX3R5cGluZ19pbmRpY2F0b3Jfb24gPSBmYWxzZTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBsZXQgY3VzdG9tZXJJZCA9IGF0b2IoZGF0YS5yZXNwb25zZXNbMF0uZGF0YS5jdXN0b21lci5pZCk7CiAgICAgICAgICAgICAgdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkID0gY3VzdG9tZXJJZC5zbGljZSgKICAgICAgICAgICAgICAgIGN1c3RvbWVySWQubGFzdEluZGV4T2YoIi8iKSArIDEKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KAogICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfaWQiLAogICAgICAgICAgICAgICAgdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KCiAgICAgICAgICAgIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJzaG9waWZ5IikgewogICAgICAgICAgICAgIGxldCBvcmRlcnNEYXRhID0gZGF0YS5yZXNwb25zZXNbMF0uZGF0YS5jdXN0b21lci5vcmRlcnMuZWRnZXM7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PSAibnVtYmVyIiAmJiBvcmRlcnNEYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGlmIChpc1JlZnVuZCkgewogICAgICAgICAgICAgICAgICB0aGlzLnJldGFpbF9mZXRjaF9jdXN0b21lcl9pZCgKICAgICAgICAgICAgICAgICAgICBjdXN0b21lckFjY2Vzc1Rva2VuLAogICAgICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGxldCBvcmRlcnNfZGF0YSA9CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLnJlc3BvbnNlc1swXS5kYXRhLmN1c3RvbWVyLm9yZGVycy5lZGdlcywKICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZV9vcmRlcnNfZGF0YSA9IFtdOwogICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9yZGVyc19kYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cl9ub2RlID0gb3JkZXJzX2RhdGFbaV0ubm9kZTsKICAgICAgICAgICAgICAgICAgICBjdXJfbm9kZS5wcm9jZXNzZWRBdCA9IG1vbWVudChjdXJfbm9kZS5wcm9jZXNzZWRBdCwgWwogICAgICAgICAgICAgICAgICAgICAgIllZWVktTU0tRERUaGg6bW06c3NaIiwKICAgICAgICAgICAgICAgICAgICBdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIik7CiAgICAgICAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRTdGF0dXMgPQogICAgICAgICAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRTdGF0dXMucmVwbGFjZSgiXyIsICIgIik7CiAgICAgICAgICAgICAgICAgICAgLy8gU2V0IG9ubHkgZmlyc3QgY2hhcmFjdGVyIHRvIHVwcGVyY2FzZSB3aGlsZSByZW1haW5pbmcgY2hhcmFjdGVycyBzZXQgdG8gbG93ZXJjYXNlCiAgICAgICAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRTdGF0dXMgPQogICAgICAgICAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRTdGF0dXMuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKwogICAgICAgICAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRTdGF0dXMuc2xpY2UoMSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZV9vcmRlcnNfZGF0YS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGN1cl9ub2RlLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZWRfZGF0ZTogY3VyX25vZGUucHJvY2Vzc2VkQXQsCiAgICAgICAgICAgICAgICAgICAgICBmdWxmaWxsbWVudF9zdGF0dXM6IGN1cl9ub2RlLmZ1bGZpbGxtZW50U3RhdHVzLAogICAgICAgICAgICAgICAgICAgICAgc3RhdHVzX3VybDogY3VyX25vZGUuc3RhdHVzVXJsLAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvd19hbGxfb3JkZXJzX2xpc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmFsbF9vcmRlcnNfbGlzdCA9IGNvbXBsZXRlX29yZGVyc19kYXRhOwogICAgICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0KICAgICAgICAgICAgICAgICAgICAiUGxlYXNlIEZpbmQgQmVsb3cgWW91ciBMYXRlc3QgT3JkZXJzOiI7CgogICAgICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VudF9vcmRlcnNfbGlzdCA9CiAgICAgICAgICAgICAgICAgICAgZGF0YS5yZXNwb25zZXNbMF0uZGF0YS5jdXN0b21lci5vcmRlcnMuZWRnZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5jb252ZXJzYXRpb25fb25seSA9IHRydWU7CiAgICAgICAgICAgICAgfSwgNTAwKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJ3b29jb21tZXJjZSIpIHsKICAgICAgICAgICAgICBpZiAoaXNSZWZ1bmQpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9hZF9jdXN0b21lcl9vcmRlcnMoCiAgICAgICAgICAgICAgICAgIGRhdGEucmVzcG9uc2VzWzBdLmRhdGEuY3VzdG9tZXIub3JkZXJzLAogICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgaXNSZWZ1bmQgPyAicmVmdW5kIiA6ICJhbGxfb3JkZXJzIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICAgICAgICBsZXQgb3JkZXJzX2RhdGEgPSBkYXRhLnJlc3BvbnNlc1swXS5kYXRhLmN1c3RvbWVyLm9yZGVycywKICAgICAgICAgICAgICAgICAgY29tcGxldGVfb3JkZXJzX2RhdGEgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3JkZXJzX2RhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cl9ub2RlID0gb3JkZXJzX2RhdGFbaV07CiAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLnByb2Nlc3NlZEF0ID0gbW9tZW50KGN1cl9ub2RlLmNyZWF0ZWRfYXQsIFsKICAgICAgICAgICAgICAgICAgICAiWVlZWS1NTS1ERFRoaDptbTpzc1oiLAogICAgICAgICAgICAgICAgICBdKS5mb3JtYXQoIkRvIE1NTSBZWVlZIik7CiAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cyA9CiAgICAgICAgICAgICAgICAgICAgQm9vbGVhbihjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMpID09PSB0cnVlCiAgICAgICAgICAgICAgICAgICAgICA/IGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cwogICAgICAgICAgICAgICAgICAgICAgOiAiVW5mdWxmaWxsZWQiOwogICAgICAgICAgICAgICAgICAvLyBTZXQgb25seSBmaXJzdCBjaGFyYWN0ZXIgdG8gdXBwZXJjYXNlIHdoaWxlIHJlbWFpbmluZyBjaGFyYWN0ZXJzIHNldCB0byBsb3dlcmNhc2UKICAgICAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzID0KICAgICAgICAgICAgICAgICAgICBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKwogICAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cy5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1cl9ub2RlLm9yZGVyX25vdGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY3VyX25vZGUub3JkZXJfbm90ZXNbaV0uZGF0ZV9jcmVhdGVkID0gbW9tZW50KAogICAgICAgICAgICAgICAgICAgICAgY3VyX25vZGUub3JkZXJfbm90ZXNbaV0uZGF0ZV9jcmVhdGVkLAogICAgICAgICAgICAgICAgICAgICAgWyJZWVlZLU1NLUREVGhoOm1tOnNzWiJdCiAgICAgICAgICAgICAgICAgICAgKS5mb3JtYXQoIkRvIE1NTSBZWVlZIEhIOm1tIGEiKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb21wbGV0ZV9vcmRlcnNfZGF0YS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBuYW1lOiBjdXJfbm9kZS5pZCwKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZWRfZGF0ZTogY3VyX25vZGUucHJvY2Vzc2VkQXQsCiAgICAgICAgICAgICAgICAgICAgZnVsZmlsbG1lbnRfc3RhdHVzOiBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMsCiAgICAgICAgICAgICAgICAgICAgc3RhdHVzX3VybDogY3VyX25vZGUub3JkZXJfc3RhdHVzX3VybCwKICAgICAgICAgICAgICAgICAgICBvcmRlcl9ub3RlczogY3VyX25vZGUub3JkZXJfbm90ZXMsCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5zaG93X2FsbF9vcmRlcnNfbGlzdCA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmFsbF9vcmRlcnNfbGlzdCA9IGNvbXBsZXRlX29yZGVyc19kYXRhOwogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9CiAgICAgICAgICAgICAgICAgICJQbGVhc2UgRmluZCBCZWxvdyBZb3VyIExhdGVzdCBPcmRlcnM6IjsKICAgICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvd19hbGxfb3JkZXJzX2xpc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlbnRfb3JkZXJzX2xpc3QgPSBjb21wbGV0ZV9vcmRlcnNfZGF0YTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmNvbnZlcnNhdGlvbl9vbmx5ID0gdHJ1ZTsKICAgICAgICAgICAgICB9LCA1MDApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iKSB7CiAgICAgICAgICAgICAgaWYgKGlzUmVmdW5kKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRfY3VzdG9tZXJfb3JkZXJzKAogICAgICAgICAgICAgICAgICBkYXRhLnJlc3BvbnNlc1swXS5kYXRhLmN1c3RvbWVyLm9yZGVycywKICAgICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAgIGlzUmVmdW5kID8gInJlZnVuZCIgOiAiYWxsX29yZGVycyIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNfdHlwaW5nX2luZGljYXRvcl9vbiA9IGZhbHNlOwogICAgICAgICAgICAgICAgbGV0IG9yZGVyc19kYXRhID0gZGF0YS5yZXNwb25zZXNbMF0uZGF0YS5jdXN0b21lci5vcmRlcnMsCiAgICAgICAgICAgICAgICAgIGNvbXBsZXRlX29yZGVyc19kYXRhID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9yZGVyc19kYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJfbm9kZSA9IG9yZGVyc19kYXRhW2ldOwogICAgICAgICAgICAgICAgICBjdXJfbm9kZS5wcm9jZXNzZWRBdCA9IG1vbWVudChjdXJfbm9kZS5jcmVhdGVkX2F0LCBbCiAgICAgICAgICAgICAgICAgICAgIllZWVktTU0tRERUaGg6bW06c3NaIiwKICAgICAgICAgICAgICAgICAgXSkuZm9ybWF0KCJEbyBNTU0gWVlZWSIpOwogICAgICAgICAgICAgICAgICBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMgPQogICAgICAgICAgICAgICAgICAgIEJvb2xlYW4oY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzKSA9PT0gdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgPyBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMKICAgICAgICAgICAgICAgICAgICAgIDogIlVuZnVsZmlsbGVkIjsKICAgICAgICAgICAgICAgICAgLy8gU2V0IG9ubHkgZmlyc3QgY2hhcmFjdGVyIHRvIHVwcGVyY2FzZSB3aGlsZSByZW1haW5pbmcgY2hhcmFjdGVycyBzZXQgdG8gbG93ZXJjYXNlCiAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cyA9CiAgICAgICAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsKICAgICAgICAgICAgICAgICAgICBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMuc2xpY2UoMSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjdXJfbm9kZS5vcmRlcl9ub3Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLm9yZGVyX25vdGVzW2ldLmRhdGVfY3JlYXRlZCA9IG1vbWVudCgKICAgICAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLm9yZGVyX25vdGVzW2ldLmRhdGVfY3JlYXRlZCwKICAgICAgICAgICAgICAgICAgICAgIFsiWVlZWS1NTS1ERFRoaDptbTpzc1oiXQogICAgICAgICAgICAgICAgICAgICkuZm9ybWF0KCJEbyBNTU0gWVlZWSBISDptbSBhIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29tcGxldGVfb3JkZXJzX2RhdGEucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgbmFtZTogY3VyX25vZGUuaWQsCiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkX2RhdGU6IGN1cl9ub2RlLnByb2Nlc3NlZEF0LAogICAgICAgICAgICAgICAgICAgIGZ1bGZpbGxtZW50X3N0YXR1czogY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzLAogICAgICAgICAgICAgICAgICAgIHN0YXR1c191cmw6IGN1cl9ub2RlLm9yZGVyX3N0YXR1c191cmwsCiAgICAgICAgICAgICAgICAgICAgb3JkZXJfbm90ZXM6IGN1cl9ub2RlLm9yZGVyX25vdGVzLAogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvd19hbGxfb3JkZXJzX2xpc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5hbGxfb3JkZXJzX2xpc3QgPSBjb21wbGV0ZV9vcmRlcnNfZGF0YTsKICAgICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPQogICAgICAgICAgICAgICAgICAiUGxlYXNlIEZpbmQgQmVsb3cgWW91ciBMYXRlc3QgT3JkZXJzOiI7CiAgICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnNob3dfYWxsX29yZGVyc19saXN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZW50X29yZGVyc19saXN0ID0gY29tcGxldGVfb3JkZXJzX2RhdGE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5jb252ZXJzYXRpb25fb25seSA9IHRydWU7CiAgICAgICAgICAgICAgfSwgNTAwKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJiaWdjb21tZXJjZSIpIHsKICAgICAgICAgICAgICBpZiAoaXNSZWZ1bmQpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9hZF9jdXN0b21lcl9vcmRlcnMoCiAgICAgICAgICAgICAgICAgIGRhdGEucmVzcG9uc2VzWzBdLmRhdGEuY3VzdG9tZXIub3JkZXJzLAogICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgaXNSZWZ1bmQgPyAicmVmdW5kIiA6ICJhbGxfb3JkZXJzIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICAgICAgICBsZXQgb3JkZXJzX2RhdGEgPSBkYXRhLnJlc3BvbnNlc1swXS5kYXRhLmN1c3RvbWVyLm9yZGVycywKICAgICAgICAgICAgICAgICAgY29tcGxldGVfb3JkZXJzX2RhdGEgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3JkZXJzX2RhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cl9ub2RlID0gb3JkZXJzX2RhdGFbaV07CiAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLnByb2Nlc3NlZEF0ID0gbW9tZW50KGN1cl9ub2RlLmNyZWF0ZWRfYXQpLmZvcm1hdCgKICAgICAgICAgICAgICAgICAgICAiRG8gTU1NIFlZWVkiCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cyA9CiAgICAgICAgICAgICAgICAgICAgQm9vbGVhbihjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMpID09PSB0cnVlCiAgICAgICAgICAgICAgICAgICAgICA/IGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cwogICAgICAgICAgICAgICAgICAgICAgOiAiVW5mdWxmaWxsZWQiOwogICAgICAgICAgICAgICAgICAvLyBTZXQgb25seSBmaXJzdCBjaGFyYWN0ZXIgdG8gdXBwZXJjYXNlIHdoaWxlIHJlbWFpbmluZyBjaGFyYWN0ZXJzIHNldCB0byBsb3dlcmNhc2UKICAgICAgICAgICAgICAgICAgY3VyX25vZGUuZnVsZmlsbG1lbnRfc3RhdHVzID0KICAgICAgICAgICAgICAgICAgICBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKwogICAgICAgICAgICAgICAgICAgIGN1cl9ub2RlLmZ1bGZpbGxtZW50X3N0YXR1cy5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1cl9ub2RlLm9yZGVyX25vdGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY3VyX25vZGUub3JkZXJfbm90ZXNbaV0uZGF0ZV9jcmVhdGVkID0gbW9tZW50KAogICAgICAgICAgICAgICAgICAgICAgY3VyX25vZGUub3JkZXJfbm90ZXNbaV0uZGF0ZV9jcmVhdGVkCiAgICAgICAgICAgICAgICAgICAgKS5mb3JtYXQoIkRvIE1NTSBZWVlZIEhIOm1tIGEiKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb21wbGV0ZV9vcmRlcnNfZGF0YS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBuYW1lOiBjdXJfbm9kZS5pZCwKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZWRfZGF0ZTogY3VyX25vZGUucHJvY2Vzc2VkQXQsCiAgICAgICAgICAgICAgICAgICAgZnVsZmlsbG1lbnRfc3RhdHVzOiBjdXJfbm9kZS5mdWxmaWxsbWVudF9zdGF0dXMsCiAgICAgICAgICAgICAgICAgICAgc3RhdHVzX3VybDogY3VyX25vZGUub3JkZXJfc3RhdHVzX3VybCwKICAgICAgICAgICAgICAgICAgICBvcmRlcl9ub3RlczogY3VyX25vZGUub3JkZXJfbm90ZXMsCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5zaG93X2FsbF9vcmRlcnNfbGlzdCA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmFsbF9vcmRlcnNfbGlzdCA9IGNvbXBsZXRlX29yZGVyc19kYXRhOwogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9CiAgICAgICAgICAgICAgICAgICJQbGVhc2UgRmluZCBCZWxvdyBZb3VyIExhdGVzdCBPcmRlcnM6IjsKICAgICAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uc2hvd19hbGxfb3JkZXJzX2xpc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlbnRfb3JkZXJzX2xpc3QgPSBjb21wbGV0ZV9vcmRlcnNfZGF0YTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmNvbnZlcnNhdGlvbl9vbmx5ID0gdHJ1ZTsKICAgICAgICAgICAgICB9LCA1MDApOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0b2tlbl90eXBlID09PSAic2hvcGlmeV9jdXN0b21lcl9pZCIpIHsKICAgICAgICBpZiAoQm9vbGVhbih0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQpID09PSBmYWxzZSkgewogICAgICAgICAgdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNob3BpZnlfY3VzdG9tZXJfZW1haWwgPSB0aGlzLiRzZXNzaW9uLmdldCgKICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIgogICAgICAgICk7CiAgICAgICAgbGV0IHN0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBjdXN0b21lcklkOiB0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQsCiAgICAgICAgICBlbWFpbDogc2hvcGlmeV9jdXN0b21lcl9lbWFpbCwKICAgICAgICB9KTsKICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gIkZldGNoaW5nIHlvdXIgb3JkZXIgZGV0YWlscyAuLi4iOwogICAgICAgIGF4aW9zCiAgICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikubGljZW5zZV9rZXksCiAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgc291cmNlOiAiV2ViIiwKICAgICAgICAgICAgY2hhdDogYC9yZXRyaWV2ZV9jdXN0b21lcl9vcmRlcnMke3N0cmluZ2lmaWVkX2N1c3RvbWVyX3BheWxvYWR9YCwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgfSkKICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXNwb25zZXNbMF0uY3VzdG9tLm9yZGVyc19saXN0Lmxlbmd0aCA9PSAwICYmCiAgICAgICAgICAgICAgdGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5jb252ZXJzYXRpb25fb25seSA9IHRydWU7CiAgICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9CiAgICAgICAgICAgICAgICAiVGhlcmUgYXJlIG5vIG9yZGVycyB0byBiZSBkaXNwbGF5ZWQgZm9yIHRoZSBnaXZlbiBFbWFpbCBvciBQaG9uZSBudW1iZXIiOwogICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5sb2FkX2N1c3RvbWVyX29yZGVycygKICAgICAgICAgICAgICAgIHJlc3BvbnNlLmRhdGEucmVzcG9uc2VzWzBdLmN1c3RvbS5vcmRlcnNfbGlzdCwKICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgaXNSZWZ1bmQgPyAicmVmdW5kIiA6ICJhbGxfb3JkZXJzIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInJlc3BvbnNlIik7CiAgICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIHJldGFpbF9pc190b2tlbl92YWxpZChpbmRleCwgaXNSZWZ1bmQpIHsKICAgICAgaXNSZWZ1bmQgPSBpc1JlZnVuZCB8fCBmYWxzZTsKICAgICAgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gInNob3BpZnkiKSB7CiAgICAgICAgaWYgKAogICAgICAgICAgKHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzICYmCiAgICAgICAgICAgICFCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSAmJgogICAgICAgICAgICAhQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJlY2VudF9vcmRlcnNfbGlzdCkpIHx8CiAgICAgICAgICAodGhpcy5jaGF0W2luZGV4XS5mZXRjaF9zaG9waWZ5X2RldGFpbHMgJiYKICAgICAgICAgICAgQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLmlzX3JlZnVuZCkgJiYKICAgICAgICAgICAgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QpKSB8fAogICAgICAgICAgKHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzICYmCiAgICAgICAgICAgIEJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZXR1cm5fc2hvcGlmeV9lbWFpbCkpCiAgICAgICAgKSB7CiAgICAgICAgICBpZiAodGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQpIHsKICAgICAgICAgICAgaWYgKEJvb2xlYW4odGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkKSkgewogICAgICAgICAgICAgIGxldCBjdXN0b21lclRva2VuID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iKTsKICAgICAgICAgICAgICBpZiAodGhpcy5jaGF0W2luZGV4XS5pc19yZWZ1bmQpIHsKICAgICAgICAgICAgICAgIHRoaXMucmV0YWlsX2ZldGNoX2N1c3RvbWVyX2lkKAogICAgICAgICAgICAgICAgICBjdXN0b21lclRva2VuLAogICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfaWQiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5jaGF0W2luZGV4XS5yZXR1cm5fc2hvcGlmeV9lbWFpbCkgewogICAgICAgICAgICAgICAgdGhpcy5zZW5kX3JldGFpbF9jdXN0b21lcl9pZChpbmRleCwgZmFsc2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnJldGFpbF9mZXRjaF9vcmRlcnMoCiAgICAgICAgICAgICAgICAgIGN1c3RvbWVyVG9rZW4sCiAgICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgICBpc1JlZnVuZCwKICAgICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfaWQiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZXQgc2hvcGlmeV9zdG9yZV9jaWQgPSB0aGlzLmdldF9zaG9waWZ5X3N0b3JlX3dpbmRvd19jdXN0b21lcl9pZCgpOwogICAgICAgICAgICBpZiAoQm9vbGVhbihzaG9waWZ5X3N0b3JlX2NpZCkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIHNob3BpZnlfc3RvcmVfY2lkID09PSBudWxsIHx8CiAgICAgICAgICAgICAgICBzaG9waWZ5X3N0b3JlX2NpZCA9PSB1bmRlZmluZWQgfHwKICAgICAgICAgICAgICAgIHNob3BpZnlfc3RvcmVfY2lkID09ICIiCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IHNob3BpZnlfc3RvcmVfY2lkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsZXQgY3VzdG9tZXJUb2tlbiA9IHRoaXMuJHNlc3Npb24uZ2V0KCJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIik7CiAgICAgICAgICAgICAgaWYgKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJldGFpbF9mZXRjaF9jdXN0b21lcl9pZCgKICAgICAgICAgICAgICAgICAgY3VzdG9tZXJUb2tlbiwKICAgICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY2hhdFtpbmRleF0ucmV0dXJuX3Nob3BpZnlfZW1haWwpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VuZF9yZXRhaWxfY3VzdG9tZXJfaWQoaW5kZXgsIGZhbHNlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5yZXRhaWxfZmV0Y2hfb3JkZXJzKAogICAgICAgICAgICAgICAgICBjdXN0b21lclRva2VuLAogICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgaXNSZWZ1bmQsCiAgICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIndvb2NvbW1lcmNlIikgewogICAgICAgIGlmICgKICAgICAgICAgICh0aGlzLmNoYXRbaW5kZXhdLmZldGNoX3Nob3BpZnlfZGV0YWlscyAmJgogICAgICAgICAgICAhQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLmlzX3JlZnVuZCkgJiYKICAgICAgICAgICAgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZWNlbnRfb3JkZXJzX2xpc3QpKSB8fAogICAgICAgICAgKHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzICYmCiAgICAgICAgICAgIEJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5pc19yZWZ1bmQpICYmCiAgICAgICAgICAgICFCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0ucmVmdW5kX29yZGVyc19saXN0KSkgfHwKICAgICAgICAgICh0aGlzLmNoYXRbaW5kZXhdLmZldGNoX3Nob3BpZnlfZGV0YWlscyAmJgogICAgICAgICAgICBCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0ucmV0dXJuX3Nob3BpZnlfZW1haWwpKQogICAgICAgICkgewogICAgICAgICAgaWYgKHRoaXMucmV0YWlsX29yZGVyX3JldHJlaXZhbF9vbmx5X2VtYWlsX3JlcXVpcmVkKSB7CiAgICAgICAgICAgIHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCA9IHRoaXMuJHNlc3Npb24uZ2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CiAgICAgICAgICAgIGlmIChCb29sZWFuKHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCkpIHsKICAgICAgICAgICAgICBsZXQgY3VzdG9tZXJUb2tlbiA9IHRoaXMuJHNlc3Npb24uZ2V0KCJzaG9waWZ5X2N1c3RvbWVyX2lkIik7CiAgICAgICAgICAgICAgdGhpcy5yZXRhaWxfZmV0Y2hfb3JkZXJzKAogICAgICAgICAgICAgICAgY3VzdG9tZXJUb2tlbiwKICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgaXNSZWZ1bmQsCiAgICAgICAgICAgICAgICAic2hvcGlmeV9jdXN0b21lcl9pZCIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGV0IHdvb2NvbW1lcmNlX3N0b3JlX2xvZ2luX2RldGFpbCA9CiAgICAgICAgICAgICAgdGhpcy5nZXRfd29vY29tbWVyY2Vfc3RvcmVfd2luZG93X2N1c3RvbWVyX2VtYWlsKCk7CiAgICAgICAgICAgIGlmIChCb29sZWFuKHdvb2NvbW1lcmNlX3N0b3JlX2xvZ2luX2RldGFpbCkgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5zZXQoCiAgICAgICAgICAgICAgICAic2hvcGlmeV9jdXN0b21lcl9pZCIsCiAgICAgICAgICAgICAgICB3b29jb21tZXJjZV9zdG9yZV9sb2dpbl9kZXRhaWxbMF0KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KAogICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfdG9rZW4iLAogICAgICAgICAgICAgICAgd29vY29tbWVyY2Vfc3RvcmVfbG9naW5fZGV0YWlsWzFdCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAodGhpcy5jaGF0W2luZGV4XS5pc19yZWZ1bmQpIHsKICAgICAgICAgICAgICAgIHRoaXMucmV0YWlsX2ZldGNoX2N1c3RvbWVyX2lkKAogICAgICAgICAgICAgICAgICB3b29jb21tZXJjZV9zdG9yZV9sb2dpbl9kZXRhaWxbMF0sCiAgICAgICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgICAgICAic2hvcGlmeV9jdXN0b21lcl9pZCIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMucmV0YWlsX2ZldGNoX29yZGVycygKICAgICAgICAgICAgICAgICAgd29vY29tbWVyY2Vfc3RvcmVfbG9naW5fZGV0YWlsWzBdLAogICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgaXNSZWZ1bmQsCiAgICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHRoaXMucmV0YWlsX3dlYl9mcmFtZXdvcmsgPT0gIm1hZ2VudG8iKSB7CiAgICAgICAgaWYgKAogICAgICAgICAgKHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzICYmCiAgICAgICAgICAgICFCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSAmJgogICAgICAgICAgICAhQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJlY2VudF9vcmRlcnNfbGlzdCkpIHx8CiAgICAgICAgICAodGhpcy5jaGF0W2luZGV4XS5mZXRjaF9zaG9waWZ5X2RldGFpbHMgJiYKICAgICAgICAgICAgQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLmlzX3JlZnVuZCkgJiYKICAgICAgICAgICAgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZWZ1bmRfb3JkZXJzX2xpc3QpKSB8fAogICAgICAgICAgKHRoaXMuY2hhdFtpbmRleF0uZmV0Y2hfc2hvcGlmeV9kZXRhaWxzICYmCiAgICAgICAgICAgIEJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5yZXR1cm5fc2hvcGlmeV9lbWFpbCkpCiAgICAgICAgKSB7CiAgICAgICAgICBpZiAodGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQpIHsKICAgICAgICAgICAgdGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiKTsKICAgICAgICAgICAgaWYgKEJvb2xlYW4odGhpcy5zaG9waWZ5X2N1c3RvbWVyX2lkKSkgewogICAgICAgICAgICAgIGxldCBjdXN0b21lclRva2VuID0gdGhpcy4kc2Vzc2lvbi5nZXQoInNob3BpZnlfY3VzdG9tZXJfaWQiKTsKICAgICAgICAgICAgICB0aGlzLnJldGFpbF9mZXRjaF9vcmRlcnMoCiAgICAgICAgICAgICAgICBjdXN0b21lclRva2VuLAogICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICBpc1JlZnVuZCwKICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZXQgbWFnZW50b19zdG9yZV9sb2dpbl9kZXRhaWwgPQogICAgICAgICAgICAgIHRoaXMuZ2V0X21hZ2VudG9fc3RvcmVfd2luZG93X2N1c3RvbWVyX2VtYWlsKCk7CiAgICAgICAgICAgIGlmIChCb29sZWFuKG1hZ2VudG9fc3RvcmVfbG9naW5fZGV0YWlsKSA9PSBmYWxzZSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgKICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIiwKICAgICAgICAgICAgICAgIG1hZ2VudG9fc3RvcmVfbG9naW5fZGV0YWlsWzBdCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgKICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIiwKICAgICAgICAgICAgICAgIG1hZ2VudG9fc3RvcmVfbG9naW5fZGV0YWlsWzFdCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAodGhpcy5jaGF0W2luZGV4XS5pc19yZWZ1bmQpIHsKICAgICAgICAgICAgICAgIHRoaXMucmV0YWlsX2ZldGNoX2N1c3RvbWVyX2lkKAogICAgICAgICAgICAgICAgICBtYWdlbnRvX3N0b3JlX2xvZ2luX2RldGFpbFswXSwKICAgICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX2lkIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5yZXRhaWxfZmV0Y2hfb3JkZXJzKAogICAgICAgICAgICAgICAgICBtYWdlbnRvX3N0b3JlX2xvZ2luX2RldGFpbFswXSwKICAgICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAgIGlzUmVmdW5kLAogICAgICAgICAgICAgICAgICAic2hvcGlmeV9jdXN0b21lcl9pZCIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0aGlzLnJldGFpbF93ZWJfZnJhbWV3b3JrID09ICJiaWdjb21tZXJjZSIpIHsKICAgICAgICBpZiAoCiAgICAgICAgICAodGhpcy5jaGF0W2luZGV4XS5mZXRjaF9zaG9waWZ5X2RldGFpbHMgJiYKICAgICAgICAgICAgIUJvb2xlYW4odGhpcy5jaGF0W2luZGV4XS5pc19yZWZ1bmQpICYmCiAgICAgICAgICAgICFCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0ucmVjZW50X29yZGVyc19saXN0KSkgfHwKICAgICAgICAgICh0aGlzLmNoYXRbaW5kZXhdLmZldGNoX3Nob3BpZnlfZGV0YWlscyAmJgogICAgICAgICAgICBCb29sZWFuKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSAmJgogICAgICAgICAgICAhQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJlZnVuZF9vcmRlcnNfbGlzdCkpIHx8CiAgICAgICAgICAodGhpcy5jaGF0W2luZGV4XS5mZXRjaF9zaG9waWZ5X2RldGFpbHMgJiYKICAgICAgICAgICAgQm9vbGVhbih0aGlzLmNoYXRbaW5kZXhdLnJldHVybl9zaG9waWZ5X2VtYWlsKSkKICAgICAgICApIHsKICAgICAgICAgIGlmICh0aGlzLnJldGFpbF9vcmRlcl9yZXRyZWl2YWxfb25seV9lbWFpbF9yZXF1aXJlZCkgewogICAgICAgICAgICB0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQgPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl9pZCIpOwogICAgICAgICAgICBpZiAoQm9vbGVhbih0aGlzLnNob3BpZnlfY3VzdG9tZXJfaWQpKSB7CiAgICAgICAgICAgICAgbGV0IGN1c3RvbWVyVG9rZW4gPSB0aGlzLiRzZXNzaW9uLmdldCgic2hvcGlmeV9jdXN0b21lcl9pZCIpOwogICAgICAgICAgICAgIHRoaXMucmV0YWlsX2ZldGNoX29yZGVycygKICAgICAgICAgICAgICAgIGN1c3RvbWVyVG9rZW4sCiAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgIGlzUmVmdW5kLAogICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfaWQiCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBiaWdjb21tZXJjZV9zdG9yZV9sb2dpbl9kZXRhaWwgPQogICAgICAgICAgICAgIHRoaXMuZ2V0X2JpZ2NvbW1lcmNlX3N0b3JlX3dpbmRvd19jdXN0b21lcl9lbWFpbCgpOwogICAgICAgICAgICBpZiAoQm9vbGVhbihiaWdjb21tZXJjZV9zdG9yZV9sb2dpbl9kZXRhaWwpID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuJHNlc3Npb24uc2V0KAogICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfaWQiLAogICAgICAgICAgICAgICAgYmlnY29tbWVyY2Vfc3RvcmVfbG9naW5fZGV0YWlsWzBdCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB0aGlzLiRzZXNzaW9uLnNldCgKICAgICAgICAgICAgICAgICJzaG9waWZ5X2N1c3RvbWVyX3Rva2VuIiwKICAgICAgICAgICAgICAgIGJpZ2NvbW1lcmNlX3N0b3JlX2xvZ2luX2RldGFpbFsxXQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKHRoaXMuY2hhdFtpbmRleF0uaXNfcmVmdW5kKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJldGFpbF9mZXRjaF9jdXN0b21lcl9pZCgKICAgICAgICAgICAgICAgICAgYmlnY29tbWVyY2Vfc3RvcmVfbG9naW5fZGV0YWlsWzBdLAogICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgInNob3BpZnlfY3VzdG9tZXJfaWQiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnJldGFpbF9mZXRjaF9vcmRlcnMoCiAgICAgICAgICAgICAgICAgIGJpZ2NvbW1lcmNlX3N0b3JlX2xvZ2luX2RldGFpbFswXSwKICAgICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAgIGlzUmVmdW5kLAogICAgICAgICAgICAgICAgICAic2hvcGlmeV9jdXN0b21lcl9pZCIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGRlbW9fcmV0YWlsX3F1ZXN0aW9uKCkgewogICAgICBpZiAodGhpcy5pc19yZXRhaWxfYm90ICYmIHRoaXMuaXNDYWxsZWRGcm9tU2V0dXApIHsKICAgICAgICBheGlvcwogICAgICAgICAgLnBvc3QoCiAgICAgICAgICAgIGFwaV9jYWxscy50ZW1wbGF0ZV9zeW5vbnltcygpLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29tcGFueV9pZDogdGhpcy5jb21wYW55aWQsCiAgICAgICAgICAgICAgY29tcGFueV9uYW1lOiB0aGlzLmNvbXBhbnluYW1lLAogICAgICAgICAgICAgIGlzX2dldF9wcm9kdWN0X2xpc3Q6IHRydWUsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy4kc2Vzc2lvbi5nZXQoImF0Iil9YCwKICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgdGhpcy5zcGlubmVyT24gPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEubWVzc2FnZS5NU0dfQ09ERSA9PT0gdGhpcy5hcGlfc3RhdHVzX2NvZGUuREFUQV9BVkFJTEFCTEVfTU9ERUxTLk1TR19DT0RFKSB7CiAgICAgICAgICAgICAgbGV0IHByb2R1Y3RfbmFtZXNfbGlzdCA9IHJlc3BvbnNlLmRhdGEuZGF0YS5wcm9kdWN0X25hbWVzX2xpc3Q7CiAgICAgICAgICAgICAgbGV0IGl0ZW0gPQogICAgICAgICAgICAgICAgcHJvZHVjdF9uYW1lc19saXN0WwogICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBwcm9kdWN0X25hbWVzX2xpc3QubGVuZ3RoKQogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICB0aGlzLnRvX3NlbmQgPSBgUGxlYXNlIHNob3cgbWUgJHtpdGVtfWA7CiAgICAgICAgICAgICAgc3dhbCh7CiAgICAgICAgICAgICAgICB0ZXh0OiAiVGVzdGluZyBvZiBCb3QgaW4gUHJvZ3Jlc3MsIFNlYXJjaGluZyBmb3IgYSBwcm9kdWN0IGZyb20geW91ciBTdG9yZSEiLAogICAgICAgICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgICAgIHR5cGU6ICJpbmZvIiwKICAgICAgICAgICAgICAgIHRpbWVyOiA1MDAwLAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgLy8gJCgiI3NlbmRfYnRuIikuY2xpY2soKQogICAgICAgICAgICAgICAgdGhpcy5jaGF0LnB1c2goewogICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgc2VuZGluZzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgc2VudDogdGhpcy50b19zZW5kLAogICAgICAgICAgICAgICAgICB0aW1lOiB0aGlzLmdlbmVyYXRlX3RpbWUoKSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgLy8gdGhpcy4kc2Vzc2lvbi5zZXQoIkJvdFJlc3BvbnNlX0NvbnZlcnNhdGlvbiIsIHRoaXMuY2hhdCk7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZV9zY3JvbGxiYXIoInVwdG9fZW5kIiwgInNlbmRlciIpOwogICAgICAgICAgICAgICAgYXhpb3MKICAgICAgICAgICAgICAgICAgLnBvc3QoYXBpX2NhbGxzLmNoYXRib3RfcmVzcG9uc2VfY2Vuc2UoKSwgewogICAgICAgICAgICAgICAgICAgIGNoYXQ6IHRoaXMudG9fc2VuZCwKICAgICAgICAgICAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICAgICAgICAgIGxpY2Vuc2Vfa2V5OgogICAgICAgICAgICAgICAgICAgICAgdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSwgImRpc3BsYXlfc3VjY2Vzc190b2FzdHIiKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLnRvX3NlbmQgPSAiIjsKICAgICAgICAgICAgICB9LCAzMjAwKTsKICAgICAgICAgICAgfSBlbHNlIGlmKHJlc3BvbnNlLmRhdGEubWVzc2FnZS5NU0dfQ09ERSA9PT0gdGhpcy5hcGlfc3RhdHVzX2NvZGUuSU5URUdSQVRJT05fREVUQUlMU19OT1RfRk9VTkRfTU9ERUxTLk1TR19DT0RFKSB7CiAgICAgICAgICAgICAgc3dhbCh7CiAgICAgICAgICAgICAgICB0ZXh0OiByZXNwb25zZS5kYXRhLm1lc3NhZ2UuTVNHLAogICAgICAgICAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSwKICAgICAgICAgICAgICAgIHR5cGU6ICJpbmZvIiwKICAgICAgICAgICAgICAgIHRpbWVyOiA1MDAwLAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKChlKSA9PiB7CiAgICAgICAgICAgIHRoaXMuc3Bpbm5lck9uID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICAgICAgY29udmVyc2F0aW9uX29ubHk6IHRydWUsCiAgICAgICAgICAgICAgdGltZTogdGhpcy5nZW5lcmF0ZV90aW1lKCksCiAgICAgICAgICAgICAgYXNrX2ZlZWRiYWNrOiBmYWxzZSwKICAgICAgICAgICAgICByZWNlaXZlZDoKICAgICAgICAgICAgICAgICJTb21lIGVycm9yIG9jY3VycmVkIHdoaWxlIHRlc3RpbmcuIFBsZWFzZSB0cnkgYnkgcmVmcmVzaGluZyB0aGUgYnJvd3NlciEgSWYgdGhlIGlzc3VlIHBlcnNpc3RzLCBwbGVhc2UgY29udGFjdCBzeXN0ZW0gYWRtaW4uIiwKICAgICAgICAgICAgICByZWNlaXZpbmc6IHRydWUsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIHJldGFpbF9jaGVja19jdXN0b21lcl9sb2dnZWRfaW4oKSB7CiAgICAgIGxldCBjdXN0b21lcl9kYXRhID0gewogICAgICAgIGlzX2N1c3RvbWVyX2xvZ2dlZF9pbjogZmFsc2UsCiAgICAgICAgY3VzdG9tZXJfaWQ6IG51bGwsCiAgICAgIH07CiAgICAgIGlmIChCb29sZWFuKHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZCkpIHsKICAgICAgICBjdXN0b21lcl9kYXRhLmlzX2N1c3RvbWVyX2xvZ2dlZF9pbiA9IHRydWU7CiAgICAgICAgY3VzdG9tZXJfZGF0YS5jdXN0b21lcl9pZCA9IHRoaXMuc2hvcGlmeV9jdXN0b21lcl9pZDsKICAgICAgfQogICAgICBsZXQgc3RyaW5naWZpZWRfY3VzdG9tZXJfcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICBjdXN0b21lcl9kYXRhLAogICAgICB9KTsKICAgICAgdGhpcy5pc190eXBpbmdfaW5kaWNhdG9yX29uID0gdHJ1ZTsKICAgICAgYXhpb3MKICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgICBjaGF0OiBgL3Nob3BpZnlfcmV0cmVpdmVfY3VzdG9tZXJfc3BlY2lmaWNfb2ZmZXJzJHtzdHJpbmdpZmllZF9jdXN0b21lcl9wYXlsb2FkfWAsCiAgICAgICAgICB0b2tlbjogdGhpcy5ib3RfcmVzcG9uc2VfdG9rZW5fdmFsdWUsCiAgICAgICAgICByb2xlOiB0aGlzLiRzZXNzaW9uLmdldCgiVXNlckluZm9ybWF0aW9uIikucm9sZSwKICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICB9KQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgdGhpcy5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSwgbnVsbCk7CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgdGhpcy51cGRhdGVfc2Nyb2xsYmFyKCJ1cHRvX2VuZCIsICJyZXNwb25zZSIpOwogICAgICAgIH0pOwogICAgfSwKICAgIHNlbmRfcmV0YWlsX2N1c3RvbWVyX2lkKGluZGV4LCBpc19sb2dpbiwgbWV0YWRhdGEpIHsKICAgICAgaWYgKGlzX2xvZ2luID09PSB0cnVlKSB7CiAgICAgICAgbGV0IHF1ZXJ5U3RyaW5nID0gJCgiI3Nob3BpZnlfbG9naW5fZm9ybSIpLnNlcmlhbGl6ZUFycmF5KCk7CiAgICAgICAgbGV0IGZvcm1fcGF5bG9hZCA9IHt9OwogICAgICAgIGZvcm1fcGF5bG9hZFsic2hvcGlmeV9pc19vbmx5X2VtYWlsIl0gPQogICAgICAgICAgdGhpcy5yZXRhaWxfb3JkZXJfcmV0cmVpdmFsX29ubHlfZW1haWxfcmVxdWlyZWQ7CiAgICAgICAgZm9ybV9wYXlsb2FkWyJ0ZXh0Il0gPSB0aGlzLmNoYXRbaW5kZXhdLm1ldGFkYXRhLnRleHQ7CiAgICAgICAgZm9ybV9wYXlsb2FkWyJlbnRpdHkiXSA9IHRoaXMuY2hhdFtpbmRleF0ubWV0YWRhdGEuZW50aXR5OwogICAgICAgIGZvciAodmFyIGkgaW4gcXVlcnlTdHJpbmcpIHsKICAgICAgICAgIGZvcm1fcGF5bG9hZFtxdWVyeVN0cmluZ1tpXS5uYW1lXSA9CiAgICAgICAgICAgIHRoaXMuY2hhdFtpbmRleF0uY3VzdG9tZXJfZW1haWxfaWQ7CiAgICAgICAgfQogICAgICAgIGZvcm1fcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KGZvcm1fcGF5bG9hZCk7CiAgICAgICAgYXhpb3MKICAgICAgICAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgICAgICBjaGF0OiBgL3JlX29yZGVyX3Byb2R1Y3RzX2FjdGlvbiR7Zm9ybV9wYXlsb2FkfWAsCiAgICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICAgIH0pCiAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgdGhpcy5jaGF0W2luZGV4XS5yZWNlaXZlZCA9ICIiOwogICAgICAgICAgICB0aGlzLmNoYXRbaW5kZXhdLmZldGNoX3Nob3BpZnlfZGV0YWlscyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNoYXQuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgdGhpcy5yZXNwb25zZV9oYW5kbGluZyhyZXNwb25zZSk7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKChlcnIpID0+IHsKICAgICAgICAgICAgY29uc29sZS5sb2coIkVycm9yIDo+PiAiLCBlcnIpOwogICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gbGV0IGZvcm1fcGF5bG9hZCA9IHsKICAgICAgICAvLyAgIGVtYWlsOidhc2hpc2guaUBjb2RlYXJyYXkudGVjaCcsCiAgICAgICAgLy8gICBwYXNzd29yZDogIiIsCiAgICAgICAgLy8gICBzaG9waWZ5X2lzX29ubHlfZW1haWw6IGZhbHNlLAogICAgICAgIC8vICAgdGV4dDogdGhpcy5jaGF0W2luZGV4XS5tZXRhZGF0YS50ZXh0LAogICAgICAgIC8vICAgZW50aXR5IDogdGhpcy5jaGF0W2luZGV4XS5tZXRhZGF0YS5lbnRpdHkKICAgICAgICAvLyB9OwogICAgICAgIC8vIGZvcm1fcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KGZvcm1fcGF5bG9hZCk7CiAgICAgICAgLy8gYXhpb3MKICAgICAgICAvLyAgIC5wb3N0KGFwaV9jYWxscy5jaGF0Ym90X3Jlc3BvbnNlX2NlbnNlKCksIHsKICAgICAgICAvLyAgICAgbGljZW5zZV9rZXk6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5saWNlbnNlX2tleSwKICAgICAgICAvLyAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgIC8vICAgICB1c2VybmFtZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmVtYWlsLAogICAgICAgIC8vICAgICBzb3VyY2U6ICJXZWIiLAogICAgICAgIC8vICAgICBjaGF0OiBgL3JlX29yZGVyX3Byb2R1Y3RzX2FjdGlvbiR7Zm9ybV9wYXlsb2FkfWAsCiAgICAgICAgLy8gICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAvLyAgICAgcm9sZTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLnJvbGUsCiAgICAgICAgLy8gICAgIHJlZnJlc2hlZF9vcl9jbG9zZWQ6IHRoaXMucmVmcmVzaGVkX29yX2Nsb3NlZCwKICAgICAgICAvLyAgIH0pCiAgICAgICAgLy8gICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAvLyAgICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YSk7CiAgICAgICAgLy8gICAgIGNvbnNvbGUubG9nKHRoaXMpOwogICAgICAgIC8vICAgICB0aGlzLnJlc3BvbnNlX2hhbmRsaW5nKHJlc3BvbnNlKQogICAgICAgIC8vICAgfSkKICAgICAgICAvLyAgIC5jYXRjaCgoZXJyKSA9PiB7CiAgICAgICAgLy8gICAgIGNvbnNvbGUubG9nKCJFcnJvciA6Pj4gIiwgZXJyKTsKICAgICAgICAvLyAgIH0pOwogICAgICB9CiAgICB9LAogICAgb3Blbl9tZXNzYWdpbmdfZnJhbWV3b3JrX2ludGVncmF0aW9uKHVybCkgewogICAgICB2YXIgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgICAgbGluay5ocmVmID0gdXJsOwogICAgICAvLyBsaW5rLnNldEF0dHJpYnV0ZSgiZG93bmxvYWQiLCBmaWxlX25hbWUpOwogICAgICBsaW5rLnNldEF0dHJpYnV0ZSgidGFyZ2V0IiwgIl9ibGFuayIpOwogICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmspOwogICAgICBsaW5rLmNsaWNrKCk7CiAgICAgIGxpbmsucmVtb3ZlKCk7CiAgICB9LAogICAgc3VwcG9ydF9zdWJzY3JpcHRpb25fZGF0YSgpIHsKICAgICAgYXhpb3MKICAgICAgICAucG9zdChhcGlfY2FsbHMuY2hhdGJvdF9yZXNwb25zZV9jZW5zZSgpLCB7CiAgICAgICAgICBsaWNlbnNlX2tleTogdGhpcy4kc2Vzc2lvbi5nZXQoIlVzZXJJbmZvcm1hdGlvbiIpLmxpY2Vuc2Vfa2V5LAogICAgICAgICAgdG9rZW46IHRoaXMuYm90X3Jlc3BvbnNlX3Rva2VuX3ZhbHVlLAogICAgICAgICAgdXNlcm5hbWU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5lbWFpbCwKICAgICAgICAgIHRva2VuOiB0aGlzLmJvdF9yZXNwb25zZV90b2tlbl92YWx1ZSwKICAgICAgICAgIHJvbGU6IHRoaXMuJHNlc3Npb24uZ2V0KCJVc2VySW5mb3JtYXRpb24iKS5yb2xlLAogICAgICAgICAgcmVmcmVzaGVkX29yX2Nsb3NlZDogdGhpcy5yZWZyZXNoZWRfb3JfY2xvc2VkLAogICAgICAgICAgY2hhdDogIi9zdXBwb3J0X3N1YnNjcmlwdGlvbl9kYXRhIiwKICAgICAgICAgIHNvdXJjZTogIldlYiIsCiAgICAgICAgfSkKICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgICAgIHRoaXMucmVzcG9uc2VfaGFuZGxpbmcocmVzcG9uc2UpOwogICAgICAgIH0pOwogICAgfSwKICAgIGNoZWNrX25vX3Byb2R1Y3RzKCkgewogICAgICBsZXQgcHJvZHVjdHNfZGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInByb2R1Y3RzX2xpc3RfZGl2Iik7CiAgICAgIGxldCBkaXNwbGF5X25vbmVfY291bnQgPSAwOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb2R1Y3RzX2Rpdi5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChwcm9kdWN0c19kaXYuY2hpbGRyZW5baV0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICAgICAgICBkaXNwbGF5X25vbmVfY291bnQgKz0gMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGRpc3BsYXlfbm9uZV9jb3VudCA9PT0gcHJvZHVjdHNfZGl2LmNoaWxkcmVuLmxlbmd0aCkgewogICAgICAgIHZhciBtc2cgPSB7CiAgICAgICAgICBjb252ZXJzYXRpb25fb25seTogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRoaXMuZ2VuZXJhdGVfdGltZSgpLAogICAgICAgICAgcmVjZWl2ZWQ6CiAgICAgICAgICAgICJTb3JyeSwgd2UgY291bGQgbm90IGZpbmQgYW55IHByb2R1Y3RzLiBQbGVhc2UgdHJ5IHJlcGhyYXNpbmcgdG8gc2VhcmNoIGEgZGlmZmVyZW50IHByb2R1Y3QhIiwKICAgICAgICAgIHJlY2VpdmluZzogdHJ1ZSwKICAgICAgICB9OwogICAgICAgIHRoaXMuY2hhdC5wdXNoKG1zZyk7CiAgICAgIH0KICAgIH0sCiAgICBnZXRfbWFnZW50b19zdG9yZV93aW5kb3dfY3VzdG9tZXJfZW1haWwoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgbGV0IGN1cnIgPSBKU09OLnBhcnNlKHRoaXMudXNlcl9kYXRhLm1hZ2VudG9fY3VzdG9tZXJfZGF0YSk7CiAgICAgICAgaWYgKEJvb2xlYW4oY3Vyci5pZCkgPT0gdHJ1ZSAmJiBCb29sZWFuKGN1cnIuZW1haWwpID09IHRydWUpIHsKICAgICAgICAgIHZhciBjdXN0b21lciA9IFtjdXJyLmlkLCBjdXJyLmVtYWlsXTsKICAgICAgICAgIHJldHVybiBjdXN0b21lcjsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgIHJldHVybiBudWxsOwogICAgfSwKICAgIGdldF93b29jb21tZXJjZV9zdG9yZV93aW5kb3dfY3VzdG9tZXJfZW1haWwoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgbGV0IGN1cnIgPSB0aGlzLnVzZXJfZGF0YS53b29fY3VycmVudF91c2VyOwogICAgICAgIGlmIChjdXJyLklEICE9PSAwICYmIGN1cnIuYWxsY2Fwcy5jdXN0b21lciA9PSB0cnVlKSB7CiAgICAgICAgICB2YXIgY3VzdG9tZXIgPSBbY3Vyci5kYXRhLklELCBjdXJyLmRhdGEudXNlcl9lbWFpbF07CiAgICAgICAgICByZXR1cm4gY3VzdG9tZXI7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7fQogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCiAgICBnZXRfYmlnY29tbWVyY2Vfc3RvcmVfd2luZG93X2N1c3RvbWVyX2VtYWlsKCkgewogICAgICAvLyBSZW1haW5pbmcgbm90IGltcGxlbWVudGVkCiAgICAgIHRyeSB7CiAgICAgICAgbGV0IGN1cnIgPSBKU09OLnBhcnNlKHRoaXMudXNlcl9kYXRhLmJpZ2NvbW1lcmNlX2N1c3RvbWVyX2RhdGEpOwogICAgICAgIGlmIChCb29sZWFuKGN1cnIuaWQpID09IHRydWUgJiYgQm9vbGVhbihjdXJyLmVtYWlsKSA9PSB0cnVlKSB7CiAgICAgICAgICB2YXIgY3VzdG9tZXIgPSBbY3Vyci5pZCwgY3Vyci5lbWFpbF07CiAgICAgICAgICByZXR1cm4gY3VzdG9tZXI7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7fQogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCiAgICBnZXRfc2hvcGlmeV9zdG9yZV93aW5kb3dfY3VzdG9tZXJfaWQoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgbGV0IGN1cnIgPSB3aW5kb3cuU2hvcGlmeUFuYWx5dGljcy5tZXRhLnBhZ2UuY3VzdG9tZXJJZDsKICAgICAgICBpZiAoY3VyciAhPT0gdW5kZWZpbmVkICYmIGN1cnIgIT09IG51bGwgJiYgY3VyciAhPT0gIiIpIHsKICAgICAgICAgIHJldHVybiBjdXJyOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgdHJ5IHsKICAgICAgICBsZXQgY3VyciA9IHdpbmRvdy5tZXRhLnBhZ2UuY3VzdG9tZXJJZDsKICAgICAgICBpZiAoY3VyciAhPT0gdW5kZWZpbmVkICYmIGN1cnIgIT09IG51bGwgJiYgY3VyciAhPT0gIiIpIHsKICAgICAgICAgIHJldHVybiBjdXJyOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgdHJ5IHsKICAgICAgICBsZXQgY3VyciA9IF9zdC5jaWQ7CiAgICAgICAgaWYgKGN1cnIgIT09IHVuZGVmaW5lZCAmJiBjdXJyICE9PSBudWxsICYmIGN1cnIgIT09ICIiKSB7CiAgICAgICAgICByZXR1cm4gY3VycjsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgIHJldHVybiBudWxsOwogICAgfSwKICAgIG5vX29yZGVyc190b19iZV9zaG93bihpbmRleCkgewogICAgICB0aGlzLmNoYXRbaW5kZXhdLnJlY2VpdmVkID0gIkl0IHNlZW1zIHlvdSBoYXZlIG5vIG9yZGVycyByaWdodCBub3chIjsKICAgIH0sCiAgICBjaGFuZ2VfY2hhdF90ZXh0X3RvX2xvZ2luX3JlZGlyZWN0KGluZGV4KSB7CiAgICAgIHRoaXMuY2hhdFtpbmRleF0ucmVjZWl2ZWQgPQogICAgICAgICc8cCBzdHlsZT0id2lkdGg6YXV0bzttYXJnaW4tYm90dG9tOjA7Ij4gUGxlYXNlIGxvZ2luIG9uIHRoZSBzdG9yZSBieSBjbGlja2luZyA8YSB0aXRsZT0iVGhpcyBmZWF0dXJlIGlzIG9ubHkgYXZhaWxhYmxlIG9uIHRoZSBzdG9yZSB3ZWJzaXRlLiJjbGFzcz0iYm90LXJlc3BvbnNlLXN0eWxlIiBzdHlsZT0iY3Vyc29yOiBub3QtYWxsb3dlZDsiIGhyZWY9ImphdmFzY3JpcHQ6IHZvaWQoMCkiPiBoZXJlIDwvYT48L3A+JzsKICAgIH0sCiAgICByZXR1cm5fZG9jdW1lbnRfY29va2llcyhuYW1lKSB7CiAgICAgIGxldCBjb29raWUgPSB7fTsKICAgICAgZG9jdW1lbnQuY29va2llLnNwbGl0KCI7IikuZm9yRWFjaChmdW5jdGlvbiAoZWwpIHsKICAgICAgICBsZXQgW2ssIHZdID0gZWwuc3BsaXQoIj0iKTsKICAgICAgICBjb29raWVbay50cmltKCldID0gdjsKICAgICAgfSk7CiAgICAgIHJldHVybiBjb29raWVbbmFtZV07CiAgICB9LAogICAgYXZhaWxhYmxlX3F0eShzdG9ja19xdHksIGlkKSB7CiAgICAgIGlmICh0aGlzLmFkZHRvQ2FydGRhdGEubGVuZ3RoICE9IDApIHsKICAgICAgICBmb3IgKHZhciBpIGluIHRoaXMuYWRkdG9DYXJ0ZGF0YSkgewogICAgICAgICAgaWYgKHRoaXMuYWRkdG9DYXJ0ZGF0YVtpXS5pZCA9PT0gaWQpIHsKICAgICAgICAgICAgbGV0IHJlcyA9IHN0b2NrX3F0eSAtIHRoaXMuYWRkdG9DYXJ0ZGF0YVtpXS5vcmRlcl9xdHk7CiAgICAgICAgICAgIHJldHVybiByZXMgPT0gMCA/ICJyZWFjaGVkIiA6IHJlczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0b2NrX3F0eTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gc3RvY2tfcXR5OwogICAgICB9CiAgICB9LAogICAgc2Nyb2xsX2NhcmRfcmlnaHQoaXRlbSkgewogICAgICB2YXIgZG9jID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgI2Nhcm91c2VsX2NhcmRzX2lkXyR7aXRlbX1gKTsKICAgICAgZG9jLnNjcm9sbExlZnQgKz0gMjUwOwogICAgICB2YXIgbWF4U2Nyb2xsTGVmdCA9IGRvYy5zY3JvbGxXaWR0aCAtIGRvYy5jbGllbnRXaWR0aDsKICAgICAgbWF4U2Nyb2xsTGVmdCA9IG1heFNjcm9sbExlZnQgLSAyMzA7CiAgICAgIGxldCBzZWNvbmRfYnR0biA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYCNjYXJvdXNlbF9zY3JvbGxfYnRuMl8ke2l0ZW19YCk7CiAgICAgIGxldCBmaXJzdF9idHRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgI2Nhcm91c2VsX3Njcm9sbF9idG4xXyR7aXRlbX1gKTsKICAgICAgZmlyc3RfYnR0bi5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgaWYgKGRvYy5zY3JvbGxMZWZ0ID49IG1heFNjcm9sbExlZnQpIHsKICAgICAgICBzZWNvbmRfYnR0bi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICB9CiAgICB9LAogICAgc2Nyb2xsX2NhcmRfbGVmdChpdGVtKSB7CiAgICAgIHZhciBkb2MgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjY2Fyb3VzZWxfY2FyZHNfaWRfJHtpdGVtfWApOwogICAgICBkb2Muc2Nyb2xsTGVmdCAtPSAyNTA7CiAgICAgIGxldCBmaXJzdF9idHRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgI2Nhcm91c2VsX3Njcm9sbF9idG4xXyR7aXRlbX1gKTsKICAgICAgbGV0IHNlY29uZF9idHRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgI2Nhcm91c2VsX3Njcm9sbF9idG4yXyR7aXRlbX1gKTsKICAgICAgc2Vjb25kX2J0dG4uc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgIGlmIChkb2Muc2Nyb2xsTGVmdCA8PSAyNTApIHsKICAgICAgICBmaXJzdF9idHRuLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgIH0KICAgIH0sCiAgfSwKfTsK"},null]}